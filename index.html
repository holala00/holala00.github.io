<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Võ Lâm Luân Hồi</title> <!-- [MODIFIED] Đổi tên game -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    
    <!-- [MODIFIED] Quay về chỉ sử dụng "Noto Serif" để đồng bộ toàn game -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- [MODIFIED] Sieu Viet (Transcendence) Skill Database (Simple) -->
    <script>
    // [NEW] DATABASE ẢNH ĐỆ TỬ THEO PHẨM CHẤT
    // Hướng dẫn: Thay thế 'LINK_ANH_...' bằng đường dẫn ảnh của bạn (URL).
    // Đã cập nhật theo danh sách bạn gửi (12 phẩm chất tương ứng với 12 link đầu tiên)
    const DISCIPLE_POTENTIAL_IMAGES = {
        'Yếu Kém': 'https://i.imgur.com/w2gUbKQ.png', 
        'Bình Thường': 'https://i.imgur.com/tFxRJ17.png',
        'Khá': 'https://i.imgur.com/PO6BpE9.png',
        'Tốt': 'https://i.imgur.com/yBTscNS.png',
        'Thiên Tài': 'https://i.imgur.com/CMu5Cyt.png',
        'Tuyệt Thế': 'https://i.imgur.com/kAQ3qJz.png',
        'Thiên Kiêu Chi Tử': 'https://i.imgur.com/iG4Y97X.png',
        'Nghịch Thiên Cải Mệnh': 'https://i.imgur.com/RgTizWN.png',
        'Vô Cực Đạo Thể': 'https://i.imgur.com/oAqq5dA.png',
        'Vạn Đạo Chi Tổ': 'https://i.imgur.com/Mj3xhrn.png',
        'Chân Ngã Duy Nhất': 'https://i.imgur.com/vl9r678.png',
        'Nhất Niệm Vĩnh Hằng': 'https://i.imgur.com/PErY687.png'
        // Link dự phòng (dư): 
        // https://i.imgur.com/X0yjKGM.png
        // https://i.imgur.com/o0fB7xn.png
    };

    const SIEU_VIET_SKILLS_DB = {
        // [MODIFIED] Giảm chi phí Liên Kích Vĩnh Hằng xuống 1
        'sv_double_atk_p': {
            name: 'Liên Kích Vĩnh Hằng',
            desc: 'Tăng vĩnh viễn {value}% tỉ lệ đánh 2 lần (Liên Kích).',
            icon: 'fa-solid fa-angles-right',
            stat: 'doubleAtkChance',
            valuePerLevel: 0.2,
            maxLevel: 50,
            costPerLevel: 1 
        },
        'sv_crit_damage': {
            name: 'Nhất Kích Tất Sát',
            desc: 'Tăng vĩnh viễn {value}% Sát Thương Bạo Kích.',
            icon: 'fa-solid fa-fire-flame-curved',
            stat: 'critDamage',
            valuePerLevel: 2,
            maxLevel: 100, // [MODIFIED] Tăng max level
            costPerLevel: 1
        },
        // [NEW] --- CÁC KỸ NĂNG SIÊU VIỆT MỚI ---
        'sv_atk_p': {
            name: 'Thần Lực Vô Song',
            desc: 'Tăng vĩnh viễn {value}% Công Kích.',
            icon: 'fa-solid fa-khanda',
            stat: 'atk_p',
            valuePerLevel: 1,
            maxLevel: 100,
            costPerLevel: 1
        },
        'sv_hp_p': {
            name: 'Bất Diệt Kim Thân',
            desc: 'Tăng vĩnh viễn {value}% Sinh Lực.',
            icon: 'fa-solid fa-heart',
            stat: 'hp_p',
            valuePerLevel: 1,
            maxLevel: 100,
            costPerLevel: 1
        },
        'sv_def_p': {
            name: 'Kim Cang Hộ Thể',
            desc: 'Tăng vĩnh viễn {value}% Phòng Thủ.',
            icon: 'fa-solid fa-shield-halved',
            stat: 'def_p',
            valuePerLevel: 1,
            maxLevel: 100,
            costPerLevel: 1
        },
        'sv_spd_p': {
            name: 'Lăng Ba Vi Bộ',
            desc: 'Tăng vĩnh viễn {value}% Thân Pháp (Tốc độ).',
            icon: 'fa-solid fa-wind',
            stat: 'spd_p',
            valuePerLevel: 1,
            maxLevel: 100,
            costPerLevel: 1
        },
        'sv_ignore_def': {
            name: 'Phá Giáp Chân Kinh',
            desc: 'Tăng vĩnh viễn {value}% Bỏ qua Phòng Thủ đối phương.',
            icon: 'fa-solid fa-skull',
            stat: 'ignoreDef_p',
            valuePerLevel: 0.5,
            maxLevel: 50,
            costPerLevel: 2
        },
        'sv_lifesteal': {
            name: 'Huyết Ma Đại Pháp',
            desc: 'Tăng vĩnh viễn {value}% Hút Sinh Lực.',
            icon: 'fa-solid fa-droplet',
            stat: 'lifesteal',
            valuePerLevel: 0.2,
            maxLevel: 50,
            costPerLevel: 2
        },
        'sv_crit_chance': {
            name: 'Thiên Nhãn Thông',
            desc: 'Tăng vĩnh viễn {value}% Tỉ lệ Chí Mạng.',
            icon: 'fa-solid fa-eye',
            stat: 'critChance',
            valuePerLevel: 0.5,
            maxLevel: 50,
            costPerLevel: 2
        },
        'sv_xp_boost': {
            name: 'Thông Tuệ Chi Tâm',
            desc: 'Tăng vĩnh viễn {value}% Kinh Nghiệm nhận được.',
            icon: 'fa-solid fa-book-open-reader',
            stat: 'xp_boost',
            valuePerLevel: 5,
            maxLevel: 100,
            costPerLevel: 1
        },
        // [NEW] --- KỸ NĂNG SIÊU VIỆT MỞ RỘNG (V2) ---
        'sv_mana_p': {
            name: 'Khí Hải Vô Lượng',
            desc: 'Tăng vĩnh viễn {value}% Nội Lực tối đa.',
            icon: 'fa-solid fa-flask',
            stat: 'mana_p',
            valuePerLevel: 1,
            maxLevel: 100,
            costPerLevel: 1
        },
        'sv_honLuc_p': {
            name: 'Linh Hồn Bất Diệt',
            desc: 'Tăng vĩnh viễn {value}% Hồn Lực tối đa.',
            icon: 'fa-solid fa-ghost',
            stat: 'honLuc_p',
            valuePerLevel: 1,
            maxLevel: 100,
            costPerLevel: 1
        },
        'sv_lck_p': {
            name: 'Hồng Phúc Tề Thiên',
            desc: 'Tăng vĩnh viễn {value}% May Mắn.',
            icon: 'fa-solid fa-clover',
            stat: 'lck_p',
            valuePerLevel: 1,
            maxLevel: 50,
            costPerLevel: 2
        },
        'sv_dodgeChance': {
            name: 'Huyễn Ảnh Mê Tông',
            desc: 'Tăng vĩnh viễn {value}% Né Tránh.',
            icon: 'fa-solid fa-person-running',
            stat: 'dodgeChance',
            valuePerLevel: 0.5,
            maxLevel: 50,
            costPerLevel: 2
        },
        'sv_accuracy_p': {
            name: 'Tâm Nhãn Thông',
            desc: 'Tăng vĩnh viễn {value}% Chính Xác.',
            icon: 'fa-solid fa-crosshairs',
            stat: 'accuracy_p',
            valuePerLevel: 1,
            maxLevel: 50,
            costPerLevel: 1
        },
        'sv_block_chance_p': {
            name: 'Thiết Bố Sam',
            desc: 'Tăng vĩnh viễn {value}% Tỉ lệ Chống Đỡ.',
            icon: 'fa-solid fa-shield',
            stat: 'block_chance_p',
            valuePerLevel: 0.5,
            maxLevel: 50,
            costPerLevel: 2
        },
        'sv_anti_crit_p': {
            name: 'Hộ Thể Thần Công',
            desc: 'Tăng vĩnh viễn {value}% Kháng Bạo Kích.',
            icon: 'fa-solid fa-shield-virus',
            stat: 'anti_crit_p',
            valuePerLevel: 1,
            maxLevel: 50,
            costPerLevel: 1
        },
        'sv_manasteal': {
            name: 'Hấp Tinh Đại Pháp',
            desc: 'Tăng vĩnh viễn {value}% Hút Nội Lực.',
            icon: 'fa-solid fa-hand-holding-droplet',
            stat: 'manasteal',
            valuePerLevel: 0.2,
            maxLevel: 50,
            costPerLevel: 2
        }
    };

    // [MODIFIED] TALENT_DB - Thêm chỉ số (stats) và mô tả (desc) đơn giản hóa
    // [UPDATED] Đã thêm rất nhiều Thiên Phú mới đa dạng hơn
    const TALENT_DB = [
    // --- ETERNAL (Vĩnh Hằng - Tỉ lệ cực thấp) ---
    { name: "Nhất Niệm Vĩnh Hằng", quality: "eternal", desc: "Cộng 1.000.000 HP và 100.000 Toàn bộ chỉ số.", stats: { hp: 1000000, atk: 100000, def: 100000, spd: 100000, lck: 100000, mana: 100000 } },
    { name: "Vĩnh Sinh Bất Tử", quality: "eternal", desc: "Cộng 2.000.000 Sinh Lực và 50% Hút Máu.", stats: { hp: 2000000, lifesteal: 50 } }, 
    { name: "Đạo Sinh Nhất", quality: "eternal", desc: "Cộng 150.000 Công Kích và 50% Sát Thương Bạo Kích.", stats: { atk: 150000, critDamage: 50 } }, 
    { name: "Chúa Tể Hư Vô", quality: "eternal", desc: "Cộng 100.000 Thân Pháp và 20% Né Tránh.", stats: { spd: 100000, dodge: 20 } }, 
    { name: "Chân Lý Chi Môn", quality: "eternal", desc: "Cộng 100.000 Phòng Thủ và 100 Sĩ Khí.", stats: { def: 100000, si_khi: 100 } }, 
    { name: "Hỗn Độn Sơ Khai", quality: "eternal", desc: "Cộng 200.000 Nội Lực, 20% Hút Nội Lực và 20% Chính Xác.", stats: { mana: 200000, manasteal: 20, accuracy: 20 } },
    { name: "Vạn Kiếm Quy Tông", quality: "eternal", desc: "Vạn kiếm thần phục. Cộng 200.000 Công Kích, 20% Chí Mạng và 50% ST Bạo Kích.", stats: { atk: 200000, crit: 20, critDamage: 50 } }, // [NEW]
    { name: "Huyết Hải Ma Tổ", quality: "eternal", desc: "Bất tử trong biển máu. Cộng 1.500.000 HP và 40% Hút Máu.", stats: { hp: 1500000, lifesteal: 40 } }, // [NEW]
    { name: "Thời Không Chi Chủ", quality: "eternal", desc: "Điều khiển thời gian. Cộng 150.000 Thân Pháp, 30% Né Tránh và 30% Chính Xác.", stats: { spd: 150000, dodge: 30, accuracy: 30 } }, // [NEW]
    { name: "Ngũ Hành Chi Chủ", quality: "eternal", desc: "Nắm giữ ngũ hành. Cộng 50.000 Toàn bộ chỉ số và 10% Hút Sinh Lực/Nội Lực.", stats: { hp: 50000, atk: 50000, def: 50000, spd: 50000, lck: 50000, mana: 50000, lifesteal: 10, manasteal: 10 } }, // [NEW]
    { name: "Hư Không Đại Đế", quality: "eternal", desc: "Vua của hư không. Cộng 200.000 Thân Pháp và 25% Né Tránh.", stats: { spd: 200000, dodge: 25 } }, // [NEW]
    { name: "Hỗn Nguyên Thánh Thể", quality: "eternal", desc: "Thân thể hoàn mỹ. Cộng 60.000 Toàn bộ chỉ số.", stats: { hp: 60000, atk: 60000, def: 60000, spd: 60000, lck: 60000, mana: 60000 } }, // [NEW]

    // --- SUPERGODLY (Siêu Thần) ---
    { name: "Huyết Tổ Chuyển Thế", quality: "supergodly", desc: "Cộng 30% Hút Máu và 500.000 HP.", stats: { lifesteal: 30, hp: 500000 } }, 
    { name: "Thôn Thiên Phệ Địa", quality: "supergodly", desc: "Cộng 30% Hút Nội Lực và 200.000 Mana.", stats: { manasteal: 30, mana: 200000 } }, 
    { name: "Đấu Chiến Thắng Phật", quality: "supergodly", desc: "Cộng 50 Sĩ Khí và 50.000 Công Kích.", stats: { si_khi: 50, atk: 50000 } }, 
    { name: "Bàn Cổ Chân Thân", quality: "supergodly", desc: "Cộng 800.000 HP và 50.000 Phòng thủ.", stats: { hp: 800000, def: 50000 } },
    { name: "Tam Thanh Chuyển Thế", quality: "supergodly", desc: "Cộng 50.000 Công Kích và 20% Chính Xác.", stats: { atk: 50000, accuracy: 20 } }, 
    { name: "Nguyên Thủy Đạo Thai", quality: "supergodly", desc: "Cộng 300.000 HP và 30.000 Toàn bộ chỉ số.", stats: { hp: 300000, atk: 30000, def: 30000, spd: 30000, lck: 30000, mana: 30000 } },
    { name: "Hỗn Độn Thần Ma", quality: "supergodly", desc: "Cộng 60.000 Công Kích và 20% Bạo Kích.", stats: { atk: 60000, crit: 20 } }, 
    { name: "Diệt Thế Hắc Liên", quality: "supergodly", desc: "Cộng 50.000 Công Kích và 100% ST Bạo Kích.", stats: { atk: 50000, critDamage: 100 } }, 
    { name: "Tạo Hóa Ngọc Điệp", quality: "supergodly", desc: "Cộng 50.000 May mắn và 50.000 Hồn Lực.", stats: { lck: 50000, honLuc: 50000 } }, 
    { name: "Thí Thần Giả", quality: "supergodly", desc: "Cộng 50.000 Công Kích.", stats: { atk: 50000 } },
    { name: "Thần Nông Bách Thảo", quality: "supergodly", desc: "Cộng 200.000 HP và 20% Hiệu quả Hút Máu.", stats: { hp: 200000, lifesteal: 20 } },
    { name: "Chiến Thần Hình Thái", quality: "supergodly", desc: "Hóa thân chiến tranh. Cộng 80.000 Công Kích và 30 Sĩ Khí.", stats: { atk: 80000, si_khi: 30 } },
    { name: "Bất Diệt Ma Thân", quality: "supergodly", desc: "Cơ thể bất hoại. Cộng 600.000 HP, 40.000 Thủ và 15% Hút Máu.", stats: { hp: 600000, def: 40000, lifesteal: 15 } },
    { name: "Ảnh Sát Chi Chủ", quality: "supergodly", desc: "Bóng ma ám sát. Cộng 50.000 Thân Pháp, 20% Né Tránh và 10% Bạo Kích.", stats: { spd: 50000, dodge: 20, crit: 10 } },
    { name: "Pháp Thần Giáng Thế", quality: "supergodly", desc: "Cộng 300.000 Nội Lực, 20% Hút Nội Lực và 60.000 Công Kích.", stats: { mana: 300000, manasteal: 20, atk: 60000 } },
    { name: "Hiên Viên Hoàng Đế", quality: "supergodly", desc: "Cộng 70.000 Công Kích, 20% Chính Xác và 20% ST Bạo Kích.", stats: { atk: 70000, accuracy: 20, critDamage: 20 } },
    { name: "Kiếm Đạo Độc Tôn", quality: "supergodly", desc: "Độc bộ kiếm đạo. Cộng 70.000 Công Kích và 40% ST Bạo Kích.", stats: { atk: 70000, critDamage: 40 } }, // [NEW]
    { name: "Vạn Pháp Quy Tông", quality: "supergodly", desc: "Pháp thuật vô biên. Cộng 250.000 Nội Lực và 25% Hút Nội Lực.", stats: { mana: 250000, manasteal: 25 } }, // [NEW]
    { name: "Cửu U Minh Vương", quality: "supergodly", desc: "Chúa tể cõi chết. Cộng 40 Sĩ Khí và 40.000 Phòng Thủ.", stats: { si_khi: 40, def: 40000 } }, // [NEW]
    { name: "Thái Dương Thần Thể", quality: "supergodly", desc: "Thân thể mặt trời. Cộng 300.000 HP và 40.000 Công Kích.", stats: { hp: 300000, atk: 40000 } }, // [NEW]

    // --- SUPREME (Chí Tôn) ---
    { name: "Xuyên Dương Tiễn", quality: "supreme", desc: "Cộng 30% Chính Xác và 30.000 Công Kích.", stats: { accuracy: 30, atk: 30000 } }, 
    { name: "Lăng Ba Vi Bộ", quality: "supreme", desc: "Cộng 20% Né Tránh và 40.000 Thân Pháp.", stats: { dodge: 20, spd: 40000 } }, 
    { name: "Cuồng Bạo Chi Huyết", quality: "supreme", desc: "Cộng 15% Bạo Kích và 10% Hút Máu.", stats: { crit: 15, lifesteal: 10 } }, 
    { name: "Chí Tôn Cốt", quality: "supreme", desc: "Cộng 200.000 HP và 20.000 Toàn bộ chỉ số.", stats: { hp: 200000, atk: 20000, def: 20000, spd: 20000, lck: 20000, mana: 20000 } },
    { name: "Trọng Đồng Giả", quality: "supreme", desc: "Cộng 30.000 Công Kích và 15% Chính Xác.", stats: { atk: 30000, accuracy: 15 } }, 
    { name: "Thương Thiên Bá Thể", quality: "supreme", desc: "Cộng 50.000 Phòng thủ và 20 Sĩ Khí.", stats: { def: 50000, si_khi: 20 } }, 
    { name: "Hoang Cổ Thánh Thể", quality: "supreme", desc: "Cộng 500.000 HP và 30.000 Công Kích.", stats: { hp: 500000, atk: 30000 } },
    { name: "Thiên Đạo Chi Nhãn", quality: "supreme", desc: "Cộng 40.000 Công Kích.", stats: { atk: 40000 } },
    { name: "Thần Tượng Trấn Ngục", quality: "supreme", desc: "Cộng 50.000 Công Kích.", stats: { atk: 50000 } },
    { name: "Vạn Pháp Bất Xâm", quality: "supreme", desc: "Cộng 50.000 Phòng thủ.", stats: { def: 50000 } },
    { name: "Độc Đoạn Vạn Cổ", quality: "supreme", desc: "Cộng 40.000 Thân Pháp.", stats: { spd: 40000 } },
    { name: "Cửu Khiếu Linh Lung", quality: "supreme", desc: "Cộng 10.000 Hồn Lực và 30% Hút Nội Lực.", stats: { honLuc: 10000, manasteal: 30 } },
    { name: "Vô Cấu Tiên Thể", quality: "supreme", desc: "Cộng 300.000 HP và Kháng mọi hiệu ứng (mô phỏng +20% Né Tránh).", stats: { hp: 300000, dodge: 20 } },
    { name: "Bắc Minh Thần Công", quality: "supreme", desc: "Hấp tinh đại pháp. Cộng 150.000 Nội Lực và 25% Hút Nội Lực.", stats: { mana: 150000, manasteal: 25 } },
    { name: "Tiểu Lý Phi Đao", quality: "supreme", desc: "Xuất đao tất trúng. Cộng 40.000 Công Kích và 40% Chính Xác.", stats: { atk: 40000, accuracy: 40 } },
    { name: "Lục Mạch Thần Kiếm", quality: "supreme", desc: "Kiếm khí tung hoành. Cộng 45.000 Công Kích và 15% Chí Mạng.", stats: { atk: 45000, crit: 15 } },
    { name: "Giáng Long Thập Bát Chưởng", quality: "supreme", desc: "Cương mãnh đệ nhất. Cộng 50.000 Công Kích và 15 Sĩ Khí.", stats: { atk: 50000, si_khi: 15 } },
    { name: "Cửu Dương Thần Công", quality: "supreme", desc: "Nội lực vô tận. Cộng 40.000 Công Kích, 40.000 Phòng Thủ và 100.000 HP.", stats: { atk: 40000, def: 40000, hp: 100000 } },
    { name: "Độc Cô Cửu Kiếm", quality: "supreme", desc: "Phá giải mọi chiêu thức. Cộng 45.000 Công Kích và 30% ST Bạo Kích.", stats: { atk: 45000, critDamage: 30 } },
    { name: "Thiên Hình Giả", quality: "supreme", desc: "Kẻ thay trời hành đạo. Cộng 35.000 Công Kích và 25 Sĩ Khí.", stats: { atk: 35000, si_khi: 25 } }, // [NEW]
    { name: "Bất Tử Điểu", quality: "supreme", desc: "Phượng hoàng tái sinh. Cộng 600.000 HP và 12% Hút Máu.", stats: { hp: 600000, lifesteal: 12 } }, // [NEW]
    { name: "Lôi Thần Phụ Thể", quality: "supreme", desc: "Sức mạnh sấm sét. Cộng 40.000 Thân Pháp và 15% Chí Mạng.", stats: { spd: 40000, crit: 15 } }, // [NEW]
    { name: "Băng Phong Vạn Dặm", quality: "supreme", desc: "Lãnh địa băng giá. Cộng 40.000 Phòng Thủ và 15% Né Tránh.", stats: { def: 40000, dodge: 15 } }, // [NEW]

    // --- MYTHIC (Thần Thoại) ---
    { name: "Hấp Tinh Đại Pháp", quality: "mythic", desc: "Cộng 15% Hút Nội Lực.", stats: { manasteal: 15 } }, 
    { name: "Kim Cang Bất Hoại", quality: "mythic", desc: "Cộng 30.000 Thủ và 10% Hút Máu.", stats: { def: 30000, lifesteal: 10 } }, 
    { name: "Ưng Nhãn", quality: "mythic", desc: "Cộng 10% Chính Xác và 10% Bạo Kích.", stats: { accuracy: 10, crit: 10 } }, 
    { name: "Thiên Mệnh Chi Tử", quality: "mythic", desc: "Cộng 10.000 May mắn.", stats: { lck: 10000 } },
    { name: "Thiên Mệnh Chi Tôn", quality: "mythic", desc: "Cộng 200.000 HP và 20.000 Công Kích.", stats: { hp: 200000, atk: 20000 } },
    { name: "Phượng Hoàng Linh Thể", quality: "mythic", desc: "Cộng 300.000 HP.", stats: { hp: 300000 } },
    { name: "Hỗn Độn Đạo Thai", quality: "mythic", desc: "Cộng 100.000 HP và 10.000 Toàn bộ chỉ số.", stats: { hp: 100000, atk: 10000, def: 10000, spd: 10000, lck: 10000, mana: 10000 } },
    { name: "Nhân Hoàng Huyết Mạch", quality: "mythic", desc: "Cộng 25.000 Phòng thủ và 10 Sĩ Khí.", stats: { def: 25000, si_khi: 10 } }, 
    { name: "Long Thần Phụ Thể", quality: "mythic", desc: "Cộng 25.000 Công Kích.", stats: { atk: 25000 } },
    { name: "Tiên Thiên Đạo Thể", quality: "mythic", desc: "Cộng 25.000 Công Kích.", stats: { atk: 25000 } },
    { name: "Vạn Cổ Bất Diệt", quality: "mythic", desc: "Cộng 400.000 HP.", stats: { hp: 400000 } },
    { name: "Thời Không Chi Chủ", quality: "mythic", desc: "Cộng 30.000 Thân pháp.", stats: { spd: 30000 } },
    { name: "Cửu Kiếp Tiên Tôn", quality: "mythic", desc: "Cộng 20.000 Công và 20.000 Thủ.", stats: { atk: 20000, def: 20000 } },
    { name: "Sát Thần Chuyển Thế", quality: "mythic", desc: "Cộng 25.000 Công Kích và 5% Hút Máu.", stats: { atk: 25000, lifesteal: 5 } }, 
    { name: "Chân Long Chi Khí", quality: "mythic", desc: "Cộng 20.000 Công và 20.000 Thủ.", stats: { atk: 20000, def: 20000 } },
    { name: "Thái Cổ Thánh Thể", quality: "mythic", desc: "Cộng 350.000 HP.", stats: { hp: 350000 } },
    { name: "Cửu Dương Chi Thể", quality: "mythic", desc: "Cộng 25.000 Công Kích.", stats: { atk: 25000 } },
    { name: "Thần Ma Đồng Thể", quality: "mythic", desc: "Cộng 30.000 Công Kích.", stats: { atk: 30000 } },
    { name: "Hệ Thống Gia Thân", quality: "mythic", desc: "Cộng 15.000 Toàn bộ chỉ số.", stats: { hp: 150000, atk: 15000, def: 15000, spd: 15000, lck: 15000, mana: 15000 } },
    { name: "Trọng Sinh Giả", quality: "mythic", desc: "Cộng 250.000 HP và 25.000 May mắn.", stats: { hp: 250000, lck: 25000 } },
    { name: "Thiên Sát Cô Tinh", quality: "mythic", desc: "Cộng 30.000 Công Kích và 15% Bạo Kích.", stats: { atk: 30000, crit: 15 } },
    { name: "Hàn Băng Thần Thể", quality: "mythic", desc: "Cộng 30.000 Phòng Thủ và 10% Né Tránh.", stats: { def: 30000, dodge: 10 } },
    { name: "Phong Hành Giả", quality: "mythic", desc: "Cộng 35.000 Thân Pháp và 8% Né Tránh.", stats: { spd: 35000, dodge: 8 } }, // [NEW]
    { name: "Cuồng Chiến Sĩ", quality: "mythic", desc: "Cộng 35.000 Công Kích và 8% Chí Mạng.", stats: { atk: 35000, crit: 8 } }, // [NEW]
    { name: "Độc Cô Cầu Bại", quality: "mythic", desc: "Cộng 40.000 Công Kích và 10% Chính Xác.", stats: { atk: 40000, accuracy: 10 } }, // [NEW]
    { name: "Dược Vương Tái Thế", quality: "mythic", desc: "Cộng 400.000 HP và 8% Hút Máu.", stats: { hp: 400000, lifesteal: 8 } }, // [NEW]

    // --- EPIC (Sử Thi) ---
    { name: "Quỷ Thủ", quality: "epic", desc: "Cộng 5% Chí Mạng và 5.000 Công Kích.", stats: { crit: 5, atk: 5000 } }, 
    { name: "Ảnh Vũ", quality: "epic", desc: "Cộng 5% Né Tránh và 5.000 Thân Pháp.", stats: { dodge: 5, spd: 5000 } }, 
    { name: "Huyết Cuồng", quality: "epic", desc: "Cộng 5% Hút Máu.", stats: { lifesteal: 5 } }, 
    { name: "Ma Tâm", quality: "epic", desc: "Cộng 5% Hút Nội Lực.", stats: { manasteal: 5 } },
    { name: "Chiến Ý", quality: "epic", desc: "Cộng 5 Sĩ Khí.", stats: { si_khi: 5 } },
    { name: "Thiện Xạ", quality: "epic", desc: "Cộng 5% Chính Xác.", stats: { accuracy: 5 } },
    { name: "Bạo Liệt", quality: "epic", desc: "Cộng 20% Sát Thương Bạo Kích.", stats: { critDamage: 20 } },
    { name: "Đại Trí Nhược Ngu", quality: "epic", desc: "Cộng 5.000 Phòng thủ.", stats: { def: 5000 } },
    { name: "Đạo Ma Chuyển Thế", quality: "epic", desc: "Cộng 5.000 Công Kích.", stats: { atk: 5000 } },
    { name: "Cuồng Vọng Tự Đại", quality: "epic", desc: "Cộng 7.000 Công Kích, Trừ 1.000 Thủ.", stats: { atk: 7000, def: -1000 } },
    { name: "Kiếm Tâm Thông Minh", quality: "epic", desc: "Cộng 5.000 Công Kích.", stats: { atk: 5000 } },
    { name: "Thiên Sinh Thần Lực", quality: "epic", desc: "Cộng 8.000 Công Kích, Trừ 1.000 Tốc.", stats: { atk: 8000, spd: -1000 } },
    { name: "Lôi Linh Căn", quality: "epic", desc: "Cộng 5.000 Công Kích.", stats: { atk: 5000 } },
    { name: "Hỏa Linh Căn", quality: "epic", desc: "Cộng 5.000 Công Kích.", stats: { atk: 5000 } },
    { name: "Băng Tâm Ngọc Cốt", quality: "epic", desc: "Cộng 6.000 Phòng Thủ.", stats: { def: 6000 } },
    { name: "Phúc Tinh Cao Chiếu", quality: "epic", desc: "Cộng 5.000 May mắn.", stats: { lck: 5000 } },
    { name: "Võ Học Kỳ Tài", quality: "epic", desc: "Cộng 5.000 Công Kích.", stats: { atk: 5000 } },
    { name: "Thiên Lý Nhãn", quality: "epic", desc: "Cộng 5.000 Công Kích và 5% Chính xác.", stats: { atk: 5000, accuracy: 5 } }, 
    { name: "Thuận Phong Nhĩ", quality: "epic", desc: "Cộng 5.000 Thân Pháp và 3% Né tránh.", stats: { spd: 5000, dodge: 3 } }, 
    { name: "Thiên Linh Căn", quality: "epic", desc: "Cộng 5.000 Công Kích.", stats: { atk: 5000 } },
    { name: "Dị Hỏa Nhận Chủ", quality: "epic", desc: "Cộng 6.000 Công Kích.", stats: { atk: 6000 } },
    { name: "Luyện Đan Tông Sư", quality: "epic", desc: "Cộng 50.000 HP.", stats: { hp: 50000 } },
    { name: "Vô Cấu Chi Thể", quality: "epic", desc: "Cộng 50.000 HP.", stats: { hp: 50000 } },
    { name: "Huyết Mạch Phản Tổ", quality: "epic", desc: "Cộng 40.000 HP.", stats: { hp: 40000 } },
    { name: "Thiên Sinh Mị Cốt", quality: "epic", desc: "Cộng 5.000 Thân Pháp.", stats: { spd: 5000 } },
    { name: "Đào Hoa Vận", quality: "epic", desc: "Cộng 5.000 May mắn.", stats: { lck: 5000 } },
    { name: "Thiện Xạ", quality: "epic", desc: "Cộng 6.000 Công Kích và 8% Chính Xác.", stats: { atk: 6000, accuracy: 8 } }, // [NEW]
    { name: "Thiết Bích", quality: "epic", desc: "Cộng 8.000 Phòng Thủ.", stats: { def: 8000 } }, // [NEW]
    { name: "Thần Tốc", quality: "epic", desc: "Cộng 8.000 Thân Pháp.", stats: { spd: 8000 } }, // [NEW]
    { name: "Cuồng Đao", quality: "epic", desc: "Cộng 8.000 Công Kích.", stats: { atk: 8000 } }, // [NEW]
    { name: "Hộ Pháp", quality: "epic", desc: "Cộng 100.000 HP và 2.000 Thủ.", stats: { hp: 100000, def: 2000 } }, // [NEW]

    // --- RARE (Quý) ---
    { name: "Thợ Săn", quality: "rare", desc: "Cộng 3% Chính Xác.", stats: { accuracy: 3 } }, 
    { name: "Lanh Lẹ", quality: "rare", desc: "Cộng 2% Né Tránh.", stats: { dodge: 2 } }, 
    { name: "Hung Hăng", quality: "rare", desc: "Cộng 2% Bạo Kích.", stats: { crit: 2 } }, 
    { name: "Khát Máu", quality: "rare", desc: "Cộng 2% Hút Máu.", stats: { lifesteal: 2 } }, 
    { name: "Tham Lam", quality: "rare", desc: "Cộng 2% Hút Nội Lực.", stats: { manasteal: 2 } }, 
    { name: "Cố Chấp", quality: "rare", desc: "Cộng 1 Sĩ Khí.", stats: { si_khi: 1 } }, 
    { name: "Thổ Mộc Đạo Thai", quality: "rare", desc: "Cộng 1.000 Phòng thủ.", stats: { def: 1000 } },
    { name: "Vân Du Thiên Hạ", quality: "rare", desc: "Cộng 1.000 Thân pháp.", stats: { spd: 1000 } },
    { name: "Khí Vận Gia Thân", quality: "rare", desc: "Cộng 1.000 May mắn.", stats: { lck: 1000 } },
    { name: "Cốt Cách Tinh Kỳ", quality: "rare", desc: "Cộng 10.000 HP.", stats: { hp: 10000 } },
    { name: "Sức Mạnh Hơn Người", quality: "rare", desc: "Cộng 1.000 Công Kích.", stats: { atk: 1000 } },
    { name: "Thân Thủ Nhanh Nhẹn", quality: "rare", desc: "Cộng 1.000 Thân Pháp.", stats: { spd: 1000 } },
    { name: "Trí Nhớ Siêu Phàm", quality: "rare", desc: "Cộng 500 Toàn bộ chỉ số.", stats: { hp: 5000, atk: 500, def: 500, spd: 500, lck: 500, mana: 500 } },
    { name: "Khéo Tay Hay Làm", quality: "rare", desc: "Cộng 500 Công Kích.", stats: { atk: 500 } },
    { name: "Nhìn Xa Trông Rộng", quality: "rare", desc: "Cộng 500 Thân Pháp.", stats: { spd: 500 } },
    { name: "Đa Tài Đa Nghệ", quality: "rare", desc: "Cộng 500 May mắn.", stats: { lck: 500 } },
    { name: "Võ Si", quality: "rare", desc: "Cộng 500 Công và 500 Thủ.", stats: { atk: 500, def: 500 } },
    { name: "Căn Cốt Thượng Giai", quality: "rare", desc: "Cộng 10.000 HP.", stats: { hp: 10000 } },
    { name: "Ngộ Tính Cao", quality: "rare", desc: "Cộng 1.000 Công Kích.", stats: { atk: 1000 } },
    { name: "Ý Chí Kiên Định", quality: "rare", desc: "Cộng 1.000 Phòng thủ.", stats: { def: 1000 } },
    { name: "Con Nhà Giàu", quality: "rare", desc: "Cộng 1.000 May mắn.", stats: { lck: 1000 } },
    { name: "Dòng Dõi Thư Hương", quality: "rare", desc: "Cộng 500 Nội lực.", stats: { mana: 500 } },
    { name: "Thích Đọc Sách", quality: "rare", desc: "Cộng 500 Nội lực.", stats: { mana: 500 } },
    { name: "Lì Lợm", quality: "rare", desc: "Cộng 2.000 HP.", stats: { hp: 2000 } }, // [NEW]
    { name: "Nhanh Nhẹn", quality: "rare", desc: "Cộng 200 Thân Pháp.", stats: { spd: 200 } }, // [NEW]

    // --- UNCOMMON (Thường) ---
    { name: "Nóng Tính", quality: "uncommon", desc: "Cộng 1% Bạo Kích.", stats: { crit: 1 } }, 
    { name: "Cẩn Thận", quality: "uncommon", desc: "Cộng 1% Né Tránh.", stats: { dodge: 1 } }, 
    { name: "Tiểu Đan Đồng", quality: "uncommon", desc: "Cộng 200 Nội Lực.", stats: { mana: 200 } },
    { name: "Tay Chân Lanh Lẹ", quality: "uncommon", desc: "Cộng 200 Thân Pháp.", stats: { spd: 200 } },
    { name: "Sức Khỏe Dồi Dào", quality: "uncommon", desc: "Cộng 2.000 HP.", stats: { hp: 2000 } },
    { name: "Sơ Nhập Giang Hồ", quality: "uncommon", desc: "Cộng 100 Toàn bộ chỉ số.", stats: { hp: 1000, atk: 100, def: 100, spd: 100, lck: 100, mana: 100 } },
    { name: "Chăm Chỉ", quality: "uncommon", desc: "Cộng 1.000 HP.", stats: { hp: 1000 } },
    { name: "Thật Thà", quality: "uncommon", desc: "Cộng 100 Phòng thủ.", stats: { def: 100 } },
    { name: "Ăn Nhiều", quality: "uncommon", desc: "Cộng 2.000 HP.", stats: { hp: 2000 } },
    { name: "Ngủ Kỹ", quality: "uncommon", desc: "Cộng 1.000 HP.", stats: { hp: 1000 } },
    { name: "Yêu Động Vật", quality: "uncommon", desc: "Cộng 100 May mắn.", stats: { lck: 100 } },
    { name: "Thích Tiền", quality: "uncommon", desc: "Cộng 100 May mắn.", stats: { lck: 100 } },
    { name: "Sợ Chết", quality: "uncommon", desc: "Cộng 100 Phòng thủ.", stats: { def: 100 } },
    { name: "Biết Nấu Ăn", quality: "uncommon", desc: "Cộng 1.000 HP.", stats: { hp: 1000 } },
    { name: "Hay Quên", quality: "uncommon", desc: "Trừ 200 Nội lực.", stats: { mana: -200 } },
    { name: "Mù Đường", quality: "uncommon", desc: "Trừ 20 Thân pháp.", stats: { spd: -20 } },
    { name: "Nhiệt Tình", quality: "uncommon", desc: "Cộng 1.000 HP.", stats: { hp: 1000 } },
    { name: "Cộc Tính", quality: "uncommon", desc: "Cộng 50 Công Kích.", stats: { atk: 50 } }, // [NEW]
    { name: "Nhát Gan", quality: "uncommon", desc: "Cộng 100 Phòng Thủ.", stats: { def: 100 } } // [NEW]
];

    // [NEW] Helper: Lấy ngẫu nhiên thiên phú dựa trên ID đệ tử
    // [MODIFIED] Cập nhật logic: Tối đa 2 thiên phú, tỷ lệ phụ thuộc vào phẩm chất
    function getDiscipleTalents(discipleId, potential = 'Yếu Kém') {
        // Danh sách các tư chất được coi là "Thiên Tài trở lên" để lọc pool xịn
        const highTierPotentials = new Set([
            'Thiên Tài', 
            'Tuyệt Thế', 
            'Thiên Kiêu Chi Tử', 
            'Nghịch Thiên Cải Mệnh', 
            'Vô Cực Đạo Thể', 
            'Vạn Đạo Chi Tổ', 
            'Chân Ngã Duy Nhất', 
            'Nhất Niệm Vĩnh Hằng'
        ]);

        // Danh sách các phẩm chất bị cấm đối với người thường (Cam trở lên)
        const restrictedQualities = new Set(['eternal', 'supergodly', 'supreme', 'mythic']);

        // Lọc Pool dựa trên tư chất
        let pool = [];
        if (highTierPotentials.has(potential)) {
            // Thiên tài: Được dùng toàn bộ kho
            pool = [...TALENT_DB]; 
        } else {
            // Phàm nhân: Chỉ được dùng Tím (Epic) trở xuống
            pool = TALENT_DB.filter(t => !restrictedQualities.has(t.quality));
        }

        // Seed logic (Giữ nguyên để cố định theo ID)
        let seed = 0;
        for (let i = 0; i < discipleId.length; i++) {
            seed = (seed + discipleId.charCodeAt(i)) % 1000;
        }
        
        // [NEW] Xác định số lượng thiên phú (1 hoặc 2) dựa trên phẩm chất
        let chanceForTwo = 0; // Tỷ lệ % có 2 thiên phú
        
        switch (potential) {
            case 'Yếu Kém': chanceForTwo = 10; break;       // 10%
            case 'Bình Thường': chanceForTwo = 20; break;   // 20%
            case 'Khá': chanceForTwo = 35; break;           // 35%
            case 'Tốt': chanceForTwo = 50; break;           // 50%
            case 'Thiên Tài': chanceForTwo = 75; break;     // 75%
            case 'Tuyệt Thế': chanceForTwo = 90; break;     // 90%
            default: chanceForTwo = 100; break;             // Các cấp cao hơn: 100% có 2 thiên phú
        }

        // Dùng seed để quyết định số lượng (để cố định với mỗi đệ tử)
        // Sử dụng phép tính khác với seed chọn skill để tránh trùng lặp logic
        const countSeed = (seed * 17 + 23) % 100; 
        const talentCount = (countSeed < chanceForTwo) ? 2 : 1;
        
        const talents = [];
        const shuffledDB = [...pool]; // Sử dụng pool đã lọc
        
        // Safety check
        if (shuffledDB.length < talentCount) {
             return shuffledDB;
        }

        for (let i = 0; i < talentCount; i++) {
            const index = (seed + (i * 31) + (i * i)) % shuffledDB.length;
            talents.push(shuffledDB[index]);
            shuffledDB.splice(index, 1);
        }
        
        // Sắp xếp lại theo phẩm chất (Vĩnh Hằng -> Siêu Thần -> Chí Tôn -> ...)
        const qualityOrder = { 
            'eternal': 7,
            'supergodly': 6,
            'supreme': 5,
            'mythic': 4, 
            'epic': 3, 
            'rare': 2, 
            'uncommon': 1 
        };
        talents.sort((a, b) => qualityOrder[b.quality] - qualityOrder[a.quality]);
        
        return talents;
    }

    // [NEW] Helper: Lấy class màu sắc cho thiên phú UI (Dạng Text Badge)
    function getTalentColorClass(quality) {
        // ... (Giữ nguyên code cũ) ...
        switch(quality) {
            case 'eternal': return 'bg-black/90 border-cyan-400 text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-white to-cyan-300 font-black shadow-[0_0_15px_rgba(34,211,238,0.8)] animate-pulse border';
            case 'supergodly': return 'bg-black/90 border-red-500 text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-fuchsia-500 to-red-500 font-black shadow-[0_0_15px_rgba(239,68,68,0.8)] border';
            case 'supreme': return 'bg-yellow-900/90 border-yellow-400 text-yellow-200 font-bold shadow-[0_0_10px_rgba(250,204,21,0.6)] border';
            case 'mythic': return 'bg-orange-900/80 border-orange-500 text-orange-200 shadow-[0_0_5px_rgba(249,115,22,0.5)] border';
            case 'epic': return 'bg-purple-900/80 border-purple-500 text-purple-200 shadow-[0_0_5px_rgba(168,85,247,0.5)] border';
            case 'rare': return 'bg-blue-900/80 border-blue-500 text-blue-200 border';
            case 'uncommon': return 'bg-green-900/80 border-green-600 text-green-200 border';
            default: return 'bg-gray-800 border-gray-600 text-gray-300 border';
        }
    }

    // [NEW] Bảng Quy Hoạch Chỉ Số Theo Cấp Bậc Đệ Tử (Rank Bonus)
    // [MODIFIED] Thêm chỉ số accuracy, lifesteal, manasteal, si_khi
    const RANK_BONUS_STATS = {
        'Ngoại Môn Đệ Tử':      { hp: 75,       atk: 25,      def: 25,      spd: 25,      mana: 25,     honLuc: 25,     crit: 0,   dodge: 0,   critDamage: 0,   accuracy: 0,   lifesteal: 0,   manasteal: 0,   si_khi: 0 },
        'Nội Môn Đệ Tử':        { hp: 300,      atk: 100,     def: 100,     spd: 100,     mana: 100,    honLuc: 100,    crit: 1,   dodge: 1,   critDamage: 5,   accuracy: 1,   lifesteal: 0,   manasteal: 0,   si_khi: 1 },
        'Hạch Tâm Đệ Tử':       { hp: 1500,     atk: 500,     def: 500,     spd: 500,     mana: 500,    honLuc: 500,    crit: 2,   dodge: 2,   critDamage: 10,  accuracy: 2,   lifesteal: 1,   manasteal: 0,   si_khi: 2 },
        'Chân Truyền Đệ Tử':    { hp: 6000,     atk: 2000,    def: 2000,    spd: 2000,    mana: 2000,   honLuc: 2000,   crit: 3,   dodge: 3,   critDamage: 15,  accuracy: 3,   lifesteal: 1,   manasteal: 1,   si_khi: 3 },
        'Thánh Tử / Thánh Nữ':  { hp: 20000,    atk: 5000,    def: 5000,    spd: 5000,    mana: 5000,   honLuc: 5000,   crit: 4,   dodge: 4,   critDamage: 20,  accuracy: 4,   lifesteal: 2,   manasteal: 1,   si_khi: 5 },
        'Hộ Pháp':              { hp: 60000,    atk: 15000,   def: 15000,   spd: 15000,   mana: 15000,  honLuc: 15000,  crit: 5,   dodge: 5,   critDamage: 25,  accuracy: 5,   lifesteal: 2,   manasteal: 2,   si_khi: 7 },
        'Trưởng Lão':           { hp: 150000,   atk: 37500,   def: 37500,   spd: 37500,   mana: 37500,  honLuc: 37500,  crit: 6,   dodge: 6,   critDamage: 30,  accuracy: 6,   lifesteal: 3,   manasteal: 2,   si_khi: 10 },
        'Đại Trưởng Lão':       { hp: 300000,   atk: 75000,   def: 75000,   spd: 75000,   mana: 75000,  honLuc: 75000,  crit: 7,   dodge: 7,   critDamage: 35,  accuracy: 7,   lifesteal: 3,   manasteal: 3,   si_khi: 15 },
        
        // Cấp bậc cao cấp (Level 100+)
        'Thái Thượng Trưởng Lão': { hp: 600000,   atk: 150000,  def: 150000,  spd: 150000,  mana: 150000, honLuc: 150000, crit: 8,   dodge: 8,   critDamage: 40,  accuracy: 8,   lifesteal: 4,   manasteal: 3,   si_khi: 20 },
        'Thánh Trưởng Lão':       { hp: 1000000,  atk: 250000,  def: 250000,  spd: 250000,  mana: 250000, honLuc: 250000, crit: 9,   dodge: 9,   critDamage: 45,  accuracy: 9,   lifesteal: 4,   manasteal: 4,   si_khi: 25 },
        'Hộ Tông Sứ':             { hp: 1500000,  atk: 375000,  def: 375000,  spd: 375000,  mana: 375000, honLuc: 375000, crit: 10,  dodge: 10,  critDamage: 50,  accuracy: 10,  lifesteal: 5,   manasteal: 4,   si_khi: 30 },
        'Đại Hộ Tông':            { hp: 2200000,  atk: 550000,  def: 550000,  spd: 550000,  mana: 550000, honLuc: 550000, crit: 12,  dodge: 12,  critDamage: 60,  accuracy: 12,  lifesteal: 5,   manasteal: 5,   si_khi: 35 },
        'Tông Môn Thần Sứ':       { hp: 3000000,  atk: 750000,  def: 750000,  spd: 750000,  mana: 750000, honLuc: 750000, crit: 14,  dodge: 14,  critDamage: 70,  accuracy: 14,  lifesteal: 6,   manasteal: 5,   si_khi: 40 },
        'Tông Môn Hộ Đạo Giả':    { hp: 3800000,  atk: 950000,  def: 950000,  spd: 950000,  mana: 950000, honLuc: 950000, crit: 16,  dodge: 16,  critDamage: 80,  accuracy: 16,  lifesteal: 7,   manasteal: 6,   si_khi: 50 },
        'Phó Tông Chủ':           { hp: 4400000,  atk: 1100000, def: 1100000, spd: 1100000, mana: 1100000, honLuc: 1100000, crit: 18,  dodge: 18,  critDamage: 90,  accuracy: 18,  lifesteal: 8,   manasteal: 7,   si_khi: 75 },
        'Vô Thượng Trưởng Lão':   { hp: 5000000,  atk: 1250000, def: 1250000, spd: 1250000, mana: 1250000, honLuc: 1250000, crit: 20,  dodge: 20,  critDamage: 100, accuracy: 20,  lifesteal: 10,  manasteal: 8,   si_khi: 100 }
    };

    // [NEW] Bảng Quy Hoạch Bonus XP Theo Phẩm Chất (Tốc độ tu luyện)
    const POTENTIAL_XP_BONUS = {
        'Yếu Kém': 10,               // +10% XP (Tốc độ x1.1)
        'Bình Thường': 25,           // +25% XP
        'Khá': 50,                   // +50% XP
        'Tốt': 100,                  // +100% XP (Tốc độ x2)
        'Thiên Tài': 200,            // +200% XP (Tốc độ x3)
        'Tuyệt Thế': 400,            // +400% XP (Tốc độ x5)
        'Thiên Kiêu Chi Tử': 800,    // +800% XP (Tốc độ x9)
        'Nghịch Thiên Cải Mệnh': 1500, // +1500% XP (Tốc độ x16)
        'Vô Cực Đạo Thể': 3000,      // +3000% XP (Tốc độ x31)
        'Vạn Đạo Chi Tổ': 5000,      // +5000% XP (Tốc độ x51)
        'Chân Ngã Duy Nhất': 7500,   // +7500% XP (Tốc độ x76)
        'Nhất Niệm Vĩnh Hằng': 10000 // +10000% XP (Tốc độ x101)
    };

    // [NEW] DATABASE KHÍ VẬN (DESTINY)
    const DESTINY_DB = {
        'THIEN_TIEN': { 
            name: 'Thiên Tiên Chuyển Thế', 
            shortName: 'Thiên Tiên',
            color: 'text-fuchsia-300', 
            border: 'border-fuchsia-500',
            bg: 'bg-fuchsia-900/40',
            icon: 'fa-solid fa-star-of-david',
            desc: 'Kiếp trước là tiên nhân trên cửu trùng thiên, nay giáng trần lịch kiếp.', 
            bonus: 'May Mắn +20%, Tốc độ Tu Luyện +20%' 
        },
        // [NEW - PART 2] 5 Khí Vận Mới
        'KIEM_THAN': { 
            name: 'Kiếm Thần Tái Thế', 
            shortName: 'Kiếm Thần',
            color: 'text-cyan-200', 
            border: 'border-cyan-400',
            bg: 'bg-cyan-900/40',
            icon: 'fa-solid fa-khanda',
            desc: 'Sinh ra đã có kiếm ý vây quanh, vạn kiếm quy tông, sát phạt đệ nhất.', 
            bonus: 'Công Kích +25%, Chí Mạng +10%' 
        },
        'NGU_HANH': { 
            name: 'Ngũ Hành Chi Thể', 
            shortName: 'Ngũ Hành',
            color: 'text-rainbow-animation', 
            border: 'border-white',
            bg: 'bg-gray-800',
            icon: 'fa-solid fa-circle-nodes',
            desc: 'Thân thể dung hợp Kim Mộc Thủy Hỏa Thổ, tương sinh tương khắc, hoàn hảo vô khuyết.', 
            bonus: 'Toàn bộ chỉ số +10%' 
        },
        'THIEN_MENH': { 
            name: 'Thiên Mệnh Chi Tử', 
            shortName: 'Thiên Mệnh',
            color: 'text-yellow-300 font-bold', 
            border: 'border-yellow-500',
            bg: 'bg-yellow-900/40',
            icon: 'fa-solid fa-crown',
            desc: 'Con cưng của trời đất, đi đường nhặt được bảo vật, gặp nạn hóa lành.', 
            bonus: 'May Mắn +50%' 
        },
        'HU_KHONG': { 
            name: 'Hư Không Chi Thể', 
            shortName: 'Hư Không',
            color: 'text-violet-300', 
            border: 'border-violet-500',
            bg: 'bg-violet-900/40',
            icon: 'fa-solid fa-ghost',
            desc: 'Thân thể hòa vào hư không, đến vô ảnh đi vô tung.', 
            bonus: 'Thân Pháp +30%' 
        },
        'DUOC_LINH': { 
            name: 'Dược Linh Thánh Thể', 
            shortName: 'Dược Linh',
            color: 'text-green-400', 
            border: 'border-green-500',
            bg: 'bg-green-900/40',
            icon: 'fa-solid fa-seedling',
            desc: 'Máu thịt như linh dược, bách độc bất xâm, sinh mệnh dồi dào.', 
            bonus: 'Sinh Lực +25%, Phòng Thủ +5%' 
        },
        // [END NEW]
        'MA_THAN': { 
            name: 'Ma Thần Huyết Mạch', 
            shortName: 'Ma Thần',
            color: 'text-red-500', 
            border: 'border-red-600',
            bg: 'bg-red-900/40',
            icon: 'fa-solid fa-skull',
            desc: 'Dòng máu ma thần chảy trong huyết quản, khát máu và hiếu chiến.', 
            bonus: 'Công Kích +20%, Sinh Lực +10%' 
        },
        'THANH_NHAN': { 
            name: 'Thánh Nhân Chuyển Thế', 
            shortName: 'Thánh Nhân',
            color: 'text-emerald-400', 
            border: 'border-emerald-500',
            bg: 'bg-emerald-900/40',
            icon: 'fa-solid fa-leaf',
            desc: 'Tích đức từ kiếp trước, được thiên địa bảo hộ, vạn tà bất xâm.', 
            bonus: 'Phòng Thủ +20%, Nội Lực +10%' 
        },
        'HUYET_SAT': { 
            name: 'Huyết Sát Chi Khí', 
            shortName: 'Huyết Sát',
            color: 'text-rose-500', 
            border: 'border-rose-600',
            bg: 'bg-rose-900/40',
            icon: 'fa-solid fa-droplet',
            desc: 'Sinh ra trong biển máu, sát khí ngút trời, lấy chiến tranh nuôi chiến tranh.', 
            bonus: 'Công Kích +15%, Sinh Lực +5%' 
        },
        'BAT_DIET': { 
            name: 'Bất Diệt Kim Thân', 
            shortName: 'Bất Diệt',
            color: 'text-amber-200', 
            border: 'border-amber-400',
            bg: 'bg-amber-900/40',
            icon: 'fa-solid fa-shield-virus',
            desc: 'Thân thể kim cương bất hoại, đao thương bất nhập, thủy hỏa bất xâm.', 
            bonus: 'Phòng Thủ +20%, Sinh Lực +10%' 
        },
        'TRONG_DONG': { 
            name: 'Trọng Đồng Giả', 
            shortName: 'Trọng Đồng',
            color: 'text-violet-400', 
            border: 'border-violet-500',
            bg: 'bg-violet-900/40',
            icon: 'fa-solid fa-eye',
            desc: 'Đôi mắt hai đồng tử, nhìn thấu hư vọng, thiên sinh thánh nhân.', 
            bonus: 'May Mắn +30%, Công Kích +5%' 
        },
        'CUU_DUONG': { 
            name: 'Cửu Dương Chi Thể', 
            shortName: 'Cửu Dương',
            color: 'text-orange-400', 
            border: 'border-orange-500',
            bg: 'bg-orange-900/40',
            icon: 'fa-solid fa-sun',
            desc: 'Thân thể chí dương chí cương, trăm bệnh không sinh, nội lực cuồn cuộn.', 
            bonus: 'Công Kích +10%, Phòng Thủ +10%' 
        },
        'THAI_AM': { 
            name: 'Thái Âm Chi Thể', 
            shortName: 'Thái Âm',
            color: 'text-indigo-300', 
            border: 'border-indigo-500',
            bg: 'bg-indigo-900/40',
            icon: 'fa-solid fa-moon',
            desc: 'Thân thể chí âm chí nhu, hấp thụ nguyệt hoa, thân pháp quỷ mị.', 
            bonus: 'Thân Pháp +15%, Nội Lực +10%' 
        },
        'NGHICH_THIEN': { 
            name: 'Nghịch Thiên Cải Mệnh', 
            shortName: 'Nghịch Thiên',
            color: 'text-orange-400', 
            border: 'border-orange-500',
            bg: 'bg-orange-900/40',
            icon: 'fa-solid fa-bolt',
            desc: 'Số phận trêu ngươi, nhưng tâm không cam lòng, quyết nghịch thiên mà đi.', 
            bonus: 'Công Kích +15%, Chí Mạng +5%' 
        },
        'TIEN_THIEN': { 
            name: 'Tiên Thiên Đạo Thể', 
            shortName: 'Tiên Thiên',
            color: 'text-cyan-300', 
            border: 'border-cyan-500',
            bg: 'bg-cyan-900/40',
            icon: 'fa-solid fa-spa',
            desc: 'Vừa sinh ra đã thân cận với đại đạo, vạn pháp bất xâm.', 
            bonus: 'Tốc độ Tu Luyện +15%, Kháng Hiệu Ứng +10%' 
        },
        'LINH_DIEU': { 
            name: 'Linh Diệu Chi Thể', 
            shortName: 'Linh Diệu',
            color: 'text-teal-300', 
            border: 'border-teal-500',
            bg: 'bg-teal-900/40',
            icon: 'fa-solid fa-wind',
            desc: 'Thân thể nhẹ tựa lông hồng, di chuyển như gió, biến ảo khôn lường.', 
            bonus: 'Thân Pháp +20%, May Mắn +5%' 
        },
        'HOANG_GIA': { 
            name: 'Hoàng Gia Huyết Mạch', 
            shortName: 'Hoàng Tộc',
            color: 'text-yellow-300', 
            border: 'border-yellow-500',
            bg: 'bg-yellow-900/40',
            icon: 'fa-solid fa-crown',
            desc: 'Dòng dõi đế vương, có chân long khí bảo hộ.', 
            bonus: 'Phòng Thủ +10%, Uy Danh nhận được +10%' 
        },
        'PHAM_NHAN': { 
            name: 'Phàm Nhân', 
            shortName: 'Phàm Nhân',
            color: 'text-gray-400', 
            border: 'border-gray-600',
            bg: 'bg-gray-800',
            icon: 'fa-solid fa-user',
            desc: 'Một người bình thường trong chúng sinh.', 
            bonus: 'Không có hiệu quả đặc biệt' 
        }
    };

    // [MODIFIED] Hàm tính toán chỉ số đệ tử (Bao gồm các Khí Vận mới)
    function calculateDiscipleStats(disciple) {
        // 1. Lấy chỉ số gốc
        let finalStats = { 
            hp: disciple.stats.hp, 
            atk: disciple.stats.atk, 
            def: disciple.stats.def || 0, 
            spd: disciple.stats.spd || 0,
            lck: disciple.stats.lck || 0,
            mana: disciple.stats.mana || 0,
            honLuc: disciple.stats.honLuc || 0, 
            crit: disciple.stats.crit || 0, 
            dodge: disciple.stats.dodge || 0,
            critDamage: 150 + (disciple.stats.critDamage || 0),
            accuracy: disciple.stats.accuracy || 0,
            lifesteal: disciple.stats.lifesteal || 0, 
            manasteal: disciple.stats.manasteal || 0,
            si_khi: disciple.stats.si_khi || 0 // [NEW] Chỉ số Sĩ Khí
        };

        // 2. Lấy danh sách thiên phú
        const talents = getDiscipleTalents(disciple.id, disciple.potential);
        talents.forEach(talent => {
            if (talent.stats) {
                if (talent.stats.hp) finalStats.hp += talent.stats.hp;
                if (talent.stats.atk) finalStats.atk += talent.stats.atk;
                if (talent.stats.def) finalStats.def += talent.stats.def;
                if (talent.stats.spd) finalStats.spd += talent.stats.spd;
                if (talent.stats.lck) finalStats.lck += talent.stats.lck;
                if (talent.stats.mana) finalStats.mana += talent.stats.mana;
                if (talent.stats.honLuc) finalStats.honLuc += talent.stats.honLuc;
                if (talent.stats.crit) finalStats.crit += talent.stats.crit;
                if (talent.stats.dodge) finalStats.dodge += talent.stats.dodge;
                if (talent.stats.critDamage) finalStats.critDamage += talent.stats.critDamage;
                if (talent.stats.accuracy) finalStats.accuracy += talent.stats.accuracy;
                if (talent.stats.lifesteal) finalStats.lifesteal += talent.stats.lifesteal;
                if (talent.stats.manasteal) finalStats.manasteal += talent.stats.manasteal;
                if (talent.stats.si_khi) finalStats.si_khi += talent.stats.si_khi; // [NEW]
            }
        });

        // 3. Cộng chỉ số từ Cấp Bậc
        const rankInfo = getDiscipleRank(disciple.level);
        const rankBonus = RANK_BONUS_STATS[rankInfo.name];
        
        if (rankBonus) {
            finalStats.hp += rankBonus.hp;
            finalStats.atk += rankBonus.atk;
            finalStats.def += rankBonus.def;
            finalStats.spd += rankBonus.spd;
            if (rankBonus.mana) finalStats.mana += rankBonus.mana; 
            if (rankBonus.honLuc) finalStats.honLuc += rankBonus.honLuc; 
            if (rankBonus.crit) finalStats.crit += rankBonus.crit; 
            if (rankBonus.dodge) finalStats.dodge += rankBonus.dodge;
            if (rankBonus.critDamage) finalStats.critDamage += rankBonus.critDamage;
            if (rankBonus.accuracy) finalStats.accuracy += rankBonus.accuracy;
            if (rankBonus.lifesteal) finalStats.lifesteal += rankBonus.lifesteal;
            if (rankBonus.manasteal) finalStats.manasteal += rankBonus.manasteal;
            if (rankBonus.si_khi) finalStats.si_khi += rankBonus.si_khi; // [NEW]
        }

        // 4. [MODIFIED] Áp dụng Khí Vận (% Bonus) - Cập nhật Logic mới
        const destiny = disciple.destiny;
        
        // Helper function để cộng %
        const addPercent = (stat, percent) => {
            finalStats[stat] = Math.floor(finalStats[stat] * (1 + percent / 100));
        };
        // Helper function để cộng điểm cố định (cho Crit/Dodge/CritDamage/Accuracy/Lifesteal/Manasteal/SiKhi %)
        const addFlat = (stat, value) => {
            finalStats[stat] = (finalStats[stat] || 0) + value;
        };

        if (destiny === 'KIEM_THAN') {
            addPercent('atk', 25);
            addFlat('crit', 10);
            addFlat('critDamage', 20);
            addFlat('accuracy', 5);
        } else if (destiny === 'NGU_HANH') {
            ['hp', 'atk', 'def', 'spd', 'lck', 'mana', 'honLuc'].forEach(s => addPercent(s, 10)); 
            addFlat('crit', 2); 
            addFlat('dodge', 2);
            addFlat('critDamage', 5);
            addFlat('accuracy', 2);
            addFlat('lifesteal', 2);
            addFlat('manasteal', 2);
            addFlat('si_khi', 5); // [NEW] Ngũ Hành tăng 5 Sĩ Khí
        } else if (destiny === 'THIEN_MENH') {
            addPercent('lck', 50); 
            addFlat('crit', 5);    
        } else if (destiny === 'HU_KHONG') {
            addPercent('spd', 30);
            addFlat('dodge', 10); 
        } else if (destiny === 'LINH_DIEU') {
             addPercent('spd', 20);
             addPercent('lck', 5);
             addFlat('dodge', 5); 
        } else if (destiny === 'NGHICH_THIEN') {
            addPercent('atk', 15);
            addFlat('crit', 5);
            addFlat('critDamage', 15);
        } else if (destiny === 'THANH_NHAN') {
            addPercent('def', 20);
            addPercent('mana', 10);
            addPercent('honLuc', 10); 
            addFlat('dodge', 3); 
        } else if (destiny === 'TRONG_DONG') {
             addPercent('lck', 30);
             addPercent('atk', 5);
             addFlat('crit', 3);
             addFlat('dodge', 3);
             addFlat('critDamage', 10);
             addFlat('accuracy', 10);
        } else if (destiny === 'THAI_AM') {
             addPercent('spd', 15);
             addPercent('mana', 10);
             addPercent('honLuc', 10); 
             addFlat('dodge', 4);
             addFlat('manasteal', 10);
        } else if (destiny === 'MA_THAN') {
             addPercent('atk', 20);
             addPercent('hp', 10);
             addFlat('crit', 2);
             addFlat('critDamage', 10);
        } else if (destiny === 'HUYET_SAT') {
             addPercent('atk', 15);
             addPercent('hp', 5);
             addFlat('crit', 2);
             addFlat('lifesteal', 10);
        } else if (destiny === 'HOANG_GIA') {
             addPercent('def', 10);
             addFlat('si_khi', 20); // [NEW] Hoàng Tộc tăng 20 Sĩ Khí
        }

        return finalStats;
    }
    </script>
    
    <style>
        body {
            /* [MODIFIED] Changed font to "Noto Serif" for a classic feel */
            font-family: 'Noto Serif', serif;
            /* [MODIFIED] Replaced simple gradient with an abstract 8-segment Bagua-style pattern */
            background-color: #0a0a0a; /* Fallback */
            background-image: 
                /* Lớp trên: Ánh sáng mờ ở tâm (giống như cũ) */
                radial-gradient(ellipse at center, rgba(64,64,64,0.5) 0%, rgba(10,10,10,1) 70%),
                /* Lớp dưới: 8 "cánh quạt" (ám chỉ Bát Quái) */
                repeating-conic-gradient(
                    from 0.125turn, /* Xoay 1/8 vòng */
                    #1a1a1a 0%,     /* Màu xám than */
                    #1a1a1a 12.5%,  /* 1/8 của 360 độ */
                    #111111 12.5%,  /* Màu đen tuyền */
                    #111111 25%     /* 1/8 tiếp theo */
                );
            background-size: cover, 600px 600px; /* 'cover' cho lớp trên, 600px cho lớp dưới */
            background-position: center, center;
            background-attachment: fixed; /* Keep gradient fixed on scroll */
            
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
        /* ... existing code for scrollbars, etc ... */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
        .modal {
            max-height: 85vh;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #1a202c;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 20px;
        }
        .star-1 { color: #FFFFFF; }
        .star-2 { color: #6ee7b7; }
        .star-3 { color: #60a5fa; }
        .star-4 { color: #c084fc; }
        .star-5 { color: #f87171; }
        /* [NEW] Star color for higher rarities */
        .star-6 { color: #fb923c; } /* orange-400 */
        .star-7 { color: #f472b6; } /* pink-400 */
        .star-8 { color: #a78bfa; } /* violet-400 */
        .star-9 { color: #e879f9; } /* fuchsia-400 */
        .star-10 { color: #3f3f46; } /* zinc-700 (dark gray for black) */
        
        /* [NEW] Disciple XP Bar Styles */
        .disciple-xp-bar-container {
            width: 100%;
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            height: 0.625rem; /* h-2.5 */
            border: 1px solid #1f2937; /* gray-800 */
            overflow: hidden;
            position: relative;
            margin-top: 4px; /* mt-1 */
        }
        .disciple-xp-bar-fill {
            background-color: #10b981; /* emerald-500 */
            height: 100%;
            transition: width 0.3s ease-in-out;
            border-radius: 9999px;
        }
        .disciple-xp-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.6rem; /* Smaller text */
            font-weight: bold;
            color: #ffffff;
            text-shadow: 1px 1px 1px #000;
        }

        /* Skill tree styles */
        .skill-node { border-left: 2px dashed #4a5568; position: relative; }
        .skill-node:before { content: ''; position: absolute; left: -8px; top: 16px; width: 14px; height: 14px; border-radius: 50%; background-color: #4a5568; border: 2px solid #6366f1; }
        .skill-node.unlocked:before { background-color: #facc15; border-color: #fff; }
        .skill-node.locked { opacity: 0.5; }
        .skill-node:first-child { border-left: none; }
        .skill-node:first-child:before { left: -2px; }

        /* Combat Display Panel Styles */
        #combat-display-panel { 
            /* [MODIFIED] Đổi màu nền sang hiệu ứng gradient tối */
            background-color: #1a1a1a; /* Fallback */
            /* [MODIFIED] Đổi ảnh nền và thêm lớp phủ tối */
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://kenh14cdn.com/203336854389633024/2020/12/15/vo-lam-truyen-ky-mobile-171106-02-1608021166975245474435.png');
            background-size: cover; /* [NEW] Đảm bảo ảnh lấp đầy khung */
            background-position: center; /* [NEW] Căn giữa ảnh */
            border: 1px solid #6b46c1; /* [MODIFIED] Đổi viền sang màu Tím (võ lâm/huyền ảo) */ 
            border-radius: 0.5rem; 
            padding: 0.5rem; 
            margin-bottom: 1rem; 
            height: 240px; /* [MODIFIED] Tăng chiều cao từ 180px lên 240px */ 
            display: flex; 
            flex-direction: column; 
            justify-content: space-around; 
        }
        .combatant { display: flex; flex-direction: column; align-items: center; width: 40%; text-align: center; }
        .combatant i { font-size: 2.5rem; margin-bottom: 0.25rem; }
        .combat-vs { font-size: 1.5rem; font-weight: bold; color: #f87171; align-self: center; }
        #combat-enemy-stats { display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: #cbd5e0; margin-top: 0.25rem; flex-wrap: wrap; }
        #combat-enemy-stats span { display: flex; align-items: center; margin: 0 0.3rem; }
        #combat-enemy-stats span i { font-size: 1rem; margin-right: 0.2rem; margin-bottom: 0; }

         /* Training log - UPDATED (Taller & Cleaner) */
         #training-log {
             font-family: 'Courier New', Courier, monospace;
             font-size: 0.85rem; /* Chữ to hơn xíu cho dễ đọc */
             line-height: 1.5; 
             /* Nền tối trong suốt */
             background-color: rgba(0, 0, 0, 0.25);
             box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
             /* Xóa viền cũ, dùng viền của container cha */
             border: none;
             border-radius: 0 0 0.5rem 0.5rem; /* Bo góc dưới */
             padding: 10px;
             height: 300px; /* [MODIFIED] Tăng chiều cao từ 180px -> 300px */
             overflow-y: auto;
             color: #e2e8f0; 
         }
         #training-log p {
             margin-bottom: 4px; 
             border-bottom: 1px dashed rgba(255, 255, 255, 0.05); /* Đường kẻ mờ hơn */
             padding-bottom: 2px;
             word-wrap: break-word; 
         }
         /* Color coding classes */
         #training-log .log-player { color: #4ade80; } /* green-400 */
         #training-log .log-enemy { color: #f87171; } /* red-400 */
         #training-log .log-system { color: #facc15; } /* yellow-400 */
         #training-log .log-reward { color: #67e8f9; } /* cyan-300 */
         #training-log .log-error { color: #fda4af; } /* rose-300 */
         #training-log .log-info { color: #9ca3af; } /* gray-400 */

         /* Health Bar Styles */
        .health-bar-container { width: 100%; height: 14px; background-color: #4b5563; border-radius: 10px; overflow: hidden; border: 1px solid #1a202c; margin-top: 0.25rem; position: relative; }
        .health-bar { height: 100%; border-radius: 8px; transition: width 0.3s ease-in-out; position: relative; }
        .health-bar-player { background-color: #dc2626; }
        .health-bar-enemy { background-color: #dc2626; }
        .hp-flash { animation: hp-flash-animation 0.3s 1; }
        @keyframes hp-flash-animation { 0% { filter: brightness(1); } 50% { filter: brightness(2.5) contrast(2); } 100% { filter: brightness(1); } }

         /* Tooltip Style */
        #item-tooltip { position: absolute; display: none; background-color: rgba(31, 41, 55, 0.95); color: white; border: 1px solid #4b5563; border-radius: 0.375rem; padding: 0.75rem; font-size: 0.875rem; z-index: 100; max-width: 250px; pointer-events: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        
        /* Grid Inventory Style */
        #equipment-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 0.75rem; }
        .inventory-item { background-color: #374151; border-radius: 0.5rem; padding: 0.75rem; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid transparent; transition: border-color 0.2s; }
        .inventory-item.item-potion { background-color: #4b5563; }
        .inventory-item.item-equipped { border-color: #60a5fa; box-shadow: 0 0 10px rgba(96, 165, 250, 0.5); }
        .inventory-item-info { margin-bottom: 0.5rem; }
        .inventory-item-actions { display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; }

        /* =========================================
           HỆ THỐNG HIỆU ỨNG PHẨM CHẤT TRANG BỊ (VFX)
           ========================================= */

        /* 1. ANIMATIONS */
        
        /* Quý (Rare) - Tím: Thở nhẹ */
        @keyframes rare-breathe {
            0%, 100% { text-shadow: 0 0 2px #c084fc; opacity: 0.9; }
            50% { text-shadow: 0 0 8px #a855f7; opacity: 1; }
        }

        /* Sử Thi (Legendary) - Vàng: Lấp lánh kim loại */
        @keyframes legendary-shimmer {
            0%, 100% { color: #facc15; text-shadow: 0 0 2px #ca8a04; }
            50% { color: #fef08a; text-shadow: 0 0 10px #facc15; }
        }

        /* Thần Thoại (Epic) - Cam: Rực lửa */
        @keyframes epic-burn {
            0%, 100% { text-shadow: 0 0 2px #f97316; }
            25% { text-shadow: 0 0 8px #fb923c, 0 0 12px #c2410c; }
            50% { text-shadow: 0 0 4px #f97316; }
            75% { text-shadow: 0 0 8px #fb923c, 0 0 12px #c2410c; }
        }

        /* Chí Tôn (Mythic) - Đỏ: Mạch đập sát khí */
        @keyframes mythic-pulse {
            0% { text-shadow: 0 0 2px #ef4444; transform: scale(1); }
            50% { text-shadow: 0 0 15px #dc2626, 0 0 5px #f87171; transform: scale(1.02); }
            100% { text-shadow: 0 0 2px #ef4444; transform: scale(1); }
        }

        /* An Bang (Set) - Xanh Lá: Tỏa khí */
        @keyframes anbang-glow {
            0%, 100% { text-shadow: 0 0 3px #a3e635; }
            50% { text-shadow: 0 0 10px #84cc16, 0 0 15px #3f6212; }
        }

        /* 2. TEXT CLASSES (Màu chữ + Animation) */
        
        .quality-common { 
            color: #e5e7eb; /* Trắng xám nhẹ */
        } 
        
        .quality-uncommon { 
            color: #60a5fa; /* Xanh lam */
            text-shadow: 0 0 3px rgba(59, 130, 246, 0.5); /* Glow tĩnh nhẹ */
        } 
        
        .quality-rare { 
            color: #c084fc; /* Tím */
            animation: rare-breathe 3s infinite ease-in-out;
        } 
        
        .quality-legendary { 
            color: #facc15; /* Vàng */
            animation: legendary-shimmer 2s infinite linear;
        } 
        
        .quality-epic { 
            color: #f97316; /* Cam */
            animation: epic-burn 2s infinite;
        }
        
        .quality-mythic { 
            color: #ef4444; /* Đỏ */
            animation: mythic-pulse 1.5s infinite ease-in-out;
            display: inline-block; /* Cần thiết để transform scale hoạt động */
        }
        
        .quality-anbang { 
            color: #a3e635; /* Xanh nõn chuối */
            animation: anbang-glow 3s infinite ease-in-out;
        }

        /* 3. BACKGROUND CLASSES (Khung viền Inventory) */

        .bg-quality-common { 
            background-color: rgba(55, 65, 81, 0.5); 
            border-color: #4b5563; 
        }
        
        .bg-quality-uncommon { 
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3), rgba(96, 165, 250, 0.1)); 
            border-color: #3b82f6; 
            box-shadow: inset 0 0 5px rgba(59, 130, 246, 0.2);
        }
        
        .bg-quality-rare { 
            background: linear-gradient(135deg, rgba(88, 28, 135, 0.3), rgba(192, 132, 252, 0.1)); 
            border-color: #a855f7; 
            box-shadow: inset 0 0 8px rgba(168, 85, 247, 0.2);
        }
        
        .bg-quality-legendary { 
            background: linear-gradient(135deg, rgba(113, 63, 18, 0.3), rgba(250, 204, 21, 0.1)); 
            border-color: #eab308; 
            box-shadow: inset 0 0 10px rgba(234, 179, 8, 0.2);
        }
        
        .bg-quality-epic { 
            background: linear-gradient(135deg, rgba(124, 45, 18, 0.4), rgba(249, 115, 22, 0.1)); 
            border-color: #f97316; 
            box-shadow: inset 0 0 12px rgba(249, 115, 22, 0.3);
        }
        
        .bg-quality-mythic { 
            background: linear-gradient(135deg, rgba(127, 29, 29, 0.5), rgba(239, 68, 68, 0.1)); 
            border-color: #ef4444; 
            box-shadow: inset 0 0 15px rgba(220, 38, 38, 0.4);
            border-width: 2px; /* Viền dày hơn chút */
        }
        
        .bg-quality-anbang { 
            background: linear-gradient(135deg, rgba(54, 83, 20, 0.4), rgba(163, 230, 53, 0.1)); 
            border-color: #84cc16; 
            box-shadow: inset 0 0 12px rgba(132, 204, 22, 0.3);
        }
        /* 4. SIÊU THẦN */
        @keyframes supergodly-glow {
            0% { 
                text-shadow: 0 0 2px #facc15, 0 0 4px #ea580c; 
                filter: brightness(1);
            }
            50% { 
                text-shadow: 0 0 10px #fef08a, 0 0 20px #facc15, 0 0 30px #ea580c; 
                filter: brightness(1.3);
            }
            100% { 
                text-shadow: 0 0 2px #facc15, 0 0 4px #ea580c; 
                filter: brightness(1);
            }
        }
        
        .quality-supergodly { 
            /* Gradient Vàng Kim -> Trắng -> Vàng Cam */
            background: linear-gradient(to bottom, #fff7ed 0%, #facc15 40%, #ca8a04 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            letter-spacing: 0.5px;
            
            /* Animation phát sáng */
            animation: supergodly-glow 2s infinite;
        }
        
        /* [NEW] Định nghĩa biến xoay cho viền 7 màu */
        @property --gradient-angle {
            syntax: "<angle>";
            initial-value: 0deg;
            inherits: false;
        }

        @keyframes rotation {
            0% { --gradient-angle: 0deg; }
            100% { --gradient-angle: 360deg; }
        }

        /* [NEW] Background style for Siêu Thần items (Inventory Card) */
        @keyframes card-shine {
            0% { left: -100%; opacity: 0; }
            20% { left: 100%; opacity: 0.6; } /* Quét nhanh */
            100% { left: 100%; opacity: 0; } /* Nghỉ lâu */
        }
        
        /* [MODIFIED] Cập nhật nền Siêu Thần: Đen, Trong suốt, Bỏ viền 7 màu */
        .bg-quality-supergodly {
            position: relative;
            
            /* Viền vàng kim tĩnh, mỏng để vẫn nhận biết được là đồ xịn */
            border: 1px solid #facc15 !important; 
            border-radius: 0.5rem;
            
            /* Nền đen trong suốt theo yêu cầu */
            background-color: rgba(0, 0, 0, 0.6) !important;
            background-image: none !important; /* Xóa bỏ các lớp gradient cũ */
            
            overflow: hidden;
            
            /* Bóng đổ vàng nhẹ nhàng hơn */
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.2) !important;
            
            z-index: 1;
        }
        
        /* [MODIFIED] Hiệu ứng Lưu Quang (Luồng sáng quét qua) - Đổi sang màu trắng */
        .bg-quality-supergodly::after {
            content: "";
            position: absolute;
            top: 0; left: -100%;
            width: 200%; height: 100%;
            /* Luồng sáng rõ hơn - Đổi màu vàng (rgba(253, 224, 71, 0.5)) thành trắng (rgba(255, 255, 255, 0.6)) */
            background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.1) 30%, rgba(255, 255, 255, 0.6) 50%, rgba(255, 255, 255, 0.1) 70%, transparent 100%);
            transform: skewX(-25deg);
            animation: card-shine 4s infinite;
            pointer-events: none;
            z-index: 1;
        }

        /* NEW: Tab Styles */
        .tab-btn { background-color: #1f2937; /* gray-800 */ }
        .tab-btn.tab-active { background-color: #374151; /* gray-700 */ color: #facc15; /* yellow-400 */ border-bottom: 2px solid #facc15; }
        .tab-btn:not(.tab-active):hover { background-color: #4b5563; /* gray-600 */ }

        /* NEW: Idle Activity Styles */
        /* [MODIFIED] Tách rule cho Câu Cá và các log khác */
        #idle-log, #idle-log-mining, #idle-log-herbalism {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            /* [MODIFIED] Xóa background-size và background-position */
            /* [MODIFIED] Thêm hiệu ứng kính mờ */
            background-color: rgba(0, 0, 0, 0.15); /* [MODIFIED] Giảm từ 0.3 -> 0.15 */
            /* [REMOVED] Xóa backdrop-filter: blur(4px); */
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            padding: 8px;
            height: 180px; /* [MODIFIED] Tăng chiều cao từ 120px lên 180px */
            overflow-y: scroll;
            color: #e2e8f0;
        }

        /* [NEW] Nền riêng cho Câu Cá */
        #idle-log {
             /* [REMOVED] Xóa background-image và background-position */
        }
        
        /* [NEW] Nền riêng cho Đào Khoáng */
        #idle-log-mining {
             /* [REMOVED] Xóa background-image và background-position */
        }

        /* [MODIFIED] Nền cho Hái Thuốc (ảnh .gif cũ) -> Đã cập nhật */
        #idle-log-herbalism {
             /* [REMOVED] Xóa background-image và background-position */
        }

        #idle-log p { margin-bottom: 2px; }
        #idle-log .log-system { color: #facc15; }
        #idle-log .log-reward { color: #67e8f9; }
        #idle-log .log-error { color: #fda4af; }
        #idle-log .log-info { color: #9ca3af; }

        .xp-bar-container {
            width: 100%;
            background-color: #1f2937;
            border-radius: 9999px;
            height: 1.25rem;
            border: 1px solid #4b5563;
            overflow: hidden;
            position: relative;
        }
        .xp-bar-fill {
            background-color: #f59e0b; /* Default */
            height: 100%;
            transition: width 0.3s ease-in-out;
            border-radius: 9999px;
        }
        .xp-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 1px 1px 1px #000;
        }

        /* [NEW] CSS cho các panel Kỹ Năng Sống */
        #fishing-panel {
            /* [MODIFIED] Thay ảnh nền Câu Cá (Hồ nước tiên cảnh) -> Ảnh Imgur mới */
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://i.imgur.com/W8zRQap.jpeg');
            background-size: cover; background-position: center; border: 1px solid #4a5568;
        }
        #mining-panel {
            /* [MODIFIED] Thay ảnh nền Khai Khoáng (Hang động tinh thể) -> Ảnh Imgur mới */
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://i.imgur.com/wenjQ9j.jpeg');
            background-size: cover; background-position: 50% 30%; border: 1px solid #4a5568;
        }
        #herbalism-panel {
            /* [MODIFIED] Thay ảnh nền Hái Thuốc (Rừng linh dược) -> Ảnh Imgur mới */
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://i.imgur.com/mqKUfXy.jpeg');
            background-size: cover; background-position: bottom; border: 1px solid #4a5568;
        }
        /* Hiệu ứng kính mờ cho các thành phần bên trong panel Kỹ Năng Sống */
        #fishing-panel > div:first-child, #mining-panel > div:first-child, #herbalism-panel > div:first-child,
        #fishing-panel .xp-bar-container, #mining-panel .xp-bar-container, #herbalism-panel .xp-bar-container {
            background-color: rgba(0, 0, 0, 0.15); /* [MODIFIED] Giảm từ 0.3 -> 0.15 */
            /* [REMOVED] Xóa backdrop-filter: blur(4px); */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.5rem; /* Tinh chỉnh padding */
        }
        /* Tinh chỉnh lại margin cho header */
        #fishing-panel > div:first-child, #mining-panel > div:first-child, #herbalism-panel > div:first-child {
            margin-bottom: 0.5rem; /* mb-2 */
            padding: 0.5rem; /* p-2 */
        }

        /* [NEW] Tu Vi (Cultivation) Bar Styles */
        .tuvi-bar-container {
            width: 100%;
            background-color: #1f2937;
            border-radius: 9999px;
            height: 1.5rem; /* h-6 */
            border: 1px solid #4b5563;
            overflow: hidden;
            position: relative;
        }
        .tuvi-bar-fill {
            background-color: #8b5cf6; /* violet-500 */
            height: 100%;
            transition: width 0.3s ease-in-out;
            border-radius: 9999px;
        }
        .tuvi-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem; /* text-sm */
            font-weight: bold;
            color: #ffffff;
            text-shadow: 1px 1px 1px #000;
        }

        /* [MODIFIED] Vong Quay (Lucky Wheel) Styles - 3x3 GRID UPDATE */
        .lucky-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            width: 320px;
            height: 320px;
            margin: 1rem auto;
            background-color: #111827; /* gray-900 */
            padding: 8px;
            border-radius: 16px;
            border: 4px solid #b45309; /* amber-700 */
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.8);
            position: relative;
        }

        .lucky-cell {
            background: linear-gradient(145deg, #374151, #1f2937);
            border: 2px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75rem;
            color: #9ca3af;
            position: relative;
            transition: all 0.1s;
            overflow: hidden;
            padding: 2px;
            font-weight: bold;
        }
        
        /* Hiệu ứng khi ô được chọn (Đèn sáng) */
        .lucky-cell.active {
            background: linear-gradient(145deg, #4f46e5, #3730a3); /* Indigo gradient */
            border-color: #fbbf24; /* amber-400 */
            color: #fff;
            box-shadow: 0 0 15px #fbbf24, inset 0 0 10px rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            z-index: 10;
            text-shadow: 0 0 5px #fff;
        }

        .lucky-cell i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        /* Ô chính giữa (Nút Quay) */
        .lucky-center-btn {
            grid-column: 2;
            grid-row: 2;
            background: radial-gradient(circle, #f59e0b, #b45309);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 4px solid #fef3c7;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.2s;
            z-index: 5;
        }
        
        .lucky-center-btn:active {
            transform: scale(0.95);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        .lucky-center-btn:disabled, .lucky-center-btn.disabled {
            filter: grayscale(100%);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* [NEW] World Map Styles */
        .map-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width */
            height: 450px;
            margin: auto;
            border: 4px solid #b45309; /* Thicker, darker border */
            border-radius: 0.5rem;
            /* [MODIFIED] Thay đổi nền thành ảnh của bạn */
            background-color: #1a202c; /* Fallback */
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://i.imgur.com/2hwtX56.jpeg');
            background-size: cover;
            background-position: center;
            /* [REMOVED] Xóa nền pattern cũ */
            box-shadow: inset 0 0 100px rgba(0,0,0,0.4);
            overflow: hidden; /* Ensure locations don't bleed out */
        }
        .map-location {
            position: absolute;
            background-color: rgba(17, 24, 39, 0.7); /* bg-gray-900/70 */
            border: 1px solid #facc15; /* yellow-400 */
            padding: 4px 8px;
            border-radius: 9999px; /* pill shape */
            color: white;
            font-weight: 600; /* semibold */
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            white-space: nowrap; /* Prevent line breaks */
        }
        .map-location:hover {
            transform: scale(1.1);
            background-color: rgba(17, 24, 39, 0.9); /* bg-gray-900/90 */
            z-index: 10;
            border-color: #fff;
        }

        /* [NEW] Menh Cach Slot Styles */
        .menh-cach-slot {
            width: 100%;
            padding-top: 100%; /* Creates a 1:1 aspect ratio square */
            position: relative;
            background-color: #1a202c; /* gray-900 */
            border: 2px dashed #4a5568; /* gray-600 */
            border-radius: 0.5rem; /* rounded-lg */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .menh-cach-slot i {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem; /* text-2xl */
        }

        /* [FIX UI] Custom Select Styles - Sửa lỗi trùng màu nền/chữ */
        select {
            appearance: none; /* Xóa style mặc định của trình duyệt */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem top 50%;
            background-size: 0.65rem auto;
            padding-right: 2rem !important; /* Chừa chỗ cho mũi tên */
            background-color: #1f2937 !important; /* bg-gray-800 */
            color: #ffffff !important;
            border: 1px solid #4b5563 !important; /* border-gray-600 */
        }
        
        select:focus {
            border-color: #60a5fa !important; /* blue-400 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        }

        /* Quan trọng: Ép style cho các option bên trong menu xổ xuống */
        select option {
            background-color: #1f2937 !important; /* Nền tối */
            color: #ffffff !important; /* Chữ trắng */
            padding: 10px;
        }
        
        /* Fix cho Firefox/IE */
        select option:checked, select option:hover {
            background-color: #374151 !important; /* bg-gray-700 khi hover/chọn */
            color: #facc15 !important; /* Chữ vàng */
        }

        /* [MODIFIED] Vo Hiep Button Style - "Linh Vũ" (Spirit Feather) Style */
        .btn-vo-hiep {
            position: relative;
            /* Nền gradient rất nhẹ, tạo cảm giác bồng bềnh */
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            
            /* Viền siêu mỏng, gần như vô hình */
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px; /* Bo tròn mạnh (Pill shape) tạo sự mềm mại */
            
            color: #f3f4f6; /* Trắng xám nhẹ */
            font-family: 'Noto Serif', serif; /* Font cũ */
            font-weight: 600;
            padding: 10px 12px;
            font-size: 0.9rem;
            
            /* [IMPORTANT] Bỏ in hoa toàn bộ */
            text-transform: none; 
            
            /* Bóng đổ mềm mại */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            
            transition: all 0.4s ease-in-out;
            overflow: hidden;
        }

        /* Hiệu ứng ánh sáng lướt nhẹ (Sheen) */
        .btn-vo-hiep::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        /* Hiệu ứng Hover: Sáng lên và tỏa hào quang */
        .btn-vo-hiep:hover {
            transform: translateY(-2px);
            color: #ffffff;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.4);
            /* Box-shadow (Hào quang) sẽ được định nghĩa riêng bên dưới */
        }
        
        .btn-vo-hiep:hover::after {
            left: 100%;
        }

        .btn-vo-hiep:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- Màu Hào Quang (Aura Colors) --- */
        /* Sử dụng box-shadow để tạo hào quang lan tỏa */

        /* Kỹ Năng - Tím Huyền Ảo */
        .skills:hover { 
            box-shadow: 0 0 15px rgba(192, 132, 252, 0.6), inset 0 0 10px rgba(192, 132, 252, 0.2); 
            border-color: #c084fc; 
            text-shadow: 0 0 5px #fff, 0 0 10px #a855f7; /* Added Glow */
        }
        
        /* Hành Trang - Xanh Biển Nhạt */
        .equip:hover { 
            box-shadow: 0 0 15px rgba(129, 140, 248, 0.6), inset 0 0 10px rgba(129, 140, 248, 0.2); 
            border-color: #818cf8; 
            text-shadow: 0 0 5px #fff, 0 0 10px #818cf8; /* Added Glow */
        }
        
        /* Thợ Rèn - Trắng Bạc */
        .smith:hover { 
            box-shadow: 0 0 15px rgba(209, 213, 219, 0.6), inset 0 0 10px rgba(209, 213, 219, 0.2); 
            border-color: #d1d5db; 
            text-shadow: 0 0 5px #fff, 0 0 10px #d1d5db; /* Added Glow */
        }
        
        /* Tông Môn - Xanh Lá Mạ */
        .sect:hover { 
            box-shadow: 0 0 15px rgba(163, 230, 53, 0.6), inset 0 0 10px rgba(163, 230, 53, 0.2); 
            border-color: #a3e635; 
            text-shadow: 0 0 5px #fff, 0 0 10px #a3e635; /* Added Glow */
        }
        
        /* Môn Phái - Xanh Ngọc */
        .class:hover { 
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.6), inset 0 0 10px rgba(34, 211, 238, 0.2); 
            border-color: #22d3ee; 
            text-shadow: 0 0 5px #fff, 0 0 10px #22d3ee; /* Added Glow */
        }
        
        /* Sủng Vật - Cam Đất */
        .pet:hover { 
            box-shadow: 0 0 15px rgba(251, 146, 60, 0.6), inset 0 0 10px rgba(251, 146, 60, 0.2); 
            border-color: #fb923c; 
            text-shadow: 0 0 5px #fff, 0 0 10px #fb923c; /* Added Glow */
        }
        
        /* Mệnh Cách - Xanh Teal */
        .destiny:hover { 
            box-shadow: 0 0 15px rgba(45, 212, 191, 0.6), inset 0 0 10px rgba(45, 212, 191, 0.2); 
            border-color: #2dd4bf; 
            text-shadow: 0 0 5px #fff, 0 0 10px #2dd4bf; /* Added Glow */
        }
        
        /* Luyện Công - Đỏ Nhạt */
        .train:hover { 
            box-shadow: 0 0 15px rgba(248, 113, 113, 0.6), inset 0 0 10px rgba(248, 113, 113, 0.2); 
            border-color: #f87171; 
            text-shadow: 0 0 5px #fff, 0 0 10px #f87171; /* Added Glow */
        }
        
        /* Bản Đồ - Xanh Dương */
        .map:hover { 
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.6), inset 0 0 10px rgba(56, 189, 248, 0.2); 
            border-color: #38bdf8; 
            text-shadow: 0 0 5px #fff, 0 0 10px #38bdf8; /* Added Glow */
        }
        
        /* Vòng Quay - Hồng Phấn */
        .wheel:hover { 
            box-shadow: 0 0 15px rgba(244, 114, 182, 0.6), inset 0 0 10px rgba(244, 114, 182, 0.2); 
            border-color: #f472b6; 
            text-shadow: 0 0 5px #fff, 0 0 10px #f472b6; /* Added Glow */
        }
        
        /* Tiền Trang - Vàng Kim */
        .shop:hover { 
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.6), inset 0 0 10px rgba(250, 204, 21, 0.2); 
            border-color: #facc15; 
            text-shadow: 0 0 5px #fff, 0 0 10px #facc15; /* Added Glow */
        }

        /* Special Buttons */
        .btn-vo-hiep-special:hover { 
            box-shadow: 0 0 20px rgba(216, 180, 254, 0.7); 
            border-color: #d8b4fe; 
            text-shadow: 0 0 5px #fff, 0 0 10px #d8b4fe; /* Added Glow */
        }
        .btn-vo-hiep-save:hover { 
            box-shadow: 0 0 15px rgba(94, 234, 212, 0.6); 
            border-color: #5eead4; 
            text-shadow: 0 0 5px #fff, 0 0 10px #5eead4; /* Added Glow */
        }
        .btn-vo-hiep-changelog:hover { 
            box-shadow: 0 0 15px rgba(156, 163, 175, 0.6); 
            border-color: #9ca3af; 
            text-shadow: 0 0 5px #fff, 0 0 10px #9ca3af; /* Added Glow */
        }
        /* [END NEW] */

        /* [REMOVED] Animation for the main title (pulse-yellow) */
        @keyframes pulse-yellow {
            0%, 100% {
                text-shadow: 0 0 5px #facc15, 0 0 10px #facc15;
                opacity: 1;
            }
            50% {
                text-shadow: 0 0 10px #fde047, 0 0 20px #fde047;
                opacity: 0.85;
            }
        }
        .title-huyet-chien {
            /* [MODIFIED] Áp dụng hiệu ứng 7 màu */
            background: linear-gradient(to right, #f87171, #facc15, #a3e635, #60a5fa, #c084fc, #f87171);
            background-size: 200% auto;
            
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            
            animation: text-gradient-animation 2s linear infinite; /* [MODIFIED] Tăng tốc (4s -> 2s) */
            
            /* [MODIFIED] Tăng cường độ bóng (0.2 -> 0.3) */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }

        /* [REMOVED] Đã xóa animation 'pulse-blue' và class '.title-tieu-dao-tu' vì không còn dùng */

        /* [NEW] Animation for rainbow text (7-color effect) */
        @keyframes text-gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .text-rainbow-animation {
            /* Dải màu cầu vồng (bắt đầu và kết thúc bằng màu đỏ để lặp mượt) */
            background: linear-gradient(to right, #f87171, #facc15, #a3e635, #60a5fa, #c084fc, #f87171);
            background-size: 200% auto; /* Kích thước nền > 100% để có thể di chuyển */
            
            /* Cắt nền theo hình dạng của chữ */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            
            /* Áp dụng animation */
            /* [MODIFIED] Giảm tốc độ từ 2s -> 6s để mượt mà hơn */
            animation: text-gradient-animation 6s linear infinite;
            
            /* [MODIFIED] Thêm drop-shadow thay vì text-shadow (vốn bị ẩn bởi text-fill-color) để tạo hiệu ứng nổi */
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
        }

        /* [NEW] Animation for pulsing/sparkling text */
        @keyframes pulse-opacity {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        .text-sparkle {
            animation: pulse-opacity 1.5s ease-in-out infinite;
        }

        /* [NEW] Animation for a glowing/pulsing text shadow (cho map Đỉnh Phong) */
        @keyframes pulse-glow {
            0%, 100% {
                /* (Yellow-300 shadow, subtle) */
                text-shadow: 0 0 5px rgba(250, 204, 21, 0.5), 0 0 10px rgba(250, 204, 21, 0.3);
            }
            50% {
                /* (Yellow-300 shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(250, 204, 21, 0.8), 0 0 20px rgba(250, 204, 21, 0.5);
            }
        }
        .text-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* [NEW] Animation for a holy/white glowing text shadow */
        @keyframes pulse-holy-glow {
            0%, 100% {
                /* (Light cyan shadow, subtle) */
                text-shadow: 0 0 5px rgba(207, 250, 254, 0.5), 0 0 10px rgba(207, 250, 254, 0.3);
            }
            50% {
                /* (Light cyan shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(207, 250, 254, 0.9), 0 0 20px rgba(207, 250, 254, 0.7);
            }
        }
        .text-pulse-holy-glow {
            color: #ecfeff; /* Màu Trắng Băng (cyan-50) */
            animation: pulse-holy-glow 2s ease-in-out infinite;
        }

        /* [NEW] Animation for a jade/ghostly glowing text shadow */
        @keyframes pulse-jade-glow {
            0%, 100% {
                /* (Emerald-300 shadow, subtle) */
                text-shadow: 0 0 5px rgba(110, 231, 183, 0.4), 0 0 10px rgba(110, 231, 183, 0.2);
            }
            50% {
                /* (Emerald-300 shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(110, 231, 183, 0.7), 0 0 20px rgba(110, 231, 183, 0.4);
            }
        }
        .text-pulse-jade-glow {
            color: #6ee7b7; /* Màu Xanh Ngọc (emerald-300) */
            animation: pulse-jade-glow 2s ease-in-out infinite;
        }

        /* [NEW] Animation for a violet/divine glowing text shadow */
        @keyframes pulse-violet-glow {
            0%, 100% {
                /* (Purple-300 shadow, subtle) */
                text-shadow: 0 0 5px rgba(192, 132, 252, 0.5), 0 0 10px rgba(192, 132, 252, 0.3);
            }
            50% {
                /* (Purple-300 shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(192, 132, 252, 0.8), 0 0 20px rgba(192, 132, 252, 0.5);
            }
        }
        .text-pulse-violet-glow {
            color: #c084fc; /* Màu Tím (purple-400) */
            animation: pulse-violet-glow 2s ease-in-out infinite;
        }

        /* [NEW] Animation for an abyss/hellfire glowing text shadow */
        @keyframes pulse-abyss-glow {
            0%, 100% {
                /* (Red-400 shadow, subtle) */
                text-shadow: 0 0 5px rgba(248, 113, 113, 0.5), 0 0 10px rgba(248, 113, 113, 0.3);
            }
            50% {
                /* (Red-400 shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(248, 113, 113, 0.8), 0 0 20px rgba(248, 113, 113, 0.5);
            }
        }
        .text-pulse-abyss-glow {
            color: #f87171; /* Màu Đỏ (red-400) */
            animation: pulse-abyss-glow 2s ease-in-out infinite;
        }

        /* [NEW] Animation for a divine/gold glowing text shadow */
        @keyframes pulse-divine-glow {
            0%, 100% {
                /* (Amber-300 shadow, subtle) */
                text-shadow: 0 0 5px rgba(252, 211, 77, 0.6), 0 0 10px rgba(253, 224, 71, 0.4);
            }
            50% {
                /* (Amber-300 shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(252, 211, 77, 0.9), 0 0 20px rgba(253, 224, 71, 0.6);
            }
        }
        .text-pulse-divine-glow {
            color: #fcd34d; /* Màu Vàng Đồng (amber-300) */
            animation: pulse-divine-glow 2s ease-in-out infinite;
        }

        /* [NEW] Animation for an ascension/white glowing text shadow */
        @keyframes pulse-ascension-glow {
            0%, 100% {
                /* (White shadow, subtle) */
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.6), 0 0 10px rgba(255, 255, 255, 0.4);
            }
            50% {
                /* (White shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(255, 255, 255, 1), 0 0 20px rgba(255, 255, 255, 0.7);
            }
        }
        .text-pulse-ascension-glow {
            color: #ffffff; /* Màu Trắng (white) */
            animation: pulse-ascension-glow 1.5s ease-in-out infinite; /* Nhanh hơn 1 chút */
        }

        /* [NEW] Animation for a sky/cyan glowing text shadow */
        @keyframes pulse-sky-glow {
            0%, 100% {
                /* (Sky-300 shadow, subtle) */
                text-shadow: 0 0 5px rgba(125, 211, 252, 0.5), 0 0 10px rgba(125, 211, 252, 0.3);
            }
            50% {
                /* (Sky-300 shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(125, 211, 252, 0.8), 0 0 20px rgba(125, 211, 252, 0.5);
            }
        }
        .text-pulse-sky-glow {
            color: #7dd3fc; /* Màu Xanh da trời (sky-300) */
            animation: pulse-sky-glow 2s ease-in-out infinite;
        }

        /* [REMOVED] Gỡ bỏ style 'text-pulse-rainbow-shadow' (Trắng + Hào quang 7 màu) */
        /*
        @keyframes pulse-rainbow-shadow { ... }
        .text-pulse-rainbow-shadow { ... }
        */

        /* [NEW] Animation for a void/dark glowing text shadow */
        @keyframes pulse-void-glow {
            0%, 100% {
                /* (Cyan-100 shadow, subtle) */
                text-shadow: 0 0 5px rgba(207, 250, 254, 0.7), 0 0 10px rgba(207, 250, 254, 0.5);
            }
            50% {
                /* (Cyan-100 shadow, brighter glow) */
                text-shadow: 0 0 10px rgba(207, 250, 254, 1), 0 0 20px rgba(207, 250, 254, 0.8);
            }
        }
        .text-pulse-void-glow {
            color: #111827; /* Màu Đen Than (gray-900) */
            animation: pulse-void-glow 1.8s ease-in-out infinite;
        }

        /* [NEW] Animation for slow spin (Summon Circle) */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 10s linear infinite;
        }

        /* [NEW] Animation for combatant hit shake */
        @keyframes enemy-hit-animation {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-3px); }
            100% { transform: translateX(0); }
        }
        .enemy-hit {
            /* Áp dụng animation */
            animation: enemy-hit-animation 0.3s 1 cubic-bezier(.36,.07,.19,.97);
        }

        /* [NEW] Disciple Name Effects based on Potential */
        /* [MODIFIED] Đồng bộ hóa tất cả font-size về 1.1rem */
        .name-potential-weak { color: #6b7280; font-size: 1.1rem; } /* Gray-500 */
        .name-potential-normal { color: #e5e7eb; font-size: 1.1rem; } /* Gray-200 */
        .name-potential-good { color: #60a5fa; font-weight: 600; text-shadow: 0 0 2px #3b82f6; font-size: 1.1rem; } /* Blue-400 */
        .name-potential-excellent { color: #c084fc; font-weight: 700; text-shadow: 0 0 3px #a855f7; font-size: 1.1rem; } /* Purple-400 */
        
        /* Thiên Tài: Rainbow + Glow + Sparkle */
        .name-potential-genius {
            /* Gradient 7 màu */
            background: linear-gradient(to right, #f87171, #fb923c, #facc15, #a3e635, #60a5fa, #c084fc, #f87171);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước */
            
            /* Animation chạy màu */
            animation: text-gradient-animation 6s linear infinite;
            
            /* Glow nhẹ xung quanh */
            filter: drop-shadow(0 0 3px rgba(250, 204, 21, 0.5));
        }
        
        /* [NEW] Tuyệt Thế: Red/Black + Void Glow */
        .name-potential-peerless {
            background: linear-gradient(to right, #ef4444, #b91c1c, #000000, #b91c1c, #ef4444);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước */
            
            /* Animation chạy màu */
            animation: text-gradient-animation 4s linear infinite;
            
            /* Glow đỏ thẫm */
            filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.8));
        }

        /* [NEW] Thiên Kiêu Chi Tử: Cosmic/Divine Style (V1.71) */
        .name-potential-heavenly {
            /* Gradient Hoàng Kim - Tím Huyền Bí - Trắng Tinh Khiết */
            background: linear-gradient(to right, #facc15, #c084fc, #ffffff, #e879f9, #facc15);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước */
            /* text-transform: uppercase; [REMOVED] Bỏ viết hoa toàn bộ */
            letter-spacing: 1px;
            
            /* Animation chạy màu siêu tốc */
            animation: text-gradient-animation 3s linear infinite;
            
            /* Glow Đa Sắc cực mạnh */
            filter: drop-shadow(0 0 5px rgba(250, 204, 21, 0.9)) drop-shadow(0 0 10px rgba(192, 132, 252, 0.7));
        }

        /* [NEW] Nghịch Thiên Cải Mệnh: Chaos/Void Style (V1.72) */
        .name-potential-defying {
            /* Gradient Hỗn Độn: Đen - Đỏ Máu - Tím Than - Trắng Lóa */
            background: linear-gradient(90deg, #000000, #991b1b, #581c87, #ffffff, #581c87, #991b1b, #000000);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước */
            /* text-transform: uppercase; [REMOVED] Bỏ viết hoa toàn bộ */
            font-family: 'Courier New', Courier, monospace; /* Font khác biệt */
            letter-spacing: 1px; /* [MODIFIED] Giảm khoảng cách chữ */
            
            /* Animation hỗn loạn */
            animation: text-gradient-animation 2.5s linear infinite;
            
            /* Glow Hắc Ám & Rung */
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 8px rgba(220, 38, 38, 0.8));
        }

        /* [NEW] Vô Cực Đạo Thể: Daoist/Yin-Yang Style (V1.74) */
        .name-potential-dao {
            /* Gradient Đen - Trắng - Xanh Ngọc - Vàng Kim */
            background: linear-gradient(to right, #000000, #ffffff, #0ea5e9, #facc15, #ffffff, #000000);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước */
            /* text-transform: uppercase; [REMOVED] Bỏ viết hoa toàn bộ */
            letter-spacing: 1px; /* [MODIFIED] Giảm khoảng cách chữ */
            
            /* Animation mượt mà */
            animation: text-gradient-animation 4s linear infinite;
            
            /* Glow Trắng & Xanh Thanh Khiết */
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.9)) drop-shadow(0 0 6px rgba(14, 165, 233, 0.8));
        }

        /* [NEW] Vạn Đạo Chi Tổ: Ancestral/Origin Style (V1.75) */
        .name-potential-ancestor {
            /* Gradient: Deep Space -> Nebula -> Core -> Gold */
            background: linear-gradient(45deg, #000000, #4c1d95, #db2777, #fbbf24, #db2777, #4c1d95, #000000);
            background-size: 400% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước */
            /* text-transform: uppercase; [REMOVED] Bỏ viết hoa toàn bộ */
            letter-spacing: 2px; /* [MODIFIED] Giảm khoảng cách chữ */
            font-family: serif; /* Font trang trọng */
            
            /* Animation: Slow majestic flow */
            animation: text-gradient-animation 8s linear infinite;
            
            /* Glow: Cosmic Aura */
            filter: drop-shadow(0 0 3px rgba(251, 191, 36, 0.8)) drop-shadow(0 0 8px rgba(219, 39, 119, 0.6)) drop-shadow(0 0 15px rgba(76, 29, 149, 0.4));
        }

        /* [NEW] Chân Ngã Duy Nhất: Pure Light/Platinum Style (V1.76) */
        .name-potential-trueself {
            /* Gradient: Trắng Sáng -> Bạch Kim -> Xanh Băng -> Trắng Lóa */
            background: linear-gradient(to right, #ffffff, #e2e8f0, #bae6fd, #ffffff, #bae6fd, #e2e8f0, #ffffff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước */
            /* text-transform: uppercase; [REMOVED] Bỏ viết hoa toàn bộ */
            letter-spacing: 2px; /* [MODIFIED] Giảm khoảng cách chữ */
            font-family: 'Noto Serif', serif;
            
            /* Animation: Ánh sáng lướt nhanh */
            animation: text-gradient-animation 2s linear infinite;
            
            /* Glow: Hào quang trắng chói mắt */
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 1)) 
                    drop-shadow(0 0 6px rgba(186, 230, 253, 0.8)) 
                    drop-shadow(0 0 10px rgba(255, 255, 255, 0.6));
        }

        /* [NEW] Nhất Niệm Vĩnh Hằng: Timeless/Eternal Neon Style (V1.77) */
        .name-potential-eternal {
            /* Gradient: Xanh Neon -> Hồng Phấn -> Trắng Tinh -> Vàng Chanh -> Xanh Neon */
            background: linear-gradient(90deg, #06b6d4, #f472b6, #ffffff, #facc15, #06b6d4);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            font-weight: 900;
            font-size: 1.1rem; /* [MODIFIED] Đồng bộ kích thước chuẩn */
            /* text-transform: uppercase; [REMOVED] Bỏ viết hoa toàn bộ */
            letter-spacing: 1px;
            font-family: 'Courier New', Courier, monospace; /* Font khác biệt */
            
            /* Animation: Chảy mượt mà */
            animation: text-gradient-animation 3s linear infinite;
            
            /* Glow: Rực rỡ đa sắc, không thể chìm */
            filter: drop-shadow(0 0 3px #22d3ee) 
                    drop-shadow(0 0 6px #e879f9) 
                    drop-shadow(0 0 10px #ffffff);
        }

        /* Icon vương miện cho Thiên Tài */
        .icon-genius {
            color: #facc15;
            animation: pulse-opacity 1s infinite;
            margin-right: 4px;
        }

        /* [NEW] Combat Animation Overlay */
        #combat-display-panel {
            position: relative; /* Make this a positioning context for the overlay */
        }
        #combat-animation-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; /* Click through */
            overflow: hidden; /* Prevent sparks from showing outside */
        }
        /* [NEW] Combat Spark Animation */
        @keyframes combat-spark-animation {
            0% {
                transform: scale(0.5);
                opacity: 1;
                /* [MODIFIED] Tăng kích thước vầng sáng */
                box-shadow: 0 0 30px 15px #facc15, 0 0 45px 30px rgba(250, 204, 21, 0.5); /* Yellow glow */
            }
            100% {
                /* [MODIFIED] Tăng kích thước cuối */
                transform: scale(2.0);
                opacity: 0;
                /* [MODIFIED] Tăng kích thước vầng sáng cuối */
                box-shadow: 0 0 60px 30px rgba(250, 204, 21, 0), 0 0 90px 60px rgba(250, 204, 21, 0);
            }
        }
        .combat-spark {
            position: absolute;
            /* [MODIFIED] Tăng kích thước cơ bản x3 */
            width: 30px;
            height: 30px;
            background-color: #fde047; /* yellow-300 */
            border-radius: 50%;
            animation: combat-spark-animation 0.3s ease-out 1;
            transform-origin: center;
        }
        /* [NEW] Combat Damage Number Animation */
        @keyframes float-up-fade-out {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scale(1.2); /* [MODIFIED] Bay cao hơn và to hơn */
                opacity: 0;
            }
        }
        .combat-damage-number {
            position: absolute;
            font-weight: bold;
            font-family: 'Noto Serif', serif; /* Dùng font game */
            text-shadow: 1px 1px 2px #000;
            animation: float-up-fade-out 1s ease-out 1; /* [MODIFIED] 1 giây */
            pointer-events: none;
            z-index: 10;
        }

        /* [NEW] Animation Fade In cho bảng tỉ lệ */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeInDown 0.3s ease-out forwards;
        }

        /* [MODIFIED] Hiệu ứng Tên Tông Môn - Style Lưu Quang (Ánh sáng trôi) */
        /* Thay vì phóng to, ta làm hiệu ứng hào quang tỏa nhẹ */
        @keyframes holy-glow-pulse {
            0% {
                filter: drop-shadow(0 0 2px rgba(34, 211, 238, 0.6));
            }
            50% {
                filter: drop-shadow(0 0 10px rgba(34, 211, 238, 0.9)) 
                        drop-shadow(0 0 20px rgba(6, 182, 212, 0.4));
            }
            100% {
                filter: drop-shadow(0 0 2px rgba(34, 211, 238, 0.6));
            }
        }
        
        /* Hiệu ứng luồng sáng chảy qua chữ */
        @keyframes text-shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .sect-name-ultimate {
            font-family: 'Noto Serif', serif;
            font-weight: 800; /* Đậm vừa phải */
            letter-spacing: 1px;
            font-size: 2.5rem; 
            
            /* Gradient màu chữ: Trắng -> Xanh Băng -> Trắng (Tạo hiệu ứng quét sáng) */
            /* Tạo dải màu lặp lại để khi background-position dịch chuyển sẽ tạo cảm giác dòng chảy */
            background: linear-gradient(90deg, #ffffff 0%, #cffafe 25%, #22d3ee 50%, #cffafe 75%, #ffffff 100%);
            background-size: 200% auto; /* Kích thước nền lớn hơn chữ để di chuyển */
            
            /* Cắt nền theo chữ */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            /* Áp dụng animation: Shimmer (chạy nền) + Glow (tỏa sáng) */
            animation: text-shimmer 6s linear infinite, holy-glow-pulse 3s ease-in-out infinite;
            
            display: inline-block;
            padding: 10px;
            /* Đảm bảo chữ không bị vỡ khi render gradient */
            -webkit-font-smoothing: antialiased;
        }
        /* [END NEW] */

        /* [NEW] Background for Login Screen (Thêm lại) */
        #login-screen {
            /* [MODIFIED] Thay ảnh nền mới theo yêu cầu */
            background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)), url('https://i.imgur.com/f42cLpi.jpeg');
            background-size: cover;
            background-position: center;
        }

        /* [MODIFIED] Background for Skills Modal (Moved to modal) */
        #skills-modal .modal {
            /* [MODIFIED] Giảm độ mờ từ 0.5 -> 0.3 để sáng hơn */
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://i.imgur.com/ne9nuG0.jpeg');
            background-size: cover;
            background-position: center;
        }
        /* [REMOVED] Removed background from panels */
        #panel-mon-phai, #panel-sieu-viet, #panel-hon-ky { /* [MODIFIED] Thêm panel-hon-ky vào đây */
             background-color: transparent;
        }
        
        /* [NEW] Glass effect for Skills modal header/footer/tabs */
        #skills-modal .modal-header,
        #skills-modal .modal-tab-bar,
        #skills-modal .modal-footer {
            background-color: rgba(0, 0, 0, 0.1); /* 10% black */
            backdrop-filter: blur(4px);
        }
        #skills-modal .tab-btn {
            background-color: transparent !important;
        }
        #skills-modal .tab-btn.tab-active {
            background-color: rgba(0, 0, 0, 0.1) !important;
        }


        /* [NEW] Background for Tho Ren Modal */
        #tho-ren-modal .modal {
            background-color: #1f2937; /* Fallback */
            /* [MODIFIED] Thay ảnh nền Thợ Rèn -> Ảnh Imgur mới */
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://i.imgur.com/BRAVKc2.jpeg');
            background-size: cover;
            background-position: center;
        }

        /* [NEW] Background for Pet Modal (Re-adding) */
        #sung-vat-modal .modal {
            background-color: #1f2937; /* Fallback */
            /* Giảm độ tối từ 0.4 xuống 0.2 */
            background-image: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://i.imgur.com/K3fpZjl.jpeg');
            background-size: cover;
            background-position: center;
        }

        /* [NEW] Background for Menh Cach Modal (Re-adding) */
        #menh-cach-modal .modal {
            background-color: #1f2937; /* Fallback bg-gray-800 */
            /* Lớp phủ 20% để nền sáng rõ */
            background-image: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://i.imgur.com/7casKU0.jpeg');
            background-size: cover;
            background-position: center;
        }
        
        /* [NEW] Background for Luyen Cong Modal (Re-adding) */
        #dungeons-modal .modal {
            background-color: #1f2937; /* Fallback */
            /* [MODIFIED] Thay ảnh nền Luyện Công -> Ảnh Imgur mới */
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://i.imgur.com/hXe7bGE.jpeg');
            background-size: cover;
            background-position: center;
        }
        
        /* [NEW] Background for Turn-Based Combat Modal (Re-adding) */
        #turn-based-combat-modal .modal {
            background-color: #1f2937; /* Fallback bg-gray-800 */
            /* Thêm lại ảnh nền và lớp phủ 30% */
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://i.imgur.com/Ll9Ubns.jpeg');
            background-size: cover;
            background-position: center;
        }

        /* [NEW] Background for Mon Phai Modal */
        #mon-phai-modal .modal {
            background-color: #1f2937; /* Fallback */
            /* Lớp phủ 10% (0.1) để nền sáng rõ */
            background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)), url('https://i.imgur.com/3W0bGYQ.jpeg');
            background-size: cover;
            background-position: center;
        }

        /* [NEW] Background for Tong Mon Modal */
        #tong-mon-modal .modal {
            background-color: #1f2937; /* Fallback */
            /* Thêm lớp phủ 40% để chữ nổi bật */
            /* [MODIFIED] Thay ảnh nền Tông Môn -> Ảnh Imgur mới */
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://i.imgur.com/BlF3jUt.jpeg');
            background-size: cover;
            background-position: center;
        }
        
        /* [NEW] Background for Tien Trang Modal (Thêm mới) */
        #tien-trang-modal .modal {
            background-color: #1f2937; /* Fallback */
            /* Ảnh nền: Gian phòng cổ kính, sang trọng */
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://i.imgur.com/WA8cpKi.jpeg');
            background-size: cover;
            background-position: center;
        }

        /* [NEW] Background for Changelog Modal (Chân Long Giáng Thế) */
        #changelog-modal .modal {
            background-color: #1f2937; /* Fallback */
            /* Ảnh nền rồng cuộn mây (Chân Long) */
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://i.imgur.com/R5SC36C.jpeg');
            background-size: cover;
            background-position: center;
        }

        /* [NEW] Hiệu ứng kính mờ (Glassmorphism) cho nội dung bên trong Tiền Trang */
        #tien-trang-modal .bg-gray-700,
        #tien-trang-modal .bg-gray-800,
        #tien-trang-modal .bg-gray-900 {
            /* [MODIFIED] Giảm độ mờ xuống 15% (0.15) để nhìn rõ nền hơn */
            background-color: rgba(0, 0, 0, 0.15) !important;
            /* Thêm hiệu ứng làm mờ hậu cảnh */
            backdrop-filter: blur(4px);
            /* Thêm viền mỏng để phân tách */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* [NEW] Style cho Thương Nhân Thần Bí */
        .merchant-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid #4c1d95; /* Viền tím đậm */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        .merchant-card:hover {
            border-color: #a855f7; /* Viền tím sáng khi hover */
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }
        
        /* [NEW] Subtab Styles for Chinh Phat */
        .subtab-btn {
            transition: all 0.2s;
        }
        .subtab-btn.active {
            background-color: #b91c1c; /* red-700 */
            color: #fff;
            box-shadow: 0 0 10px rgba(185, 28, 28, 0.5);
            border: 1px solid #fca5a5;
        }

        /* =========================================
           [CHỈNH SỬA] UI TAB TIỀN TRANG (ICON & COLOR)
           ========================================= */
        
        /* 1. Container Thanh Tab */
        #tien-trang-modal .flex.border-b {
            background-color: #0f172a !important; /* Nền xanh đen đậm (Slate-900) */
            border-bottom: 1px solid #334155;
        }

        /* 2. Nút Tab Mặc định */
        #tien-trang-modal .tab-btn {
            display: flex; /* Dàn hàng ngang cho Icon + Text */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Khoảng cách giữa Icon và Text */
            
            background-color: transparent !important;
            color: #94a3b8; /* Màu xám xanh (Slate-400) */
            font-family: 'Noto Serif', serif;
            font-weight: 600;
            font-size: 0.95rem;
            
            text-transform: none; /* Viết thường tự nhiên */
            
            border: none; 
            border-bottom: 3px solid transparent;
            
            transition: all 0.3s ease;
            padding: 12px 20px;
            white-space: nowrap; /* Không xuống dòng */
        }
        
        #tien-trang-modal .tab-btn i {
            font-size: 1.1rem; /* Icon to hơn chữ một chút */
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        /* 3. Hiệu ứng Hover */
        #tien-trang-modal .tab-btn:hover {
            color: #e2e8f0; /* Trắng sáng */
            background-color: rgba(255, 255, 255, 0.05) !important;
        }
        #tien-trang-modal .tab-btn:hover i {
            opacity: 1;
        }
        
        /* 4. Trạng thái Active (Chung) */
        #tien-trang-modal .tab-btn.tab-active {
            background-color: rgba(15, 23, 42, 0.8) !important; /* Giữ nền tối */
            font-weight: 700;
            filter: drop-shadow(0 0 8px rgba(0,0,0,0.5)); /* Bóng nhẹ giúp nổi bật trên nền sáng */
        }
        
        /* 5. Màu sắc riêng cho từng Tab (Color Coding) */
        
        /* Đổi Tiền - Vàng (Gold) */
        #tab-exchange.tab-active { color: #facc15 !important; border-bottom-color: #facc15; }
        
        /* Tiêu Hao - Xanh Lá (Green) */
        #tab-buy.tab-active { color: #4ade80 !important; border-bottom-color: #4ade80; }
        
        /* Đồ Phổ - Cam (Orange) */
        #tab-buy-blueprints.tab-active { color: #fb923c !important; border-bottom-color: #fb923c; }
        
        /* Phù Phép - Tím (Purple) */
        #tab-buy-scrolls.tab-active { color: #c084fc !important; border-bottom-color: #c084fc; }
        
        /* Trang Bị - Xanh Dương (Blue) */
        #tab-buy-equip.tab-active { color: #60a5fa !important; border-bottom-color: #60a5fa; }
        
        /* Bán Đồ - Đỏ (Red) */
        #tab-sell.tab-active { color: #f87171 !important; border-bottom-color: #f87171; }
        
        /* Bán NL - Nâu/Vàng Đất (Amber) */
        #tab-sell-materials.tab-active { color: #fbbf24 !important; border-bottom-color: #fbbf24; }
        
        /* Đổi NL - Xanh Ngọc (Cyan) */
        #tab-exchange-items.tab-active { color: #22d3ee !important; border-bottom-color: #22d3ee; }

        
        /* Xử lý trong suốt cho ô nhập liệu (Input) */
        #tien-trang-modal input {
            background-color: rgba(0, 0, 0, 0.3) !important; /* [MODIFIED] Giảm độ mờ ô nhập liệu */
            border-color: rgba(255, 255, 255, 0.3) !important;
            color: #fff;
        }
        
        /* [MODIFIED] Hiệu ứng kính mờ (trong suốt) cho Tông Môn */
        #tong-mon-modal .bg-gray-700,
        #tong-mon-modal .bg-gray-800,
        #tong-mon-modal .bg-gray-900 {
            /* [MODIFIED] Dùng bg-black/10 (10% đen) và XÓA hiệu ứng mờ (blur) */
            background-color: rgba(0, 0, 0, 0.1) !important;
            /* [REMOVED] backdrop-filter: blur(4px); */
            /* Thêm viền mờ để phân tách */
            border-width: 1px;
            border-color: rgba(255, 255, 255, 0.1);
        }
        .character-aura-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: skewX(-25deg);
            animation: aura-shine 3s infinite linear;
            pointer-events: none;
        }

        /* [MODIFIED] Style Tối Thượng: Hiệu ứng Dòng Chảy Băng Hàn (Xanh Băng/Cyan) */
        .game-title-modern {
            /* [MODIFIED] Đổi font sang "Noto Serif" để đồng bộ */
            font-family: 'Noto Serif', serif; 
            font-weight: 900; /* Cực đậm */
            
            /* [MODIFIED] Bỏ in hoa toàn bộ, để hiển thị tự nhiên */
            text-transform: none; 
            
            /* [MODIFIED] Giảm khoảng cách chữ để vừa khung hơn */
            letter-spacing: 0.02em; 
            
            /* [MODIFIED] Gradient sáng hơn (Bỏ các màu tối #0c4a6e, dùng màu trung tính sáng hơn) */
            background: linear-gradient(
                110deg, 
                #0284c7 0%,   /* Sky-600 (Sáng hơn Sky-900 cũ) */
                #22d3ee 20%,  /* Cyan-400 */
                #cffafe 40%,  /* Cyan-100 (Rất sáng) */
                #ffffff 50%,  /* Trắng (Lõi băng) */
                #cffafe 60%,  
                #22d3ee 80%,  
                #0284c7 100%
            );
            background-size: 200% auto; /* Kích thước lớn để tạo không gian di chuyển */
            
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            
            /* Viền Xanh Băng nhạt sắc nét */
            -webkit-text-stroke: 1px rgba(165, 243, 252, 0.8); /* Cyan-200 */
            
            /* [MODIFIED] Giảm độ mờ (blur) của bóng đổ, tăng độ sắc nét */
            filter: drop-shadow(0 2px 0px rgba(0,0,0,0.5)) /* Giảm alpha bóng đen */
                    drop-shadow(0 0 5px rgba(34, 211, 238, 0.8)); /* Tăng alpha bóng sáng (Cyan) */
            
            position: relative;
            display: inline-block;
            
            /* Animation: Dòng chảy hàn khí (Flow) */
            animation: text-metal-flow 4s linear infinite;
        }

        /* Hiệu ứng dòng chảy nội lực */
        @keyframes text-metal-flow {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        /* Giữ lại lớp bóng loáng quét qua (Shine) để tăng độ sắc sảo */
        .game-title-modern::after {
            content: 'Võ Lâm Luân Hồi';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /* Ánh sáng trắng quét nhanh */
            background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.9) 50%, transparent 100%);
            background-size: 20% 100%; /* Tia sáng hẹp hơn, sắc hơn */
            background-repeat: no-repeat;
            background-position: -150% 0;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-text-stroke: 0; 
            
            animation: title-shine-pass 5s infinite; /* Chậm hơn một chút để tách biệt với dòng chảy nền */
            pointer-events: none;
            z-index: 1;
        }

        @keyframes title-shine-pass {
            0%, 30% { background-position: -150% 0; } /* Nghỉ lâu hơn */
            60% { background-position: 250% 0; } /* Quét qua */
            100% { background-position: 250% 0; }
        }

        /* [NEW] "Băng Phách Hàn Quang" Style - Phong cách Băng Giá/Hàn Khí */
        .btn-ice-soul {
            position: relative;
            width: 100%;
            padding: 18px 20px; /* Tăng padding một chút */
            margin-bottom: 18px;
            
            /* Tạo hình khối tinh thể băng sắc nhọn (Vát góc bất đối xứng) */
            clip-path: polygon(
                5% 0%, 100% 0%,       /* Góc trên */
                95% 100%, 0% 100%     /* Góc dưới */
            );
            
            /* Nền: Băng vĩnh cửu (Xanh đen -> Xanh ngọc -> Xanh đen) */
            background: linear-gradient(120deg, #083344 0%, #0e7490 50%, #06b6d4 100%);
            
            /* Viền giả (do clip-path cắt border) - Dùng box-shadow inset */
            box-shadow: 
                inset 0 0 0 2px rgba(165, 243, 252, 0.3), /* Viền băng mờ */
                inset 0 0 20px rgba(34, 211, 238, 0.2); /* Glow nội tại */
            
            /* Chữ: Trắng xanh, lạnh lẽo */
            color: #cffafe; 
            /* [MODIFIED] Đổi font sang "Noto Serif" để đồng bộ */
            font-family: 'Noto Serif', serif; 
            font-weight: 700; /* Đậm */
            font-size: 1.1rem; /* Tinh chỉnh lại kích thước cho Noto Serif */
            text-transform: uppercase;
            letter-spacing: 2px; 
            text-shadow: 0 0 5px rgba(34, 211, 238, 0.8);
            
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            overflow: hidden;
            text-align: center;
        }

        /* Hiệu ứng phản chiếu gương băng (Ice Mirror Sheen) */
        .btn-ice-soul::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            transform: rotate(45deg);
            opacity: 0.5;
            pointer-events: none;
        }

        /* Hiệu ứng sương mù lạnh quét qua */
        .btn-ice-soul::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            /* Vệt sáng trắng lạnh */
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transform: skewX(-20deg);
            transition: none;
            z-index: 2;
        }

        /* Hover Effects: Đóng băng & Phát sáng */
        .btn-ice-soul:hover {
            /* Nền sáng lên như băng gặp nắng */
            background: linear-gradient(120deg, #0e7490 0%, #06b6d4 50%, #67e8f9 100%);
            
            /* Chữ sáng trắng chói */
            color: #fff;
            text-shadow: 0 0 10px #a5f3fc, 0 0 20px #22d3ee;
            
            transform: scale(1.05) skewX(-2deg); /* Biến dạng nhẹ */
            
            /* Tăng cường viền sáng */
            box-shadow: 
                inset 0 0 0 2px #cffafe,
                0 0 15px #06b6d4;
        }

        .btn-ice-soul:hover::after {
            animation: frost-sweep 0.6s ease-in-out;
        }

        @keyframes frost-sweep {
            0% { left: -100%; opacity: 0; }
            50% { opacity: 1; }
            100% { left: 200%; opacity: 0; }
        }

        /* Icon văn bản */
        .btn-ice-soul i {
            margin-right: 10px;
            color: #67e8f9; /* Cyan-300 */
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        
        .btn-ice-soul:hover i {
            color: #fff;
            transform: rotate(360deg) scale(1.2); /* Xoay tròn như bông tuyết */
        }
        
        /* Tinh thể băng trang trí nhỏ (Pseudo elements giả lập) */
        .btn-ice-soul span.ice-shard {
            position: absolute;
            background: white;
            opacity: 0.8;
            border-radius: 50%;
            box-shadow: 0 0 4px white;
            animation: twinkle 2s infinite ease-in-out;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* [NEW] Sect Title Styles (Text Shadows / Glows) */
        .text-shadow-red { text-shadow: 0 0 5px #ef4444, 0 0 10px rgba(239, 68, 68, 0.5); }
        .text-shadow-blue { text-shadow: 0 0 5px #3b82f6, 0 0 10px rgba(59, 130, 246, 0.5); }
        .text-shadow-green { text-shadow: 0 0 5px #22c55e, 0 0 10px rgba(34, 197, 94, 0.5); }
        .text-shadow-gold { text-shadow: 0 0 5px #eab308, 0 0 10px rgba(234, 179, 8, 0.5); }
        .text-shadow-purple { text-shadow: 0 0 5px #a855f7, 0 0 10px rgba(168, 85, 247, 0.5); }
        .text-shadow-cyan { text-shadow: 0 0 5px #06b6d4, 0 0 10px rgba(6, 182, 212, 0.5); }
        .text-shadow-pink { text-shadow: 0 0 5px #ec4899, 0 0 10px rgba(236, 72, 153, 0.5); }
        .text-shadow-white { text-shadow: 0 0 5px #ffffff, 0 0 10px rgba(255, 255, 255, 0.5); }
        .text-shadow-orange { text-shadow: 0 0 5px #f97316, 0 0 10px rgba(249, 115, 22, 0.5); }
        .text-shadow-black { text-shadow: 0 0 5px #000000, 0 0 10px rgba(255, 255, 255, 0.3); }
        /* [END NEW] */

        /* [NEW] Login Card Style (Landing Page 2.0) */
        .login-card {
            background: rgba(10, 20, 35, 0.65); /* Dark Blue Glass */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(165, 243, 252, 0.15); /* Viền Cyan nhạt */
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7), inset 0 0 30px rgba(0, 0, 0, 0.5);
            animation: cardFadeIn 1s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Hiệu ứng nền di chuyển chậm cho Landing */
        @keyframes bg-pan {
            0% { background-position: 50% 50%; }
            50% { background-position: 55% 55%; }
            100% { background-position: 50% 50%; }
        }

        /* [NEW] STYLE CHỮ CHO MAP TRÙNG SINH 50 */
        @keyframes text-ultimate-flow {
            0% { background-position: 0% 50%; text-shadow: 0 0 5px #ef4444; }
            50% { background-position: 100% 50%; text-shadow: 0 0 20px #fbbf24, 0 0 10px #000; }
            100% { background-position: 0% 50%; text-shadow: 0 0 5px #ef4444; }
        }
        .text-ultimate-style {
            /* Gradient Đỏ Máu - Đen Vực Thẳm - Vàng Hoàng Kim */
            background: linear-gradient(90deg, #ef4444, #000000, #fbbf24, #000000, #ef4444);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.0rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: 2px;
            text-transform: uppercase;
            
            /* Animation chạy nhanh và nguy hiểm */
            animation: text-ultimate-flow 3s linear infinite;
            
            /* Bóng đổ đỏ rực */
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.8));
        }

        /* [NEW] STYLE TINH HÀ (TS 60) */
        @keyframes text-astral-pulse {
            0%, 100% { text-shadow: 0 0 10px #60a5fa, 0 0 20px #2563eb; }
            50% { text-shadow: 0 0 20px #93c5fd, 0 0 40px #60a5fa, 0 0 10px #ffffff; }
        }
        .text-astral-style {
            /* Gradient Xanh Dương - Tím - Trắng (Vũ Trụ) */
            background: linear-gradient(45deg, #1e3a8a, #3b82f6, #93c5fd, #e879f9, #1e3a8a);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.05rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: 3px;
            text-transform: uppercase;
            
            /* Animation trôi chậm và phát sáng */
            animation: text-gradient-animation 5s ease infinite, text-astral-pulse 3s ease-in-out infinite;
        }

        /* [MODIFIED] STYLE NGUYÊN SƠ (TS 70) - Đã bỏ rung lắc */
        .text-chaos-style {
            /* Gradient Xám Bạc - Đen - 7 Màu Hỗn Loạn */
            background: linear-gradient(to right, #9ca3af, #000000, #f87171, #facc15, #000000, #9ca3af);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.05rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: -1px; /* Chữ dính vào nhau do áp lực */
            text-transform: uppercase;
            
            /* [MODIFIED] Chỉ giữ lại hiệu ứng trôi màu mượt mà, bỏ rung lắc */
            animation: text-gradient-animation 4s linear infinite;
            
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        /* [NEW] STYLE LUÂN HỒI (TS 80) */
        .text-samsara-style {
            /* Gradient Đen - Trắng - Đen - Vàng */
            background: linear-gradient(90deg, #000000, #ffffff, #000000, #facc15, #000000);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.1rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: 2px;
            text-transform: uppercase;
            
            /* Animation chạy nhanh */
            animation: text-gradient-animation 3s linear infinite;
            
            /* Bóng đổ trắng/đen */
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8)) drop-shadow(0 0 2px rgba(0,0,0,1));
        }

        /* [NEW] STYLE HOÀNG HÔN (TS 90) */
        @keyframes text-twilight-pulse {
            0%, 100% { text-shadow: 0 0 10px #f97316, 0 0 20px #b91c1c; }
            50% { text-shadow: 0 0 20px #fb923c, 0 0 40px #ef4444, 0 0 10px #ffffff; }
        }
        .text-twilight-style {
            /* Gradient Vàng Cam -> Đỏ -> Tím -> Đen (Hoàng Hôn/Tận Thế) */
            background: linear-gradient(to right, #fbbf24, #f97316, #b91c1c, #4c1d95, #000000);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.1rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: 2px;
            text-transform: uppercase;
            
            /* Animation chạy màu và phát sáng */
            animation: text-gradient-animation 4s linear infinite, text-twilight-pulse 3s ease-in-out infinite;
        }

        /* [NEW] STYLE HỦY DIỆT (TS 100) - SỬA LẠI: BỎ RUNG LẮC */
        .text-destruction-style {
            /* Gradient Đen Vực Thẳm - Đỏ Máu - Xám Tro (Tạo cảm giác tàn khốc) */
            background: linear-gradient(to right, #000000, #991b1b, #4b5563, #000000);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.15rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Courier New', Courier, monospace; /* Font đơn giản, lạnh lùng */
            
            /* Animation: Chảy chậm rãi, nguy hiểm (Không rung) */
            animation: text-gradient-animation 5s linear infinite;
            
            /* Bóng đổ Đỏ Đậm + Đen */
            filter: drop-shadow(0 0 5px rgba(185, 28, 28, 0.8)) drop-shadow(0 0 10px rgba(0, 0, 0, 1));
        }

        /* [NEW] STYLE HỖN NGUYÊN (TS 125) */
        @keyframes text-divine-pulse {
            0%, 100% { text-shadow: 0 0 10px #ffffff, 0 0 20px #22d3ee; opacity: 1; }
            50% { text-shadow: 0 0 20px #ffffff, 0 0 40px #facc15, 0 0 10px #22d3ee; opacity: 0.9; }
        }
        .text-divine-truth-style {
            /* Gradient Trắng - Vàng Kim - Xanh Ngọc (Thánh Khiết) */
            background: linear-gradient(to right, #ffffff, #facc15, #22d3ee, #ffffff);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.2rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: 2px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation chảy nhẹ nhàng + phát sáng */
            animation: text-gradient-animation 4s linear infinite, text-divine-pulse 3s ease-in-out infinite;
            
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
        }

        /* [NEW] STYLE THÁI HƯ (TS 150) */
        @keyframes text-void-shimmer {
            0% { background-position: 0% 50%; opacity: 0.8; }
            50% { background-position: 100% 50%; opacity: 1; text-shadow: 0 0 15px rgba(148, 163, 184, 0.8); }
            100% { background-position: 0% 50%; opacity: 0.8; }
        }
        .text-ancient-void-style {
            /* Gradient Xám Bạc - Đen - Xanh Nhạt (Hư Vô/Cổ Đại) */
            background: linear-gradient(90deg, #94a3b8, #000000, #cbd5e1, #475569, #000000, #94a3b8);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.25rem !important; /* To hơn một chút để nổi bật */
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Courier New', Courier, monospace; /* Font cổ điển/máy móc */
            
            /* Animation */
            animation: text-void-shimmer 5s infinite linear;
            
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.3));
        }

        /* [NEW] STYLE CỰC ĐẠO (TS 175) */
        @keyframes text-dao-pulse {
            0%, 100% { opacity: 1; text-shadow: 0 0 10px #ffffff, 0 0 20px #facc15; }
            50% { opacity: 0.8; text-shadow: 0 0 20px #ffffff, 0 0 40px #facc15, 0 0 10px #000000; }
        }
        .text-ultimate-dao-style {
            /* Gradient: Vàng Kim - Đen - Trắng (Cực Đạo) */
            background: linear-gradient(135deg, #facc15, #000000, #ffffff, #000000, #facc15);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.3rem !important;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation */
            animation: text-gradient-animation 3s linear infinite, text-dao-pulse 2s ease-in-out infinite;
            
            filter: drop-shadow(0 0 6px rgba(250, 204, 21, 0.6));
        }

        /* [NEW] STYLE VĨNH HẰNG (TS 200) */
        @keyframes text-eternal-shimmer {
            0% { background-position: 0% 50%; filter: brightness(100%); }
            50% { background-position: 100% 50%; filter: brightness(150%); text-shadow: 0 0 20px rgba(255, 255, 255, 0.8); }
            100% { background-position: 0% 50%; filter: brightness(100%); }
        }
        .text-eternal-truth-style {
            /* Gradient: Bạch Kim - Vàng Chanh - Xanh Thiên Thanh (Vĩnh Hằng) */
            background: linear-gradient(90deg, #e2e8f0, #fef08a, #0ea5e9, #fef08a, #e2e8f0);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.35rem !important;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation */
            animation: text-eternal-shimmer 6s infinite linear;
            
            filter: drop-shadow(0 0 5px rgba(14, 165, 233, 0.5));
        }

        /* [NEW] STYLE HỦY DIỆT CHÂN THẦN (TS 250) */
        @keyframes text-destroy-shimmer {
            0% { text-shadow: 0 0 10px #7f1d1d, 0 0 20px #000000; color: #f87171; transform: translateX(0); }
            25% { transform: translateX(-1px); }
            50% { text-shadow: 0 0 30px #ef4444, 0 0 50px #b91c1c; color: #ffffff; transform: translateX(1px); }
            75% { transform: translateX(-1px); }
            100% { text-shadow: 0 0 10px #7f1d1d, 0 0 20px #000000; color: #f87171; transform: translateX(0); }
        }
        .text-destroy-god-style {
            /* Gradient: Đỏ Thẫm - Đen - Xám Bạc (Hủy Diệt) */
            background: linear-gradient(to bottom, #ef4444, #000000, #9ca3af, #7f1d1d);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.4rem !important;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Courier New', Courier, monospace; /* Font máy móc/hủy diệt */
            
            /* Animation: Chậm rãi nhưng nguy hiểm */
            animation: text-gradient-animation 2s linear infinite, text-destroy-shimmer 0.5s infinite alternate;
            
            filter: drop-shadow(0 0 8px rgba(220, 38, 38, 0.8));
        }

        /* [MODIFIED] STYLE ĐIỂM KỲ DỊ (TS 300) - FIX: ĐẸP HƠN, BỎ CO GIÃN */
        @keyframes text-singularity-pulse {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #4f46e5, 0 0 20px #818cf8; transform: scale(1); filter: brightness(1); }
            50% { text-shadow: 0 0 15px #fff, 0 0 30px #06b6d4, 0 0 40px #c084fc; transform: scale(1.02); filter: brightness(1.2); }
            100% { text-shadow: 0 0 5px #fff, 0 0 10px #4f46e5, 0 0 20px #818cf8; transform: scale(1); filter: brightness(1); }
        }
        .text-singularity-style {
            /* Gradient: Tím Thẫm - Xanh Neon - Trắng - Chàm (Vũ Trụ Sáng) */
            background: linear-gradient(90deg, #4c1d95, #22d3ee, #ffffff, #818cf8, #4c1d95);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.3rem !important;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Noto Serif', serif; /* Font đẹp hơn */
            
            /* Animation: Chảy màu mượt và Phát sáng */
            animation: text-gradient-animation 3s linear infinite, text-singularity-pulse 3s ease-in-out infinite;
            
            filter: drop-shadow(0 0 5px rgba(129, 140, 248, 0.6));
        }

        /* [NEW] STYLE BỈ NGẠN (TS 400) */
        @keyframes text-nirvana-fade {
            0%, 100% { opacity: 0.8; filter: blur(0px); text-shadow: 0 0 10px #ffffff; }
            50% { opacity: 1; filter: blur(0.5px); text-shadow: 0 0 20px #a5f3fc, 0 0 30px #ffffff; }
        }
        .text-nirvana-style {
            /* Gradient: Trắng Tinh - Xanh Băng - Bạch Kim (Hư Ảo) */
            background: linear-gradient(to right, #ffffff, #cffafe, #e2e8f0, #ffffff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.4rem !important;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Mờ ảo trôi nổi */
            animation: text-gradient-animation 8s linear infinite, text-nirvana-fade 4s ease-in-out infinite;
            
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
        }

        /* [NEW] STYLE VÔ CỰC (TS 500) */
        @keyframes text-infinite-shimmer {
            0% { background-position: 0% 50%; filter: drop-shadow(0 0 5px white); }
            50% { background-position: 100% 50%; filter: drop-shadow(0 0 15px white) drop-shadow(0 0 5px black); }
            100% { background-position: 0% 50%; filter: drop-shadow(0 0 5px white); }
        }
        .text-infinite-style {
            /* Gradient: Trắng - Bạc - Đen (Vô Cực) */
            background: linear-gradient(90deg, #ffffff, #9ca3af, #000000, #9ca3af, #ffffff);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.45rem !important;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Chảy màu bạc đen sang trọng */
            animation: text-infinite-shimmer 4s infinite linear;
        }

        /* [NEW] STYLE KHỞI NGUYÊN (TS 750) */
        @keyframes text-origin-pulse {
            0%, 100% { text-shadow: 0 0 10px #facc15, 0 0 20px #ffffff; filter: brightness(1); }
            50% { text-shadow: 0 0 30px #fde047, 0 0 50px #ffffff, 0 0 10px #facc15; filter: brightness(1.2); }
        }
        .text-origin-god-style {
            /* Gradient: Vàng Kim - Trắng - Bạch Kim (Thần Thánh) */
            background: linear-gradient(to right, #facc15, #ffffff, #eab308, #ffffff, #facc15);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.5rem !important;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Phát sáng rực rỡ */
            animation: text-gradient-animation 5s linear infinite, text-origin-pulse 3s ease-in-out infinite;
            
            filter: drop-shadow(0 0 5px rgba(234, 179, 8, 0.8));
        }

        /* [NEW] STYLE ĐẠI ĐẠO (TS 1000) */
        @keyframes text-dao-shimmer {
            0% { background-position: 0% 50%; filter: hue-rotate(0deg); }
            50% { background-position: 100% 50%; filter: hue-rotate(180deg); text-shadow: 0 0 20px rgba(255,255,255,0.9); }
            100% { background-position: 0% 50%; filter: hue-rotate(360deg); }
        }
        .text-great-dao-style {
            /* Gradient: Kim Cương - Đa Sắc (Đại Đạo) */
            background: linear-gradient(120deg, #ffffff, #e2e8f0, #a5f3fc, #c084fc, #facc15, #ffffff);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.5rem !important; /* [MODIFIED] Giảm nhẹ size để cân đối */
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* [NEW] Fix lỗi mất dấu và căn chỉnh */
            line-height: 1.6; /* Tăng chiều cao dòng để hiển thị đủ dấu */
            padding-bottom: 5px; /* Thêm đệm dưới */
            display: inline-block; /* Giúp padding hoạt động tốt hơn */
            
            /* Animation: Biến ảo */
            animation: text-dao-shimmer 5s infinite linear;
            
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.9));
        }

        /* [NEW] STYLE BẢN NGUYÊN (TS 1500) */
        @keyframes text-origin-deep-pulse {
            0%, 100% { text-shadow: 0 0 10px #000000, 0 0 20px #4c1d95; filter: contrast(1.2); }
            50% { text-shadow: 0 0 20px #ffffff, 0 0 40px #2e1065, 0 0 10px #000000; filter: contrast(1.5); }
        }
        .text-origin-source-style {
            /* Gradient: Đen Thẫm - Tím Than - Lõi Trắng (Bản Nguyên) */
            background: linear-gradient(to right, #000000, #2e1065, #ffffff, #2e1065, #000000);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.55rem !important;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Sâu thẳm và bí ẩn */
            animation: text-gradient-animation 6s linear infinite, text-origin-deep-pulse 4s ease-in-out infinite;
            
            filter: drop-shadow(0 0 8px rgba(76, 29, 149, 0.8));
        }

        /* [NEW] STYLE CHÂN LÝ (TS 2000) */
        @keyframes text-truth-shimmer {
            0% { text-shadow: 0 0 10px #0ea5e9, 0 0 20px #facc15; transform: scale(1); }
            50% { text-shadow: 0 0 20px #38bdf8, 0 0 40px #fef08a, 0 0 10px #ffffff; transform: scale(1.02); }
            100% { text-shadow: 0 0 10px #0ea5e9, 0 0 20px #facc15; transform: scale(1); }
        }
        .text-absolute-truth-style {
            /* Gradient: Xanh Dương Đậm - Cyan - Vàng Kim (Chân Lý) */
            background: linear-gradient(120deg, #1e3a8a, #06b6d4, #ffffff, #facc15, #06b6d4, #1e3a8a);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.35rem !important; /* [MODIFIED] Giảm size */
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;

            /* [NEW] Fix lỗi mất dấu */
            line-height: 1.6;
            padding-bottom: 5px;
            display: inline-block;
            
            /* Animation: Chảy màu và phát sáng trí tuệ */
            animation: text-gradient-animation 5s linear infinite, text-truth-shimmer 4s ease-in-out infinite;
            
            filter: drop-shadow(0 0 6px rgba(14, 165, 233, 0.6));
        }

        /* [NEW] STYLE THIÊN NGOẠI (TS 3000) */
        @keyframes text-void-pulse-deep {
            0%, 100% { text-shadow: 0 0 10px #000000, 0 0 20px #1e1b4b; opacity: 1; }
            50% { text-shadow: 0 0 15px #ffffff, 0 0 30px #4338ca, 0 0 10px #000000; opacity: 0.9; }
        }
        .text-outer-void-style {
            /* Gradient: Đen Sâu - Xanh Đêm - Trắng Sao (Vũ Trụ) */
            background: linear-gradient(120deg, #020617, #1e1b4b, #ffffff, #1e1b4b, #020617);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.35rem !important;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;

            /* Căn chỉnh */
            line-height: 1.6;
            padding-bottom: 5px;
            display: inline-block;
            
            /* Animation: Trôi chậm rãi và bí ẩn */
            animation: text-gradient-animation 8s linear infinite, text-void-pulse-deep 6s ease-in-out infinite;
            
            filter: drop-shadow(0 0 8px rgba(30, 27, 75, 0.8));
        }

        /* [NEW] STYLE KHỞI NGUYÊN (TS 5000) */
        @keyframes text-genesis-shine {
            0% { background-position: 0% 50%; filter: brightness(100%) drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
            50% { background-position: 100% 50%; filter: brightness(130%) drop-shadow(0 0 15px rgba(253, 224, 71, 0.8)); }
            100% { background-position: 0% 50%; filter: brightness(100%) drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        }
        .text-genesis-style {
            /* Gradient: Bạch Kim - Vàng Ròng - Cầu Vồng Nhạt (Thần Thánh Tối Cao) */
            background: linear-gradient(120deg, #e2e8f0, #fef08a, #ffffff, #facc15, #bae6fd, #e2e8f0);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.4rem !important;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;

            /* Căn chỉnh */
            line-height: 1.6;
            padding-bottom: 5px;
            display: inline-block;
            
            /* Animation: Lấp lánh thần thánh */
            animation: text-gradient-animation 4s linear infinite, text-genesis-shine 3s ease-in-out infinite;
            
            /* Bóng đổ đa tầng */
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));
        }

        /* [NEW] STYLE VẠN CỔ (TS 7500) */
        @keyframes text-antiquity-flow {
            0% { background-position: 0% 50%; filter: sepia(0.5); }
            50% { background-position: 100% 50%; filter: sepia(0); text-shadow: 0 0 15px rgba(217, 119, 6, 0.8); }
            100% { background-position: 0% 50%; filter: sepia(0.5); }
        }
        .text-eternal-antiquity-style {
            /* Gradient: Đá Cổ - Vàng Cổ - Xanh Thời Gian */
            background: linear-gradient(120deg, #78716c, #f59e0b, #e0f2fe, #f59e0b, #78716c);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.45rem !important;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Trôi chậm rãi qua dòng thời gian */
            animation: text-gradient-animation 6s linear infinite, text-antiquity-flow 5s ease-in-out infinite;
            
            filter: drop-shadow(0 0 3px rgba(245, 158, 11, 0.6));
        }

        /* [MODIFIED] STYLE CHUNG CỰC (TS 10000) - FIX: SANG TRỌNG HƠN */
        @keyframes text-omega-shimmer {
            0% { 
                text-shadow: 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(76, 29, 149, 0.5); 
                filter: brightness(1); 
            }
            50% { 
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.6), 0 0 30px rgba(139, 92, 246, 0.8); 
                filter: brightness(1.3); 
            }
            100% { 
                text-shadow: 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(76, 29, 149, 0.5); 
                filter: brightness(1); 
            }
        }
        .text-omega-style {
            /* Gradient: Đen Vực Thẳm - Tím Hoàng Gia - Trắng Tinh - Đen */
            background: linear-gradient(120deg, #000000, #2e1065, #ffffff, #5b21b6, #000000);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.45rem !important; /* [MODIFIED] Size vừa phải */
            text-transform: uppercase;
            font-family: 'Noto Serif', serif; /* [MODIFIED] Font trang trọng */
            letter-spacing: 3px;
            
            /* Animation: Chảy màu huyền bí + Phát sáng */
            animation: text-gradient-animation 5s linear infinite, text-omega-shimmer 4s ease-in-out infinite;
            
            /* Drop shadow tạo chiều sâu */
            filter: drop-shadow(0 0 5px rgba(167, 139, 250, 0.4));
        }

        /* [NEW] STYLE HỖN ĐỘN VÔ THƯỢNG (TS 15000) */
        @keyframes text-supreme-flow {
            0% { background-position: 0% 50%; text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
            50% { background-position: 100% 50%; text-shadow: 0 0 20px rgba(239, 68, 68, 0.8), 0 0 10px rgba(0,0,0,1); }
            100% { background-position: 0% 50%; text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
        }
        .text-supreme-chaos-style {
            /* Gradient: Tím Vực Thẳm - Đỏ Máu - Đen - Bạch Kim */
            background: linear-gradient(to right, #2e1065, #7f1d1d, #000000, #e2e8f0, #000000, #7f1d1d, #2e1065);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.5rem !important;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif; /* Font trang trọng */
            letter-spacing: 3px;
            
            /* Animation: Chảy chậm, uy áp */
            animation: text-supreme-flow 6s infinite linear;
            
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.8));
        }

        /* [NEW] STYLE CHÂN NGÃ ĐỘC TÔN (TS 20000) */
        @keyframes text-true-self-pulse {
            0%, 100% { text-shadow: 0 0 10px #ffffff, 0 0 20px #818cf8; opacity: 1; transform: scale(1); }
            50% { text-shadow: 0 0 20px #ffffff, 0 0 40px #c084fc, 0 0 10px #818cf8; opacity: 0.9; transform: scale(1.02); }
        }
        .text-true-self-style {
            /* Gradient: Trắng Tinh - Tím Nhạt - Xanh Băng (Chân Ngã) */
            background: linear-gradient(to right, #ffffff, #e9d5ff, #cffafe, #ffffff);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.5rem !important;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Ánh sáng tinh khiết */
            animation: text-gradient-animation 5s linear infinite, text-true-self-pulse 3s ease-in-out infinite;
            
            filter: drop-shadow(0 0 6px rgba(192, 132, 252, 0.8));
        }

        /* [NEW] STYLE VẠN KIẾP LUÂN HỒI (TS 30000) */
        @keyframes text-samsara-flow {
            0% { background-position: 0% 50%; filter: sepia(0.2) hue-rotate(0deg); }
            50% { background-position: 100% 50%; filter: sepia(0.5) hue-rotate(-15deg); text-shadow: 0 0 20px rgba(220, 38, 38, 0.8); }
            100% { background-position: 0% 50%; filter: sepia(0.2) hue-rotate(0deg); }
        }
        .text-endless-samsara-style {
            /* Gradient: Vàng Cát (Thời Gian) - Đỏ Thẫm (Huyết) - Đen (Vực Thẳm) */
            background: linear-gradient(120deg, #d97706, #7f1d1d, #000000, #991b1b, #fbbf24, #d97706);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.55rem !important;
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Dòng chảy luân hồi */
            animation: text-gradient-animation 6s linear infinite, text-samsara-flow 5s ease-in-out infinite;
            
            filter: drop-shadow(0 0 5px rgba(180, 83, 9, 0.6));
        }

        /* [NEW] STYLE CHÂN KHÔNG (TS 50000) */
        @keyframes text-null-glitch {
            0% { text-shadow: 2px 2px #ff0000, -2px -2px #0000ff; opacity: 1; transform: skewX(0deg); }
            25% { text-shadow: -2px 2px #00ff00, 2px -2px #ff00ff; opacity: 0.8; transform: skewX(1deg); }
            50% { text-shadow: 2px -2px #ff0000, -2px 2px #0000ff; opacity: 1; transform: skewX(-1deg); }
            75% { text-shadow: -2px -2px #00ff00, 2px 2px #ff00ff; opacity: 0.8; transform: skewX(0deg); }
            100% { text-shadow: 2px 2px #ff0000, -2px -2px #0000ff; opacity: 1; transform: skewX(0deg); }
        }
        .text-absolute-null-style {
            /* Trắng Đen Nhiễu Loạn */
            color: #ffffff;
            font-weight: 900;
            font-size: 1.6rem !important;
            letter-spacing: 6px;
            text-transform: uppercase;
            font-family: 'Courier New', Courier, monospace; /* Font đơn giản, lạnh lùng */
            
            /* Animation: Glitch effect */
            animation: text-null-glitch 0.2s infinite steps(2);
            
            /* Viền trắng tạo khối */
            -webkit-text-stroke: 1px rgba(255,255,255,0.5);
            filter: contrast(1.5);
        }

        /* [NEW] STYLE VÔ TẬN CHI NGUYÊN (TS 100000) */
        @keyframes text-origin-flow {
            0% { background-position: 0% 50%; text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
            50% { background-position: 100% 50%; text-shadow: 0 0 20px rgba(165, 243, 252, 0.8), 0 0 40px rgba(253, 224, 71, 0.6); }
            100% { background-position: 0% 50%; text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
        }
        .text-endless-origin-style {
            /* Gradient: Cực Quang (Aurora) - Trắng, Cyan Nhạt, Vàng Nhạt, Hồng Phấn */
            background: linear-gradient(to right, #ffffff, #a5f3fc, #fef08a, #fce7f3, #ffffff);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.6rem !important;
            letter-spacing: 4px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Trôi nhẹ nhàng như dòng chảy năng lượng */
            animation: text-gradient-animation 6s linear infinite, text-origin-flow 4s ease-in-out infinite;
            
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.6));
        }

        /* [MODIFIED] STYLE VÔ CỰC CHÂN GIỚI (TS 250000) - FIX: BỎ CO GIÃN, SANG TRỌNG HƠN */
        @keyframes text-infinite-void-pulse {
            0% { 
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(79, 70, 229, 0.8); 
                filter: brightness(1); 
            }
            50% { 
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(129, 140, 248, 1); 
                filter: brightness(1.3); 
            }
            100% { 
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(79, 70, 229, 0.8); 
                filter: brightness(1); 
            }
        }
        .text-supreme-void-style {
            /* Gradient: Đen Vực Thẳm - Chàm Sáng - Trắng Tinh - Đen */
            background: linear-gradient(120deg, #000000, #4f46e5, #ffffff, #6366f1, #000000);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.6rem !important; /* Size vừa phải */
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            letter-spacing: 2px;
            
            /* Animation: Chảy màu mượt + Phát sáng */
            animation: text-gradient-animation 4s linear infinite, text-infinite-void-pulse 3s ease-in-out infinite;
            
            /* Drop shadow tạo chiều sâu */
            filter: drop-shadow(0 0 8px rgba(67, 56, 202, 0.6));
        }

        /* [NEW] STYLE THẦN THOẠI KỶ NGUYÊN (TS 500,000) */
        @keyframes text-mythical-shimmer {
            0% { background-position: 0% 50%; filter: brightness(100%); }
            50% { background-position: 100% 50%; filter: brightness(130%) drop-shadow(0 0 10px rgba(250, 204, 21, 0.6)); }
            100% { background-position: 0% 50%; filter: brightness(100%); }
        }
        .text-mythical-era-style {
            /* Gradient: Vàng Kim - Đỏ Thẫm - Tím Mộng Mơ (Thần Thoại) */
            background: linear-gradient(120deg, #facc15, #991b1b, #a855f7, #991b1b, #facc15);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.35rem !important; /* [MODIFIED] Giảm size để tránh mất dấu */
            letter-spacing: 3px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;

            /* [NEW] Fix lỗi hiển thị dấu tiếng Việt */
            line-height: 1.6;
            padding-bottom: 5px;
            display: inline-block;
            
            /* Animation: Lấp lánh huyền bí */
            animation: text-gradient-animation 5s linear infinite, text-mythical-shimmer 4s ease-in-out infinite;
            
            filter: drop-shadow(0 0 5px rgba(168, 85, 247, 0.5));
        }

        /* [NEW] STYLE CHÍ TÔN VÔ THƯỢNG (TS 1,000,000) */
        @keyframes text-supreme-god-pulse {
            0% { text-shadow: 0 0 10px #facc15, 0 0 20px #ef4444; filter: brightness(1); transform: scale(1); }
            50% { text-shadow: 0 0 30px #fde047, 0 0 60px #dc2626, 0 0 15px #ffffff; filter: brightness(1.3); transform: scale(1.02); }
            100% { text-shadow: 0 0 10px #facc15, 0 0 20px #ef4444; filter: brightness(1); transform: scale(1); }
        }
        .text-supreme-god-style {
            /* Gradient: Vàng Kim - Đỏ Thẫm - Bạch Kim (Chí Tôn) */
            background: linear-gradient(to bottom, #fef08a, #facc15, #b91c1c, #991b1b, #000000);
            background-size: 100% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            
            font-weight: 900;
            font-size: 1.4rem !important;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-family: 'Noto Serif', serif;
            
            /* Animation: Uy áp tuyệt đối */
            animation: text-gradient-animation 3s linear infinite, text-supreme-god-pulse 4s ease-in-out infinite;
            
            filter: drop-shadow(0 0 6px rgba(220, 38, 38, 0.6));
        }

    </style>
</head>
<body class="text-white"> <!-- [MODIFIED] Removed bg-gray-900 -->
    <!-- Hidden file input -->
    <input type="file" id="load-game-input" class="hidden" accept=".json" onchange="handleFileLoad(event)">

    <!-- Login Screen (NEW LANDING UI) -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center relative overflow-hidden" style="animation: bg-pan 30s infinite ease-in-out alternate;">
        <!-- Animated Background Overlay -->
        <div class="absolute inset-0 bg-black/30 z-0"></div>
        
        <!-- Decorative Gradients -->
        <div class="absolute top-0 left-0 w-full h-40 bg-gradient-to-b from-black/90 to-transparent z-10"></div>
        <div class="absolute bottom-0 left-0 w-full h-40 bg-gradient-to-t from-black/90 to-transparent z-10"></div>

        <!-- Main Login Card -->
        <div class="login-card relative z-20 p-8 md:p-12 rounded-3xl flex flex-col items-center w-full max-w-md mx-4">
            
            <!-- Title [MODIFIED: Further reduced size (text-2xl/3xl/4xl)] -->
            <h1 class="game-title-modern text-2xl sm:text-3xl md:text-4xl mb-6 text-center leading-tight whitespace-nowrap">Võ Lâm Luân Hồi</h1>

            <div class="flex items-center gap-3 mb-8 w-full justify-center">
                <div class="h-px bg-gradient-to-r from-transparent via-cyan-500 to-transparent w-12"></div>
                <p class="text-cyan-100 text-xs tracking-[0.3em] uppercase text-shadow-blue opacity-90 font-bold">Hồi Ức Giang Hồ</p>
                <div class="h-px bg-gradient-to-r from-transparent via-cyan-500 to-transparent w-12"></div>
            </div>
            
            <!-- Buttons Container -->
            <div class="w-full space-y-4">
                <!-- Nút Tiếp Tục (Ẩn/Hiện) -->
                <button id="btn-continue" onclick="continueGame()" class="btn-ice-soul hidden shadow-xl hover:shadow-cyan-500/30 transform hover:-translate-y-1 transition-all duration-300 rounded-xl">
                    <span class="flex items-center justify-center gap-3">
                        <i class="fa-solid fa-play text-xl"></i> Tiếp Tục Hành Trình
                    </span>
                </button>

                <!-- Nút Chơi Mới -->
                <button onclick="startNewGame()" class="btn-ice-soul shadow-xl hover:shadow-cyan-500/30 transform hover:-translate-y-1 transition-all duration-300 rounded-xl">
                    <span class="ice-shard" style="top: 10%; left: 90%; width: 2px; height: 2px;"></span>
                    <span class="ice-shard" style="bottom: 20%; left: 5%; width: 3px; height: 3px; animation-delay: 1s;"></span>
                    <span class="flex items-center justify-center gap-3">
                        <i class="fa-solid fa-snowflake text-xl"></i> Bắt Đầu Chơi Mới
                    </span>
                </button>
                
                <!-- Grid Buttons -->
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <button onclick="document.getElementById('load-game-input').click()" class="bg-gray-800/60 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600 hover:border-cyan-500/50 font-bold py-3 rounded-xl backdrop-blur-sm transition flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-cloud-arrow-up group-hover:-translate-y-0.5 transition"></i> Tải Save
                    </button>
                    <button onclick="showModal('instructions-modal')" class="bg-gray-800/60 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600 hover:border-cyan-500/50 font-bold py-3 rounded-xl backdrop-blur-sm transition flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-scroll group-hover:-translate-y-0.5 transition"></i> Bí Kíp
                    </button>
                    <button onclick="showModal('changelog-modal')" class="bg-gray-800/60 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600 hover:border-cyan-500/50 font-bold py-3 rounded-xl backdrop-blur-sm transition flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-dragon group-hover:-translate-y-0.5 transition"></i> Cập Nhật
                    </button>
                    <button onclick="showModal('about-modal')" class="bg-gray-800/60 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600 hover:border-cyan-500/50 font-bold py-3 rounded-xl backdrop-blur-sm transition flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-circle-info group-hover:-translate-y-0.5 transition"></i> Thông Tin
                    </button>
                </div>
            </div>
            
            <!-- Footer Info -->
            <div class="mt-8 pt-4 border-t border-white/10 w-full text-center">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-mono">Version 2.1.0 &bull; Developed by HuyHuyy</p>
            </div>
        </div>

        <!-- Footer Decoration Text -->
        <div class="absolute bottom-6 text-[10px] text-gray-500 z-20 animate-pulse">
            Chạm vào màn hình để cảm nhận khí tức...
        </div>
    </div>

    <!-- Main Game Screen -->
    <!-- [MODIFIED] Added min-h-screen to match the login screen's feel -->
    <div id="main-screen" class="hidden min-h-screen p-4 max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Panel: Player Info -->
            <!-- [MODIFIED] Changed bg-gray-800 to bg-black/30 backdrop-blur-sm and added border -->
            <div class="lg:col-span-1 bg-black/30 backdrop-blur-sm p-4 sm:p-6 rounded-lg shadow-xl border border-gray-700 h-fit">
                
                <!-- [MOVED] Phần Tài Phú đã được chuyển sang cột phải -->

                <!-- Character Info -->
                <!-- [MODIFIED] Added ID 'player-title-display' -->
                <h3 id="player-title-display" class="text-xl font-semibold mb-3 text-cyan-400 text-center">Luân Hồi Giả</h3>
                <div id="equipped-character" class="bg-gray-700 p-4 rounded-lg mb-2">
                    <!-- This will be filled by JS -->
                </div>
                
                <!-- [MODIFIED] HP/Mana/HonLuc/XP Bars with Brighter Colors & Glow Effects -->
                
                 <div class="mb-2">
                    <div class="flex justify-between text-sm mb-1 font-bold text-red-300" style="text-shadow: 0 0 5px rgba(248, 113, 113, 0.5);">
                        <span><i class="fa-solid fa-heart mr-1"></i>Sinh Lực (HP)</span>
                        <span id="hp-display" class="font-mono">100 / 100</span>
                    </div>
                    <!-- [FIX] Thêm overflow-hidden để cắt phần thừa nếu thanh quá dài -->
                    <div class="w-full bg-gray-800/80 rounded-full h-3 border border-gray-600 shadow-inner overflow-hidden">
                        <div id="hp-bar" class="bg-gradient-to-r from-red-700 via-red-500 to-red-400 h-full rounded-full transition-all duration-300 shadow-[0_0_8px_rgba(239,68,68,0.6)] relative" style="width: 100%">
                            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/20 to-transparent rounded-full"></div>
                        </div>
                    </div>
                </div>
                
                 <div class="mb-2">
                    <div class="flex justify-between text-sm mb-1 font-bold text-blue-300" style="text-shadow: 0 0 5px rgba(96, 165, 250, 0.5);">
                        <span><i class="fa-solid fa-flask mr-1"></i>Nội Lực (Mana)</span>
                        <span id="mana-display" class="font-mono">50 / 50</span>
                    </div>
                    <!-- [FIX] Thêm overflow-hidden -->
                    <div class="w-full bg-gray-800/80 rounded-full h-3 border border-gray-600 shadow-inner overflow-hidden">
                        <div id="mana-bar" class="bg-gradient-to-r from-blue-700 via-blue-500 to-blue-400 h-full rounded-full transition-all duration-300 shadow-[0_0_8px_rgba(59,130,246,0.6)] relative" style="width: 100%">
                             <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/20 to-transparent rounded-full"></div>
                        </div>
                    </div>
                </div>
                
                <!-- [NEW] Hon Luc (Soul Power) Bar -->
                <div class="mb-2">
                    <div class="flex justify-between text-sm mb-1 font-bold text-purple-300" style="text-shadow: 0 0 5px rgba(192, 132, 252, 0.5);">
                        <span><i class="fa-solid fa-ghost mr-1"></i>Hồn Lực (HL)</span>
                        <span id="honluc-display" class="font-mono">100 / 100</span>
                    </div>
                    <!-- [FIX] Thêm overflow-hidden -->
                    <div class="w-full bg-gray-800/80 rounded-full h-3 border border-gray-600 shadow-inner overflow-hidden">
                        <div id="honluc-bar" class="bg-gradient-to-r from-purple-700 via-purple-500 to-purple-400 h-full rounded-full transition-all duration-300 shadow-[0_0_8px_rgba(168,85,247,0.6)] relative" style="width: 100%">
                             <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/20 to-transparent rounded-full"></div>
                        </div>
                    </div>
                </div>
                
                <!-- XP Bar -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1 font-bold text-green-300" style="text-shadow: 0 0 5px rgba(74, 222, 128, 0.5);">
                        <span><i class="fa-solid fa-arrow-up-right-dots mr-1"></i>Kinh Nghiệm</span>
                        <span id="xp-display" class="font-mono">0 / 100</span>
                    </div>
                    <!-- [FIX] Thêm overflow-hidden -->
                    <div class="w-full bg-gray-800/80 rounded-full h-3 border border-gray-600 shadow-inner overflow-hidden">
                        <div id="xp-bar" class="bg-gradient-to-r from-green-700 via-green-500 to-green-400 h-full rounded-full transition-all duration-300 shadow-[0_0_8px_rgba(34,197,94,0.6)] relative" style="width: 0%">
                             <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/20 to-transparent rounded-full"></div>
                        </div>
                    </div>
                </div>
                
                <!-- [NEW] Rebirth Button -->
                <div class="mt-4 mb-2">
                     <button id="rebirth-btn" onclick="confirmRebirth()" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        Trùng Sinh (Cần Cấp 200)
                    </button>
                </div>
                
                <!-- [MOVED] Phần Trang Bị đã được chuyển sang cột phải -->
                
                <!-- [MODIFIED] Căn giữa tiêu đề Thuộc Tính Tổng -->
                <h3 class="text-xl font-semibold mb-3 mt-6 text-green-400 text-center">Thuộc Tính Tổng</h3>
                <div id="total-stats" class="bg-gray-700 p-4 rounded-lg grid grid-cols-2 gap-x-4 gap-y-2 text-sm"></div>
            </div>

            <!-- Right Panel: Actions (UI OVERHAUL) -->
            <!-- [MODIFIED] Changed bg-gray-800 to bg-black/30 backdrop-blur-sm and added border -->
            <div class="lg:col-span-2 bg-black/30 backdrop-blur-sm p-4 sm:p-6 rounded-lg shadow-xl flex flex-col border border-gray-700">
                
                <!-- Top Section: Combat & Status -->
                <div class="flex-grow">
                    <!-- [MODIFIED] Added .title-huyet-chien class for animation -->
                    <h2 class="text-2xl font-bold mb-4 text-yellow-400 text-center title-huyet-chien">Võ Lâm Truyền Kỳ - Hồi Ức Giang Hồ</h2>

                    <!-- [MOVED] Bottom Section: Navigation Tabs -->
                    <div class="w-full max-w-lg mx-auto mb-6 pb-4 border-b border-gray-700"> <!-- [MODIFIED] Removed mt-6/pt-4/border-t, added mb-6/pb-4/border-b -->
                        <!-- [MODIFIED] Grid layout changed for better uniformity -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-2"> <!-- [MODIFIED] Changed grid to fit 11-12 items -->
                            <button onclick="showModal('skills-modal')" class="btn-vo-hiep btn-vo-hiep-grid skills">Kỹ Năng</button>
                            <button onclick="showModal('equipment-modal')" class="btn-vo-hiep btn-vo-hiep-grid equip">Hành Trang</button>
                            <button onclick="showModal('tho-ren-modal')" class="btn-vo-hiep btn-vo-hiep-grid smith">Thợ Rèn</button>
                            <!-- [MODIFIED] Thêm ID cho nút Tông Môn để xử lý khóa -->
                            <button id="btn-open-sect" onclick="showModal('tong-mon-modal')" class="btn-vo-hiep btn-vo-hiep-grid sect">Tông Môn</button>
                            <!-- [NEW] Mon Phai Button (Re-added) -->
                            <button onclick="showModal('mon-phai-modal')" class="btn-vo-hiep btn-vo-hiep-grid class">Môn Phái</button>
                            <!-- [MODIFIED] Nút Sủng Vật (Thêm ID để xử lý khóa) -->
                            <button id="btn-open-pet" onclick="showModal('sung-vat-modal')" class="btn-vo-hiep btn-vo-hiep-grid pet">Sủng Vật</button>
                            
                            <!-- [NEW] Nút Mệnh Cách (Thêm ID để xử lý khóa) -->
                            <button id="btn-open-menh-cach" onclick="showModal('menh-cach-modal')" class="btn-vo-hiep btn-vo-hiep-grid destiny">Mệnh Cách</button>
                            
                            <button onclick="showModal('dungeons-modal')" class="btn-vo-hiep btn-vo-hiep-grid train">Luyện Công</button>
                            <button onclick="showModal('world-map-modal')" class="btn-vo-hiep btn-vo-hiep-grid map">Bản Đồ</button> <!-- [NEW] -->
                            <!-- [NEW] Vong Quay Button -->
                            <button onclick="showModal('vong-quay-modal')" class="btn-vo-hiep btn-vo-hiep-grid wheel">Vòng Quay</button>
                            <button onclick="showModal('tien-trang-modal')" class="btn-vo-hiep btn-vo-hiep-grid shop">Tiền Trang</button>
                            <!-- [NEW] Khe Nut Thoi Khong Button -->
                            <button onclick="showModal('khe-nut-thoi-khong-modal')" class="btn-vo-hiep btn-vo-hiep-special">游行者</button>
                        </div>
                        <!-- [NEW] Hàng nút thứ 2 cho Lưu Game và các chức năng khác -->
                        <div class="grid grid-cols-2 gap-2 mt-2">
                             <button onclick="saveGame()" class="btn-vo-hiep btn-vo-hiep-save">Lưu Game</button>
                             <button onclick="showModal('changelog-modal')" class="btn-vo-hiep btn-vo-hiep-changelog">Chân Long Giáng Thế</button>
                        </div>
                    </div>

                    <!-- Combat Display Panel -->
                    <!-- [MODIFIED] Đã xóa 'max-w-xl' và 'mx-auto' để khung rộng ra tối đa -->
                    <div id="combat-display-panel" class="hidden w-full">
                        <!-- [NEW] Animation Overlay -->
                        <div id="combat-animation-overlay"></div>
                        <div class="flex justify-between items-start">
                            <!-- Player -->
                            <div class="combatant">
                                <!-- [MODIFIED] Thêm class 'text-rainbow-animation' và xóa 'text-blue-400' -->
                                <i class="fa-brands fa-d-and-d text-rainbow-animation"></i>
                                <!-- [MODIFIED] Đổi tên hiển thị mặc định -->
                                <p class="font-bold text-lg text-rainbow-animation">Vạn Sinh Chủ</p>
                                <p class="text-sm">Cấp <span id="combat-player-level">1</span></p>
                                <div class="health-bar-container">
                                    <div id="combat-player-hp-bar" class="health-bar health-bar-player" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <span class="combat-vs">VS</span>
                            
                            <!-- Enemy -->
                            <div class="combatant">
                                <i id="combat-enemy-icon" class="fa-solid fa-skull-crossbones text-red-400"></i>
                                <p id="combat-enemy-name" class="font-bold text-lg text-red-300">...</p>
                                <p id="combat-enemy-level" class="text-sm">Cấp ?</p>
                                <div class="health-bar-container">
                                    <div id="combat-enemy-hp-bar" class="health-bar health-bar-enemy" style="width: 100%"></div>
                                </div>
                                <div id="combat-enemy-stats">
                                    <!-- Stats injected by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- [MODIFIED] Training Status Panel (Taller Log UI) -->
                    <div id="training-status-panel" class="hidden w-full mt-4 bg-black/30 backdrop-blur-md border border-gray-600 rounded-xl shadow-xl flex flex-col overflow-hidden">
                        <!-- Header nhỏ gọn -->
                        <div class="bg-gray-800/80 p-2 px-4 flex justify-between items-center border-b border-gray-600">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-scroll text-yellow-500"></i>
                                <!-- [MODIFIED] Removed 'uppercase' class -->
                                <h3 class="text-sm font-bold text-gray-200 tracking-wider">Giang Hồ Sử Ký</h3>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <div class="text-xs text-gray-400 bg-black/40 px-2 py-1 rounded border border-gray-700 flex items-center gap-1">
                                    <i class="fa-solid fa-map-location-dot text-cyan-500"></i>
                                    <span id="training-map-name" class="font-bold text-cyan-100"></span>
                                </div>
                                <button onclick="stopTraining()" class="bg-red-900/80 hover:bg-red-700 text-red-100 text-xs font-bold py-1 px-3 rounded border border-red-500/50 transition shadow-sm flex items-center gap-1">
                                    <i class="fa-solid fa-power-off"></i> Dừng
                                </button>
                            </div>
                        </div>
                        
                        <!-- Log Content (Cao hơn) -->
                        <div id="training-log" class="scrollbar-thin w-full">
                            <!-- Training log messages will appear here -->
                        </div>
                    </div>

                    <!-- [NEW LOCATION] KHU VỰC THÔNG TIN (Được chuyển từ bên trái sang) -->
                    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- [MOVED] Cột 1: Tài Phú -->
                        <div class="bg-black/20 backdrop-blur-sm p-4 rounded-lg border border-gray-700">
                            <h2 class="text-xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 uppercase tracking-wider border-b border-gray-700 pb-2 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-sack-dollar text-yellow-500"></i> Tài Phú
                            </h2>
                            <div class="grid grid-cols-2 gap-2">
                                <!-- Kim Nguyên Bảo -->
                                <div class="bg-gray-900/60 border border-yellow-500/30 rounded-lg p-2 relative overflow-hidden group hover:border-yellow-500/60 transition shadow-md">
                                    <div class="absolute -right-2 -top-2 text-yellow-500/10 text-4xl group-hover:text-yellow-500/20 transition pointer-events-none"><i class="fa-solid fa-gem"></i></div>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Kim Nguyên Bảo</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        <i class="fa-solid fa-gem text-yellow-400 text-xs"></i>
                                        <span id="knb-display" class="font-bold text-yellow-300 text-sm">0</span>
                                    </div>
                                </div>

                                <!-- Ngân Lượng -->
                                <div class="bg-gray-900/60 border border-gray-500/30 rounded-lg p-2 relative overflow-hidden group hover:border-gray-400/60 transition shadow-md">
                                    <div class="absolute -right-2 -top-2 text-gray-500/10 text-4xl group-hover:text-gray-500/20 transition pointer-events-none"><i class="fa-solid fa-coins"></i></div>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Ngân Lượng</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        <i class="fa-solid fa-coins text-gray-300 text-xs"></i>
                                        <span id="nganluong-display" class="font-bold text-gray-200 text-sm">0</span>
                                    </div>
                                </div>

                                <!-- Linh Khí -->
                                <div class="bg-gray-900/60 border border-purple-500/30 rounded-lg p-2 relative overflow-hidden group hover:border-purple-500/60 transition shadow-md">
                                    <div class="absolute -right-2 -top-2 text-purple-500/10 text-4xl group-hover:text-purple-500/20 transition pointer-events-none"><i class="fa-solid fa-wind"></i></div>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Linh Khí</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        <i class="fa-solid fa-wind text-purple-400 text-xs"></i>
                                        <span id="linhkhi-display" class="font-bold text-purple-300 text-sm">0</span>
                                    </div>
                                </div>

                                <!-- Linh Thạch -->
                                <div class="bg-gray-900/60 border border-green-500/30 rounded-lg p-2 relative overflow-hidden group hover:border-green-500/60 transition shadow-md">
                                    <div class="absolute -right-2 -top-2 text-green-500/10 text-4xl group-hover:text-green-500/20 transition pointer-events-none"><i class="fa-solid fa-cubes"></i></div>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Linh Thạch</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        <i class="fa-solid fa-cubes text-green-400 text-xs"></i>
                                        <span id="linhthach-display" class="font-bold text-green-300 text-sm">0</span>
                                    </div>
                                </div>

                                <!-- Tu Vi -->
                                <div class="bg-gray-900/60 border border-violet-500/30 rounded-lg p-2 relative overflow-hidden group hover:border-violet-500/60 transition shadow-md">
                                    <div class="absolute -right-2 -top-2 text-violet-500/10 text-4xl group-hover:text-violet-500/20 transition pointer-events-none"><i class="fa-solid fa-fire"></i></div>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Tu Vi</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        <i class="fa-solid fa-fire text-violet-400 text-xs"></i>
                                        <span id="tuvi-display" class="font-bold text-violet-300 text-sm">0</span>
                                    </div>
                                </div>

                                <!-- Linh Hồn Thạch -->
                                <div class="bg-gray-900/60 border border-cyan-500/30 rounded-lg p-2 relative overflow-hidden group hover:border-cyan-500/60 transition shadow-md">
                                    <div class="absolute -right-2 -top-2 text-cyan-500/10 text-4xl group-hover:text-cyan-500/20 transition pointer-events-none"><i class="fa-solid fa-ghost"></i></div>
                                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Linh Hồn Thạch</p>
                                    <div class="flex items-center gap-1 mt-0.5">
                                        <i class="fa-solid fa-ghost text-cyan-400 text-xs"></i>
                                        <span id="linhhonthach-display" class="font-bold text-cyan-300 text-sm">0</span>
                                    </div>
                                </div>
                                
                                <!-- Chân Khí (Full width) -->
                                <div class="col-span-2 bg-gray-900/60 border border-blue-500/30 rounded-lg p-2 relative overflow-hidden group hover:border-blue-500/60 transition shadow-md flex justify-between items-center px-3">
                                    <div class="absolute -right-2 -top-2 text-blue-500/10 text-4xl group-hover:text-blue-500/20 transition pointer-events-none"><i class="fa-solid fa-cloud"></i></div>
                                    <div class="flex items-center gap-2">
                                         <i class="fa-solid fa-cloud text-blue-400 text-xs"></i>
                                         <span class="text-[10px] text-gray-400 uppercase tracking-wide">Chân Khí</span>
                                    </div>
                                    <span id="chankhi-display" class="font-bold text-blue-200 text-sm">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- [MOVED] Cột 2: Trang Bị -->
                        <div class="bg-black/20 backdrop-blur-sm p-4 rounded-lg border border-gray-700">
                            <!-- [MODIFIED] Căn giữa tiêu đề Trang Bị -->
                            <h3 class="text-xl font-semibold mb-4 text-cyan-400 text-center border-b border-gray-700 pb-2">Trang Bị</h3>
                            <div id="equipped-equipment" class="bg-gray-700/50 p-2 rounded-lg grid grid-cols-1 sm:grid-cols-2 gap-2 h-fit">
                                <!-- This will be filled by JS -->
                            </div>
                        </div>
                    </div>
                    <!-- [END MOVED] -->

                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals Container -->
    <div id="modals">
        <!-- [NEW] Ky Ngo Modal (Empty Frame) -->
        <div id="ky-ngo-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-indigo-500 flex flex-col min-h-[300px]">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700 flex justify-between items-center bg-gray-900/50 rounded-t-lg">
                    <h3 class="text-xl font-bold text-indigo-400">Kỳ Ngộ Giang Hồ</h3>
                    <button onclick="hideModal('ky-ngo-modal')" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <!-- Content (Empty) -->
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow flex items-center justify-center text-gray-500 italic bg-black/20">
                    (Nội dung trống)
                </div>
                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right border-t border-gray-700">
                    <button onclick="hideModal('ky-ngo-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Menh Cach Modal (Placeholder) -->
        <div id="menh-cach-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <!-- [MODIFIED] Removed bg-gray-800, changed max-w-3xl to max-w-7xl -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-7xl modal border border-teal-600 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Mệnh Cách</h3>
                </div>

                <!-- [NEW] Tab Headers -->
                <div class="flex border-b border-gray-700 bg-gray-900">
                    <button id="tab-menh-ban" onclick="switchMenhCachTab('menh-ban')" class="flex-1 py-3 px-4 font-bold text-center tab-btn tab-active">Mệnh Bàn</button>
                    <button id="tab-chieu-menh" onclick="switchMenhCachTab('chieu-menh')" class="flex-1 py-3 px-4 font-bold text-center text-gray-400 tab-btn">Liệp Mệnh</button>
                </div>

                <!-- [MODIFIED] Content -->
                <!-- Tab Content: Mệnh Bàn -->
                <div id="panel-menh-ban" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel" style="min-height: 300px;">
                    <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Mệnh Bàn</h4>
                    <!-- [MODIFIED] Thêm ID để cập nhật số ô đã mở -->
                    <p id="menh-ban-slot-count" class="text-center text-gray-400 mb-4 text-sm">Trang bị Mệnh Cách để nhận chỉ số cộng thêm. (Đã mở 10/10 ô)</p>
                    <!-- [MODIFIED] Added glass effect -->
                    <div class="max-w-md mx-auto p-4 bg-black/20 backdrop-blur-sm border border-gray-600 rounded-lg">
                        <!-- [MODIFIED] Changed ID and content -->
                        <div id="menh-cach-equipped-slots" class="grid grid-cols-5 gap-3">
                            <!-- 10 ô trang bị sẽ được render bởi JS -->
                            <div class="menh-cach-slot border-dashed border-gray-600"><i class="fa-solid fa-plus text-gray-600"></i></div>
                            <div class="menh-cach-slot"><i class="fa-solid fa-lock text-gray-600"></i></div>
                            <div class="menh-cach-slot">
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                            <div class="menh-cach-slot">
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                            <div class="menh-cach-slot">
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                            <div class="menh-cach-slot">
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                            <div class="menh-cach-slot">
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                            <div class="menh-cach-slot">
                                <i class="fa-solid fa-lock text-gray-600"></i>
                            </div>
                            <div class="menh-cach-slot"><i class="fa-solid fa-lock text-gray-600"></i></div>
                            <div class="menh-cach-slot"><i class="fa-solid fa-lock text-gray-600"></i></div>
                        </div>
                    </div>

                    <!-- [NEW] Kho Mệnh Cách -->
                    <h4 class="text-lg font-bold text-cyan-400 mt-6 mb-4 text-center">Kho Mệnh Cách</h4>
                    <!-- [MODIFIED] Added glass effect -->
                    <div id="menh-cach-inventory-list" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-3 bg-black/20 backdrop-blur-sm border border-gray-600 p-3 rounded-lg" style="min-height: 200px;">
                        <!-- Inventory items rendered by JS -->
                        <p class="text-gray-500 text-center col-span-full">Kho Mệnh Cách trống.</p>
                    </div>
                </div>
                
                <!-- Tab Content: Liệp Mệnh -->
                <div id="panel-chieu-menh" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden" style="min-height: 300px;">
                    <!-- [MODIFIED] Added glass effect -->
                    <div class="text-center mb-4 bg-black/20 backdrop-blur-sm border border-gray-600 p-3 rounded-lg">
                        <p class="text-lg">Số Linh Hồn Thạch: 
                            <span id="chieu-menh-lht-display" class="font-bold text-xl text-yellow-400">0</span>
                            <i class="fa-solid fa-gem text-yellow-400"></i>
                        </p>
                    </div>

                    <!-- Summoning Options -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Trương Ma Tử -->
                        <!-- [MODIFIED] Added glass effect -->
                        <div class="bg-black/20 backdrop-blur-sm border border-blue-500 p-4 rounded-lg text-center">
                            <i class="fa-solid fa-user-graduate text-4xl text-blue-400 mb-3"></i>
                            <h5 class="font-bold text-lg text-blue-300">Trương Ma Tử</h5>
                            <p class="text-xs text-gray-400 mb-3">Cần Cấp 20. Có tỷ lệ ra Mệnh Tím.</p>
                            <button id="summon-btn-1" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-sm mb-2" onclick="performSummon('pool_1', 1)">
                                Chiêu Mộ (100 LHT)
                            </button>
                            <button id="summon-btn-10" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-3 rounded text-sm" onclick="performSummon('pool_1', 10)">
                                Chiêu Mộ x10 (1000 LHT)
                            </button>
                        </div>
                        
                        <!-- Trương Đạo Lăng -->
                        <!-- [MODIFIED] Added glass effect -->
                        <div class="bg-black/20 backdrop-blur-sm border border-purple-500 p-4 rounded-lg text-center">
                            <i class="fa-solid fa-user-tie text-4xl text-purple-400 mb-3"></i>
                            <h5 class="font-bold text-lg text-purple-300">Trương Đạo Lăng</h5>
                            <p class="text-xs text-gray-400 mb-3">Cần Cấp 40. Có tỷ lệ ra Mệnh Vàng.</p>
                            <button id="summon-btn-2" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded text-sm mb-2" onclick="performSummon('pool_2', 1)">
                                Chiêu Mộ (1,000 LHT)
                            </button>
                            <button id="summon-btn-20" class="w-full bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-3 rounded text-sm" onclick="performSummon('pool_2', 10)">
                                Chiêu Mộ x10 (10,000 LHT)
                            </button>
                        </div>

                        <!-- Tả Từ -->
                        <!-- [MODIFIED] Added glass effect -->
                        <div class="bg-black/20 backdrop-blur-sm border border-yellow-500 p-4 rounded-lg text-center">
                            <i class="fa-solid fa-user-astronaut text-4xl text-yellow-400 mb-3"></i>
                            <h5 class="font-bold text-lg text-yellow-300">Tả Từ</h5>
                            <p class="text-xs text-gray-400 mb-3">Cần Cấp 60. Có tỷ lệ ra Mệnh Cam.</p>
                            <button id="summon-btn-3" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded text-sm mb-2" onclick="performSummon('pool_3', 1)">
                                Chiêu Mộ (10,000 LHT)
                            </button>
                            <button id="summon-btn-30" class="w-full bg-yellow-700 hover:bg-yellow-800 text-white font-bold py-2 px-3 rounded text-sm" onclick="performSummon('pool_3', 10)">
                                Chiêu Mộ x10 (100,000 LHT)
                            </button>
                        </div>
                    </div>

                    <!-- Results Panel -->
                    <!-- [MODIFIED] Added glass effect -->
                    <div class="bg-black/20 backdrop-blur-sm border border-gray-600 p-3 rounded-lg" style="min-height: 150px;">
                        <h5 class="font-bold text-cyan-400 text-center mb-2">Kết Quả Chiêu Mộ Gần Nhất</h5>
                        <div id="summon-results-panel" class="grid grid-cols-5 sm:grid-cols-10 gap-2 text-center">
                            <!-- Results will be injected here -->
                            <p class="text-gray-500 col-span-full">Chưa có kết quả.</p>
                        </div>
                    </div>
                    
                    <!-- [NEW] Summon History Log (Styled like training-log) -->
                    <h5 class="font-bold text-cyan-400 text-center mt-4 mb-2">Lịch Sử Chiêu Mộ</h5>
                    <!-- [MODIFIED] Added glass effect -->
                    <div id="summon-history-log" class="scrollbar-thin bg-black/20 backdrop-blur-sm border border-gray-600" style="font-family: 'Courier New', Courier, monospace; font-size: 0.8rem; line-height: 1.4; border-radius: 0.5rem; padding: 8px; height: 150px; overflow-y: scroll; color: #e2e8f0;">
                        <p class="log-info text-center">Chưa có lịch sử.</p>
                    </div>

                    <!-- Quick Sell Button -->
                    <div class="text-center mt-4">
                        <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" onclick="sellAllHungMenh()">
                            Bán Toàn Bộ Hung Mệnh
                        </button>
                    </div>
                </div>
                <!-- [END MODIFIED] -->

                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('menh-cach-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Vong Quay (Lucky Wheel) Modal (FIX: Re-added missing modal) -->
        <div id="vong-quay-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-md modal border border-pink-600 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400 text-center">Vòng Quay May Mắn</h3>
                </div>
                <!-- Content -->
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow flex flex-col items-center" style="min-height: 450px;">
                    
                    <!-- 3x3 Grid Container -->
                    <div id="vong-quay-grid" class="lucky-grid-container">
                        <!-- JS will inject cells here -->
                    </div>
                    
                    <!-- Result display -->
                    <div id="vong-quay-result" class="text-center text-lg font-bold text-yellow-300 mt-2 h-8"></div>
                    
                    <!-- Ticket count -->
                    <p class="text-center text-gray-300 mt-2">Số Lượt Quay: <span id="vong-quay-tickets" class="font-bold text-xl text-yellow-400">0</span></p>
                    
                    <!-- 10x Spin Button (Optional separate button) -->
                    <div class="w-full mt-4">
                         <button id="vong-quay-spin-10-btn" onclick="spinWheel(10)" class="w-full bg-purple-700 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 border border-purple-500 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-forward"></i> Quay Nhanh 10 Lần
                        </button>
                    </div>
                </div>
                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('vong-quay-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Khe Nut Thoi Khong Modal -->
        <div id="khe-nut-thoi-khong-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-3xl modal border border-purple-500 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-purple-400">Khe Nứt Thời Không</h3>
                </div>
                
                <!-- Content -->
                <div id="khe-nut-list" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow" style="max-height: 70vh;">
                    <!-- [MODIFIED] Removed placeholder, added map entry -->
                    <div class="bg-gray-700 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-gray-600 transition duration-200">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-yellow-300">
                                <i class="fa-solid fa-book-open mr-2"></i>Đấu La Đại Lục
                            </h4>
                            <p class="text-sm text-gray-300 mt-1">Một thế giới nơi Võ Hồn là tất cả. (Hệ thống: Chiến đấu theo lượt)</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 1+</p>
                        </div>
                        <button onclick="showModal('dauladailuc-modal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0">
                            Tiến vào
                        </button>
                    </div>
                    <!-- More worlds will be added here -->
                </div>

                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('khe-nut-thoi-khong-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Dau La Dai Luc - World Hub Modal -->
        <div id="dauladailuc-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[55]"> <!-- z-index 55 -->
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl modal border border-cyan-500 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-cyan-400">Đấu La Đại Lục</h3>
                </div>
                
                <!-- Content -->
                <div id="dauladailuc-map-list" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow" style="max-height: 70vh;">
                    <p class="text-sm text-gray-400 mb-4">Chọn một khu vực để bắt đầu thám hiểm. (Luyện công tự động sẽ bị dừng lại)</p>
                    
                    <!-- Map List -->
                    <!-- [MODIFIED] ID added, content is now dynamic -->
                    <div id="dll-map-list-container" class="space-y-3">
                        <!-- Content rendered by renderDauLaDaiLucModal() -->
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('dauladailuc-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Rời khỏi</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Tu Chan Gioi - World Hub Modal (Copy from Dau La Dai Luc) -->
        <div id="tuchangioi-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[55]"> <!-- z-index 55 -->
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl modal border border-green-500 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-green-400">Tu Chân Giới</h3>
                </div>
                
                <!-- Content -->
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow" style="max-height: 70vh;">
                    <p class="text-sm text-gray-400 mb-4">Chọn một khu vực để bắt đầu tu luyện. (Luyện công tự động sẽ bị dừng lại)</p>
                    
                    <!-- Map List -->
                    <div id="tcg-map-list-container" class="space-y-3">
                        <!-- Content rendered by renderTuChanGioiModal() -->
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('tuchangioi-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Rời khỏi</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Kiem The Gioi - World Hub Modal -->
        <div id="kiemthe-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[55]"> <!-- z-index 55 -->
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl modal border border-yellow-500 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Kiếm Thế Giới</h3>
                </div>
                
                <!-- Content -->
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow" style="max-height: 70vh;">
                    <p class="text-sm text-gray-400 mb-4">Chọn chiến trường để tham gia. (Luyện công tự động sẽ bị dừng lại)</p>
                    
                    <!-- Map List -->
                    <div id="ktg-map-list-container" class="space-y-3">
                        <!-- Content rendered by renderKiemTheModal() -->
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('kiemthe-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Rời khỏi</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Turn Based Combat Modal -->
        <div id="turn-based-combat-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]"> <!-- z-index 60, cao nhất -->
            <!-- [MODIFIED] Xóa bg-gray-900 để CSS có thể áp dụng ảnh nền -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-4xl modal border border-red-500 flex flex-col" style="height: 90vh;">
                <!-- Header -->
                <div class="p-4 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-red-400">CHIẾN ĐẤU THEO LƯỢT</h3>
                </div>
                
                <!-- Main Combat Area -->
                <div class="flex-grow p-4 grid grid-cols-1 md:grid-cols-3 gap-4 overflow-hidden" style="min-height: 0;">
                    
                    <!-- 1. Player Panel -->
                    <!-- [MODIFIED] Đổi bg-black/30 -> bg-black/15 -->
                    <div class="bg-black/15 border border-gray-700 p-4 rounded-lg flex flex-col overflow-y-auto scrollbar-thin">
                        <div>
                            <!-- [MODIFIED] Đổi tên hiển thị mặc định trong Modal chiến đấu -->
                            <h4 id="tb-player-name" class="text-2xl font-bold text-blue-400">Vạn Sinh Chủ</h4>
                            <p id="tb-player-level" class="text-sm text-yellow-400 mb-4">Cấp 1</p>
                            
                            <!-- HP Bar -->
                            <div class="mb-2">
                                <div class="flex justify-between text-sm mb-1 text-gray-300">
                                    <span>Sinh Lực (HP)</span>
                                    <span id="tb-player-hp">100 / 100</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-4">
                                    <div id="tb-player-hp-bar" class="bg-red-600 h-4 rounded-full transition-all duration-300" style="width: 100%"></div>
                                </div>
                            </div>
                            <!-- Hon Luc Bar -->
                            <div class="mb-2">
                                <div class="flex justify-between text-sm mb-1 text-gray-300">
                                    <span>Hồn Lực (HL)</span>
                                    <span id="tb-player-honluc">100 / 100</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-4">
                                    <div id="tb-player-honluc-bar" class="bg-purple-500 h-4 rounded-full transition-all duration-300" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <!-- [NEW] Player Stats -->
            <div id="tb-player-stats" class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm mt-4 bg-gray-700 p-2 rounded">
                <!-- Stats injected by JS -->
            </div>

            <!-- [NEW] Companion (Disciple/Pet) Combat Panel -->
            <div id="tb-companion-panel" class="hidden mt-4 pt-4 border-t border-gray-700"> <!-- [MODIFIED] ID -->
                <h4 class="text-lg font-bold text-gray-300 text-center mb-2">Đồng Hành</h4> <!-- [NEW] Title -->
                <h4 id="tb-companion-name" class="text-lg font-bold text-green-400">...</h4> <!-- [MODIFIED] ID -->
                <p id="tb-companion-level" class="text-xs text-yellow-400 mb-2">Cấp ...</p> <!-- [MODIFIED] ID -->
                <!-- HP Bar -->
                <div class="mb-2">
                    <div class="flex justify-between text-xs mb-1 text-gray-300">
                        <span>Sinh Lực (HP)</span>
                        <span id="tb-companion-hp">... / ...</span> <!-- [MODIFIED] ID -->
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div id="tb-companion-hp-bar" class="bg-red-600 h-3 rounded-full transition-all duration-300" style="width: 100%"></div> <!-- [MODIFIED] ID -->
                    </div>
                </div>
                <!-- Stats -->
                <div id="tb-companion-stats" class="grid grid-cols-2 gap-x-2 gap-y-1 text-xs mt-2 bg-gray-700 p-2 rounded"> <!-- [MODIFIED] ID -->
                    <!-- Stats injected by JS -->
                </div>
            </div>
        </div>
                        
        <!-- Player Action Buttons -->
                        <div id="tb-action-buttons" class="space-y-2 mt-4">
                            <button onclick="performPlayerAction('attack')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded">
                                <i class="fa-solid fa-khanda mr-2"></i>Tấn Công
                            </button>
                            <button onclick="performPlayerAction('skill')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded opacity-50 cursor-not-allowed" disabled>
                                <i class="fa-solid fa-star mr-2"></i>Hồn Kỹ (Chưa có)
                            </button>
                            <!-- [MODIFIED] Enabled the Item button -->
                            <button onclick="performPlayerAction('item')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded">
                                <i class="fa-solid fa-flask mr-2"></i>Vật Phẩm
                            </button>
                        </div>
                    </div>

                    <!-- 2. Combat Log -->
                    <!-- [MODIFIED] Đổi bg-black/30 -> bg-black/15 -->
                    <div class="bg-black/15 border border-gray-700 p-4 rounded-lg flex flex-col" style="min-height: 0;"> <!-- [NEW] Added min-height: 0 to fix overflow -->
                        <h4 class="text-lg font-bold text-gray-300 mb-2 border-b border-gray-700 pb-2">Nhật Ký Chiến Đấu</h4>
                        <div id="tb-combat-log" class="flex-grow overflow-y-auto scrollbar-thin space-y-2" style="font-family: 'Courier New', Courier, monospace; font-size: 0.9rem;">
                            <!-- Log messages added here -->
                        </div>
                    </div>

                    <!-- 3. Enemy Panel -->
                    <!-- [MODIFIED] Đổi bg-black/30 -> bg-black/15 -->
                    <div class="bg-black/15 border border-gray-700 p-4 rounded-lg flex flex-col overflow-y-auto scrollbar-thin items-center">
                        <div>
                            <i id="tb-enemy-icon" class="fa-solid fa-paw text-6xl text-red-500 mb-4"></i>
                            <h4 id="tb-enemy-name" class="text-2xl font-bold text-red-400 text-center">...</h4>
                            <p id="tb-enemy-level" class="text-sm text-yellow-400 text-center mb-4">Cấp ?</p>
                            
                            <!-- Enemy HP Bar -->
                            <div class="mb-2 w-full">
                                <div class="flex justify-between text-sm mb-1 text-gray-300">
                                    <span>Sinh Lực (HP)</span>
                                    <span id="tb-enemy-hp">... / ...</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-4">
                                    <div id="tb-enemy-hp-bar" class="bg-red-600 h-4 rounded-full transition-all duration-300" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <!-- [NEW] Enemy Stats -->
                            <div id="tb-enemy-stats" class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm mt-4 bg-gray-700 p-2 rounded w-full">
                                <!-- Stats injected by JS -->
                            </div>
                        </div>
                        <button onclick="endTurnBasedCombat(false)" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mt-4">
                            <i class="fa-solid fa-flag-white mr-2"></i>Bỏ Chạy
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- [NEW] Turn Based Win/Loss Modal -->
        <div id="tb-result-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[70]"> <!-- z-index 70 -->
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-md modal border border-gray-600">
                <div class="p-4 sm:p-6 text-center">
                    <h3 id="tb-result-title" class="text-3xl font-bold text-yellow-400 mb-4">CHIẾN THẮNG</h3>
                    <div id="tb-result-rewards" class="space-y-2 text-lg text-gray-200 mb-6">
                        <!-- Rewards injected by JS -->
                    </div>
                    <button onclick="hideModal('tb-result-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <!-- [NEW] Dungeons Modal (Luyen Cong) (Re-added) -->
        <div id="dungeons-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <!-- [MODIFIED] Removed bg-gray-800, changed max-w-lg to max-w-2xl -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-2xl modal border border-red-600 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Luyện Công</h3>
                </div>
                <!-- Content -->
                <div id="dungeon-list" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <!-- Dungeon list will be rendered here -->
                </div>
                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('dungeons-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Dungeon Info Modal (Re-added) -->
        <div id="dungeon-info-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-gray-600 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 id="dungeon-info-title" class="text-xl sm:text-2xl font-bold text-yellow-400">Thông Tin Bản Đồ</h3>
                </div>
                <div id="dungeon-info-content" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <!-- Info content will be rendered here -->
                </div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('dungeon-info-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>
        
        <!-- [NEW] Mon Phai (Sect) Selection Modal (Re-added) -->
        <div id="mon-phai-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]">
            <!-- [MODIFIED] Removed bg-gray-800 -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-3xl modal border border-gray-600 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Gia Nhập Môn Phái</h3>
                </div>
                <div id="mon-phai-list" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <!-- List of sects will be rendered here by JS -->
                </div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('mon-phai-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>
        
        <!-- [NEW] World Map Modal (Re-added) -->
        <div id="world-map-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-2xl modal border border-gray-600 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Bản Đồ Thế Giới</h3>
                </div>
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <div class="map-container">
                        <!-- [MODIFIED] Added hideModal('world-map-modal') to clicks -->
                        <div class="map-location" style="top: 15%; left: 20%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Thôn Tân Thủ</div>
                        <!-- [REMOVED] Di chuyển Tiểu Ngư Thôn sang modal Changelog
                        <div class="map-location" style="top: 25%; left: 30%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Tiểu Ngư Thôn</div>
                        -->
                        <div class="map-location" style="top: 30%; left: 45%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Tương Dương Thành</div>
                        <div class="map-location" style="top: 50%; left: 30%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Phục Ngưu Sơn</div>
                        <div class="map-location" style="top: 65%; left: 60%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Thanh Thành Sơn</div>
                        <div class="map-location" style="top: 40%; left: 75%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Núi Võ Đang</div>
                        <div class="map-location" style="top: 80%; left: 40%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Cán Viên Động</div>
                        <div class="map-location" style="top: 10%; left: 70%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Kiếm Các</div>
                        <div class="map-location" style="top: 25%; left: 85%;" onclick="showModal('dungeons-modal'); hideModal('world-map-modal');">Đỉnh Hoa Sơn</div>
                    </div>
                </div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('world-map-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Changelog Modal (Re-added) -->
        <div id="changelog-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <!-- [MODIFIED] Removed bg-gray-800 -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-lg modal border border-gray-600 flex flex-col">
                <!-- Header trong suốt để thấy nền -->
                <div class="p-4 sm:p-6 border-b border-gray-500/30 bg-black/20 backdrop-blur-md rounded-t-lg">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400 text-shadow">Chân Long Thế Giới</h3>
                </div>
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <!-- [MODIFIED] Thêm nội dung map mới vào Changelog -->
                    <h4 class="text-lg font-bold text-cyan-400 mb-4 text-shadow">Bản Đồ Mới: Tiểu Ngư Thôn</h4>
                    <!-- [MODIFIED] Thay bg-gray-700 bằng hiệu ứng kính mờ -->
                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-green-300">
                                <i class="fa-solid fa-fish-fins mr-2"></i>Tiểu Ngư Thôn
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Một làng chài ven biển yên bình, gần đây bị quấy rối bởi Cá Tinh và Tôm Tinh.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 5-15</p>
                        </div>
                        <button onclick="confirmAdventure('map_ngu_thon'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>
                    
                    <!-- [NEW] Thêm 5 map mới -->
                    <!-- [MODIFIED] Glass Effect -->
                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-yellow-300">
                                <i class="fa-solid fa-city mr-2"></i>Tô Châu
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Thành cổ ven Thái Hồ, nơi tụ tập của Thủy Tặc và Lính Gác.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 15-25</p>
                        </div>
                        <button onclick="confirmAdventure('map_to_chau'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-yellow-300">
                                <i class="fa-solid fa-chess-rook mr-2"></i>Kinh Thành
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Kinh thành hoa lệ, nhưng cũng là nơi ẩn náu của Đại Nội Thị Vệ và Cấm Vệ Quân.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 25-35</p>
                        </div>
                        <button onclick="confirmAdventure('map_kinh_thanh'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-400">
                                <i class="fa-solid fa-mountain-sun mr-2"></i>Thục Sơn
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Tiên sơn huyền ảo, nơi các đệ tử Thục Sơn tu luyện kiếm pháp.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 60-70</p>
                        </div>
                        <button onclick="confirmAdventure('map_thuc_son'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-400">
                                <i class="fa-solid fa-place-of-worship mr-2"></i>Ngọc Hư Thành
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Cung điện trên mây, được canh giữ bởi các Hộ Pháp Ngọc Hư Cung.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 90-100</p>
                        </div>
                        <button onclick="confirmAdventure('map_ngoc_hu'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-500">
                                <i class="fa-solid fa-dungeon mr-2"></i>Hư Thiên Điện
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Điện thờ cổ xưa lơ lửng trong hư không, nơi trú ngụ của Hư Thiên Vệ Sĩ.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 120-130</p>
                        </div>
                        <button onclick="confirmAdventure('map_hu_thien'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>
                    
                    <!-- [NEW] Thêm 4 map mới -->
                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-yellow-300">
                                <i class="fa-solid fa-khanda mr-2"></i>Đại Lý
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Nơi Thiên Long Tự tọa lạc, quê hương của Đoàn Thị Binh Sĩ.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 35-45</p>
                        </div>
                        <button onclick="confirmAdventure('map_dai_ly'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-400">
                                <i class="fa-solid fa-star-of-david mr-2"></i>Thập Nhị Cung
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Các cung hoàng đạo được canh giữ bởi các Thánh Vệ.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 70-80</p>
                        </div>
                        <button onclick="confirmAdventure('map_thap_nhi_cung'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-400">
                                <i class="fa-solid fa-dharmachakra mr-2"></i>Lục Đạo Luân Hồi
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Nơi các linh hồn luân chuyển, canh giữ bởi Tu La Đạo Binh và Ác Quỷ.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 100-110</p>
                        </div>
                        <button onclick="confirmAdventure('map_luc_dao'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-500">
                                <i class="fa-solid fa-dragon mr-2"></i>Quần Long Tranh Bá
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Chiến trường thượng cổ nơi các long hồn tranh đấu.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 130-140</p>
                        </div>
                        <button onclick="confirmAdventure('map_quan_long'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>
                    <!-- [NEW] Thêm 6 map mới -->
                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-500">
                                <i class="fa-solid fa-hippo mr-2"></i>Thái Cổ Hồng Hoang
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Vùng đất sơ khai, nơi các dị thú thái cổ ngự trị.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 140-150</p>
                        </div>
                        <button onclick="confirmAdventure('map_tchh'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>
                    
                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-500">
                                <i class="fa-solid fa-yin-yang mr-2"></i>Tam Thanh Diệt Thế
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Nơi Tam Thanh Thánh Nhân diễn võ, ẩn chứa sức mạnh diệt thế.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 150-160</p>
                        </div>
                        <button onclick="confirmAdventure('map_ttdt'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>
                    
                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-500">
                                <i class="fa-solid fa-hat-wizard mr-2"></i>Phong Thần Đại Chiến
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Chiến trường cổ xưa nơi Xiển Giáo và Triệt Giáo phân tranh.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 160-170</p>
                        </div>
                        <button onclick="confirmAdventure('map_ptdc'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-600">
                                <i class="fa-solid fa-shield-halved mr-2"></i>Viễn Cổ Tranh Phong
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Nơi các Ma Thần và Chiến Binh viễn cổ tranh đoạt thiên địa.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 170-180</p>
                        </div>
                        <button onclick="confirmAdventure('map_vctp'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-600">
                                <i class="fa-solid fa-crown mr-2"></i>Thống Nhất Tam Giới
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Thiên Đình xuất chinh, thống nhất tam giới Nhân-Thần-Ma.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 180-190</p>
                        </div>
                        <button onclick="confirmAdventure('map_tntg'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>

                    <div class="bg-black/50 backdrop-blur-sm border border-white/10 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-black/70 transition duration-200 mt-4">
                        <div class="flex-grow">
                            <h4 class="font-bold text-xl text-red-600">
                                <i class="fa-solid fa-meteor mr-2"></i>Tinh Không Đại Vực
                            </h4>
                            <p class="text-sm text-gray-200 mt-1">Vực sâu tinh không, nơi ẩn náu của Vực Ngoại Thiên Ma.</p>
                            <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 190-200</p>
                        </div>
                        <button onclick="confirmAdventure('map_tkdv'); hideModal('changelog-modal');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0 shadow-md">
                            Tiến vào
                        </button>
                    </div>
                    <!-- [END NEW] -->
                    <!-- [END NEW] -->
                </div>
                <!-- [MODIFIED] Removed bg-gray-900, dùng background kính mờ cho footer -->
                <div class="p-4 rounded-b-lg text-right bg-black/20 backdrop-blur-md border-t border-gray-500/30">
                    <button onclick="hideModal('changelog-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded shadow-md">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] About Modal (Re-added) -->
        <div id="about-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-gray-600 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">About (Về tác giả)</h3>
                </div>
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow text-center">
                    <p class="text-lg">Game được tạo bởi <span class="font-bold text-cyan-400">HuyHuyy</span>.</p>
                    <p class="text-gray-400 mt-2">Dựa trên ý tưởng và được phát triển với sự trợ giúp của AI.</p>
                    <p class="mt-6">Cảm ơn bạn đã chơi!</p>
                </div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('about-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- Instructions Modal -->
        <div id="instructions-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
             <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-gray-600 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700 flex-shrink-0">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Hướng Dẫn Võ Lâm</h3>
                </div>
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <h4 class="font-bold text-lg mb-2 text-cyan-400">Mục tiêu:</h4>
                    <p class="mb-4">Chọn bản đồ trong "Luyện Công" để nhân vật tự động chiến đấu (Idle). Nhân vật sẽ tự tìm quái, tự đánh, tự dùng kỹ năng. Bạn có thể dùng vật phẩm (Máu/Mana) thủ công bằng phím tắt.</p>
                    <h4 class="font-bold text-lg mt-4 mb-2 text-cyan-400">Tử Vong:</h4>
                    <p class="mb-4">Khi Sinh Lực (HP) về 0, bạn sẽ "Về Thành Dưỡng Sức", dừng luyện công và bị <strong class="text-red-400">mất 3% Kinh nghiệm</strong> hiện tại. HP/Mana sẽ được hồi đầy.</p>
                    <h4 class="font-bold text-lg mt-4 mb-2 text-cyan-400">Hành Trang:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Hành trang có tối đa 300 ô chứa đồ.</li>
                        <li>Vật phẩm tiêu hao (Máu/Mana) tự động xếp chồng, tối đa 5000/ô.</li>
                        <li>Trang bị (vũ khí, giáp,...) mỗi món chiếm 1 ô.</li>
                        <li>Di chuột qua vật phẩm để xem nhanh thông tin.</li>
                        <li>Có nút "Sử dụng" cho vật phẩm tiêu hao.</li>
                        <li>Nếu hành trang đầy, vật phẩm nhặt được sẽ bị mất.</li>
                    </ul>
                    <h4 class="font-bold text-lg mt-4 mb-2 text-cyan-400">Thuộc tính:</h4>
                    <p class="mb-1"><strong class="text-red-400">Sinh Lực (HP):</strong> Máu, khi về 0 sẽ tử vong.</p>
                     <p class="mb-1"><strong class="text-blue-400">Nội Lực (Mana):</strong> Dùng để thi triển kỹ năng.</p>
                    <p class="mb-1"><strong class="text-orange-400">Công Kích (Attack):</strong> Sức tấn công.</p>
                    <p class="mb-1"><strong class="text-blue-400">Phòng Thủ (Defense):</strong> Khả năng phòng thủ.</p>
                    <p class="mb-1"><strong class="text-green-400">Thân Pháp (Speed):</strong> Ảnh hưởng tốc độ đánh và né tránh (tối đa 75%).</p>
                    <p class="mb-1"><strong class="text-yellow-400">May Mắn (Luck):</strong> Ảnh hưởng tỷ lệ chí mạng.</p>
                </div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right flex-shrink-0">
                    <button onclick="hideModal('instructions-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Skills Modal (Re-added) -->
        <div id="skills-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <!-- [MODIFIED] Removed bg-gray-800 -->
            <!-- Thêm h-[80vh] và overflow-hidden để cố định kích thước khung -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-2xl modal border border-purple-600 flex flex-col h-[80vh] overflow-hidden">
                <!-- Header -->
                <!-- [MODIFIED] Added class 'modal-header', flex-shrink-0 -->
                <div class="p-4 sm:p-6 border-b border-gray-700 modal-header flex-shrink-0">
                    <h3 id="skills-modal-title" class="text-xl sm:text-2xl font-bold text-yellow-400">Kỹ Năng</h3>
                </div>
                
                <!-- [NEW] Tab Headers -->
                <!-- [MODIFIED] Removed bg-gray-900, added class 'modal-tab-bar', flex-shrink-0 -->
                <div class="flex border-b border-gray-700 modal-tab-bar overflow-x-auto flex-shrink-0"> 
                    <button id="tab-mon-phai" onclick="switchSkillTab('mon-phai')" class="flex-1 whitespace-nowrap py-3 px-4 font-bold text-center tab-btn tab-active">Môn Phái</button>
                    <!-- [NEW] Thêm tab Kỹ Năng Sống -->
                    <button id="tab-ky-nang-song" onclick="switchSkillTab('ky-nang-song')" class="flex-1 whitespace-nowrap py-3 px-4 font-bold text-center text-gray-400 tab-btn">Kỹ Năng Sống</button>
                    <button id="tab-hon-ky" onclick="switchSkillTab('hon-ky')" class="flex-1 whitespace-nowrap py-3 px-4 font-bold text-center text-gray-400 tab-btn">Hồn Kỹ</button> 
                    <button id="tab-sieu-viet" onclick="switchSkillTab('sieu-viet')" class="flex-1 whitespace-nowrap py-3 px-4 font-bold text-center text-gray-400 tab-btn">Siêu Việt</button>
                    <button id="tab-tiem-nang" onclick="switchSkillTab('tiem-nang')" class="flex-1 whitespace-nowrap py-3 px-4 font-bold text-center text-gray-400 tab-btn">Tiềm Năng</button>
                </div>

                <!-- Content -->
                <!-- [MODIFIED] Tab Content: Môn Phái - Xóa min-height, thêm bg -->
                <div id="panel-mon-phai" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel bg-black/20 backdrop-blur-sm">
                    <div id="skill-tree-list">
                        <!-- Skill tree items will be rendered here by JS -->
                    </div>
                </div>

                <!-- [NEW] Tab Content: Kỹ Năng Sống (Được di chuyển từ màn hình chính vào đây) -->
                <div id="panel-ky-nang-song" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-black/20 backdrop-blur-sm space-y-6">
                    <!-- Fishing Panel -->
                    <div id="fishing-panel" class="w-full rounded-lg shadow-inner flex flex-col border border-gray-600 overflow-hidden" style="height: 320px;">
                        <div class="flex-shrink-0 p-3 bg-black/40 backdrop-blur-sm">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-bold text-cyan-400"><i class="fa-solid fa-fish-fins mr-2"></i>Câu Cá</h3>
                                <span id="fishing-skill-level" class="font-bold text-sm text-white">Cấp 1</span>
                            </div>
                            <div class="xp-bar-container mb-2 mt-2 h-3">
                                <div id="fishing-skill-bar" class="xp-bar-fill bg-cyan-500" style="width: 0%;"></div>
                                <div id="fishing-skill-xp" class="xp-bar-text text-[10px]">0 / 100 XP</div>
                            </div>
                            <div class="xp-bar-container mb-1 h-3 invisible">
                                <div id="fishing-action-bar" class="xp-bar-fill bg-green-500" style="width: 0%;"></div>
                                <div id="fishing-action-text" class="xp-bar-text text-[10px]">Đang...</div>
                            </div>
                        </div>
                        
                        <div id="idle-log" class="scrollbar-thin flex-grow p-2 overflow-y-auto bg-black/30 font-mono text-xs"></div>
                        
                        <div class="flex-shrink-0 p-2 bg-black/40">
                            <button id="start-fishing-btn" onclick="startIdleAction('fishing_spot_1')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">Bắt đầu Câu</button>
                            <button id="stop-fishing-btn" onclick="stopIdleAction()" class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">Dừng Câu Cá</button>
                        </div>
                    </div>

                    <!-- Mining Panel -->
                    <div id="mining-panel" class="w-full rounded-lg shadow-inner flex flex-col border border-gray-600 overflow-hidden" style="height: 320px;">
                        <div class="flex-shrink-0 p-3 bg-black/40 backdrop-blur-sm">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-bold text-yellow-500"><i class="fa-solid fa-hammer mr-2"></i>Khai Khoáng</h3>
                                <span id="mining-skill-level" class="font-bold text-sm text-white">Cấp 1</span>
                            </div>
                            <div class="xp-bar-container mb-2 mt-2 h-3">
                                <div id="mining-skill-bar" class="xp-bar-fill bg-yellow-600" style="width: 0%;"></div>
                                <div id="mining-skill-xp" class="xp-bar-text text-[10px]">0 / 100 XP</div>
                            </div>
                            <div class="xp-bar-container mb-1 h-3 invisible">
                                <div id="mining-action-bar" class="xp-bar-fill bg-green-500" style="width: 0%;"></div>
                                <div id="mining-action-text" class="xp-bar-text text-[10px]">Đang...</div>
                            </div>
                        </div>
                        
                        <div id="idle-log-mining" class="scrollbar-thin flex-grow p-2 overflow-y-auto bg-black/30 font-mono text-xs"></div>
                        
                        <div class="flex-shrink-0 p-2 bg-black/40">
                            <button id="start-mining-btn" onclick="startIdleAction('mining_spot_1')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">Bắt đầu Đào</button>
                            <button id="stop-mining-btn" onclick="stopIdleAction()" class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">Dừng Khai Khoáng</button>
                        </div>
                    </div>

                    <!-- Herbalism Panel -->
                    <div id="herbalism-panel" class="w-full rounded-lg shadow-inner flex flex-col border border-gray-600 overflow-hidden" style="height: 320px;">
                        <div class="flex-shrink-0 p-3 bg-black/40 backdrop-blur-sm">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-bold text-green-500"><i class="fa-solid fa-seedling mr-2"></i>Hái Thuốc</h3>
                                <span id="herbalism-skill-level" class="font-bold text-sm text-white">Cấp 1</span>
                            </div>
                            <div class="xp-bar-container mb-2 mt-2 h-3">
                                <div id="herbalism-skill-bar" class="xp-bar-fill bg-green-600" style="width: 0%;"></div>
                                <div id="herbalism-skill-xp" class="xp-bar-text text-[10px]">0 / 100 XP</div>
                            </div>
                            <div class="xp-bar-container mb-1 h-3 invisible">
                                <div id="herbalism-action-bar" class="xp-bar-fill bg-green-500" style="width: 0%;"></div>
                                <div id="herbalism-action-text" class="xp-bar-text text-[10px]">Đang...</div>
                            </div>
                        </div>

                        <div id="idle-log-herbalism" class="scrollbar-thin flex-grow p-2 overflow-y-auto bg-black/30 font-mono text-xs"></div>
                        
                        <div class="flex-shrink-0 p-2 bg-black/40">
                            <button id="start-herbalism-btn" onclick="startIdleAction('herbalism_spot_1')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">Bắt đầu Hái</button>
                            <button id="stop-herbalism-btn" onclick="stopIdleAction()" class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">Dừng Hái Thuốc</button>
                        </div>
                    </div>
                </div>

                <!-- [NEW] Tab Content: Hồn Kỹ (UI Mới) - Xóa min-height, thêm bg -->
                <div id="panel-hon-ky" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-black/20 backdrop-blur-sm">
                     <!-- Nội dung sẽ được render bởi renderHonKyPanel() -->
                </div>
                
                <!-- [NEW] Tab Content: Siêu Việt - Xóa min-height, thêm bg -->
                <div id="panel-sieu-viet" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-black/20 backdrop-blur-sm">
                    <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Kỹ Năng Siêu Việt</h4>
                    <p class="text-center text-gray-400 mb-4 text-sm">Điểm Siêu Việt: <span id="sieu-viet-points" class="font-bold text-2xl text-yellow-300">0</span></p>
                    <p class="text-center text-gray-400 mb-4 text-sm">Đây là nơi bạn dùng Điểm Siêu Việt (nhận từ Trùng Sinh) để nâng cấp các chỉ số vĩnh viễn.</p>
                    <!-- Cây kỹ năng Siêu Việt sẽ được thêm vào đây -->
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <p class="text-gray-500 text-center">(Chức năng đang được phát triển)</p>
                    </div>
                </div>
                
                <!-- [NEW] Tab Content: Tiềm Năng -->
                <div id="panel-tiem-nang" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-black/20 backdrop-blur-sm">
                    <!-- Nội dung 4 ô Tiềm Năng sẽ được render bởi renderTiemNangPanel() -->
                </div>

                <!-- Footer -->
                <!-- [MODIFIED] Removed bg-gray-900, added class 'modal-footer', flex-shrink-0 -->
                <div class="p-4 rounded-b-lg text-right modal-footer flex-shrink-0">
                    <button onclick="hideModal('skills-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Equipment/Inventory Modal (Re-added) -->
        <div id="equipment-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-5xl modal border border-indigo-600 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700 flex flex-col sm:flex-row justify-between sm:items-center">
                    <div>
                        <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Hành Trang</h3>
                        <p id="inventory-slot-count" class="text-sm text-gray-400">Số ô: 0/300</p>
                    </div>
                    <!-- Auto-sell toggles -->
                    <div class="flex gap-4 mt-3 sm:mt-0">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="auto-sell-common" onchange="toggleAutoSell('common')" class="w-4 h-4 mr-2 bg-gray-700 border-gray-600">
                            Tự Bán (Thường)
                        </label>
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="auto-sell-uncommon" onchange="toggleAutoSell('uncommon')" class="w-4 h-4 mr-2 bg-gray-700 border-gray-600">
                            Tự Bán (Hiếm)
                        </label>
                    </div>
                </div>
                <!-- Content -->
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <div id="equipment-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                        <!-- Items will be rendered here by JS -->
                    </div>
                </div>
                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('equipment-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Sung Vat (Pet) Modal (Re-added) -->
        <div id="sung-vat-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <!-- [MODIFIED] Removed bg-gray-800, changed border-orange-600 to border-cyan-500 -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-5xl modal border border-cyan-500 flex flex-col">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Sủng Vật</h3>
                </div>
                <!-- Content -->
                <div class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow grid grid-cols-1 md:grid-cols-3 gap-6" style="min-height: 400px;">
                    <!-- Left: Equipped Pet -->
                    <!-- [MODIFIED] Removed bg-gray-900, added glass effect classes -->
                    <div class="md:col-span-1 bg-black/40 backdrop-blur-sm border border-cyan-600 p-4 rounded-lg">
                        <h4 class="font-bold text-lg text-cyan-400 mb-3 text-center">Đang Xuất Chiến</h4>
                        <!-- [MODIFIED] Removed bg-gray-700, added glass effect classes -->
                        <div id="sung-vat-equipped-slot" class="bg-black/30 backdrop-blur-sm border border-cyan-700 p-4 rounded-lg">
                            <!-- Equipped pet rendered by JS -->
                        </div>
                    </div>
                    <!-- Right: Pet List -->
                    <div id="sung-vat-list" class="md:col-span-2 space-y-3 h-full overflow-y-auto scrollbar-thin" style="max-height: 65vh;">
                        <!-- Pet list rendered by JS -->
                    </div>
                </div>
                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('sung-vat-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Boost Disciple Modal -->
        <div id="boost-disciple-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-gray-600 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 id="boost-disciple-title" class="text-xl sm:text-2xl font-bold text-yellow-400">Bồi Dưỡng Đệ Tử</h3>
                </div>
                <div id="boost-disciple-content" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <!-- Content will be rendered by JS -->
                </div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('boost-disciple-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Boost Pet Modal -->
        <div id="boost-pet-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-orange-500 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 id="boost-pet-title" class="text-xl sm:text-2xl font-bold text-yellow-400">Bồi Dưỡng Sủng Vật</h3>
                </div>
                <div id="boost-pet-content" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow">
                    <!-- Content will be rendered by JS -->
                </div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right">
                    <button onclick="hideModal('boost-pet-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- [NEW] Disciple Skills Modal (Võ Học Đệ Tử) - [MODIFIED] UI Upgrade -->
        <div id="disciple-skills-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]">
            <!-- [MODIFIED] Tăng kích thước lên max-w-5xl và chiều cao cố định h-[85vh] -->
            <div class="bg-gray-900 rounded-xl shadow-2xl w-11/12 max-w-5xl h-[85vh] modal border-2 border-indigo-500 flex flex-col overflow-hidden">
                <!-- Header Cố định -->
                <div class="p-4 border-b border-gray-700 bg-gray-800/90 backdrop-blur flex justify-between items-center flex-shrink-0">
                    <h3 id="disciple-skills-title" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Võ Học Đệ Tử</h3>
                    <div class="bg-gray-800 px-3 py-1 rounded-full border border-gray-600 flex items-center gap-2">
                        <span class="text-xs text-gray-400">Điểm Cống Hiến:</span>
                        <span class="font-bold text-lime-400 text-base" id="skill-modal-dch-display">0</span>
                    </div>
                    <button onclick="hideModal('disciple-skills-modal')" class="text-gray-400 hover:text-white transition">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>
                
                <!-- Content Cuộn -->
                <div id="disciple-skills-content" class="p-6 overflow-y-auto scrollbar-thin flex-grow bg-gray-900/50 relative">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>

         <!-- Tien Trang Modal (UPDATED LAYOUT FIX) -->
        <div id="tien-trang-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-2 sm:p-4 z-50">
            <!-- [MODIFIED] Layout Fix: Sử dụng relative, flex-col, và max-h-[90vh] để đảm bảo nằm trong màn hình -->
            <div class="relative bg-gray-900 rounded-lg shadow-2xl w-full max-w-6xl h-[90vh] max-h-[90vh] flex flex-col border border-gray-600 overflow-hidden">
                
                <!-- Header (Cố định) -->
                <div class="p-3 sm:p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0 bg-gray-900/90 backdrop-blur z-10">
                    <h3 class="text-lg sm:text-2xl font-bold text-yellow-400">Tiền Trang</h3>
                    <button onclick="hideModal('tien-trang-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded text-sm">Đóng</button>
                </div>
                
                <!-- Tab Headers (Cố định, cuộn ngang nếu quá dài) -->
                <div class="flex border-b border-gray-700 bg-black/40 backdrop-blur-sm overflow-x-auto scrollbar-thin flex-shrink-0 whitespace-nowrap">
                    <!-- [MODIFIED] Added Icons and standardized classes -->
                    <button id="tab-exchange" onclick="switchTienTrangTab('exchange')" class="tab-btn tab-active">
                        <i class="fa-solid fa-right-left"></i> Đổi Tiền
                    </button>
                    <button id="tab-buy" onclick="switchTienTrangTab('buy')" class="tab-btn">
                        <i class="fa-solid fa-flask"></i> Tiêu Hao
                    </button>
                    <!-- [MODIFIED] Đổi tên tab Đồ Phổ thành Thương Nhân Thần Bí -->
                    <button id="tab-buy-blueprints" onclick="switchTienTrangTab('buy-blueprints')" class="tab-btn text-purple-400">
                        <i class="fa-solid fa-user-secret"></i> Thương Nhân Thần Bí
                    </button>
                    <button id="tab-buy-scrolls" onclick="switchTienTrangTab('buy-scrolls')" class="tab-btn">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Phù Phép
                    </button>
                    <button id="tab-buy-equip" onclick="switchTienTrangTab('buy-equip')" class="tab-btn">
                        <i class="fa-solid fa-shirt"></i> Trang Bị
                    </button>
                    <button id="tab-sell" onclick="switchTienTrangTab('sell')" class="tab-btn">
                        <i class="fa-solid fa-sack-dollar"></i> Bán Đồ
                    </button>
                    <button id="tab-sell-materials" onclick="switchTienTrangTab('sell-materials')" class="tab-btn">
                        <i class="fa-solid fa-boxes-packing"></i> Bán NL
                    </button>
                    <button id="tab-exchange-items" onclick="switchTienTrangTab('exchange-items')" class="tab-btn">
                        <i class="fa-solid fa-recycle"></i> Đổi NL
                    </button>
                </div>
                
                <!-- Content Area (Cuộn dọc) -->
                <div class="flex-grow overflow-y-auto scrollbar-thin bg-gray-900/50 relative">
                    
                    <!-- Tab Content: Exchange (REMASTERED UI) -->
                    <div id="panel-exchange" class="p-4 sm:p-6 tab-panel absolute inset-0 overflow-y-auto scrollbar-thin bg-gray-900/50">
                        
                        <!-- Header -->
                        <div class="text-center mb-8">
                            <h4 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-amber-500 to-yellow-300 uppercase tracking-widest filter drop-shadow-lg">Thị Trường Tiền Tệ</h4>
                            <div class="h-0.5 w-32 mx-auto bg-gradient-to-r from-transparent via-yellow-500 to-transparent mt-2"></div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-5xl mx-auto">
                            
                            <!-- Card 1: Mua Kim Nguyên Bảo -->
                            <div class="bg-black/30 backdrop-blur-sm border border-yellow-500/30 p-6 rounded-xl shadow-[0_0_20px_rgba(234,179,8,0.05)] relative overflow-hidden group hover:border-yellow-500/60 transition duration-300 flex flex-col justify-between">
                                <div class="absolute -right-6 -top-6 text-yellow-500/5 text-9xl group-hover:text-yellow-500/10 transition pointer-events-none"><i class="fa-solid fa-gem"></i></div>
                                
                                <div>
                                    <h5 class="font-bold text-xl text-yellow-300 mb-1 flex items-center gap-2">
                                        <i class="fa-solid fa-gem"></i> Mua Kim Nguyên Bảo
                                    </h5>
                                    <p class="text-xs text-gray-400 mb-4">Đổi Ngân Lượng lấy KNB để mua vật phẩm cao cấp.</p>
                                    
                                    <div class="bg-black/40 rounded p-3 border border-gray-700/50 mb-4 flex justify-between items-center">
                                        <span class="text-gray-400 text-sm">Tỷ giá:</span>
                                        <span class="font-mono font-bold text-white text-sm">1,000,000 NL <i class="fa-solid fa-arrow-right text-gray-500 mx-1"></i> <span class="text-yellow-300">1 KNB</span></span>
                                    </div>
                                </div>

                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Số dư hiện tại: <span id="tien-trang-nl" class="text-white font-bold font-mono">0</span> NL</p>
                                    <div class="flex gap-2">
                                        <div class="relative flex-grow">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fa-solid fa-coins text-gray-500 text-xs"></i>
                                            </div>
                                            <input type="number" id="nl-to-exchange" placeholder="Nhập số NL..." class="bg-gray-900/80 border border-gray-600 rounded pl-8 pr-2 py-2 text-white w-full text-sm focus:border-yellow-400 outline-none transition" min="1000000" step="1000000">
                                        </div>
                                        <button onclick="exchangeCurrency()" class="bg-gradient-to-r from-yellow-700 to-yellow-600 hover:from-yellow-600 hover:to-yellow-500 text-white font-bold py-2 px-4 rounded shadow-lg transition transform active:scale-95 border border-yellow-500/50 whitespace-nowrap text-sm">
                                            Đổi Ngay
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 2: Đổi Ngân Lượng -->
                            <div class="bg-black/30 backdrop-blur-sm border border-gray-500/30 p-6 rounded-xl shadow-lg relative overflow-hidden group hover:border-gray-400/60 transition duration-300 flex flex-col justify-between">
                                <div class="absolute -right-6 -top-6 text-gray-500/5 text-9xl group-hover:text-gray-500/10 transition pointer-events-none"><i class="fa-solid fa-coins"></i></div>
                                
                                <div>
                                    <h5 class="font-bold text-xl text-gray-200 mb-1 flex items-center gap-2">
                                        <i class="fa-solid fa-sack-dollar"></i> Đổi Ngân Lượng
                                    </h5>
                                    <p class="text-xs text-gray-400 mb-4">Quy đổi ngược KNB thành Ngân Lượng để chi tiêu.</p>
                                    
                                    <div class="bg-black/40 rounded p-3 border border-gray-700/50 mb-4 flex justify-between items-center">
                                        <span class="text-gray-400 text-sm">Tỷ giá:</span>
                                        <span class="font-mono font-bold text-white text-sm">1 KNB <i class="fa-solid fa-arrow-right text-gray-500 mx-1"></i> <span class="text-gray-300">888,888 NL</span></span>
                                    </div>
                                </div>

                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Số dư hiện tại: <span id="tien-trang-knb" class="text-yellow-300 font-bold font-mono">0</span> KNB</p>
                                    <div class="flex gap-2">
                                        <div class="relative flex-grow">
                                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                <i class="fa-solid fa-gem text-yellow-600 text-xs"></i>
                                            </div>
                                            <input type="number" id="knb-to-exchange" placeholder="Nhập số KNB..." class="bg-gray-900/80 border border-gray-600 rounded pl-8 pr-2 py-2 text-white w-full text-sm focus:border-gray-400 outline-none transition" min="1" step="1">
                                        </div>
                                        <button onclick="exchangeKNBToNL()" class="bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500 text-white font-bold py-2 px-4 rounded shadow-lg transition transform active:scale-95 border border-gray-500/50 whitespace-nowrap text-sm">
                                            Đổi Ngay
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card 3: Hợp Thành Thần Cách (Full Width) -->
                            <div class="lg:col-span-2 bg-black/30 backdrop-blur-sm border border-red-500/30 p-6 rounded-xl shadow-[0_0_20px_rgba(239,68,68,0.1)] relative overflow-hidden group hover:border-red-500/60 transition duration-300 mt-2">
                                <div class="absolute -right-10 -top-10 text-red-500/5 text-[10rem] group-hover:text-red-500/10 transition pointer-events-none animate-spin-slow"><i class="fa-solid fa-sun"></i></div>
                                
                                <div class="flex flex-col md:flex-row items-center justify-between gap-6 relative z-10">
                                    <div class="flex-grow text-center md:text-left">
                                        <h5 class="font-bold text-2xl text-red-400 mb-2 flex items-center justify-center md:justify-start gap-2 uppercase tracking-widest text-shadow-red">
                                            <i class="fa-solid fa-fire-flame-curved animate-pulse"></i> Hợp Thành Thần Cách
                                        </h5>
                                        <p class="text-sm text-gray-300 mb-4 max-w-xl">Dung hợp khí vận thiên địa từ 5 loại tiền tệ để ngưng tụ <strong class="text-red-400">Thần Cách</strong> - Đơn vị tiền tệ tối thượng dùng để giao dịch Hồn Kỹ.</p>
                                        
                                        <!-- Cost breakdown -->
                                        <div class="flex flex-wrap justify-center md:justify-start gap-2 text-xs font-mono bg-black/40 p-3 rounded-lg border border-red-900/30 inline-block">
                                            <span class="text-gray-400">Công thức 1 Thần Cách:</span>
                                            <span class="text-yellow-300 font-bold">2 UD</span> + 
                                            <span class="text-teal-300 font-bold">2 DV</span> + 
                                            <span class="text-orange-300 font-bold">50 VD</span> + 
                                            <span class="text-pink-300 font-bold">100 TL</span> + 
                                            <span class="text-lime-300 font-bold">200 CH</span>
                                        </div>
                                    </div>

                                    <div class="w-full md:w-auto bg-gray-900/60 p-4 rounded-lg border border-red-500/20 flex flex-col gap-3 min-w-[250px]">
                                        <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                                            <span class="text-gray-400 text-xs uppercase">Hiện có</span>
                                            <span class="font-bold text-xl text-red-400 text-shadow-red"><span id="tien-trang-thancach-display">0</span> <i class="fa-solid fa-sun text-xs"></i></span>
                                        </div>
                                        
                                        <div class="flex gap-2">
                                            <input type="number" id="thancach-to-exchange" placeholder="Số lượng..." class="bg-black/50 border border-red-900/50 rounded px-3 py-2 text-white w-full text-sm focus:border-red-500 outline-none text-center font-bold" min="1" step="1">
                                            <button onclick="exchangeThanCach()" class="bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 text-white font-bold py-2 px-4 rounded shadow-lg transition transform active:scale-95 border border-red-500/50 text-sm whitespace-nowrap">
                                                Hợp Thành
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Tab Content: Buy Items -->
                    <div id="panel-buy" class="p-4 sm:p-6 tab-panel hidden absolute inset-0 overflow-y-auto scrollbar-thin">
                        <p class="mb-4 text-center">Mua vật phẩm tiêu hao (Máu, Mana...) bằng Ngân Lượng.</p>
                        <div id="buy-item-list" class="space-y-2 pb-4"></div>
                    </div>

                    <!-- [MODIFIED] Tab Content: Mysterious Merchant (Was Blueprints) -->
                    <div id="panel-buy-blueprints" class="p-4 sm:p-6 tab-panel hidden absolute inset-0 overflow-y-auto scrollbar-thin bg-gray-900/90">
                        <!-- Merchant Header -->
                        <div class="flex flex-col items-center justify-center mb-6 border-b border-gray-700/50 pb-6">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-b from-purple-900/50 to-black border-2 border-purple-500 flex items-center justify-center mb-3 shadow-[0_0_20px_rgba(168,85,247,0.4)]">
                                 <i class="fa-solid fa-user-secret text-5xl text-purple-300 animate-pulse"></i>
                            </div>
                            <h4 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-fuchsia-400 to-purple-400 mb-2 text-shadow">Thương Nhân Thần Bí</h4>
                            <p class="text-gray-400 text-sm italic text-center max-w-md">
                                "Ta đi khắp thế gian sưu tầm kỳ bảo. Ngươi có đủ Uy Danh và Cống Hiến để đổi lấy những Đồ Phổ thất truyền này không?"
                            </p>
                        </div>
                        
                        <p class="mb-4 text-center text-xs text-gray-500 uppercase tracking-widest font-bold">-- Vật Phẩm Hoàng Kim --</p>
                        
                        <!-- Merchant Grid (Grid layout instead of list) -->
                        <div id="buy-blueprint-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 pb-8">
                            <!-- Content rendered by JS -->
                        </div>
                    </div>

                    <!-- Tab Content: Scrolls -->
                    <div id="panel-buy-scrolls" class="p-4 sm:p-6 tab-panel hidden absolute inset-0 overflow-y-auto scrollbar-thin">
                        <p class="mb-4 text-center text-purple-300">Mua các loại Cuộn Phù Phép để cường hóa trang bị.</p>
                        <div id="buy-scroll-list" class="space-y-2 pb-4"></div>
                    </div>

                    <!-- Tab Content: Equipment -->
                    <div id="panel-buy-equip" class="p-4 sm:p-6 tab-panel hidden absolute inset-0 overflow-y-auto scrollbar-thin">
                        <p class="mb-4 text-center">Mua trang bị bằng Ngân Lượng và Kim Nguyên Bảo.</p>
                        <div id="buy-equip-list" class="space-y-2 pb-4"></div>
                    </div>

                    <!-- Tab Content: Sell Items -->
                    <div id="panel-sell" class="p-4 sm:p-6 tab-panel hidden absolute inset-0 overflow-y-auto scrollbar-thin">
                        <p class="mb-4 text-center">Bán trang bị không dùng để nhận Ngân Lượng.</p>
                        <div class="flex justify-center gap-2 mb-4 flex-wrap">
                            <button onclick="sellItemsByQuality('common')" class="text-xs bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded">Bán hết (Thường)</button>
                            <button onclick="sellItemsByQuality('uncommon')" class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded">Bán hết (Hiếm)</button>
                            <button onclick="sellItemsByQuality('rare')" class="text-xs bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded">Bán hết (Quý)</button>
                            <button onclick="sellItemsByQuality('legendary')" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded">Bán hết (Sử Thi)</button>
                        </div>
                        <div id="sell-item-list" class="space-y-2 pb-4"></div>
                    </div>
                    
                    <!-- Tab Content: Sell Materials -->
                    <div id="panel-sell-materials" class="p-4 sm:p-6 tab-panel hidden absolute inset-0 overflow-y-auto scrollbar-thin">
                        <p class="mb-4 text-center">Bán vật phẩm tiêu hao (máu, mana, cá,...) để nhận Ngân Lượng.</p>
                        <div id="sell-material-list" class="space-y-2 pb-4"></div>
                    </div>
                    
                    <!-- Tab Content: Exchange Items -->
                    <div id="panel-exchange-items" class="p-4 sm:p-6 tab-panel hidden absolute inset-0 overflow-y-auto scrollbar-thin">
                        <p class="mb-4 text-center">Đổi nguyên liệu cấp thấp lấy nguyên liệu cấp cao.</p>
                        <div id="item-exchange-list" class="space-y-2 pb-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Detail Modal (No longer used for inventory hover) -->
        <div id="item-detail-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-md modal border border-gray-600 flex flex-col">
                <div id="item-detail-content" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow"></div>
                <div class="p-4 bg-gray-900 rounded-b-lg text-right flex-shrink-0">
                    <button onclick="hideModal('item-detail-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>
        
        <!-- Upgrade Confirmation Modal -->
        <div id="upgrade-confirm-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[70]">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-gray-600">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Xác nhận Cường hóa</h3>
                </div>
                <div id="upgrade-confirm-content" class="p-4 sm:p-6"></div>
                <div id="upgrade-confirm-buttons" class="p-4 bg-gray-900 rounded-b-lg flex justify-end space-x-4"></div>
            </div>
        </div>

        <!-- Dungeon Confirmation Modal -->
        <div id="dungeon-confirm-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[60]">
            <div class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg modal border border-gray-600">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 id="dungeon-confirm-title" class="text-xl sm:text-2xl font-bold text-yellow-400">Xác Nhận Luyện Công</h3>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="dungeon-confirm-summary" class="mb-4"></div>
                    <p class="text-gray-400 text-sm">Nhân vật sẽ tự động luyện công tại bản đồ này cho đến khi bạn dừng lại hoặc bị đánh bại.</p>
                </div>
                <div id="dungeon-confirm-buttons" class="p-4 bg-gray-900 rounded-b-lg flex justify-end space-x-4">
                    <!-- Button logic will be set by JS -->
                </div>
            </div>
        </div>
        
        <!-- [NEW] Tho Ren (Blacksmith) Modal -->
        <div id="tho-ren-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <!-- [MODIFIED] Thêm h-[85vh] và overflow-hidden để CỐ ĐỊNH khung, tránh bị nhảy kích thước -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-5xl modal border border-orange-600 flex flex-col h-[85vh] overflow-hidden">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-gray-700 flex justify-between items-center flex-shrink-0 bg-gray-900/80 backdrop-blur">
                    <h3 class="text-xl sm:text-2xl font-bold text-yellow-400">Thợ Rèn</h3>
                    <button onclick="hideModal('tho-ren-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
                
                <!-- Tab Headers -->
                <!-- [MODIFIED] Added glass effect and scrollbar hiding -->
                <div class="flex border-b border-gray-700 bg-black/40 backdrop-blur-sm overflow-x-auto flex-shrink-0 scrollbar-thin">
                    <button id="tab-cuong-hoa" onclick="switchThoRenTab('cuong-hoa')" class="flex-1 py-3 px-4 font-bold text-center tab-btn tab-active whitespace-nowrap">Cường Hóa</button>
                    <button id="tab-che-tao" onclick="switchThoRenTab('che-tao')" class="flex-1 py-3 px-4 font-bold text-center text-gray-400 tab-btn whitespace-nowrap">Chế Tạo</button>
                    <!-- [NEW] Thêm tab Tinh Phách (Luyện Hóa) -->
                    <button id="tab-tinh-phach" onclick="switchThoRenTab('tinh-phach')" class="flex-1 py-3 px-4 font-bold text-center text-gray-400 tab-btn whitespace-nowrap">Tinh Phách</button>
                    <!-- [NEW] Thêm tab Phù Phép (Enchant) -->
                    <button id="tab-phu-phep" onclick="switchThoRenTab('phu-phep')" class="flex-1 py-3 px-4 font-bold text-center text-gray-400 tab-btn whitespace-nowrap">Phù Phép</button>
                    <!-- [NEW] Thêm tab Hoàng Kim (Golden Upgrade) -->
                    <button id="tab-hoang-kim" onclick="switchThoRenTab('hoang-kim')" class="flex-1 py-3 px-4 font-bold text-center text-yellow-500 tab-btn whitespace-nowrap" style="text-shadow: 0 0 5px rgba(234, 179, 8, 0.5);">Hoàng Kim</button>
                </div>

                <!-- Tab Content: Cường Hóa (Upgrade) -->
                <!-- [MODIFIED] Xóa max-height cứng, dùng flex-grow để điền đầy khung -->
                <div id="panel-cuong-hoa" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel bg-gray-900/50">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- 1. Item List -->
                        <div class="md:col-span-1 h-full">
                            <h4 class="text-lg font-bold text-cyan-400 mb-2">Chọn Trang Bị</h4>
                            <!-- [MODIFIED] Added glass effect -->
                            <div id="upgrade-item-list" class="space-y-2 bg-black/20 backdrop-blur-sm p-2 rounded h-80 overflow-y-auto scrollbar-thin">
                                <!-- Items will be rendered here by JS -->
                            </div>
                        </div>
                        
                        <!-- 2. Upgrade Slot & Info -->
                        <div class="md:col-span-1 flex flex-col items-center">
                            <h4 class="text-lg font-bold text-cyan-400 mb-2">Thông Tin Cường Hóa</h4>
                            <!-- [MODIFIED] Added glass effect -->
                            <div id="upgrade-slot" class="bg-black/20 backdrop-blur-sm rounded p-4 w-full h-48 flex items-center justify-center mb-2 text-center border border-gray-600">
                                <span class="text-gray-500">Chọn vật phẩm...</span>
                            </div>
                            <!-- [MODIFIED] Added glass effect -->
                            <div class="bg-black/20 backdrop-blur-sm rounded p-4 w-full text-center border border-gray-600">
                                <p class="text-sm">Tỷ lệ thành công:</p>
                                <p id="upgrade-chance" class="font-bold text-2xl text-yellow-300 mb-2">--%</p>
                                <p class="text-sm">Chi phí (Ngân Lượng):</p>
                                <p id="upgrade-cost" class="font-bold text-lg text-gray-300 mb-3">--</p>
                                <div id="upgrade-materials" class="text-sm mb-4">
                                    <!-- Materials required will be shown here -->
                                </div>
                                <button id="perform-upgrade-btn" onclick="performUpgrade()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded opacity-50 cursor-not-allowed" disabled>
                                    Cường Hóa
                                </button>
                            </div>
                        </div>

                        <!-- 3. Owned Materials -->
                        <div class="md:col-span-1 h-full">
                             <h4 class="text-lg font-bold text-cyan-400 mb-2">Nguyên Liệu Sở Hữu</h4>
                             <!-- [MODIFIED] Added glass effect -->
                             <div id="upgrade-owned-materials" class="space-y-2 bg-black/20 backdrop-blur-sm p-2 rounded h-80 overflow-y-auto scrollbar-thin">
                                <!-- Owned materials will be rendered here by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Chế Tạo (Crafting) -->
                <!-- [MODIFIED] Xóa max-height cứng, thêm bg-gray-900/50 -->
                <div id="panel-che-tao" class="p-2 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-gray-900/50">
                    <div id="crafting-recipe-list" class="space-y-2">
                        <!-- Crafting recipes will be rendered here by JS (We need to modify the render function) -->
                    </div>
                </div>
                
                <!-- Tab Content: Tinh Phách (Refinement) -->
                <!-- [MODIFIED] Xóa max-height cứng, thêm bg-gray-900/50 -->
                <div id="panel-tinh-phach" class="p-2 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-gray-900/50">
                    <h4 class="text-lg font-bold text-cyan-400 mb-2 text-center">Hấp Thụ Tinh Phách</h4>
                    <p class="text-center text-gray-400 mb-4 text-sm">Hấp thụ Thủy Tinh để nhận chỉ số cộng thêm vĩnh viễn cho nhân vật.<br>Các chỉ số này được cộng dồn sau khi tính toán trang bị và kỹ năng.</p>
                    
                    <!-- Bonus Display -->
                    <!-- [MODIFIED] Added glass effect -->
                    <div class="bg-black/40 backdrop-blur-sm p-3 rounded-lg mb-4 max-w-xl mx-auto border border-gray-600">
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Chỉ Số Vĩnh Viễn Hiện Tại</h5>
                        <div id="tinh-phach-bonus-display" class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <!-- Gem List -->
                    <div id="tinh-phach-list" class="space-y-3 max-w-xl mx-auto">
                        <!-- Gem absorption blocks will be rendered here by JS (We need to modify the render function) -->
                    </div>
                </div>

                <!-- Tab Content: Phù Phép (Enchant) - Placeholder -->
                <!-- [MODIFIED] Xóa max-height cứng, thêm bg-gray-900/50 -->
                <div id="panel-phu-phep" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-gray-900/50">
                    <!-- ... existing content for enchant ... -->
                     <h4 class="text-lg font-bold text-cyan-400 mb-2 text-center">Phù Phép Trang Bị</h4>
                     <p class="text-center text-gray-400 mb-6 text-sm">Sử dụng các loại bùa chú cổ xưa để gia tăng sức mạnh bí ẩn cho trang bị.<br>Chức năng đang được nghiên cứu bởi các bậc thầy thợ rèn.</p>
                     <!-- ... existing placeholder UI ... -->
                     <div class="flex flex-col items-center justify-center h-64 bg-black/20 backdrop-blur-sm rounded-lg border border-dashed border-gray-600 max-w-2xl mx-auto">
                        <div class="text-center p-6">
                            <div class="mb-4 relative inline-block">
                                <i class="fa-solid fa-wand-magic-sparkles text-6xl text-gray-600"></i>
                                <i class="fa-solid fa-lock text-2xl text-yellow-600 absolute -bottom-2 -right-2 bg-gray-800 rounded-full p-1"></i>
                            </div>
                            <h5 class="text-xl font-bold text-gray-400 mb-2">Tính Năng Đang Phát Triển</h5>
                            <p class="text-sm text-gray-500">Quay lại sau khi bản cập nhật "Huyền Bí Chi Môn" được ra mắt.</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Hoàng Kim (Golden Upgrade) -->
                <!-- [MODIFIED] Xóa max-height cứng, thêm bg-gray-900/50 -->
                <div id="panel-hoang-kim" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow tab-panel hidden bg-gray-900/50">
                    <h4 class="text-lg font-bold text-yellow-400 mb-2 text-center uppercase tracking-widest text-shadow">Hoàng Kim Thần Trang</h4>
                    <p class="text-center text-gray-400 mb-6 text-sm">Sử dụng Đồ Phổ thất truyền để đúc lại trang bị, kích hoạt dòng thuộc tính Hoàng Kim ẩn giấu.</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                        <!-- Cột 1: Chọn Trang Bị -->
                        <div class="bg-black/20 backdrop-blur-sm border border-gray-700 p-3 rounded-lg flex flex-col max-h-[60vh]">
                            <h5 class="font-bold text-cyan-400 text-center mb-2 border-b border-gray-700 pb-2 flex-shrink-0">1. Chọn Trang Bị Gốc</h5>
                            <div id="hoang-kim-equip-list" class="space-y-2 flex-grow overflow-y-auto scrollbar-thin">
                                <!-- Danh sách trang bị sẽ render ở đây -->
                                <p class="text-center text-gray-500 text-xs mt-4">Chưa có trang bị phù hợp.</p>
                            </div>
                        </div>

                        <!-- Cột 2: Khu vực Hợp Thành (Center) -->
                        <div class="flex flex-col items-center justify-start space-y-4 py-4 overflow-y-auto scrollbar-thin">
                             <!-- Slot Trang Bị -->
                             <div id="hk-slot-equip" class="w-20 h-20 bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center relative cursor-pointer shadow-inner transition hover:border-cyan-400 flex-shrink-0">
                                <i class="fa-solid fa-shirt text-3xl text-gray-600"></i>
                                <span class="absolute -bottom-6 text-xs text-gray-400 whitespace-nowrap">Trang Bị</span>
                             </div>
                             
                             <i class="fa-solid fa-plus text-xl text-gray-500 flex-shrink-0"></i>
                             
                             <!-- Slot Đồ Phổ -->
                             <div id="hk-slot-blueprint" class="w-20 h-20 bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center relative cursor-pointer shadow-inner transition hover:border-yellow-400 flex-shrink-0">
                                <i class="fa-solid fa-scroll text-3xl text-gray-600"></i>
                                 <span class="absolute -bottom-6 text-xs text-gray-400 whitespace-nowrap">Đồ Phổ</span>
                             </div>
                             
                             <div class="my-2 flex-shrink-0">
                                <i class="fa-solid fa-angles-down text-2xl text-yellow-500 animate-bounce"></i>
                             </div>

                             <!-- Result Preview -->
                             <div class="bg-black/40 border border-yellow-600/30 p-4 rounded-lg text-center w-full shadow-[0_0_15px_rgba(234,179,8,0.1)] flex-shrink-0">
                                <p class="text-xs text-gray-400 mb-1">Kết quả dự kiến:</p>
                                <p id="hk-result-name" class="font-bold text-lg text-gray-600">???</p>
                                <div class="mt-3 pt-3 border-t border-gray-700 grid grid-cols-2 gap-2 text-xs">
                                    <p class="text-right text-gray-400">Tỷ lệ:</p>
                                    <p class="text-left font-bold text-green-400">100%</p>
                                    <p class="text-right text-gray-400">Chi phí:</p>
                                    <p id="hk-cost-display" class="text-left font-bold text-yellow-300">-- KNB</p>
                                </div>
                             </div>

                             <button id="btn-upgrade-hoang-kim" class="w-full bg-gradient-to-r from-yellow-700 to-yellow-600 hover:from-yellow-600 hover:to-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow-[0_0_15px_rgba(234,179,8,0.4)] border border-yellow-500/50 opacity-50 cursor-not-allowed transition transform hover:scale-105 active:scale-95 flex-shrink-0" disabled>
                                <i class="fa-solid fa-hammer mr-2"></i>Chế Tác Hoàng Kim
                             </button>
                        </div>

                        <!-- Cột 3: Chọn Đồ Phổ -->
                        <div class="bg-black/20 backdrop-blur-sm border border-gray-700 p-3 rounded-lg flex flex-col max-h-[60vh]">
                            <h5 class="font-bold text-yellow-300 text-center mb-2 border-b border-gray-700 pb-2 flex-shrink-0">2. Chọn Đồ Phổ</h5>
                            <div id="hoang-kim-blueprint-list" class="space-y-2 flex-grow overflow-y-auto scrollbar-thin">
                                <!-- Danh sách đồ phổ sẽ render ở đây -->
                                 <p class="text-center text-gray-500 text-xs mt-4">Chưa có Đồ Phổ nào.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
            <!-- [END FIX] -->
            </div>
        </div>
        
        <!-- [NEW] Tong Mon (Sect) Modal -->
        <div id="tong-mon-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <!-- [MODIFIED] Removed bg-gray-800 -->
            <div class="rounded-lg shadow-xl w-11/12 max-w-6xl modal border border-gray-600 flex flex-col">
                <div class="p-4 sm:p-6 border-b border-gray-700">
                    <h3 id="tong-mon-title" class="text-xl sm:text-2xl font-bold text-yellow-400">Khai Tông Lập Phái</h3>
                </div>

                <!-- Content Area -->
                <div id="tong-mon-content" class="p-4 sm:p-6 overflow-y-auto scrollbar-thin flex-grow" style="max-height: 75vh;">
                    <!-- [REMOVED] Đã xóa bảng "found-sect-panel" -->

                    <!-- [MODIFIED] Bảng điều khiển chính, đã xóa class 'hidden' -->
                    <div id="main-sect-panel" class="">
                        <!-- [MODIFIED] Simplified Tab Headers - Removed flex-1, added flex-grow and whitespace-nowrap for better wrapping -->
                        <!-- [MODIFIED] Xóa class 'bg-gray-900' -->
                        <div class="flex flex-wrap border-b border-gray-700 mb-4">
                            <button id="tab-chieu-mo" onclick="switchTongMonTab('chieu-mo')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm tab-btn tab-active">Chiêu Mộ</button>
                            <button id="tab-boi-duong" onclick="switchTongMonTab('boi-duong')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Bồi Dưỡng</button>
                            <button id="tab-nhiem-vu" onclick="switchTongMonTab('nhiem-vu')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Nhiệm Vụ</button>
                            <button id="tab-quan-ly" onclick="switchTongMonTab('quan-ly')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Quản Lý</button>
                            <button id="tab-thuong-kho" onclick="switchTongMonTab('thuong-kho')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Thương Khố</button>
                            <button id="tab-cua-hang-tm" onclick="switchTongMonTab('cua-hang-tm')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Cửa Hàng</button>
                            <button id="tab-thi-luyen-tm" onclick="switchTongMonTab('thi-luyen-tm')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Thí Luyện</button>
                            
                            <!-- [MODIFIED] GOM NHÓM: Xóa các tab riêng lẻ (Khiêu Chiến, Phó Bản, Chiến Trường) thay bằng tab Chinh Phạt -->
                            <button id="tab-chinh-phat" onclick="switchTongMonTab('chinh-phat')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-red-400 tab-btn"><i class="fa-solid fa-swords mr-1"></i>Chinh Phạt</button> 
                        
                            <!-- [MODIFIED] Đã XÓA tab Độ Thiên Kiếp vì đã hợp nhất vào Tu Tiên -->

                            <!-- [NEW] Tu Tiên Tab -->
                            <button id="tab-tu-tien" onclick="switchTongMonTab('tu-tien')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Tu Tiên</button>
                            <!-- [NEW] Bế Quan Tab -->
                            <button id="tab-be-quan" onclick="switchTongMonTab('be-quan')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Bế Quan</button>
                            <!-- [NEW] Phi Thăng Tab -->
                            <button id="tab-phi-thang" onclick="switchTongMonTab('phi-thang')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Phi Thăng</button>
                            <!-- [NEW] Truyền Công Tab -->
                            <button id="tab-truyen-cong" onclick="switchTongMonTab('truyen-cong')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Truyền Công</button>
                            <!-- [NEW] Hôn Phối Tab -->
                            <button id="tab-hon-phoi" onclick="switchTongMonTab('hon-phoi')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Hôn Phối</button>
                            
                            <!-- [NEW] Động Phủ Tab -->
                            <button id="tab-dong-phu" onclick="switchTongMonTab('dong-phu')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Động Phủ</button>
                        
                            <!-- [NEW] Lãnh Địa Tab -->
                            <button id="tab-lanh-dia" onclick="switchTongMonTab('lanh-dia')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Lãnh Địa</button>
                            <!-- [NEW] Lôi Đài Tab (Placeholder) -->
                            <button id="tab-loi-dai" onclick="switchTongMonTab('loi-dai')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Lôi Đài</button>
                            <!-- [RESTORED] Tông Môn Đại Trận Tab -->
                            <button id="tab-dai-tran" onclick="switchTongMonTab('dai-tran')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Đại Trận</button>
                            <!-- [NEW] Kinh Mạch Tab -->
                            <button id="tab-kinh-mach" onclick="switchTongMonTab('kinh-mach')" class="flex-grow whitespace-nowrap py-3 px-3 font-bold text-center text-sm text-gray-400 tab-btn">Kinh Mạch</button>
                        </div>

                    <!-- [MODIFIED] Tab Content: Chiêu Mộ Đệ Tử (UI UPGRADE) -->
                    <div id="panel-chieu-mo" class="tab-panel">
                        <!-- Decorative Header -->
                        <div class="text-center mb-6">
                            <h4 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-orange-400 to-yellow-300 text-shadow-gold uppercase tracking-widest">Chiêu Mộ Các</h4>
                            <div class="h-1 w-32 mx-auto bg-gradient-to-r from-transparent via-yellow-500 to-transparent mt-1"></div>
                        </div>

                        <!-- Main Recruitment Area -->
                        <div class="relative bg-black/40 backdrop-blur-md border border-yellow-600/30 p-6 rounded-xl shadow-[0_0_20px_rgba(234,179,8,0.1)] overflow-hidden">
                            <!-- Background Ornament -->
                            <i class="fa-solid fa-users absolute -top-6 -right-6 text-9xl text-white/5 transform rotate-12 pointer-events-none"></i>
                            
                            <!-- Info Row -->
                            <div class="flex justify-between items-center mb-8 relative z-10">
                                <div class="bg-black/50 px-4 py-2 rounded-full border border-gray-600 flex items-center gap-2 shadow-sm">
                                    <i class="fa-solid fa-users text-gray-400"></i>
                                    <span class="text-gray-300 text-sm">Đệ tử:</span>
                                    <span class="text-white font-bold"><span id="sect-current-members-recruit" class="text-yellow-300 text-lg">0</span> / <span id="sect-max-members-recruit">5</span></span>
                                </div>
                                
                                <button onclick="document.getElementById('recruit-rates-table').classList.remove('hidden')" class="text-xs text-cyan-400 hover:text-cyan-300 underline decoration-dashed transition flex items-center gap-1 bg-black/30 px-2 py-1 rounded hover:bg-black/50">
                                    <i class="fa-solid fa-circle-info"></i> Tỉ Lệ Xuất Hiện
                                </button>
                            </div>

                            <!-- Center Summon Button -->
                            <div class="flex flex-col items-center justify-center relative z-10 my-4">
                                <div class="w-36 h-36 relative group cursor-pointer">
                                    <!-- Outer spinning ring -->
                                    <div class="absolute inset-0 rounded-full border-2 border-dashed border-yellow-600/30 animate-spin-slow group-hover:border-yellow-400/60 transition duration-500"></div>
                                    <div class="absolute inset-2 rounded-full border border-yellow-600/20 animate-spin-slow" style="animation-direction: reverse; animation-duration: 15s;"></div>
                                    
                                    <!-- Inner button -->
                                    <div class="absolute inset-4 rounded-full bg-gradient-to-b from-gray-800 to-black border border-yellow-500/50 shadow-[0_0_30px_rgba(234,179,8,0.1)] group-hover:shadow-[0_0_50px_rgba(234,179,8,0.4)] transition duration-300 flex items-center justify-center overflow-hidden">
                                        <!-- Button Effect -->
                                        <div class="absolute inset-0 bg-gradient-to-t from-yellow-500/10 to-transparent opacity-0 group-hover:opacity-100 transition duration-300"></div>
                                        
                                        <button id="recruit-disciple-btn" onclick="recruitDisciple()" class="w-full h-full rounded-full flex flex-col items-center justify-center text-yellow-100 font-bold tracking-wider hover:text-white transition z-10 focus:outline-none disabled:grayscale disabled:cursor-not-allowed">
                                            <i class="fa-solid fa-user-plus text-3xl mb-1 text-yellow-400 group-hover:scale-110 transition duration-300"></i>
                                            <span class="text-xs uppercase">Chiêu Mộ</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Cost Display -->
                                <div class="mt-6 bg-black/60 px-5 py-2 rounded-full border border-gray-700 flex items-center gap-2 shadow-inner">
                                    <span class="text-gray-400 text-xs uppercase tracking-wide">Chi phí</span>
                                    <span class="text-yellow-400 font-bold font-mono">200,000,000 NL</span>
                                </div>

                                <p id="recruit-limit-msg" class="text-xs text-red-400 mt-3 font-bold bg-black/80 px-3 py-1 rounded border border-red-900/50 hidden animate-pulse">
                                    <i class="fa-solid fa-ban mr-1"></i> Đã đạt giới hạn số lượng đệ tử
                                </p>
                            </div>

                            <!-- Rates Table Overlay (Hidden by default) -->
                            <div id="recruit-rates-table" class="hidden absolute inset-0 bg-gray-900/95 z-20 p-4 flex flex-col justify-center items-center animate-fade-in backdrop-blur-md">
                                <div class="w-full max-w-sm border border-gray-700 rounded-lg p-4 bg-black/40 max-h-[90%] overflow-y-auto scrollbar-thin">
                                    <h5 class="font-bold text-yellow-300 mb-4 border-b border-gray-600 pb-2 w-full text-center text-lg uppercase tracking-wider">Tỉ Lệ Thiên Cơ</h5>
                                    
                                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs w-full">
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-500">Yếu Kém</span> <span class="font-mono text-gray-400">40%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-400">Bình Thường</span> <span class="font-mono text-gray-300">30%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-blue-400">Khá</span> <span class="font-mono text-blue-300">15%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-purple-400">Tốt</span> <span class="font-mono text-purple-300">10%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-genius">Thiên Tài</span> <span class="font-mono text-yellow-300">3.5%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-peerless">Tuyệt Thế</span> <span class="font-mono text-red-400">1%</span></div>
                                        
                                        <div class="col-span-2 h-2"></div> <!-- Spacer -->
                                        
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-heavenly">Thiên Kiêu</span> <span class="font-mono text-orange-300">0.3%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-defying">Nghịch Thiên</span> <span class="font-mono text-fuchsia-300">0.1%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-dao">Vô Cực</span> <span class="font-mono text-cyan-300">0.05%</span></div>
                                        
                                        <!-- [MODIFIED] Added missing high tiers -->
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-ancestor">Vạn Đạo</span> <span class="font-mono text-pink-300">0.03%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-trueself">Chân Ngã</span> <span class="font-mono text-white">0.015%</span></div>
                                        <div class="flex justify-between border-b border-gray-800 pb-1"><span class="name-potential-eternal">Vĩnh Hằng</span> <span class="font-mono text-emerald-300">0.005%</span></div>
                                    </div>
                                    
                                    <p class="text-[10px] text-gray-500 mt-4 italic text-center">
                                        * Nâng cấp <strong>Tụ Linh Trận</strong> để loại bỏ các phẩm chất thấp.
                                    </p>
                                    
                                    <button onclick="document.getElementById('recruit-rates-table').classList.add('hidden')" class="mt-4 w-full py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-xs font-bold transition">Đóng</button>
                                </div>
                            </div>
                        </div>

                         <!-- Log Section -->
                         <div class="mt-6">
                             <h4 class="text-sm font-bold text-gray-400 mb-2 flex items-center gap-2 uppercase tracking-wide pl-1 border-l-4 border-cyan-500">
                                 Nhật Ký Chiêu Mộ
                             </h4>
                             <div id="sect-log-recruit" class="bg-black/20 border border-gray-700/50 p-3 rounded-lg h-40 overflow-y-auto scrollbar-thin text-xs font-mono shadow-inner">
                                <!-- Sect activity log -->
                             </div>
                        </div>
                    </div>

                        <!-- [MODIFIED] Tab Content: Bồi Dưỡng Đệ Tử -->
                        <div id="panel-boi-duong" class="tab-panel hidden">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-bold text-cyan-400">Danh Sách Đệ Tử</h4>
                                <button onclick="startTuLuyenAll()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-sm">
                                    <i class="fa-solid fa-users mr-2"></i>Tu Luyện Tất Cả
                                </button>
                            </div>
                            <div id="disciple-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Disciple cards will be rendered here -->
                                <p class="text-gray-400 md:col-span-2 lg:col-span-3 text-center">Chưa có đệ tử nào.</p>
                            </div>
                             <!-- Placeholder for future training/mission assignment -->
                             <h4 class="text-lg font-bold text-cyan-400 mt-6 mb-4">Hoạt Động (Chưa Mở)</h4>
                             <p class="text-gray-500 text-center">Giao nhiệm vụ và bồi dưỡng đệ tử sẽ được thêm sau.</p>
                        </div>

                        <!-- [NEW] Tab Content: Nhiệm vụ Tông môn -->
                        <div id="panel-nhiem-vu" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Nhiệm vụ Tông môn</h4>
                            
                            <!-- [NEW] Active Missions Header with Claim All Button -->
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-bold text-yellow-300">Đệ tử đang làm nhiệm vụ:</h5>
                                <div id="sect-mission-claim-all-container">
                                    <!-- Nút Nhận Thưởng Nhanh sẽ được render tại đây bởi JS -->
                                </div>
                            </div>
                            
                            <!-- [MODIFIED] Chuyển sang Grid 2 cột -->
                            <div id="active-mission-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                                <p class="text-center text-gray-400 col-span-full">Không có đệ tử nào đang làm nhiệm vụ.</p>
                            </div>

                            <!-- [NEW] Available Missions -->
                            <!-- [MODIFIED] Added auto-assign button -->
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-bold text-yellow-300">Nhiệm vụ có sẵn:</h5>
                                <button onclick="autoAssignMissions()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm">
                                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Giao Phó Tự Động
                                </button>
                            </div>
                            <!-- [MODIFIED] Chuyển sang Grid 2 cột -->
                            <div id="available-mission-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <p class="text-center text-gray-400 col-span-full">Đang tải danh sách nhiệm vụ...</p>
                            </div>
                        </div>
                        
                        <!-- [NEW] Tab Content: Quản lý Tông môn -->
                        <div id="panel-quan-ly" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Quản lý Tông môn</h4>
                            <p class="text-gray-400 text-center">Chức năng đang được phát triển.</p>
                        </div>
                        
                        <!-- [NEW] Tab Content: Thương khố Tông môn -->
                <div id="panel-thuong-kho" class="tab-panel hidden">
                    <h4 class="text-lg font-bold text-cyan-400 mb-4">Thương khố Tông môn</h4>
                    <p class="text-gray-400 text-center mb-4">Gửi vật phẩm từ hành trang cá nhân vào kho chung của Tông Môn, hoặc rút vật phẩm từ kho về hành trang.</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- Cột 1: Thương Khố Tông Môn -->
                        <div class="bg-gray-900 p-4 rounded-lg">
                            <h5 class="font-bold text-yellow-400 text-center mb-3">Vật Phẩm Trong Kho</h5>
                            <!-- [NEW] Nội dung kho sẽ được render ở đây -->
                            <div id="sect-warehouse-display" class="space-y-4" style="max-height: 50vh; overflow-y: auto;">
                                <!-- Rendered by JS -->
                            </div>
                        </div>

                        <!-- Cột 2: Hành Trang Cá Nhân -->
                        <div class="bg-gray-900 p-4 rounded-lg">
                            <h5 class="font-bold text-cyan-400 text-center mb-3">Hành Trang Cá Nhân</h5>
                            <!-- [NEW] Nội dung hành trang sẽ được render ở đây -->
                            <div id="player-inventory-display-for-sect" class="space-y-4" style="max-height: 50vh; overflow-y: auto;">
                                <!-- Rendered by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- [NEW] Tab Content: Cửa hàng Tông môn -->
                        <div id="panel-cua-hang-tm" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Cửa hàng Tông môn</h4>
                            <!-- [NEW] Add DCH display -->
                            <p class="text-center text-gray-300 mb-4">Dùng Điểm Cống Hiến (ĐCH) để mua vật phẩm.</p>
                            <p class="text-center text-gray-300 mb-4">Điểm Cống Hiến hiện có: <span id="sect-shop-dch-display" class="font-bold text-lime-400">0</span></p>
                            <!-- [NEW] Add shop list container -->
                            <div id="sect-shop-list" class="space-y-3">
                                <!-- Shop items will be rendered here -->
                            </div>
                        </div>
                        
                        <!-- [NEW] Tab Content: Tông Môn Thí Luyện -->
                        <div id="panel-thi-luyen-tm" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Tông Môn Thí Luyện</h4>
                            <p class="text-gray-400 text-center">Chức năng đang được phát triển.</p>
                        </div>

                        <!-- [NEW] Tab Content: Chinh Phạt (Gom nhóm Khiêu Chiến, Phó Bản, Chiến Trường) -->
                        <div id="panel-chinh-phat" class="tab-panel hidden">
                            <!-- Sub-navigation -->
                            <!-- [FIX UI] Chuyển sang flex-wrap để tự động xuống dòng nếu không đủ chỗ -->
                            <!-- Xóa overflow-x-auto, thêm flex-wrap -->
                            <div class="flex flex-wrap justify-center gap-2 sm:gap-3 mb-6 border-b border-gray-700/50 pb-4 w-full px-2">
                                <button onclick="switchChinhPhatSubTab('khieu-chien-tm')" id="subtab-khieu-chien-tm" class="subtab-btn px-3 py-2 rounded-full text-sm font-bold bg-gray-700 text-gray-400 hover:bg-gray-600 whitespace-nowrap transition-all shadow-sm hover:shadow-md border border-transparent hover:border-gray-500">
                                    <i class="fa-solid fa-khanda mr-2"></i>Khiêu Chiến
                                </button>
                                <button onclick="switchChinhPhatSubTab('pho-ban')" id="subtab-pho-ban" class="subtab-btn px-3 py-2 rounded-full text-sm font-bold bg-gray-700 text-gray-400 hover:bg-gray-600 whitespace-nowrap transition-all shadow-sm hover:shadow-md border border-transparent hover:border-gray-500">
                                    <i class="fa-solid fa-dungeon mr-2"></i>Phó Bản
                                </button>
                                <button onclick="switchChinhPhatSubTab('chien-truong')" id="subtab-chien-truong" class="subtab-btn px-3 py-2 rounded-full text-sm font-bold bg-gray-700 text-gray-400 hover:bg-gray-600 whitespace-nowrap transition-all shadow-sm hover:shadow-md border border-transparent hover:border-gray-500">
                                    <i class="fa-solid fa-flag-checkered mr-2"></i>Chiến Trường
                                </button>
                                <!-- [NEW] Tab Võ Đài Thần Ma -->
                                <button onclick="switchChinhPhatSubTab('vo-dai-than-ma')" id="subtab-vo-dai-than-ma" class="subtab-btn px-3 py-2 rounded-full text-sm font-bold bg-gray-700 text-gray-400 hover:bg-gray-600 whitespace-nowrap transition-all shadow-sm hover:shadow-md border border-transparent hover:border-gray-500">
                                    <i class="fa-solid fa-skull mr-2"></i>Võ Đài Thần Ma
                                </button>
                                <!-- [NEW] Tab Ám Ảnh Kiếm Ảnh -->
                                <button onclick="switchChinhPhatSubTab('am-anh-kiem-anh')" id="subtab-am-anh-kiem-anh" class="subtab-btn px-3 py-2 rounded-full text-sm font-bold bg-gray-700 text-gray-400 hover:bg-gray-600 whitespace-nowrap transition-all shadow-sm hover:shadow-md border border-transparent hover:border-gray-500">
                                    <i class="fa-solid fa-user-secret mr-2"></i>Ám Ảnh Kiếm Ảnh
                                </button>
                                <!-- [NEW] Tab Bách Thắng Danh Tướng -->
                                <button onclick="switchChinhPhatSubTab('bach-thang')" id="subtab-bach-thang" class="subtab-btn px-3 py-2 rounded-full text-sm font-bold bg-gray-700 text-gray-400 hover:bg-gray-600 whitespace-nowrap transition-all shadow-sm hover:shadow-md border border-transparent hover:border-gray-500">
                                    <i class="fa-solid fa-trophy mr-2"></i>Bách Thắng Danh Tướng
                                </button>
                            </div>

                            <!-- Containers for Sub-contents (Previously top-level panels) -->
                            <div id="panel-khieu-chien-tm" class="subtab-content hidden">
                                <!-- Content rendered by renderSectChallengePanel -->
                            </div>
                            <div id="panel-pho-ban" class="subtab-content hidden">
                                <!-- Content rendered by renderPhoBanPanel -->
                            </div>
                            <div id="panel-chien-truong" class="subtab-content hidden">
                                <!-- Content rendered by renderChienTruongPanel -->
                            </div>
                            <!-- [NEW] Container for Vo Dai Than Ma -->
                            <div id="panel-vo-dai-than-ma" class="subtab-content hidden">
                                <!-- Content rendered by renderVoDaiThanMaPanel -->
                            </div>
                            <!-- [NEW] Container for Am Anh Kiem Anh -->
                            <div id="panel-am-anh-kiem-anh" class="subtab-content hidden">
                                <!-- Content rendered by renderAmAnhKiemAnhPanel -->
                            </div>
                            <!-- [NEW] Container for Bach Thang Danh Tuong -->
                            <div id="panel-bach-thang" class="subtab-content hidden">
                                <!-- Content rendered by renderBachThangPanel -->
                            </div>
                        </div>

                        <!-- [NEW] Tab Content: Độ Thiên Kiếp -->
                        <div id="panel-do-thien-kiep" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Độ Thiên Kiếp</h4>
                            <p class="text-gray-400 text-center">Chức năng đang được phát triển.</p>
                        </div>

                        <!-- [MODIFIED] Tab Content: Tu Tiên -->
                        <div id="panel-tu-tien" class="tab-panel hidden">
                            <!-- Content will be rendered by renderTuTienPanel() -->
                        </div>

                        <!-- [NEW] Tab Content: Bế Quan -->
                        <div id="panel-be-quan" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Bế Quan</h4>
                            <p class="text-gray-400 text-center">Chức năng đang được phát triển.</p>
                        </div>

                        <!-- [NEW] Tab Content: Phi Thăng -->
                        <div id="panel-phi-thang" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Phi Thăng</h4>
                            <p class="text-gray-400 text-center">Chức năng đang được phát triển.</p>
                        </div>

                        <!-- [NEW] Tab Content: Truyền Công -->
                        <div id="panel-truyen-cong" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Truyền Công</h4>
                            <p class="text-gray-400 text-center">Chức năng đang được phát triển.</p>
                        </div>

                        <!-- [NEW] Tab Content: Hôn Phối -->
                        <div id="panel-hon-phoi" class="tab-panel hidden">
                            <!-- Content will be rendered by renderHonPhoiPanel() -->
                        </div>

                        <!-- [REMOVED] Đã xóa Panel Luyện Đan -->

                        <!-- [NEW] Tab Content: Động Phủ -->
                        <div id="panel-dong-phu" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Động Phủ Tông Môn</h4>
                            <p class="text-gray-400 text-center">Chức năng Động Phủ đang được phát triển.</p>
                        </div>

                        <!-- [NEW] Tab Content: Linh Trì -->
                        <div id="panel-linh-tri" class="tab-panel hidden">
                            <!-- Nội dung sẽ được render bởi renderLinhTriPanel() -->
                        </div>

                        <!-- [NEW] Tab Content: Lãnh Địa -->
                        <div id="panel-lanh-dia" class="tab-panel hidden">
                            <!-- Content will be rendered by renderLanhDiaPanel() -->
                        </div>

                        <!-- [NEW] Tab Content: Lôi Đài -->
                        <div id="panel-loi-dai" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Lôi Đài Tông Môn</h4>
                            <p class="text-gray-400 text-center">Chức năng Lôi Đài đang được phát triển.</p>
                        </div>

                        <!-- [NEW] Tab Content: Phó Bản -->
                        <div id="panel-pho-ban" class="tab-panel hidden">
                            <h4 class="text-lg font-bold text-cyan-400 mb-4">Phó Bản Tông Môn</h4>
                            <p class="text-gray-400 text-center">Chức năng Phó Bản đang được phát triển.</p>
                        </div>

                        <!-- [NEW] Tab Content: Chiến Trường -->
                        <div id="panel-chien-truong" class="tab-panel hidden">
                            <!-- Nội dung sẽ được render bởi renderChienTruongPanel() -->
                        </div>

                        <!-- [RESTORED] Tab Content: Tông Môn Đại Trận -->
                        <div id="panel-dai-tran" class="tab-panel hidden">
                            <!-- Content rendered by JS -->
                        </div>

                        <!-- [NEW] Tab Content: Kinh Mạch -->
                        <div id="panel-kinh-mach" class="tab-panel hidden">
                            <!-- Content rendered by JS -->
                        </div>

                        <!-- Removed old panels: tong-quan, nhiem-vu, nang-cap -->

                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 bg-gray-900 rounded-b-lg text-right flex-shrink-0">
                    <button onclick="hideModal('tong-mon-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                </div>
            </div>
        </div>

        <!-- ... other modals ... -->
    </div>
    
    <!-- [NEW] Item Tooltip Element (WAS MISSING) -->
    <div id="item-tooltip"></div>
    
    <!-- [NEW] Toast Notification Element -->
    <div id="toast" class="hidden"></div>

    <script>
        // --- GAME CONSTANTS ---
        const GAME_TICK_MS = 200; // Combat tick speed in milliseconds
        const MAX_LOG_LINES = 200;
        const MAX_INVENTORY_SLOTS = 300; // [MODIFIED] Đã tăng từ 50 lên 300
        const MAX_STACK_SIZE = 50000; // [MODIFIED] Đã tăng từ 500 lên 50000
        const MAX_MENH_CACH_LEVEL = 30; // [MODIFIED] Cấp tối đa cho Mệnh Cách tăng lên 30

        // [NEW] Cultivation Realms Database (Cảnh Giới)
        // [MODIFIED] Rebalanced bonus stats to meet new max targets:
        // Max (Thánh Nhân): 500M HP, 150M ATK, 150M DEF, 150M SPD
        // [MODIFIED] Tăng chi phí đột phá (breakthroughCost) VÀ Max Tu Vi gấp 100 lần (Hardcore Mode)
        const CANH_GIOI_DB = {
            'pham_nhan': {
                id: 'pham_nhan', name: 'Phàm Nhân', level: 0, nextRealm: 'luyen_khi',
                maxTuVi: 10000, // 100 -> 10,000
                tuViPerClick: 1000, linhKhiPerClick: 1000, breakthroughCost: 50000, // x100 rates
                bonusStats: { hp: 0, atk: 0, def: 0 }
            },
            'luyen_khi': {
                id: 'luyen_khi', name: 'Luyện Khí', level: 1, nextRealm: 'truc_co',
                maxTuVi: 100000, // 1,000 -> 100,000
                tuViPerClick: 2000, linhKhiPerClick: 5000, breakthroughCost: 500000, 
                bonusStats: { hp: 10000, atk: 2000, def: 1000, spd: 1000 }
            },
            'truc_co': {
                id: 'truc_co', name: 'Trúc Cơ', level: 2, nextRealm: 'kim_dan',
                maxTuVi: 500000, // 5,000 -> 500,000
                tuViPerClick: 5000, linhKhiPerClick: 10000, breakthroughCost: 2500000,
                bonusStats: { hp: 50000, atk: 10000, def: 5000, spd: 5000, critChance: 1, critDamage: 10 }
            },
            'kim_dan': {
                id: 'kim_dan', name: 'Kim Đan', level: 3, nextRealm: 'nguyen_anh',
                maxTuVi: 2000000, // 20,000 -> 2,000,000
                tuViPerClick: 10000, linhKhiPerClick: 20000, breakthroughCost: 10000000,
                bonusStats: { hp: 200000, atk: 40000, def: 20000, spd: 20000, critChance: 2, critDamage: 20 }
            },
            'nguyen_anh': {
                id: 'nguyen_anh', name: 'Nguyên Anh', level: 4, nextRealm: 'hoa_than',
                maxTuVi: 10000000, // 100,000 -> 10,000,000
                tuViPerClick: 25000, linhKhiPerClick: 100000, breakthroughCost: 50000000,
                bonusStats: { hp: 1000000, atk: 200000, def: 100000, spd: 100000, critChance: 3, critDamage: 50 }
            },
            'hoa_than': {
                id: 'hoa_than', name: 'Hóa Thần', level: 5, nextRealm: 'dai_thua',
                maxTuVi: 50000000, // 500,000 -> 50,000,000
                tuViPerClick: 50000, linhKhiPerClick: 500000, breakthroughCost: 200000000,
                bonusStats: { hp: 5000000, atk: 1000000, def: 500000, spd: 500000, critChance: 4, critDamage: 100 }
            },
            'dai_thua': {
                id: 'dai_thua', name: 'Đại Thừa', level: 6, nextRealm: 'do_kiep',
                maxTuVi: 200000000, // 2M -> 200M
                tuViPerClick: 100000, linhKhiPerClick: 2000000, breakthroughCost: 1000000000,
                bonusStats: { hp: 20000000, atk: 4000000, def: 2000000, spd: 2000000, critChance: 5, critDamage: 200 }
            },
            'do_kiep': {
                id: 'do_kiep', name: 'Độ Kiếp', level: 7, nextRealm: 'hu_tien',
                maxTuVi: 1000000000, // 10M -> 1 Tỷ
                tuViPerClick: 250000, linhKhiPerClick: 5000000, breakthroughCost: 5000000000,
                bonusStats: { hp: 50000000, atk: 10000000, def: 5000000, spd: 5000000, critChance: 6, critDamage: 300, lifesteal: 1 }
            },
            'hu_tien': {
                id: 'hu_tien', name: 'Hư Tiên', level: 8, nextRealm: 'chan_tien',
                maxTuVi: 5000000000, // 50M -> 5 Tỷ
                tuViPerClick: 600000, linhKhiPerClick: 10000000, breakthroughCost: 20000000000,
                bonusStats: { hp: 80000000, atk: 20000000, def: 10000000, spd: 10000000, critChance: 7, critDamage: 400, lifesteal: 2 }
            },
            'chan_tien': {
                id: 'chan_tien', name: 'Chân Tiên', level: 9, nextRealm: 'kim_tien',
                maxTuVi: 20000000000, // 200M -> 20 Tỷ
                tuViPerClick: 1500000, linhKhiPerClick: 20000000, breakthroughCost: 50000000000,
                bonusStats: { hp: 120000000, atk: 30000000, def: 20000000, spd: 20000000, critChance: 8, critDamage: 500, lifesteal: 3, ignoreDef_p: 5 }
            },
            'kim_tien': {
                id: 'kim_tien', name: 'Kim Tiên', level: 10, nextRealm: 'huyen_tien',
                maxTuVi: 100000000000, // 1 Tỷ -> 100 Tỷ
                tuViPerClick: 4000000, linhKhiPerClick: 50000000, breakthroughCost: 200000000000,
                bonusStats: { hp: 180000000, atk: 45000000, def: 30000000, spd: 30000000, critChance: 10, critDamage: 700, lifesteal: 4, ignoreDef_p: 10 }
            },
            'huyen_tien': {
                id: 'huyen_tien', name: 'Huyền Tiên', level: 11, nextRealm: 'thai_at_tien',
                maxTuVi: 500000000000, // 5 Tỷ -> 500 Tỷ
                tuViPerClick: 10000000, linhKhiPerClick: 100000000, breakthroughCost: 1000000000000,
                bonusStats: { hp: 250000000, atk: 65000000, def: 50000000, spd: 50000000, critChance: 12, critDamage: 1000, lifesteal: 5, ignoreDef_p: 15 }
            },
            'thai_at_tien': {
                id: 'thai_at_tien', name: 'Thái Ất Tiên', level: 12, nextRealm: 'dai_la_kim_tien',
                maxTuVi: 2500000000000, // 25 Tỷ -> 2,500 Tỷ
                tuViPerClick: 30000000, linhKhiPerClick: 250000000, breakthroughCost: 5000000000000,
                bonusStats: { hp: 350000000, atk: 90000000, def: 80000000, spd: 80000000, critChance: 15, critDamage: 1500, lifesteal: 6, ignoreDef_p: 20, manasteal: 5 }
            },
            'dai_la_kim_tien': {
                id: 'dai_la_kim_tien', name: 'Đại La Kim Tiên', level: 13, nextRealm: 'thanh_nhan',
                maxTuVi: 10000000000000, // 100 Tỷ -> 10,000 Tỷ
                tuViPerClick: 100000000, linhKhiPerClick: 500000000, breakthroughCost: 20000000000000,
                bonusStats: { hp: 420000000, atk: 120000000, def: 110000000, spd: 110000000, critChance: 20, critDamage: 2000, lifesteal: 7, ignoreDef_p: 25, manasteal: 10 }
            },
            'thanh_nhan': {
                id: 'thanh_nhan', name: 'Thánh Nhân', level: 14, nextRealm: null,
                maxTuVi: 100000000000000, // 1000 Tỷ -> 100,000 Tỷ
                tuViPerClick: 500000000, linhKhiPerClick: 2000000000, breakthroughCost: 0,
                // [TARGET] HP 500M, ATK 150M, DEF 150M, SPD 150M
                bonusStats: { hp: 500000000, atk: 150000000, def: 150000000, spd: 150000000, critChance: 25, critDamage: 3000, lifesteal: 10, ignoreDef_p: 30, manasteal: 20 }
            }
        };

        // [NEW] Be Quan (AFK Cultivation) Rates Database
        // [MODIFIED] Increased rates by 100x to match new caps
        const BE_QUAN_RATES_DB = {
            'pham_nhan': { tuViPerHour: 1000, linhKhiPerHour: 10000 },
            'luyen_khi': { tuViPerHour: 2000, linhKhiPerHour: 50000 },
            'truc_co': { tuViPerHour: 5000, linhKhiPerHour: 120000 },
            'kim_dan': { tuViPerHour: 10000, linhKhiPerHour: 300000 },
            'nguyen_anh': { tuViPerHour: 25000, linhKhiPerHour: 800000 },
            'hoa_than': { tuViPerHour: 50000, linhKhiPerHour: 2000000 },
            'dai_thua': { tuViPerHour: 100000, linhKhiPerHour: 5000000 },
            'do_kiep': { tuViPerHour: 250000, linhKhiPerHour: 12000000 },
            'hu_tien': { tuViPerHour: 600000, linhKhiPerHour: 30000000 },
            'chan_tien': { tuViPerHour: 1500000, linhKhiPerHour: 80000000 },
            'kim_tien': { tuViPerHour: 4000000, linhKhiPerHour: 200000000 },
            'huyen_tien': { tuViPerHour: 10000000, linhKhiPerHour: 500000000 },
            'thai_at_tien': { tuViPerHour: 30000000, linhKhiPerHour: 1500000000 },
            'dai_la_kim_tien': { tuViPerHour: 100000000, linhKhiPerHour: 5000000000 },
            'thanh_nhan': { tuViPerHour: 500000000, linhKhiPerHour: 20000000000 }
        };

        // [NEW] Sect Level Upgrade Database
        const SECT_LEVEL_DB = {
            // Key is the *next* level to reach
            2: { costNL: 10000000, costDCH: 100, bonusDesc: '+1 Giới hạn Đệ tử' }, // 10M NL, 100 DCH
            3: { costNL: 25000000, costDCH: 250, bonusDesc: '+1 Giới hạn Đệ tử' }, // 25M NL, 250 DCH
            4: { costNL: 50000000, costDCH: 500, bonusDesc: '+1 Giới hạn Đệ tử' }, // 50M NL, 500 DCH
            5: { costNL: 100000000, costDCH: 1000, bonusDesc: '+2 Giới hạn Đệ tử' } // 100M NL, 1000 DCH [MODIFIED] Removed max: true
            // Levels 6-50 will be auto-generated below
        };

        // [NEW] Auto-generate Sect Levels from 6 to 50
        (function() {
            let lastCostNL = 100000000;
            let lastCostDCH = 1000;
            const costMultiplier = 1.1; // Using a 10% cost increase per level

            for (let level = 6; level <= 50; level++) {
                lastCostNL = Math.floor(lastCostNL * costMultiplier);
                lastCostDCH = Math.floor(lastCostDCH * costMultiplier);
                
                let bonusDesc = '+1 Giới hạn Đệ tử';
                if (level % 5 === 0) {
                    bonusDesc = '+2 Giới hạn Đệ tử'; // Bonus every 5 levels
                }
                
                SECT_LEVEL_DB[level] = {
                    costNL: lastCostNL,
                    costDCH: lastCostDCH,
                    bonusDesc: bonusDesc
                };
            }
            // Max flag is no longer needed, logic will check for undefined next level
        })();

        // [NEW] Song Tu (Dual Cultivation) Tiers Database
        const SONG_TU_DB = {
            'tier_1': {
                id: 'tier_1',
                name: 'Song Tu Sơ Cấp',
                levelReq: 1, // Average level of the two disciples
                durationMs: 1 * 60 * 60 * 1000, // 1 giờ
                costLinhThach: 2000, // [MODIFIED] 2.000
                rewardXp: 50000000 // [MODIFIED] 50 Triệu XP
            },
            'tier_2': {
                id: 'tier_2',
                name: 'Song Tu Trung Cấp',
                levelReq: 40, // Average level 40+
                durationMs: 4 * 60 * 60 * 1000, // 4 giờ
                costLinhThach: 15000, // [MODIFIED] 15.000
                rewardXp: 500000000 // [MODIFIED] 500 Triệu XP
            },
            'tier_3': {
                id: 'tier_3',
                name: 'Song Tu Cao Cấp',
                levelReq: 80, // Average level 80+
                durationMs: 12 * 60 * 60 * 1000, // 12 giờ
                costLinhThach: 60000, // [MODIFIED] 60.000
                rewardXp: 2500000000 // [MODIFIED] 2.5 Tỷ XP
            }
        };

        // [NEW] Lanh Dia (Territory) Database
        const LANH_DIA_DB = {
            'territory_1': {
                id: 'territory_1', name: 'Mỏ Sắt Hắc Thiết', desc: 'Một mỏ sắt vô chủ, sản sinh Linh Thạch.',
                icon: 'fa-solid fa-mountain-city',
                powerReq: 250000, // 250k Power
                captureTimeMs: 1 * 60 * 60 * 1000, // 1 giờ
                reward: 'linhThach', ratePerHour: 5, capacity: 120 // 5/hr, max 120
            },
            'territory_2': {
                id: 'territory_2', name: 'Thảo Nguyên Linh Khí', desc: 'Đồng cỏ tràn ngập linh khí, sản sinh Linh Khí.',
                icon: 'fa-solid fa-leaf',
                powerReq: 750000, // 750k Power
                captureTimeMs: 4 * 60 * 60 * 1000, // 4 giờ
                reward: 'linhKhi', ratePerHour: 500, capacity: 4800 // 500/hr, max 4800
            },
            'territory_3': {
                id: 'territory_3', name: 'Cổ Đạo Cống Phẩm', desc: 'Một con đường buôn bán cổ, thỉnh thoảng nhặt được cống phẩm.',
                icon: 'fa-solid fa-map-signs',
                powerReq: 2000000, // 2M Power
                captureTimeMs: 8 * 60 * 60 * 1000, // 8 giờ
                reward: 'diemCongHien', ratePerHour: 2, capacity: 48 // 2/hr, max 48
            },
            'territory_4': {
                id: 'territory_4', name: 'Xưởng Rèn Bỏ Hoang', desc: 'Một xưởng rèn cũ, vẫn có thể tìm thấy Đá Cường Hóa.',
                icon: 'fa-solid fa-hammer',
                powerReq: 5000000, // 5M Power
                captureTimeMs: 12 * 60 * 60 * 1000, // 12 giờ
                reward: 'upgrade_stone_medium', rewardType: 'material', ratePerHour: 1, capacity: 24 // 1/hr, max 24
            },
            // [NEW] Thêm 3 lãnh địa mới
            'territory_5': {
                id: 'territory_5', name: 'Lôi Trạch Cổ', desc: 'Đầm lầy cổ đại đầy sấm sét, sản sinh Đá Cường Hóa Cao.',
                icon: 'fa-solid fa-bolt-lightning',
                powerReq: 10000000, // 10M Power
                captureTimeMs: 18 * 60 * 60 * 1000, // 18 giờ
                reward: 'upgrade_stone_high', rewardType: 'material', ratePerHour: 0.5, capacity: 12 // 0.5/hr, max 12
            },
            'territory_6': {
                id: 'territory_6', name: 'Huyễn Cảnh Tinh Thần', desc: 'Một dị giới hư ảo, sản sinh Tử Thủy Tinh (Trung).',
                icon: 'fa-solid fa-star-of-life',
                powerReq: 25000000, // 25M Power
                captureTimeMs: 24 * 60 * 60 * 1000, // 1 ngày
                reward: 'gem_purple_2', rewardType: 'material', ratePerHour: 0.25, capacity: 6 // 0.25/hr, max 6
            },
            // [MODIFIED] Territory 7: Vực Hỗn Độn (50M)
            'territory_7': {
                id: 'territory_7', name: 'Vực Hỗn Độn', desc: 'Rìa của thế giới, sản sinh ngẫu nhiên tài nguyên cao cấp.',
                icon: 'fa-solid fa-tornado',
                powerReq: 50000000, // 50M Power
                captureTimeMs: 36 * 60 * 60 * 1000, // 36 giờ (1.5 ngày)
                reward: 'linhThach', ratePerHour: 1000, capacity: 48000 
            },
            // [MODIFIED] Territory 8: Băng Phong Cốc (75M)
            'territory_8': {
                id: 'territory_8', 
                name: 'Băng Phong Cốc', 
                desc: 'Thung lũng băng giá vĩnh cửu. Sản sinh Lam Thủy Tinh (Trung).',
                icon: 'fa-solid fa-snowflake',
                powerReq: 75000000, // 75M LC (Giảm từ 100M)
                captureTimeMs: 48 * 60 * 60 * 1000, // 48 giờ (2 ngày)
                reward: 'gem_blue_2', // Lam Thủy Tinh (Trung)
                rewardType: 'material', 
                ratePerHour: 0.2, // 5 giờ 1 viên
                capacity: 10 // Max 10 viên
            },
            // [MODIFIED] Territory 9: Hỏa Diệm Sơn (130M)
            'territory_9': {
                id: 'territory_9', 
                name: 'Hỏa Diệm Sơn', 
                desc: 'Ngọn núi lửa không bao giờ tắt. Sản sinh Tử Thủy Tinh (Trung).',
                icon: 'fa-solid fa-fire',
                powerReq: 130000000, // 130M LC (Giảm từ 250M)
                captureTimeMs: 54 * 60 * 60 * 1000, // 54 giờ
                reward: 'gem_purple_2', // Tử Thủy Tinh (Trung)
                rewardType: 'material', 
                ratePerHour: 0.15, 
                capacity: 8
            },
            // [MODIFIED] Territory 10: Long Mạch Hoàng Gia (200M)
            'territory_10': {
                id: 'territory_10', 
                name: 'Long Mạch Hoàng Gia', 
                desc: 'Nơi long khí hội tụ. Sản sinh lượng lớn Linh Thạch.',
                icon: 'fa-solid fa-dragon',
                powerReq: 200000000, // 200M LC (Giảm từ 500M)
                captureTimeMs: 60 * 60 * 60 * 1000, // 60 giờ (2.5 ngày)
                reward: 'linhThach', 
                ratePerHour: 8000, 
                capacity: 480000 
            },
            // [MODIFIED] Territory 11: Tiên Giới Chi Môn (270M)
            'territory_11': {
                id: 'territory_11', 
                name: 'Tiên Giới Chi Môn', 
                desc: 'Cánh cổng dẫn tới thượng giới. Sản sinh Linh Khí cực đại.',
                icon: 'fa-solid fa-dungeon',
                powerReq: 270000000, // 270M LC (Giảm từ 1 Tỷ)
                captureTimeMs: 72 * 60 * 60 * 1000, // 72 giờ (3 ngày)
                reward: 'linhKhi', 
                ratePerHour: 30000, 
                capacity: 2160000 
            },
            // [MODIFIED] Territory 12: Hư Không Tinh Vực (400M)
            'territory_12': {
                id: 'territory_12', 
                name: 'Hư Không Tinh Vực', 
                desc: 'Vùng không gian hỗn loạn. Sản sinh Hoàng Thủy Tinh (Cao).',
                icon: 'fa-solid fa-meteor',
                powerReq: 400000000, // 400M LC (Giảm từ 5 Tỷ)
                captureTimeMs: 84 * 60 * 60 * 1000, // 84 giờ (3.5 ngày)
                reward: 'gem_yellow_3', // Hoàng Thủy Tinh (Cao)
                rewardType: 'material', 
                ratePerHour: 0.05, // 20 giờ 1 viên
                capacity: 5 // Max 5 viên
            },
            // [NEW] Territory 13: Cửu Trọng Thiên (550M)
            'territory_13': {
                id: 'territory_13', 
                name: 'Cửu Trọng Thiên', 
                desc: 'Tầng trời cao nhất, nơi các vị thần ngự trị. Sản sinh Lục Thủy Tinh (Siêu) tăng HP cực đại.',
                icon: 'fa-solid fa-cloud-sun',
                powerReq: 550000000, // 550M LC
                captureTimeMs: 96 * 60 * 60 * 1000, // 96 giờ (4 ngày)
                reward: 'gem_green_4', // Lục Thủy Tinh (Siêu)
                rewardType: 'material', 
                ratePerHour: 0.05, // 20 giờ 1 viên
                capacity: 5 
            },
            // [NEW] Territory 14: Vạn Cổ Cấm Địa (750M)
            'territory_14': {
                id: 'territory_14', 
                name: 'Vạn Cổ Cấm Địa', 
                desc: 'Vùng đất chết bị lãng quên từ thời thượng cổ. Sản sinh Lam Thủy Tinh (Siêu) tăng Thủ cực đại.',
                icon: 'fa-solid fa-skull-crossbones',
                powerReq: 750000000, // 750M LC
                captureTimeMs: 108 * 60 * 60 * 1000, // 108 giờ (4.5 ngày)
                reward: 'gem_blue_4', // Lam Thủy Tinh (Siêu)
                rewardType: 'material', 
                ratePerHour: 0.04, // 25 giờ 1 viên
                capacity: 5 
            },
            // [NEW] Territory 15: Hỗn Độn Thần Vực (1 Tỷ)
            'territory_15': {
                id: 'territory_15', 
                name: 'Hỗn Độn Thần Vực', 
                desc: 'Nơi giao thoa giữa trật tự và hỗn loạn, ẩn chứa sức mạnh hủy diệt. Sản sinh Tử Thủy Tinh (Siêu) tăng Công cực đại.',
                icon: 'fa-solid fa-hurricane',
                powerReq: 1000000000, // 1 Tỷ LC
                captureTimeMs: 120 * 60 * 60 * 1000, // 120 giờ (5 ngày)
                reward: 'gem_purple_4', // Tử Thủy Tinh (Siêu)
                rewardType: 'material', 
                ratePerHour: 0.03, // ~33 giờ 1 viên
                capacity: 4 
            },
            // [NEW] Territory 16: Hồng Mông Khởi Nguyên (1.5 Tỷ)
            'territory_16': {
                id: 'territory_16', 
                name: 'Hồng Mông Khởi Nguyên', 
                desc: 'Nơi khởi nguồn của vũ trụ, chứa đựng chân lý vạn vật. Sản sinh Hoàng Thủy Tinh (Siêu) tăng % Kinh Nghiệm.',
                icon: 'fa-solid fa-infinity',
                powerReq: 1500000000, // 1.5 Tỷ LC
                captureTimeMs: 144 * 60 * 60 * 1000, // 144 giờ (6 ngày)
                reward: 'gem_yellow_4', // Hoàng Thủy Tinh (Siêu)
                rewardType: 'material', 
                ratePerHour: 0.02, // 50 giờ 1 viên
                capacity: 3 
            },
            // [NEW] Territory 17: Thần Mộc Kỷ Nguyên (3 Tỷ)
            'territory_17': {
                id: 'territory_17', 
                name: 'Thần Mộc Kỷ Nguyên', 
                desc: 'Cây thế giới chọc trời, linh khí nồng đậm hóa lỏng. Sản sinh lượng lớn Linh Khí.',
                icon: 'fa-solid fa-tree',
                powerReq: 3000000000, // 3 Tỷ LC
                captureTimeMs: 168 * 60 * 60 * 1000, // 168 giờ (7 ngày)
                reward: 'linhKhi', 
                ratePerHour: 100000, 
                capacity: 10000000 
            },
            // [NEW] Territory 18: Cửu U Minh Giới (5 Tỷ)
            'territory_18': {
                id: 'territory_18', 
                name: 'Cửu U Minh Giới', 
                desc: 'Vùng đất của cái chết, nơi tích tụ oán khí và khoáng sản. Sản sinh lượng lớn Linh Thạch.',
                icon: 'fa-solid fa-skull',
                powerReq: 5000000000, // 5 Tỷ LC
                captureTimeMs: 192 * 60 * 60 * 1000, // 192 giờ (8 ngày)
                reward: 'linhThach', 
                ratePerHour: 25000, 
                capacity: 2000000 
            },
            // [NEW] Territory 19: Thiên Đạo Cung (10 Tỷ)
            'territory_19': {
                id: 'territory_19', 
                name: 'Thiên Đạo Cung', 
                desc: 'Cung điện của người nắm giữ trật tự. Sản sinh Lục Thủy Tinh (Siêu) tăng HP cực đại.',
                icon: 'fa-solid fa-gopuram',
                powerReq: 10000000000, // 10 Tỷ LC
                captureTimeMs: 240 * 60 * 60 * 1000, // 240 giờ (10 ngày)
                reward: 'gem_green_4', // Lục Thủy Tinh (Siêu)
                rewardType: 'material', 
                ratePerHour: 0.01, // 100 giờ 1 viên
                capacity: 2 
            },
            // [NEW] Territory 20: Hỗn Độn Khởi Nguyên (20 Tỷ)
            'territory_20': {
                id: 'territory_20', 
                name: 'Hỗn Độn Khởi Nguyên', 
                desc: 'Nơi vạn vật bắt đầu và kết thúc. Sản sinh Tử Thủy Tinh (Siêu) tăng Công Kích cực đại.',
                icon: 'fa-solid fa-circle-notch',
                powerReq: 20000000000, // 20 Tỷ LC
                captureTimeMs: 360 * 60 * 60 * 1000, // 360 giờ (15 ngày)
                reward: 'gem_purple_4', // Tử Thủy Tinh (Siêu)
                rewardType: 'material', 
                ratePerHour: 0.01, 
                capacity: 2 
            },
            // [NEW] Territory 21: Sáng Thế Thần Vực (35 Tỷ)
            'territory_21': {
                id: 'territory_21', 
                name: 'Sáng Thế Thần Vực', 
                desc: 'Vùng đất của Đấng Sáng Tạo. Sản sinh Hoàng Thủy Tinh (Siêu) tăng % Kinh Nghiệm.',
                icon: 'fa-solid fa-sun',
                powerReq: 35000000000, // 35 Tỷ LC
                captureTimeMs: 480 * 60 * 60 * 1000, // 480 giờ (20 ngày)
                reward: 'gem_yellow_4', // Hoàng Thủy Tinh (Siêu)
                rewardType: 'material', 
                ratePerHour: 0.005, // 200 giờ 1 viên
                capacity: 1 
            },
            // [NEW] Territory 22: Vĩnh Hằng Chi Địa (50 Tỷ)
            'territory_22': {
                id: 'territory_22', 
                name: 'Vĩnh Hằng Chi Địa', 
                desc: 'Nơi thời gian ngừng trôi. Sản sinh Mảnh Bạch Kim (Nguyên liệu tối thượng).',
                icon: 'fa-solid fa-infinity',
                powerReq: 50000000000, // 50 Tỷ LC
                captureTimeMs: 720 * 60 * 60 * 1000, // 720 giờ (30 ngày)
                reward: 'ore_mythic_1', // Mảnh Bạch Kim
                rewardType: 'material', 
                ratePerHour: 0.02, // 50 giờ 1 viên
                capacity: 5 
            },
            // [NEW] MỞ RỘNG LÃNH ĐỊA ENDGAME (75 Tỷ - 999 Tỷ)
            'territory_23': {
                id: 'territory_23', 
                name: 'Hồng Mông Thánh Địa', 
                desc: 'Vùng đất linh thiêng nhất vũ trụ. Sản sinh Hoàng Thủy Tinh (Siêu) - Tăng % Kinh Nghiệm.',
                icon: 'fa-solid fa-place-of-worship',
                powerReq: 75000000000, // 75 Tỷ LC
                captureTimeMs: 840 * 60 * 60 * 1000, // 35 ngày
                reward: 'gem_yellow_4', 
                rewardType: 'material', 
                ratePerHour: 0.01, // 100 giờ 1 viên
                capacity: 2
            },
            'territory_24': {
                id: 'territory_24', 
                name: 'Thiên Đạo Thần Cung', 
                desc: 'Cung điện của ý chí vũ trụ. Linh khí đậm đặc hóa lỏng.',
                icon: 'fa-solid fa-gopuram',
                powerReq: 100000000000, // 100 Tỷ LC
                captureTimeMs: 960 * 60 * 60 * 1000, // 40 ngày
                reward: 'linhKhi', 
                ratePerHour: 200000, 
                capacity: 20000000 // 20M Linh Khí
            },
            'territory_25': {
                id: 'territory_25', 
                name: 'Hư Vô Tịch Diệt', 
                desc: 'Khoảng không vô tận chứa đựng kho báu vô tận.',
                icon: 'fa-solid fa-ghost',
                powerReq: 150000000000, // 150 Tỷ LC
                captureTimeMs: 1080 * 60 * 60 * 1000, // 45 ngày
                reward: 'linhThach', 
                ratePerHour: 50000, 
                capacity: 5000000 // 5M Linh Thạch
            },
            'territory_26': {
                id: 'territory_26', 
                name: 'Thái Cổ Thần Vực', 
                desc: 'Vùng đất của các Cổ Thần. Sản sinh Mảnh Bạch Kim với tốc độ cao hơn.',
                icon: 'fa-solid fa-dragon',
                powerReq: 200000000000, // 200 Tỷ LC
                captureTimeMs: 1200 * 60 * 60 * 1000, // 50 ngày
                reward: 'ore_mythic_1', 
                rewardType: 'material', 
                ratePerHour: 0.03, // ~33 giờ 1 viên
                capacity: 5
            },
            'territory_27': {
                id: 'territory_27', 
                name: 'Hỗn Độn Chung Cực', 
                desc: 'Điểm khởi đầu và kết thúc. Sản sinh Tử Thủy Tinh (Siêu) - Tăng Công Kích.',
                icon: 'fa-solid fa-circle-dot',
                powerReq: 300000000000, // 300 Tỷ LC
                captureTimeMs: 1440 * 60 * 60 * 1000, // 60 ngày
                reward: 'gem_purple_4', 
                rewardType: 'material', 
                ratePerHour: 0.02, // 50 giờ 1 viên
                capacity: 3
            },
            'territory_28': {
                id: 'territory_28', 
                name: 'Vạn Giới Chi Nguyên', 
                desc: 'Trung tâm của vạn giới. Nơi quy tụ lòng tin của chúng sinh (Cống Hiến).',
                icon: 'fa-solid fa-globe',
                powerReq: 500000000000, // 500 Tỷ LC
                captureTimeMs: 1680 * 60 * 60 * 1000, // 70 ngày
                reward: 'diemCongHien', 
                ratePerHour: 500, 
                capacity: 50000 // 50k Cống Hiến
            },
            'territory_29': {
                id: 'territory_29', 
                name: 'Đa Vũ Trụ Trung Tâm', 
                desc: 'Nơi giao thoa các dòng thời gian. Sản sinh Hoàng Thủy Tinh (Siêu) cực nhanh.',
                icon: 'fa-solid fa-atom',
                powerReq: 750000000000, // 750 Tỷ LC
                captureTimeMs: 1920 * 60 * 60 * 1000, // 80 ngày
                reward: 'gem_yellow_4', 
                rewardType: 'material', 
                ratePerHour: 0.03, // ~33 giờ 1 viên
                capacity: 5
            },
            'territory_30': {
                id: 'territory_30', 
                name: 'Điểm Cuối Của Sự Thật', 
                desc: 'Chân lý tối thượng. Sản sinh Mảnh Bạch Kim cực nhanh để chế tạo Thần Trang.',
                icon: 'fa-solid fa-eye',
                powerReq: 999000000000, // 999 Tỷ LC
                captureTimeMs: 2400 * 60 * 60 * 1000, // 100 ngày
                reward: 'ore_mythic_1', 
                rewardType: 'material', 
                ratePerHour: 0.05, // 20 giờ 1 viên
                capacity: 10
            },
            // [NEW] 4 Lãnh Địa Siêu Cấp (1.250 Tỷ - 5.000 Tỷ)
            'territory_31': {
                id: 'territory_31', 
                name: 'Vực Sâu Tinh Không', 
                desc: 'Nơi các vì sao rơi xuống. Sản sinh Lục Thủy Tinh (Siêu) cực nhanh.',
                icon: 'fa-solid fa-star',
                powerReq: 1250000000000, // 1.250 Tỷ LC
                captureTimeMs: 2880 * 60 * 60 * 1000, // 120 ngày
                reward: 'gem_green_4', // HP
                rewardType: 'material', 
                // [MODIFIED] Tăng sản lượng lên 0.5/h
                ratePerHour: 0.5, 
                capacity: 20
            },
            'territory_32': {
                id: 'territory_32', 
                name: 'Thiên Hà Chi Nhãn', 
                desc: 'Con mắt của vũ trụ. Sản sinh Lam Thủy Tinh (Siêu) cực nhanh.',
                icon: 'fa-solid fa-eye',
                powerReq: 1500000000000, // 1.500 Tỷ LC
                captureTimeMs: 3600 * 60 * 60 * 1000, // 150 ngày
                reward: 'gem_blue_4', // Def
                rewardType: 'material', 
                // [MODIFIED] Tăng sản lượng lên 0.5/h
                ratePerHour: 0.5, 
                capacity: 20
            },
            'territory_33': {
                id: 'territory_33', 
                name: 'Cội Nguồn Hủy Diệt', 
                desc: 'Nơi sức mạnh hủy diệt sinh ra. Sản sinh Tử Thủy Tinh (Siêu) cực nhanh.',
                icon: 'fa-solid fa-burst',
                powerReq: 2500000000000, // 2.500 Tỷ LC
                captureTimeMs: 4800 * 60 * 60 * 1000, // 200 ngày
                reward: 'gem_purple_4', // Atk
                rewardType: 'material', 
                // [MODIFIED] Tăng sản lượng lên 0.5/h
                ratePerHour: 0.5, 
                capacity: 15
            },
            'territory_34': {
                id: 'territory_34', 
                name: 'Đỉnh Cao Vũ Trụ', 
                desc: 'Điểm cao nhất của thực tại. Sản sinh Hoàng Thủy Tinh (Siêu) cực nhanh.',
                icon: 'fa-solid fa-crown',
                powerReq: 5000000000000, // 5.000 Tỷ LC
                captureTimeMs: 7200 * 60 * 60 * 1000, // 300 ngày
                reward: 'gem_yellow_4', // XP Boost
                rewardType: 'material', 
                // [MODIFIED] Tăng sản lượng lên 0.5/h
                ratePerHour: 0.5, 
                capacity: 10
            }
        };

        // [NEW] Động Phủ (Cave Buildings) Database
        const DONG_PHU_DB = {
            'linh_dien': {
                id: 'linh_dien',
                name: 'Linh Điền (Sơ)',
                desc: 'Sản xuất Linh Thạch cơ bản.',
                icon: 'fa-solid fa-gem', 
                baseRate: 1, // 1/giờ
                baseCapacity: 10,
                cost: { nl: 10000000, dch: 50 }, // 10M NL, 50 DCH
                costMultiplier: 1.5,
                rateMultiplier: 1.8,
                capacityMultiplier: 2.0
            },
            // [NEW] Linh Điền Trung Cấp
            'linh_dien_trung_cap': {
                id: 'linh_dien_trung_cap',
                name: 'Linh Điền (Trung)',
                desc: 'Sản xuất Linh Thạch năng suất cao.',
                icon: 'fa-solid fa-gem',
                baseRate: 10, // 10/giờ
                baseCapacity: 100,
                cost: { nl: 50000000, dch: 250 }, // 50M NL, 250 DCH
                costMultiplier: 1.5,
                rateMultiplier: 1.8,
                capacityMultiplier: 2.0
            },
            // [NEW] Linh Điền Cao Cấp
            'linh_dien_cao_cap': {
                id: 'linh_dien_cao_cap',
                name: 'Linh Điền (Cao)',
                desc: 'Sản xuất Linh Thạch năng suất cực đại.',
                icon: 'fa-regular fa-gem', 
                baseRate: 100, // 100/giờ
                baseCapacity: 1000,
                cost: { nl: 500000000, dch: 1000 }, // 500M NL, 1000 DCH
                costMultiplier: 1.5,
                rateMultiplier: 1.8,
                capacityMultiplier: 2.0
            },
            // [NEW] Linh Điền Siêu Cấp
            'linh_dien_sieu_cap': {
                id: 'linh_dien_sieu_cap',
                name: 'Linh Điền (Siêu)',
                desc: 'Tụ tập tinh hoa lòng đất, sản sinh Linh Thạch vô tận.',
                icon: 'fa-solid fa-diamond', // Icon kim cương
                baseRate: 500, // 500/giờ
                baseCapacity: 5000,
                cost: { nl: 2500000000, dch: 5000 }, // 2.5 Tỷ NL, 5000 DCH
                costMultiplier: 1.5,
                rateMultiplier: 1.8,
                capacityMultiplier: 2.0
            },
            // [NEW] Linh Điền Thần Cấp
            'linh_dien_than_cap': {
                id: 'linh_dien_than_cap',
                name: 'Linh Điền (Thần)',
                desc: 'Mảnh đất của thần linh, Linh Thạch tự sinh sôi.',
                icon: 'fa-solid fa-sun', // Icon mặt trời
                baseRate: 2500, // 2500/giờ
                baseCapacity: 25000,
                cost: { nl: 10000000000, dch: 20000 }, // 10 Tỷ NL, 20000 DCH
                costMultiplier: 1.5,
                rateMultiplier: 1.8,
                capacityMultiplier: 2.0
            },
            // [NEW] Tụ Linh Đài (Sơ) - Giữ nguyên
            'tu_luyen_dai': {
                id: 'tu_luyen_dai',
                name: 'Tụ Linh Đài (Sơ)',
                desc: 'Tụ linh khí trời đất, tự động sản sinh Tu Vi (dùng để đột phá cảnh giới).',
                icon: 'fa-solid fa-yin-yang',
                baseRate: 5, // 5 Tu Vi/giờ
                baseCapacity: 50,
                cost: { nl: 15000000, dch: 75 },
                costMultiplier: 1.6,
                rateMultiplier: 2.0,
                capacityMultiplier: 2.2
            },
            // [NEW] Tụ Linh Đài Trung Cấp - Gấp 1.5 Sơ
            'tu_luyen_dai_trung_cap': {
                id: 'tu_luyen_dai_trung_cap',
                name: 'Tụ Linh Đài (Trung)',
                desc: 'Tụ linh khí trời đất, tự động sản sinh Tu Vi năng suất cao.',
                icon: 'fa-solid fa-yin-yang',
                baseRate: 8, // 5 * 1.5 = 7.5 -> 8
                baseCapacity: 75, // 50 * 1.5 = 75
                cost: { nl: 75000000, dch: 375 }, // 75M NL
                costMultiplier: 1.6,
                rateMultiplier: 2.0,
                capacityMultiplier: 2.2
            },
            // [NEW] Tụ Linh Đài Cao Cấp - Gấp 1.5 Trung
            'tu_luyen_dai_cao_cap': {
                id: 'tu_luyen_dai_cao_cap',
                name: 'Tụ Linh Đài (Cao)',
                desc: 'Tụ linh khí trời đất, tự động sản sinh Tu Vi năng suất cực đại.',
                icon: 'fa-solid fa-yin-yang',
                baseRate: 12, // 8 * 1.5 = 12
                baseCapacity: 113, // 75 * 1.5 = 112.5 -> 113
                cost: { nl: 750000000, dch: 3750 }, // 750M NL
                costMultiplier: 1.6,
                rateMultiplier: 2.0,
                capacityMultiplier: 2.2
            },
            // [NEW] Tụ Linh Đài Siêu Cấp - Gấp 1.5 Cao
            'tu_luyen_dai_sieu_cap': {
                id: 'tu_luyen_dai_sieu_cap',
                name: 'Tụ Linh Đài (Siêu)',
                desc: 'Hấp thụ tinh hoa nhật nguyệt, sản sinh Tu Vi vô tận.',
                icon: 'fa-solid fa-atom', // Icon nguyên tử/năng lượng
                baseRate: 18, // 12 * 1.5 = 18
                baseCapacity: 170, // 113 * 1.5 = 169.5 -> 170
                cost: { nl: 3500000000, dch: 20000 }, // 3.5 Tỷ NL
                costMultiplier: 1.6,
                rateMultiplier: 2.0,
                capacityMultiplier: 2.2
            },
            // [NEW] Tụ Linh Đài Thần Cấp - Gấp 1.55 Siêu
            'tu_luyen_dai_than_cap': {
                id: 'tu_luyen_dai_than_cap',
                name: 'Tụ Linh Đài (Thần)',
                desc: 'Đài sen của Tiên Nhân, ngồi vào là đắc đạo thành tiên.',
                icon: 'fa-solid fa-infinity', // Icon vô cực
                baseRate: 28, // 18 * 1.55 = 27.9 -> 28
                baseCapacity: 264, // 170 * 1.55 = 263.5 -> 264
                cost: { nl: 15000000000, dch: 50000 }, // 15 Tỷ NL
                costMultiplier: 1.6,
                rateMultiplier: 2.0,
                capacityMultiplier: 2.2
            },
            // [NEW] Luyện Đan Phòng (Sơ)
            'luyen_dan_phong': {
                id: 'luyen_dan_phong',
                name: 'Luyện Đan Phòng (Sơ)',
                desc: 'Sản xuất Đệ Tử Tu Luyện Đan (10k XP).', 
                icon: 'fa-solid fa-fire-burner',
                baseRate: 1, // 1/giờ
                baseCapacity: 10, 
                resourceId: 'disciple_xp_pill_1', 
                resourceType: 'item', 
                cost: { nl: 25000000, dch: 100 },
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [NEW] Luyện Đan Phòng Trung Cấp
            'luyen_dan_phong_trung_cap': {
                id: 'luyen_dan_phong_trung_cap',
                name: 'Luyện Đan Phòng (Trung)',
                desc: 'Sản xuất Đệ Tử Đan Trung (500k XP).', 
                icon: 'fa-solid fa-fire-burner',
                baseRate: 1, // 1/giờ
                baseCapacity: 10, 
                resourceId: 'disciple_xp_pill_2', 
                resourceType: 'item', 
                cost: { nl: 100000000, dch: 500 }, // 100M NL
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [NEW] Luyện Đan Phòng Cao Cấp
            'luyen_dan_phong_cao_cap': {
                id: 'luyen_dan_phong_cao_cap',
                name: 'Luyện Đan Phòng (Cao)',
                desc: 'Sản xuất Đệ Tử Đan Cao (2.5M XP).', 
                icon: 'fa-solid fa-fire-burner',
                baseRate: 1, // 1/giờ
                baseCapacity: 10, 
                resourceId: 'disciple_xp_pill_3', 
                resourceType: 'item', 
                cost: { nl: 500000000, dch: 2000 }, // 500M NL
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [NEW] Luyện Đan Phòng Siêu Cấp
            'luyen_dan_phong_sieu_cap': {
                id: 'luyen_dan_phong_sieu_cap',
                name: 'Luyện Đan Phòng (Siêu)',
                desc: 'Sản xuất Luyện Cốt Đan Trung (Tăng vĩnh viễn Công Kích).', 
                icon: 'fa-solid fa-flask', // Icon bình thuốc
                baseRate: 1, // 1/giờ
                baseCapacity: 5, // Sức chứa thấp vì đồ quý
                resourceId: 'disciple_atk_pill_2', 
                resourceType: 'item', 
                cost: { nl: 2000000000, dch: 10000 }, // 2 Tỷ NL
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [NEW] Luyện Đan Phòng Thần Cấp
            'luyen_dan_phong_than_cap': {
                id: 'luyen_dan_phong_than_cap',
                name: 'Luyện Đan Phòng (Thần)',
                desc: 'Sản xuất Luyện Cốt Đan Cao (Tăng mạnh vĩnh viễn Công Kích).', 
                icon: 'fa-solid fa-prescription-bottle-medical', 
                baseRate: 1, 
                baseCapacity: 3, 
                resourceId: 'disciple_atk_pill_3', 
                resourceType: 'item', 
                cost: { nl: 10000000000, dch: 50000 }, 
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [MODIFIED] Luyện Khí Các (Sơ) - Thưởng Thủy Tinh Cao
            'luyen_khi_cac': {
                id: 'luyen_khi_cac',
                name: 'Luyện Khí Các (Sơ)', 
                desc: 'Tụ tập linh khí, ngưng tụ Lục Thủy Tinh (Cao).', 
                icon: 'fa-solid fa-gem', // [MODIFIED] Icon Gem
                baseRate: 1, 
                baseCapacity: 10, 
                resourceId: 'gem_green_3', // [MODIFIED] Lục Thủy Tinh (Cao)
                resourceType: 'material', 
                cost: { nl: 25000000, dch: 100 },
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [MODIFIED] Luyện Khí Các Trung Cấp - Thưởng Thủy Tinh Cao
            'luyen_khi_cac_trung_cap': {
                id: 'luyen_khi_cac_trung_cap',
                name: 'Luyện Khí Các (Trung)',
                desc: 'Tụ tập linh khí, ngưng tụ Lam Thủy Tinh (Cao).', 
                icon: 'fa-solid fa-gem', // [MODIFIED] Icon Gem
                baseRate: 1, 
                baseCapacity: 10, 
                resourceId: 'gem_blue_3', // [MODIFIED] Lam Thủy Tinh (Cao)
                resourceType: 'material', 
                cost: { nl: 100000000, dch: 500 }, 
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [MODIFIED] Luyện Khí Các Cao Cấp - Thưởng Thủy Tinh Cao
            'luyen_khi_cac_cao_cap': {
                id: 'luyen_khi_cac_cao_cap',
                name: 'Luyện Khí Các (Cao)',
                desc: 'Tụ tập linh khí, ngưng tụ Tử Thủy Tinh (Cao).', 
                icon: 'fa-solid fa-gem', // [MODIFIED] Icon Gem
                baseRate: 1, 
                baseCapacity: 5, 
                resourceId: 'gem_purple_3', // [MODIFIED] Tử Thủy Tinh (Cao)
                resourceType: 'material', 
                cost: { nl: 500000000, dch: 2000 }, 
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.8 
            },
            // [NEW] Luyện Khí Các Siêu Cấp
            'luyen_khi_cac_sieu_cap': {
                id: 'luyen_khi_cac_sieu_cap',
                name: 'Luyện Khí Các (Siêu)',
                desc: 'Lò luyện tinh hoa, ngưng tụ Hoàng Thủy Tinh (Cao).', 
                icon: 'fa-solid fa-gem', 
                baseRate: 1, // Rất chậm (1 viên/giờ)
                baseCapacity: 3, 
                resourceId: 'gem_yellow_3', // Hoàng Thủy Tinh (Cao)
                resourceType: 'material', 
                cost: { nl: 2500000000, dch: 10000 }, // 2.5 Tỷ NL
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.5 
            },
            // [NEW] Luyện Khí Các Thần Cấp
            'luyen_khi_cac_than_cap': {
                id: 'luyen_khi_cac_than_cap',
                name: 'Luyện Khí Các (Thần)',
                desc: 'Lấy thiên địa làm lò, ngưng tụ Lục Thủy Tinh (Siêu).', 
                icon: 'fa-solid fa-diamond', // Icon khác biệt chút
                baseRate: 1, 
                baseCapacity: 2, 
                resourceId: 'gem_green_4', // Lục Thủy Tinh (Siêu) - Tier 4
                resourceType: 'material', 
                cost: { nl: 10000000000, dch: 50000 }, // 10 Tỷ NL
                costMultiplier: 2.0,
                rateMultiplier: 1.5, 
                capacityMultiplier: 1.5 
            },
            
            // [NEW] --- DƯỢC VIÊN (HERB GARDEN) ---
            'duoc_vien': {
                id: 'duoc_vien',
                name: 'Dược Viên (Sơ)',
                desc: 'Trồng trọt thảo dược cơ bản (Cỏ Dại).', 
                icon: 'fa-solid fa-seedling', 
                baseRate: 10, // 10/giờ
                baseCapacity: 100, 
                resourceId: 'herb_common_1', // Cỏ Dại
                resourceType: 'material', 
                cost: { nl: 5000000, dch: 20 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'duoc_vien_trung_cap': {
                id: 'duoc_vien_trung_cap',
                name: 'Dược Viên (Trung)',
                desc: 'Trồng trọt thảo dược hiếm (Bạc Hà).', 
                icon: 'fa-solid fa-leaf', 
                baseRate: 5, 
                baseCapacity: 50, 
                resourceId: 'herb_uncommon_1', // Bạc Hà
                resourceType: 'material', 
                cost: { nl: 25000000, dch: 100 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'duoc_vien_cao_cap': {
                id: 'duoc_vien_cao_cap',
                name: 'Dược Viên (Cao)',
                desc: 'Vườn thuốc quý (Linh Chi).', 
                icon: 'fa-solid fa-tree', 
                baseRate: 2, 
                baseCapacity: 20, 
                resourceId: 'herb_rare_1', // Linh Chi
                resourceType: 'material', 
                cost: { nl: 100000000, dch: 500 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'duoc_vien_sieu_cap': {
                id: 'duoc_vien_sieu_cap',
                name: 'Dược Viên (Siêu)',
                desc: 'Linh điền ngàn năm (Nhân Sâm).', 
                icon: 'fa-solid fa-spa', 
                baseRate: 1, 
                baseCapacity: 10, 
                resourceId: 'herb_epic_1', // Nhân Sâm
                resourceType: 'material', 
                cost: { nl: 500000000, dch: 2000 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'duoc_vien_than_cap': {
                id: 'duoc_vien_than_cap',
                name: 'Dược Viên (Thần)',
                desc: 'Thánh địa sinh trưởng dược liệu (Thiên Sơn Tuyết Liên).', 
                icon: 'fa-solid fa-sun-plant-wilt', 
                baseRate: 1, 
                baseCapacity: 5, 
                resourceId: 'herb_mythic_1', // [MODIFIED] Đổi từ Đá Cường Hóa sang Tuyết Liên
                resourceType: 'material', 
                cost: { nl: 2500000000, dch: 10000 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },

            // [NEW] --- KHOÁNG TRƯỜNG (MINE) ---
            'khoang_truong': {
                id: 'khoang_truong',
                name: 'Khoáng Trường (Sơ)',
                desc: 'Mỏ khoáng sản xuất Sắt.', 
                icon: 'fa-solid fa-mound', 
                baseRate: 10, 
                baseCapacity: 100, 
                resourceId: 'ore_common_1', // Mảnh Sắt
                resourceType: 'material', 
                cost: { nl: 5000000, dch: 20 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'khoang_truong_trung_cap': {
                id: 'khoang_truong_trung_cap',
                name: 'Khoáng Trường (Trung)',
                desc: 'Mỏ khoáng sản xuất Đồng.', 
                icon: 'fa-solid fa-cubes-stacked', 
                baseRate: 5, 
                baseCapacity: 50, 
                resourceId: 'ore_uncommon_1', // Mảnh Đồng
                resourceType: 'material', 
                cost: { nl: 25000000, dch: 100 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'khoang_truong_cao_cap': {
                id: 'khoang_truong_cao_cap',
                name: 'Khoáng Trường (Cao)',
                desc: 'Mỏ khoáng sản xuất Bạc.', 
                icon: 'fa-solid fa-cube', 
                baseRate: 2, 
                baseCapacity: 20, 
                resourceId: 'ore_rare_1', // Mảnh Bạc
                resourceType: 'material', 
                cost: { nl: 100000000, dch: 500 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'khoang_truong_sieu_cap': {
                id: 'khoang_truong_sieu_cap',
                name: 'Khoáng Trường (Siêu)',
                desc: 'Mỏ khoáng sản xuất Vàng.', 
                icon: 'fa-solid fa-gem', 
                baseRate: 1, 
                baseCapacity: 10, 
                resourceId: 'ore_epic_1', // Mảnh Vàng
                resourceType: 'material', 
                cost: { nl: 500000000, dch: 2000 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            },
            'khoang_truong_than_cap': {
                id: 'khoang_truong_than_cap',
                name: 'Khoáng Trường (Thần)',
                desc: 'Mạch khoáng thiên thạch (Mảnh Bạch Kim).', 
                icon: 'fa-solid fa-meteor', 
                baseRate: 1, 
                baseCapacity: 5, 
                resourceId: 'ore_mythic_1', // [MODIFIED] Đổi từ Đá Cường Hóa sang Bạch Kim
                resourceType: 'material', 
                cost: { nl: 2500000000, dch: 10000 }, 
                costMultiplier: 1.5, rateMultiplier: 1.8, capacityMultiplier: 2.0 
            }
        };

        // [NEW] Lôi Đài (Arena) Ranking Tiers
        const LOI_DAI_TIERS_DB = {
            0: { name: 'Vô Danh Tiểu Tốt', color: 'text-gray-500' },
            1: { name: 'Sơ Nhập Giang Hồ', color: 'text-yellow-700' },     // Đồng
            2: { name: 'Tiểu Hữu Danh Khí', color: 'text-gray-400' },      // Bạc
            3: { name: 'Võ Lâm Hảo Thủ', color: 'text-yellow-400' },       // Vàng
            4: { name: 'Nhất Phương Danh Sĩ', color: 'text-teal-300' },    // Bạch Kim
            5: { name: 'Uy Trấn Giang Hồ', color: 'text-blue-400' },       // Kim Cương
            6: { name: 'Nhất Đại Tông Sư', color: 'text-purple-400' },     // Cao Thủ
            7: { name: 'Độc Cô Cầu Bại', color: 'text-red-500 font-bold animate-pulse' } // Thách Đấu
        };

        // [NEW] Win Streak Titles Database (Danh Hiệu Chuỗi Thắng)
        const WINSTREAK_TITLES = {
            5: { name: 'Liên Thắng', color: 'text-green-400', icon: 'fa-check' },
            10: { name: 'Đại Sát Tứ Phương', color: 'text-blue-400 font-bold', icon: 'fa-bolt' },
            20: { name: 'Không Thể Cản Phá', color: 'text-purple-400 font-bold', icon: 'fa-skull' },
            30: { name: 'Thần Cản Sát Thần', color: 'text-red-500 font-black animate-pulse', icon: 'fa-dragon' },
            50: { name: 'Độc Cô Cầu Bại', color: 'text-yellow-400 font-black text-shadow-gold animate-pulse', icon: 'fa-crown' },
            100: { name: 'Vạn Cổ Vô Địch', color: 'text-rainbow-animation font-black text-lg', icon: 'fa-sun' }
        };

        /**
         * [NEW] Helper lấy danh hiệu chuỗi thắng
         */
        function getStreakTitle(streak) {
            let title = null;
            // Sắp xếp key giảm dần để tìm mốc cao nhất đạt được
            const milestones = Object.keys(WINSTREAK_TITLES).map(Number).sort((a, b) => b - a);
            
            for (const milestone of milestones) {
                if (streak >= milestone) {
                    title = WINSTREAK_TITLES[milestone];
                    break;
                }
            }
            return title;
        }

        // [MODIFIED] VO DAI THAN MA (Gods & Demons Arena) Database - 20 Ranks Wuxia
        // [NEW] Thêm trường 'standardPower' (Lực Chiến Chuẩn) cho từng Rank
        // [MODIFIED] Thêm 'diemVinhDuLienDau' vào salary (Thấp nhất 50)
        // [MODIFIED] Thêm 'xp' vào salary
        const ARENA_RANKS_DB = {
            1: { name: 'Vô Danh Tiểu Tốt', minPoints: 0, salary: { knb: 50, danhVong: 20, diemVinhDuLienDau: 50, xp: 100000 }, color: 'text-gray-500', icon: 'fa-solid fa-user', standardPower: 1000 },
            2: { name: 'Sơ Nhập Giang Hồ', minPoints: 100, salary: { knb: 80, danhVong: 30, diemVinhDuLienDau: 80, xp: 200000 }, color: 'text-gray-400', icon: 'fa-solid fa-shoe-prints', standardPower: 5000 },
            3: { name: 'Giang Hồ Học Nghệ', minPoints: 300, salary: { knb: 120, danhVong: 50, diemVinhDuLienDau: 120, xp: 500000 }, color: 'text-green-300', icon: 'fa-solid fa-book-open', standardPower: 15000 },
            4: { name: 'Hữu Danh Vô Thực', minPoints: 600, salary: { knb: 180, danhVong: 80, diemVinhDuLienDau: 180, xp: 1000000 }, color: 'text-green-500', icon: 'fa-solid fa-scroll', standardPower: 40000 },
            5: { name: 'Tiểu Cao Thủ', minPoints: 1000, salary: { knb: 250, danhVong: 120, diemVinhDuLienDau: 250, xp: 2500000 }, color: 'text-blue-300', icon: 'fa-solid fa-khanda', standardPower: 100000 },
            6: { name: 'Nhất Lưu Cao Thủ', minPoints: 1500, salary: { knb: 350, danhVong: 180, diemVinhDuLienDau: 350, xp: 5000000 }, color: 'text-blue-500', icon: 'fa-solid fa-medal', standardPower: 250000 },
            7: { name: 'Tuyệt Đỉnh Cao Thủ', minPoints: 2200, salary: { knb: 500, danhVong: 250, diemVinhDuLienDau: 500, xp: 10000000 }, color: 'text-indigo-400', icon: 'fa-solid fa-star', standardPower: 600000 },
            8: { name: 'Võ Lâm Danh Gia', minPoints: 3000, salary: { knb: 700, danhVong: 350, diemVinhDuLienDau: 700, xp: 25000000 }, color: 'text-indigo-300', icon: 'fa-solid fa-landmark', standardPower: 1500000 },
            9: { name: 'Võ Lâm Cao Nhân', minPoints: 4000, salary: { knb: 900, danhVong: 500, diemVinhDuLienDau: 900, xp: 50000000 }, color: 'text-purple-400', icon: 'fa-solid fa-user-ninja', standardPower: 4000000 },
            10: { name: 'Đại Hiệp', minPoints: 5500, salary: { knb: 1200, danhVong: 700, diemVinhDuLienDau: 1200, xp: 100000000 }, color: 'text-purple-300 font-bold', icon: 'fa-solid fa-hat-cowboy', standardPower: 10000000 },
            11: { name: 'Thiên Tài Võ Học', minPoints: 7500, salary: { knb: 1600, danhVong: 1000, diemVinhDuLienDau: 1600, xp: 250000000 }, color: 'text-yellow-300', icon: 'fa-solid fa-brain', standardPower: 25000000 },
            12: { name: 'Võ Lâm Minh Chủ', minPoints: 10000, salary: { knb: 2200, danhVong: 1500, diemVinhDuLienDau: 2200, xp: 500000000 }, color: 'text-yellow-500 font-bold', icon: 'fa-solid fa-sitemap', standardPower: 60000000 },
            13: { name: 'Độc Bộ Giang Hồ', minPoints: 13000, salary: { knb: 3000, danhVong: 2200, diemVinhDuLienDau: 3000, xp: 1000000000 }, color: 'text-orange-400', icon: 'fa-solid fa-person-hiking', standardPower: 150000000 },
            14: { name: 'Tung Hoành Thiên Hạ', minPoints: 17000, salary: { knb: 4000, danhVong: 3000, diemVinhDuLienDau: 4000, xp: 2500000000 }, color: 'text-orange-500 font-bold', icon: 'fa-solid fa-earth-asia', standardPower: 400000000 },
            15: { name: 'Độc Cô Cầu Bại', minPoints: 22000, salary: { knb: 5500, danhVong: 4000, diemVinhDuLienDau: 5500, xp: 5000000000 }, color: 'text-red-400', icon: 'fa-solid fa-user-slash', standardPower: 1000000000 }, // 1 Tỷ
            16: { name: 'Nhất Đại Tông Sư', minPoints: 30000, salary: { knb: 7500, danhVong: 5500, diemVinhDuLienDau: 7500, xp: 10000000000 }, color: 'text-red-500 font-bold', icon: 'fa-solid fa-yin-yang', standardPower: 3000000000 },
            17: { name: 'Thiên Hạ Vô Song', minPoints: 40000, salary: { knb: 10000, danhVong: 7500, diemVinhDuLienDau: 10000, xp: 25000000000 }, color: 'text-fuchsia-400 font-black', icon: 'fa-solid fa-gem', standardPower: 10000000000 },
            18: { name: 'Thông Thiên Võ Thánh', minPoints: 55000, salary: { knb: 15000, danhVong: 10000, diemVinhDuLienDau: 15000, xp: 50000000000 }, color: 'text-pink-500 font-black', icon: 'fa-solid fa-dragon', standardPower: 50000000000 },
            19: { name: 'Võ Đạo Chí Tôn', minPoints: 75000, salary: { knb: 25000, danhVong: 15000, diemVinhDuLienDau: 25000, xp: 100000000000 }, color: 'text-rainbow-animation', icon: 'fa-solid fa-crown', standardPower: 200000000000 },
            20: { name: 'Nhất Thế Chi Tôn', minPoints: 100000, salary: { knb: 50000, danhVong: 25000, diemVinhDuLienDau: 50000, xp: 250000000000 }, color: 'text-rainbow-animation font-black text-2xl', icon: 'fa-solid fa-sun', standardPower: 1000000000000 } // 1 Ngàn Tỷ (End Game)
        };

        // [NEW] Hon Ky (Soul Skill) Database
        const HON_KY_DB = {
            'hk_1': {
                id: 'hk_1',
                name: 'Đệ Nhất Hồn Kỹ: Triền Nhiễu',
                desc: 'Tấn công mục tiêu, gây sát thương bằng 120% Công Kích.',
                color: 'text-yellow-300', 
                icon: 'fa-solid fa-plant-wilt', // [NEW] Icon Dây leo
                honLucCost: 10,
                type: 'attack', 
                multiplier: 1.2,
                levelReq: 10,
                thanCachCost: 200
            },
            'hk_2': {
                id: 'hk_2',
                name: 'Đệ Nhị Hồn Kỹ: Độc Tố',
                desc: 'Tấn công mục tiêu, gây sát thương bằng 150% Công Kích.',
                color: 'text-yellow-300',
                icon: 'fa-solid fa-biohazard', // [NEW] Icon Độc
                honLucCost: 20,
                type: 'attack',
                multiplier: 1.5,
                levelReq: 20,
                thanCachCost: 500
            },
            'hk_3': {
                id: 'hk_3',
                name: 'Đệ Tam Hồn Kỹ: Chu Võng Thúc Phược',
                desc: 'Tấn công mục tiêu, gây sát thương bằng 200% Công Kích.',
                color: 'text-purple-400', 
                icon: 'fa-solid fa-spider', // [NEW] Icon Nhện
                honLucCost: 30,
                type: 'attack',
                multiplier: 2.0,
                levelReq: 30,
                thanCachCost: 1000
            },
            'hk_4': {
                id: 'hk_4',
                name: 'Đệ Tứ Hồn Kỹ: Bạch Hổ Lưu Tinh Vũ',
                desc: 'Triệu hồi mưa sao băng tấn công. Gây 250% Sát thương, tăng 20% Chí Mạng.',
                color: 'text-purple-400', 
                icon: 'fa-solid fa-meteor', // [NEW] Icon Sao băng
                honLucCost: 40,
                type: 'attack',
                multiplier: 2.5,
                levelReq: 40,
                bonusCrit: 20,
                thanCachCost: 2000
            },
            'hk_5': {
                id: 'hk_5',
                name: 'Đệ Ngũ Hồn Kỹ: Lam Ngân Bá Vương Thương',
                desc: 'Ngưng tụ thương ý bá đạo. Gây 300% Sát thương, Bỏ qua 20% Phòng Thủ.',
                color: 'text-gray-400 font-bold border-b border-gray-500', 
                icon: 'fa-solid fa-khanda', // [NEW] Icon Thương
                honLucCost: 50,
                type: 'attack',
                multiplier: 3.0,
                levelReq: 50,
                ignoreDef: 0.2,
                thanCachCost: 5000
            },
            'hk_6': {
                id: 'hk_6',
                name: 'Đệ Lục Hồn Kỹ: Hư Vô',
                desc: 'Cơ thể hóa thành hư vô, miễn nhiễm sát thương vật lý (Mô phỏng tăng 100% Phòng Thủ trong 3 lượt).',
                color: 'text-red-600 font-black animate-pulse', 
                icon: 'fa-solid fa-ghost', // [NEW] Icon Ma
                honLucCost: 80,
                type: 'buff', 
                levelReq: 60,
                effect: { type: 'buff', stat: 'def', value: 1.0, duration: 3 }, 
                thanCachCost: 10000
            },
            'hk_7': {
                id: 'hk_7',
                name: 'Đệ Thất Hồn Kỹ: Võ Hồn Chân Thân',
                desc: 'Hiện nguyên hình Võ Hồn. Tăng 50% Công Kích và 50% Hồi Phục trong 10 lượt.',
                color: 'text-red-600 font-black animate-pulse', 
                icon: 'fa-solid fa-dragon', // [NEW] Icon Rồng
                honLucCost: 100,
                type: 'buff',
                levelReq: 70,
                effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 10 },
                effect2: { type: 'buff', stat: 'lifesteal', value: 50, duration: 10 },
                thanCachCost: 20000
            },
            'hk_8': {
                id: 'hk_8',
                name: 'Đệ Bát Hồn Kỹ: Lam Ngân Tà Ma Kính',
                desc: 'Gương diệt quỷ. Gây 400% Sát thương và làm choáng kẻ địch (Giảm 80% Tốc độ) trong 3 lượt.',
                color: 'text-red-600 font-black animate-pulse', 
                icon: 'fa-solid fa-eye', // [NEW] Icon Mắt
                honLucCost: 150,
                type: 'attack',
                multiplier: 4.0,
                levelReq: 80,
                effect: { type: 'debuff', stat: 'spd', value: -0.8, duration: 3 },
                thanCachCost: 30000
            },
            'hk_9': {
                id: 'hk_9',
                name: 'Đệ Cửu Hồn Kỹ: Thiên Thanh Tịch Diệt Lôi',
                desc: 'Sức mạnh rồng xanh hủy diệt. Gây 600% Sát thương chuẩn (Bỏ qua 100% Phòng Thủ).',
                color: 'text-red-600 font-black animate-pulse', 
                icon: 'fa-solid fa-bolt', // [NEW] Icon Sét
                honLucCost: 250,
                type: 'attack',
                multiplier: 6.0,
                levelReq: 90,
                ignoreDef: 1.0, 
                thanCachCost: 45000
            },
            'hk_10': {
                id: 'hk_10',
                name: 'Thần Kỹ: Hải Thần Hoàng Hôn',
                desc: 'Ánh sáng hoàng hôn của Hải Thần. Gây 1500% Sát thương, Hồi phục 100% Sinh Lực ngay lập tức.',
                color: 'text-yellow-400 font-black text-shadow-gold', 
                icon: 'fa-solid fa-water', // [NEW] Icon Nước
                honLucCost: 500,
                type: 'attack',
                multiplier: 15.0,
                levelReq: 100,
                effect: { type: 'buff', stat: 'lifesteal', value: 1000, duration: 1 }, 
                thanCachCost: 60000
            },
            'hk_11': {
                id: 'hk_11',
                name: 'Thần Kỹ: Tu La Thẩm Phán',
                desc: 'Sự phán xét của Tu La Thần. Gây 900% Sát thương chuẩn (Bỏ qua 100% Thủ). Kẻ địch không thể né tránh.',
                color: 'text-red-600 font-black text-shadow-red animate-pulse', 
                icon: 'fa-solid fa-gavel', // [NEW] Icon Búa
                honLucCost: 1000,
                type: 'attack',
                multiplier: 9.0, 
                levelReq: 120,
                ignoreDef: 1.0, 
                bonusCrit: 100, 
                thanCachCost: 80000
            },
            'hk_12': {
                id: 'hk_12',
                name: 'Tuyệt Kỹ: Hàng Long Thập Bát Chưởng',
                desc: 'Thiên hạ đệ nhất chưởng pháp. Triệu hồi 18 con rồng tấn công, gây 1500% Sát thương diện rộng.',
                color: 'text-orange-500 font-black text-shadow-orange animate-pulse', 
                icon: 'fa-solid fa-hand-fist', // [NEW] Icon Nắm đấm
                honLucCost: 2000,
                type: 'attack',
                multiplier: 15.0, 
                levelReq: 150,
                ignoreDef: 0.5, 
                thanCachCost: 100000
            },
            'hk_13': {
                id: 'hk_13',
                name: 'Thần Công: Thiên Địa Vô Cực',
                desc: 'Võ học tối thượng của Võ Đang. Mượn sức mạnh trời đất, gây 2400% Sát thương chuẩn và làm choáng.',
                color: 'text-cyan-400 font-black text-shadow-cyan animate-pulse', 
                icon: 'fa-solid fa-yin-yang', // [NEW] Icon Âm Dương
                honLucCost: 3000,
                type: 'attack',
                multiplier: 24.0, 
                levelReq: 180,
                ignoreDef: 1.0, 
                effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 3 }, 
                thanCachCost: 125000
            },
            'hk_14': {
                id: 'hk_14',
                name: 'Tuyệt Kỹ: Bạo Vũ Lê Hoa Châm',
                desc: 'Ám khí vương giả của Đường Môn. Phóng ra màn mưa kim châm, gây 3600% Sát thương diện rộng, 100% Chí Mạng.',
                color: 'text-gray-200 font-black text-shadow-white animate-pulse', 
                icon: 'fa-solid fa-burst', // [NEW] Icon Nổ
                honLucCost: 4000,
                type: 'attack',
                multiplier: 36.0, 
                levelReq: 200,
                bonusCrit: 100, 
                ignoreDef: 0.5, 
                thanCachCost: 150000
            },
            'hk_15': {
                id: 'hk_15',
                name: 'Thần Công: Phong Sương Toái Ảnh',
                desc: 'Kiếm khí băng hàn đập tan hình bóng. Gây 4500% Sát thương, Đóng băng vĩnh cửu (Choáng 5s).',
                color: 'text-cyan-200 font-black text-shadow-blue animate-pulse', 
                icon: 'fa-solid fa-snowflake', // [NEW] Icon Tuyết
                honLucCost: 5000,
                type: 'attack',
                multiplier: 45.0, 
                levelReq: 220,
                ignoreDef: 0.8, 
                effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 5 }, 
                thanCachCost: 180000
            },
            'hk_16': {
                id: 'hk_16',
                name: 'Tuyệt Kỹ: Nhân Kiếm Hợp Nhất',
                desc: 'Người và kiếm hòa làm một, đạt cảnh giới vô ngã. Gây 6000% Sát thương chuẩn (Bỏ qua 100% Phòng Thủ).',
                color: 'text-emerald-400 font-black text-shadow-green animate-pulse', 
                icon: 'fa-solid fa-khanda', // [NEW] Icon Kiếm
                honLucCost: 7000,
                type: 'attack',
                multiplier: 60.0, 
                levelReq: 250,
                ignoreDef: 1.0, 
                thanCachCost: 220000
            },
            'hk_17': {
                id: 'hk_17',
                name: 'Thần Kỹ: Thiên Ngoại Lưu Tinh',
                desc: 'Kiếm chiêu đẹp nhất thế gian, như sao băng sa xuống. Gây 9000% Sát thương, 100% Chí Mạng, không thể né tránh.',
                color: 'text-white font-black text-shadow-white animate-pulse', 
                icon: 'fa-solid fa-shuttle-space', // [NEW] Icon Phi thuyền/Sao băng
                honLucCost: 10000,
                type: 'attack',
                multiplier: 90.0, 
                levelReq: 280,
                bonusCrit: 100, 
                ignoreDef: 0.5, 
                thanCachCost: 260000
            },
            'hk_18': {
                id: 'hk_18',
                name: 'Thần Công: Vân Long Kích',
                desc: 'Rồng ẩn trong mây bất ngờ tập kích. Gây 15000% Sát thương diện rộng, làm choáng 5s.',
                color: 'text-cyan-400 font-black text-shadow-blue animate-pulse', 
                icon: 'fa-solid fa-cloud-bolt', // [NEW] Icon Rồng mây
                honLucCost: 15000,
                type: 'attack',
                multiplier: 150.0, 
                levelReq: 300,
                ignoreDef: 0.7, 
                effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 5 }, 
                thanCachCost: 300000
            },
            'hk_19': {
                id: 'hk_19',
                name: 'Tuyệt Kỹ: Âm Phong Thực Cốt',
                desc: 'Gió âm ty thổi qua, ăn mòn xương tủy. Gây 18000% Sát thương, giảm 50% Phòng Thủ địch trong 10s.',
                color: 'text-emerald-400 font-black text-shadow-green animate-pulse', 
                icon: 'fa-solid fa-wind', // [NEW] Icon Gió
                honLucCost: 20000,
                type: 'attack',
                multiplier: 180.0, 
                levelReq: 320,
                ignoreDef: 0.5, 
                effect: { type: 'debuff', stat: 'def', value: -0.5, duration: 10 },
                thanCachCost: 350000
            },
            'hk_20': {
                id: 'hk_20',
                name: 'Thần Công: Vô Tướng Trảm',
                desc: 'Đao pháp vô hình vô tướng, chém đứt hư không. Gây 24000% Sát thương chuẩn (Bỏ qua 100% Thủ).',
                color: 'text-gray-200 font-black text-shadow-white animate-pulse', 
                icon: 'fa-solid fa-xmarks-lines', // [NEW] Icon Vết chém
                honLucCost: 30000,
                type: 'attack',
                multiplier: 240.0, 
                levelReq: 350,
                ignoreDef: 1.0, 
                bonusCrit: 50, 
                thanCachCost: 400000
            },
            'hk_21': {
                id: 'hk_21',
                name: 'Thần Kỹ: Truy Tinh Thục Nguyệt',
                desc: 'Đuổi sao hái trăng, tốc độ cực hạn. Gây 30000% Sát thương liên hoàn, tăng 100% Tốc Độ Đánh trong 10s.',
                color: 'text-indigo-300 font-black text-shadow-blue animate-pulse', 
                icon: 'fa-solid fa-forward', // [NEW] Icon Tốc độ
                honLucCost: 50000,
                type: 'attack',
                multiplier: 300.0, 
                levelReq: 380,
                ignoreDef: 0.8, 
                effect: { type: 'buff', stat: 'spd', value: 1.0, duration: 10 }, 
                thanCachCost: 500000
            },
            'hk_22': {
                id: 'hk_22',
                name: 'Thần Công: Lôi Động Cửu Thiên',
                desc: 'Sấm sét rung chuyển chín tầng trời. Gây 35000% Sát thương diện rộng, làm choáng (giảm tốc 100%) trong 5s.',
                color: 'text-purple-500 font-black text-shadow-purple animate-pulse', 
                icon: 'fa-solid fa-bolt-lightning', // [NEW] Icon Sét lớn
                honLucCost: 60000,
                type: 'attack',
                multiplier: 350.0, 
                levelReq: 420,
                ignoreDef: 0.6, 
                effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 5 },
                thanCachCost: 600000
            },
            'hk_23': {
                id: 'hk_23',
                name: 'Thần Kỹ: Băng Tung Vô Ảnh',
                desc: 'Thân pháp băng giá vô hình. Gây 40000% Sát thương, Đóng băng (Choáng 5s) và Tăng 100% Né Tránh.',
                color: 'text-cyan-200 font-black text-shadow-blue animate-pulse', 
                icon: 'fa-solid fa-icicles', // [NEW] Icon Băng nhọn
                honLucCost: 70000,
                type: 'attack',
                multiplier: 400.0,
                levelReq: 450,
                ignoreDef: 0.7,
                effect: { type: 'buff', stat: 'dodgeChance', value: 100, duration: 5 },
                thanCachCost: 700000
            },
            'hk_24': {
                id: 'hk_24',
                name: 'Tuyệt Kỹ: Nhiếp Hồn Nguyệt Ảnh',
                desc: 'Ánh trăng đoạt hồn. Gây 45000% Sát thương, Hút 50% HP và 50% Nội Lực của địch.',
                color: 'text-indigo-400 font-black text-shadow-purple animate-pulse', 
                icon: 'fa-solid fa-moon', // [NEW] Icon Trăng
                honLucCost: 80000,
                type: 'attack',
                multiplier: 450.0,
                levelReq: 480,
                ignoreDef: 0.6,
                lifesteal: 50,
                manasteal: 50,
                thanCachCost: 800000
            },
             'hk_25': {
                id: 'hk_25',
                name: 'Thần Kỹ: Cửu Cung Phi Tinh',
                desc: 'Chín ngôi sao bay lượn vào tử huyệt. Gây 50000% Sát thương, 100% Chí Mạng, Bỏ qua 80% Thủ.',
                color: 'text-yellow-200 font-black text-shadow-gold animate-pulse', 
                icon: 'fa-solid fa-star', // [NEW] Icon Sao
                honLucCost: 100000,
                type: 'attack',
                multiplier: 500.0,
                levelReq: 520,
                ignoreDef: 0.8,
                bonusCrit: 100,
                thanCachCost: 900000
            },
            'hk_26': {
                id: 'hk_26',
                name: 'Tuyệt Kỹ: Càn Khôn Nhất Trịch',
                desc: 'Một đòn định càn khôn. Tiêu hao lớn để gây 60000% Sát thương chuẩn (True Dmg).',
                color: 'text-red-500 font-black text-shadow-red animate-pulse', 
                icon: 'fa-solid fa-sack-dollar', // [NEW] Icon Ném tiền
                honLucCost: 150000, 
                type: 'attack',
                multiplier: 600.0,
                levelReq: 560,
                ignoreDef: 1.0, 
                thanCachCost: 950000
            },
             'hk_27': {
                id: 'hk_27',
                name: 'Thần Công: Tam Tiên Kiếm',
                desc: 'Ba kiếm đoạt mệnh của Hoa Sơn. Đánh 3 lần, mỗi lần 25000% (Tổng 75000%). Kẻ địch không thể sống sót.',
                color: 'text-blue-300 font-black text-shadow-white animate-pulse', 
                icon: 'fa-brands fa-d-and-d', // [NEW] Icon Huyền ảo
                honLucCost: 200000,
                type: 'attack',
                multiplier: 250.0, 
                hits: 3,
                levelReq: 600,
                ignoreDef: 0.9,
                bonusCrit: 50,
                thanCachCost: 1000000
            }
        };

        // [NEW] Menh Cach (Destiny) Database
        const MENH_CACH_DB = {
            // --- Cát Mệnh (Auspicious) - [MODIFIED] Replaced with new detailed list ---
            'mc_cat_001': {
                id: 'mc_cat_001', name: 'Huy Hoàng', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-sun',
                baseDesc: 'Tăng {value} Công Phép', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_phep', baseValue: 100, scaleValue: 50, isPercent: false,
                sellPrice: 50 // [NEW] Giá bán (phân giải)
            },
            'mc_cat_002': {
                id: 'mc_cat_002', name: 'Thú Đằng', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-paw',
                baseDesc: 'Tăng {value} Công', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk', baseValue: 100, scaleValue: 50, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_003': {
                id: 'mc_cat_003', name: 'Chiến Cuồng', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-hammer',
                baseDesc: 'Tăng {value} Công Kỹ', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_ky', baseValue: 100, scaleValue: 50, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_004': {
                id: 'mc_cat_004', name: 'Tán Hoa', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-shield-heart',
                baseDesc: 'Tăng {value} Thủ Phép', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'def_phep', baseValue: 175, scaleValue: 75, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_005': {
                id: 'mc_cat_005', name: 'Dạ Xoa', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-ghost',
                baseDesc: 'Tăng {value} Công Phép', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_phep', baseValue: 200, scaleValue: 100, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_006': {
                id: 'mc_cat_006', name: 'Dũng Tướng', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-user-shield',
                baseDesc: 'Tăng {value} Thủ Kỹ', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'def_ky', baseValue: 175, scaleValue: 75, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_007': {
                id: 'mc_cat_007', name: 'Phá Quân', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-gavel',
                baseDesc: 'Tăng {value} Công Kỹ', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_ky', baseValue: 200, scaleValue: 100, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_008': {
                id: 'mc_cat_008', name: 'Nham Đả', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-mountain',
                baseDesc: 'Tăng {value} Thủ', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'def', baseValue: 175, scaleValue: 75, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_009': {
                id: 'mc_cat_009', name: 'Tham Lang', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-dog', /* [MODIFIED] Thay fa-wolf-pack-browser (lỗi) bằng fa-dog */
                baseDesc: 'Tăng {value} Công', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk', baseValue: 200, scaleValue: 100, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_010': {
                id: 'mc_cat_010', name: 'Nhiệt Huyết', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-fire',
                baseDesc: 'Tăng {value} Sĩ Khí', scaleDesc: 'Mỗi Cấp Tăng {scale} Sĩ Khí',
                stat: 'si_khi', baseValue: 5, scaleValue: 3, isPercent: false,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_011': {
                id: 'mc_cat_011', name: 'Không Sợ', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-shield',
                baseDesc: 'Tăng {value}% Chống Đỡ', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'block_chance_p', baseValue: 2, scaleValue: 2, isPercent: true,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_012': {
                id: 'mc_cat_012', name: 'Tín Lao', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-crosshairs',
                baseDesc: 'Tăng {value}% Chính Xác', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'accuracy_p', baseValue: 2, scaleValue: 2, isPercent: true,
                sellPrice: 50 // [NEW]
            },
            'mc_cat_013': {
                id: 'mc_cat_013', name: 'Cát Tinh', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-clover',
                baseDesc: 'Tăng {value}% Né Tránh', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'dodgeChance', baseValue: 1, scaleValue: 1, isPercent: true, // [FIX] dodge_p -> dodgeChance
                sellPrice: 50 
            },
            'mc_cat_014': {
                id: 'mc_cat_014', name: 'Trảm Thiết', type: 'cat', quality: 'rare',
                icon: 'fa-solid fa-burst',
                baseDesc: 'Tăng {value}% Bạo Kích', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'critChance', baseValue: 2, scaleValue: 2, isPercent: true, // [FIX] crit_chance_p -> critChance
                sellPrice: 50 
            },
            // Tier 2 - Legendary (Vàng)
            'mc_cat_015': {
                id: 'mc_cat_015', name: 'Đại Phá Hoại Thần', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-meteor',
                baseDesc: 'Tăng {value} Công Phép', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_phep', baseValue: 300, scaleValue: 150, isPercent: false,
                sellPrice: 250 // [NEW]
            },
            'mc_cat_016': {
                id: 'mc_cat_016', name: 'Hiên Viên Kiếm Thế', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-khanda',
                baseDesc: 'Tăng {value} Công Kỹ', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_ky', baseValue: 300, scaleValue: 150, isPercent: false,
                sellPrice: 250 // [NEW]
            },
            'mc_cat_017': {
                id: 'mc_cat_017', name: 'Bồng Long Ngộ Hổ', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-dragon',
                baseDesc: 'Tăng {value} Công', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk', baseValue: 300, scaleValue: 150, isPercent: false,
                sellPrice: 250 // [NEW]
            },
            'mc_cat_018': {
                id: 'mc_cat_018', name: 'Rung Trời Chuyển Đất', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-bolt-lightning',
                baseDesc: 'Tăng {value} Sĩ Khí', scaleDesc: 'Mỗi Cấp Tăng {scale} Sĩ Khí',
                stat: 'si_khi', baseValue: 15, scaleValue: 4, isPercent: false,
                sellPrice: 250 // [NEW]
            },
            'mc_cat_019': {
                id: 'mc_cat_019', name: 'Khoái Đao Loạn Ma', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-scissors', /* [MODIFIED] Đổi icon sang cái kéo (cắt đứt rối loạn/chống đỡ) */
                baseDesc: 'Giảm {value}% Chống Đỡ của đối phương', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'anti_block_p', baseValue: 4, scaleValue: 4, isPercent: true,
                sellPrice: 250 // [NEW]
            },
            'mc_cat_020': {
                id: 'mc_cat_020', name: 'Nhất Nguyên Phục Sử', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-eye',
                baseDesc: 'Tăng {value}% Chính Xác', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'accuracy_p', baseValue: 3, scaleValue: 3, isPercent: true,
                sellPrice: 250 // [NEW]
            },
            'mc_cat_021': {
                id: 'mc_cat_021', name: 'Thiên Địa Vô Dụng', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-shield-halved',
                baseDesc: 'Tăng {value}% Chống Đỡ', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'block_chance_p', baseValue: 3, scaleValue: 3, isPercent: true,
                sellPrice: 250 // [NEW]
            },
            'mc_cat_022': {
                id: 'mc_cat_022', name: 'Thiên Kinh Vạn Hỉ', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-person-running',
                baseDesc: 'Tăng {value}% Né Tránh', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'dodgeChance', baseValue: 2, scaleValue: 2, isPercent: true, // [FIX] dodge_p -> dodgeChance
                sellPrice: 250 
            },
            'mc_cat_023': {
                id: 'mc_cat_023', name: 'Bá Giả Hoành Han', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-fire-flame-curved',
                baseDesc: 'Tăng {value}% Bạo Kích', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'critChance', baseValue: 3, scaleValue: 3, isPercent: true, // [FIX] crit_chance_p -> critChance
                sellPrice: 250 
            },
            'mc_cat_024': {
                id: 'mc_cat_024', name: 'Bất Tử Điểu', type: 'cat', quality: 'legendary',
                icon: 'fa-solid fa-feather-pointed',
                baseDesc: 'Tăng {value} HP', scaleDesc: 'Mỗi Cấp Tăng {scale} HP',
                stat: 'hp', baseValue: 1000, scaleValue: 1000, isPercent: false,
                sellPrice: 250 // [NEW]
            },
            // Tier 3 - Epic (Cam)
            'mc_cat_025': {
                id: 'mc_cat_025', name: 'Chân Đại Phá Hoại Thần', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-meteor', /* [MODIFIED] Thay fa-user-astronaut */
                baseDesc: 'Tăng {value} Công Phép', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_phep', baseValue: 500, scaleValue: 500, isPercent: false,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_026': {
                id: 'mc_cat_026', name: 'Chân Hiên Viên Kiếm Thể', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-khanda', /* [MODIFIED] Thay fa-wand-sparkles */
                baseDesc: 'Tăng {value} Công Kỹ', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk_ky', baseValue: 500, scaleValue: 500, isPercent: false,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_027': {
                id: 'mc_cat_027', name: 'Chân Bồng Long Ngộ Hổ', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-paw', /* [MODIFIED] Thay fa-tiger (lỗi) bằng fa-paw */
                baseDesc: 'Tăng {value} Công', scaleDesc: 'Mỗi Cấp Tăng {scale} Điểm',
                stat: 'atk', baseValue: 500, scaleValue: 500, isPercent: false,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_028': {
                id: 'mc_cat_028', name: 'Vật Đổi Sao Dời', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-arrows-rotate',
                baseDesc: 'Giảm {value}% Bạo Kích của đối phương', scaleDesc: 'Mỗi Cấp Giảm {scale}%',
                stat: 'anti_crit_p', baseValue: 6, scaleValue: 6, isPercent: true,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_029': {
                id: 'mc_cat_029', name: 'Phá Toái Hư Không', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-circle-nodes',
                baseDesc: 'Giảm {value}% Chống Đỡ của đối phương', scaleDesc: 'Mỗi Cấp Giảm {scale}%',
                stat: 'anti_block_p', baseValue: 6, scaleValue: 6, isPercent: true,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_030': {
                id: 'mc_cat_030', name: 'Bách Bộ Xuyên Dương', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-bullseye',
                baseDesc: 'Tăng {value}% Chính Xác', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'accuracy_p', baseValue: 6, scaleValue: 6, isPercent: true,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_031': {
                id: 'mc_cat_031', name: 'Vạn Thọ Vô Cương', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-heart-circle-plus',
                baseDesc: 'Tăng {value} HP', scaleDesc: 'Mỗi Cấp Tăng {scale} HP',
                stat: 'hp', baseValue: 2000, scaleValue: 2000, isPercent: false,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_032': {
                id: 'mc_cat_032', name: 'Phi Tiên', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-wind', /* [MODIFIED] Thay fa-jet-fighter-up */
                baseDesc: 'Tăng {value} Sĩ Khí', scaleDesc: 'Mỗi Cấp Tăng {scale} Sĩ Khí',
                stat: 'si_khi', baseValue: 25, scaleValue: 5, isPercent: false,
                sellPrice: 1000 // [NEW]
            },
            'mc_cat_033': {
                id: 'mc_cat_033', name: 'Chu Tiên', type: 'cat', quality: 'epic',
                icon: 'fa-solid fa-bahai', 
                baseDesc: 'Tăng {value}% Sát Thương Bạo Kích', scaleDesc: 'Mỗi Cấp Tăng {scale}%',
                stat: 'critDamage', baseValue: 6, scaleValue: 6, isPercent: true, // [FIX] crit_damage_p -> critDamage
                sellPrice: 1000 
            },

            // --- Hung Mệnh (Inauspicious) ---
            'mc_hung_001': {
                id: 'mc_hung_001', name: 'Vận Rủi Đeo Bám', type: 'hung', quality: 'uncommon',
                icon: 'fa-solid fa-face-frown',
                desc: 'Giảm 20% May Mắn (LCK) cơ bản.',
                effect: [{ id: 'lck_p', value: -20, isPercent: true }],
                sellPrice: 10 // [NEW] Giá bán Hung Mệnh
            },
            'mc_hung_002': {
                id: 'mc_hung_002', name: 'Thân Thể Yếu Đuối', type: 'hung', quality: 'rare',
                icon: 'fa-solid fa-lungs-virus',
                desc: 'Giảm 10% Sinh Lực (HP) và 10% Phòng Thủ (DEF) cơ bản.',
                effect: [
                    { id: 'hp_p', value: -10, isPercent: true },
                    { id: 'def_p', value: -10, isPercent: true }
                ],
                sellPrice: 100 // [NEW] Giá bán Hung Mệnh
            },
            'mc_hung_003': {
                id: 'mc_hung_003', name: 'Tay Chân Chậm Chạp', type: 'hung', quality: 'rare',
                icon: 'fa-solid fa-person-walking-dashed-line',
                desc: 'Giảm 15% Thân Pháp (SPD) cơ bản.',
                effect: [{ id: 'spd_p', value: -15, isPercent: true }],
                sellPrice: 100 // [NEW] Giá bán Hung Mệnh
            },
            'mc_hung_004': {
                id: 'mc_hung_004', name: 'Thiên Sát Cô Tinh', type: 'hung', quality: 'mythic',
                icon: 'fa-solid fa-skull', /* [MODIFIED] Cập nhật icon Đầu Lâu */
                desc: 'Tăng 30% Công Kích (ATK), nhưng giảm 30% Phòng Thủ (DEF) và 30% Sinh Lực (HP).',
                effect: [
                    { id: 'atk_p', value: 30, isPercent: true },
                    { id: 'def_p', value: -30, isPercent: true },
                    { id: 'hp_p', value: -30, isPercent: true }
                ],
                sellPrice: 1000 // [NEW] Giá bán Hung Mệnh
            },
        };

        // [NEW] --- Database cho các Gói Liệp Mệnh ---
        const SUMMON_POOLS_DB = {
            'pool_1': {
                levelReq: 20,
                cost: 100,
                cost_10: 1000,
                rates: {
                    'uncommon': 70, // Xanh (Chủ yếu Hung)
                    'rare': 30,     // Tím (Cát + Hung)
                    'legendary': 0,
                    'epic': 0
                }
            },
            'pool_2': {
                levelReq: 40,
                cost: 1000,
                cost_10: 10000,
                rates: {
                    'uncommon': 0,
                    'rare': 79,     // Tím
                    'legendary': 20, // Vàng
                    'epic': 1
                }
            },
            'pool_3': {
                levelReq: 60,
                cost: 10000,
                cost_10: 100000,
                rates: {
                    'uncommon': 0,
                    'rare': 0,
                    'legendary': 85, // Vàng
                    'epic': 15      // Cam
                }
            }
        };

        // [NEW] Helper để lấy danh sách Menh Cach ID theo Phẩm chất
        const MENH_CACH_BY_QUALITY = {
            'uncommon': [],
            'rare': [],
            'legendary': [],
            'epic': [],
            'mythic': []
        };
        // Tự động điền danh sách khi game tải
        (function() {
            for (const id in MENH_CACH_DB) {
                const mc = MENH_CACH_DB[id];
                if (MENH_CACH_BY_QUALITY[mc.quality]) {
                    // Chỉ thêm Cát Mệnh và Hung Mệnh vào các gói quay
                    // Bỏ qua các Mệnh Cách đặc biệt (nếu có)
                    if (mc.type === 'cat' || mc.type === 'hung') {
                         // [FIX] Bỏ qua Mệnh Đỏ (Mythic) khỏi các gói quay thường
                         if (mc.quality !== 'mythic') {
                            MENH_CACH_BY_QUALITY[mc.quality].push(id);
                         }
                    }
                }
            }
        })();
        // [END NEW]

        // [NEW] Dau La Dai Luc Database
        const DAULADAILUC_ENEMIES_DB = {
            // [FIX] THÊM ĐỐI THỦ VÕ ĐÀI VÀO DATABASE ĐỂ TRÁNH LỖI INSTANT-LOSE
            'arena_npc': { 
                name: 'Đối Thủ Võ Đài', 
                level: 1, 
                rarity: 3, 
                icon: 'fa-solid fa-user-ninja', 
                stats: { hp: 100, atk: 10, def: 10, spd: 10, lck: 10 }, 
                skills: [{ name: 'Tuyệt Kỹ Trấn Phái', chance: 0, multiplier: 1.2 }], 
                rewards: { xp: 0, nganLuong: 0 } 
            },
            // [FIX] THÊM ĐỐI THỦ BÁCH THẮNG VÀO DATABASE ĐỂ TRÁNH LỖI REWARDS UNDEFINED
            'bach_thang_npc': { 
                name: 'Bách Thắng Danh Tướng', 
                level: 1, 
                rarity: 4, 
                icon: 'fa-solid fa-user-injured', 
                stats: { hp: 100, atk: 10, def: 10, spd: 10, lck: 10 }, 
                skills: [{ name: 'Bách Chiến Bách Thắng', chance: 0, multiplier: 1.5 }], 
                rewards: { xp: 100, nganLuong: 100 } 
            },
            
            // [FIX NEW] THÊM DỮ LIỆU TÂM MA (SHADOW BOSS) - QUAN TRỌNG
            // Khắc phục lỗi thiếu dữ liệu khiến trận đấu kết thúc ngay lập tức hoặc quái yếu
            'shadow_boss': {
                name: 'Tâm Ma',
                level: 1, // Cấp độ giả (sẽ được ghi đè)
                rarity: 5, // Độ hiếm (Màu đỏ)
                icon: 'fa-solid fa-user-ninja',
                // Chỉ số giả (sẽ được ghi đè khi startShadowBattle)
                stats: { hp: 1000, atk: 100, def: 100, spd: 100, lck: 100 }, 
                // Kỹ năng của Tâm Ma
                skills: [
                    { name: 'Hắc Ám Trảm', chance: 0, multiplier: 1.2 }, // Đòn đánh thường 120% sát thương
                    { name: 'Phản Phệ', chance: 30, multiplier: 1.5, ignoreDef: 0.2 } // Kỹ năng 30% tỷ lệ, 150% ST, xuyên giáp
                ],
                rewards: { xp: 0, nganLuong: 0 } // Phần thưởng xử lý riêng
            },

            'dll_mob_1': { 
                name: 'Hồn Thú 10 năm - Mạn Đà La Xà', 
                level: 1, 
                rarity: 1, 
                icon: 'fa-solid fa-snake', 
                stats: { hp: 50, atk: 8, def: 2, spd: 5, lck: 5 }, 
                skills: [{ name: 'Đớp', chance: 0, multiplier: 1 }],
                rewards: {
                    xp: 50,
                    nganLuong: 100,
                    honLuc: 5, // Hồi 5 Hồn Lực
                    linhKhi: 1, // [NEW] Thưởng Linh Khí
                    loot: [ // [NEW] Thêm phần thưởng rơi đồ
                        { id: 'item_hp_small', chance: 20 }, // 20% rơi Tiểu Hồng Dược
                        { id: 'ore_common_1', chance: 15 }   // 15% rơi Mảnh Sắt
                    ],
                    equipChance: 1 // [NEW] 1% chance to drop equipment
                }
            },
            'dll_mob_2': { 
                name: 'Hồn Thú 10 năm - U Minh Lang', 
                level: 2, 
                rarity: 1, 
                icon: 'fa-solid fa-wolf-pack-browser', // (Placeholder icon)
                stats: { hp: 70, atk: 10, def: 3, spd: 8, lck: 5 }, 
                skills: [{ name: 'Vồ', chance: 0, multiplier: 1.1 }],
                rewards: {
                    xp: 75,
                    nganLuong: 150,
                    honLuc: 8,
                    linhKhi: 2, // [NEW] Thưởng Linh Khí
                    loot: [ // [NEW] Thêm phần thưởng rơi đồ
                        { id: 'item_hp_small', chance: 30 }, // 30% rơi Tiểu Hồng Dược
                        { id: 'ore_uncommon_1', chance: 10 } // 10% rơi Mảnh Đồng
                    ],
                    equipChance: 1.5 // [NEW] 1.5% chance to drop equipment
                }
            },
            // [NEW] Enemies for Shrek Academy
            'dll_mob_3': { 
                name: 'Hồn Thú 100 năm - Quỷ Đằng', 
                level: 5, 
                rarity: 2, 
                icon: 'fa-solid fa-seedling', 
                stats: { hp: 120, atk: 15, def: 8, spd: 10, lck: 5 }, 
                skills: [{ name: 'Quấn', chance: 20, multiplier: 1.2 }],
                rewards: {
                    xp: 150,
                    nganLuong: 250,
                    honLuc: 10,
                    linhKhi: 3,
                    loot: [
                        { id: 'item_hp_small', chance: 35 },
                        { id: 'herb_uncommon_1', chance: 15 } // Rơi Bạc Hà
                    ],
                    equipChance: 2
                }
            },
            'dll_mob_4': { 
                name: 'Hồn Thú 100 năm - Phượng Vĩ Kê', // Phoenix-Tail Rooster
                level: 7, 
                rarity: 2, 
                icon: 'fa-solid fa-feather-pointed', 
                stats: { hp: 100, atk: 20, def: 5, spd: 15, lck: 10 }, 
                skills: [{ name: 'Mổ', chance: 0, multiplier: 1.1 }],
                rewards: {
                    xp: 180,
                    nganLuong: 300,
                    honLuc: 12,
                    linhKhi: 4,
                    loot: [
                        { id: 'item_hp_small', chance: 25 },
                        { id: 'item_mana_small', chance: 10 }
                    ],
                    equipChance: 2.5
                }
            },
            // [NEW] Enemies for Tinh Dau Sam Lam
            'dll_mob_5': { 
                name: 'Hồn Thú 1000 năm - Nhân H 面 Ma Chu', // Man-Faced Demon Spider
                level: 10, 
                rarity: 3, 
                icon: 'fa-solid fa-spider', 
                stats: { hp: 250, atk: 30, def: 15, spd: 20, lck: 10 }, 
                skills: [{ name: 'Độc Tố', chance: 25, multiplier: 1.5 }],
                rewards: {
                    xp: 300,
                    nganLuong: 500,
                    honLuc: 15,
                    linhKhi: 6,
                    loot: [
                        { id: 'item_hp_medium', chance: 10 },
                        { id: 'ore_rare_1', chance: 10 } // Rơi Mảnh Bạc
                    ],
                    equipChance: 3.5
                }
            },
            'dll_mob_6': { 
                name: 'Hồn Thú 1000 năm - Thái Thản Cự Viên', // Titan Giant Ape
                level: 12, 
                rarity: 4, 
                icon: 'fa-solid fa-hand-fist', // Placeholder
                stats: { hp: 500, atk: 25, def: 40, spd: 10, lck: 5 }, 
                skills: [{ name: 'Nện', chance: 20, multiplier: 2.0 }],
                rewards: {
                    xp: 500,
                    nganLuong: 1000,
                    honLuc: 25,
                    linhKhi: 10,
                    loot: [
                        { id: 'item_hp_medium', chance: 20 },
                        { id: 'upgrade_stone_medium', chance: 5 } // Rơi Đá Cường Hóa Trung
                    ],
                    equipChance: 5,
                    unlockHonKy: 'hk_1', // [NEW]
                    unlockHonKyChance: 100 // [NEW] 100% chance
                }
            },
            // [NEW] Enemies for Cuc Bac Bang Nguyen
            'dll_mob_7': { 
                name: 'Hồn Thú 1000 năm - Băng Tằm', 
                level: 15, 
                rarity: 3, 
                icon: 'fa-solid fa-bug', 
                stats: { hp: 400, atk: 35, def: 30, spd: 25, lck: 15 }, 
                skills: [{ name: 'Tơ Băng', chance: 20, multiplier: 1.3 }],
                rewards: {
                    xp: 450,
                    nganLuong: 800,
                    honLuc: 15,
                    linhKhi: 8,
                    loot: [
                        { id: 'item_hp_medium', chance: 15 },
                        { id: 'herb_rare_1', chance: 10 } // Rơi Linh Chi
                    ],
                    equipChance: 4
                }
            },
            'dll_mob_8': { 
                name: 'Hồn Thú 1000 năm - Băng Hùng', 
                level: 17, 
                rarity: 4, 
                icon: 'fa-solid fa-paw', 
                stats: { hp: 700, atk: 45, def: 50, spd: 15, lck: 10 }, 
                skills: [{ name: 'Vả', chance: 25, multiplier: 1.8 }],
                rewards: {
                    xp: 600,
                    nganLuong: 1200,
                    honLuc: 20,
                    linhKhi: 12,
                    loot: [
                        { id: 'item_hp_medium', chance: 25 },
                        { id: 'upgrade_stone_medium', chance: 10 }
                    ],
                    equipChance: 5.5
                }
            },
            // [NEW] Enemies for Hai Than Dao
            'dll_mob_9': { 
                name: 'Hồn Thú 1 vạn năm - Hải Hồn Thú', 
                level: 20, 
                rarity: 4, 
                icon: 'fa-solid fa-fish-fins', 
                stats: { hp: 1000, atk: 60, def: 40, spd: 40, lck: 15 }, 
                skills: [{ name: 'Sóng Cuốn', chance: 20, multiplier: 1.5 }],
                rewards: {
                    xp: 800,
                    nganLuong: 1500,
                    honLuc: 25,
                    linhKhi: 15,
                    loot: [
                        { id: 'item_hp_large', chance: 5 },
                        { id: 'fish_epic_1', chance: 5 } // Rơi Cá Rồng
                    ],
                    equipChance: 6
                }
            },
            'dll_mob_10': { 
                name: 'Hồn Thú 1 vạn năm - Ma Hồn Đại Bạch Kình', 
                level: 25, 
                rarity: 5, 
                icon: 'fa-solid fa-whale', 
                stats: { hp: 1500, atk: 75, def: 60, spd: 30, lck: 10 }, 
                skills: [{ name: 'Hút', chance: 30, multiplier: 2.0 }],
                rewards: {
                    xp: 1200,
                    nganLuong: 2500,
                    honLuc: 30,
                    linhKhi: 20,
                    loot: [
                        { id: 'item_hp_large', chance: 10 },
                        { id: 'upgrade_stone_high', chance: 5 }
                    ],
                    equipChance: 7.5,
                    unlockHonKy: 'hk_2', // [NEW]
                    unlockHonKyChance: 100 // [NEW] 100% chance
                }
            },
            // [NEW] Enemies for Vo Hon Dien
            'dll_mob_11': { 
                name: 'Hồn Sư - Hồn Tông', 
                level: 30, 
                rarity: 4, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 1300, atk: 85, def: 70, spd: 50, lck: 20 }, 
                skills: [{ name: 'Hồn Kỹ Bộc Phát', chance: 25, multiplier: 1.8 }],
                rewards: {
                    xp: 1500,
                    nganLuong: 3000,
                    honLuc: 30,
                    linhKhi: 25,
                    loot: [
                        { id: 'item_hp_large', chance: 15 },
                        { id: 'gem_green_2', chance: 2 } // Rơi Lục Thủy Tinh (Trung)
                    ],
                    equipChance: 8
                }
            },
            'dll_mob_12': { 
                name: 'Hồn Sư - Hồn Vương', 
                level: 35, 
                rarity: 5, 
                icon: 'fa-solid fa-user-crown', 
                stats: { hp: 2000, atk: 100, def: 80, spd: 60, lck: 25 }, 
                skills: [{ name: 'Võ Hồn Chân Thân', chance: 30, multiplier: 2.2 }],
                rewards: {
                    xp: 2200,
                    nganLuong: 5000,
                    honLuc: 40,
                    linhKhi: 35,
                    loot: [
                        { id: 'item_hp_large', chance: 20 },
                        { id: 'gem_blue_2', chance: 2 } // Rơi Lam Thủy Tinh (Trung)
                    ],
                    equipChance: 10,
                    unlockHonKy: 'hk_3', // [NEW]
                    unlockHonKyChance: 100 // [NEW] 100% chance
                }
            },
            // [NEW] Enemies for Sa Mạc Huyễn Ảnh (Cấp 40+)
            'dll_mob_13': { 
                name: 'Hồn Thú 3 vạn năm - Sa Chi Hạt', 
                level: 40, 
                rarity: 5, 
                icon: 'fa-solid fa-bug', 
                stats: { hp: 2500, atk: 120, def: 100, spd: 70, lck: 25 }, 
                skills: [{ name: 'Chích Độc', chance: 20, multiplier: 1.5 }],
                rewards: {
                    xp: 3000,
                    nganLuong: 6000,
                    honLuc: 40,
                    linhKhi: 40,
                    loot: [ { id: 'item_hp_large', chance: 25 }, { id: 'gem_green_3', chance: 2 } ],
                    equipChance: 12
                }
            },
            'dll_mob_14': { 
                name: 'Hồn Thú 3 vạn năm - Huyễn Ảnh Xà', 
                level: 45, 
                rarity: 5, 
                icon: 'fa-solid fa-snake', 
                stats: { hp: 3000, atk: 140, def: 80, spd: 90, lck: 30 }, 
                skills: [{ name: 'Ảo Ảnh', chance: 25, multiplier: 1.4 }],
                rewards: {
                    xp: 3500,
                    nganLuong: 7000,
                    honLuc: 45,
                    linhKhi: 45,
                    loot: [ { id: 'item_hp_large', chance: 30 }, { id: 'gem_blue_3', chance: 2 } ],
                    equipChance: 13,
                    // [NEW] Drop Hồn Kỹ 4
                    unlockHonKy: 'hk_4', 
                    unlockHonKyChance: 30 
                }
            },
            // [NEW] Enemies for Lanh Dia Bich Lan Xa (Cấp 70+)
            'dll_mob_15': { 
                name: 'Hồn Thú 5 vạn năm - Bích Lân Xà', 
                level: 70, 
                rarity: 6, 
                icon: 'fa-solid fa-snake', 
                stats: { hp: 5000, atk: 200, def: 150, spd: 100, lck: 30 }, 
                skills: [{ name: 'Độc Dịch', chance: 20, multiplier: 1.6 }],
                rewards: {
                    xp: 5000,
                    nganLuong: 10000,
                    honLuc: 50,
                    linhKhi: 60,
                    loot: [ { id: 'item_hp_large', chance: 35 }, { id: 'gem_purple_3', chance: 2 } ],
                    equipChance: 15
                }
            },
            'dll_mob_16': { 
                name: 'Hồn Thú 5 vạn năm - Bích Lân Xà Hoàng', 
                level: 75, 
                rarity: 7, 
                icon: 'fa-solid fa-crown', 
                stats: { hp: 8000, atk: 250, def: 180, spd: 120, lck: 35 }, 
                skills: [{ name: 'Hoàng Giả Lĩnh Vực', chance: 25, multiplier: 1.8 }],
                rewards: {
                    xp: 7500,
                    nganLuong: 15000,
                    honLuc: 60,
                    linhKhi: 70,
                    loot: [ { id: 'item_hp_large', chance: 50 }, { id: 'gem_yellow_3', chance: 2 } ],
                    equipChance: 18,
                    // [NEW] Drop Hồn Kỹ 5
                    unlockHonKy: 'hk_5', 
                    unlockHonKyChance: 20 
                }
            },
            // [NEW] Enemies for Tham Hai Ma Kinh Vuc (Cấp 120+)
            'dll_mob_17': { 
                name: 'Hồn Thú 10 vạn năm - Thâm Hải Ma Kình', 
                level: 120, 
                rarity: 8, 
                icon: 'fa-solid fa-whale', 
                stats: { hp: 20000, atk: 500, def: 300, spd: 150, lck: 40 }, 
                skills: [{ name: 'Thủy Lôi', chance: 25, multiplier: 2.0 }],
                rewards: {
                    xp: 15000,
                    nganLuong: 30000,
                    honLuc: 75,
                    linhKhi: 100,
                    loot: [ { id: 'item_hp_large', chance: 60 }, { id: 'gem_green_4', chance: 1 } ],
                    equipChance: 22
                }
            },
            'dll_mob_18': { 
                name: 'Hồn Thú 10 vạn năm - Thâm Hải Ma Kình Vương', 
                level: 130, 
                rarity: 9, 
                icon: 'fa-solid fa-water', 
                stats: { hp: 35000, atk: 650, def: 350, spd: 130, lck: 45 }, 
                skills: [{ name: 'Kình Lãng', chance: 30, multiplier: 2.5 }],
                rewards: {
                    xp: 25000,
                    nganLuong: 50000,
                    honLuc: 100,
                    linhKhi: 150,
                    loot: [ { id: 'item_hp_large', chance: 75 }, { id: 'gem_blue_4', chance: 1 } ],
                    equipChance: 25,
                    // [NEW] Drop Hồn Kỹ 6
                    unlockHonKy: 'hk_6', 
                    unlockHonKyChance: 10 
                }
            },
            // [NEW] Enemies for Sat Luc Chi Do (Fix Missing Mob)
            'dll_mob_19': { 
                name: 'Sát Lục Giả', 
                level: 145, 
                rarity: 8, 
                icon: 'fa-solid fa-mask', 
                stats: { hp: 40000, atk: 700, def: 350, spd: 180, lck: 40 }, 
                skills: [{ name: 'Cuồng Bạo', chance: 25, multiplier: 1.8 }],
                rewards: {
                    xp: 30000,
                    nganLuong: 55000,
                    honLuc: 110,
                    linhKhi: 180,
                    loot: [ { id: 'item_hp_large', chance: 60 }, { id: 'upgrade_stone_high', chance: 5 } ],
                    equipChance: 27
                }
            },
            'dll_mob_19_2': { 
                name: 'Đọa Lạc Kỵ Sĩ', 
                level: 148, 
                rarity: 8, 
                icon: 'fa-solid fa-horse-head', 
                stats: { hp: 45000, atk: 750, def: 380, spd: 190, lck: 45 }, 
                skills: [{ name: 'Hắc Ám Xung Kích', chance: 30, multiplier: 2.0 }],
                rewards: {
                    xp: 35000,
                    nganLuong: 60000,
                    honLuc: 115,
                    linhKhi: 190,
                    loot: [ { id: 'item_hp_large', chance: 65 }, { id: 'gem_purple_3', chance: 2 } ],
                    equipChance: 28
                }
            },
            // [NEW] Enemies for Sat Luc Chi Do (Cấp 150+)
            'dll_mob_20': { 
                name: 'Sát Lục Chi Vương', 
                level: 150, 
                rarity: 9, 
                icon: 'fa-solid fa-user-slash', 
                stats: { hp: 50000, atk: 800, def: 400, spd: 200, lck: 50 }, 
                skills: [{ name: 'Sát Ý', chance: 20, multiplier: 2.2 }],
                rewards: {
                    xp: 40000,
                    nganLuong: 70000,
                    honLuc: 120,
                    linhKhi: 200,
                    loot: [ { id: 'item_hp_large', chance: 80 }, { id: 'gem_purple_4', chance: 1 } ],
                    equipChance: 30
                }
            },
            // [NEW] Enemies for Tinh Dau Dai Sam Lam - Khu Loi (Cấp 180+)
            'dll_mob_21': { 
                name: 'Thiên Thanh Ngưu Mãng (Đại Minh)', 
                level: 180, 
                rarity: 9, 
                icon: 'fa-solid fa-dragon', 
                stats: { hp: 150000, atk: 1500, def: 800, spd: 120, lck: 60 }, 
                skills: [{ name: 'Thiên Thanh Tịch Diệt Lôi', chance: 30, multiplier: 2.5, ignoreDef: 0.2 }],
                rewards: {
                    xp: 60000, nganLuong: 100000, honLuc: 150, linhKhi: 250,
                    loot: [ { id: 'item_hp_large', chance: 85 }, { id: 'gem_yellow_3', chance: 3 } ],
                    equipChance: 35
                }
            },
            'dll_mob_22': { 
                name: 'Thái Thản Cự Viên (Nhị Minh)', 
                level: 185, 
                rarity: 9, 
                icon: 'fa-solid fa-hand-fist', 
                stats: { hp: 200000, atk: 1200, def: 1000, spd: 100, lck: 50 }, 
                skills: [{ name: 'Thái Thản Thương Khung Phá', chance: 25, multiplier: 3.0 }],
                rewards: {
                    xp: 65000, nganLuong: 110000, honLuc: 160, linhKhi: 260,
                    loot: [ { id: 'item_hp_large', chance: 85 }, { id: 'upgrade_stone_high', chance: 5 } ],
                    equipChance: 36,
                    // [NEW] Drop Hồn Kỹ 7 (Võ Hồn Chân Thân)
                    unlockHonKy: 'hk_7', 
                    unlockHonKyChance: 10 
                }
            },
            // [NEW] Enemies for Lanh Dia Bich Lan Xa (Cấp 70+)
            'dll_mob_15': { 
                name: 'Hồn Thú 5 vạn năm - Bích Lân Xà', 
                level: 70, 
                rarity: 6, 
                icon: 'fa-solid fa-snake', 
                stats: { hp: 5000, atk: 200, def: 150, spd: 100, lck: 30 }, 
                skills: [{ name: 'Độc Dịch', chance: 20, multiplier: 1.6 }],
                rewards: {
                    xp: 5000,
                    nganLuong: 10000,
                    honLuc: 50,
                    linhKhi: 60,
                    loot: [ { id: 'item_hp_large', chance: 35 }, { id: 'gem_purple_3', chance: 2 } ],
                    equipChance: 15
                }
            },
            'dll_mob_16': { 
                name: 'Hồn Thú 5 vạn năm - Bích Lân Xà Hoàng', 
                level: 75, 
                rarity: 7, 
                icon: 'fa-solid fa-crown', 
                stats: { hp: 8000, atk: 250, def: 180, spd: 120, lck: 35 }, 
                skills: [{ name: 'Hoàng Giả Lĩnh Vực', chance: 25, multiplier: 1.8 }],
                rewards: {
                    xp: 7500,
                    nganLuong: 15000,
                    honLuc: 60,
                    linhKhi: 70,
                    loot: [ { id: 'item_hp_large', chance: 50 }, { id: 'gem_yellow_3', chance: 2 } ],
                    equipChance: 18
                }
            },
            // [NEW] Enemies for Tham Hai Ma Kinh Vuc (Cấp 120+)
            'dll_mob_17': { 
                name: 'Hồn Thú 10 vạn năm - Thâm Hải Ma Kình', 
                level: 120, 
                rarity: 8, 
                icon: 'fa-solid fa-whale', 
                stats: { hp: 20000, atk: 500, def: 300, spd: 150, lck: 40 }, 
                skills: [{ name: 'Thủy Lôi', chance: 25, multiplier: 2.0 }],
                rewards: {
                    xp: 15000,
                    nganLuong: 30000,
                    honLuc: 75,
                    linhKhi: 100,
                    loot: [ { id: 'item_hp_large', chance: 60 }, { id: 'gem_green_4', chance: 1 } ],
                    equipChance: 22
                }
            },
            'dll_mob_18': { 
                name: 'Hồn Thú 10 vạn năm - Thâm Hải Ma Kình Vương', 
                level: 130, 
                rarity: 9, 
                icon: 'fa-solid fa-water', 
                stats: { hp: 35000, atk: 650, def: 350, spd: 130, lck: 45 }, 
                skills: [{ name: 'Kình Lãng', chance: 30, multiplier: 2.5 }],
                rewards: {
                    xp: 25000,
                    nganLuong: 50000,
                    honLuc: 100,
                    linhKhi: 150,
                    loot: [ { id: 'item_hp_large', chance: 75 }, { id: 'gem_blue_4', chance: 1 } ],
                    equipChance: 25
                }
            },
            // [NEW] Enemies for Sat Luc Chi Do (Fix Missing Mob)
            'dll_mob_19': { 
                name: 'Sát Lục Giả', 
                level: 145, 
                rarity: 8, 
                icon: 'fa-solid fa-mask', 
                stats: { hp: 40000, atk: 700, def: 350, spd: 180, lck: 40 }, 
                skills: [{ name: 'Cuồng Bạo', chance: 25, multiplier: 1.8 }],
                rewards: {
                    xp: 30000,
                    nganLuong: 55000,
                    honLuc: 110,
                    linhKhi: 180,
                    loot: [ { id: 'item_hp_large', chance: 60 }, { id: 'upgrade_stone_high', chance: 5 } ],
                    equipChance: 27
                }
            },
            'dll_mob_19_2': { 
                name: 'Đọa Lạc Kỵ Sĩ', 
                level: 148, 
                rarity: 8, 
                icon: 'fa-solid fa-horse-head', 
                stats: { hp: 45000, atk: 750, def: 380, spd: 190, lck: 45 }, 
                skills: [{ name: 'Hắc Ám Xung Kích', chance: 30, multiplier: 2.0 }],
                rewards: {
                    xp: 35000,
                    nganLuong: 60000,
                    honLuc: 115,
                    linhKhi: 190,
                    loot: [ { id: 'item_hp_large', chance: 65 }, { id: 'gem_purple_3', chance: 2 } ],
                    equipChance: 28
                }
            },
            // [NEW] Enemies for Sat Luc Chi Do (Cấp 150+)
            'dll_mob_20': { 
                name: 'Sát Lục Chi Vương', 
                level: 150, 
                rarity: 9, 
                icon: 'fa-solid fa-user-slash', 
                stats: { hp: 50000, atk: 800, def: 400, spd: 200, lck: 50 }, 
                skills: [{ name: 'Sát Ý', chance: 20, multiplier: 2.2 }],
                rewards: {
                    xp: 40000,
                    nganLuong: 70000,
                    honLuc: 120,
                    linhKhi: 200,
                    loot: [ { id: 'item_hp_large', chance: 80 }, { id: 'gem_purple_4', chance: 1 } ],
                    equipChance: 30
                }
            },
            // [FIX] --- Thêm lại quái vật cho Tu Chân Giới (Bị thiếu) ---
            'tcg_mob_1': { 
                name: 'Yêu Thú - Lang Yêu (10 năm)', 
                level: 3, 
                rarity: 1, 
                icon: 'fa-solid fa-wolf-pack-browser', 
                stats: { hp: 80, atk: 12, def: 5, spd: 8, lck: 5 }, 
                skills: [{ name: 'Cắn', chance: 0, multiplier: 1 }],
                rewards: {
                    xp: 80,
                    nganLuong: 160,
                    honLuc: 0, // TCG dùng Linh Khí
                    linhKhi: 5,
                    loot: [ { id: 'item_hp_small', chance: 20 }, { id: 'manh_phap_bao', chance: 10 } ],
                    equipChance: 1.2
                }
            },
            'tcg_mob_2': { 
                name: 'Yêu Thú - Hổ Yêu (10 năm)', 
                level: 5, 
                rarity: 2, 
                icon: 'fa-solid fa-tiger', 
                stats: { hp: 130, atk: 18, def: 8, spd: 5, lck: 5 }, 
                skills: [{ name: 'Vồ', chance: 20, multiplier: 1.2 }],
                rewards: {
                    xp: 130,
                    nganLuong: 250,
                    honLuc: 0,
                    linhKhi: 8,
                    loot: [ { id: 'item_hp_small', chance: 30 }, { id: 'manh_phap_bao', chance: 15 } ],
                    equipChance: 1.8
                }
            },
            'tcg_mob_3': { 
                name: 'Yêu Thú - Hắc Phong Điêu (100 năm)', 
                level: 10, 
                rarity: 2, 
                icon: 'fa-solid fa-dove', 
                stats: { hp: 200, atk: 25, def: 10, spd: 20, lck: 10 }, 
                skills: [{ name: 'Phong Nhận', chance: 25, multiplier: 1.3 }],
                rewards: {
                    xp: 220,
                    nganLuong: 400,
                    honLuc: 0,
                    linhKhi: 12,
                    loot: [ { id: 'item_hp_small', chance: 35 }, { id: 'manh_phap_bao', chance: 20 } ],
                    equipChance: 2.2
                }
            },
            'tcg_mob_4': { 
                name: 'Yêu Thú - Thiết Giáp Tê (100 năm)', 
                level: 12, 
                rarity: 3, 
                icon: 'fa-solid fa-hippo', 
                stats: { hp: 300, atk: 20, def: 25, spd: 10, lck: 5 }, 
                skills: [{ name: 'Húc', chance: 20, multiplier: 1.5 }],
                rewards: {
                    xp: 280,
                    nganLuong: 500,
                    honLuc: 0,
                    linhKhi: 15,
                    loot: [ { id: 'item_hp_medium', chance: 10 }, { id: 'manh_phap_bao_trung', chance: 5 } ],
                    equipChance: 2.8
                }
            },
            'tcg_mob_5': { 
                name: 'Yêu Điêu - Kim Quang Điêu (1000 năm)', 
                level: 20, 
                rarity: 3, 
                icon: 'fa-solid fa-crow', 
                stats: { hp: 500, atk: 40, def: 20, spd: 35, lck: 15 }, 
                skills: [{ name: 'Kim Quang', chance: 30, multiplier: 1.6 }],
                rewards: {
                    xp: 550,
                    nganLuong: 1000,
                    honLuc: 0,
                    linhKhi: 20,
                    loot: [ { id: 'item_hp_medium', chance: 15 }, { id: 'manh_phap_bao_trung', chance: 10 } ],
                    equipChance: 3.5
                }
            },
            'tcg_mob_6': { 
                name: 'Yêu Thú - Tam Nhãn Linh Hầu (1000 năm)', 
                level: 22, 
                rarity: 4, 
                icon: 'fa-solid fa-monkey', 
                stats: { hp: 650, atk: 50, def: 30, spd: 40, lck: 20 }, 
                skills: [{ name: 'Hỏa Nhãn', chance: 30, multiplier: 1.8 }],
                rewards: {
                    xp: 700,
                    nganLuong: 1300,
                    honLuc: 0,
                    linhKhi: 25,
                    loot: [ { id: 'item_hp_medium', chance: 20 }, { id: 'manh_phap_bao_trung', chance: 15 } ],
                    equipChance: 4.5
                }
            },
            'tcg_mob_7': { 
                name: 'Ma Tu - Luyện Hồn Tướng', 
                level: 30, 
                rarity: 4, 
                icon: 'fa-solid fa-user-ghost', 
                stats: { hp: 900, atk: 65, def: 40, spd: 45, lck: 20 }, 
                skills: [{ name: 'Hồn Trảm', chance: 25, multiplier: 1.7 }],
                rewards: {
                    xp: 1000,
                    nganLuong: 1800,
                    honLuc: 0,
                    linhKhi: 30,
                    loot: [ { id: 'item_hp_medium', chance: 25 }, { id: 'manh_phap_bao_cao', chance: 5 } ],
                    equipChance: 5.5
                }
            },
            'tcg_mob_8': { 
                name: 'Quỷ Tướng - Hắc Giáp', 
                level: 32, 
                rarity: 5, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 1200, atk: 55, def: 60, spd: 30, lck: 15 }, 
                skills: [{ name: 'Quỷ Giáp', chance: 20, multiplier: 1.5 }],
                rewards: {
                    xp: 1300,
                    nganLuong: 2200,
                    honLuc: 0,
                    linhKhi: 35,
                    loot: [ { id: 'item_hp_medium', chance: 30 }, { id: 'manh_phap_bao_cao', chance: 7 } ],
                    equipChance: 6
                }
            },
            'tcg_mob_9': { 
                name: 'Yêu Thú - Huyết Giao (3000 năm)', 
                level: 40, 
                rarity: 5, 
                icon: 'fa-solid fa-dragon', 
                stats: { hp: 2000, atk: 80, def: 50, spd: 50, lck: 20 }, 
                skills: [{ name: 'Huyết Lãng', chance: 30, multiplier: 1.9 }],
                rewards: {
                    xp: 2000,
                    nganLuong: 3500,
                    honLuc: 0,
                    linhKhi: 45,
                    loot: [ { id: 'item_hp_large', chance: 10 }, { id: 'manh_phap_bao_cao', chance: 10 } ],
                    equipChance: 7.5
                }
            },
            'tcg_mob_10': { 
                name: 'Ma Tu - Huyết Y Lão Tổ', 
                level: 42, 
                rarity: 6, 
                icon: 'fa-solid fa-user-graduate', 
                stats: { hp: 1800, atk: 95, def: 40, spd: 60, lck: 25 }, 
                skills: [{ name: 'Huyết Chú', chance: 35, multiplier: 2.1 }],
                rewards: {
                    xp: 2500,
                    nganLuong: 4500,
                    honLuc: 0,
                    linhKhi: 50,
                    loot: [ { id: 'item_hp_large', chance: 15 }, { id: 'manh_phap_bao_cao', chance: 12 } ],
                    equipChance: 8.5
                }
            },
            'tcg_mob_11': { 
                name: 'Lôi Linh - Hình Người', 
                level: 50, 
                rarity: 6, 
                icon: 'fa-solid fa-bolt-lightning', 
                stats: { hp: 3000, atk: 120, def: 60, spd: 70, lck: 25 }, 
                skills: [{ name: 'Lôi Kích', chance: 30, multiplier: 2.0 }],
                rewards: {
                    xp: 3500,
                    nganLuong: 6000,
                    honLuc: 0,
                    linhKhi: 60,
                    loot: [ { id: 'item_hp_large', chance: 20 }, { id: 'gem_green_3', chance: 1 } ],
                    equipChance: 10
                }
            },
            'tcg_mob_12': { 
                name: 'Lôi Thú - Cổ Đại', 
                level: 52, 
                rarity: 7, 
                icon: 'fa-solid fa-bolt', 
                stats: { hp: 4000, atk: 110, def: 80, spd: 50, lck: 20 }, 
                skills: [{ name: 'Lôi Giáp', chance: 25, multiplier: 1.8 }],
                rewards: {
                    xp: 4200,
                    nganLuong: 7000,
                    honLuc: 0,
                    linhKhi: 65,
                    loot: [ { id: 'item_hp_large', chance: 25 }, { id: 'gem_blue_3', chance: 1 } ],
                    equipChance: 11
                }
            },
            'tcg_mob_13': { 
                name: 'Tàn Hồn - Cổ Chiến Binh', 
                level: 70, 
                rarity: 7, 
                icon: 'fa-solid fa-ghost', 
                stats: { hp: 6000, atk: 180, def: 90, spd: 80, lck: 30 }, 
                skills: [{ name: 'Chiến Ý', chance: 30, multiplier: 2.2 }],
                rewards: {
                    xp: 6000,
                    nganLuong: 10000,
                    honLuc: 0,
                    linhKhi: 80,
                    loot: [ { id: 'item_hp_large', chance: 30 }, { id: 'gem_purple_3', chance: 1 } ],
                    equipChance: 13
                }
            },
            'tcg_mob_14': { 
                name: 'Cổ Ma - Hóa Thân', 
                level: 72, 
                rarity: 8, 
                icon: 'fa-solid fa-poo', 
                stats: { hp: 7500, atk: 200, def: 100, spd: 70, lck: 25 }, 
                skills: [{ name: 'Ma Khí', chance: 35, multiplier: 2.4 }],
                rewards: {
                    xp: 7000,
                    nganLuong: 12000,
                    honLuc: 0,
                    linhKhi: 90,
                    loot: [ { id: 'item_hp_large', chance: 35 }, { id: 'gem_yellow_3', chance: 1 } ],
                    equipChance: 15
                }
            },
            'tcg_mob_15': { 
                name: 'Khôi Lỗi - Tiên Phủ (Binh)', 
                level: 80, 
                rarity: 8, 
                icon: 'fa-solid fa-robot', 
                stats: { hp: 10000, atk: 250, def: 150, spd: 60, lck: 20 }, 
                skills: [{ name: 'Trảm', chance: 25, multiplier: 2.0 }],
                rewards: {
                    xp: 9000,
                    nganLuong: 15000,
                    honLuc: 0,
                    linhKhi: 100,
                    loot: [ { id: 'item_hp_large', chance: 40 }, { id: 'gem_green_4', chance: 1 } ],
                    equipChance: 17
                }
            },
            'tcg_mob_16': { 
                name: 'Kiếm Linh - Tiên Phủ (Tướng)', 
                level: 82, 
                rarity: 9, 
                icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 9000, atk: 300, def: 120, spd: 100, lck: 35 }, 
                skills: [{ name: 'Kiếm Ý', chance: 35, multiplier: 2.5 }],
                rewards: {
                    xp: 11000,
                    nganLuong: 18000,
                    honLuc: 0,
                    linhKhi: 120,
                    loot: [ { id: 'item_hp_large', chance: 45 }, { id: 'gem_blue_4', chance: 1 } ],
                    equipChance: 19
                }
            },
            'tcg_mob_17': { 
                name: 'Dị Thú - Tinh Hà', 
                level: 100, 
                rarity: 9, 
                icon: 'fa-solid fa-meteor', 
                stats: { hp: 15000, atk: 380, def: 180, spd: 90, lck: 30 }, 
                skills: [{ name: 'Nuốt', chance: 30, multiplier: 2.3 }],
                rewards: {
                    xp: 15000,
                    nganLuong: 25000,
                    honLuc: 0,
                    linhKhi: 140,
                    loot: [ { id: 'item_hp_large', chance: 50 }, { id: 'gem_purple_4', chance: 1 } ],
                    equipChance: 21
                }
            },
            'tcg_mob_18': { 
                name: 'Thiên Ma - Ngoại Vực', 
                level: 110, 
                rarity: 10, 
                icon: 'fa-solid fa-alien-8bit', 
                stats: { hp: 20000, atk: 450, def: 200, spd: 110, lck: 40 }, 
                skills: [{ name: 'Ma Âm', chance: 35, multiplier: 2.6 }],
                rewards: {
                    xp: 20000,
                    nganLuong: 35000,
                    honLuc: 0,
                    linhKhi: 160,
                    loot: [ { id: 'item_hp_large', chance: 60 }, { id: 'gem_yellow_4', chance: 1 } ],
                    equipChance: 24
                }
            },
            'tcg_mob_19': { 
                name: 'Hỗn Độn Chi Linh', 
                level: 140, 
                rarity: 10, 
                icon: 'fa-solid fa-hurricane', 
                stats: { hp: 40000, atk: 600, def: 300, spd: 100, lck: 40 }, 
                skills: [{ name: 'Hỗn Độn', chance: 30, multiplier: 2.8 }],
                rewards: {
                    xp: 30000,
                    nganLuong: 50000,
                    honLuc: 0,
                    linhKhi: 180,
                    loot: [ { id: 'item_hp_large', chance: 70 }, { id: 'gem_yellow_4', chance: 2 } ],
                    equipChance: 28
                }
            },
            'tcg_mob_20': { 
                name: 'Kẻ Thôn Phệ', 
                level: 145, 
                rarity: 10, 
                icon: 'fa-solid fa-circle-nodes', 
                stats: { hp: 35000, atk: 700, def: 250, spd: 120, lck: 50 }, 
                skills: [{ name: 'Thôn Phệ', chance: 35, multiplier: 3.0, ignoreDef: 0.1 }],
                rewards: {
                    xp: 35000,
                    nganLuong: 60000,
                    honLuc: 0,
                    linhKhi: 200,
                    loot: [ { id: 'item_hp_large', chance: 80 }, { id: 'gem_purple_4', chance: 2 } ],
                    equipChance: 30
                }
            },
            // [END FIX] --- Hết quái Tu Chân Giới ---
            'ktg_mob_1': { 
                name: 'Dân Quân (Tống)', 
                level: 5, 
                rarity: 1, 
                icon: 'fa-solid fa-shield-halved', 
                stats: { hp: 110, atk: 16, def: 7, spd: 10, lck: 5 }, 
                skills: [{ name: 'Đâm Thương', chance: 0, multiplier: 1 }],
                rewards: {
                    xp: 110,
                    nganLuong: 220,
                    honLuc: 0,
                    linhKhi: 3, // Thưởng Linh Khí
                    loot: [ { id: 'item_hp_small', chance: 25 }, { id: 'ore_common_1', chance: 5 } ],
                    equipChance: 1.5
                }
            },
            'ktg_mob_2': { 
                name: 'Lính Tuần Tra (Kim)', 
                level: 8, 
                rarity: 2, 
                icon: 'fa-solid fa-shield-halved', 
                stats: { hp: 190, atk: 24, def: 12, spd: 15, lck: 5 }, 
                skills: [{ name: 'Chém', chance: 20, multiplier: 1.2 }],
                rewards: {
                    xp: 190,
                    nganLuong: 380,
                    honLuc: 0,
                    linhKhi: 5,
                    loot: [ { id: 'item_hp_small', chance: 35 }, { id: 'ore_uncommon_1', chance: 3 } ],
                    equipChance: 2
                }
            },
            'ktg_mob_3': { 
                name: 'Đội Trưởng (Tống)', 
                level: 15, 
                rarity: 3, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 380, atk: 42, def: 22, spd: 25, lck: 10 }, 
                skills: [{ name: 'Hò Hét', chance: 25, multiplier: 1.5 }],
                rewards: {
                    xp: 420,
                    nganLuong: 750,
                    honLuc: 0,
                    linhKhi: 10,
                    loot: [ { id: 'item_hp_medium', chance: 15 }, { id: 'upgrade_stone_low', chance: 10 } ],
                    equipChance: 3
                }
            },
            'ktg_mob_4': { 
                name: 'Tướng Tà (Kim)', 
                level: 25, 
                rarity: 4, 
                icon: 'fa-solid fa-user-secret', 
                stats: { hp: 750, atk: 68, def: 35, spd: 35, lck: 15 }, 
                skills: [{ name: 'Tà Đao', chance: 30, multiplier: 1.8 }],
                rewards: {
                    xp: 850,
                    nganLuong: 1600,
                    honLuc: 0,
                    linhKhi: 20,
                    loot: [ { id: 'item_hp_medium', chance: 25 }, { id: 'upgrade_stone_medium', chance: 5 } ],
                    equipChance: 5
                }
            },
            // [NEW] More Kiem The Enemies
            'ktg_mob_5': { 
                name: 'Đại Tướng (Tống)', 
                level: 35, 
                rarity: 4, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 1200, atk: 90, def: 60, spd: 40, lck: 20 }, 
                skills: [{ name: 'Phá Giáp', chance: 25, multiplier: 1.6 }],
                rewards: {
                    xp: 1300,
                    nganLuong: 2500,
                    honLuc: 0,
                    linhKhi: 25,
                    loot: [ { id: 'item_hp_medium', chance: 30 }, { id: 'upgrade_stone_medium', chance: 7 } ],
                    equipChance: 6
                }
            },
            'ktg_mob_6': { 
                name: 'Nguyên Soái (Kim)', 
                level: 40, 
                rarity: 5, 
                icon: 'fa-solid fa-user-crown', 
                stats: { hp: 1800, atk: 110, def: 50, spd: 45, lck: 25 }, 
                skills: [{ name: 'Toàn Quân Xuất Kích', chance: 30, multiplier: 2.0 }],
                rewards: {
                    xp: 1800,
                    nganLuong: 3500,
                    honLuc: 0,
                    linhKhi: 30,
                    loot: [ { id: 'item_hp_large', chance: 10 }, { id: 'upgrade_stone_high', chance: 3 } ],
                    equipChance: 7
                }
            },
            'ktg_mob_7': { 
                name: 'Thích Khách (Tống)', 
                level: 50, 
                rarity: 4, 
                icon: 'fa-solid fa-user-ninja', 
                stats: { hp: 1500, atk: 130, def: 40, spd: 70, lck: 30 }, 
                skills: [{ name: 'Ám Sát', chance: 30, multiplier: 1.8 }],
                rewards: {
                    xp: 2200,
                    nganLuong: 4000,
                    honLuc: 0,
                    linhKhi: 35,
                    loot: [ { id: 'item_hp_large', chance: 15 }, { id: 'gem_green_2', chance: 3 } ],
                    equipChance: 8
                }
            },
            'ktg_mob_8': { 
                name: 'Hoàng Kim Tướng Quân (Kim)', 
                level: 60, 
                rarity: 6, 
                icon: 'fa-solid fa-user-helmet-safety', // Placeholder
                stats: { hp: 3000, atk: 160, def: 80, spd: 50, lck: 30 }, 
                skills: [{ name: 'Hoàng Kim Đao', chance: 35, multiplier: 2.2 }],
                rewards: {
                    xp: 3000,
                    nganLuong: 6000,
                    honLuc: 0,
                    linhKhi: 45,
                    loot: [ { id: 'item_hp_large', chance: 20 }, { id: 'gem_blue_2', chance: 3 } ],
                    equipChance: 10
                }
            },
            // [NEW] More Kiem The Enemies (Higher Level)
            'ktg_mob_9': { 
                name: 'Võ Sư Tống (Tinh Anh)', 
                level: 65, 
                rarity: 6, 
                icon: 'fa-solid fa-user-graduate', 
                stats: { hp: 4000, atk: 180, def: 90, spd: 60, lck: 30 }, 
                skills: [{ name: 'Thiết Quyền', chance: 30, multiplier: 1.8 }],
                rewards: {
                    xp: 4000,
                    nganLuong: 8000,
                    honLuc: 0,
                    linhKhi: 50,
                    loot: [ { id: 'item_hp_large', chance: 25 }, { id: 'gem_purple_2', chance: 3 } ],
                    equipChance: 11
                }
            },
            'ktg_mob_10': { 
                name: 'Vệ Úy Kim (Tinh Anh)', 
                level: 70, 
                rarity: 6, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 4500, atk: 200, def: 110, spd: 55, lck: 30 }, 
                skills: [{ name: 'Trường Đao', chance: 30, multiplier: 1.9 }],
                rewards: {
                    xp: 4800,
                    nganLuong: 9500,
                    honLuc: 0,
                    linhKhi: 55,
                    loot: [ { id: 'item_hp_large', chance: 30 }, { id: 'gem_green_3', chance: 2 } ],
                    equipChance: 12
                }
            },
            'ktg_mob_11': { 
                name: 'Bạch Kim Tướng Quân (Kim)', 
                level: 80, 
                rarity: 7, 
                icon: 'fa-solid fa-user-helmet-safety', 
                stats: { hp: 6000, atk: 240, def: 130, spd: 65, lck: 35 }, 
                skills: [{ name: 'Kim Quang Trảm', chance: 35, multiplier: 2.1 }],
                rewards: {
                    xp: 6500,
                    nganLuong: 12000,
                    honLuc: 0,
                    linhKhi: 65,
                    loot: [ { id: 'item_hp_large', chance: 35 }, { id: 'gem_blue_3', chance: 2 } ],
                    equipChance: 14
                }
            },
            'ktg_mob_12': { 
                name: 'Ngự Doanh Chỉ Huy (Tống)', 
                level: 85, 
                rarity: 7, 
                icon: 'fa-solid fa-user-crown', 
                stats: { hp: 7000, atk: 260, def: 150, spd: 70, lck: 40 }, 
                skills: [{ name: 'Chỉ Huy Kiếm', chance: 35, multiplier: 2.2 }],
                rewards: {
                    xp: 7500,
                    nganLuong: 15000,
                    honLuc: 0,
                    linhKhi: 70,
                    loot: [ { id: 'item_hp_large', chance: 40 }, { id: 'gem_purple_3', chance: 2 } ],
                    equipChance: 15
                }
            },
            // [NEW] More Kiem The Enemies (Even Higher Level)
            'ktg_mob_13': { 
                name: 'Tinh Nhuệ Cung Thủ (Tống)', 
                level: 90, 
                rarity: 7, 
                icon: 'fa-solid fa-bow-arrow', 
                stats: { hp: 8000, atk: 300, def: 140, spd: 80, lck: 40 }, 
                skills: [{ name: 'Liên Xạ', chance: 35, multiplier: 1.5, hits: 2 }],
                rewards: {
                    xp: 9000,
                    nganLuong: 18000,
                    honLuc: 0,
                    linhKhi: 80,
                    loot: [ { id: 'item_hp_large', chance: 40 }, { id: 'gem_yellow_3', chance: 2 } ],
                    equipChance: 16
                }
            },
            'ktg_mob_14': { 
                name: 'Lang Nha Binh (Kim)', 
                level: 95, 
                rarity: 7, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 9500, atk: 280, def: 180, spd: 60, lck: 40 }, 
                skills: [{ name: 'Lang Nha Kích', chance: 30, multiplier: 2.3 }],
                rewards: {
                    xp: 10000,
                    nganLuong: 20000,
                    honLuc: 0,
                    linhKhi: 85,
                    loot: [ { id: 'item_hp_large', chance: 45 }, { id: 'gem_green_4', chance: 1 } ],
                    equipChance: 17
                }
            },
            'ktg_mob_15': { 
                name: 'Cấm Vệ Quân (Tống)', 
                level: 110, 
                rarity: 8, 
                icon: 'fa-solid fa-user-helmet-safety', 
                stats: { hp: 12000, atk: 350, def: 200, spd: 90, lck: 45 }, 
                skills: [{ name: 'Hộ Giá', chance: 30, multiplier: 2.5 }],
                rewards: {
                    xp: 13000,
                    nganLuong: 25000,
                    honLuc: 0,
                    linhKhi: 100,
                    loot: [ { id: 'item_hp_large', chance: 50 }, { id: 'gem_blue_4', chance: 1 } ],
                    equipChance: 19
                }
            },
            'ktg_mob_16': { 
                name: 'Đại Nguyên Soái (Kim)', 
                level: 115, 
                rarity: 8, 
                icon: 'fa-solid fa-user-crown', 
                stats: { hp: 15000, atk: 400, def: 220, spd: 80, lck: 50 }, 
                skills: [{ name: 'Thiên Quân Vạn Mã', chance: 35, multiplier: 2.8 }],
                rewards: {
                    xp: 16000,
                    nganLuong: 30000,
                    honLuc: 0,
                    linhKhi: 110,
                    loot: [ { id: 'item_hp_large', chance: 60 }, { id: 'gem_purple_4', chance: 1 } ],
                    equipChance: 20
                }
            },
            // [NEW] More Kiem The Enemies (Highest Level)
            'ktg_mob_17': { 
                name: 'Thần Võ Tướng (Tống)', 
                level: 120, 
                rarity: 8, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 18000, atk: 450, def: 250, spd: 100, lck: 50 }, 
                skills: [{ name: 'Thần Võ Kích', chance: 30, multiplier: 2.6 }],
                rewards: {
                    xp: 20000,
                    nganLuong: 40000,
                    honLuc: 0,
                    linhKhi: 120,
                    loot: [ { id: 'item_hp_large', chance: 60 }, { id: 'gem_yellow_4', chance: 1 } ],
                    equipChance: 22
                }
            },
            'ktg_mob_18': { 
                name: 'Long Hổ Vệ (Kim)', 
                level: 125, 
                rarity: 8, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 22000, atk: 480, def: 280, spd: 90, lck: 50 }, 
                skills: [{ name: 'Long Hổ Đao', chance: 30, multiplier: 2.7 }],
                rewards: {
                    xp: 24000,
                    nganLuong: 45000,
                    honLuc: 0,
                    linhKhi: 130,
                    loot: [ { id: 'item_hp_large', chance: 65 }, { id: 'gem_yellow_4', chance: 1 } ],
                    equipChance: 23
                }
            },
            'ktg_mob_19': { 
                name: 'Cấm Vệ Thống Lĩnh (Tống)', 
                level: 140, 
                rarity: 9, 
                icon: 'fa-solid fa-user-crown', 
                stats: { hp: 30000, atk: 550, def: 300, spd: 110, lck: 55 }, 
                skills: [{ name: 'Thống Lĩnh Kiếm', chance: 35, multiplier: 2.8 }],
                rewards: {
                    xp: 30000,
                    nganLuong: 60000,
                    honLuc: 0,
                    linhKhi: 150,
                    loot: [ { id: 'item_hp_large', chance: 70 }, { id: 'gem_purple_4', chance: 2 } ],
                    equipChance: 25
                }
            },
            'ktg_mob_20': { 
                name: 'Hoàng Đế (Kim)', 
                level: 150, 
                rarity: 10, 
                icon: 'fa-solid fa-user-king', // Placeholder
                stats: { hp: 45000, atk: 650, def: 350, spd: 100, lck: 60 }, 
                skills: [{ name: 'Thiên Tử Kiếm', chance: 40, multiplier: 3.0, ignoreDef: 0.1 }],
                rewards: {
                    xp: 40000,
                    nganLuong: 80000,
                    honLuc: 0,
                    linhKhi: 200,
                    loot: [ { id: 'item_hp_large', chance: 80 }, { id: 'gem_yellow_4', chance: 2 } ],
                    equipChance: 30
                }
            },
            // [NEW] More Kiem The Enemies (Level 160+)
            'ktg_mob_21': { 
                name: 'Hộ Vệ Hoàng Gia (Tống)', 
                level: 160, 
                rarity: 9, 
                icon: 'fa-solid fa-user-shield', 
                stats: { hp: 60000, atk: 700, def: 400, spd: 120, lck: 60 }, 
                skills: [{ name: 'Trung Hồn', chance: 30, multiplier: 2.8 }],
                rewards: {
                    xp: 50000,
                    nganLuong: 100000,
                    honLuc: 0,
                    linhKhi: 220,
                    loot: [ { id: 'item_hp_large', chance: 80 }, { id: 'gem_green_4', chance: 2 } ],
                    equipChance: 32
                }
            },
            'ktg_mob_22': { 
                name: 'Đại Tông Sư (Kim)', 
                level: 165, 
                rarity: 9, 
                icon: 'fa-solid fa-user-graduate', 
                stats: { hp: 70000, atk: 750, def: 380, spd: 130, lck: 60 }, 
                skills: [{ name: 'Vô Cực Kiếm', chance: 30, multiplier: 2.9 }],
                rewards: {
                    xp: 55000,
                    nganLuong: 110000,
                    honLuc: 0,
                    linhKhi: 230,
                    loot: [ { id: 'item_hp_large', chance: 85 }, { id: 'gem_blue_4', chance: 2 } ],
                    equipChance: 33
                }
            },
            'ktg_mob_23': { 
                name: 'Thái Sư (Tống)', 
                level: 170, 
                rarity: 10, 
                icon: 'fa-solid fa-user-tie', 
                stats: { hp: 85000, atk: 800, def: 450, spd: 110, lck: 65 }, 
                skills: [{ name: 'Triều Đình Kiếm Pháp', chance: 35, multiplier: 3.0 }],
                rewards: {
                    xp: 65000,
                    nganLuong: 130000,
                    honLuc: 0,
                    linhKhi: 250,
                    loot: [ { id: 'item_hp_large', chance: 90 }, { id: 'gem_purple_4', chance: 2 } ],
                    equipChance: 35
                }
            },
            'ktg_mob_24': { 
                name: 'Hoàn Nhan Tông Chủ (Kim)', 
                level: 180, 
                rarity: 10, 
                icon: 'fa-solid fa-user-king',
                stats: { hp: 100000, atk: 900, def: 500, spd: 140, lck: 70 }, 
                skills: [{ name: 'Kim Long Tà Kiếm', chance: 40, multiplier: 3.2, ignoreDef: 0.15 }],
                rewards: {
                    xp: 80000,
                    nganLuong: 160000,
                    honLuc: 0,
                    linhKhi: 300,
                    loot: [ { id: 'item_hp_large', chance: 95 }, { id: 'gem_yellow_4', chance: 3 } ],
                    equipChance: 38
                }
            },
        };

        const DAULADAILUC_MAPS_DB = {
            'dll_map_1_1': {
                name: 'Thôn Thánh Hồn',
                desc: 'Nơi bắt đầu của mọi huyền thoại. (Quái: Hồn Thú 10 năm)',
                levelReq: 1,
                enemies: ['dll_mob_1', 'dll_mob_2']
            },
            // [NEW] New Map
            'dll_map_2_1': {
                name: 'Học Viện Sử Lai Khắc',
                desc: 'Chỉ thu nhận quái vật... (Quái: Hồn Thú 100 năm)',
                levelReq: 5, // Cần cấp 5
                enemies: ['dll_mob_3', 'dll_mob_4']
            },
            // [NEW] New Map 2
            'dll_map_3_1': {
                name: 'Tinh Đấu Sâm Lâm',
                desc: 'Khu rừng Hồn Thú nguy hiểm. (Quái: Hồn Thú 1000 năm)',
                levelReq: 10, // Cần cấp 10
                enemies: ['dll_mob_5', 'dll_mob_6']
            },
            // [NEW] New Map 3
            'dll_map_4_1': {
                name: 'Cực Bắc Băng Nguyên',
                desc: 'Vùng đất băng giá vĩnh cửu. (Quái: Hồn Thú 1000 năm - Băng)',
                levelReq: 15, // Cần cấp 15
                enemies: ['dll_mob_7', 'dll_mob_8']
            },
            // [NEW] New Map 4
            'dll_map_5_1': {
                name: 'Hải Thần Đảo',
                desc: 'Hòn đảo bí ẩn giữa đại dương. (Quái: Hồn Thú 1 vạn năm)',
                levelReq: 20, // Cần cấp 20
                enemies: ['dll_mob_9', 'dll_mob_10']
            },
            // [NEW] New Map 5
            'dll_map_6_1': {
                name: 'Võ Hồn Điện',
                desc: 'Nơi tập trung các Hồn Sư mạnh mẽ. (Quái: Hồn Sư)',
                levelReq: 30, // Cần cấp 30
                enemies: ['dll_mob_11', 'dll_mob_12']
            },
            // [NEW] New Map 6
            'dll_map_7_1': {
                name: 'Sa Mạc Huyễn Ảnh',
                desc: 'Sa mạc rộng lớn đầy rẫy ảo ảnh. (Quái: Hồn Thú 3 vạn năm)',
                levelReq: 40, // Cần cấp 40
                enemies: ['dll_mob_13', 'dll_mob_14']
            },
            // [NEW] New Map 7
            'dll_map_8_1': {
                name: 'Lãnh Địa Bích Lân Xà',
                desc: 'Hang ổ của Bích Lân Xà Hoàng. (Quái: Hồn Thú 5 vạn năm)',
                levelReq: 70, // Cần cấp 70
                enemies: ['dll_mob_15', 'dll_mob_16']
            },
            // [NEW] New Map 8
            'dll_map_9_1': {
                name: 'Thâm Hải Ma Kình Vực',
                desc: 'Vực biển sâu nơi Ma Kình Vương ngự trị. (Quái: Hồn Thú 10 vạn năm)',
                levelReq: 120, // Cần cấp 120
                enemies: ['dll_mob_17', 'dll_mob_18']
            },
            // [NEW] New Map 9
            'dll_map_10_1': {
                name: 'Sát Lục Chi Đô',
                desc: 'Thành phố của tội lỗi và sát戮. (Quái: Sát Lục Giả)',
                levelReq: 150, // Cần cấp 150
                enemies: ['dll_mob_19', 'dll_mob_19_2', 'dll_mob_20'] // [MODIFIED] Added mob 19_2
            },
            // [NEW] Map 11: Tinh Đấu Đại Sâm Lâm (Lõi)
            'dll_map_11_1': {
                name: 'Thanh Khê Tiểu Kính',
                desc: 'Con đường mòn đầu tiên vào Tu Chân Giới, linh khí mỏng manh.',
                levelReq: 3, // Requires player level 3
                enemies: ['tcg_mob_1', 'tcg_mob_2'],
                isTuChanGioi: true // Flag for this world
            },
            // [NEW] More Tu Chan Gioi Maps
            'tcg_map_2_1': {
                name: 'Hắc Phong Lĩnh',
                desc: 'Nơi yêu thú trăm năm cư ngụ, gió lốc gào thét.',
                levelReq: 10, // Requires player level 10
                enemies: ['tcg_mob_3', 'tcg_mob_4'],
                isTuChanGioi: true
            },
            'tcg_map_3_1': {
                name: 'Kim Quang Đỉnh',
                desc: 'Đỉnh núi cao chọc trời, nơi các loại yêu điêu mạnh mẽ làm tổ.',
                levelReq: 20, // Requires player level 20
                enemies: ['tcg_mob_5', 'tcg_mob_6'],
                isTuChanGioi: true
            },
            // [NEW] More Tu Chan Gioi Maps
            'tcg_map_4_1': {
                name: 'Vạn Quỷ Hồn Lĩnh',
                desc: 'Nơi oán khí ngập trời, Ma Tu và Quỷ Tướng hoành hành.',
                levelReq: 30,
                enemies: ['tcg_mob_7', 'tcg_mob_8'],
                isTuChanGioi: true
            },
            'tcg_map_5_1': {
                name: 'Huyết Hải Yêu Vực',
                desc: 'Biển máu vô tận, nơi Huyết Yêu và Giao Long ẩn nấp.',
                levelReq: 40,
                enemies: ['tcg_mob_9', 'tcg_mob_10'],
                isTuChanGioi: true
            },
            'tcg_map_6_1': {
                name: 'Lôi Minh Cấm Địa',
                desc: 'Cấm địa cổ xưa đầy rẫy Lôi Linh, nguy hiểm khôn lường.',
                levelReq: 50,
                enemies: ['tcg_mob_11', 'tcg_mob_12'],
                isTuChanGioi: true
            },
            'tcg_map_7_1': {
                name: 'Tiên Ma Chiến Trường',
                desc: 'Di tích chiến trường thượng cổ, Tàn Hồn và Cổ Ma vẫn còn vương vấn.',
                levelReq: 70,
                enemies: ['tcg_mob_13', 'tcg_mob_14'],
                isTuChanGioi: true
            },
            // [NEW] Tu Chan Gioi Maps (High Level)
            'tcg_map_8_1': {
                name: 'Thượng Cổ Tiên Phủ',
                desc: 'Nơi ở của tiên nhân cổ đại, được canh giữ bởi Khôi Lỗi và Kiếm Linh.',
                levelReq: 80,
                enemies: ['tcg_mob_15', 'tcg_mob_16'],
                isTuChanGioi: true
            },
            'tcg_map_9_1': {
                name: 'Cửu Thiên Tinh Hà',
                desc: 'Vượt ra ngoài đại lục, nơi các Dị Thú và Thiên Ma du hành.',
                levelReq: 100,
                enemies: ['tcg_mob_17', 'tcg_mob_18'],
                isTuChanGioi: true
            },
            'tcg_map_10_1': {
                name: 'Hỗn Độn Hư Vô',
                desc: 'Rìa của vũ trụ, nơi chỉ có Hỗn Độn Chi Linh và những kẻ Thôn Phệ.',
                levelReq: 140,
                enemies: ['tcg_mob_19', 'tcg_mob_20'],
                isTuChanGioi: true
            },
            // [NEW] Maps for Kiem The Gioi
            'ktg_map_1_1': {
                name: 'Biên Cảnh (Tống)',
                desc: 'Biên ải Tương Dương, nơi quân Tống và quân Kim thường xuyên giao tranh.',
                levelReq: 5,
                enemies: ['ktg_mob_1', 'ktg_mob_2'],
                isKiemTheGioi: true // Flag for this world
            },
            'ktg_map_2_1': {
                name: 'Chiến Trường Tống Kim (Sơ)',
                desc: 'Tham gia chiến trường, nơi các đội trưởng và tướng tà đang giao chiến.',
                levelReq: 15,
                enemies: ['ktg_mob_3', 'ktg_mob_4'],
                isKiemTheGioi: true // Flag for this world
            },
            // [NEW] More Kiem The Maps
            'ktg_map_3_1': {
                name: 'Chiến Trường Tống Kim (Trung)',
                desc: 'Chiến trường khốc liệt, nơi Đại Tướng và Nguyên Soái 2 bên đọ sức.',
                levelReq: 30,
                enemies: ['ktg_mob_5', 'ktg_mob_6'],
                isKiemTheGioi: true // Flag for this world
            },
            'ktg_map_4_1': {
                name: 'Doanh Trại Mật (Kim)',
                desc: 'Đột kích doanh trại bí mật của quân Kim, cẩn thận Thích Khách và Tướng Quân.',
                levelReq: 45,
                enemies: ['ktg_mob_7', 'ktg_mob_8'],
                isKiemTheGioi: true // Flag for this world
            },
            // [NEW] More Kiem The Maps (Higher Level)
            'ktg_map_5_1': {
                name: 'Tàn Tích Cổ Thành',
                desc: 'Tàn tích bị lãng quên, nơi các Võ Sư và Vệ Úy tinh anh ẩn náu.',
                levelReq: 60,
                enemies: ['ktg_mob_9', 'ktg_mob_10'],
                isKiemTheGioi: true // Flag for this world
            },
            'ktg_map_6_1': {
                name: 'Đại Điện Hoàng Kim',
                desc: 'Nơi ở của các Tướng Quân Hoàng Kim và Chỉ Huy Ngự Doanh.',
                levelReq: 75,
                enemies: ['ktg_mob_11', 'ktg_mob_12'],
                isKiemTheGioi: true // Flag for this world
            },
            // [NEW] More Kiem The Maps (Even Higher Level)
            'ktg_map_7_1': {
                name: 'Thành Cổ Đại Chiến',
                desc: 'Chiến trường tại thành cổ, nơi Cung Thủ và Lang Nha Binh giao tranh ác liệt.',
                levelReq: 90,
                enemies: ['ktg_mob_13', 'ktg_mob_14'],
                isKiemTheGioi: true // Flag for this world
            },
            'ktg_map_8_1': {
                name: 'Hoàng Cung Quyết Chiến',
                desc: 'Trận chiến cuối cùng tại Hoàng Cung, Cấm Vệ Quân và Nguyên Soái xuất hiện.',
                levelReq: 110,
                enemies: ['ktg_mob_15', 'ktg_mob_16'],
                isKiemTheGioi: true // Flag for this world
            },
            // [NEW] More Kiem The Maps (Highest Level)
            'ktg_map_9_1': {
                name: 'Huyết Long Đàm',
                desc: 'Nơi Thần Võ Tướng và Long Hổ Vệ canh giữ, sát khí ngập trời.',
                levelReq: 120,
                enemies: ['ktg_mob_17', 'ktg_mob_18'],
                isKiemTheGioi: true // Flag for this world
            },
            'ktg_map_10_1': {
                name: 'Thiên Tử Cấm Thành',
                desc: 'Nơi Hoàng Đế ngự trị, được bảo vệ bởi Thống Lĩnh Cấm Vệ Quân.',
                levelReq: 140,
                enemies: ['ktg_mob_19', 'ktg_mob_20'],
                isKiemTheGioi: true // Flag for this world
            },
            // [NEW] More Kiem The Maps (Level 160+)
            'ktg_map_11_1': {
                name: 'Cung Điện Hoàng Gia',
                desc: 'Nơi ở của Hộ Vệ Hoàng Gia và các Đại Tông Sư.',
                levelReq: 160,
                enemies: ['ktg_mob_21', 'ktg_mob_22'],
                isKiemTheGioi: true // Flag for this world
            },
            'ktg_map_12_1': {
                name: 'Kim Quốc Đại Doanh',
                desc: 'Đại bản doanh của quân Kim, nơi Thái Sư và Tông Chủ Hoàn Nhan ngự trị.',
                levelReq: 170,
                enemies: ['tptk_mob_3', 'tptk_mob_4'],
                isThonPheTinhKhong: true // Flag for this world
            }
        };

        // [FIX] Đã xóa ký tự '*' bị lạc gây lỗi SyntaxError ở dòng này.
        // [NEW] Linh Tri (Spirit Pool) Database
        const LINH_TRI_DB = {
            1: { level: 1, ratePerHour: 300, capacity: 3000, costNL: 1000000, costDCH: 10 },
            2: { level: 2, ratePerHour: 600, capacity: 6000, costNL: 5000000, costDCH: 25 },
            3: { level: 3, ratePerHour: 1050, capacity: 10500, costNL: 10000000, costDCH: 50 },
            4: { level: 4, ratePerHour: 1650, capacity: 15000, costNL: 25000000, costDCH: 100 },
            5: { level: 5, ratePerHour: 2400, capacity: 22500, costNL: 50000000, costDCH: 175 },
            6: { level: 6, ratePerHour: 3300, capacity: 30000, costNL: 100000000, costDCH: 250 },
            7: { level: 7, ratePerHour: 4500, capacity: 45000, costNL: 200000000, costDCH: 400 },
            8: { level: 8, ratePerHour: 6000, capacity: 60000, costNL: 500000000, costDCH: 600 },
            9: { level: 9, ratePerHour: 8100, capacity: 90000, costNL: 1000000000, costDCH: 1000 },
            10: { level: 10, ratePerHour: 10500, capacity: 150000, costNL: 2500000000, costDCH: 2500 }, // [MODIFIED] Xóa max
            // [NEW] Cấp 11-20
            11: { level: 11, ratePerHour: 13500, capacity: 200000, costNL: 5000000000, costDCH: 4000 },
            12: { level: 12, ratePerHour: 17000, capacity: 260000, costNL: 9000000000, costDCH: 6000 },
            13: { level: 13, ratePerHour: 21000, capacity: 340000, costNL: 16200000000, costDCH: 9000 },
            14: { level: 14, ratePerHour: 26000, capacity: 440000, costNL: 29160000000, costDCH: 13500 },
            15: { level: 15, ratePerHour: 32000, capacity: 570000, costNL: 52488000000, costDCH: 20250 },
            16: { level: 16, ratePerHour: 40000, capacity: 740000, costNL: 94478400000, costDCH: 30375 },
            17: { level: 17, ratePerHour: 50000, capacity: 960000, costNL: 170061120000, costDCH: 45562 },
            18: { level: 18, ratePerHour: 62000, capacity: 1250000, costNL: 306110000000, costDCH: 68343 },
            19: { level: 19, ratePerHour: 77000, capacity: 1600000, costNL: 550998000000, costDCH: 102514 },
            20: { level: 20, ratePerHour: 95000, capacity: 2000000, max: true } // [NEW] Cấp tối đa mới
        };

        // [NEW] Sung Vat (Pet) Database
        const SUNG_VAT_DB = {
            'pet_001': {
                id: 'pet_001',
                name: 'Xích Viêm Hồ', // [MODIFIED] Tên mới: Tiểu Hỏa Hồ -> Xích Viêm Hồ
                icon: 'fa-brands fa-firefox', // [MODIFIED] Icon cáo lửa
                rarity: 2, // 2 sao (Hiếm)
                rebirthReq: 0, 
                costType: 'knb', 
                costValue: 0,
                baseStats: { hp: 50, atk: 10, def: 5, spd: 5 },
                potential: { hp: 5, atk: 2, def: 1, spd: 1 },
                passiveSkill: {
                    desc: 'Hỏa Lực: Tăng 10% ATK và 5% HP cho sủng vật này.',
                    effect: { atk_p: 10, hp_p: 5 }
                },
                activeSkill: { 
                    name: 'Hỏa Cầu',
                    desc: 'Tấn công kẻ thù, gây sát thương bằng 150% ATK của sủng vật.',
                    multiplier: 1.5,
                    cost: 0 
                },
                desc: 'Linh thú hệ hỏa, toàn thân rực lửa đỏ.'
            },
            'pet_002': {
                id: 'pet_002',
                name: 'Huyền Vũ Linh Quy', // [MODIFIED] Tên mới: Linh Lân Quy -> Huyền Vũ Linh Quy
                icon: 'fa-solid fa-shield-cat', // [MODIFIED] Icon khiên thú
                rarity: 4, // 4 sao (Sử Thi)
                rebirthReq: 5, 
                costType: 'knb',
                costValue: 1000, 
                baseStats: { hp: 150, atk: 5, def: 15, spd: 3 },
                potential: { hp: 10, atk: 1, def: 3, spd: 1 },
                passiveSkill: {
                    desc: 'Thạch Giáp: Tăng 20% DEF và 10% HP cho sủng vật này.',
                    effect: { def_p: 20, hp_p: 10 }
                },
                activeSkill: { 
                    name: 'Thiết Giáp',
                    desc: 'Tấn công kẻ thù, gây 100% ATK (và tăng 50% DEF cho sủng vật - chưa hỗ trợ).',
                    multiplier: 1.0,
                    cost: 0
                },
                desc: 'Hậu duệ của thần thú Huyền Vũ, phòng thủ vô song.'
            },
            'pet_003': {
                id: 'pet_003',
                name: 'Lôi Chấn Tử', // [MODIFIED] Tên mới: Thái Cổ Lôi Điểu -> Lôi Chấn Tử
                icon: 'fa-solid fa-bolt-lightning', 
                rarity: 6, // 6 sao (Thần Thoại)
                rebirthReq: 10, 
                costType: 'knb',
                costValue: 5000, 
                baseStats: { hp: 100, atk: 15, def: 10, spd: 15 },
                potential: { hp: 7, atk: 3, def: 2, spd: 3 },
                passiveSkill: {
                    desc: 'Lôi Tốc: Tăng 20% SPD và 10% ATK cho sủng vật này.',
                    effect: { spd_p: 20, atk_p: 10 }
                },
                activeSkill: { 
                    name: 'Lôi Kích',
                    desc: 'Tấn công kẻ thù, gây 120% ATK (và có 25% đánh 2 lần - chưa hỗ trợ).',
                    multiplier: 1.2,
                    cost: 0
                },
                desc: 'Sinh ra từ sấm sét, tốc độ nhanh như điện.'
            },
            'pet_004': {
                id: 'pet_004',
                name: 'Hỗn Độn Ma Thú', // [MODIFIED] Tên mới
                icon: 'fa-solid fa-spaghetti-monster-flying', // [MODIFIED] Icon quái vật bay
                rarity: 8, // 8 sao (Chí Tôn)
                rebirthReq: 30, 
                costType: 'knb',
                costValue: 20000, 
                baseStats: { hp: 120, atk: 20, def: 12, spd: 10 },
                potential: { hp: 10, atk: 4, def: 3, spd: 2 },
                passiveSkill: {
                    desc: 'Hỗn Độn: Tăng 15% tất cả chỉ số (HP, ATK, DEF, SPD) cho sủng vật này.',
                    effect: { hp_p: 15, atk_p: 15, def_p: 15, spd_p: 15 }
                },
                activeSkill: { 
                    name: 'Hỗn Độn Tảo',
                    desc: 'Tấn công kẻ thù, gây 200% ATK (và bỏ qua 10% phòng thủ - chưa hỗ trợ).',
                    multiplier: 2.0,
                    cost: 0
                },
                desc: 'Sinh vật từ hư không, sức mạnh không thể đo lường.'
            },

            // --- [NEW] 3 Sủng Vật Thần Thoại (Chỉ số Cao) ---
            
            // 1. Mua bằng Điểm Cống Hiến (Tông Môn)
            'pet_mythic_conghien': {
                id: 'pet_mythic_conghien',
                name: 'Thánh Thú Bạch Trạch', // [MODIFIED] Tên
                icon: 'fa-solid fa-book-open-reader', // [MODIFIED] Icon tri thức/sách
                rarity: 9, // Thượng Cổ
                rebirthReq: 5, 
                costType: 'diemCongHien', 
                costValue: 50000, 
                baseStats: { hp: 2000, atk: 250, def: 200, spd: 150 }, 
                potential: { hp: 100, atk: 30, def: 25, spd: 20 }, 
                passiveSkill: {
                    desc: 'Thánh Nhân Chỉ Lộ: Tăng 50% Kinh Nghiệm nhận được và 20% toàn bộ chỉ số cho chủ nhân.',
                    effect: { xp_boost: 50, hp_p: 20, atk_p: 20, def_p: 20, spd_p: 20 }
                },
                activeSkill: {
                    name: 'Vạn Vật Thông Linh',
                    desc: 'Gây 400% ATK lên kẻ địch.',
                    multiplier: 4.0,
                    cost: 0
                },
                desc: 'Thần thú thông thái, toàn thân phát ra ánh sáng trí tuệ.'
            },

            // 2. Mua bằng Uy Danh (Danh hiệu/BXH)
            'pet_mythic_uydanh': {
                id: 'pet_mythic_uydanh',
                name: 'Hắc Ám Ma Long',
                icon: 'fa-solid fa-dragon', 
                rarity: 10, // Siêu Thần
                rebirthReq: 10, 
                costType: 'uyDanh', 
                costValue: 20000, 
                baseStats: { hp: 3500, atk: 500, def: 300, spd: 200 },
                potential: { hp: 150, atk: 50, def: 30, spd: 25 },
                passiveSkill: {
                    desc: 'Long Uy Hủy Diệt: Tăng 50% Công Kích và 30% Tỉ Lệ Chí Mạng cho chủ nhân.',
                    effect: { atk_p: 50, critChance: 30 }
                },
                activeSkill: {
                    name: 'Hắc Hỏa Diệt Thế',
                    desc: 'Phun lửa hắc ám thiêu rụi mọi thứ, gây 600% ATK.',
                    multiplier: 6.0,
                    cost: 0
                },
                desc: 'Rồng đen từ vực thẳm, đôi mắt đỏ rực như máu.'
            },

            // 3. Mua bằng Danh Vọng (Nhiệm vụ/Sự kiện)
            'pet_mythic_danhvong': {
                id: 'pet_mythic_danhvong',
                name: 'Bất Tử Phượng Hoàng', // [MODIFIED] Tên
                icon: 'fa-solid fa-crow', // Dùng tạm icon chim
                rarity: 10, // Siêu Thần
                rebirthReq: 10,
                costType: 'danhVong', 
                costValue: 30000, 
                baseStats: { hp: 5000, atk: 350, def: 400, spd: 250 },
                potential: { hp: 200, atk: 35, def: 40, spd: 30 },
                passiveSkill: {
                    desc: 'Niết Bàn: Tăng 100% Sinh Lực và 20% Hút Máu cho chủ nhân.',
                    effect: { hp_p: 100, lifesteal: 20 }
                },
                activeSkill: {
                    name: 'Bão Lửa Phượng Hoàng',
                    desc: 'Tạo bão lửa thiêu đốt, gây 500% ATK.',
                    multiplier: 5.0,
                    cost: 0
                },
                desc: 'Thần điểu bất tử, tắm trong lửa đỏ, hào quang rực rỡ.'
            },

            // [NEW] --- TỨ ĐẠI SIÊU THẦN THÚ MỚI (V1.69) ---
            // Cập nhật điều kiện: Cần cả 4 loại tiền tệ để kích hoạt

            // 1. Thanh Ngưu
            'pet_super_conghien': {
                id: 'pet_super_conghien',
                name: 'Thanh Ngưu Lão Tổ',
                icon: 'fa-solid fa-cow', 
                rarity: 10, // Siêu Thần
                rebirthReq: 20, 
                costType: 'mixed', // [MODIFIED] Loại chi phí hỗn hợp
                mixCosts: {        // [NEW] Chi tiết 4 loại tiền
                    uyDanh: 5000,
                    danhVong: 5000,
                    diemCongHien: 50000,
                    kimNguyenBao: 20000
                },
                baseStats: { hp: 10000, atk: 300, def: 1000, spd: 150 }, 
                potential: { hp: 500, atk: 30, def: 100, spd: 20 }, 
                passiveSkill: {
                    desc: 'Đạo Pháp Tự Nhiên: Tăng 50% HP và 50% Phòng Thủ cho chủ nhân.',
                    effect: { hp_p: 50, def_p: 50 }
                },
                activeSkill: {
                    name: 'Khí Thôn Sơn Hà',
                    desc: 'Gây 300% ATK và hồi phục 10% HP tối đa cho chủ nhân (chưa hỗ trợ hồi máu pet).',
                    multiplier: 3.0,
                    cost: 0
                },
                desc: 'Thú cưỡi của Đạo Đức Thiên Tôn, mình đồng da sắt, vạn pháp bất xâm.'
            },

            // 2. Bạch Hổ
            'pet_super_vinhdu': {
                id: 'pet_super_vinhdu',
                name: 'Bạch Hổ Chiến Thần',
                icon: 'fa-solid fa-cat', 
                rarity: 10, // Siêu Thần
                rebirthReq: 30, 
                costType: 'mixed', // [MODIFIED]
                mixCosts: {
                    uyDanh: 10000,
                    danhVong: 5000,
                    diemCongHien: 20000,
                    kimNguyenBao: 30000
                },
                baseStats: { hp: 5000, atk: 1500, def: 400, spd: 400 },
                potential: { hp: 200, atk: 150, def: 30, spd: 50 },
                passiveSkill: {
                    desc: 'Sát Phạt Chi Khí: Tăng 60% Công Kích và 20% Tỉ Lệ Chí Mạng cho chủ nhân.',
                    effect: { atk_p: 60, critChance: 20 }
                },
                activeSkill: {
                    name: 'Bạch Hổ Diệt Thế',
                    desc: 'Gầm lên một tiếng kinh thiên động địa, gây 1000% ATK sát thương bạo kích.',
                    multiplier: 10.0,
                    cost: 0
                },
                desc: 'Thần thú cai quản phương Tây, chủ quản chiến tranh và giết chóc.'
            },

            // 3. Khổng Tước
            'pet_super_danhvong': {
                id: 'pet_super_danhvong',
                name: 'Khổng Tước Minh Vương',
                icon: 'fa-solid fa-feather', 
                rarity: 10, // Siêu Thần
                rebirthReq: 30,
                costType: 'mixed', // [MODIFIED]
                mixCosts: {
                    uyDanh: 5000,
                    danhVong: 10000,
                    diemCongHien: 20000,
                    kimNguyenBao: 30000
                },
                baseStats: { hp: 6000, atk: 1000, def: 500, spd: 600 },
                potential: { hp: 300, atk: 80, def: 50, spd: 80 },
                passiveSkill: {
                    desc: 'Ngũ Sắc Thần Quang: Tăng 40% Né Tránh và 40% Chính Xác cho chủ nhân.',
                    effect: { dodgeChance: 40, accuracy_p: 40 }
                },
                activeSkill: {
                    name: 'Khổng Tước Khai Vũ',
                    desc: 'Tung ra ánh sáng ngũ sắc, gây 600% ATK và bỏ qua 50% phòng thủ.',
                    multiplier: 6.0,
                    cost: 0
                },
                desc: 'Phật Mẫu trong truyền thuyết, ánh sáng ngũ sắc có thể thu vạn vật.'
            },

            // 4. Đế Giang
            'pet_super_knb': {
                id: 'pet_super_knb',
                name: 'Hư Không Đế Giang',
                icon: 'fa-solid fa-spaghetti-monster-flying', // Dùng icon lạ mắt
                rarity: 10, // Siêu Thần
                rebirthReq: 50, 
                costType: 'mixed', // [MODIFIED]
                mixCosts: {
                    uyDanh: 20000,
                    danhVong: 20000,
                    diemCongHien: 100000,
                    kimNguyenBao: 100000
                },
                baseStats: { hp: 15000, atk: 2000, def: 1500, spd: 1000 },
                potential: { hp: 1000, atk: 200, def: 150, spd: 100 },
                passiveSkill: {
                    desc: 'Hư Không Thể: Tăng 50% TẤT CẢ chỉ số cơ bản (HP, ATK, DEF, SPD, LCK) cho chủ nhân.',
                    effect: { hp_p: 50, atk_p: 50, def_p: 50, spd_p: 50, lck_p: 50 }
                },
                activeSkill: {
                    name: 'Hủy Diệt Không Gian',
                    desc: 'Xé rách không gian, gây 1500% ATK sát thương chuẩn (Bỏ qua 100% phòng thủ - chưa hỗ trợ, tính là dmg cực to).',
                    multiplier: 15.0,
                    cost: 0
                },
                desc: 'Tổ Vu không gian trong truyền thuyết, tốc độ nhanh nhất thế gian, không có diện mạo.'
            },

            // [NEW] Cửu Vĩ Hồ (Trùng Sinh 15)
            'pet_005': {
                id: 'pet_005',
                name: 'Cửu Vĩ Thiên Hồ',
                icon: 'fa-solid fa-mask', // [MODIFIED] Icon mặt nạ cáo
                rarity: 7, 
                rebirthReq: 15,
                costType: 'knb',
                costValue: 50000, 
                baseStats: { hp: 200, atk: 30, def: 15, spd: 20 },
                potential: { hp: 15, atk: 5, def: 3, spd: 4 },
                passiveSkill: {
                    desc: 'Mê Hoặc: Tăng 25% SPD và 10% LCK cho sủng vật này.',
                    effect: { spd_p: 25, lck_p: 10 }
                },
                activeSkill: {
                    name: 'Hồ Lửa',
                    desc: 'Tấn công kẻ thù, gây 250% ATK.',
                    multiplier: 2.5,
                    cost: 0
                },
                desc: 'Hồ ly chín đuôi tu luyện ngàn năm.'
            },
            // [NEW] Hỏa Kỳ Lân (Trùng Sinh 40)
            'pet_006': {
                id: 'pet_006',
                name: 'Hỏa Kỳ Lân',
                icon: 'fa-solid fa-chess-knight', // [MODIFIED] Icon mã (kỳ lân)
                rarity: 9, 
                rebirthReq: 40, 
                costType: 'knb',
                costValue: 100000, 
                baseStats: { hp: 500, atk: 50, def: 40, spd: 25 },
                potential: { hp: 25, atk: 8, def: 6, spd: 4 },
                passiveSkill: {
                    desc: 'Thánh Thú Chi Uy: Tăng 30% ATK và 30% HP cho sủng vật này.',
                    effect: { atk_p: 30, hp_p: 30 }
                },
                activeSkill: {
                    name: 'Lửa Tam Muội',
                    desc: 'Phun lửa thiêu đốt kẻ thù, gây 300% ATK.',
                    multiplier: 3.0,
                    cost: 0
                },
                desc: 'Thần thú canh giữ Lăng Vân Quật.'
            },
            // [NEW] Thái Cổ Thanh Long (Trùng Sinh 50)
            'pet_007': {
                id: 'pet_007',
                name: 'Thái Cổ Thanh Long',
                icon: 'fa-solid fa-dragon', 
                rarity: 10, 
                rebirthReq: 50, 
                costType: 'knb',
                costValue: 200000, 
                baseStats: { hp: 1000, atk: 80, def: 60, spd: 40 },
                potential: { hp: 50, atk: 12, def: 8, spd: 6 },
                passiveSkill: {
                    desc: 'Long Thần Giáng Thế: Tăng 50% tất cả chỉ số cho sủng vật này.',
                    effect: { hp_p: 50, atk_p: 50, def_p: 50, spd_p: 50 }
                },
                activeSkill: {
                    name: 'Thanh Long Phá Thiên',
                    desc: 'Triệu hồi rồng thần tấn công, gây 500% ATK hủy diệt.',
                    multiplier: 5.0,
                    cost: 0
                },
                desc: 'Rồng thần thượng cổ, sức mạnh hủy diệt thiên địa.'
            }
        };

        // [MODIFIED] Vong Quay (Lucky Wheel) Reward Database
        // [FIX] Updated Rewards: 10M NL, 1M NL, 10 KNB, Med Stone, Epic/Mythic Gear
        const VONG_QUAY_DB = [
            // --- Hàng Trên (Top Row: 0-4) ---
            { id: 'vq_1', name: '1,000,000 NL', type: 'currency', currency: 'nganLuong', value: 1000000, icon: 'fa-solid fa-sack-dollar', color: 'text-gray-200' },
            { id: 'vq_2', name: 'Đá Cường Hóa (Sơ)', type: 'material', itemId: 'upgrade_stone_low', value: 5, icon: 'fa-circle', color: 'text-gray-400' },
            { id: 'vq_3', name: 'Trang Bị (Cam)', type: 'generated_equipment', quality: 'epic', level: [50, 80], icon: 'fa-shirt', color: 'text-orange-500' },
            { id: 'vq_4', name: '10,000,000 NL', type: 'currency', currency: 'nganLuong', value: 10000000, icon: 'fa-solid fa-sack-dollar', color: 'text-yellow-300 font-black' }, // Giải đặc biệt NL
            { id: 'vq_5', name: '10 KNB', type: 'currency', currency: 'kimNguyenBao', value: 10, icon: 'fa-gem', color: 'text-yellow-400' },
            
            // --- Cột Phải (Right Col: 5-7) ---
            { id: 'vq_6', name: 'Linh Thạch x50', type: 'currency', currency: 'linhThach', value: 50, icon: 'fa-cubes', color: 'text-green-400' },
            { id: 'vq_7', name: 'Đá Cường Hóa (Trung)', type: 'material', itemId: 'upgrade_stone_medium', value: 2, icon: 'fa-square', color: 'text-blue-300' },
            
            // [MODIFIED] Thay Trang Bị Đỏ bằng Mất Lượt
            { id: 'vq_8', name: 'Mất Lượt', type: 'nothing', icon: 'fa-solid fa-face-dizzy', color: 'text-gray-500' }, 
            
            // --- Hàng Dưới (Bottom Row: 8-12) ---
            { id: 'vq_9', name: 'Đá Cường Hóa (Cao)', type: 'material', itemId: 'upgrade_stone_high', value: 1, icon: 'fa-star', color: 'text-purple-400' },
            { id: 'vq_10', name: 'Lượt Quay x1', type: 'spin_again', icon: 'fa-ticket', color: 'text-green-300' }, 
            { id: 'vq_11', name: '20 KNB', type: 'currency', currency: 'kimNguyenBao', value: 20, icon: 'fa-gem', color: 'text-red-400' },
            { id: 'vq_12', name: '5,000,000 NL', type: 'currency', currency: 'nganLuong', value: 5000000, icon: 'fa-solid fa-sack-dollar', color: 'text-yellow-200' },
            { id: 'vq_13', name: 'Linh Khí x100', type: 'currency', currency: 'linhKhi', value: 100, icon: 'fa-wind', color: 'text-purple-300' },

            // --- Cột Trái (Left Col: 13-15) ---
            { id: 'vq_14', name: 'Trượt', type: 'nothing', icon: 'fa-face-frown', color: 'text-gray-500' },
            { id: 'vq_15', name: 'Chìa Khóa Bạc', type: 'material', itemId: 'key_rare', value: 1, icon: 'fa-key', color: 'text-purple-300' },
            { id: 'vq_16', name: 'Danh Vọng x10', type: 'currency', currency: 'danhVong', value: 10, icon: 'fa-scroll', color: 'text-teal-300' }
        ];

        // [FIX] Re-added the complete RIVAL_SECTS_DB definition which was corrupted
        const RIVAL_SECTS_DB = {
            'sect_1': {
                id: 'sect_1',
                name: 'Thanh Thành Phái',
                icon: 'fa-solid fa-mountain',
                rarity: 1,
                powerLevel: 100, 
                levelReq: 1,
                desc: 'Môn phái nhỏ, chủ yếu gây rối ở Tương Dương.',
                rewards: {
                    diemCongHien: 1, 
                    nganLuong: 50000,
                    danhVong: 1,
                },
                cooldown: 10 * 60 * 1000 // 10 minutes
            },
            'sect_2': {
                id: 'sect_2',
                name: 'Đoàn Gia (Đại Lý)',
                icon: 'fa-solid fa-fingerprint',
                rarity: 2,
                powerLevel: 500,
                levelReq: 5,
                desc: 'Môn phái tại Đại Lý, võ công linh hoạt, khó lường.',
                rewards: {
                    diemCongHien: 3,
                    nganLuong: 150000,
                    danhVong: 1,
                },
                cooldown: 30 * 60 * 1000 // 30 minutes
            },
            'sect_3': {
                id: 'sect_3',
                name: 'Võ Đang Phái',
                icon: 'fa-solid fa-yin-yang',
                rarity: 3,
                powerLevel: 2000,
                levelReq: 10,
                desc: 'Thái Sơn Bắc Đẩu trong võ lâm, nội công thâm hậu.',
                rewards: {
                    diemCongHien: 8,
                    nganLuong: 500000,
                    danhVong: 2,
                },
                cooldown: 2 * 60 * 60 * 1000 // 2 hours
            },
            'sect_4': {
                id: 'sect_4',
                name: 'Thiếu Lâm Tự',
                icon: 'fa-solid fa-gopuram',
                rarity: 4,
                powerLevel: 5000,
                levelReq: 20,
                desc: 'Võ học thiên hạ xuất Thiếu Lâm. Nổi tiếng với 72 tuyệt kỹ.',
                rewards: {
                    diemCongHien: 20,
                    nganLuong: 1500000,
                    danhVong: 4,
                },
                cooldown: 6 * 60 * 60 * 1000 // 6 hours
            },
            'sect_5': {
                id: 'sect_5',
                name: 'Ma Giáo',
                icon: 'fa-solid fa-skull',
                rarity: 5,
                powerLevel: 10000,
                levelReq: 30,
                desc: 'Thế lực hắc ám bí ẩn, võ công tàn độc, thâm hiểm.',
                rewards: {
                    diemCongHien: 50,
                    nganLuong: 5000000,
                    danhVong: 10,
                },
                cooldown: 12 * 60 * 60 * 1000 // 12 hours
            },
            'sect_6': {
                id: 'sect_6',
                name: 'Cái Bang',
                icon: 'fa-solid fa-person-walking-with-cane',
                rarity: 6,
                powerLevel: 25000,
                levelReq: 35, 
                desc: 'Thiên hạ đệ nhất bang, nổi tiếng với Hàng Long Thập Bát Chưởng.',
                rewards: {
                    diemCongHien: 100,
                    nganLuong: 10000000,
                    danhVong: 20,
                },
                cooldown: 18 * 60 * 60 * 1000 // 18 hours
            },
            'sect_7': {
                id: 'sect_7',
                name: 'Minh Giáo',
                icon: 'fa-solid fa-sun',
                rarity: 7,
                powerLevel: 50000,
                levelReq: 40,
                desc: 'Nguồn gốc từ Ba Tư, võ công quỷ dị, Càn Khôn Đại Na Di.',
                rewards: {
                    diemCongHien: 200,
                    nganLuong: 25000000,
                    danhVong: 35,
                },
                cooldown: 24 * 60 * 60 * 1000 // 24 hours
            },
            'sect_8': {
                id: 'sect_8',
                name: 'Cổ Mộ Phái',
                icon: 'fa-solid fa-moon',
                rarity: 8,
                powerLevel: 100000,
                levelReq: 45,
                desc: 'Phái ẩn cư, nổi tiếng với Ngọc Nữ Tâm Kinh và khinh công tuyệt đỉnh.',
                rewards: {
                    diemCongHien: 400,
                    nganLuong: 50000000,
                    danhVong: 60,
                },
                cooldown: 36 * 60 * 60 * 1000 // 36 hours
            },
            'sect_9': {
                id: 'sect_9',
                name: 'Đảo Thần Long',
                icon: 'fa-solid fa-dragon',
                rarity: 9,
                powerLevel: 200000,
                levelReq: 50,
                desc: 'Một hòn đảo bí ẩn, nơi ở của Thần Long Giáo Chủ.',
                rewards: {
                    diemCongHien: 800,
                    nganLuong: 100000000,
                    danhVong: 100,
                },
                cooldown: 48 * 60 * 60 * 1000 // 48 hours
            },
            // [MODIFIED] Cập nhật Lực Chiến và Phần Thưởng cho các tông môn cấp cao (Đồng bộ với Map mới)
            'sect_10': {
                id: 'sect_10',
                name: 'Đường Môn',
                icon: 'fa-solid fa-bahai', 
                rarity: 9,
                powerLevel: 1000000, // 1M
                levelReq: 60,
                desc: 'Gia tộc ám khí lừng danh đất Thục. Độc dược và cơ quan khiến người ta khiếp sợ.',
                rewards: {
                    diemCongHien: 1000, 
                    nganLuong: 150000000, 
                    danhVong: 150, 
                },
                cooldown: 50 * 60 * 60 * 1000 
            },
            'sect_11': {
                id: 'sect_11',
                name: 'Thiên Nhẫn Giáo',
                icon: 'fa-solid fa-fire',
                rarity: 10, 
                powerLevel: 5000000, // 5M
                levelReq: 70,
                desc: 'Tà giáo Tây Vực, tôn thờ hỏa thần. Võ công tàn độc, thiêu rụi mọi thứ.',
                rewards: {
                    diemCongHien: 1500,
                    nganLuong: 250000000, 
                    danhVong: 200, 
                },
                cooldown: 55 * 60 * 60 * 1000
            },
            'sect_12': {
                id: 'sect_12',
                name: 'Nga Mi Phái',
                icon: 'fa-solid fa-spa',
                rarity: 10,
                powerLevel: 15000000, // 15M
                levelReq: 80,
                desc: 'Nữ nhi hào kiệt, kiếm pháp mềm mại nhưng ẩn chứa sát cơ vô hình.',
                rewards: {
                    diemCongHien: 2000, 
                    nganLuong: 400000000, 
                    danhVong: 300, 
                },
                cooldown: 60 * 60 * 60 * 1000
            },
            'sect_13': {
                id: 'sect_13',
                name: 'Côn Lôn Phái',
                icon: 'fa-solid fa-mountain-sun',
                rarity: 11, 
                powerLevel: 50000000, // 50M
                levelReq: 90,
                desc: 'Ẩn cư nơi núi tuyết vĩnh cửu, kiếm khí lạnh lẽo thấu xương, ngạo nghễ thiên hạ.',
                rewards: {
                    diemCongHien: 3000, 
                    nganLuong: 800000000, 
                    danhVong: 500, 
                },
                cooldown: 72 * 60 * 60 * 1000
            },
            'sect_14': {
                id: 'sect_14',
                name: 'Thiên Vương Bang',
                icon: 'fa-solid fa-shield-halved',
                rarity: 11,
                powerLevel: 150000000, // 150M
                levelReq: 100,
                desc: 'Chiến binh giáp sắt, thương pháp dũng mãnh, lấy công làm thủ, bất khả chiến bại.',
                rewards: {
                    diemCongHien: 5000, 
                    nganLuong: 1500000000, // 1.5B
                    danhVong: 800, 
                },
                cooldown: 84 * 60 * 60 * 1000
            },
            'sect_15': {
                id: 'sect_15',
                name: 'Tiêu Dao Phái',
                icon: 'fa-solid fa-fan',
                rarity: 12, 
                powerLevel: 500000000, // 500M
                levelReq: 120,
                desc: 'Hành tung bí ẩn, võ công thượng thừa, có khả năng hấp thụ nội lực kẻ khác.',
                rewards: {
                    diemCongHien: 8000, 
                    nganLuong: 3000000000, // 3B
                    danhVong: 1500, 
                },
                cooldown: 96 * 60 * 60 * 1000
            },
            'sect_16': {
                id: 'sect_16',
                name: 'Thiên Hạ Hội',
                icon: 'fa-solid fa-crown',
                rarity: 13, 
                powerLevel: 2000000000, // 2 Tỷ
                levelReq: 140,
                desc: 'Bang phái bá chủ võ lâm, tham vọng thống nhất thiên hạ. Sở hữu Phong Vân.',
                rewards: {
                    diemCongHien: 15000, 
                    nganLuong: 10000000000, // 10B
                    danhVong: 3000, 
                },
                cooldown: 120 * 60 * 60 * 1000
            },
            // [MODIFIED] Cập nhật lại chuỗi phần thưởng Tối Đa 20 Tỷ
            'sect_17': {
                id: 'sect_17',
                name: 'Vô Song Thành',
                icon: 'fa-solid fa-city',
                rarity: 13,
                powerLevel: 5000000000, // 5 Tỷ
                levelReq: 160,
                desc: 'Thành trì đối địch với Thiên Hạ Hội. Kiếm pháp hủy diệt linh hồn, ngừng đọng thời gian.',
                rewards: {
                    diemCongHien: 20000, 
                    nganLuong: 12000000000, // [MODIFIED] 12 Tỷ
                    danhVong: 4500, 
                },
                cooldown: 144 * 60 * 60 * 1000
            },
            'sect_18': {
                id: 'sect_18',
                name: 'Trung Hoa Các',
                icon: 'fa-solid fa-music',
                rarity: 14, 
                powerLevel: 10000000000, // 10 Tỷ
                levelReq: 180,
                desc: 'Nơi ở ẩn của Võ Lâm Thần Thoại. Kiếm khí hạo nhiên, vạn kiếm quy tông.',
                rewards: {
                    diemCongHien: 30000, 
                    nganLuong: 14000000000, // [MODIFIED] 14 Tỷ
                    danhVong: 7000, 
                },
                cooldown: 168 * 60 * 60 * 1000
            },
            'sect_19': {
                id: 'sect_19',
                name: 'Hiệp Khách Đảo',
                icon: 'fa-solid fa-skull-crossbones',
                rarity: 14,
                powerLevel: 25000000000, // 25 Tỷ
                levelReq: 200,
                desc: 'Hòn đảo bí ẩn, nơi đi dễ khó về. Chứa đựng bí mật võ học tối thượng.',
                rewards: {
                    diemCongHien: 50000, 
                    nganLuong: 16000000000, // [MODIFIED] 16 Tỷ
                    danhVong: 12000, 
                },
                cooldown: 192 * 60 * 60 * 1000
            },
            'sect_20': {
                id: 'sect_20',
                name: 'Thiên Ngoại Thiên',
                icon: 'fa-solid fa-meteor',
                rarity: 15, 
                powerLevel: 50000000000, // 50 Tỷ
                levelReq: 250,
                desc: 'Thế lực nằm ngoài tam giới, sức mạnh vượt qua phạm trù võ học phàm trần.',
                rewards: {
                    diemCongHien: 100000, 
                    nganLuong: 18000000000, // [MODIFIED] 18 Tỷ
                    danhVong: 25000, 
                },
                cooldown: 240 * 60 * 60 * 1000 // 10 ngày
            },
            // [NEW] 3 Tông Môn Mới
            'sect_21': {
                id: 'sect_21',
                name: 'Bồng Lai Tiên Đảo',
                icon: 'fa-solid fa-cloud-sun',
                rarity: 15,
                powerLevel: 75000000000, // 75 Tỷ
                levelReq: 300,
                desc: 'Tiên đảo lơ lửng trên chín tầng mây, nơi các Chân Tiên tu luyện.',
                rewards: {
                    diemCongHien: 150000,
                    nganLuong: 19000000000, // 19 Tỷ
                    danhVong: 40000,
                },
                cooldown: 288 * 60 * 60 * 1000 // 12 ngày
            },
            'sect_22': {
                id: 'sect_22',
                name: 'Thương Khung Chi Đỉnh',
                icon: 'fa-solid fa-mountain',
                rarity: 15,
                powerLevel: 100000000000, // 100 Tỷ
                levelReq: 350,
                desc: 'Đỉnh núi cao nhất thế giới, nơi giao thoa giữa Thiên và Địa.',
                rewards: {
                    diemCongHien: 200000,
                    nganLuong: 20000000000, // 20 Tỷ (Max)
                    danhVong: 60000,
                },
                cooldown: 336 * 60 * 60 * 1000 // 14 ngày
            },
            'sect_23': {
                id: 'sect_23',
                name: 'Hư Không Thần Điện',
                icon: 'fa-solid fa-dungeon',
                rarity: 16,
                powerLevel: 150000000000, // 150 Tỷ
                levelReq: 400,
                desc: 'Điện thờ cổ xưa trôi nổi trong hư không, chứa đựng sức mạnh khởi nguyên.',
                rewards: {
                    diemCongHien: 300000, // Tăng mạnh ĐCH bù cho NL
                    nganLuong: 20000000000, // 20 Tỷ (Max)
                    danhVong: 100000, // Tăng mạnh Danh Vọng
                },
                cooldown: 360 * 60 * 60 * 1000 // 15 ngày
            },
            // [NEW] 5 Mốc Mới (200 - 999 Tỷ)
            'sect_24': {
                id: 'sect_24',
                name: 'Cửu Thiên Huyền Nữ Cung',
                icon: 'fa-solid fa-person-dress',
                rarity: 16,
                powerLevel: 200000000000, // 200 Tỷ
                levelReq: 450,
                desc: 'Cung điện của Huyền Nữ trên chín tầng trời, nơi cất giữ bí mật trường sinh.',
                rewards: {
                    diemCongHien: 400000,
                    nganLuong: 22000000000, // 22 Tỷ
                    danhVong: 150000,
                },
                cooldown: 384 * 60 * 60 * 1000 // 16 ngày
            },
            'sect_25': {
                id: 'sect_25',
                name: 'Vạn Cổ Tiên Đình',
                icon: 'fa-solid fa-place-of-worship',
                rarity: 16,
                powerLevel: 300000000000, // 300 Tỷ
                levelReq: 500,
                desc: 'Tàn tích của Tiên Đình thời thượng cổ, vẫn còn các Tiên Nhân trấn giữ.',
                rewards: {
                    diemCongHien: 500000,
                    nganLuong: 25000000000, // 25 Tỷ (Max Cap)
                    danhVong: 200000,
                },
                cooldown: 432 * 60 * 60 * 1000 // 18 ngày
            },
            'sect_26': {
                id: 'sect_26',
                name: 'Thái Cổ Thần Tộc',
                icon: 'fa-solid fa-dna',
                rarity: 16,
                powerLevel: 500000000000, // 500 Tỷ
                levelReq: 600,
                desc: 'Chủng tộc thần thánh sinh ra từ hỗn độn, sức mạnh nghịch thiên.',
                rewards: {
                    diemCongHien: 750000,
                    nganLuong: 25000000000, // 25 Tỷ (Max Cap)
                    danhVong: 300000,
                },
                cooldown: 480 * 60 * 60 * 1000 // 20 ngày
            },
            'sect_27': {
                id: 'sect_27',
                name: 'Hỗn Độn Ma Sào',
                icon: 'fa-solid fa-biohazard',
                rarity: 16,
                powerLevel: 750000000000, // 750 Tỷ
                levelReq: 700,
                desc: 'Hang ổ của Ma Thần hỗn độn, nơi vạn vật bị thôn phệ.',
                rewards: {
                    diemCongHien: 1000000,
                    nganLuong: 25000000000, // 25 Tỷ (Max Cap)
                    danhVong: 500000,
                },
                cooldown: 528 * 60 * 60 * 1000 // 22 ngày
            },
            'sect_28': {
                id: 'sect_28',
                name: 'Thiên Đạo Chấp Pháp Giả',
                icon: 'fa-solid fa-gavel',
                rarity: 16, 
                powerLevel: 999000000000, // 999 Tỷ
                levelReq: 800,
                desc: 'Những kẻ thay trời hành đạo, nắm giữ quy tắc sinh diệt của vũ trụ.',
                rewards: {
                    diemCongHien: 2000000, 
                    nganLuong: 25000000000, // 25 Tỷ (Max Cap)
                    danhVong: 1000000, 
                },
                cooldown: 720 * 60 * 60 * 1000 // 30 ngày
            },
            // [NEW] 4 Mốc Siêu Cấp (1250 Tỷ - 5000 Tỷ)
            'sect_29': {
                id: 'sect_29',
                name: 'Thời Gian Thần Điện',
                icon: 'fa-solid fa-hourglass-half',
                rarity: 16, // Sáng Thế
                powerLevel: 1250000000000, // 1,250 Tỷ
                levelReq: 850,
                desc: 'Nơi dòng sông thời gian khởi nguồn. Những kẻ canh giữ quá khứ và tương lai.',
                rewards: {
                    diemCongHien: 2500000,
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 1500000,
                },
                cooldown: 840 * 60 * 60 * 1000 // 35 ngày
            },
            'sect_30': {
                id: 'sect_30',
                name: 'Vận Mệnh Thiên Cung',
                icon: 'fa-solid fa-dice-d20',
                rarity: 16, // Sáng Thế
                powerLevel: 1500000000000, // 1,500 Tỷ
                levelReq: 900,
                desc: 'Cung điện điều khiển số mệnh của vạn vật. Thay đổi định mệnh, nghịch thiên cải mệnh.',
                rewards: {
                    diemCongHien: 3000000,
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 2000000,
                },
                cooldown: 960 * 60 * 60 * 1000 // 40 ngày
            },
            'sect_31': {
                id: 'sect_31',
                name: 'Hỗn Độn Sơ Khai',
                icon: 'fa-solid fa-hurricane',
                rarity: 16, // Hư Vô
                powerLevel: 2500000000000, // 2,500 Tỷ
                levelReq: 1000,
                desc: 'Trở về trạng thái trước khi vũ trụ hình thành. Hư vô, tịch mịch và hủy diệt.',
                rewards: {
                    diemCongHien: 5000000,
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 3000000,
                },
                cooldown: 1200 * 60 * 60 * 1000 // 50 ngày
            },
            'sect_32': {
                id: 'sect_32',
                name: 'Hư Vô Chúa Tể',
                icon: 'fa-solid fa-infinity',
                rarity: 16, // Vĩnh Hằng
                powerLevel: 5000000000000, // 5,000 Tỷ
                levelReq: 1200,
                desc: 'Thực thể tối cao đứng trên mọi quy tắc. Sự tồn tại cuối cùng của Đa Vũ Trụ.',
                rewards: {
                    diemCongHien: 10000000, // Siêu khủng
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 5000000,
                },
                cooldown: 1440 * 60 * 60 * 1000 // 60 ngày
            }
        };

        // [NEW] Sect Dungeon Database (Phó Bản Tông Môn)
        const SECT_DUNGEON_DB = {
            'sect_dungeon_1': {
                id: 'sect_dungeon_1',
                name: 'Huyết Sắc Mộ Địa',
                desc: 'Một hầm mộ cổ xưa, đầy rẫy oán khí và cương thi.',
                icon: 'fa-solid fa-skull', 
                rarity: 3, 
                powerReq: 100000, 
                cooldown: 1 * 60 * 60 * 1000, // [MODIFIED] 6h -> 1h
                rewards: { diemCongHien: 50, linhKhi: 5000, material: 'upgrade_stone_medium', materialAmount: 5 }
            },
            'sect_dungeon_2': {
                id: 'sect_dungeon_2',
                name: 'Ma Hỏa Động',
                desc: 'Một hang động núi lửa, nơi trú ngụ của Hỏa Ma.',
                icon: 'fa-solid fa-fire', 
                rarity: 4, 
                powerReq: 500000, 
                cooldown: 2 * 60 * 60 * 1000, // [MODIFIED] 12h -> 2h
                rewards: { diemCongHien: 200, linhKhi: 25000, material: 'upgrade_stone_high', materialAmount: 3 }
            },
            'sect_dungeon_3': {
                id: 'sect_dungeon_3',
                name: 'Băng Cung Vĩnh Hằng',
                desc: 'Cung điện của Băng Nữ, nhiệt độ có thể đóng băng linh hồn.',
                icon: 'fa-solid fa-snowflake', 
                rarity: 5, 
                powerReq: 1500000, 
                cooldown: 4 * 60 * 60 * 1000, // [MODIFIED] 24h -> 4h
                rewards: { diemCongHien: 500, linhKhi: 100000, material: 'gem_purple_2', materialAmount: 1 }
            },
            'sect_dungeon_4': {
                id: 'sect_dungeon_4',
                name: 'Lôi Đình Thánh Vực',
                desc: 'Một không gian bị Lôi Kiếp tàn phá, đầy rẫy Lôi Linh.',
                icon: 'fa-solid fa-bolt', 
                rarity: 6, 
                powerReq: 5000000, 
                cooldown: 6 * 60 * 60 * 1000, // [MODIFIED] 48h -> 6h
                rewards: { diemCongHien: 1200, linhKhi: 500000, material: 'gem_yellow_3', materialAmount: 1 }
            },
            'sect_dungeon_5': {
                id: 'sect_dungeon_5',
                name: 'Thượng Cổ Di Tích',
                desc: 'Tàn tích của một tông môn cổ xưa, được canh giữ bởi các linh hồn hùng mạnh.',
                icon: 'fa-solid fa-monument', 
                rarity: 7, 
                powerReq: 10000000, 
                cooldown: 8 * 60 * 60 * 1000, // [MODIFIED] 72h -> 8h
                rewards: { diemCongHien: 2500, linhKhi: 1000000, material: 'gem_green_4', materialAmount: 1 }
            },
            'sect_dungeon_6': {
                id: 'sect_dungeon_6',
                name: 'Hư Không Liệt Phùng',
                desc: 'Một vết nứt không gian, dẫn đến một chiều không gian hỗn loạn đầy quái vật.',
                icon: 'fa-solid fa-hurricane', 
                rarity: 8, 
                powerReq: 20000000, 
                cooldown: 12 * 60 * 60 * 1000, // [MODIFIED] 96h -> 12h
                rewards: { diemCongHien: 5000, linhKhi: 2500000, material: 'gem_blue_4', materialAmount: 1 }
            },
            'sect_dungeon_7': {
                id: 'sect_dungeon_7',
                name: 'Ma Thần Điện',
                desc: 'Nơi Ma Thần thượng cổ từng ngự trị, sát khí ngút trời.',
                icon: 'fa-solid fa-dungeon', 
                rarity: 8, 
                powerReq: 35000000, 
                cooldown: 16 * 60 * 60 * 1000, // [MODIFIED] 120h -> 16h
                rewards: { diemCongHien: 10000, linhKhi: 5000000, material: 'gem_purple_4', materialAmount: 1 }
            },
            'sect_dungeon_8': {
                id: 'sect_dungeon_8',
                name: 'Tiên Cung Hỗn Loạn',
                desc: 'Cung điện của Tiên Nhân sa ngã. (Thưởng: 1 Trang Bị Siêu Thần Lv.200 - 5%)',
                icon: 'fa-solid fa-place-of-worship', 
                rarity: 9, 
                powerReq: 60000000, 
                cooldown: 20 * 60 * 60 * 1000, // [MODIFIED] 144h -> 20h
                rewards: { diemCongHien: 15000, linhKhi: 10000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 200, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_9': {
                id: 'sect_dungeon_9',
                name: 'Hồn Hà Cổ Giới',
                desc: 'Nơi linh hồn an nghỉ. (Thưởng: 1 Trang Bị Siêu Thần Lv.210 - 5%)',
                icon: 'fa-solid fa-water', 
                rarity: 9, 
                powerReq: 100000000, 
                cooldown: 24 * 60 * 60 * 1000, // [MODIFIED] 168h -> 24h
                rewards: { diemCongHien: 25000, linhKhi: 20000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 210, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_10': {
                id: 'sect_dungeon_10',
                name: 'Thần Vực Hủy Diệt',
                desc: 'Lãnh địa thần sa ngã. (Thưởng: 1 Trang Bị Siêu Thần Lv.220 - 5%)',
                icon: 'fa-solid fa-bomb', 
                rarity: 10, 
                powerReq: 175000000, 
                cooldown: 30 * 60 * 60 * 1000, // [MODIFIED] 192h -> 30h
                rewards: { diemCongHien: 40000, linhKhi: 35000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 220, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_11': {
                id: 'sect_dungeon_11',
                name: 'Hỗn Độn Chung Cực',
                desc: 'Nơi tận cùng vũ trụ. (Thưởng: 1 Trang Bị Siêu Thần Lv.225 - 5%)',
                icon: 'fa-solid fa-circle-dot', 
                rarity: 10, 
                powerReq: 300000000, 
                cooldown: 36 * 60 * 60 * 1000, // [MODIFIED] 240h -> 36h
                rewards: { diemCongHien: 75000, linhKhi: 60000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 225, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_12': {
                id: 'sect_dungeon_12',
                name: 'Thiên Ngoại Ma Cung',
                desc: 'Cung điện Ma Tộc. (Thưởng: 1 Trang Bị Siêu Thần Lv.230 - 5%)',
                icon: 'fa-solid fa-chess-rook', 
                rarity: 11, 
                powerReq: 500000000, 
                cooldown: 42 * 60 * 60 * 1000, // [MODIFIED] 240h -> 42h
                rewards: { diemCongHien: 100000, linhKhi: 100000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 230, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_13': {
                id: 'sect_dungeon_13',
                name: 'Vực Sâu Vô Tận',
                desc: 'Nơi sâu nhất thế giới. (Thưởng: 1 Trang Bị Siêu Thần Lv.235 - 5%)',
                icon: 'fa-solid fa-angle-down', 
                rarity: 11, 
                powerReq: 1000000000, 
                cooldown: 48 * 60 * 60 * 1000, // [MODIFIED] 240h -> 48h
                rewards: { diemCongHien: 200000, linhKhi: 250000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 235, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_14': {
                id: 'sect_dungeon_14',
                name: 'Hư Không Chiến Trường',
                desc: 'Chiến trường cổ đại. (Thưởng: 1 Trang Bị Siêu Thần Lv.240 - 5%)',
                icon: 'fa-solid fa-shuttle-space', 
                rarity: 12, 
                powerReq: 2500000000, 
                cooldown: 52 * 60 * 60 * 1000, // [MODIFIED] 300h -> 52h
                rewards: { diemCongHien: 500000, linhKhi: 500000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 240, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_15': {
                id: 'sect_dungeon_15',
                name: 'Thần Mộ Viễn Cổ',
                desc: 'Nơi an nghỉ của thần. (Thưởng: 1 Trang Bị Siêu Thần Lv.245 - 5%)',
                icon: 'fa-solid fa-cross', 
                rarity: 12, 
                powerReq: 5000000000, 
                cooldown: 56 * 60 * 60 * 1000, // [MODIFIED] 360h -> 56h
                // [UPDATED] Linh Khí giới hạn 1 Tỷ
                rewards: { diemCongHien: 1000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 245, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_16': {
                id: 'sect_dungeon_16',
                name: 'Điện Thờ Sáng Thế',
                desc: 'Khởi nguồn sự sống. (Thưởng: 1 Trang Bị Siêu Thần Lv.250 - 5%)',
                icon: 'fa-solid fa-sun', 
                rarity: 13, 
                powerReq: 10000000000, 
                cooldown: 60 * 60 * 60 * 1000, // [MODIFIED] 480h -> 60h
                // [UPDATED] Linh Khí giới hạn 1 Tỷ
                rewards: { diemCongHien: 2500000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 250, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_17': {
                id: 'sect_dungeon_17',
                name: 'Vực Thẳm Hỗn Mang',
                desc: 'Nơi không gian và thời gian đảo lộn. (Thưởng: 1 Trang Bị Siêu Thần Lv.260 - 5%)',
                icon: 'fa-solid fa-tornado', 
                rarity: 13, 
                powerReq: 15000000000, 
                cooldown: 64 * 60 * 60 * 1000, // [MODIFIED] 500h -> 64h
                // [UPDATED] Linh Khí giới hạn 1 Tỷ
                rewards: { diemCongHien: 5000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 260, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_18': {
                id: 'sect_dungeon_18',
                name: 'Thiên Đạo Cấm Vực',
                desc: 'Vùng đất cấm kỵ của Thiên Đạo. (Thưởng: 1 Trang Bị Siêu Thần Lv.270 - 5%)',
                icon: 'fa-solid fa-ban', 
                rarity: 14, 
                powerReq: 25000000000, 
                cooldown: 68 * 60 * 60 * 1000, // [MODIFIED] 600h -> 68h
                // [UPDATED] Linh Khí giới hạn 1 Tỷ
                rewards: { diemCongHien: 10000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 270, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_19': {
                id: 'sect_dungeon_19',
                name: 'Cửu Trọng Thiên Khuyết',
                desc: 'Cung điện của các Cổ Thần trên chín tầng trời. (Thưởng: 1 Trang Bị Siêu Thần Lv.280 - 5%)',
                icon: 'fa-solid fa-cloud-sun', 
                rarity: 15, 
                powerReq: 35000000000, 
                cooldown: 70 * 60 * 60 * 1000, // [MODIFIED] 720h -> 70h
                // [UPDATED] Linh Khí giới hạn 1 Tỷ
                rewards: { diemCongHien: 20000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 280, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_20': {
                id: 'sect_dungeon_20',
                name: 'Hư Vô Tận Cùng',
                desc: 'Điểm kết thúc của vạn vật, hư vô vĩnh hằng. (Thưởng: 1 Trang Bị Siêu Thần Lv.300 - 5%)',
                icon: 'fa-solid fa-infinity', 
                rarity: 16, 
                powerReq: 50000000000, 
                cooldown: 72 * 60 * 60 * 1000, // [MODIFIED] 720h -> 72h (Max 3 days)
                // [UPDATED] Linh Khí giới hạn 1 Tỷ, Cống Hiến giới hạn 25 Triệu
                rewards: { diemCongHien: 25000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 300, materialAmount: 1, dropChance: 5 }
            },
            // [NEW] 8 Bản Đồ Phó Bản Mới (75 Tỷ - 999 Tỷ)
            'sect_dungeon_21': {
                id: 'sect_dungeon_21',
                name: 'Táng Thần Uyên',
                desc: 'Vực thẳm chôn cất các vị thần sa ngã. (Thưởng: 1 Trang Bị Siêu Thần Lv.320 - 5%)',
                icon: 'fa-solid fa-skull',
                rarity: 16,
                powerReq: 75000000000, // 75 Tỷ
                cooldown: 74 * 60 * 60 * 1000, // ~3 ngày
                rewards: { diemCongHien: 30000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 320, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_22': {
                id: 'sect_dungeon_22',
                name: 'Hồng Mông Thánh Điện',
                desc: 'Thánh điện tồn tại từ thuở khai thiên. (Thưởng: 1 Trang Bị Siêu Thần Lv.350 - 5%)',
                icon: 'fa-solid fa-place-of-worship',
                rarity: 16,
                powerReq: 100000000000, // 100 Tỷ
                cooldown: 76 * 60 * 60 * 1000,
                rewards: { diemCongHien: 40000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 350, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_23': {
                id: 'sect_dungeon_23',
                name: 'Thời Không Trường Hà',
                desc: 'Dòng sông thời gian trôi vô tận. (Thưởng: 1 Trang Bị Siêu Thần Lv.380 - 5%)',
                icon: 'fa-solid fa-water',
                rarity: 16,
                powerReq: 150000000000, // 150 Tỷ
                cooldown: 78 * 60 * 60 * 1000,
                rewards: { diemCongHien: 50000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 380, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_24': {
                id: 'sect_dungeon_24',
                name: 'Vô Tận Hắc Ám',
                desc: 'Nơi ánh sáng không thể chạm tới. (Thưởng: 1 Trang Bị Siêu Thần Lv.400 - 5%)',
                icon: 'fa-solid fa-moon',
                rarity: 16,
                powerReq: 200000000000, // 200 Tỷ
                cooldown: 80 * 60 * 60 * 1000,
                rewards: { diemCongHien: 60000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 400, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_25': {
                id: 'sect_dungeon_25',
                name: 'Khởi Nguyên Chi Địa',
                desc: 'Nơi bắt đầu của tất cả. (Thưởng: 1 Trang Bị Siêu Thần Lv.450 - 5%)',
                icon: 'fa-solid fa-seedling',
                rarity: 16,
                powerReq: 300000000000, // 300 Tỷ
                cooldown: 84 * 60 * 60 * 1000,
                rewards: { diemCongHien: 80000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 450, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_26': {
                id: 'sect_dungeon_26',
                name: 'Chân Lý Chi Môn',
                desc: 'Cánh cửa dẫn đến sự thật tối thượng. (Thưởng: 1 Trang Bị Siêu Thần Lv.500 - 5%)',
                icon: 'fa-solid fa-door-open',
                rarity: 16,
                powerReq: 500000000000, // 500 Tỷ
                cooldown: 96 * 60 * 60 * 1000, // 4 days
                rewards: { diemCongHien: 100000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 500, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_27': {
                id: 'sect_dungeon_27',
                name: 'Hư Vô Giới',
                desc: 'Thế giới không tồn tại vật chất. (Thưởng: 1 Trang Bị Siêu Thần Lv.600 - 5%)',
                icon: 'fa-solid fa-ghost',
                rarity: 16,
                powerReq: 750000000000, // 750 Tỷ
                cooldown: 120 * 60 * 60 * 1000, // 5 days
                rewards: { diemCongHien: 150000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 600, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_28': {
                id: 'sect_dungeon_28',
                name: 'Thiên Đạo Chung Cực',
                desc: 'Điểm cuối của con đường tu tiên. (Thưởng: 1 Trang Bị Siêu Thần Lv.800 - 5%)',
                icon: 'fa-solid fa-yin-yang',
                rarity: 16,
                powerReq: 999000000000, // 999 Tỷ
                cooldown: 168 * 60 * 60 * 1000, // 7 days
                rewards: { diemCongHien: 250000000, linhKhi: 1000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 800, materialAmount: 1, dropChance: 5 }
            },
            // [NEW] 4 Phó Bản Siêu Cấp (1.250 Tỷ - 5.000 Tỷ)
            'sect_dungeon_29': {
                id: 'sect_dungeon_29',
                name: 'Hư Không Tinh Cung',
                desc: 'Cung điện trôi nổi giữa các vì sao, nơi cất giấu bí mật vũ trụ. (Thưởng: Trang Bị Lv.850)',
                icon: 'fa-solid fa-star',
                rarity: 16,
                powerReq: 1250000000000, // 1.250 Tỷ
                cooldown: 192 * 60 * 60 * 1000, // 8 days
                rewards: { diemCongHien: 300000000, linhKhi: 2000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 850, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_30': {
                id: 'sect_dungeon_30',
                name: 'Thời Gian Chi Hà',
                desc: 'Dòng sông thời gian, nơi quá khứ và tương lai giao nhau. (Thưởng: Trang Bị Lv.900)',
                icon: 'fa-solid fa-hourglass-half',
                rarity: 16,
                powerReq: 1500000000000, // 1.500 Tỷ
                cooldown: 216 * 60 * 60 * 1000, // 9 days
                rewards: { diemCongHien: 400000000, linhKhi: 3000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 900, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_31': {
                id: 'sect_dungeon_31',
                name: 'Vực Sâu Hỗn Mang',
                desc: 'Nơi hỗn độn sơ khai chưa phân tách, nguy hiểm cùng cực. (Thưởng: Trang Bị Lv.1000)',
                icon: 'fa-solid fa-hurricane',
                rarity: 16,
                powerReq: 2500000000000, // 2.500 Tỷ
                cooldown: 240 * 60 * 60 * 1000, // 10 days
                rewards: { diemCongHien: 600000000, linhKhi: 5000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 1000, materialAmount: 1, dropChance: 5 }
            },
            'sect_dungeon_32': {
                id: 'sect_dungeon_32',
                name: 'Cội Nguồn Sáng Thế',
                desc: 'Nơi khởi nguồn của tất cả sự sống và cái chết. (Thưởng: Trang Bị Lv.1200)',
                icon: 'fa-solid fa-atom',
                rarity: 16,
                powerReq: 5000000000000, // 5.000 Tỷ
                cooldown: 360 * 60 * 60 * 1000, // 15 days
                rewards: { diemCongHien: 1000000000, linhKhi: 10000000000, rewardType: 'generated_equipment', quality: 'supergodly', level: 1200, materialAmount: 1, dropChance: 5 }
            }
        }; // [FIX] Đảm bảo đóng SECT_DUNGEON_DB đúng cách

        // [NEW] Chien Truong (Battlefield) Database - UPDATE: 25B NL CAP & SUPER LEVELS
        const CHIEN_TRUONG_DB = {
            'battlefield_1': {
                id: 'battlefield_1', name: 'Chiến Trường Tống Kim (Sơ)', icon: 'fa-solid fa-flag-checkered', rarity: 1, powerReq: 500000,
                desc: 'Chiến trường cơ bản. Thưởng Ngân Lượng và Kinh Nghiệm.',
                rewards: { diemTichLuyTongKim: 10, xp: 5000000, nganLuong: 1000000, danhVong: 5 }, cooldown: 30 * 60 * 1000
            },
            // ... (Giữ nguyên các level thấp từ 2 đến 23) ...
            'battlefield_2': { id: 'battlefield_2', name: 'Chiến Trường Tống Kim (Trung)', icon: 'fa-solid fa-tents', rarity: 2, powerReq: 2000000, desc: 'Giao tranh quy mô lớn hơn.', rewards: { diemTichLuyTongKim: 30, xp: 15000000, nganLuong: 5000000, danhVong: 15 }, cooldown: 2 * 60 * 60 * 1000 },
            'battlefield_3': { id: 'battlefield_3', name: 'Chiến Trường Tống Kim (Cao)', icon: 'fa-solid fa-castle', rarity: 3, powerReq: 5000000, desc: 'Công thành chiến khốc liệt.', rewards: { diemTichLuyTongKim: 75, xp: 50000000, nganLuong: 15000000, danhVong: 40 }, cooldown: 6 * 60 * 60 * 1000 },
            'battlefield_4': { id: 'battlefield_4', name: 'Chiến Trường Liên Server', icon: 'fa-solid fa-server', rarity: 4, powerReq: 10000000, desc: 'Giao tranh với cao thủ thế giới khác.', rewards: { diemTichLuyTongKim: 150, xp: 150000000, nganLuong: 30000000, danhVong: 100 }, cooldown: 12 * 60 * 60 * 1000 },
            'battlefield_5': { id: 'battlefield_5', name: 'Chiến Trường Thần Ma', icon: 'fa-solid fa-meteor', rarity: 5, powerReq: 25000000, desc: 'Chiến trường thượng cổ.', rewards: { diemTichLuyTongKim: 300, xp: 500000000, nganLuong: 75000000, danhVong: 250 }, cooldown: 24 * 60 * 60 * 1000 },
            'battlefield_6': { id: 'battlefield_6', name: 'Chiến Trường Hỗn Loạn', icon: 'fa-solid fa-tornado', rarity: 6, powerReq: 50000000, desc: 'Nơi sức mạnh hỗn loạn giao thoa.', rewards: { diemTichLuyTongKim: 500, xp: 1200000000, nganLuong: 150000000, danhVong: 400 }, cooldown: 36 * 60 * 60 * 1000 },
            'battlefield_7': { id: 'battlefield_7', name: 'Chiến Trường Tinh Anh', icon: 'fa-solid fa-user-shield', rarity: 7, powerReq: 100000000, desc: 'Chỉ dành cho tinh anh.', rewards: { diemTichLuyTongKim: 1000, xp: 3000000000, nganLuong: 350000000, danhVong: 750 }, cooldown: 48 * 60 * 60 * 1000 },
            'battlefield_8': { id: 'battlefield_8', name: 'Chiến Trường Thần Giới', icon: 'fa-solid fa-wand-sparkles', rarity: 8, powerReq: 200000000, desc: 'Chiến trường của các vị thần.', rewards: { diemTichLuyTongKim: 2000, xp: 8000000000, nganLuong: 800000000, danhVong: 1500 }, cooldown: 72 * 60 * 60 * 1000 },
            'battlefield_9': { id: 'battlefield_9', name: 'Chiến Trường Ma Giới', icon: 'fa-solid fa-ghost', rarity: 9, powerReq: 350000000, desc: 'Xâm nhập Ma Giới.', rewards: { diemTichLuyTongKim: 3500, xp: 15000000000, nganLuong: 1500000000, danhVong: 2500 }, cooldown: 96 * 60 * 60 * 1000 },
            'battlefield_10': { id: 'battlefield_10', name: 'Chiến Trường Hư Vô', icon: 'fa-solid fa-circle-nodes', rarity: 10, powerReq: 500000000, desc: 'Chiến trường cuối cùng.', rewards: { diemTichLuyTongKim: 5000, xp: 30000000000, nganLuong: 3000000000, danhVong: 5000 }, cooldown: 120 * 60 * 60 * 1000 },
            'battlefield_11': { id: 'battlefield_11', name: 'Chiến Trường Vô Tận', icon: 'fa-solid fa-infinity', rarity: 11, powerReq: 1000000000, desc: 'Không gian chiến đấu vô tận.', rewards: { diemTichLuyTongKim: 10000, xp: 80000000000, nganLuong: 5000000000, danhVong: 7500 }, cooldown: 144 * 60 * 60 * 1000 },
            'battlefield_12': { id: 'battlefield_12', name: 'Thần Ma Đại Chiến', icon: 'fa-solid fa-dragon', rarity: 12, powerReq: 2500000000, desc: 'Tái hiện cuộc chiến kinh thiên.', rewards: { diemTichLuyTongKim: 25000, xp: 200000000000, nganLuong: 10000000000, danhVong: 15000 }, cooldown: 168 * 60 * 60 * 1000 },
            'battlefield_13': { id: 'battlefield_13', name: 'Hỗn Độn Chiến Vực', icon: 'fa-solid fa-hurricane', rarity: 13, powerReq: 5000000000, desc: 'Chiến đấu trong hỗn mang.', rewards: { diemTichLuyTongKim: 50000, xp: 500000000000, nganLuong: 15000000000, danhVong: 30000 }, cooldown: 192 * 60 * 60 * 1000 },
            'battlefield_14': { id: 'battlefield_14', name: 'Sáng Thế Chi Chiến', icon: 'fa-solid fa-sun', rarity: 14, powerReq: 10000000000, desc: 'Cuộc chiến định hình vũ trụ.', rewards: { diemTichLuyTongKim: 100000, xp: 1500000000000, nganLuong: 20000000000, danhVong: 60000 }, cooldown: 240 * 60 * 60 * 1000 },
            'battlefield_15': { id: 'battlefield_15', name: 'Hư Không Đại Kiếp', icon: 'fa-solid fa-skull-crossbones', rarity: 15, powerReq: 20000000000, desc: 'Đại kiếp nạn cuối cùng.', rewards: { diemTichLuyTongKim: 250000, xp: 5000000000000, nganLuong: 25000000000, danhVong: 150000 }, cooldown: 360 * 60 * 60 * 1000 },
            'battlefield_16': { id: 'battlefield_16', name: 'Chiến Trường Tinh Hà', icon: 'fa-solid fa-star', rarity: 15, powerReq: 35000000000, desc: 'Chiến đấu giữa các vì sao.', rewards: { diemTichLuyTongKim: 400000, xp: 12000000000000, nganLuong: 25000000000, danhVong: 250000 }, cooldown: 400 * 60 * 60 * 1000 },
            'battlefield_17': { id: 'battlefield_17', name: 'Thần Ma Vô Song', icon: 'fa-solid fa-dragon', rarity: 16, powerReq: 50000000000, desc: 'Nơi Thần Ma mạnh nhất đối đầu.', rewards: { diemTichLuyTongKim: 600000, xp: 20000000000000, nganLuong: 25000000000, danhVong: 400000 }, cooldown: 480 * 60 * 60 * 1000 },
            'battlefield_18': { id: 'battlefield_18', name: 'Hỗn Độn Sơ Khai', icon: 'fa-solid fa-hurricane', rarity: 16, powerReq: 75000000000, desc: 'Thời điểm vũ trụ chưa hình thành.', rewards: { diemTichLuyTongKim: 800000, xp: 40000000000000, nganLuong: 25000000000, danhVong: 600000 }, cooldown: 550 * 60 * 60 * 1000 },
            'battlefield_19': { id: 'battlefield_19', name: 'Hồng Mông Chiến Vực', icon: 'fa-solid fa-sun', rarity: 16, powerReq: 100000000000, desc: 'Chiến trường sinh linh Hồng Mông.', rewards: { diemTichLuyTongKim: 1000000, xp: 70000000000000, nganLuong: 25000000000, danhVong: 800000 }, cooldown: 600 * 60 * 60 * 1000 },
            'battlefield_20': { id: 'battlefield_20', name: 'Đại Đạo Tranh Phong', icon: 'fa-solid fa-yin-yang', rarity: 16, powerReq: 200000000000, desc: 'Tranh giành đại đạo.', rewards: { diemTichLuyTongKim: 1500000, xp: 150000000000000, nganLuong: 25000000000, danhVong: 1200000 }, cooldown: 720 * 60 * 60 * 1000 },
            'battlefield_21': { id: 'battlefield_21', name: 'Tinh Hải Hỗn Loạn', icon: 'fa-solid fa-water', rarity: 16, powerReq: 300000000000, desc: 'Đại chiến giữa các chòm sao.', rewards: { diemTichLuyTongKim: 2000000, xp: 400000000000000, nganLuong: 25000000000, danhVong: 1600000 }, cooldown: 780 * 60 * 60 * 1000 },
            'battlefield_22': { id: 'battlefield_22', name: 'Hư Vô Tận Cùng', icon: 'fa-solid fa-ghost', rarity: 16, powerReq: 500000000000, desc: 'Điểm cuối của hư vô.', rewards: { diemTichLuyTongKim: 2500000, xp: 600000000000000, nganLuong: 25000000000, danhVong: 2000000 }, cooldown: 840 * 60 * 60 * 1000 },
            'battlefield_23': { id: 'battlefield_23', name: 'Vực Sâu Vô Tận', icon: 'fa-solid fa-circle-notch', rarity: 16, powerReq: 750000000000, desc: 'Nơi sâu nhất vũ trụ.', rewards: { diemTichLuyTongKim: 3500000, xp: 1000000000000000, nganLuong: 25000000000, danhVong: 3000000 }, cooldown: 920 * 60 * 60 * 1000 },
            'battlefield_24': { id: 'battlefield_24', name: 'Thiên Địa Chung Cực', icon: 'fa-solid fa-infinity', rarity: 16, powerReq: 999000000000, desc: 'Quyết định vận mệnh đa vũ trụ.', rewards: { diemTichLuyTongKim: 5000000, xp: 2000000000000000, nganLuong: 25000000000, danhVong: 5000000 }, cooldown: 1000 * 60 * 60 * 1000 },
            // [NEW] 4 Chiến Trường Siêu Cấp (1.250 Tỷ - 5.000 Tỷ)
            'battlefield_25': {
                id: 'battlefield_25',
                name: 'Chiến Trường Tinh Vực',
                icon: 'fa-solid fa-star',
                rarity: 16,
                powerReq: 1250000000000, // 1.250 Tỷ
                desc: 'Cuộc chiến giữa các thiên hà. (Thưởng XP cực lớn).',
                rewards: {
                    diemTichLuyTongKim: 6000000,
                    xp: 3000000000000000, // 3 Triệu Tỷ
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 6000000,
                },
                cooldown: 1200 * 60 * 60 * 1000 // 50 ngày
            },
            'battlefield_26': {
                id: 'battlefield_26',
                name: 'Thần Ma Viễn Cổ',
                icon: 'fa-solid fa-dragon',
                rarity: 16,
                powerReq: 1500000000000, // 1.500 Tỷ
                desc: 'Cuộc chiến của các vị thần cổ đại. (Thưởng XP cực lớn).',
                rewards: {
                    diemTichLuyTongKim: 7000000,
                    xp: 4000000000000000, // 4 Triệu Tỷ
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 7000000,
                },
                cooldown: 1440 * 60 * 60 * 1000 // 60 ngày
            },
            'battlefield_27': {
                id: 'battlefield_27',
                name: 'Đại Kiếp Luân Hồi',
                icon: 'fa-solid fa-infinity',
                rarity: 16,
                powerReq: 2500000000000, // 2.500 Tỷ
                desc: 'Vượt qua kiếp nạn luân hồi sinh tử. (Thưởng XP cực lớn).',
                rewards: {
                    diemTichLuyTongKim: 8500000,
                    xp: 6000000000000000, // 6 Triệu Tỷ
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 8500000,
                },
                cooldown: 1680 * 60 * 60 * 1000 // 70 ngày
            },
            'battlefield_28': {
                id: 'battlefield_28',
                name: 'Quyết Chiến Đỉnh Cao',
                icon: 'fa-solid fa-crown',
                rarity: 16,
                powerReq: 5000000000000, // 5.000 Tỷ
                desc: 'Trận chiến cuối cùng của những kẻ mạnh nhất vũ trụ.',
                rewards: {
                    diemTichLuyTongKim: 10000000,
                    xp: 10000000000000000, // 10 Triệu Tỷ
                    nganLuong: 25000000000, // Max 25 Tỷ
                    danhVong: 10000000,
                },
                cooldown: 1920 * 60 * 60 * 1000 // 80 ngày
            }
        };

        // [NEW] DB cho hệ thống Tinh Phách (Hấp thụ vĩnh viễn)
        const TINH_PHACH_DB = {
            // ID Vật Phẩm: { gemType (loại ngọc), stat, value, isPercent, cost (Ngân Lượng), desc }
            'gem_green_1': { gemType: 'green', stat: 'hp', value: 2, isPercent: false, cost: 1000, desc: '+2 HP vĩnh viễn' },
            'gem_green_2': { gemType: 'green', stat: 'hp', value: 10, isPercent: false, cost: 5000, desc: '+10 HP vĩnh viễn' },
            'gem_green_3': { gemType: 'green', stat: 'hp', value: 50, isPercent: false, cost: 25000, desc: '+50 HP vĩnh viễn' },
            'gem_green_4': { gemType: 'green', stat: 'hp', value: 250, isPercent: false, cost: 125000, desc: '+250 HP vĩnh viễn' },

            'gem_blue_1': { gemType: 'blue', stat: 'def', value: 1, isPercent: false, cost: 1000, desc: '+1 Thủ vĩnh viễn' },
            'gem_blue_2': { gemType: 'blue', stat: 'def', value: 5, isPercent: false, cost: 5000, desc: '+5 Thủ vĩnh viễn' },
            'gem_blue_3': { gemType: 'blue', stat: 'def', value: 25, isPercent: false, cost: 25000, desc: '+25 Thủ vĩnh viễn' },
            'gem_blue_4': { gemType: 'blue', stat: 'def', value: 125, isPercent: false, cost: 125000, desc: '+125 Thủ vĩnh viễn' },

            'gem_purple_1': { gemType: 'purple', stat: 'atk', value: 1, isPercent: false, cost: 1000, desc: '+1 Công vĩnh viễn' },
            'gem_purple_2': { gemType: 'purple', stat: 'atk', value: 5, isPercent: false, cost: 5000, desc: '+5 Công vĩnh viễn' },
            'gem_purple_3': { gemType: 'purple', stat: 'atk', value: 25, isPercent: false, cost: 25000, desc: '+25 Công vĩnh viễn' },
            'gem_purple_4': { gemType: 'purple', stat: 'atk', value: 125, isPercent: false, cost: 125000, desc: '+125 Công vĩnh viễn' },

            'gem_yellow_1': { gemType: 'yellow', stat: 'xp_boost', value: 0.01, isPercent: true, cost: 5000, desc: '+0.01% XP vĩnh viễn' },
            'gem_yellow_2': { gemType: 'yellow', stat: 'xp_boost', value: 0.05, isPercent: true, cost: 25000, desc: '+0.05% XP vĩnh viễn' },
            'gem_yellow_3': { gemType: 'yellow', stat: 'xp_boost', value: 0.1, isPercent: true, cost: 125000, desc: '+0.1% XP vĩnh viễn' },
            'gem_yellow_4': { gemType: 'yellow', stat: 'xp_boost', value: 0.5, isPercent: true, cost: 625000, desc: '+0.5% XP vĩnh viễn' }
        };

        // --- GAME DATABASES (ENEMIES, DUNGEONS) ---
        
        // Cấp 1-10: Sơ Cấp (Tân Thủ)
        const ENEMIES_DB = {
            'mob01': { name: 'Sơn Tặc Đại Ca', level: 5, rarity: 1, icon: 'fa-solid fa-user-ninja', 
                       stats: { hp: 111, atk: 9, def: 5, spd: 5, lck: 5 }, 
                       skills: [{ name: 'Chém Thường', chance: 0, multiplier: 1 }] },
            'mob02': { name: 'Sơn Tặc Tinh Anh', level: 8, rarity: 2, icon: 'fa-solid fa-user-ninja', 
                       stats: { hp: 150, atk: 12, def: 8, spd: 8, lck: 5 }, 
                       skills: [{ name: 'Chém Mạnh', chance: 0, multiplier: 1.1 }] },
            // [NEW] Enemies for Tiểu Ngư Thôn
            'mob_ngu_thon_1': { name: 'Cá Tinh', level: 6, rarity: 1, icon: 'fa-solid fa-fish-fins', 
                       stats: { hp: 130, atk: 10, def: 6, spd: 7, lck: 5 }, 
                       skills: [{ name: 'Quẫy Đuôi', chance: 0, multiplier: 1 }] },
            'mob_ngu_thon_2': { name: 'Tôm Tinh', level: 9, rarity: 1, icon: 'fa-solid fa-shrimp', 
                       stats: { hp: 160, atk: 13, def: 7, spd: 10, lck: 6 }, 
                       skills: [{ name: 'Búng Càng', chance: 0, multiplier: 1.1 }] },
            // [END NEW]
            // [NEW] Enemies for Tô Châu (15-25)
            'mob_to_chau_1': { name: 'Lính Gác Tô Châu', level: 17, rarity: 2, icon: 'fa-solid fa-user-shield', 
                       stats: { hp: 280, atk: 20, def: 14, spd: 11, lck: 10 }, 
                       skills: [{ name: 'Đâm Thương', chance: 0, multiplier: 1 }] },
            'mob_to_chau_2': { name: 'Thủy Tặc Thái Hồ', level: 22, rarity: 2, icon: 'fa-solid fa-water', 
                       stats: { hp: 400, atk: 30, def: 18, spd: 14, lck: 10 }, 
                       skills: [{ name: 'Vung Đao', chance: 15, multiplier: 1.3 }] },
            // [NEW] Enemies for Kinh Thành (25-35)
            'mob_kinh_thanh_1': { name: 'Cấm Vệ Quân', level: 27, rarity: 2, icon: 'fa-solid fa-user-shield', 
                       stats: { hp: 550, atk: 38, def: 22, spd: 13, lck: 12 }, 
                       skills: [{ name: 'Trường Đao', chance: 0, multiplier: 1 }] },
            'mob_kinh_thanh_2': { name: 'Đại Nội Thị Vệ', level: 32, rarity: 2, icon: 'fa-solid fa-user-secret', 
                       stats: { hp: 700, atk: 48, def: 28, spd: 18, lck: 14 }, 
                       skills: [{ name: 'Ám Kích', chance: 20, multiplier: 1.5 }] },
            // [NEW] Enemies for Thục Sơn (60-70)
            'mob_thuc_son_1': { name: 'Thục Sơn Đệ Tử', level: 65, rarity: 3, icon: 'fa-solid fa-user-graduate', 
                       stats: { hp: 7000, atk: 180, def: 120, spd: 30, lck: 25 }, 
                       skills: [{ name: 'Ngự Kiếm Thuật', chance: 25, multiplier: 1.6 }] },
            'mob_thuc_son_2': { name: 'Thục Sơn Hộ Pháp', level: 70, rarity: 3, icon: 'fa-solid fa-hat-wizard', 
                       stats: { hp: 8500, atk: 220, def: 140, spd: 32, lck: 28 }, 
                       skills: [{ name: 'Lôi Kiếm', chance: 30, multiplier: 1.8 }] },
            // [NEW] Enemies for Ngọc Hư Thành (90-100)
            'mob_ngoc_hu_1': { name: 'Ngọc Hư Cung Đệ Tử', level: 95, rarity: 4, icon: 'fa-solid fa-user-ninja', 
                       stats: { hp: 10000, atk: 280, def: 180, spd: 28, lck: 30 }, 
                       skills: [{ name: 'Phi Kiếm', chance: 20, multiplier: 1.5 }] },
            'mob_ngoc_hu_2': { name: 'Ngọc Hư Cung Hộ Pháp', level: 100, rarity: 4, icon: 'fa-solid fa-user-shield', 
                       stats: { hp: 11500, atk: 300, def: 200, spd: 30, lck: 32 }, 
                       skills: [{ name: 'Kim Quang Chú', chance: 25, multiplier: 1.7 }] },
            // [NEW] Enemies for Hư Thiên Điện (120-130)
            'mob_hu_thien_1': { name: 'Hư Thiên Vệ Sĩ', level: 125, rarity: 4, icon: 'fa-solid fa-ghost', 
                       stats: { hp: 20000, atk: 400, def: 280, spd: 38, lck: 38 }, 
                       skills: [{ name: 'Hư Không Trảm', chance: 30, multiplier: 1.8 }] },
            'mob_hu_thien_2': { name: 'Hư Thiên Tướng', level: 130, rarity: 4, icon: 'fa-solid fa-skull-crossbones', 
                       stats: { hp: 25000, atk: 450, def: 320, spd: 40, lck: 40 }, 
                       skills: [{ name: 'Diệt Hồn Kích', chance: 35, multiplier: 2.0 }] },
            // [NEW] Enemies for Đại Lý (35-45)
            'mob_dai_ly_1': { name: 'Đoàn Thị Binh Sĩ', level: 37, rarity: 2, icon: 'fa-solid fa-user-shield', 
                       stats: { hp: 900, atk: 55, def: 35, spd: 20, lck: 15 }, 
                       skills: [{ name: 'Nhất Dương Chỉ', chance: 20, multiplier: 1.6 }] },
            'mob_dai_ly_2': { name: 'Thiên Long Tự Tăng', level: 42, rarity: 3, icon: 'fa-solid fa-gopuram', 
                       stats: { hp: 1200, atk: 65, def: 40, spd: 22, lck: 18 }, 
                       skills: [{ name: 'Thiên Long Kiếm', chance: 25, multiplier: 1.7 }] },
            // [NEW] Enemies for Thập Nhị Cung (70-80)
            'mob_tnc_1': { name: 'Cung Song Tử Vệ', level: 75, rarity: 3, icon: 'fa-solid fa-users', 
                       stats: { hp: 9000, atk: 240, def: 150, spd: 35, lck: 30 }, 
                       skills: [{ name: 'Song Trảm', chance: 25, multiplier: 1.7, hits: 2 }] },
            'mob_tnc_2': { name: 'Cung Cự Giải Vệ', level: 78, rarity: 3, icon: 'fa-solid fa-shield-halved', 
                       stats: { hp: 10000, atk: 230, def: 180, spd: 30, lck: 28 }, 
                       skills: [{ name: 'Cự Kích', chance: 30, multiplier: 2.0 }] },
            // [NEW] Enemies for Lục Đạo Luân Hồi (100-110)
            'mob_ldlh_1': { name: 'Tu La Đạo Binh', level: 105, rarity: 4, icon: 'fa-solid fa-person-military-pointing', 
                       stats: { hp: 13000, atk: 320, def: 220, spd: 32, lck: 35 }, 
                       skills: [{ name: 'Tu La Trảm', chance: 25, multiplier: 1.8 }] },
            'mob_ldlh_2': { name: 'Địa Ngục Ác Quỷ', level: 108, rarity: 4, icon: 'fa-solid fa-ghost', 
                       stats: { hp: 14500, atk: 340, def: 200, spd: 38, lck: 32 }, 
                       skills: [{ name: 'Oán Niệm', chance: 30, multiplier: 2.0 }] },
            // [NEW] Enemies for Quần Long Tranh Bá (130-140)
            'mob_qltb_1': { name: 'Thiên Long Vệ', level: 135, rarity: 4, icon: 'fa-solid fa-dragon', 
                       stats: { hp: 28000, atk: 480, def: 340, spd: 42, lck: 42 }, 
                       skills: [{ name: 'Long Hống', chance: 30, multiplier: 1.9 }] },
            'mob_qltb_2': { name: 'Thái Cổ Long Hồn', level: 138, rarity: 5, icon: 'fa-solid fa-dragon', 
                       stats: { hp: 32000, atk: 520, def: 300, spd: 45, lck: 45 }, 
                       skills: [{ name: 'Long Hồn Kích', chance: 35, multiplier: 2.2 }] },
            // [NEW] Enemies for Thái Cổ Hồng Hoang (140-150)
            'mob_tchh_1': { name: 'Hồng Hoang Dị Thú', level: 145, rarity: 5, icon: 'fa-solid fa-hippo', 
                       stats: { hp: 38000, atk: 580, def: 350, spd: 48, lck: 48 }, 
                       skills: [{ name: 'Hoang Dã Hống', chance: 30, multiplier: 2.0 }] },
            'mob_tchh_2': { name: 'Thái Cổ Tinh Linh', level: 148, rarity: 5, icon: 'fa-solid fa-star-of-life', 
                       stats: { hp: 35000, atk: 620, def: 320, spd: 55, lck: 50 }, 
                       skills: [{ name: 'Thái Cổ Chú', chance: 35, multiplier: 2.3 }] },
            // [NEW] Enemies for Tam Thanh Diệt Thế (150-160)
            'mob_ttdt_1': { name: 'Thượng Thanh Đệ Tử', level: 155, rarity: 5, icon: 'fa-solid fa-user-graduate', 
                       stats: { hp: 42000, atk: 650, def: 380, spd: 52, lck: 52 }, 
                       skills: [{ name: 'Thanh Liên Kiếm', chance: 30, multiplier: 2.1 }] },
            'mob_ttdt_2': { name: 'Ngọc Thanh Hộ Pháp', level: 158, rarity: 6, icon: 'fa-solid fa-user-shield', 
                       stats: { hp: 48000, atk: 680, def: 400, spd: 50, lck: 55 }, 
                       skills: [{ name: 'Ngọc Hư Chưởng', chance: 35, multiplier: 2.4 }] },
            // [NEW] Enemies for Phong Thần Đại Chiến (160-170)
            'mob_ptdc_1': { name: 'Phong Thần Tướng', level: 165, rarity: 6, icon: 'fa-solid fa-user-helmet-safety', 
                       stats: { hp: 55000, atk: 720, def: 420, spd: 58, lck: 58 }, 
                       skills: [{ name: 'Phong Thần Trảm', chance: 30, multiplier: 2.2 }] },
            'mob_ptdc_2': { name: 'Xiển Giáo Tiên Nhân', level: 168, rarity: 6, icon: 'fa-solid fa-hat-wizard', 
                       stats: { hp: 50000, atk: 780, def: 400, spd: 62, lck: 60 }, 
                       skills: [{ name: 'Tiên Pháp', chance: 35, multiplier: 2.5 }] },
            // [NEW] Enemies for Viễn Cổ Tranh Phong (170-180)
            'mob_vctp_1': { name: 'Viễn Cổ Chiến Binh', level: 175, rarity: 6, icon: 'fa-solid fa-user-shield', 
                       stats: { hp: 65000, atk: 820, def: 480, spd: 60, lck: 62 }, 
                       skills: [{ name: 'Cổ Lão Kích', chance: 30, multiplier: 2.3 }] },
            'mob_vctp_2': { name: 'Ma Thần Viễn Cổ', level: 178, rarity: 7, icon: 'fa-solid fa-ghost', 
                       stats: { hp: 60000, atk: 880, def: 450, spd: 65, lck: 65 }, 
                       skills: [{ name: 'Ma Thần Phệ', chance: 35, multiplier: 2.6 }] },
            // [NEW] Enemies for Thống Nhất Tam Giới (180-190)
            'mob_tntg_1': { name: 'Thiên Binh', level: 185, rarity: 7, icon: 'fa-solid fa-user-astronaut', 
                       stats: { hp: 75000, atk: 930, def: 520, spd: 68, lck: 68 }, 
                       skills: [{ name: 'Thiên Phạt', chance: 30, multiplier: 2.4 }] },
            'mob_tntg_2': { name: 'Thiên Tướng', level: 188, rarity: 7, icon: 'fa-solid fa-user-crown', 
                       stats: { hp: 82000, atk: 980, def: 550, spd: 65, lck: 70 }, 
                       skills: [{ name: 'Thiên Lôi', chance: 35, multiplier: 2.7 }] },
            // [NEW] Enemies for Tinh Không Đại Vực (190-200)
            'mob_tkdv_1': { name: 'Tinh Không Thú', level: 195, rarity: 8, icon: 'fa-solid fa-meteor', 
                       stats: { hp: 90000, atk: 1050, def: 580, spd: 72, lck: 72 }, 
                       skills: [{ name: 'Tinh Hà Trảo', chance: 30, multiplier: 2.5 }] },
            'mob_tkdv_2': { name: 'Vực Ngoại Thiên Ma', level: 198, rarity: 8, icon: 'fa-solid fa-alien-8bit', 
                       stats: { hp: 85000, atk: 1150, def: 550, spd: 78, lck: 75 }, 
                       skills: [{ name: 'Ma Âm', chance: 35, multiplier: 2.8 }] },
            // Cấp 10-20: Tương Dương
            'mob03': { name: 'Lãng Khách', level: 12, rarity: 1, icon: 'fa-solid fa-user-secret', 
                       stats: { hp: 200, atk: 15, def: 10, spd: 10, lck: 8 }, 
                       skills: [{ name: 'Kiếm Khí', chance: 0, multiplier: 1 }] },
            'mob04': { name: 'Hắc Y Nhân', level: 18, rarity: 2, icon: 'fa-solid fa-user-secret', 
                       stats: { hp: 300, atk: 22, def: 15, spd: 12, lck: 10 }, 
                       skills: [{ name: 'Ám Sát', chance: 20, multiplier: 1.5 }, { name: 'Chém Nhanh', chance: 0, multiplier: 1.1 }] },
            'boss01': { name: 'Thống Lĩnh Sơn Tặc', level: 20, rarity: 3, icon: 'fa-solid fa-skull-crossbones', 
                        stats: { hp: 1000, atk: 30, def: 20, spd: 10, lck: 15 }, 
                        skills: [{ name: 'Cuồng Phong Trảm', chance: 30, multiplier: 1.8 }, { name: 'Chém Nát', chance: 0, multiplier: 1.2 }] },
            // Cấp 20-30: Phục Ngưu Sơn
            'mob05': { name: 'Mã Tặc', level: 25, rarity: 1, icon: 'fa-solid fa-horse-head', 
                       stats: { hp: 450, atk: 35, def: 20, spd: 15, lck: 10 }, 
                       skills: [{ name: 'Mã Tặc Đao', chance: 0, multiplier: 1 }] },
            'mob06': { name: 'Đại Hán', level: 28, rarity: 2, icon: 'fa-solid fa-user-large', 
                       stats: { hp: 600, atk: 40, def: 25, spd: 12, lck: 10 }, 
                       skills: [{ name: 'Búa Tạ', chance: 15, multiplier: 1.6 }, { name: 'Đập', chance: 0, multiplier: 1.1 }] },
            // [NEW] Cấp 30-40: Thanh Thành Sơn
            'mob07': { name: 'Giang Hồ Hảo Hán', level: 35, rarity: 1, icon: 'fa-solid fa-user-shield', 
                       stats: { hp: 800, atk: 55, def: 30, spd: 20, lck: 15 }, 
                       skills: [{ name: 'Chém', chance: 0, multiplier: 1 }] },
            'mob08': { name: 'Đạo Tặc Tinh Anh', level: 38, rarity: 2, icon: 'fa-solid fa-user-ninja', 
                       stats: { hp: 1000, atk: 65, def: 35, spd: 22, lck: 15 }, 
                       skills: [{ name: 'Đâm Lén', chance: 20, multiplier: 1.5 }, { name: 'Chém', chance: 0, multiplier: 1.1 }] },
            'boss02': { name: 'Thanh Thành Lão Quái', level: 40, rarity: 3, icon: 'fa-solid fa-skull-crossbones', 
                        stats: { hp: 2500, atk: 80, def: 40, spd: 20, lck: 20 }, 
                        skills: [{ name: 'Cuồng Phong Kiếm', chance: 30, multiplier: 2.0 }, { name: 'Chém Nát', chance: 0, multiplier: 1.2 }] },
            // [NEW] Cấp 40-50: Võ Đang Sơn
            'mob09': { name: 'Võ Đang Đệ Tử', level: 45, rarity: 1, icon: 'fa-solid fa-user-graduate', 
                       stats: { hp: 1300, atk: 80, def: 50, spd: 25, lck: 20 }, 
                       skills: [{ name: 'Kiếm Pháp', chance: 0, multiplier: 1 }] },
            'mob10': { name: 'Võ Đang Trưởng Lão', level: 48, rarity: 2, icon: 'fa-solid fa-user-tie', 
                       stats: { hp: 1600, atk: 95, def: 60, spd: 28, lck: 20 }, 
                       skills: [{ name: 'Thái Cực Kiếm', chance: 25, multiplier: 1.6 }, { name: 'Chém', chance: 0, multiplier: 1.1 }] },
            'boss03': { name: 'Võ Đang Chưởng Môn', level: 50, rarity: 3, icon: 'fa-solid fa-hat-wizard', 
                        stats: { hp: 4000, atk: 120, def: 60, spd: 30, lck: 25 }, 
                        skills: [{ name: 'Chân Võ Kiếm Trận', chance: 35, multiplier: 2.2 }, { name: 'Kiếm Tâm', chance: 0, multiplier: 1.3 }] },
            // [NEW] Cấp 50-60: Cán Viên Động
            'mob11': { name: 'Thạch Nhân', level: 55, rarity: 1, icon: 'fa-solid fa-gem', 
                       stats: { hp: 2000, atk: 100, def: 80, spd: 20, lck: 10 }, 
                       skills: [{ name: 'Ném Đá', chance: 0, multiplier: 1 }] },
            'mob12': { name: 'Thạch Quái Tinh Anh', level: 58, rarity: 2, icon: 'fa-solid fa-mountain', 
                       stats: { hp: 2500, atk: 115, def: 95, spd: 18, lck: 15 }, 
                       skills: [{ name: 'Địa Chấn', chance: 20, multiplier: 1.4 }, { name: 'Đập Mạnh', chance: 0, multiplier: 1.1 }] },
            'boss04': { name: 'Thạch Vương', level: 60, rarity: 3, icon: 'fa-solid fa-chess-rook', 
                        stats: { hp: 6000, atk: 150, def: 100, spd: 15, lck: 20 }, 
                        skills: [{ name: 'Thạch Phá Thiên Kinh', chance: 30, multiplier: 2.0 }, { name: 'Nghiền Nát', chance: 0, multiplier: 1.2 }] },
            // [NEW] Boss for Hoa Son Luan Kiem
            'boss05': { name: 'Độc Cô Cầu Bại', level: 150, rarity: 5, icon: 'fa-solid fa-user-ninja', // [MODIFIED]
                        stats: { hp: 50000, atk: 700, def: 400, spd: 50, lck: 40 }, // [MODIFIED]
                        skills: [{ name: 'Độc Cô Cửu Kiếm', chance: 50, multiplier: 3.0, ignoreDef: 0.3 }, { name: 'Phá Kiếm Thức', chance: 0, multiplier: 1.5 }] },
            // [NEW] Cấp 100-120: Kiếm Các
            'mob13': { name: 'Lính Gác Tinh Anh', level: 105, rarity: 1, icon: 'fa-solid fa-user-shield', // (No change)
                       stats: { hp: 12000, atk: 300, def: 200, spd: 30, lck: 30 }, // [MODIFIED]
                       skills: [{ name: 'Chém Nhanh', chance: 0, multiplier: 1 }] },
            'mob14': { name: 'Phó Tướng', level: 115, rarity: 2, icon: 'fa-solid fa-user-tie', // [MODIFIED]
                       stats: { hp: 18000, atk: 350, def: 250, spd: 35, lck: 35 }, // [MODIFIED]
                       skills: [{ name: 'Song Đao', chance: 20, multiplier: 1.6 }, { name: 'Chém', chance: 0, multiplier: 1.1 }] },
            // [NEW] Cấp 130-150: Đỉnh Hoa Sơn
            'mob15': { name: 'Cao Thủ Giấu Mặt', level: 150, rarity: 1, icon: 'fa-solid fa-user-ninja', // [MODIFIED]
                       stats: { hp: 40000, atk: 600, def: 380, spd: 42, lck: 40 }, // [MODIFIED]
                       skills: [{ name: 'Kiếm Khí', chance: 0, multiplier: 1 }] },
            'mob16': { name: 'Trưởng Lão Ẩn Cư', level: 155, rarity: 2, icon: 'fa-solid fa-hat-wizard', // [MODIFIED]
                       stats: { hp: 45000, atk: 650, def: 420, spd: 48, lck: 45 }, // [MODIFIED]
                       skills: [{ name: 'Nội Lực Bộc Phát', chance: 25, multiplier: 1.8 }, { name: 'Chưởng', chance: 0, multiplier: 1.2 }] },
            // [NEW] Super Rare Boss (0.01% chance on any map)
            'boss_rare_01': { 
                name: 'Kẻ Lãng Du Vô Danh', 
                level: 180, 
                rarity: 5, 
                icon: 'fa-solid fa-ghost', 
                stats: { hp: 150000, atk: 1200, def: 700, spd: 60, lck: 50 }, 
                skills: [
                    { name: 'Hủy Diệt', chance: 40, multiplier: 4.0, ignoreDef: 0.5 }, 
                    { name: 'Vô Ảnh Cước', chance: 0, multiplier: 1.5 }
                ]
            },
            // [NEW] Level 200+ Bosses for Vô Tận Mộng Cảnh
            'boss_sg_01': { 
                name: 'Ác Mộng Chi Chủ', level: 200, rarity: 10, icon: 'fa-solid fa-ghost', 
                stats: { hp: 500000, atk: 2500, def: 1200, spd: 70, lck: 50 }, 
                skills: [ { name: 'Tuyệt Vọng Hắc Ám', chance: 50, multiplier: 3.5, hits: 2, ignoreDef: 0.4 }, { name: 'Thôn Phệ Linh Hồn', chance: 0, multiplier: 1.8 } ]
            },
            'boss_sg_02': { 
                name: 'Huyễn Ảnh Ma Tôn', level: 205, rarity: 10, icon: 'fa-solid fa-eye', 
                stats: { hp: 450000, atk: 2800, def: 1000, spd: 80, lck: 60 }, 
                skills: [ { name: 'Vạn Ảnh Tề Phát', chance: 40, multiplier: 1.0, hits: 5, ignoreDef: 0.2 }, { name: 'Ảo Ảnh Kích', chance: 0, multiplier: 1.6 } ]
            },
            'boss_sg_03': { 
                name: 'Thần Lôi Cự Nhân', level: 210, rarity: 10, icon: 'fa-solid fa-bolt', 
                stats: { hp: 600000, atk: 2200, def: 1500, spd: 60, lck: 40 }, 
                skills: [ { name: 'Lôi Đình Vạn Quân', chance: 35, multiplier: 4.5, ignoreDef: 0.3 }, { name: 'Chùy Sét', chance: 0, multiplier: 1.5 } ]
            },
            'boss_sg_04': { 
                name: 'Băng Sương Cổ Long', level: 215, rarity: 10, icon: 'fa-solid fa-snowflake', 
                stats: { hp: 550000, atk: 2600, def: 1300, spd: 65, lck: 55 }, 
                skills: [ { name: 'Bão Tuyết Diệt Thế', chance: 45, multiplier: 3.8, ignoreDef: 0.35 }, { name: 'Hơi Thở Băng Giá', chance: 0, multiplier: 1.7 } ]
            },
            'boss_sg_05': { 
                name: 'Vô Tận Chi Chủ', level: 220, rarity: 10, icon: 'fa-solid fa-infinity', 
                stats: { hp: 700000, atk: 3000, def: 1400, spd: 75, lck: 65 }, 
                skills: [ { name: 'Hủy Diệt Luân Hồi', chance: 60, multiplier: 5.0, ignoreDef: 0.5 }, { name: 'Thời Không Trảm', chance: 0, multiplier: 2.0 } ]
            },
            // [NEW] Level 250+ Monsters for Phong Lăng Độ
            'mob_phonglang_1': { 
                name: 'Thủy Tặc', level: 250, rarity: 8, icon: 'fa-solid fa-water', 
                stats: { hp: 200000, atk: 2800, def: 1200, spd: 80, lck: 75 }, 
                skills: [{ name: 'Chém Nhanh', chance: 0, multiplier: 1.5 }] 
            },
            'mob_phonglang_2': { 
                name: 'Thủy Tặc Tinh Anh', level: 255, rarity: 9, icon: 'fa-solid fa-anchor', 
                stats: { hp: 250000, atk: 3200, def: 1400, spd: 85, lck: 80 }, 
                skills: [{ name: 'Xoáy Nước Trảm', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'boss_phonglang_1': { 
                name: 'Thủy Tặc Đầu Lĩnh', level: 260, rarity: 10, icon: 'fa-solid fa-skull-crossbones', 
                stats: { hp: 700000, atk: 4000, def: 1800, spd: 70, lck: 85 }, 
                skills: [ { name: 'Cuồng Phong Đao', chance: 50, multiplier: 3.0, ignoreDef: 0.2 }, { name: 'Phá Giáp', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 300+ Monsters for Vuot Ai
            'mob_vuot_ai_1': { 
                name: 'Nhiếp Nhí Vệ Sĩ', level: 300, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 500000, atk: 5000, def: 2200, spd: 90, lck: 80 }, 
                skills: [{ name: 'Chém Nhanh', chance: 0, multiplier: 1.5 }] 
            },
            'mob_vuot_ai_2': { 
                name: 'Nhiếp Nhí Tinh Anh', level: 305, rarity: 9, icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 600000, atk: 5500, def: 2400, spd: 95, lck: 85 }, 
                skills: [{ name: 'Tinh Anh Trảm', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'boss_vuot_ai_1': { 
                name: 'Nhiếp Nhí Trần', level: 310, rarity: 10, icon: 'fa-solid fa-ghost', 
                stats: { hp: 1500000, atk: 6500, def: 3000, spd: 80, lck: 90 }, 
                skills: [ { name: 'Vượt Ải Trảm', chance: 50, multiplier: 3.5, ignoreDef: 0.3 }, { name: 'Phá Giáp', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 350+ Monsters for Luc Dao Luan Hoi (Cao Cap)
            'mob_ldlh2_1': { 
                name: 'Thiên Đạo', level: 350, rarity: 9, icon: 'fa-solid fa-cloud-sun', 
                stats: { hp: 2000000, atk: 7000, def: 3500, spd: 100, lck: 90 }, 
                skills: [{ name: 'Thiên Phạt', chance: 0, multiplier: 1.5 }] 
            },
            'mob_ldlh2_2': { 
                name: 'A Tu La Đạo', level: 355, rarity: 9, icon: 'fa-solid fa-user-secret', 
                stats: { hp: 1800000, atk: 7500, def: 3200, spd: 110, lck: 95 }, 
                skills: [{ name: 'Tu La Trảm', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_ldlh2_3': { 
                name: 'Nhân Đạo', level: 360, rarity: 9, icon: 'fa-solid fa-person', 
                stats: { hp: 2500000, atk: 7200, def: 3800, spd: 90, lck: 90 }, 
                skills: [{ name: 'Nhân Kiếm', chance: 0, multiplier: 1.5 }] 
            },
            'mob_ldlh2_4': { 
                name: 'Súc Sinh Đạo', level: 365, rarity: 9, icon: 'fa-solid fa-paw', 
                stats: { hp: 3000000, atk: 6800, def: 4000, spd: 80, lck: 85 }, 
                skills: [{ name: 'Dã Thú Vồ', chance: 30, multiplier: 2.0 }, { name: 'Cắn', chance: 0, multiplier: 1.2 }] 
            },
            'mob_ldlh2_5': { 
                name: 'Ngạ Quỷ Đạo', level: 370, rarity: 9, icon: 'fa-solid fa-ghost', 
                stats: { hp: 2200000, atk: 8000, def: 3500, spd: 120, lck: 100 }, 
                skills: [{ name: 'Hút Hồn', chance: 30, multiplier: 2.2 }, { name: 'Cào', chance: 0, multiplier: 1.1 }] 
            },
            'boss_ldlh2_1': { 
                name: 'Địa Ngục Đạo', level: 380, rarity: 10, icon: 'fa-solid fa_skull', 
                stats: { hp: 5000000, atk: 10000, def: 5000, spd: 90, lck: 100 }, 
                skills: [ { name: 'Địa Ngục Phán Quyết', chance: 50, multiplier: 4.0, ignoreDef: 0.4 }, { name: 'Sa Đọa', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 400+ Monsters for Thap Nhi Cung (Cao Cap)
            'mob_12cg_ti': { 
                name: 'Thần Thú - Tí (Chuột)', level: 400, rarity: 9, icon: 'fa-solid fa-rat', 
                stats: { hp: 3000000, atk: 9000, def: 4500, spd: 150, lck: 110 }, 
                skills: [{ name: 'Vô Ảnh Cước', chance: 0, multiplier: 1.5 }] 
            },
            'mob_12cg_suu': { 
                name: 'Thần Thú - Sửu (Trâu)', level: 405, rarity: 9, icon: 'fa-solid fa-cow', 
                stats: { hp: 4000000, atk: 8500, def: 5500, spd: 100, lck: 100 }, 
                skills: [{ name: 'Húc', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_12cg_dan': { 
                name: 'Thần Thú - Dần (Hổ)', level: 410, rarity: 9, icon: 'fa-solid fa-tiger', 
                stats: { hp: 3500000, atk: 9500, def: 4800, spd: 130, lck: 110 }, 
                skills: [{ name: 'Vồ', chance: 30, multiplier: 2.2 }, { name: 'Cào', chance: 0, multiplier: 1.1 }] 
            },
            // [NEW] Bổ sung Thần Thú - Mão
            'mob_12cg_mao': { 
                name: 'Thần Thú - Mão (Mèo)', level: 412, rarity: 9, icon: 'fa-solid fa-cat', 
                stats: { hp: 2800000, atk: 8800, def: 4200, spd: 170, lck: 140 }, 
                skills: [{ name: 'Cào Nhanh', chance: 35, multiplier: 1.8 }, { name: 'Vồ', chance: 0, multiplier: 1.1 }] 
            },
            // [NEW] Bổ sung Thần Thú - Tỵ
            'mob_12cg_ty': { 
                name: 'Thần Thú - Tỵ (Rắn)', level: 414, rarity: 9, icon: 'fa-solid fa-staff-snake', 
                stats: { hp: 3100000, atk: 9600, def: 4400, spd: 145, lck: 110 }, 
                skills: [{ name: 'Độc Nha', chance: 30, multiplier: 2.0 }, { name: 'Siết', chance: 0, multiplier: 1.2 }] 
            },
            'mob_12cg_ngo': { 
                name: 'Thần Thú - Ngọ (Ngựa)', level: 415, rarity: 9, icon: 'fa-solid fa-horse', 
                stats: { hp: 3200000, atk: 9200, def: 4600, spd: 160, lck: 120 }, 
                skills: [{ name: 'Đá Hậu', chance: 30, multiplier: 2.1 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            // [NEW] Bổ sung Thần Thú - Mùi
            'mob_12cg_mui': { 
                name: 'Thần Thú - Mùi (Dê)', level: 418, rarity: 9, icon: 'fa-solid fa-cloud-meatball', 
                stats: { hp: 3600000, atk: 8700, def: 5000, spd: 110, lck: 130 }, 
                skills: [{ name: 'Húc Sừng', chance: 25, multiplier: 1.9 }, { name: 'Đá', chance: 0, multiplier: 1.1 }] 
            },
            'mob_12cg_than': { 
                name: 'Thần Thú - Thân (Khỉ)', level: 420, rarity: 9, icon: 'fa-solid fa-monkey', 
                stats: { hp: 3300000, atk: 9800, def: 4700, spd: 140, lck: 130 }, 
                skills: [{ name: 'Gậy Như Ý', chance: 30, multiplier: 2.3 }, { name: 'Đấm', chance: 0, multiplier: 1.1 }] 
            },
            // [NEW] Bổ sung Thần Thú - Dậu
            'mob_12cg_dau': { 
                name: 'Thần Thú - Dậu (Gà)', level: 422, rarity: 9, icon: 'fa-solid fa-feather-pointed', 
                stats: { hp: 2900000, atk: 10000, def: 4000, spd: 155, lck: 120 }, 
                skills: [{ name: 'Mổ', chance: 40, multiplier: 2.1 }, { name: 'Vỗ Cánh', chance: 0, multiplier: 1.1 }] 
            },
            // [NEW] Bổ sung Thần Thú - Tuất
            'mob_12cg_tuat': { 
                name: 'Thần Thú - Tuất (Chó)', level: 425, rarity: 9, icon: 'fa-solid fa-dog', 
                stats: { hp: 3400000, atk: 9300, def: 4800, spd: 135, lck: 125 }, 
                skills: [{ name: 'Cắn Xé', chance: 30, multiplier: 2.0 }, { name: 'Sủa', chance: 0, multiplier: 1.0 }] 
            },
            // [NEW] Bổ sung Thần Thú - Hợi
            'mob_12cg_hoi': { 
                name: 'Thần Thú - Hợi (Heo)', level: 428, rarity: 9, icon: 'fa-solid fa-piggy-bank', 
                stats: { hp: 4500000, atk: 8000, def: 6000, spd: 90, lck: 150 }, 
                skills: [{ name: 'Đè Bẹp', chance: 25, multiplier: 2.2 }, { name: 'Húc', chance: 0, multiplier: 1.2 }] 
            },
            'boss_12cg_thin': { 
                name: 'Thần Thú - Thìn (Rồng)', level: 430, rarity: 10, icon: 'fa-solid fa-dragon', 
                stats: { hp: 8000000, atk: 12000, def: 6000, spd: 120, lck: 150 }, 
                skills: [ { name: 'Long Thần Phẫn Nộ', chance: 50, multiplier: 4.5, ignoreDef: 0.5 }, { name: 'Long Hống', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 500+ Monsters for Dinh Phong Doi Quyet
            'mob_dpdq_1': { 
                name: 'Cổ Kiếm Hồn', level: 500, rarity: 9, icon: 'fa-solid fa-khanda', 
                stats: { hp: 10000000, atk: 15000, def: 8000, spd: 130, lck: 120 }, 
                skills: [{ name: 'Kiếm Hồn Trảm', chance: 0, multiplier: 1.5 }] 
            },
            'mob_dpdq_2': { 
                name: 'Thiên Ma Ảnh', level: 510, rarity: 9, icon: 'fa-solid fa-ghost', 
                stats: { hp: 9000000, atk: 17000, def: 7000, spd: 160, lck: 130 }, 
                skills: [{ name: 'Ma Ảnh Tấn', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_dpdq_3': { 
                name: 'Bất Diệt Chiến Tướng', level: 520, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 15000000, atk: 14000, def: 10000, spd: 110, lck: 110 }, 
                skills: [{ name: 'Bất Diệt Kích', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_dpdq_4': { 
                name: 'Thánh Tâm Tôn Giả', level: 530, rarity: 9, icon: 'fa-solid fa-star-of-life', 
                stats: { hp: 12000000, atk: 16000, def: 9000, spd: 140, lck: 125 }, 
                skills: [{ name: 'Thánh Tâm Chưởng', chance: 30, multiplier: 2.2 }, { name: 'Đẩy', chance: 0, multiplier: 1.1 }] 
            },
            'mob_dpdq_5': { 
                name: 'Hư Không Hành Giả', level: 540, rarity: 9, icon: 'fa-solid fa-meteor', 
                stats: { hp: 11000000, atk: 18000, def: 8500, spd: 170, lck: 140 }, 
                skills: [{ name: 'Hư Không Bộ', chance: 30, multiplier: 2.3 }, { name: 'Đấm', chance: 0, multiplier: 1.1 }] 
            },
            'boss_dpdq_1': { 
                name: 'Đỉnh Phong Võ Đế', level: 550, rarity: 10, icon: 'fa-solid fa-crown', 
                stats: { hp: 30000000, atk: 22000, def: 12000, spd: 150, lck: 200 }, 
                skills: [ { name: 'Võ Đế Phán Quyết', chance: 50, multiplier: 5.0, ignoreDef: 0.6 }, { name: 'Chưởng', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 650+ Monsters for Vo Lam Minh Chu
            'mob_vlmc_1': { 
                name: 'Huyền Không Đại Sư', level: 650, rarity: 9, icon: 'fa-solid fa-gopuram', 
                stats: { hp: 50000000, atk: 30000, def: 15000, spd: 140, lck: 150 }, 
                skills: [{ name: 'Thiếu Lâm Tuyệt Kỹ', chance: 0, multiplier: 1.5 }] 
            },
            'mob_vlmc_2': { 
                name: 'Trương Tam Phong', level: 655, rarity: 9, icon: 'fa-solid fa-yin-yang', 
                stats: { hp: 45000000, atk: 32000, def: 18000, spd: 130, lck: 160 }, 
                skills: [{ name: 'Thái Cực Kiếm', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_vlmc_3': { 
                name: 'Diệt Tuyệt Sư Thái', level: 660, rarity: 9, icon: 'fa-solid fa-star-of-life', // Placeholder
                stats: { hp: 48000000, atk: 35000, def: 14000, spd: 150, lck: 150 }, 
                skills: [{ name: 'Nga Mi Kiếm Pháp', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_vlmc_4': { 
                name: 'Hồng Thất Công', level: 665, rarity: 9, icon: 'fa-solid fa-person-walking-with-cane', 
                stats: { hp: 55000000, atk: 33000, def: 16000, spd: 140, lck: 170 }, 
                skills: [{ name: 'Hàng Long Chưởng', chance: 30, multiplier: 2.2 }, { name: 'Đẩy', chance: 0, multiplier: 1.1 }] 
            },
            'mob_vlmc_5': { 
                name: 'Trương Vô Kỵ', level: 670, rarity: 9, icon: 'fa-solid fa-sun', 
                stats: { hp: 60000000, atk: 31000, def: 20000, spd: 130, lck: 180 }, 
                skills: [{ name: 'Càn Khôn Đại Na Di', chance: 30, multiplier: 2.3 }, { name: 'Đấm', chance: 0, multiplier: 1.1 }] 
            },
            'boss_vlmc_1': { 
                name: 'Võ Lâm Minh Chủ', level: 680, rarity: 10, icon: 'fa-solid fa-user-tie', // Placeholder
                stats: { hp: 100000000, atk: 40000, def: 25000, spd: 160, lck: 250 }, 
                skills: [ { name: 'Thiên Hạ Vô Địch', chance: 50, multiplier: 6.0, ignoreDef: 0.7 }, { name: 'Kiếm Khí', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 750+ Monsters for Me Cung Tan Lang
            'mob_tanlang_1': { 
                name: 'Binh Sĩ Đất Nung', level: 750, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 120000000, atk: 50000, def: 35000, spd: 150, lck: 180 }, 
                skills: [{ name: 'Trường Mâu', chance: 0, multiplier: 1.5 }] 
            },
            'mob_tanlang_2': { 
                name: 'Oan Hồn Lăng Mộ', level: 755, rarity: 9, icon: 'fa-solid fa-ghost', 
                stats: { hp: 110000000, atk: 60000, def: 30000, spd: 180, lck: 200 }, 
                skills: [{ name: 'Oán Niệm', chance: 30, multiplier: 2.0 }, { name: 'Cào', chance: 0, multiplier: 1.2 }] 
            },
            'mob_tanlang_3': { 
                name: 'Cơ Quan Thú', level: 760, rarity: 9, icon: 'fa-solid fa-robot', 
                stats: { hp: 160000000, atk: 52000, def: 45000, spd: 130, lck: 170 }, 
                skills: [{ name: 'Càn Quét', chance: 30, multiplier: 2.0 }, { name: 'Đập', chance: 0, multiplier: 1.2 }] 
            },
            'mob_tanlang_4': { 
                name: 'Thủ Lăng Vệ Sĩ', level: 765, rarity: 9, icon: 'fa-solid fa-khanda', 
                stats: { hp: 130000000, atk: 58000, def: 40000, spd: 160, lck: 190 }, 
                skills: [{ name: 'Trảm', chance: 30, multiplier: 2.2 }, { name: 'Chém', chance: 0, multiplier: 1.1 }] 
            },
            'mob_tanlang_5': { 
                name: 'Tướng Quân Đất Nung', level: 770, rarity: 9, icon: 'fa-solid fa-user-tie', 
                stats: { hp: 140000000, atk: 55000, def: 38000, spd: 140, lck: 190 }, 
                skills: [{ name: 'Chỉ Huy', chance: 30, multiplier: 2.3 }, { name: 'Đấm', chance: 0, multiplier: 1.1 }] 
            },
            'boss_tanlang_1': { 
                name: 'Tần Thủy Hoàng (Oan Hồn)', level: 780, rarity: 10, icon: 'fa-solid fa-crown', 
                stats: { hp: 250000000, atk: 70000, def: 40000, spd: 170, lck: 300 }, 
                skills: [ { name: 'Thống Nhất Thiên Hạ', chance: 50, multiplier: 6.5, ignoreDef: 0.75 }, { name: 'Phần Thư', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 850+ Monsters for Cuu Thien Than Dien
            'mob_cttd_1': { 
                name: 'Thiên Binh', level: 850, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 200000000, atk: 80000, def: 50000, spd: 160, lck: 200 }, 
                skills: [{ name: 'Thiên Phạt', chance: 0, multiplier: 1.5 }] 
            },
            'mob_cttd_2': { 
                name: 'Thiên Tướng', level: 855, rarity: 9, icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 180000000, atk: 90000, def: 45000, spd: 190, lck: 220 }, 
                skills: [{ name: 'Thiên Tướng Kích', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_cttd_3': { 
                name: 'Kim Giáp Hộ Pháp', level: 860, rarity: 9, icon: 'fa-solid fa-khanda', 
                stats: { hp: 250000000, atk: 85000, def: 60000, spd: 140, lck: 190 }, 
                skills: [{ name: 'Kim Quang Trảm', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_cttd_4': { 
                name: 'Lôi Thần Hóa Thân', level: 865, rarity: 9, icon: 'fa-solid fa-bolt-lightning', 
                stats: { hp: 220000000, atk: 95000, def: 48000, spd: 200, lck: 210 }, 
                skills: [{ name: 'Lôi Kích', chance: 30, multiplier: 2.2 }, { name: 'Đánh', chance: 0, multiplier: 1.1 }] 
            },
            'mob_cttd_5': { 
                name: 'Thánh Thú Kỳ Lân', level: 870, rarity: 9, icon: 'fa-solid fa-dragon', 
                stats: { hp: 300000000, atk: 88000, def: 55000, spd: 150, lck: 250 }, 
                skills: [{ name: 'Thánh Hỏa', chance: 30, multiplier: 2.3 }, { name: 'Húc', chance: 0, multiplier: 1.1 }] 
            },
            'boss_cttd_1': { 
                name: 'Thiên Đế', level: 880, rarity: 10, icon: 'fa-solid fa-crown', 
                stats: { hp: 500000000, atk: 110000, def: 60000, spd: 180, lck: 350 }, 
                skills: [ { name: 'Cửu Thiên Phán Quyết', chance: 50, multiplier: 7.0, ignoreDef: 0.8 }, { name: 'Thiên Lệnh', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 950+ Monsters for U Minh Ma Uyen
            'mob_ummu_1': { 
                name: 'U Minh Tiểu Quỷ', level: 950, rarity: 9, icon: 'fa-solid fa-ghost', 
                stats: { hp: 400000000, atk: 130000, def: 70000, spd: 200, lck: 220 }, 
                skills: [{ name: 'Quỷ Trảo', chance: 0, multiplier: 1.5 }] 
            },
            'mob_ummu_2': { 
                name: 'Ma Uyên Vong Hồn', level: 955, rarity: 9, icon: 'fa-solid fa-poo', 
                stats: { hp: 380000000, atk: 150000, def: 65000, spd: 220, lck: 240 }, 
                skills: [{ name: 'Vong Hồn Kích', chance: 30, multiplier: 2.0 }, { name: 'Cào', chance: 0, multiplier: 1.2 }] 
            },
            'mob_ummu_3': { 
                name: 'Cốt Long', level: 960, rarity: 9, icon: 'fa-solid fa-dragon', 
                stats: { hp: 500000000, atk: 120000, def: 90000, spd: 180, lck: 210 }, 
                skills: [{ name: 'Long Cốt Ba', chance: 30, multiplier: 2.0 }, { name: 'Húc', chance: 0, multiplier: 1.2 }] 
            },
            'mob_ummu_4': { 
                name: 'Địa Ngục Sứ Giả', level: 965, rarity: 9, icon: 'fa-solid fa-user-secret', 
                stats: { hp: 450000000, atk: 160000, def: 75000, spd: 210, lck: 230 }, 
                skills: [{ name: 'Câu Hồn', chance: 30, multiplier: 2.2 }, { name: 'Chém', chance: 0, multiplier: 1.1 }] 
            },
            'mob_ummu_5': { 
                name: 'Ma Tướng', level: 970, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 480000000, atk: 170000, def: 85000, spd: 190, lck: 220 }, 
                skills: [{ name: 'Ma Vương Trảm', chance: 30, multiplier: 2.3 }, { name: 'Đấm', chance: 0, multiplier: 1.1 }] 
            },
            'boss_ummu_1': { 
                name: 'U Minh Ma Chủ', level: 980, rarity: 10, icon: 'fa-solid fa-skull', 
                stats: { hp: 1000000000, atk: 200000, def: 100000, spd: 200, lck: 400 }, 
                skills: [ { name: 'U Minh Phán Quyết', chance: 50, multiplier: 7.5, ignoreDef: 0.85 }, { name: 'Ma Khí', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 1150+ Monsters for Tru Tien Thanh Vuc
            'mob_tttv_1': { 
                name: 'Thánh Vực Hộ Vệ', level: 1150, rarity: 9, icon: 'fa-solid fa-shield-halved', 
                stats: { hp: 800000000, atk: 250000, def: 150000, spd: 220, lck: 250 }, 
                skills: [{ name: 'Thánh Quang', chance: 0, multiplier: 1.5 }] 
            },
            'mob_tttv_2': { 
                name: 'Tru Tiên Kiếm Linh', level: 1155, rarity: 9, icon: 'fa-solid fa-khanda', 
                stats: { hp: 750000000, atk: 280000, def: 130000, spd: 250, lck: 270 }, 
                skills: [{ name: 'Kiếm Linh Trảm', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_tttv_3': { 
                name: 'Thánh Quang Sứ Giả', level: 1160, rarity: 9, icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 1000000000, atk: 260000, def: 180000, spd: 200, lck: 240 }, 
                skills: [{ name: 'Thánh Quang Phán Xét', chance: 30, multiplier: 2.0 }, { name: 'Chưởng', chance: 0, multiplier: 1.2 }] 
            },
            'mob_tttv_4': { 
                name: 'Tiên Giới Thần Tướng', level: 1165, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 900000000, atk: 270000, def: 160000, spd: 230, lck: 260 }, 
                skills: [{ name: 'Thần Tướng Kích', chance: 30, multiplier: 2.2 }, { name: 'Đâm', chance: 0, multiplier: 1.1 }] 
            },
            'mob_tttv_5': { 
                name: 'Cổ Thần Tàn Ảnh', level: 1170, rarity: 9, icon: 'fa-solid fa-ghost', 
                stats: { hp: 850000000, atk: 300000, def: 140000, spd: 260, lck: 280 }, 
                skills: [{ name: 'Tàn Ảnh', chance: 30, multiplier: 2.3 }, { name: 'Vồ', chance: 0, multiplier: 1.1 }] 
            },
            'boss_tttv_1': { 
                name: 'Tru Tiên Kiếm Thánh', level: 1180, rarity: 10, icon: 'fa-solid fa-khanda', 
                stats: { hp: 2000000000, atk: 350000, def: 180000, spd: 240, lck: 450 }, 
                skills: [ { name: 'Tru Tiên Kiếm Trận', chance: 50, multiplier: 8.0, ignoreDef: 0.9 }, { name: 'Kiếm Khí', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 1450+ Monsters for Phi Thang Lo
            'mob_ptl_1': { 
                name: 'Linh Hồn Dẫn Lộ', level: 1450, rarity: 9, icon: 'fa-solid fa-person-praying', 
                stats: { hp: 4000000000, atk: 500000, def: 250000, spd: 250, lck: 300 }, 
                skills: [{ name: 'Linh Hồn Chỉ Dẫn', chance: 0, multiplier: 1.5 }] 
            },
            'mob_ptl_2': { 
                name: 'Tiên Giới Thủ Vệ', level: 1455, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 5000000000, atk: 450000, def: 300000, spd: 230, lck: 280 }, 
                skills: [{ name: 'Thiên Môn Trảm', chance: 30, multiplier: 2.0 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'mob_ptl_3': { 
                name: 'Thánh Quang Tinh Linh', level: 1460, rarity: 9, icon: 'fa-solid fa-star-of-life', 
                stats: { hp: 4500000000, atk: 550000, def: 220000, spd: 280, lck: 320 }, 
                skills: [{ name: 'Thánh Quang Bạo', chance: 30, multiplier: 2.0 }, { name: 'Chiếu', chance: 0, multiplier: 1.2 }] 
            },
            'mob_ptl_4': { 
                name: 'Hộ Pháp Chân Tiên', level: 1465, rarity: 9, icon: 'fa-solid fa-user-graduate', 
                stats: { hp: 4800000000, atk: 520000, def: 280000, spd: 240, lck: 290 }, 
                skills: [{ name: 'Chân Tiên Kiếm', chance: 30, multiplier: 2.2 }, { name: 'Đâm', chance: 0, multiplier: 1.1 }] 
            },
            'mob_ptl_5': { 
                name: 'Thần Tướng Phi Thăng', level: 1470, rarity: 9, icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 4600000000, atk: 580000, def: 260000, spd: 260, lck: 310 }, 
                skills: [{ name: 'Phi Thăng Kích', chance: 30, multiplier: 2.3 }, { name: 'Đấm', chance: 0, multiplier: 1.1 }] 
            },
            'boss_ptl_1': { 
                name: 'Thiên Môn Chi Chủ', level: 1480, rarity: 10, icon: 'fa-solid fa-door-open', 
                stats: { hp: 10000000000, atk: 700000, def: 350000, spd: 250, lck: 500 }, 
                skills: [ { name: 'Thiên Môn Thần Phạt', chance: 50, multiplier: 8.5, ignoreDef: 0.95 }, { name: 'Kiếm Khí', chance: 0, multiplier: 1.5 } ]
            },
            // [NEW] Level 1850+ Monsters for Chung Cuc Thien Khung
            'mob_cctk_1': { 
                name: 'Thiên Tinh', level: 1850, rarity: 9, icon: 'fa-solid fa-star', 
                stats: { hp: 15000000000, atk: 1000000, def: 500000, spd: 280, lck: 350 }, 
                skills: [{ name: 'Tinh Phạt', chance: 0, multiplier: 1.5 }] 
            },
            'mob_cctk_2': { 
                name: 'Hư Không Thú', level: 1855, rarity: 9, icon: 'fa-solid fa-ghost', 
                stats: { hp: 14000000000, atk: 1200000, def: 450000, spd: 320, lck: 380 }, 
                skills: [{ name: 'Hư Không Cắn Nuốt', chance: 30, multiplier: 2.0 }, { name: 'Vồ', chance: 0, multiplier: 1.2 }] 
            },
            'mob_cctk_3': { 
                name: 'Thánh Quang Sứ', level: 1860, rarity: 9, icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 18000000000, atk: 1100000, def: 600000, spd: 260, lck: 340 }, 
                skills: [{ name: 'Thánh Quang Phán Xét', chance: 30, multiplier: 2.0 }, { name: 'Chưởng', chance: 0, multiplier: 1.2 }] 
            },
            'mob_cctk_4': { 
                name: 'Lôi Bằng', level: 1865, rarity: 9, icon: 'fa-solid fa-bolt-lightning', 
                stats: { hp: 16000000000, atk: 1300000, def: 480000, spd: 350, lck: 370 }, 
                skills: [{ name: 'Lôi Bạo', chance: 30, multiplier: 2.2 }, { name: 'Đánh', chance: 0, multiplier: 1.1 }] 
            },
            'mob_cctk_5': { 
                name: 'Thiên Khung Thần Tướng', level: 1870, rarity: 9, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 20000000000, atk: 1150000, def: 550000, spd: 270, lck: 360 }, 
                skills: [{ name: 'Thần Tướng Kích', chance: 30, multiplier: 2.3 }, { name: 'Đâm', chance: 0, multiplier: 1.1 }] 
            },
            'boss_cctk_1': { 
                name: 'Thiên Khung Chi Chủ', level: 1880, rarity: 10, icon: 'fa-solid fa-crown', 
                stats: { hp: 40000000000, atk: 1500000, def: 700000, spd: 300, lck: 600 }, 
                skills: [ { name: 'Chung Cực Phán Quyết', chance: 50, multiplier: 9.0, ignoreDef: 1.0 }, { name: 'Thiên Kiếm', chance: 0, multiplier: 1.5 } ]
            },

            // [NEW] Level 2200+ Monsters for Hon Don Tinh Hai
            'mob_hdth_1': { 
                name: 'Hỗn Độn Thú', level: 2200, rarity: 9, icon: 'fa-solid fa-spaghetti-monster-flying', 
                stats: { hp: 50000000000, atk: 2500000, def: 1000000, spd: 320, lck: 400 }, 
                skills: [{ name: 'Hỗn Độn Hống', chance: 0, multiplier: 1.5 }] 
            },
            'mob_hdth_2': { 
                name: 'Tinh Hải Du Hiệp', level: 2250, rarity: 9, icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 45000000000, atk: 2800000, def: 900000, spd: 350, lck: 420 }, 
                skills: [{ name: 'Tinh Quang Kiếm', chance: 30, multiplier: 2.2 }, { name: 'Chém', chance: 0, multiplier: 1.2 }] 
            },
            'boss_hdth_1': { 
                name: 'Tinh Hải Chi Chủ', level: 2300, rarity: 10, icon: 'fa-solid fa-star-of-david', 
                stats: { hp: 100000000000, atk: 3500000, def: 1500000, spd: 380, lck: 700 }, 
                skills: [ { name: 'Tinh Hải Diệt Thế', chance: 50, multiplier: 9.5, ignoreDef: 0.9 }, { name: 'Vẫn Thạch', chance: 0, multiplier: 1.8 } ]
            },
            
            /* [REMOVED] Gỡ bỏ 6 quái vật cũ của Thôn Phệ Tinh Không */

            // [NEW] Level 2500+ Monsters for Thon Phe Tinh Khong (Full List - 20 Monsters)
            // Cấp 2500-2530
            'tptk_mob_01': { name: 'Người Thường', level: 2500, rarity: 9, icon: 'fa-solid fa-person', stats: { hp: 100000000000, atk: 5000000, def: 2000000, spd: 300, lck: 400 }, skills: [{ name: 'Đấm', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_02': { name: 'Học Đồ', level: 2510, rarity: 9, icon: 'fa-solid fa-user-graduate', stats: { hp: 110000000000, atk: 5200000, def: 2200000, spd: 310, lck: 410 }, skills: [{ name: 'Đá', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_03': { name: 'Hành Tinh', level: 2520, rarity: 9, icon: 'fa-solid fa-globe', stats: { hp: 120000000000, atk: 5400000, def: 2400000, spd: 320, lck: 420 }, skills: [{ name: 'Trọng Lực', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_04': { name: 'Hằng Tinh', level: 2530, rarity: 9, icon: 'fa-solid fa-sun', stats: { hp: 130000000000, atk: 5600000, def: 2600000, spd: 330, lck: 430 }, skills: [{ name: 'Hỏa Diễm', chance: 0, multiplier: 1.5 }] },
            // Cấp 2540-2580
            'tptk_mob_05': { name: 'Vũ Trụ', level: 2540, rarity: 9, icon: 'fa-solid fa-satellite', stats: { hp: 140000000000, atk: 5800000, def: 2800000, spd: 340, lck: 440 }, skills: [{ name: 'Lực Vũ Trụ', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_06': { name: 'Vực Chủ', level: 2550, rarity: 9, icon: 'fa-solid fa-meteor', stats: { hp: 150000000000, atk: 6000000, def: 3000000, spd: 350, lck: 450 }, skills: [{ name: 'Chưởng Khống', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_07': { name: 'Giới Chủ', level: 2560, rarity: 9, icon: 'fa-solid fa-star-of-life', stats: { hp: 160000000000, atk: 6200000, def: 3200000, spd: 360, lck: 460 }, skills: [{ name: 'Giới Lực', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_08': { name: 'Bất Hủ', level: 2580, rarity: 9, icon: 'fa-solid fa-shield-halved', stats: { hp: 180000000000, atk: 6500000, def: 3500000, spd: 370, lck: 470 }, skills: [{ name: 'Bất Hủ Thân', chance: 0, multiplier: 1.5 }] },
            // Cấp 2600-2640
            'tptk_mob_09': { name: 'Vũ Trụ Tôn Giả', level: 2600, rarity: 9, icon: 'fa-solid fa-user-astronaut', stats: { hp: 200000000000, atk: 7000000, def: 4000000, spd: 380, lck: 480 }, skills: [{ name: 'Tôn Giả Kích', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_10': { name: 'Vũ Trụ Bá Chủ', level: 2610, rarity: 9, icon: 'fa-solid fa-user-tie', stats: { hp: 220000000000, atk: 7500000, def: 4200000, spd: 390, lck: 490 }, skills: [{ name: 'Bá Chủ Quyền', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_11': { name: 'Vũ Trụ Chi Chủ', level: 2620, rarity: 9, icon: 'fa-solid fa-satellite-dish', stats: { hp: 240000000000, atk: 8000000, def: 4400000, spd: 400, lck: 500 }, skills: [{ name: 'Vũ Trụ Lệnh', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_12': { name: 'Chân Thần', level: 2640, rarity: 9, icon: 'fa-solid fa-person-praying', stats: { hp: 260000000000, atk: 8500000, def: 4600000, spd: 410, lck: 510 }, skills: [{ name: 'Thần Lực', chance: 0, multiplier: 1.5 }] },
            // Cấp 2660-2720
            'tptk_mob_13': { name: 'Hư Không Chân Thần', level: 2660, rarity: 9, icon: 'fa-solid fa-star-of-life', stats: { hp: 280000000000, atk: 9000000, def: 4800000, spd: 420, lck: 520 }, skills: [{ name: 'Hư Không', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_14': { name: 'Vĩnh Hằng Chân Thần', level: 2680, rarity: 9, icon: 'fa-solid fa-infinity', stats: { hp: 300000000000, atk: 9500000, def: 5000000, spd: 430, lck: 530 }, skills: [{ name: 'Vĩnh Hằng', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_15': { name: 'Hỗn Độn Chúa Tể', level: 2700, rarity: 9, icon: 'fa-solid fa-hurricane', stats: { hp: 350000000000, atk: 10000000, def: 5500000, spd: 440, lck: 540 }, skills: [{ name: 'Hỗn Độn', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_16': { name: 'Thần Vương', level: 2720, rarity: 9, icon: 'fa-solid fa-chess-king', stats: { hp: 400000000000, atk: 11000000, def: 6000000, spd: 450, lck: 550 }, skills: [{ name: 'Thần Vương Lệnh', chance: 0, multiplier: 1.5 }] },
            // Cấp 2740-2800 (Boss)
            'tptk_mob_17': { name: 'Hồn Nguyên', level: 2740, rarity: 9, icon: 'fa-solid fa-atom', stats: { hp: 500000000000, atk: 12000000, def: 7000000, spd: 460, lck: 560 }, skills: [{ name: 'Hồn Nguyên Kích', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_18': { name: 'Lãnh Chúa', level: 2760, rarity: 9, icon: 'fa-solid fa-user-tie', stats: { hp: 600000000000, atk: 13000000, def: 8000000, spd: 470, lck: 570 }, skills: [{ name: 'Lãnh Chúa Quyền', chance: 0, multiplier: 1.5 }] },
            'tptk_mob_19': { name: 'Tôn Chủ', level: 2780, rarity: 9, icon: 'fa-solid fa-crown', stats: { hp: 700000000000, atk: 14000000, def: 9000000, spd: 480, lck: 580 }, skills: [{ name: 'Tôn Chủ Ấn', chance: 0, multiplier: 1.5 }] },
            // Boss
            'tptk_boss_20': { name: 'Thần Linh', level: 2800, rarity: 10, icon: 'fa-solid fa-wand-sparkles', stats: { hp: 2000000000000, atk: 20000000, def: 10000000, spd: 500, lck: 800 }, skills: [ { name: 'Thần Linh Phán Quyết', chance: 50, multiplier: 10.0, ignoreDef: 1.0 }, { name: 'Thôn Phệ', chance: 0, multiplier: 1.5 } ] },

            // [NEW] Map 1: Vực Sâu Hư Không (2800 - 3000)
            'void_mob_1': { 
                name: 'Hư Không Phệ Trùng', level: 2850, rarity: 10, icon: 'fa-solid fa-bug', 
                stats: { hp: 3000000000000, atk: 30000000, def: 15000000, spd: 550, lck: 900 }, 
                skills: [{ name: 'Cắn Nuốt Không Gian', chance: 30, multiplier: 2.0 }] 
            },
            'void_mob_2': { 
                name: 'Hư Không Ảnh Giả', level: 2900, rarity: 10, icon: 'fa-solid fa-user-secret', 
                stats: { hp: 4000000000000, atk: 35000000, def: 20000000, spd: 600, lck: 950 }, 
                skills: [{ name: 'Ám Ảnh Kích', chance: 35, multiplier: 2.5 }] 
            },
            'void_boss': { 
                name: 'Hư Không Chúa Tể', level: 3000, rarity: 11, icon: 'fa-solid fa-skull', 
                stats: { hp: 15000000000000, atk: 80000000, def: 40000000, spd: 700, lck: 1500 }, 
                skills: [ { name: 'Hư Vô Tịch Diệt', chance: 60, multiplier: 12.0, ignoreDef: 1.0 }, { name: 'Bóp Nghẹt', chance: 0, multiplier: 2.0 } ] 
            },

            // [NEW] Map 2: Thái Cổ Thần Mộ (3000 - 3500)
            'tomb_mob_1': { 
                name: 'Thủ Mộ Thần Binh', level: 3100, rarity: 11, icon: 'fa-solid fa-user-shield', 
                stats: { hp: 8000000000000, atk: 80000000, def: 50000000, spd: 750, lck: 1800 }, 
                skills: [{ name: 'Thần Binh Trấn Áp', chance: 30, multiplier: 2.5 }] 
            },
            'tomb_mob_2': { 
                name: 'Tàn Hồn Cổ Thần', level: 3300, rarity: 11, icon: 'fa-solid fa-ghost', 
                stats: { hp: 10000000000000, atk: 100000000, def: 60000000, spd: 800, lck: 2000 }, 
                skills: [{ name: 'Thần Phạt', chance: 40, multiplier: 3.0 }] 
            },
            'tomb_boss': { 
                name: 'Bất Tử Thần Vương', level: 3500, rarity: 12, icon: 'fa-solid fa-crown', 
                stats: { hp: 50000000000000, atk: 200000000, def: 120000000, spd: 900, lck: 4000 }, 
                skills: [ { name: 'Thần Vương Chi Nộ', chance: 60, multiplier: 15.0, ignoreDef: 1.0 }, { name: 'Bất Tử Thân', chance: 0, multiplier: 2.0 } ] 
            },

            // [NEW] Map 3: Đỉnh Cao Vũ Trụ (3500+)
            'multi_mob_1': { 
                name: 'Tinh Hà Cự Thú', level: 3600, rarity: 12, icon: 'fa-solid fa-dragon', 
                stats: { hp: 20000000000000, atk: 250000000, def: 150000000, spd: 1000, lck: 5000 }, 
                skills: [{ name: 'Tinh Hà Bạo', chance: 30, multiplier: 3.0 }] 
            },
            'multi_mob_2': { 
                name: 'Vũ Trụ Chấp Pháp Giả', level: 3800, rarity: 12, icon: 'fa-solid fa-gavel', 
                stats: { hp: 30000000000000, atk: 300000000, def: 200000000, spd: 1100, lck: 6000 }, 
                skills: [{ name: 'Phán Quyết', chance: 40, multiplier: 4.0 }] 
            },
            'multi_boss': { 
                name: 'Đấng Sáng Thế', level: 4000, rarity: 13, icon: 'fa-solid fa-sun', 
                stats: { hp: 200000000000000, atk: 1000000000, def: 500000000, spd: 1500, lck: 10000 }, 
                skills: [ { name: 'Tái Thiết Lập', chance: 70, multiplier: 20.0, ignoreDef: 1.0 }, { name: 'Xóa Sổ', chance: 0, multiplier: 5.0 } ] 
            },

            // [NEW] --- CÁC MAP MỚI SAU ĐỈNH CAO VŨ TRỤ (CẤP 4000+) ---
            
            // Map 4: Thiên Ngoại Thiên (4000 - 5000)
            'tnt_mob_1': { 
                name: 'Thiên Ma Tướng', level: 4100, rarity: 13, icon: 'fa-solid fa-brands fa-mandalorian', 
                stats: { hp: 50000000000000, atk: 600000000, def: 300000000, spd: 2000, lck: 8000 }, 
                skills: [{ name: 'Ma Khí', chance: 30, multiplier: 3.5 }] 
            },
            'tnt_mob_2': { 
                name: 'Ngoại Vực Sứ Giả', level: 4300, rarity: 13, icon: 'fa-solid fa-user-astronaut', 
                stats: { hp: 70000000000000, atk: 700000000, def: 350000000, spd: 2200, lck: 9000 }, 
                skills: [{ name: 'Hư Không Chưởng', chance: 35, multiplier: 4.0 }] 
            },
            'tnt_boss': { 
                name: 'Thiên Ngoại Ma Tôn', level: 4500, rarity: 14, icon: 'fa-solid fa-biohazard', 
                stats: { hp: 300000000000000, atk: 2000000000, def: 1000000000, spd: 2500, lck: 15000 }, 
                skills: [ { name: 'Thiên Ngoại Phi Tiên', chance: 60, multiplier: 25.0, ignoreDef: 1.0 }, { name: 'Diệt Thế', chance: 0, multiplier: 6.0 } ] 
            },

            // Map 5: Hỗn Độn Nguyên Giới (5000 - 6500)
            'hdng_mob_1': { 
                name: 'Hỗn Độn Thú', level: 5200, rarity: 14, icon: 'fa-solid fa-spaghetti-monster-flying', 
                stats: { hp: 150000000000000, atk: 1500000000, def: 800000000, spd: 3000, lck: 20000 }, 
                skills: [{ name: 'Hỗn Độn Hống', chance: 30, multiplier: 4.5 }] 
            },
            'hdng_mob_2': { 
                name: 'Nguyên Linh', level: 5800, rarity: 14, icon: 'fa-solid fa-ghost', 
                stats: { hp: 200000000000000, atk: 1800000000, def: 1000000000, spd: 3500, lck: 25000 }, 
                skills: [{ name: 'Nguyên Lực Kích', chance: 40, multiplier: 5.0 }] 
            },
            'hdng_boss': { 
                name: 'Hỗn Độn Chúa Tể (Chân Thân)', level: 6500, rarity: 15, icon: 'fa-solid fa-eye', 
                stats: { hp: 1000000000000000, atk: 5000000000, def: 3000000000, spd: 4000, lck: 50000 }, 
                skills: [ { name: 'Quy Về Hư Vô', chance: 70, multiplier: 50.0, ignoreDef: 1.0 }, { name: 'Tái Tạo', chance: 0, multiplier: 8.0 } ] 
            },

            // Map 6: Vĩnh Hằng Chi Môn (7000+) - [MODIFIED] Giảm tiếp 1/20
            'vhcm_mob_1': { 
                name: 'Vĩnh Hằng Thủ Vệ', level: 7200, rarity: 15, icon: 'fa-solid fa-shield-halved', 
                stats: { hp: 250000000, atk: 1500, def: 1000, spd: 225, lck: 3000 }, 
                skills: [{ name: 'Bất Diệt Hộ Thể', chance: 30, multiplier: 5.0 }] 
            },
            'vhcm_mob_2': { 
                name: 'Thời Gian Chi Ảnh', level: 7800, rarity: 15, icon: 'fa-solid fa-clock', 
                stats: { hp: 300000000, atk: 1750, def: 1250, spd: 250, lck: 3500 }, 
                skills: [{ name: 'Thời Gian Nghịch Lưu', chance: 40, multiplier: 6.0 }] 
            },
            'vhcm_boss': { 
                name: 'Vĩnh Hằng Chí Tôn', level: 8500, rarity: 16, icon: 'fa-solid fa-infinity', 
                stats: { hp: 2500000000, atk: 7500, def: 5000, spd: 300, lck: 5000 }, 
                skills: [ { name: 'Vĩnh Hằng Bất Diệt', chance: 80, multiplier: 100.0, ignoreDef: 1.0 }, { name: 'Siêu Thoát', chance: 0, multiplier: 10.0 } ] 
            },

            // [NEW] Map 7: Thái Cực Thánh Cảnh (9000+) - [MODIFIED] Giảm tiếp 1/20
            'tctc_mob_1': {
                name: 'Thái Cực Âm Linh', level: 9200, rarity: 15, icon: 'fa-solid fa-ghost',
                stats: { hp: 10000000000, atk: 20000, def: 15000, spd: 400, lck: 7500 },
                skills: [{ name: 'Âm Sát', chance: 0, multiplier: 6.0 }]
            },
            'tctc_mob_2': {
                name: 'Thái Cực Dương Linh', level: 9500, rarity: 15, icon: 'fa-solid fa-sun',
                stats: { hp: 12500000000, atk: 22500, def: 17500, spd: 425, lck: 8000 },
                skills: [{ name: 'Dương Hỏa', chance: 0, multiplier: 6.5 }]
            },
            'tctc_boss': {
                name: 'Thái Cực Thánh Chủ', level: 10000, rarity: 16, icon: 'fa-solid fa-yin-yang',
                stats: { hp: 50000000000, atk: 50000, def: 40000, spd: 500, lck: 15000 },
                skills: [ { name: 'Thái Cực Đồ', chance: 70, multiplier: 100.0, ignoreDef: 1.0 }, { name: 'Vô Cực Sinh Thái Cực', chance: 0, multiplier: 20.0 } ]
            },

            // [NEW] Map 8: Hư Vô Cấm Địa (Trùng Sinh 22 - Cấp 11000+) - [MODIFIED] Giảm tiếp 1/20
            'hvcd_mob_1': {
                name: 'Hư Không Thú', level: 11000, rarity: 16, icon: 'fa-solid fa-dragon',
                stats: { hp: 25000000000, atk: 100000, def: 75000, spd: 600, lck: 20000 },
                skills: [{ name: 'Thôn Phệ', chance: 0, multiplier: 7.0 }]
            },
            'hvcd_mob_2': {
                name: 'Hư Không Ảnh Ma', level: 11500, rarity: 16, icon: 'fa-solid fa-ghost',
                stats: { hp: 30000000000, atk: 110000, def: 90000, spd: 650, lck: 22500 },
                skills: [{ name: 'Ám Ảnh Sát', chance: 0, multiplier: 7.5 }]
            },
            'hvcd_boss': {
                name: 'Hư Vô Chúa Tể', level: 12000, rarity: 16, icon: 'fa-solid fa-eye',
                stats: { hp: 150000000000, atk: 250000, def: 200000, spd: 750, lck: 30000 },
                skills: [ { name: 'Hư Vô Tịch Diệt', chance: 80, multiplier: 200.0, ignoreDef: 1.0 }, { name: 'Quy Về Hư Không', chance: 0, multiplier: 30.0 } ]
            },

            // [NEW] Map 9: Đạo Nguyên Thánh Cảnh (Trùng Sinh 25 - Cấp 15000+) - [MODIFIED] Giảm tiếp 1/20
            'dnsc_mob_1': {
                name: 'Đạo Nguyên Linh Thú', level: 14000, rarity: 16, icon: 'fa-solid fa-paw',
                stats: { hp: 50000000000, atk: 400000, def: 300000, spd: 900, lck: 40000 },
                skills: [{ name: 'Đạo Lực Kích', chance: 0, multiplier: 10.0 }]
            },
            'dnsc_mob_2': {
                name: 'Thánh Cảnh Hộ Pháp', level: 14500, rarity: 16, icon: 'fa-solid fa-user-shield',
                stats: { hp: 60000000000, atk: 450000, def: 350000, spd: 1000, lck: 45000 },
                skills: [{ name: 'Thánh Quang Trảm', chance: 0, multiplier: 12.0 }]
            },
            'dnsc_boss': {
                name: 'Đạo Tổ', level: 15000, rarity: 16, icon: 'fa-solid fa-yin-yang',
                stats: { hp: 500000000000, atk: 1000000, def: 750000, spd: 1250, lck: 75000 },
                skills: [ { name: 'Nhất Khí Hóa Tam Thanh', chance: 60, multiplier: 500.0, ignoreDef: 1.0 }, { name: 'Đạo Pháp Tự Nhiên', chance: 0, multiplier: 50.0 } ]
            },

            // [NEW] Map 10: Hồng Mông Tiên Cảnh (Trùng Sinh 30 - Cấp 18000+) - [MODIFIED] Giảm tiếp 1/20
            'hmtc_mob_1': {
                name: 'Hồng Mông Linh Thú', level: 17000, rarity: 16, icon: 'fa-solid fa-dragon',
                stats: { hp: 250000000000, atk: 1500000, def: 1000000, spd: 1250, lck: 50000 },
                skills: [{ name: 'Hồng Mông Khí', chance: 0, multiplier: 15.0 }]
            },
            'hmtc_mob_2': {
                name: 'Tiên Cảnh Thủ Vệ', level: 17500, rarity: 16, icon: 'fa-solid fa-user-shield',
                stats: { hp: 300000000000, atk: 1750000, def: 1250000, spd: 1400, lck: 60000 },
                skills: [{ name: 'Tiên Pháp Trấn Áp', chance: 0, multiplier: 18.0 }]
            },
            'hmtc_boss': {
                name: 'Hồng Mông Đạo Tôn', level: 18000, rarity: 16, icon: 'fa-solid fa-yin-yang',
                stats: { hp: 2500000000000, atk: 5000000, def: 4000000, spd: 1750, lck: 100000 },
                skills: [ { name: 'Vạn Vật Quy Nguyên', chance: 60, multiplier: 1000.0, ignoreDef: 1.0 }, { name: 'Khai Thiên Tịch Địa', chance: 0, multiplier: 100.0 } ]
            },

            // [NEW] Map 11: Sáng Thế Thần Vực (Trùng Sinh 35 - Cấp 20000+) - [MODIFIED] Giảm tiếp 1/20
            'sttv_mob_1': {
                name: 'Sáng Thế Linh Sứ', level: 20000, rarity: 16, icon: 'fa-solid fa-user-astronaut',
                stats: { hp: 25000000000000, atk: 25000000, def: 15000000, spd: 2000, lck: 150000 },
                skills: [{ name: 'Thần Quang Phán Xét', chance: 0, multiplier: 20.0 }]
            },
            'sttv_mob_2': {
                name: 'Khởi Nguyên Chi Thú', level: 21000, rarity: 16, icon: 'fa-solid fa-dragon',
                stats: { hp: 40000000000000, atk: 30000000, def: 20000000, spd: 2250, lck: 175000 },
                skills: [{ name: 'Hơi Thở Khởi Nguyên', chance: 0, multiplier: 25.0 }]
            },
            'sttv_boss': {
                name: 'Sáng Thế Thần Chủ', level: 22000, rarity: 16, icon: 'fa-solid fa-sun',
                stats: { hp: 500000000000000, atk: 250000000, def: 100000000, spd: 3000, lck: 250000 },
                skills: [ { name: 'Sáng Thế Chi Quang', chance: 50, multiplier: 2000.0, ignoreDef: 1.0 }, { name: 'Tái Thiết Lập', chance: 0, multiplier: 200.0 } ]
            },

            // [NEW] Map 12: Thiên Đạo Vô Cực Giới (Trùng Sinh 40 - Cấp 25000+) - [MODIFIED] Giảm tiếp 1/20
            'tdvc_mob_1': {
                name: 'Thiên Đạo Sứ Giả', level: 25000, rarity: 16, icon: 'fa-solid fa-user-astronaut',
                stats: { hp: 250000000000000, atk: 250000000, def: 150000000, spd: 4000, lck: 500000 },
                skills: [{ name: 'Thiên Phạt', chance: 0, multiplier: 30.0 }]
            },
            'tdvc_mob_2': {
                name: 'Luân Hồi Hộ Pháp', level: 26000, rarity: 16, icon: 'fa-solid fa-dharmachakra',
                stats: { hp: 400000000000000, atk: 300000000, def: 200000000, spd: 4500, lck: 600000 },
                skills: [{ name: 'Luân Hồi Kích', chance: 0, multiplier: 35.0 }]
            },
            'tdvc_boss': {
                name: 'Thiên Đạo Chúa Tể', level: 28000, rarity: 16, icon: 'fa-solid fa-infinity',
                stats: { hp: 5000000000000000, atk: 2500000000, def: 1000000000, spd: 6000, lck: 1000000 },
                skills: [ { name: 'Đại Đạo Vô Hình', chance: 50, multiplier: 5000.0, ignoreDef: 1.0 }, { name: 'Vô Cực Diệt Thế', chance: 0, multiplier: 500.0 } ]
            },

            // [NEW] Map 13: Chúa Tể Vĩnh Hằng Giới (Trùng Sinh 50 - Cấp 30000+) 
            // [MODIFIED] Chỉ số cao hơn 30% so với Map 12
            'ctvh_mob_1': {
                name: 'Thời Gian Nghịch Lưu', level: 30000, rarity: 16, icon: 'fa-solid fa-hourglass-half',
                stats: { hp: 325000000000000, atk: 325000000, def: 195000000, spd: 5200, lck: 650000 },
                skills: [{ name: 'Lão Hóa', chance: 0, multiplier: 50.0 }]
            },
            'ctvh_mob_2': {
                name: 'Không Gian Phá Toái', level: 32000, rarity: 16, icon: 'fa-solid fa-maximize',
                stats: { hp: 520000000000000, atk: 390000000, def: 260000000, spd: 5850, lck: 780000 },
                skills: [{ name: 'Cắt Nát Hư Không', chance: 0, multiplier: 60.0 }]
            },
            'ctvh_boss': {
                name: 'Chúa Tể Vĩnh Hằng', level: 35000, rarity: 16, icon: 'fa-solid fa-crown',
                stats: { hp: 6500000000000000, atk: 3250000000, def: 1300000000, spd: 7800, lck: 1300000 },
                skills: [ { name: 'Vĩnh Hằng Chi Nộ', chance: 50, multiplier: 10000.0, ignoreDef: 1.0 }, { name: 'Xóa Sổ Thực Tại', chance: 0, multiplier: 1000.0 } ]
            },

            // [NEW] Map 14: Tinh Hà Cổ Lộ (Trùng Sinh 60 - Cấp 38000+)
            // [MODIFIED] Chỉ số cao hơn 30% so với Map 13
            'thcl_mob_1': {
                name: 'Tinh Thú Hộ Vệ', level: 38000, rarity: 16, icon: 'fa-solid fa-star-of-david',
                stats: { hp: 422500000000000, atk: 422500000, def: 253500000, spd: 6760, lck: 845000 },
                skills: [{ name: 'Tinh Quang Phá', chance: 0, multiplier: 80.0 }]
            },
            'thcl_mob_2': {
                name: 'Hư Không Du Giả', level: 40000, rarity: 16, icon: 'fa-solid fa-shuttle-space',
                stats: { hp: 676000000000000, atk: 507000000, def: 338000000, spd: 7605, lck: 1014000 },
                skills: [{ name: 'Thiên Thạch Rơi', chance: 0, multiplier: 90.0 }]
            },
            'thcl_boss': {
                name: 'Tinh Hà Chi Chủ', level: 42000, rarity: 16, icon: 'fa-solid fa-galaxy',
                stats: { hp: 8450000000000000, atk: 422500000000, def: 169000000000, spd: 10140, lck: 1690000 },
                skills: [ { name: 'Đại Băng Hoại', chance: 60, multiplier: 20000.0, ignoreDef: 1.0 }, { name: 'Sao Chổi Hủy Diệt', chance: 0, multiplier: 2000.0 } ]
            },

            // [NEW] Map 15: Nguyên Sơ Hỗn Mang (Trùng Sinh 70 - Cấp 45000+)
            // Chỉ số cao hơn 30% so với TS 60
            'nshm_mob_1': {
                name: 'Hỗn Độn Thú', level: 45000, rarity: 16, icon: 'fa-solid fa-pastafarianism',
                stats: { hp: 550000000000000, atk: 550000000000, def: 330000000000, spd: 8800, lck: 1100000 }, 
                skills: [{ name: 'Hỗn Loạn', chance: 0, multiplier: 100.0 }]
            },
            'nshm_mob_2': {
                name: 'Nguyên Linh Cổ Đại', level: 48000, rarity: 16, icon: 'fa-solid fa-dna',
                stats: { hp: 880000000000000, atk: 660000000000, def: 440000000000, spd: 9900, lck: 1300000 },
                skills: [{ name: 'Phân Tách', chance: 0, multiplier: 120.0 }]
            },
            'nshm_boss': {
                name: 'Nguyên Sơ Cổ Thần', level: 50000, rarity: 16, icon: 'fa-solid fa-eye',
                stats: { hp: 11000000000000000, atk: 5500000000000, def: 2200000000000, spd: 13200, lck: 2200000 }, 
                skills: [ { name: 'Khai Thiên', chance: 60, multiplier: 300.0, ignoreDef: 1.0 }, { name: 'Tái Tạo', chance: 0, multiplier: 30.0 } ]
            },

            // [NEW] Map 16: Vô Tận Luân Hồi (Trùng Sinh 80 - Cấp 55000+)
            // Chỉ số cao hơn 30% so với TS 70
            'vtlh_mob_1': {
                name: 'Luân Hồi Thủ Vệ', level: 55000, rarity: 16, icon: 'fa-solid fa-circle-notch',
                stats: { hp: 715000000000000, atk: 715000000000, def: 429000000000, spd: 11440, lck: 1430000 }, 
                skills: [{ name: 'Luân Hồi Kiếp', chance: 0, multiplier: 130.0 }]
            },
            'vtlh_mob_2': {
                name: 'Vong Xuyên Chi Hồn', level: 58000, rarity: 16, icon: 'fa-solid fa-water',
                stats: { hp: 1144000000000000, atk: 858000000000, def: 572000000000, spd: 12870, lck: 1690000 },
                skills: [{ name: 'Lãng Quên', chance: 0, multiplier: 150.0 }]
            },
            'vtlh_boss': {
                name: 'Luân Hồi Chi Chủ', level: 60000, rarity: 16, icon: 'fa-solid fa-infinity',
                stats: { hp: 14300000000000000, atk: 7150000000000, def: 2860000000000, spd: 17160, lck: 2860000 }, 
                skills: [ { name: 'Vạn Kiếp Bất Phục', chance: 60, multiplier: 400.0, ignoreDef: 1.0 }, { name: 'Lục Đạo Luân Hồi', chance: 0, multiplier: 40.0 } ]
            },

            // [NEW] Map 17: Chư Thần Hoàng Hôn (Trùng Sinh 90 - Cấp 65000+)
            // Chỉ số cao hơn 30% so với TS 80
            'cthh_mob_1': {
                name: 'Thần Hủy Diệt Tàn Ảnh', level: 65000, rarity: 16, icon: 'fa-solid fa-person-falling-burst',
                stats: { hp: 930000000000000, atk: 930000000000, def: 558000000000, spd: 14800, lck: 1860000 }, 
                skills: [{ name: 'Hủy Diệt Chi Lực', chance: 0, multiplier: 170.0 }]
            },
            'cthh_mob_2': {
                name: 'Hoàng Hôn Sứ Giả', level: 68000, rarity: 16, icon: 'fa-solid fa-crow',
                stats: { hp: 1480000000000000, atk: 1110000000000, def: 740000000000, spd: 16600, lck: 2200000 },
                skills: [{ name: 'Ngày Tàn', chance: 0, multiplier: 200.0 }]
            },
            'cthh_boss': {
                name: 'Thần Vương Sa Ngã', level: 70000, rarity: 16, icon: 'fa-solid fa-crown',
                stats: { hp: 18600000000000000, atk: 9300000000000, def: 3720000000000, spd: 22200, lck: 3720000 }, 
                skills: [ { name: 'Ragnarok', chance: 60, multiplier: 520.0, ignoreDef: 1.0 }, { name: 'Thần Quyền', chance: 0, multiplier: 50.0 } ]
            },

            // [NEW] Map 18: Kỷ Nguyên Hủy Diệt (Trùng Sinh 100 - Cấp 75000+)
            // Chỉ số cao hơn 20% so với TS 90
            'knhd_mob_1': {
                name: 'Hư Không Phệ Hồn', level: 75000, rarity: 16, icon: 'fa-solid fa-ghost',
                stats: { hp: 1116000000000000, atk: 1116000000000, def: 669600000000, spd: 17760, lck: 2232000 }, 
                skills: [{ name: 'Phệ Hồn', chance: 0, multiplier: 200.0 }]
            },
            'knhd_mob_2': {
                name: 'Diệt Thế Chiến Binh', level: 78000, rarity: 16, icon: 'fa-solid fa-skull-crossbones',
                stats: { hp: 1776000000000000, atk: 1332000000000, def: 888000000000, spd: 19920, lck: 2640000 },
                skills: [{ name: 'Trảm Diệt', chance: 0, multiplier: 240.0 }]
            },
            'knhd_boss': {
                name: 'Chúa Tể Hủy Diệt', level: 80000, rarity: 16, icon: 'fa-solid fa-biohazard',
                stats: { hp: 22320000000000000, atk: 11160000000000, def: 4464000000000, spd: 26640, lck: 4464000 }, 
                skills: [ { name: 'Đại Hủy Diệt', chance: 60, multiplier: 624.0, ignoreDef: 1.0 }, { name: 'Tận Thế', chance: 0, multiplier: 60.0 } ]
            },

            // [NEW] Map 19: Hỗn Nguyên Thánh Cảnh (Trùng Sinh 125 - Cấp 85000+)
            // Chỉ số cao hơn 15% so với TS 100
            'hnsc_mob_1': {
                name: 'Hỗn Nguyên Linh', level: 85000, rarity: 16, icon: 'fa-solid fa-atom',
                stats: { hp: 1283400000000000, atk: 1283400000000, def: 770040000000, spd: 20424, lck: 2566800 }, 
                skills: [{ name: 'Nguyên Lực', chance: 0, multiplier: 220.0 }]
            },
            'hnsc_mob_2': {
                name: 'Thánh Cảnh Thủ Vệ', level: 88000, rarity: 16, icon: 'fa-solid fa-user-shield',
                stats: { hp: 2042400000000000, atk: 1531800000000, def: 1021200000000, spd: 22908, lck: 3036000 },
                skills: [{ name: 'Thánh Quang Trảm', chance: 0, multiplier: 260.0 }]
            },
            'hnsc_boss': {
                name: 'Hỗn Nguyên Thánh Tổ', level: 90000, rarity: 16, icon: 'fa-solid fa-peace',
                stats: { hp: 25668000000000000, atk: 12834000000000, def: 5133600000000, spd: 30636, lck: 5133600 }, 
                skills: [ { name: 'Vạn Pháp Quy Tông', chance: 60, multiplier: 700.0, ignoreDef: 1.0 }, { name: 'Thánh Nhân Chỉ Lộ', chance: 0, multiplier: 70.0 } ]
            },

            // [NEW] Map 20: Thái Hư Cổ Giới (Trùng Sinh 150 - Cấp 95000+)
            // Chỉ số cao hơn 15% so với TS 125
            'thcg_mob_1': {
                name: 'Thái Hư Ảnh Thú', level: 95000, rarity: 16, icon: 'fa-solid fa-ghost',
                stats: { hp: 1475910000000000, atk: 1475910000000, def: 885546000000, spd: 23487, lck: 2951820 }, 
                skills: [{ name: 'Hư Ảnh Kích', chance: 0, multiplier: 240.0 }]
            },
            'thcg_mob_2': {
                name: 'Cổ Giới Thủ Vệ', level: 98000, rarity: 16, icon: 'fa-solid fa-dungeon',
                stats: { hp: 2348760000000000, atk: 1761570000000, def: 1174380000000, spd: 26344, lck: 3491400 },
                skills: [{ name: 'Trấn Áp', chance: 0, multiplier: 280.0 }]
            },
            'thcg_boss': {
                name: 'Thái Hư Cổ Long', level: 100000, rarity: 16, icon: 'fa-solid fa-dragon',
                stats: { hp: 29518200000000000, atk: 14759100000000, def: 5903640000000, spd: 35231, lck: 5903640 }, 
                skills: [ { name: 'Thái Hư Diệt Thế', chance: 60, multiplier: 750.0, ignoreDef: 1.0 }, { name: 'Long Ngâm', chance: 0, multiplier: 80.0 } ]
            },

            // [NEW] Map 21: Cực Đạo Chung Yên (Trùng Sinh 175 - Cấp 105000+)
            // Chỉ số cao hơn 15% so với TS 150
            'cdcy_mob_1': {
                name: 'Cực Đạo Sứ Giả', level: 105000, rarity: 16, icon: 'fa-solid fa-user-astronaut',
                stats: { hp: 1697296500000000, atk: 1697296000000, def: 1018377000000, spd: 27010, lck: 3394590 }, 
                skills: [{ name: 'Đạo Pháp', chance: 0, multiplier: 260.0 }]
            },
            'cdcy_mob_2': {
                name: 'Chung Yên Thú', level: 108000, rarity: 16, icon: 'fa-solid fa-paw',
                stats: { hp: 2701074000000000, atk: 2025805000000, def: 1350537000000, spd: 30295, lck: 4015110 },
                skills: [{ name: 'Chung Kết', chance: 0, multiplier: 300.0 }]
            },
            'cdcy_boss': {
                name: 'Cực Đạo Chi Chủ', level: 110000, rarity: 16, icon: 'fa-solid fa-yin-yang',
                stats: { hp: 33945930000000000, atk: 16972960000000, def: 6789186000000, spd: 40515, lck: 6789180 }, 
                skills: [ { name: 'Vạn Vật Quy Hư', chance: 60, multiplier: 800.0, ignoreDef: 1.0 }, { name: 'Cực Đạo Trảm', chance: 0, multiplier: 90.0 } ]
            },

            // [NEW] Map 22: Vĩnh Hằng Chân Giới (Trùng Sinh 200 - Cấp 115000+)
            // Chỉ số cao hơn 15% so với TS 175
            'vhcg_mob_1': {
                name: 'Vĩnh Hằng Thủ Vệ', level: 115000, rarity: 16, icon: 'fa-solid fa-shield-halved',
                stats: { hp: 1951890000000000, atk: 1951890000000, def: 1171134000000, spd: 31061, lck: 3903780 }, 
                skills: [{ name: 'Bất Diệt', chance: 0, multiplier: 280.0 }]
            },
            'vhcg_mob_2': {
                name: 'Chân Lý Chi Ảnh', level: 118000, rarity: 16, icon: 'fa-solid fa-eye',
                stats: { hp: 3106235000000000, atk: 2329675000000, def: 1553117000000, spd: 34839, lck: 4617370 },
                skills: [{ name: 'Phản Chiếu', chance: 0, multiplier: 320.0 }]
            },
            'vhcg_boss': {
                name: 'Vĩnh Hằng Chân Thần', level: 120000, rarity: 16, icon: 'fa-solid fa-infinity',
                stats: { hp: 39037810000000000, atk: 19518900000000, def: 7807563000000, spd: 46592, lck: 7807550 }, 
                skills: [ { name: 'Vĩnh Hằng Chi Quang', chance: 60, multiplier: 850.0, ignoreDef: 1.0 }, { name: 'Chân Lý Phán Quyết', chance: 0, multiplier: 100.0 } ]
            },

            // [NEW] Map 23: Thần Vực Hủy Diệt (Trùng Sinh 250 - Cấp 125000+)
            // Chỉ số cao hơn 10% so với TS 200
            'tvhd_mob_1': {
                name: 'Hủy Diệt Chiến Binh', level: 125000, rarity: 16, icon: 'fa-solid fa-skull-crossbones',
                stats: { hp: 2147079000000000, atk: 2147079000000, def: 1288247000000, spd: 34167, lck: 4294150 }, 
                skills: [{ name: 'Hủy Diệt Trảm', chance: 0, multiplier: 300.0 }]
            },
            'tvhd_mob_2': {
                name: 'Tận Thế Sứ Giả', level: 128000, rarity: 16, icon: 'fa-solid fa-biohazard',
                stats: { hp: 3416858000000000, atk: 2562642000000, def: 1708428000000, spd: 38322, lck: 5079100 },
                skills: [{ name: 'Tận Thế Hàng Lâm', chance: 0, multiplier: 350.0 }]
            },
            'tvhd_boss': {
                name: 'Chân Thần Hủy Diệt', level: 130000, rarity: 16, icon: 'fa-solid fa-dragon',
                stats: { hp: 42941590000000000, atk: 21470790000000, def: 8588316000000, spd: 51251, lck: 8588300 }, 
                skills: [ { name: 'Vạn Vật Tịch Diệt', chance: 60, multiplier: 900.0, ignoreDef: 1.0 }, { name: 'Thần Phạt', chance: 0, multiplier: 110.0 } ]
            },

            // [NEW] Map 24: Đa Vũ Trụ Chi Đỉnh (Trùng Sinh 300 - Cấp 135000+)
            // Chỉ số cao hơn 10% so với TS 250
            'dvt_mob_1': {
                name: 'Kẻ Du Hành Thời Gian', level: 135000, rarity: 16, icon: 'fa-solid fa-user-clock',
                stats: { hp: 2361787000000000, atk: 2361787000000, def: 1417072000000, spd: 37584, lck: 4723570 }, 
                skills: [{ name: 'Nghịch Chuyển', chance: 0, multiplier: 330.0 }]
            },
            'dvt_mob_2': {
                name: 'Vũ Trụ Thôn Phệ Giả', level: 138000, rarity: 16, icon: 'fa-solid fa-black-hole', // Giả lập icon hố đen bằng circle-dot nếu không có
                stats: { hp: 3758544000000000, atk: 2818906000000, def: 1879271000000, spd: 42154, lck: 5587010 },
                skills: [{ name: 'Thôn Phệ Tinh Không', chance: 0, multiplier: 380.0 }]
            },
            'dvt_boss': {
                name: 'Chúa Tể Đa Vũ Trụ', level: 140000, rarity: 16, icon: 'fa-solid fa-globe',
                stats: { hp: 47235750000000000, atk: 23617870000000, def: 9447148000000, spd: 56376, lck: 9447130 }, 
                skills: [ { name: 'Đa Chiều Không Gian', chance: 60, multiplier: 1000.0, ignoreDef: 1.0 }, { name: 'Vụ Nổ Big Bang', chance: 0, multiplier: 120.0 } ]
            },

            // [NEW] Map 25: Bỉ Ngạn Hư Vô (Trùng Sinh 400 - Cấp 145000+)
            // Chỉ số cao hơn 5% so với TS 300
            'bnhv_mob_1': {
                name: 'Hư Vô Hành Giả', level: 145000, rarity: 16, icon: 'fa-solid fa-person-walking-dashed-line-arrow-right',
                stats: { hp: 2479876000000000, atk: 2479876000000, def: 1487925000000, spd: 39463, lck: 4959750 }, 
                skills: [{ name: 'Hư Bước', chance: 0, multiplier: 350.0 }]
            },
            'bnhv_mob_2': {
                name: 'Bỉ Ngạn Hoa Linh', level: 148000, rarity: 16, icon: 'fa-solid fa-plant-wilt',
                stats: { hp: 3946471000000000, atk: 2959851000000, def: 1973234000000, spd: 44261, lck: 5866360 },
                skills: [{ name: 'Hoa Khai Bỉ Ngạn', chance: 0, multiplier: 400.0 }]
            },
            'bnhv_boss': {
                name: 'Bỉ Ngạn Chúa Tể', level: 150000, rarity: 16, icon: 'fa-solid fa-torii-gate',
                stats: { hp: 49597540000000000, atk: 24798760000000, def: 9919505000000, spd: 59194, lck: 9919480 }, 
                skills: [ { name: 'Vô Ngã Vô Ưu', chance: 60, multiplier: 1050.0, ignoreDef: 1.0 }, { name: 'Luân Hồi Nghịch Chuyển', chance: 0, multiplier: 130.0 } ]
            },

            // [NEW] Map 26: Thánh Vực Vô Cực (Trùng Sinh 500 - Cấp 155000+)
            // Chỉ số cao hơn 5% so với TS 400
            'tvvc_mob_1': {
                name: 'Vô Cực Hành Giả', level: 155000, rarity: 16, icon: 'fa-solid fa-person-rays',
                stats: { hp: 2603870000000000, atk: 2603870000000, def: 1562322000000, spd: 41436, lck: 5207740 }, 
                skills: [{ name: 'Vô Cực Bộ', chance: 0, multiplier: 380.0 }]
            },
            'tvvc_mob_2': {
                name: 'Đại Đạo Chi Linh', level: 158000, rarity: 16, icon: 'fa-solid fa-yin-yang',
                stats: { hp: 4143795000000000, atk: 3107845000000, def: 2071896000000, spd: 46474, lck: 6159680 },
                skills: [{ name: 'Đạo Pháp', chance: 0, multiplier: 420.0 }]
            },
            'tvvc_boss': {
                name: 'Vô Cực Thánh Tôn', level: 160000, rarity: 16, icon: 'fa-solid fa-infinity',
                stats: { hp: 52077420000000000, atk: 26038700000000, def: 10415480000000, spd: 62154, lck: 10415450 }, 
                skills: [ { name: 'Vô Cực Diệt Thế', chance: 60, multiplier: 1100.0, ignoreDef: 1.0 }, { name: 'Quy Nguyên', chance: 0, multiplier: 150.0 } ]
            },

            // [NEW] Map 27: Thần Giới Khởi Nguyên (Trùng Sinh 750 - Cấp 165000+)
            // Chỉ số cao hơn 5% so với TS 500
            'kgkn_mob_1': {
                name: 'Khởi Nguyên Thần Binh', level: 165000, rarity: 16, icon: 'fa-solid fa-user-shield',
                stats: { hp: 2734063500000000, atk: 2734063500000, def: 1640438000000, spd: 43507, lck: 5468120 }, 
                skills: [{ name: 'Thần Kích', chance: 0, multiplier: 400.0 }]
            },
            'kgkn_mob_2': {
                name: 'Thần Giới Hộ Pháp', level: 168000, rarity: 16, icon: 'fa-solid fa-user-astronaut',
                stats: { hp: 4350984750000000, atk: 3263237250000, def: 2175490000000, spd: 48797, lck: 6467660 },
                skills: [{ name: 'Hộ Pháp Chưởng', chance: 0, multiplier: 450.0 }]
            },
            'kgkn_boss': {
                name: 'Khởi Nguyên Thần Vương', level: 170000, rarity: 16, icon: 'fa-solid fa-sun',
                stats: { hp: 54681291000000000, atk: 27340635000000, def: 10936254000000, spd: 65261, lck: 10936220 }, 
                skills: [ { name: 'Thần Vương Chi Nộ', chance: 60, multiplier: 1150.0, ignoreDef: 1.0 }, { name: 'Sáng Thế Ánh Sáng', chance: 0, multiplier: 160.0 } ]
            },

            // [NEW] Map 28: Đại Đạo Chi Đỉnh (Trùng Sinh 1000 - Cấp 175000+)
            // Chỉ số cao hơn 5% so với TS 750
            'ddcd_mob_1': {
                name: 'Đại Đạo Thủ Vệ', level: 175000, rarity: 16, icon: 'fa-solid fa-user-shield',
                stats: { hp: 2870766000000000, atk: 2870766000000, def: 1722459000000, spd: 45682, lck: 5741520 }, 
                skills: [{ name: 'Đạo Kiếm', chance: 0, multiplier: 420.0 }]
            },
            'ddcd_mob_2': {
                name: 'Chân Lý Sứ Giả', level: 178000, rarity: 16, icon: 'fa-solid fa-user-astronaut',
                stats: { hp: 4568533000000000, atk: 3426400000000, def: 2284266000000, spd: 51236, lck: 6791040 },
                skills: [{ name: 'Chân Lý Chi Quang', chance: 0, multiplier: 480.0 }]
            },
            'ddcd_boss': {
                name: 'Đại Đạo Chi Chủ', level: 180000, rarity: 16, icon: 'fa-solid fa-infinity',
                stats: { hp: 57415355000000000, atk: 28707660000000, def: 11483060000000, spd: 68524, lck: 11483030 }, 
                skills: [ { name: 'Đại Đạo Vô Cực', chance: 60, multiplier: 1200.0, ignoreDef: 1.0 }, { name: 'Vạn Pháp Quy Nhất', chance: 0, multiplier: 170.0 } ]
            },

            // [NEW] Map 29: Bản Nguyên Giới (Trùng Sinh 1500 - Cấp 185000+)
            // Chỉ số cao hơn 4% so với TS 1000
            'bng_mob_1': {
                name: 'Bản Nguyên Chi Linh', level: 185000, rarity: 16, icon: 'fa-solid fa-atom',
                stats: { hp: 2985596640000000, atk: 2985596640000, def: 1791357360000, spd: 47509, lck: 5971180 }, 
                skills: [{ name: 'Nguyên Lực Kích', chance: 0, multiplier: 450.0 }]
            },
            'bng_mob_2': {
                name: 'Thủ Vệ Cội Nguồn', level: 188000, rarity: 16, icon: 'fa-solid fa-shield-cat',
                stats: { hp: 4751274320000000, atk: 3563456000000, def: 2375636640000, spd: 53285, lck: 7062680 },
                skills: [{ name: 'Cội Nguồn Hộ Thể', chance: 0, multiplier: 500.0 }]
            },
            'bng_boss': {
                name: 'Bản Nguyên Chúa Tể', level: 190000, rarity: 16, icon: 'fa-solid fa-circle-nodes',
                stats: { hp: 59711969200000000, atk: 29855966400000, def: 11942382400000, spd: 71265, lck: 11942350 }, 
                skills: [ { name: 'Vạn Vật Quy Nguyên', chance: 60, multiplier: 1250.0, ignoreDef: 1.0 }, { name: 'Sức Mạnh Cội Nguồn', chance: 0, multiplier: 180.0 } ]
            },

            // [NEW] Map 30: Chân Lý Tối Thượng (Trùng Sinh 2000 - Cấp 200000+)
            // Chỉ số cao hơn 3% so với TS 1500
            'cltt_mob_1': {
                name: 'Chân Lý Thủ Vệ', level: 200000, rarity: 16, icon: 'fa-solid fa-book-journal-whills',
                stats: { hp: 3075164539200000, atk: 3075164539200, def: 1845098080800, spd: 48934, lck: 6150310 }, 
                skills: [{ name: 'Chân Lý Kích', chance: 0, multiplier: 480.0 }]
            },
            'cltt_mob_2': {
                name: 'Quy Tắc Chấp Pháp Giả', level: 205000, rarity: 16, icon: 'fa-solid fa-scale-balanced',
                stats: { hp: 4893812549600000, atk: 3670359680000, def: 2446906274800, spd: 54883, lck: 7274560 },
                skills: [{ name: 'Quy Tắc Trói Buộc', chance: 0, multiplier: 550.0 }]
            },
            'cltt_boss': {
                name: 'Chân Lý Chúa Tể', level: 210000, rarity: 16, icon: 'fa-solid fa-eye',
                stats: { hp: 61503328276000000, atk: 30751645392000, def: 12300653912000, spd: 73402, lck: 12300620 }, 
                skills: [ { name: 'Chân Lý Tuyệt Đối', chance: 60, multiplier: 1300.0, ignoreDef: 1.0 }, { name: 'Phá Vỡ Quy Tắc', chance: 0, multiplier: 200.0 } ]
            },

            // [NEW] Map 31: Thiên Ngoại Hư Không (Trùng Sinh 3000 - Cấp 220000+)
            // Chỉ số cao hơn 2% so với TS 2000
            'tnhk_mob_1': {
                name: 'Hư Không Du Thần', level: 220000, rarity: 16, icon: 'fa-solid fa-user-astronaut',
                stats: { hp: 3136667829984000, atk: 3136667829984, def: 1881999962416, spd: 49912, lck: 6273316 }, 
                skills: [{ name: 'Hư Không Bộ', chance: 0, multiplier: 500.0 }]
            },
            'tnhk_mob_2': {
                name: 'Thiên Ngoại Tà Linh', level: 225000, rarity: 16, icon: 'fa-solid fa-ghost',
                stats: { hp: 4991688800592000, atk: 3743766548320, def: 2495844321796, spd: 55980, lck: 7420050 },
                skills: [{ name: 'Tà Linh Phệ', chance: 0, multiplier: 580.0 }]
            },
            'tnhk_boss': {
                name: 'Thiên Ngoại Chúa Tể', level: 230000, rarity: 16, icon: 'fa-solid fa-meteor',
                stats: { hp: 62733394841520000, atk: 31366678299840, def: 12546666990400, spd: 74870, lck: 12546630 }, 
                skills: [ { name: 'Vũ Trụ Sụp Đổ', chance: 60, multiplier: 1350.0, ignoreDef: 1.0 }, { name: 'Tinh Hà Diệt Tuyệt', chance: 0, multiplier: 220.0 } ]
            },

            // [NEW] Map 32: Hồng Mông Khởi Nguyên (Trùng Sinh 5000 - Cấp 250000+)
            // Chỉ số cao hơn 2% so với TS 3000
            'hmkn_mob_1': {
                name: 'Hồng Mông Ma Thần', level: 250000, rarity: 16, icon: 'fa-solid fa-dragon',
                stats: { hp: 3199401186583680, atk: 3199401186583, def: 1919639943894, spd: 50910, lck: 6398782 }, 
                skills: [{ name: 'Hồng Mông Kích', chance: 0, multiplier: 550.0 }]
            },
            'hmkn_mob_2': {
                name: 'Khởi Nguyên Chi Linh', level: 255000, rarity: 16, icon: 'fa-solid fa-atom',
                stats: { hp: 5091522576610440, atk: 3818641880966, def: 2545761254302, spd: 57099, lck: 7568451 },
                skills: [{ name: 'Khởi Nguyên Lực', chance: 0, multiplier: 600.0 }]
            },
            'hmkn_boss': {
                name: 'Hồng Mông Chí Tôn', level: 260000, rarity: 16, icon: 'fa-solid fa-sun',
                stats: { hp: 63988062738350400, atk: 31994011865836, def: 12797600329420, spd: 76367, lck: 12797562 }, 
                skills: [ { name: 'Vạn Vật Sinh Diệt', chance: 60, multiplier: 1400.0, ignoreDef: 1.0 }, { name: 'Khai Thiên Tịch Địa', chance: 0, multiplier: 250.0 } ]
            },

            // [NEW] Map 33: Vạn Cổ Bất Diệt (Trùng Sinh 7500 - Cấp 300000+)
            // Chỉ số cao hơn 2% so với TS 5000
            'vcbd_mob_1': {
                name: 'Vạn Cổ Chiến Hồn', level: 300000, rarity: 16, icon: 'fa-solid fa-ghost',
                stats: { hp: 3263389210315353, atk: 3263389210315, def: 1958032743572, spd: 51928, lck: 6526757 }, 
                skills: [{ name: 'Chiến Ý Bất Diệt', chance: 0, multiplier: 580.0 }]
            },
            'vcbd_mob_2': {
                name: 'Bất Diệt Cốt', level: 305000, rarity: 16, icon: 'fa-solid fa-skull',
                stats: { hp: 5193353029192648, atk: 3895014718585, def: 2596676307998, spd: 58241, lck: 7719820 },
                skills: [{ name: 'Cốt Gai', chance: 0, multiplier: 630.0 }]
            },
            'vcbd_boss': {
                name: 'Vạn Cổ Bất Diệt Tôn', level: 310000, rarity: 16, icon: 'fa-solid fa-hourglass-end',
                stats: { hp: 65267823993117408, atk: 32633892103152, def: 13053560336216, spd: 77894, lck: 13053513 }, 
                skills: [ { name: 'Thời Gian Phong Ấn', chance: 60, multiplier: 1500.0, ignoreDef: 1.0 }, { name: 'Vạn Cổ Trường Tồn', chance: 0, multiplier: 280.0 } ]
            },

            // [NEW] Map 34: Thiên Địa Chung Cực (Trùng Sinh 10000 - Cấp 350000+)
            // Chỉ số cao hơn 2% so với TS 7500
            'tdcc_mob_1': {
                name: 'Chung Cực Thủ Vệ', level: 350000, rarity: 16, icon: 'fa-solid fa-shield-halved',
                stats: { hp: 3328656994521660, atk: 3328656994521, def: 1997194196712, spd: 52966, lck: 6657312 }, 
                skills: [{ name: 'Chung Cực Trảm', chance: 0, multiplier: 600.0 }]
            },
            'tdcc_mob_2': {
                name: 'Hư Vô Ảnh', level: 355000, rarity: 16, icon: 'fa-solid fa-ghost',
                stats: { hp: 5297220089776500, atk: 3972915067332, def: 2648610044888, spd: 59405, lck: 7874216 },
                skills: [{ name: 'Hư Vô Phệ', chance: 0, multiplier: 650.0 }]
            },
            'tdcc_boss': {
                name: 'Thiên Địa Chúa Tể', level: 360000, rarity: 16, icon: 'fa-solid fa-globe',
                stats: { hp: 66573180472979756, atk: 33286569945216, def: 13314627978086, spd: 79451, lck: 13314583 }, 
                skills: [ { name: 'Thiên Địa Diệt Tuyệt', chance: 60, multiplier: 1600.0, ignoreDef: 1.0 }, { name: 'Chung Yên', chance: 0, multiplier: 300.0 } ]
            },

            // [NEW] Map 35: Hỗn Độn Vô Thượng (Trùng Sinh 15000 - Cấp 400000+)
            // Chỉ số cao hơn 2% so với TS 10000
            'hdvt_mob_1': {
                name: 'Vô Thượng Ảnh', level: 400000, rarity: 16, icon: 'fa-solid fa-user-secret',
                stats: { hp: 3395230134426093, atk: 3395230134426, def: 2037138080656, spd: 54025, lck: 6790458 }, 
                skills: [{ name: 'Vô Thượng Kích', chance: 0, multiplier: 650.0 }]
            },
            'hdvt_mob_2': {
                name: 'Hỗn Độn Ma Linh', level: 405000, rarity: 16, icon: 'fa-solid fa-pastafarianism',
                stats: { hp: 5403164491572030, atk: 4052373368678, def: 2701582245785, spd: 60593, lck: 8031700 },
                skills: [{ name: 'Hỗn Độn Phệ', chance: 0, multiplier: 700.0 }]
            },
            'hdvt_boss': {
                name: 'Hỗn Độn Vô Thượng Tôn', level: 410000, rarity: 16, icon: 'fa-solid fa-crown',
                stats: { hp: 67904644082439351, atk: 33952301344260, def: 13580920537704, spd: 81040, lck: 13580874 }, 
                skills: [ { name: 'Vô Thượng Phán Quyết', chance: 60, multiplier: 1700.0, ignoreDef: 1.0 }, { name: 'Tịch Diệt', chance: 0, multiplier: 350.0 } ]
            },

            // [NEW] Map 36: Chân Ngã Độc Tôn (Trùng Sinh 20000 - Cấp 450000+)
            // Chỉ số cao hơn 2% so với TS 15000
            'cndt_mob_1': {
                name: 'Tâm Ma Ảnh', level: 450000, rarity: 16, icon: 'fa-solid fa-user-ninja',
                stats: { hp: 3463134737114614, atk: 3463134737114, def: 2077880842268, spd: 55105, lck: 6926267 }, 
                skills: [{ name: 'Ảnh Sát', chance: 0, multiplier: 670.0 }]
            },
            'cndt_mob_2': {
                name: 'Chấp Niệm Linh', level: 455000, rarity: 16, icon: 'fa-solid fa-brain',
                stats: { hp: 5511227781403470, atk: 4133420836052, def: 2755613890701, spd: 61804, lck: 8192334 },
                skills: [{ name: 'Niệm Lực', chance: 0, multiplier: 720.0 }]
            },
            'cndt_boss': {
                name: 'Chân Ngã Độc Tôn', level: 460000, rarity: 16, icon: 'fa-solid fa-user-astronaut',
                stats: { hp: 69262736964088138, atk: 34631368482044, def: 13852547392817, spd: 82660, lck: 13852491 }, 
                skills: [ { name: 'Duy Ngã Độc Tôn', chance: 60, multiplier: 1800.0, ignoreDef: 1.0 }, { name: 'Vô Ngã', chance: 0, multiplier: 380.0 } ]
            },

            // [NEW] Map 37: Vạn Kiếp Luân Hồi (Trùng Sinh 30000 - Cấp 500000+)
            // Chỉ số cao hơn 2% so với TS 20000
            'vklh_mob_1': {
                name: 'Luân Hồi Ảnh', level: 500000, rarity: 16, icon: 'fa-solid fa-spinner',
                stats: { hp: 3532397484536906, atk: 3532397484536, def: 2119438490721, spd: 56207, lck: 7064792 }, 
                skills: [{ name: 'Luân Hồi Kiếp', chance: 0, multiplier: 690.0 }]
            },
            'vklh_mob_2': {
                name: 'Kiếp Nạn Chi Chủ', level: 505000, rarity: 16, icon: 'fa-solid fa-bolt',
                stats: { hp: 5621452337031539, atk: 4216089252773, def: 2810726168515, spd: 63040, lck: 8356180 },
                skills: [{ name: 'Đại Kiếp', chance: 0, multiplier: 740.0 }]
            },
            'vklh_boss': {
                name: 'Vạn Kiếp Chí Tôn', level: 510000, rarity: 16, icon: 'fa-solid fa-infinity',
                stats: { hp: 70647991703369900, atk: 35323995851684, def: 14129598340673, spd: 84313, lck: 14129540 }, 
                skills: [ { name: 'Vạn Kiếp Bất Phục', chance: 60, multiplier: 1900.0, ignoreDef: 1.0 }, { name: 'Luân Hồi Diệt', chance: 0, multiplier: 400.0 } ]
            },

            // [NEW] Map 38: Chân Không Tuyệt Đối (Trùng Sinh 50000 - Cấp 600000+)
            // Chỉ số cao hơn 2% so với TS 30000
            'cktd_mob_1': {
                name: 'Hư Ảnh Vô Danh', level: 600000, rarity: 16, icon: 'fa-solid fa-user-slash',
                stats: { hp: 3603045434227644, atk: 3603045434227, def: 2161827260535, spd: 57331, lck: 7206087 }, 
                skills: [{ name: 'Vô Hình Kích', chance: 0, multiplier: 710.0 }]
            },
            'cktd_mob_2': {
                name: 'Tịch Diệt Sứ', level: 605000, rarity: 16, icon: 'fa-solid fa-eraser',
                stats: { hp: 5733881383772169, atk: 4300411037828, def: 2866940691885, spd: 64300, lck: 8523303 },
                skills: [{ name: 'Xóa Sổ', chance: 0, multiplier: 760.0 }]
            },
            'cktd_boss': {
                name: 'Chân Không Chi Chủ', level: 610000, rarity: 16, icon: 'fa-solid fa-circle',
                stats: { hp: 72060951537437298, atk: 36030454342276, def: 14412190306868, spd: 85999, lck: 14412120 }, 
                skills: [ { name: 'Tuyệt Đối Hư Vô', chance: 60, multiplier: 2000.0, ignoreDef: 1.0 }, { name: 'Chân Không Phá', chance: 0, multiplier: 420.0 } ]
            },

            // [NEW] Map 39: Vô Tận Chi Nguyên (Trùng Sinh 100000 - Cấp 1000000+)
            // Chỉ số cao hơn 2% so với TS 50000
            'vtcn_mob_1': {
                name: 'Nguyên Sơ Hạt', level: 1000000, rarity: 16, icon: 'fa-solid fa-atom',
                stats: { hp: 3675106342912196, atk: 3675106342912, def: 2205063805747, spd: 58477, lck: 7350208 }, 
                skills: [{ name: 'Phân Tách', chance: 0, multiplier: 730.0 }]
            },
            'vtcn_mob_2': {
                name: 'Thời Gian Chi Sa', level: 1005000, rarity: 16, icon: 'fa-solid fa-hourglass',
                stats: { hp: 5848559011447612, atk: 4386419258585, def: 2924279505723, spd: 65586, lck: 8693769 },
                skills: [{ name: 'Thời Gian Trôi', chance: 0, multiplier: 780.0 }]
            },
            'vtcn_boss': {
                name: 'Đấng Sáng Tạo Tối Cao', level: 1010000, rarity: 16, icon: 'fa-solid fa-hand-holding-medical',
                stats: { hp: 73502170568186043, atk: 36751085284093, def: 14700434113637, spd: 87718, lck: 14700362 }, 
                skills: [ { name: 'Vô Tận Sáng Thế', chance: 60, multiplier: 2050.0, ignoreDef: 1.0 }, { name: 'Khởi Nguyên Chi Quang', chance: 0, multiplier: 450.0 } ]
            },

            // [NEW] Map 40: Vô Cực Chân Giới (Trùng Sinh 250000 - Cấp 1500000+)
            // Chỉ số cao hơn 2% so với TS 100000
            'vccg_mob_1': {
                name: 'Hư Không Thôn Phệ Giả', level: 1500000, rarity: 16, icon: 'fa-solid fa-black-hole',
                stats: { hp: 3748608469770439, atk: 3748608469770, def: 2249165081862, spd: 59646, lck: 7497212 }, 
                skills: [{ name: 'Thôn Phệ Vạn Vật', chance: 0, multiplier: 750.0 }]
            },
            'vccg_mob_2': {
                name: 'Vô Thượng Pháp Ảnh', level: 1505000, rarity: 16, icon: 'fa-solid fa-user-secret',
                stats: { hp: 5965530191677364, atk: 4474147643756, def: 2982765095837, spd: 66897, lck: 8867644 },
                skills: [{ name: 'Pháp Tắc Hủy Diệt', chance: 0, multiplier: 800.0 }]
            },
            'vccg_boss': {
                name: 'Vô Cực Chân Chủ', level: 1510000, rarity: 16, icon: 'fa-solid fa-infinity',
                stats: { hp: 74972213979549763, atk: 37486102352274, def: 14994440940909, spd: 89472, lck: 14994369 }, 
                skills: [ { name: 'Vô Cực Chi Nộ', chance: 60, multiplier: 2100.0, ignoreDef: 1.0 }, { name: 'Chân Lý Tối Thượng', chance: 0, multiplier: 480.0 } ]
            },

            // [NEW] Map 41: Thần Thoại Kỷ Nguyên (Trùng Sinh 500,000 - Cấp 2,000,000+)
            // Chỉ số cao hơn 2% so với TS 250,000
            'ttkn_mob_1': {
                name: 'Kỷ Nguyên Chiến Binh', level: 2000000, rarity: 16, icon: 'fa-solid fa-khanda',
                stats: { hp: 3823580639165847, atk: 3823580639165, def: 2294148383499, spd: 60839, lck: 7647156 }, 
                skills: [{ name: 'Trảm Phá Kỷ Nguyên', chance: 0, multiplier: 765.0 }]
            },
            'ttkn_mob_2': {
                name: 'Thần Thoại Chi Ảnh', level: 2005000, rarity: 16, icon: 'fa-solid fa-dragon',
                stats: { hp: 6084840795510911, atk: 4563629596631, def: 3042420397755, spd: 68235, lck: 9044997 },
                skills: [{ name: 'Hơi Thở Thần Thoại', chance: 0, multiplier: 816.0 }]
            },
            'ttkn_boss': {
                name: 'Kỷ Nguyên Chúa Tể', level: 2010000, rarity: 16, icon: 'fa-solid fa-crown',
                stats: { hp: 76471658259140758, atk: 38235822822729, def: 15294329759727, spd: 91261, lck: 15294256 }, 
                skills: [ { name: 'Kỷ Nguyên Hủy Diệt', chance: 60, multiplier: 2142.0, ignoreDef: 1.0 }, { name: 'Tái Thiết Kỷ Nguyên', chance: 0, multiplier: 490.0 } ]
            },

            // [NEW] Map 42: Chí Tôn Vô Thượng (Trùng Sinh 1,000,000 - Cấp 5,000,000+)
            // Chỉ số cao hơn 2% so với TS 500,000
            'ctvt_mob_1': {
                name: 'Vô Thượng Chiến Hồn', level: 5000000, rarity: 16, icon: 'fa-solid fa-khanda',
                stats: { hp: 3900052251949163, atk: 3900052251949, def: 2340031351169, spd: 62055, lck: 7800100 }, 
                skills: [{ name: 'Vô Thượng Trảm', chance: 0, multiplier: 780.0 }]
            },
            'ctvt_mob_2': {
                name: 'Chí Tôn Ảnh Vệ', level: 5005000, rarity: 16, icon: 'fa-solid fa-user-ninja',
                stats: { hp: 6206537611421129, atk: 4654902188563, def: 3103268805709, spd: 69600, lck: 9225896 },
                skills: [{ name: 'Ảnh Sát', chance: 0, multiplier: 832.0 }]
            },
            'ctvt_boss': {
                name: 'Vô Thượng Chí Tôn', level: 5010000, rarity: 16, icon: 'fa-solid fa-crown',
                stats: { hp: 78001091424323573, atk: 39000552737583, def: 15600219554921, spd: 93086, lck: 15600135 }, 
                skills: [ { name: 'Chí Tôn Uy Áp', chance: 60, multiplier: 2185.0, ignoreDef: 1.0 }, { name: 'Vạn Thế Độc Tôn', chance: 0, multiplier: 500.0 } ]
            },
        };
        
        const DUNGEONS_DB = {
            'map01': { 
                name: 'Thôn Tân Thủ', rarity: 1, levelRange: '1-10', unlockCost: 0,
                enemies: ['mob01', 'mob02'], 
                rewards: { gold: [500, 1500], xp: [20, 40] } // 1%
            },
            // [NEW] Tiểu Ngư Thôn
            'map_ngu_thon': {
                name: 'Tiểu Ngư Thôn', rarity: 2, levelRange: '5-15', unlockCost: 25000,
                enemies: ['mob_ngu_thon_1', 'mob_ngu_thon_2'],
                rewards: { gold: [1000, 2500], xp: [50, 100], equipChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } // 1.1%
            },
            // [END NEW]
            // [NEW] Definitions for new maps
            'map_to_chau': { 
                name: 'Tô Châu', rarity: 3, levelRange: '15-25', unlockCost: 100000, // Cost is irrelevant as it's unlocked via changelog
                enemies: ['mob_to_chau_1', 'mob_to_chau_2'], 
                rewards: { gold: [3000, 5000], xp: [120, 200], equipChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_kinh_thanh': { 
                name: 'Kinh Thành', rarity: 3, levelRange: '25-35', unlockCost: 300000,
                enemies: ['mob_kinh_thanh_1', 'mob_kinh_thanh_2'], 
                rewards: { gold: [5000, 8000], xp: [300, 500], equipChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_thuc_son': { 
                name: 'Thục Sơn', rarity: 6, levelRange: '60-70', unlockCost: 6000000,
                enemies: ['mob_thuc_son_1', 'mob_thuc_son_2'], 
                rewards: { gold: [18000, 30000], xp: [1500, 2400], equipChance: 5, materialDrop: { chance: 5, amount: [100, 300] }, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_ngoc_hu': { 
                name: 'Ngọc Hư Thành', rarity: 7, levelRange: '90-100', unlockCost: 9000000,
                enemies: ['mob_ngoc_hu_1', 'mob_ngoc_hu_2'], 
                rewards: { gold: [22000, 35000], xp: [1700, 2600], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_hu_thien': { 
                name: 'Hư Thiên Điện', rarity: 8, levelRange: '120-130', unlockCost: 15000000,
                enemies: ['mob_hu_thien_1', 'mob_hu_thien_2'], 
                rewards: { gold: [30000, 50000], xp: [2500, 4000], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            // [NEW] Definitions for 4 new maps
            'map_dai_ly': { 
                name: 'Đại Lý', rarity: 4, levelRange: '35-45', unlockCost: 750000,
                enemies: ['mob_dai_ly_1', 'mob_dai_ly_2'], 
                rewards: { gold: [8000, 13000], xp: [700, 1100], equipChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_thap_nhi_cung': { 
                name: 'Thập Nhị Cung', rarity: 6, levelRange: '70-80', unlockCost: 7000000,
                enemies: ['mob_tnc_1', 'mob_tnc_2'], 
                rewards: { gold: [20000, 33000], xp: [1700, 2600], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_luc_dao': { 
                name: 'Lục Đạo Luân Hồi', rarity: 7, levelRange: '100-110', unlockCost: 10000000,
                enemies: ['mob_ldlh_1', 'mob_ldlh_2'], 
                rewards: { gold: [26000, 40000], xp: [2000, 3000], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_quan_long': { 
                name: 'Quần Long Tranh Bá', rarity: 8, levelRange: '130-140', unlockCost: 17000000,
                enemies: ['mob_qltb_1', 'mob_qltb_2'], 
                rewards: { gold: [35000, 55000], xp: [2800, 4500], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            // [NEW] Definitions for 6 new maps
            'map_tchh': { 
                name: 'Thái Cổ Hồng Hoang', rarity: 9, levelRange: '140-150', unlockCost: 20000000,
                enemies: ['mob_tchh_1', 'mob_tchh_2'], 
                rewards: { gold: [40000, 60000], xp: [3500, 5500], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_ttdt': { 
                name: 'Tam Thanh Diệt Thế', rarity: 9, levelRange: '150-160', unlockCost: 25000000,
                enemies: ['mob_ttdt_1', 'mob_ttdt_2'], 
                rewards: { gold: [45000, 65000], xp: [4200, 6200], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_ptdc': { 
                name: 'Phong Thần Đại Chiến', rarity: 9, levelRange: '160-170', unlockCost: 30000000,
                enemies: ['mob_ptdc_1', 'mob_ptdc_2'], 
                rewards: { gold: [50000, 70000], xp: [5000, 7000], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_vctp': { 
                name: 'Viễn Cổ Tranh Phong', rarity: 10, levelRange: '170-180', unlockCost: 35000000,
                enemies: ['mob_vctp_1', 'mob_vctp_2'], 
                rewards: { gold: [55000, 75000], xp: [6000, 8000], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_tntg': { 
                name: 'Thống Nhất Tam Giới', rarity: 10, levelRange: '180-190', unlockCost: 40000000,
                enemies: ['mob_tntg_1', 'mob_tntg_2'], 
                rewards: { gold: [60000, 80000], xp: [7000, 9000], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            'map_tkdv': { 
                name: 'Tinh Không Đại Vực', rarity: 10, levelRange: '190-200', unlockCost: 50000000,
                enemies: ['mob_tkdv_1', 'mob_tkdv_2'], 
                rewards: { gold: [65000, 85000], xp: [8000, 10000], equipChance: 5, materialDropChance: 5, linhHonThachDrop: { chance: 5, amount: [10, 30] } } 
            },
            // [END NEW]
            'map02': { 
                name: 'Tương Dương Thành', rarity: 2, levelRange: '10-20', unlockCost: 50000,
                enemies: ['mob03', 'mob04'], boss: 'boss01',
                rewards: { gold: [2000, 4000], xp: [80, 160], equipChance: 5 } // 1.2%
            },
            'map03': { 
                name: 'Phục Ngưu Sơn', rarity: 3, levelRange: '20-30', unlockCost: 200000,
                enemies: ['mob05', 'mob06'],
                rewards: { gold: [4000, 7000], xp: [200, 400], equipChance: 5 } // 1.5%
            },
            // [NEW]
            'map04': { 
                name: 'Thanh Thành Sơn', rarity: 4, levelRange: '30-40', unlockCost: 500000,
                enemies: ['mob07', 'mob08'], boss: 'boss02',
                rewards: { gold: [6000, 10000], xp: [650, 1000], equipChance: 5 } // 1.8%
            },
            'map05': { 
                name: 'Núi Võ Đang', rarity: 5, levelRange: '40-50', unlockCost: 1000000,
                enemies: ['mob09', 'mob10'], boss: 'boss03',
                rewards: { gold: [10000, 15000], xp: [1080, 1600], equipChance: 5 } // 2%
            },
            // [NEW] Map for Upgrade Stones
            'map06': { 
                name: 'Cán Viên Động', rarity: 6, levelRange: '50-60', unlockCost: 5000000,
                enemies: ['mob11', 'mob12'], boss: 'boss04',
                rewards: { 
                    gold: [15000, 25000], 
                    xp: [1200, 2000], 
                    // Special rewards: Higher chance for materials, lower for equip
                    equipChance: 5, // Lower equip chance
                    materialDropChance: 5 // 35% chance to drop *a* stone per kill
                } 
            },
            // [NEW] Hoa Son Luan Kiem - Boss Only Map
             'map07': { 
                name: 'Hoa Sơn Luận Kiếm', rarity: 8, levelRange: '130-140', unlockCost: 20000000, // [MODIFIED]
                enemies: [], // No regular enemies
                boss: 'boss05', // Only this boss
                rewards: { 
                    gold: [100000, 200000], 
                    xp: [3000, 3500], 
                    equipChance: 5 // 5% chance for an equipment drop
                    // No material drops specified, only equipment
                } 
            },
            // [NEW]
            'map08': { 
                name: 'Kiếm Các', rarity: 7, levelRange: '100-120', unlockCost: 10000000, // [MODIFIED]
                enemies: ['mob13', 'mob14'],
                rewards: { 
                    gold: [25000, 40000], 
                    xp: [1800, 2800], 
                    equipChance: 5, 
                    materialDropChance: 5 // Vẫn rớt đá
                } 
            },
            // [NEW]
            'map09': { 
                name: 'Đỉnh Hoa Sơn', rarity: 9, levelRange: '130-150', unlockCost: 20000000, // [MODIFIED]
                enemies: ['mob15', 'mob16'], 
                boss: 'boss05', // Tái đấu Độc Cô Cầu Bại
                rewards: { 
                    gold: [40000, 60000], 
                    xp: [3500, 5000], 
                    equipChance: 5, 
                    materialDropChance: 5 
                } 
            },
            // [NEW] Level 200 Map
            'map10': {
                name: 'Vô Tận Mộng Cảnh', rarity: 10, levelRange: '200+', unlockCost: 100000000,
                enemies: ['boss_sg_01', 'boss_sg_02', 'boss_sg_03', 'boss_sg_04', 'boss_sg_05'], // Only bosses
                boss: null, // No single dedicated boss, picks randomly from enemies list
                rewards: {
                    gold: [500000, 1000000],
                    xp: [80000, 150000],
                    equipChance: 5, // 60% chance for equipment drop
                    materialDropChance: 5 // 50% chance for high-tier stone
                    // TODO: Could add specific logic in endCombat to guarantee mythic drops or high stones
                }
            },
            // [NEW] Map Lvl 250+
            'map_phonglangdo': {
                name: 'Phong Lăng Độ', rarity: 10, levelRange: '250-260', unlockCost: 200000000,
                enemies: ['mob_phonglang_1', 'mob_phonglang_2'],
                boss: 'boss_phonglang_1',
                rewards: {
                    gold: [1000000, 2000000],
                    xp: [200000, 300000],
                    equipChance: 5, // 65% chance
                    materialDropChance: 5, // 50% chance
                    linhHonThachDrop: { chance: 5, amount: [50, 150] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 300+
            'map_vuot_ai': {
                name: 'Vượt Ải Nhiếp Nhí Trần', rarity: 10, levelRange: '300-310', unlockCost: 500000000,
                enemies: ['mob_vuot_ai_1', 'mob_vuot_ai_2'],
                boss: 'boss_vuot_ai_1',
                rewards: {
                    gold: [2500000, 4000000],
                    xp: [400000, 600000],
                    equipChance: 5, // 70% chance
                    materialDropChance: 5, // 55% chance
                    linhHonThachDrop: { chance: 5, amount: [100, 200] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 350+ (ID mới để tránh trùng lặp)
            'map_luc_dao_350': {
                name: 'Lục Đạo Luân Hồi', rarity: 10, levelRange: '350-380', unlockCost: 1000000000,
                enemies: ['mob_ldlh2_1', 'mob_ldlh2_2', 'mob_ldlh2_3', 'mob_ldlh2_4', 'mob_ldlh2_5'],
                boss: 'boss_ldlh2_1',
                rewards: {
                    gold: [5000000, 8000000],
                    xp: [700000, 1000000],
                    equipChance: 5, // 75% chance
                    materialDropChance: 5, // 60% chance
                    linhHonThachDrop: { chance: 5, amount: [150, 300] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 400+ (ID mới để tránh trùng lặp)
            'map_thap_nhi_cung_400': {
                name: 'Thập Nhị Cung (Cao Cấp)', rarity: 10, levelRange: '400-430', unlockCost: 2000000000,
                // [MODIFIED] Bổ sung 6 con giáp còn lại vào danh sách quái
                enemies: ['mob_12cg_ti', 'mob_12cg_suu', 'mob_12cg_dan', 'mob_12cg_ngo', 'mob_12cg_than', 'mob_12cg_mao', 'mob_12cg_ty', 'mob_12cg_mui', 'mob_12cg_dau', 'mob_12cg_tuat', 'mob_12cg_hoi'],
                boss: 'boss_12cg_thin',
                rewards: {
                    gold: [10000000, 15000000],
                    xp: [1200000, 1800000],
                    equipChance: 5, // 80% chance
                    materialDropChance: 5, // 65% chance
                    linhHonThachDrop: { chance: 5, amount: [200, 400] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 500+
            'map_dinh_phong_500': {
                name: 'Đỉnh Phong Đối Quyết', rarity: 10, levelRange: '500-550', unlockCost: 5000000000, // 5 Tỷ
                enemies: ['mob_dpdq_1', 'mob_dpdq_2', 'mob_dpdq_3', 'mob_dpdq_4', 'mob_dpdq_5'],
                boss: 'boss_dpdq_1',
                rewards: {
                    gold: [25000000, 40000000],
                    xp: [3000000, 5000000],
                    equipChance: 5, // 85% chance
                    materialDropChance: 5, // 70% chance
                    linhHonThachDrop: { chance: 5, amount: [300, 500] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 650+
            'map_vlmc_650': {
                name: 'Khiêu Chiến Võ Lâm Minh Chủ', rarity: 10, levelRange: '650-680', unlockCost: 10000000000, // 10 Tỷ
                enemies: ['mob_vlmc_1', 'mob_vlmc_2', 'mob_vlmc_3', 'mob_vlmc_4', 'mob_vlmc_5'],
                boss: 'boss_vlmc_1',
                rewards: {
                    gold: [50000000, 80000000],
                    xp: [7000000, 10000000],
                    equipChance: 5, // 90% chance
                    materialDropChance: 5, // 80% chance
                    linhHonThachDrop: { chance: 5, amount: [500, 1000] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 750+
            'map_tanlang_750': {
                name: 'Mê Cung Tần Lăng', rarity: 10, levelRange: '750-780', unlockCost: 20000000000, // 20 Tỷ
                enemies: ['mob_tanlang_1', 'mob_tanlang_2', 'mob_tanlang_3', 'mob_tanlang_4', 'mob_tanlang_5'],
                boss: 'boss_tanlang_1',
                rewards: {
                    gold: [100000000, 150000000],
                    xp: [12000000, 18000000],
                    equipChance: 5, // 95% chance
                    materialDropChance: 5, // 85% chance
                    linhHonThachDrop: { chance: 5, amount: [700, 1200] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 850+
            'map_cttd_850': {
                name: 'Cửu Thiên Thần Điện', rarity: 10, levelRange: '850-880', unlockCost: 50000000000, // 50 Tỷ
                enemies: ['mob_cttd_1', 'mob_cttd_2', 'mob_cttd_3', 'mob_cttd_4', 'mob_cttd_5'],
                boss: 'boss_cttd_1',
                rewards: {
                    gold: [200000000, 300000000],
                    xp: [20000000, 30000000],
                    equipChance: 5, // 95% chance
                    materialDropChance: 5, // 90% chance
                    linhHonThachDrop: { chance: 5, amount: [1000, 1500] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 950+
            'map_ummu_950': {
                name: 'U Minh Ma Uyên', rarity: 10, levelRange: '950-980', unlockCost: 100000000000, // 100 Tỷ
                enemies: ['mob_ummu_1', 'mob_ummu_2', 'mob_ummu_3', 'mob_ummu_4', 'mob_ummu_5'],
                boss: 'boss_ummu_1',
                rewards: {
                    gold: [400000000, 600000000],
                    xp: [40000000, 60000000],
                    equipChance: 5, // 95% chance
                    materialDropChance: 5, // 95% chance
                    linhHonThachDrop: { chance: 5, amount: [1500, 2500] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 1150+
            'map_trutien_1150': {
                name: 'Tru Tiên Thánh Vực', rarity: 10, levelRange: '1150-1180', unlockCost: 200000000000, // 200 Tỷ
                enemies: ['mob_tttv_1', 'mob_tttv_2', 'mob_tttv_3', 'mob_tttv_4', 'mob_tttv_5'],
                boss: 'boss_tttv_1',
                rewards: {
                    gold: [800000000, 1200000000],
                    xp: [80000000, 120000000],
                    equipChance: 5, // 95% chance
                    materialDropChance: 5, // 95% chance
                    linhHonThachDrop: { chance: 5, amount: [2000, 3000] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 1450+
            'map_phithanglo_1450': {
                name: 'Phi Thăng Lộ', rarity: 10, levelRange: '1450-1480', unlockCost: 500000000000, // 500 Tỷ
                enemies: ['mob_ptl_1', 'mob_ptl_2', 'mob_ptl_3', 'mob_ptl_4', 'mob_ptl_5'],
                boss: 'boss_ptl_1',
                rewards: {
                    gold: [1500000000, 2000000000],
                    xp: [150000000, 200000000],
                    equipChance: 5, // 95% chance
                    materialDropChance: 5, // 95% chance
                    linhHonThachDrop: { chance: 5, amount: [3000, 5000] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 1850+
            'map_cctk_1850': {
                name: 'Chung Cực Thiên Khung', rarity: 10, levelRange: '1850-1880', unlockCost: 1000000000000, // 1000 Tỷ
                enemies: ['mob_cctk_1', 'mob_cctk_2', 'mob_cctk_3', 'mob_cctk_4', 'mob_cctk_5'],
                boss: 'boss_cctk_1',
                rewards: {
                    gold: [2500000000, 4000000000],
                    xp: [250000000, 400000000],
                    equipChance: 5, // 95% chance
                    materialDropChance: 05, // 95% chance
                    linhHonThachDrop: { chance: 5, amount: [5000, 8000] } // Cao hơn
                }
            },
            // [NEW] Map Lvl 2200+ (Hỗn Độn Tinh Hải)
            'map_hdth_2200': {
                name: 'Hỗn Độn Tinh Hải', rarity: 10, levelRange: '2200-2400', unlockCost: 2500000000000, // 2500 Tỷ
                enemies: ['mob_hdth_1', 'mob_hdth_2'],
                boss: 'boss_hdth_1',
                rewards: {
                    gold: [3500000000, 5000000000],
                    xp: [350000000, 550000000],
                    equipChance: 05,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [8000, 12000] }
                }
            },
            // [MODIFIED] Map Lvl 2500+ (Sửa lại toàn bộ)
            'map_tptk_2500': {
                name: 'Thôn Phệ Tinh Không', rarity: 10, levelRange: '2500-2800', unlockCost: 5000000000000, // 5000 Tỷ
                enemies: [
                    'tptk_mob_01', 'tptk_mob_02', 'tptk_mob_03', 'tptk_mob_04', 'tptk_mob_05', 
                    'tptk_mob_06', 'tptk_mob_07', 'tptk_mob_08', 'tptk_mob_09', 'tptk_mob_10',
                    'tptk_mob_11', 'tptk_mob_12', 'tptk_mob_13', 'tptk_mob_14', 'tptk_mob_15',
                    'tptk_mob_16', 'tptk_mob_17', 'tptk_mob_18', 'tptk_mob_19'
                ],
                boss: 'tptk_boss_20',
                rewards: {
                    gold: [5000000000, 8000000000],
                    xp: [500000000, 800000000],
                    equipChance: 5, // 95% chance
                    materialDropChance: 5, // 95% chance
                    linhHonThachDrop: { chance: 5, amount: [10000, 15000] } 
                }
            },
            
            // [NEW] --- CÁC MAP MỚI SAU 2800 ---

            'map_void_abyss': {
                name: 'Vực Sâu Hư Không', rarity: 11, levelRange: '2800-3000', unlockCost: 10000000000000, // 10k Tỷ
                enemies: ['void_mob_1', 'void_mob_2'],
                boss: 'void_boss',
                rewards: {
                    gold: [10000000000, 15000000000],
                    xp: [800000000, 1200000000],
                    equipChance: 5, 
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [20000, 30000] }
                }
            },

            'map_god_tomb': {
                name: 'Thái Cổ Thần Mộ', rarity: 12, levelRange: '3000-3500', unlockCost: 50000000000000, // 50k Tỷ
                enemies: ['tomb_mob_1', 'tomb_mob_2'],
                boss: 'tomb_boss',
                rewards: {
                    gold: [20000000000, 30000000000],
                    xp: [2000000000, 3000000000],
                    equipChance: 5, 
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [40000, 60000] }
                }
            },

            'map_multiverse': {
                name: 'Đỉnh Cao Vũ Trụ', rarity: 13, levelRange: '3500+', unlockCost: 100000000000000, // 100k Tỷ
                enemies: ['multi_mob_1', 'multi_mob_2'],
                boss: 'multi_boss',
                rewards: {
                    gold: [50000000000, 100000000000],
                    xp: [5000000000, 10000000000],
                    equipChance: 5, 
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [100000, 200000] }
                }
            },

            // [NEW] --- CÁC MAP MỚI SAU CẤP 4000 ---
            
            'map_outer_heavens': {
                name: 'Thiên Ngoại Thiên', rarity: 14, levelRange: '4000-5000', unlockCost: 200000000000000, // 200k Tỷ
                enemies: ['tnt_mob_1', 'tnt_mob_2'],
                boss: 'tnt_boss',
                rewards: {
                    gold: [100000000000, 200000000000],
                    xp: [20000000000, 50000000000],
                    equipChance: 5, 
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [300000, 500000] }
                }
            },

            'map_chaos_origin': {
                name: 'Hỗn Độn Nguyên Giới', rarity: 15, levelRange: '5000-7000', unlockCost: 500000000000000, // 500k Tỷ
                enemies: ['hdng_mob_1', 'hdng_mob_2'],
                boss: 'hdng_boss',
                rewards: {
                    gold: [300000000000, 500000000000],
                    xp: [100000000000, 200000000000],
                    equipChance: 5, 
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [800000, 1000000] }
                }
            },

            'map_eternal_gate': {
                name: 'Vĩnh Hằng Chi Môn', rarity: 16, levelRange: '7000+', unlockCost: 1000000000000000, // 1 Triệu Tỷ
                enemies: ['vhcm_mob_1', 'vhcm_mob_2'],
                boss: 'vhcm_boss',
                rewards: {
                    gold: [1000000000000, 2000000000000],
                    xp: [500000000000, 1000000000000],
                    equipChance: 5, 
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [2000000, 5000000] }
                }
            },
            // [NEW] MAP MỚI
            'map_taiji_realm': {
                name: 'Thái Cực Thánh Cảnh', rarity: 16, 
                levelRange: 'Trùng Sinh 20', 
                unlockCost: 0, 
                rebirthReq: 20, 
                enemies: ['tctc_mob_1', 'tctc_mob_2'],
                boss: 'tctc_boss',
                rewards: {
                    gold: [5000000000000, 10000000000000],
                    xp: [2000000000000, 5000000000000],
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [5000000, 10000000] }
                }
            },
            // [NEW] MAP MỚI: Hư Vô Cấm Địa
            'map_void_forbidden': {
                name: 'Hư Vô Cấm Địa', rarity: 16, 
                levelRange: 'Trùng Sinh 22', 
                unlockCost: 0, 
                rebirthReq: 22, 
                enemies: ['hvcd_mob_1', 'hvcd_mob_2'],
                boss: 'hvcd_boss',
                rewards: {
                    gold: [20000000000000, 50000000000000], // 200 Tỷ - 500 Tỷ
                    xp: [10000000000000, 20000000000000], // 10k Tỷ - 20k Tỷ
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [10000000, 20000000] }
                }
            },
            // [NEW] MAP MỚI: Đạo Nguyên Thánh Cảnh
            'map_dao_origin': {
                name: 'Đạo Nguyên Thánh Cảnh', rarity: 16, 
                levelRange: 'Trùng Sinh 25', 
                unlockCost: 0, 
                rebirthReq: 25, 
                enemies: ['dnsc_mob_1', 'dnsc_mob_2'],
                boss: 'dnsc_boss',
                rewards: {
                    gold: [100000000000000, 200000000000000], // 1k Tỷ - 2k Tỷ
                    xp: [50000000000000, 100000000000000], // 50k Tỷ - 100k Tỷ
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [30000000, 50000000] }
                }
            },
            // [NEW] MAP MỚI: Hồng Mông Tiên Cảnh
            'map_hongmeng_realm': {
                name: 'Hồng Mông Tiên Cảnh', rarity: 16, 
                levelRange: 'Trùng Sinh 30', 
                unlockCost: 0, 
                rebirthReq: 30, 
                enemies: ['hmtc_mob_1', 'hmtc_mob_2'],
                boss: 'hmtc_boss',
                rewards: {
                    gold: [500000000000000, 1000000000000000], // 5k Tỷ - 10k Tỷ
                    xp: [200000000000000, 500000000000000], // 200k Tỷ - 500k Tỷ
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [50000000, 100000000] }
                }
            },
            // [NEW] MAP MỚI: Sáng Thế Thần Vực
            'map_genesis_domain': {
                name: 'Sáng Thế Thần Vực', rarity: 16, 
                levelRange: 'Trùng Sinh 35', 
                unlockCost: 0, 
                rebirthReq: 35, 
                enemies: ['sttv_mob_1', 'sttv_mob_2'],
                boss: 'sttv_boss',
                rewards: {
                    gold: [2000000000000000, 5000000000000000], // 20k Tỷ - 50k Tỷ
                    xp: [1000000000000000, 2000000000000000], // 1 Triệu Tỷ - 2 Triệu Tỷ
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [200000000, 500000000] }
                }
            },
            // [NEW] MAP MỚI: Thiên Đạo Vô Cực Giới
            'map_heavenly_dao': {
                name: 'Thiên Đạo Vô Cực Giới', rarity: 16, 
                levelRange: 'Trùng Sinh 40', 
                unlockCost: 0, 
                rebirthReq: 40, 
                enemies: ['tdvc_mob_1', 'tdvc_mob_2'],
                boss: 'tdvc_boss',
                rewards: {
                    gold: [10000000000000000, 20000000000000000], // 100k Tỷ - 200k Tỷ
                    xp: [5000000000000000, 10000000000000000], // 5 Triệu Tỷ - 10 Triệu Tỷ
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [1000000000, 2000000000] }
                }
            },
            // [NEW] MAP MỚI: Chúa Tể Vĩnh Hằng Giới
            'map_eternal_ruler': {
                name: 'Chúa Tể Vĩnh Hằng Giới', rarity: 16, 
                levelRange: 'Trùng Sinh 50', 
                unlockCost: 0, 
                rebirthReq: 50, 
                enemies: ['ctvh_mob_1', 'ctvh_mob_2'],
                boss: 'ctvh_boss',
                rewards: {
                    gold: [100000000000000000, 200000000000000000], // 1 Triệu Tỷ - 2 Triệu Tỷ
                    xp: [50000000000000000, 100000000000000000], // 50 Triệu Tỷ - 100 Triệu Tỷ
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [5000000000, 10000000000] } // 500tr - 1 Tỷ LHT
                }
            },
            // [NEW] MAP MỚI: Tinh Hà Cổ Lộ
            'map_astral_path': {
                name: 'Tinh Hà Cổ Lộ', rarity: 16, 
                levelRange: 'Trùng Sinh 60', 
                unlockCost: 0, 
                rebirthReq: 60, 
                enemies: ['thcl_mob_1', 'thcl_mob_2'],
                boss: 'thcl_boss',
                rewards: {
                    gold: [500000000000000000, 1000000000000000000], 
                    xp: [200000000000000000, 500000000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [20000000000, 50000000000] } 
                }
            },
            // [NEW] MAP MỚI: Nguyên Sơ Hỗn Mang
            'map_primordial_chaos': {
                name: 'Nguyên Sơ Hỗn Mang', rarity: 16, 
                levelRange: 'Trùng Sinh 70', 
                unlockCost: 0, 
                rebirthReq: 70, 
                enemies: ['nshm_mob_1', 'nshm_mob_2'],
                boss: 'nshm_boss',
                rewards: {
                    gold: [650000000000000000, 1300000000000000000], // +30%
                    xp: [260000000000000000, 650000000000000000], // +30%
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [30000000000, 70000000000] } 
                }
            },
            // [NEW] MAP MỚI: Vô Tận Luân Hồi
            'map_endless_samsara': {
                name: 'Vô Tận Luân Hồi', rarity: 16, 
                levelRange: 'Trùng Sinh 80', 
                unlockCost: 0, 
                rebirthReq: 80, 
                enemies: ['vtlh_mob_1', 'vtlh_mob_2'],
                boss: 'vtlh_boss',
                rewards: {
                    gold: [850000000000000000, 1700000000000000000], 
                    xp: [340000000000000000, 850000000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [40000000000, 90000000000] } 
                }
            },
            // [NEW] MAP MỚI: Chư Thần Hoàng Hôn
            'map_twilight_gods': {
                name: 'Chư Thần Hoàng Hôn', rarity: 16, 
                levelRange: 'Trùng Sinh 90', 
                unlockCost: 0, 
                rebirthReq: 90, 
                enemies: ['cthh_mob_1', 'cthh_mob_2'],
                boss: 'cthh_boss',
                rewards: {
                    gold: [1100000000000000000, 2200000000000000000], 
                    xp: [440000000000000000, 1100000000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [52000000000, 110000000000] } 
                }
            },
            // [NEW] MAP MỚI: Kỷ Nguyên Hủy Diệt
            'map_era_of_destruction': {
                name: 'Kỷ Nguyên Hủy Diệt', rarity: 16, 
                levelRange: 'Trùng Sinh 100', 
                unlockCost: 0, 
                rebirthReq: 100, 
                enemies: ['knhd_mob_1', 'knhd_mob_2'],
                boss: 'knhd_boss',
                rewards: {
                    gold: [1320000000000000000, 2640000000000000000], 
                    xp: [528000000000000000, 1320000000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [62400000000, 132000000000] } 
                }
            },
            // [NEW] MAP MỚI: Hỗn Nguyên Thánh Cảnh
            'map_primordial_saint': {
                name: 'Hỗn Nguyên Thánh Cảnh', rarity: 16, 
                levelRange: 'Trùng Sinh 125', 
                unlockCost: 0, 
                rebirthReq: 125, 
                enemies: ['hnsc_mob_1', 'hnsc_mob_2'],
                boss: 'hnsc_boss',
                rewards: {
                    gold: [1518000000000000000, 3036000000000000000], 
                    xp: [607200000000000000, 1518000000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [72000000000, 152000000000] } 
                }
            },
            // [NEW] MAP MỚI: Thái Hư Cổ Giới
            'map_ancient_void': {
                name: 'Thái Hư Cổ Giới', rarity: 16, 
                levelRange: 'Trùng Sinh 150', 
                unlockCost: 0, 
                rebirthReq: 150, 
                enemies: ['thcg_mob_1', 'thcg_mob_2'],
                boss: 'thcg_boss',
                rewards: {
                    gold: [1745700000000000000, 3491400000000000000], 
                    xp: [698280000000000000, 1745700000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [83000000000, 175000000000] } 
                }
            },
            // [NEW] MAP MỚI: Cực Đạo Chung Yên
            'map_ultimate_dao': {
                name: 'Cực Đạo Chung Yên', rarity: 16, 
                levelRange: 'Trùng Sinh 175', 
                unlockCost: 0, 
                rebirthReq: 175, 
                enemies: ['cdcy_mob_1', 'cdcy_mob_2'],
                boss: 'cdcy_boss',
                rewards: {
                    gold: [2007555000000000000, 4015110000000000000], 
                    xp: [803022000000000000, 2007555000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [95450000000, 201250000000] } 
                }
            },
            // [NEW] MAP MỚI: Vĩnh Hằng Chân Giới
            'map_eternal_truth': {
                name: 'Vĩnh Hằng Chân Giới', rarity: 16, 
                levelRange: 'Trùng Sinh 200', 
                unlockCost: 0, 
                rebirthReq: 200, 
                enemies: ['vhcg_mob_1', 'vhcg_mob_2'],
                boss: 'vhcg_boss',
                rewards: {
                    gold: [2308688000000000000, 4617376000000000000], 
                    xp: [923475000000000000, 2308688000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [110000000000, 230000000000] } 
                }
            },
            // [NEW] MAP MỚI: Thần Vực Hủy Diệt
            'map_destroy_god_realm': {
                name: 'Thần Vực Hủy Diệt', rarity: 16, 
                levelRange: 'Trùng Sinh 250', 
                unlockCost: 0, 
                rebirthReq: 250, 
                enemies: ['tvhd_mob_1', 'tvhd_mob_2'],
                boss: 'tvhd_boss',
                rewards: {
                    gold: [2539556000000000000, 5079113000000000000], 
                    xp: [1015822000000000000, 2539556000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [120000000000, 250000000000] } 
                }
            },
            // [NEW] MAP MỚI: Đa Vũ Trụ Chi Đỉnh
            'map_multiverse_peak': {
                name: 'Đa Vũ Trụ Chi Đỉnh', rarity: 16, 
                levelRange: 'Trùng Sinh 300', 
                unlockCost: 0, 
                rebirthReq: 300, 
                enemies: ['dvt_mob_1', 'dvt_mob_2'],
                boss: 'dvt_boss',
                rewards: {
                    gold: [2793512000000000000, 5587024000000000000], 
                    xp: [1117404000000000000, 2793512000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [132000000000, 275000000000] } 
                }
            },
            // [NEW] MAP MỚI: Bỉ Ngạn Hư Vô
            'map_nirvana_void': {
                name: 'Bỉ Ngạn Hư Vô', rarity: 16, 
                levelRange: 'Trùng Sinh 400', 
                unlockCost: 0, 
                rebirthReq: 400, 
                enemies: ['bnhv_mob_1', 'bnhv_mob_2'],
                boss: 'bnhv_boss',
                rewards: {
                    gold: [2933187000000000000, 5866375000000000000], 
                    xp: [1173274000000000000, 2933187000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [138600000000, 288750000000] } 
                }
            },
            // [NEW] MAP MỚI: Thánh Vực Vô Cực
            'map_infinite_saint': {
                name: 'Thánh Vực Vô Cực', rarity: 16, 
                levelRange: 'Trùng Sinh 500', 
                unlockCost: 0, 
                rebirthReq: 500, 
                enemies: ['tvvc_mob_1', 'tvvc_mob_2'],
                boss: 'tvvc_boss',
                rewards: {
                    gold: [3079846000000000000, 6159694000000000000], 
                    xp: [1231938000000000000, 3079846000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [145530000000, 303180000000] } 
                }
            },
            // [NEW] MAP MỚI: Thần Giới Khởi Nguyên
            'map_origin_god_realm': {
                name: 'Thần Giới Khởi Nguyên', rarity: 16, 
                levelRange: 'Trùng Sinh 750', 
                unlockCost: 0, 
                rebirthReq: 750, 
                enemies: ['kgkn_mob_1', 'kgkn_mob_2'],
                boss: 'kgkn_boss',
                rewards: {
                    gold: [3233838300000000000, 6467678700000000000], 
                    xp: [1293534900000000000, 3233838300000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [152800000000, 318330000000] } 
                }
            },
            // [NEW] MAP MỚI: Đại Đạo Chi Đỉnh
            'map_great_dao_peak': {
                name: 'Đại Đạo Chi Đỉnh', rarity: 16, 
                levelRange: 'Trùng Sinh 1000', 
                unlockCost: 0, 
                rebirthReq: 1000, 
                enemies: ['ddcd_mob_1', 'ddcd_mob_2'],
                boss: 'ddcd_boss',
                rewards: {
                    gold: [3395530200000000000, 6791060400000000000], 
                    xp: [1358211000000000000, 3395530000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 50, amount: [160440000000, 334240000000] } 
                }
            },
            // [NEW] MAP MỚI: Bản Nguyên Giới
            'map_origin_source': {
                name: 'Bản Nguyên Giới', rarity: 16, 
                levelRange: 'Trùng Sinh 1500', 
                unlockCost: 0, 
                rebirthReq: 1500, 
                enemies: ['bng_mob_1', 'bng_mob_2'],
                boss: 'bng_boss',
                rewards: {
                    gold: [3531351400000000000, 7062702800000000000], 
                    xp: [1412539000000000000, 3531351000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [166860000000, 347610000000] } 
                }
            },
            // [NEW] MAP MỚI: Chân Lý Tối Thượng
            'map_absolute_truth': {
                name: 'Chân Lý Tối Thượng', rarity: 16, 
                levelRange: 'Trùng Sinh 2000', 
                unlockCost: 0, 
                rebirthReq: 2000, 
                enemies: ['cltt_mob_1', 'cltt_mob_2'],
                boss: 'cltt_boss',
                rewards: {
                    gold: [3637291900000000000, 7274583800000000000], 
                    xp: [1454915000000000000, 3637291000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [171860000000, 358030000000] } 
                }
            },
            // [NEW] MAP MỚI: Thiên Ngoại Hư Không
            'map_outer_void': {
                name: 'Thiên Ngoại Hư Không', rarity: 16, 
                levelRange: 'Trùng Sinh 3000', 
                unlockCost: 0, 
                rebirthReq: 3000, 
                enemies: ['tnhk_mob_1', 'tnhk_mob_2'],
                boss: 'tnhk_boss',
                rewards: {
                    gold: [3710037700000000000, 7420075500000000000], 
                    xp: [1484013300000000000, 3710036800000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [175300000000, 365190000000] } 
                }
            },
            // [NEW] MAP MỚI: Hồng Mông Khởi Nguyên
            'map_eternal_genesis': {
                name: 'Hồng Mông Khởi Nguyên', rarity: 16, 
                levelRange: 'Trùng Sinh 5000', 
                unlockCost: 0, 
                rebirthReq: 5000, 
                enemies: ['hmkn_mob_1', 'hmkn_mob_2'],
                boss: 'hmkn_boss',
                rewards: {
                    gold: [3784238400000000000, 7568476800000000000], 
                    xp: [1513695000000000000, 3784238000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [178800000000, 372490000000] } 
                }
            },
            // [NEW] MAP MỚI: Vạn Cổ Bất Diệt
            'map_eternal_antiquity': {
                name: 'Vạn Cổ Bất Diệt', rarity: 16, 
                levelRange: 'Trùng Sinh 7500', 
                unlockCost: 0, 
                rebirthReq: 7500, 
                enemies: ['vcbd_mob_1', 'vcbd_mob_2'],
                boss: 'vcbd_boss',
                rewards: {
                    gold: [3859923100000000000, 7719846300000000000], 
                    xp: [1543968900000000000, 3859923000000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [182370000000, 379930000000] } 
                }
            },
            // [NEW] MAP MỚI: Thiên Địa Chung Cực
            'map_ultimate_end': {
                name: 'Thiên Địa Chung Cực', rarity: 16, 
                levelRange: 'Trùng Sinh 10000', 
                unlockCost: 0, 
                rebirthReq: 10000, 
                enemies: ['tdcc_mob_1', 'tdcc_mob_2'],
                boss: 'tdcc_boss',
                rewards: {
                    gold: [3937121562000000000, 7874243124000000000], 
                    xp: [1574848278000000000, 3937121562000000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [186017400000, 387528600000] } 
                }
            },
            // [NEW] MAP MỚI: Hỗn Độn Vô Thượng
            'map_supreme_chaos': {
                name: 'Hỗn Độn Vô Thượng', rarity: 16, 
                levelRange: 'Trùng Sinh 15000', 
                unlockCost: 0, 
                rebirthReq: 15000, 
                enemies: ['hdvt_mob_1', 'hdvt_mob_2'],
                boss: 'hdvt_boss',
                rewards: {
                    gold: [4015865874400000000, 8031731748800000000], 
                    xp: [1606345223560000000, 4015865874400000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [189737748000, 395279172000] } 
                }
            },
            // [NEW] MAP MỚI: Chân Ngã Độc Tôn
            'map_true_self': {
                name: 'Chân Ngã Độc Tôn', rarity: 16, 
                levelRange: 'Trùng Sinh 20000', 
                unlockCost: 0, 
                rebirthReq: 20000, 
                enemies: ['cndt_mob_1', 'cndt_mob_2'],
                boss: 'cndt_boss',
                rewards: {
                    gold: [4096183193288000000, 8192366386576000000], 
                    xp: [1638472537315200000, 4096183193288000000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [193532502960, 403184755440] } 
                }
            },
            // [NEW] MAP MỚI: Vạn Kiếp Luân Hồi
            'map_eternal_samsara': {
                name: 'Vạn Kiếp Luân Hồi', rarity: 16, 
                levelRange: 'Trùng Sinh 30000', 
                unlockCost: 0, 
                rebirthReq: 30000, 
                enemies: ['vklh_mob_1', 'vklh_mob_2'],
                boss: 'vklh_boss',
                rewards: {
                    gold: [4178106857145760000, 8356213714291520000], 
                    xp: [1671249488057504000, 4178122857155760000], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [197403153010, 411248450540] } 
                }
            },
            // [NEW] MAP MỚI: Chân Không Tuyệt Đối
            'map_absolute_null': {
                name: 'Chân Không Tuyệt Đối', rarity: 16, 
                levelRange: 'Trùng Sinh 50000', 
                unlockCost: 0, 
                rebirthReq: 50000, 
                enemies: ['cktd_mob_1', 'cktd_mob_2'],
                boss: 'cktd_boss',
                rewards: {
                    gold: [4261668994288675200, 8523337988577350400], 
                    xp: [1704674477818654080, 4261683428708875200], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [201351216070, 419473419550] } 
                }
            },
            // [NEW] MAP MỚI: Vô Tận Chi Nguyên
            'map_endless_origin': {
                name: 'Vô Tận Chi Nguyên', rarity: 16, 
                levelRange: 'Trùng Sinh 100000', 
                unlockCost: 0, 
                rebirthReq: 100000, 
                enemies: ['vtcn_mob_1', 'vtcn_mob_2'],
                boss: 'vtcn_boss',
                rewards: {
                    gold: [4346902393146448700, 8693804786292897400], 
                    xp: [1738767973374827161, 4346920114285052704], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [205378240390, 427862887940] } 
                }
            },
            // [NEW] MAP MỚI: Vô Cực Chân Giới
            'map_infinite_true_realm': {
                name: 'Vô Cực Chân Giới', rarity: 16, 
                levelRange: 'Trùng Sinh 250000', 
                unlockCost: 0, 
                rebirthReq: 250000, 
                enemies: ['vccg_mob_1', 'vccg_mob_2'],
                boss: 'vccg_boss',
                rewards: {
                    gold: [4433840441775377600, 8867680883550755300], 
                    xp: [1773543568049733704, 4433858342855153758], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [209485805190, 436420145690] } 
                }
            },
            // [NEW] MAP MỚI: Thần Thoại Kỷ Nguyên
            'map_mythical_era': {
                name: 'Thần Thoại Kỷ Nguyên', rarity: 16, 
                levelRange: 'Trùng Sinh 500000', 
                unlockCost: 0, 
                rebirthReq: 500000, 
                enemies: ['ttkn_mob_1', 'ttkn_mob_2'],
                boss: 'ttkn_boss',
                rewards: {
                    gold: [4522517250610885200, 9045034501221770400], 
                    xp: [1809014281659728378, 4522530011526184833], 
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [213675521290, 445148548600] } 
                }
            },
            // [NEW] MAP MỚI: Chí Tôn Vô Thượng
            'map_supreme_god': {
                name: 'Chí Tôn Vô Thượng', rarity: 16, 
                levelRange: 'Trùng Sinh 1,000,000', 
                unlockCost: 0, 
                rebirthReq: 1000000, 
                enemies: ['ctvt_mob_1', 'ctvt_mob_2'],
                boss: 'ctvt_boss',
                rewards: {
                    gold: [4612967595623102900, 9225935191246205800], // +2%
                    xp: [1845194567292922945, 4612980613831408529], // +2%
                    equipChance: 5,
                    materialDropChance: 5,
                    linhHonThachDrop: { chance: 5, amount: [217949031710, 454051499570] } 
                }
            },
        };
        
        // NEW: Skill Name DB for logging
        const SKILL_NAMES_DB = {
            'fishing': 'Câu Cá',
            'mining': 'Khai Khoáng',
            'herbalism': 'Hái Thuốc' // [NEW]
            // Add more as skills are added
        };

        // --- GAME VARIABLES ---
        let gameData;
        let gameLoopInterval = null;
        let tooltipTimeout = null;
        let selectedUpgradeItemId = null; // [NEW] For Blacksmith
        let selectedHoangKimEquipId = null; // [NEW] Cho tab Hoàng Kim
        let selectedHoangKimBlueprintId = null; // [NEW] Cho tab Hoàng Kim
        // [NEW] Variables cho Phù Phép
        let selectedEnchantEquipId = null;
        let selectedEnchantScrollId = null;
        
        let currentBoostingDiscipleId = null; // [NEW] For Sect Shop -> Boost Modal refresh
        let selectedTruyenCongTarget = null; // [NEW] For Stat Transfer
        let selectedTruyenCongMaterials = []; // [MODIFIED] Changed from Material (singular) to Materials (array)

        // [MODIFIED] Function to calculate XP needed for next level using the new formula
        // Cập nhật công thức EXP: 1500 * 1.1053^(level-1)
        // Mục tiêu: Cấp 199 lên 200 tốn khoảng 674.5 Tỷ XP
        function getXpToNext(level) {
            if (level <= 0) return 1500; 
            // Công thức cũ: 1500 * 1.15^(L-1) -> Quá cao
            // Công thức mới: 1500 * 1.1053^(L-1) -> Chuẩn hóa theo yêu cầu
            return Math.floor(1500 * Math.pow(1.1053, level - 1));
        }

        // [NEW] Helper function to get dynamic Max Level
        function getMaxLevel() {
            // Cấp tối đa cơ bản là 200. Mỗi lần trùng sinh tăng thêm 1 cấp tối đa.
            const baseMaxLevel = 200;
            const rebirths = (gameData && gameData.rebirthCount) ? gameData.rebirthCount : 0;
            return baseMaxLevel + rebirths;
        }

        // [NEW] XP Formula for Disciples
        // Cập nhật công thức Đệ Tử: 200 * 1.11^(level-1)
        // Mục tiêu: Cấp 199 lên 200 khoảng 200 Tỷ XP (Dễ hơn nhân vật chính một chút)
        function getDiscipleXpToNext(level) {
            if (level <= 0) return 200; 
            return Math.floor(200 * Math.pow(1.11, level - 1));
        }
        
        // [NEW] --- Pet Helper Functions ---
        function getPetXpToNext(level) {
            if (level <= 0) return 300; 
            // Pet max level is 100
            // Cập nhật: 300 * 1.2^(level-1) -> Cấp 99 lên 100 khoảng 20 Tỷ XP
            if (level >= 100) return Infinity;
            return Math.floor(300 * Math.pow(1.20, level - 1));
        }

        // [NEW] XP Formula for Disciples
        function getDiscipleXpToNext(level) {
            if (level <= 0) return 200; // Lower starting requirement
            // Slower progression than player
            return Math.floor(200 * Math.pow(1.20, level - 1));
        }

        // [NEW] Helper function to get disciple rank by level
        function getDiscipleRank(level) {
            if (level <= 20) {
                return { name: 'Ngoại Môn Đệ Tử', class: 'text-gray-400' };
            } else if (level <= 40) {
                return { name: 'Nội Môn Đệ Tử', class: 'text-blue-400' };
            } else if (level <= 50) {
                return { name: 'Hạch Tâm Đệ Tử', class: 'text-purple-400' };
            } else if (level <= 60) {
                return { name: 'Chân Truyền Đệ Tử', class: 'text-yellow-400' };
            } else if (level <= 70) {
                return { name: 'Thánh Tử / Thánh Nữ', class: 'text-orange-400' };
            } else if (level <= 80) {
                return { name: 'Hộ Pháp', class: 'text-red-400' };
            } else if (level <= 90) {
                return { name: 'Trưởng Lão', class: 'text-pink-400' };
            } else if (level <= 99) {
                return { name: 'Đại Trưởng Lão', class: 'text-fuchsia-500' };
            } 
            // [NEW] Cấp bậc cao cấp (100 - 199)
            else if (level <= 112) {
                return { name: 'Thái Thượng Trưởng Lão', class: 'text-red-500 font-semibold' };
            } else if (level <= 125) {
                return { name: 'Thánh Trưởng Lão', class: 'text-yellow-300 font-semibold' };
            } else if (level <= 137) {
                return { name: 'Hộ Tông Sứ', class: 'text-teal-300 font-semibold' };
            } else if (level <= 150) {
                return { name: 'Đại Hộ Tông', class: 'text-emerald-400 font-bold' };
            } else if (level <= 162) {
                return { name: 'Tông Môn Thần Sứ', class: 'text-violet-400 font-bold' };
            } else if (level <= 175) {
                return { name: 'Tông Môn Hộ Đạo Giả', class: 'text-rose-400 font-bold' };
            } else if (level <= 189) {
                return { name: 'Phó Tông Chủ', class: 'text-orange-500 font-black text-shadow-orange' };
            } else {
                // Level 190+ [MODIFIED] Removed text-lg to sync font size
                return { name: 'Vô Thượng Trưởng Lão', class: 'text-rainbow-animation font-black' };
            }
        }

        // [NEW] XP Formula for Menh Cach
        function getMenhCachXpToNext(level) {
            if (level >= MAX_MENH_CACH_LEVEL) return Infinity;
            // Bắt đầu 500 XP, mỗi cấp tăng 30%
            return Math.floor(500 * Math.pow(1.3, level - 1));
        }

        // [NEW] --- Pet Helper Functions ---
        function getPetXpToNext(level) {
            if (level <= 0) return 300; 
            
            // [MODIFIED] Mở giới hạn lên 2500 (trước là 1000)
            if (level >= 2500) return Infinity;

            // Cấp 1-99: Công thức cũ (Tăng trưởng nhanh)
            if (level < 100) {
                return Math.floor(300 * Math.pow(1.20, level - 1));
            }
            
            // [NEW] Cấp 100+: Công thức mới (Tăng trưởng ổn định để tránh tràn số)
            // Lấy mốc XP tại cấp 100 làm chuẩn
            const xpAt100 = 300 * Math.pow(1.20, 99); 
            // Mỗi cấp sau 100 tăng 2% so với cấp trước
            let req = Math.floor(xpAt100 * Math.pow(1.02, level - 100));

            // [NEW] Giới hạn XP yêu cầu tối đa mỗi cấp là 500 Tỷ (để người chơi có thể đạt được)
            const MAX_XP_REQ = 500000000000; 
            if (req > MAX_XP_REQ) return MAX_XP_REQ;
            
            return req;
        }

        /**
         * [MODIFIED] Hiển thị tab Ám Ảnh Kiếm Ảnh (Đã Kích Hoạt Chiến Đấu)
         */
        function renderAmAnhKiemAnhPanel() {
            const panel = document.getElementById('panel-am-anh-kiem-anh');
            if (!panel) return;

            // [NEW] Logic giới hạn 2 lần/ngày
            // Khởi tạo dữ liệu nếu chưa có (cho save cũ)
            if (!gameData.sect.amAnhKiemAnh) {
                gameData.sect.amAnhKiemAnh = { attempts: 0, lastDate: new Date().toISOString().slice(0, 10) };
            }
            
            const today = new Date().toISOString().slice(0, 10);
            
            // Reset nếu qua ngày mới
            if (gameData.sect.amAnhKiemAnh.lastDate !== today) {
                gameData.sect.amAnhKiemAnh.attempts = 0;
                gameData.sect.amAnhKiemAnh.lastDate = today;
            }

            const maxAttempts = 2;
            const currentAttempts = gameData.sect.amAnhKiemAnh.attempts;
            const remaining = Math.max(0, maxAttempts - currentAttempts);
            const canChallenge = remaining > 0;

            // Lấy chỉ số hiện tại của người chơi
            const playerStats = getTotalStats();
            
            // Tâm Ma có chỉ số HP gấp 1.5 lần để làm Boss, các chỉ số khác ngang bằng
            const shadowStats = { ...playerStats };
            shadowStats.hp = Math.floor(playerStats.hp * 1.5);

            let html = `
                <div class="text-center mb-6">
                    <h4 class="text-2xl font-bold text-gray-200 uppercase tracking-widest" style="text-shadow: 0 0 10px rgba(255,255,255,0.2);">Ám Ảnh Kiếm Ảnh</h4>
                    <p class="text-sm text-gray-400 mt-2 italic">"Kẻ thù lớn nhất của đời người là chính mình."</p>
                    <p class="text-xs text-gray-500">Chiến thắng bản ngã để khai mở tiềm năng vô hạn.</p>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-12 mb-8">
                    <!-- Player Card (Bản Thể) -->
                    <div class="bg-gray-800/80 p-5 rounded-xl border border-blue-500/30 shadow-[0_0_15px_rgba(59,130,246,0.1)] w-full md:w-72 relative overflow-hidden group transition hover:border-blue-400">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-transparent z-0"></div>
                        <div class="relative z-10">
                            <div class="w-20 h-20 mx-auto bg-gray-900 rounded-full flex items-center justify-center border-2 border-blue-400 mb-3 shadow-inner">
                                <i class="fa-solid fa-user-ninja text-4xl text-blue-300"></i>
                            </div>
                            <h5 class="font-bold text-lg text-blue-300 text-center mb-1">${PLAYER_DATA.name}</h5>
                            <p class="text-xs text-gray-400 text-center mb-4 bg-black/20 rounded-full px-2 py-0.5 w-fit mx-auto">Bản Thể</p>
                            
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between border-b border-gray-700/50 pb-1"><span class="text-gray-400"><i class="fa-solid fa-heart text-red-500 w-4"></i>Sinh Lực</span> <span class="text-red-400 font-mono font-bold">${playerStats.hp.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-700/50 pb-1"><span class="text-gray-400"><i class="fa-solid fa-khanda text-orange-500 w-4"></i>Công Kích</span> <span class="text-orange-400 font-mono font-bold">${playerStats.atk.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-700/50 pb-1"><span class="text-gray-400"><i class="fa-solid fa-shield-halved text-blue-500 w-4"></i>Phòng Thủ</span> <span class="text-blue-400 font-mono font-bold">${playerStats.def.toLocaleString()}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400"><i class="fa-solid fa-wind text-green-500 w-4"></i>Thân Pháp</span> <span class="text-green-400 font-mono font-bold">${playerStats.spd.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- VS Icon -->
                    <div class="text-5xl font-black text-red-600 animate-pulse flex flex-col items-center">
                        <span>VS</span>
                        <span class="text-xs font-normal text-gray-500 mt-1 opacity-50">Tử Chiến</span>
                    </div>

                    <!-- Shadow Card (Tâm Ma) -->
                    <div class="bg-gray-900 p-5 rounded-xl border border-red-900/50 shadow-[0_0_20px_rgba(220,38,38,0.1)] w-full md:w-72 relative overflow-hidden group transition hover:border-red-700">
                        <!-- Hiệu ứng nhiễu/tối cho Tâm Ma -->
                        <div class="absolute inset-0 bg-black/60 z-0"></div>
                        
                        <div class="relative z-10">
                            <div class="w-20 h-20 mx-auto bg-black rounded-full flex items-center justify-center border-2 border-red-800 mb-3 grayscale opacity-80">
                                <i class="fa-solid fa-user-ninja text-4xl text-gray-400"></i>
                            </div>
                            <h5 class="font-bold text-lg text-gray-400 text-center mb-1">Tâm Ma</h5>
                            <p class="text-xs text-red-500 text-center mb-4 bg-red-900/20 rounded-full px-2 py-0.5 w-fit mx-auto border border-red-900/30">Bản Ngã Hắc Ám</p>
                            
                            <div class="space-y-2 text-sm opacity-70">
                                <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-500">Sinh Lực</span> <span class="text-gray-300 font-mono font-bold text-red-400">${shadowStats.hp.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-500">Công Kích</span> <span class="text-gray-300 font-mono font-bold">${shadowStats.atk.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-500">Phòng Thủ</span> <span class="text-gray-300 font-mono font-bold">${shadowStats.def.toLocaleString()}</span></div>
                                <div class="flex justify-between"><span class="text-gray-500">Thân Pháp</span> <span class="text-gray-300 font-mono font-bold">${shadowStats.spd.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <!-- [MODIFIED] Hiển thị số lượt và trạng thái nút -->
                    <p class="text-sm ${canChallenge ? 'text-green-400' : 'text-red-500'} mb-2 font-bold bg-black/40 inline-block px-3 py-1 rounded border border-gray-700">
                        Số lượt khiêu chiến còn lại hôm nay: <span class="text-white">${remaining}</span> / ${maxAttempts}
                    </p>
                    <br>
                    <button class="px-8 py-3 bg-gradient-to-r from-gray-800 to-black hover:from-red-900 hover:to-black text-gray-300 hover:text-white font-bold rounded-lg shadow-lg border border-gray-600 hover:border-red-500 transition-all transform hover:scale-105 group ${!canChallenge ? 'opacity-50 cursor-not-allowed grayscale' : ''}" 
                        onclick="${canChallenge ? 'startShadowBattle()' : ''}" 
                        ${!canChallenge ? 'disabled' : ''}>
                        <i class="fa-solid fa-khanda mr-2 group-hover:rotate-45 transition duration-300"></i> 
                        ${canChallenge ? 'Khiêu Chiến Tâm Ma' : 'Đã Hết Lượt Hôm Nay'}
                    </button>
                    <p class="text-xs text-gray-600 mt-3 italic">* Phần thưởng: Kim Nguyên Bảo, Đá Cường Hóa và cơ hội nhận Linh Hồn Thạch.</p>
                </div>
            `;
            
            panel.innerHTML = html;
        }

        /**
         * [NEW] Bắt đầu chiến đấu với Tâm Ma
         */
        function startShadowBattle() {
            // [NEW] Kiểm tra giới hạn lượt
            if (!gameData.sect.amAnhKiemAnh) {
                gameData.sect.amAnhKiemAnh = { attempts: 0, lastDate: new Date().toISOString().slice(0, 10) };
            }
            const today = new Date().toISOString().slice(0, 10);
            
            // Reset nếu qua ngày
            if (gameData.sect.amAnhKiemAnh.lastDate !== today) {
                gameData.sect.amAnhKiemAnh.attempts = 0;
                gameData.sect.amAnhKiemAnh.lastDate = today;
            }
            
            if (gameData.sect.amAnhKiemAnh.attempts >= 2) {
                showToast("Bạn đã hết lượt khiêu chiến Tâm Ma hôm nay!", false);
                return;
            }

            // Trừ lượt (Tiêu hao ngay khi bắt đầu)
            gameData.sect.amAnhKiemAnh.attempts++;

            const playerStats = getTotalStats();
            
            // Tâm Ma mạnh hơn bản thể về HP để làm Boss
            const shadowStats = { ...playerStats };
            
            // [FIX] Tăng HP Boss lên gấp 5 lần người chơi để trận đấu dài hơn, tránh 1 hit chết
            // Nếu bạn quá mạnh, có thể tăng số này lên 10 hoặc 20
            shadowStats.hp = Math.floor(playerStats.hp * 5.0); 
            
            // Công/Thủ ngang bằng hoặc nhỉnh hơn chút xíu
            shadowStats.atk = Math.floor(playerStats.atk * 1.1);
            shadowStats.def = Math.floor(playerStats.def * 1.1);
            shadowStats.spd = playerStats.spd;
            shadowStats.critChance = playerStats.critChance;
            shadowStats.critDamage = playerStats.critDamage;

            const shadowEnemy = {
                dbId: 'shadow_boss', // Đã khớp với key trong DAULADAILUC_ENEMIES_DB
                name: `Tâm Ma - ${PLAYER_DATA.name}`,
                level: gameData.player.level,
                icon: 'fa-solid fa-user-ninja',
                stats: shadowStats,
                currentHp: shadowStats.hp,
                maxHp: shadowStats.hp
            };

            // Chuẩn bị đồng hành
            let companions = [];
            const equippedPetId = gameData.equippedSungVat;
            const championDiscipleId = gameData.sect.combatChampionId;

            if (equippedPetId) {
                const petInstance = gameData.sungVat.find(p => p.id === equippedPetId);
                const petDB = SUNG_VAT_DB[equippedPetId];
                if (petInstance && petDB) {
                    const petStats = getPetStats(petInstance);
                    companions.push({ type: 'pet', id: petInstance.id, name: petDB.name, level: petInstance.level, stats: petStats, currentHp: petStats.hp, maxHp: petStats.hp });
                }
            }
            if (championDiscipleId) {
                const champ = gameData.disciples.find(d => d.id === championDiscipleId);
                if (champ && champ.status === 'Nhàn Rỗi') {
                     const fullStats = calculateDiscipleStats(champ);
                    companions.push({ type: 'disciple', id: champ.id, name: champ.name, level: champ.level, stats: fullStats, currentHp: fullStats.hp, maxHp: fullStats.hp });
                }
            }

            // Hồi phục 100% HP/Mana trước khi đánh Boss
            gameData.player.currentHp = playerStats.hp;
            gameData.player.currentMana = playerStats.mana;

            gameData.turnBasedCombat = {
                active: true,
                mapId: 'map_am_anh',
                enemy: shadowEnemy,
                companions: companions,
                log: [],
                playerTurn: true
            };

            hideModal('tong-mon-modal');
            showModal('turn-based-combat-modal');
            addTurnBasedCombatLog(`Tâm Ma thức tỉnh! HP gấp 5 lần bản thể!`, 'system');
            renderTurnBasedCombatUI();
        }

        // [MODIFIED] Hàm kết thúc chiến đấu (Đã thêm logic xử lý map_bach_thang)
        function endTurnBasedCombat(didWin) {
            if (!gameData.turnBasedCombat.active) return; 

            const combatMapId = gameData.turnBasedCombat.mapId;
            
            // --- [NEW] XỬ LÝ CHO BÁCH THẮNG DANH TƯỚNG ---
            if (combatMapId === 'map_bach_thang') {
                if (didWin) {
                    const reward = gameData.turnBasedCombat.bachThangReward;
                    
                    // 1. Cộng thưởng
                    gameData.nganLuong += reward.nl;
                    addPlayerXp(reward.xp, 'turn_based');
                    
                    // 2. Cập nhật tiến độ
                    if (gameData.sect.bachThang.currentLayer === reward.layer) {
                        gameData.sect.bachThang.currentLayer++;
                        gameData.sect.bachThang.highestLayer = reward.layer;
                    }

                    // 3. Thông báo
                    document.getElementById('tb-result-title').textContent = 'CHIẾN THẮNG';
                    document.getElementById('tb-result-title').className = 'text-3xl font-bold text-yellow-400 mb-4';
                    document.getElementById('tb-result-rewards').innerHTML = `
                        <p>Vượt ải Bách Thắng Tầng ${reward.layer}!</p>
                        <p class="text-green-300">+${reward.xp.toLocaleString()} XP</p>
                        <p class="text-yellow-300">+${reward.nl.toLocaleString()} NL</p>
                    `;
                    showModal('tb-result-modal');

                    // 4. Log
                    addTurnBasedCombatLog(`CHIẾN THẮNG TẦNG ${reward.layer}!`, 'system');
                    addSectLog(`Vượt ải Bách Thắng tầng ${reward.layer}, nhận thưởng lớn!`, 'reward');

                } else {
                    // Thua
                    document.getElementById('tb-result-title').textContent = 'THẤT BẠI';
                    document.getElementById('tb-result-title').className = 'text-3xl font-bold text-red-500 mb-4';
                    
                    const layer = gameData.turnBasedCombat.bachThangReward ? gameData.turnBasedCombat.bachThangReward.layer : '?';
                    
                    document.getElementById('tb-result-rewards').innerHTML = `
                        <p>Bạn đã thất bại tại Tầng ${layer}.</p>
                        <p class="text-gray-400 text-sm">Hãy nâng cao lực chiến và thử lại!</p>
                    `;
                    showModal('tb-result-modal');
                }
                
                // Cleanup
                if (gameData.player.currentHp <= 0) gameData.player.currentHp = getTotalStats().hp;
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                hideModal('turn-based-combat-modal');
                updateUI();
                
                // Mở lại panel sau khi đóng combat
                setTimeout(() => {
                    showModal('tong-mon-modal');
                    switchTongMonTab('chinh-phat');
                    switchChinhPhatSubTab('bach-thang');
                }, 300);
                return; // Quan trọng: Dừng hàm tại đây
            }
            // --- [END NEW] ---

            // [EXISTING LOGIC FOR OTHER MAPS]
            if (combatMapId === 'map_vo_dai') {
                 if (!gameData.arena.battleLog) gameData.arena.battleLog = [];
                const enemyName = gameData.turnBasedCombat.enemy.name;
                const timeStr = new Date().toLocaleTimeString();

                if (didWin) {
                    const pointsGained = gameData.turnBasedCombat.arenaRewardPoints || 10;
                    gameData.arena.points += pointsGained;
                    gameData.arena.wins++;
                    gameData.kimNguyenBao += 10;
                    
                    // [FIX] Sửa lỗi rank bị 0
                    const currentRank = gameData.arena.rank || 1;
                    const rankData = ARENA_RANKS_DB[currentRank] || ARENA_RANKS_DB[1];
                    const salaryData = rankData.salary;
                    
                    const xpReward = Math.floor((salaryData.xp || 100000) / 10);
                    addPlayerXp(xpReward, 'turn_based');

                    showToast(`Thắng Võ Đài! +${pointsGained} Điểm, +${xpReward.toLocaleString()} XP.`, true);
                    
                    gameData.arena.battleLog.unshift({
                        type: 'win',
                        msg: `Đánh bại <span class="text-white font-bold">${enemyName}</span>. Nhận <span class="text-yellow-300">+${pointsGained}</span> điểm.`,
                        time: timeStr
                    });
                    generateArenaOpponents();
                } else {
                    const pointsLost = 5;
                    gameData.arena.points = Math.max(0, gameData.arena.points - pointsLost);
                    gameData.arena.losses++;
                    gameData.arena.battleLog.unshift({
                        type: 'loss',
                        msg: `Thất bại trước <span class="text-white font-bold">${enemyName}</span>. Mất <span class="text-red-400">-${pointsLost}</span> điểm.`,
                        time: timeStr
                    });
                    showToast(`Thua cuộc! Mất ${pointsLost} điểm.`, false);
                }
                
                if (gameData.player.currentHp <= 0) gameData.player.currentHp = getTotalStats().hp;
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                hideModal('turn-based-combat-modal');
                updateUI();
                setTimeout(() => {
                    showModal('tong-mon-modal');
                    switchTongMonTab('chinh-phat');
                    switchChinhPhatSubTab('vo-dai-than-ma');
                }, 300);
                return;
            }

            // Fallback cho các map thường/phó bản
            // [FIX] Thêm kiểm tra enemyDB tồn tại trước khi truy cập
            const enemyDB = DAULADAILUC_ENEMIES_DB[gameData.turnBasedCombat.enemy.dbId];
            
            if (!enemyDB) {
                console.error("Lỗi: Không tìm thấy DB cho quái:", gameData.turnBasedCombat.enemy.dbId);
                // Thoát an toàn
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                hideModal('turn-based-combat-modal');
                updateUI();
                return;
            }

            if (didWin) {
                const rewards = enemyDB.rewards;
                addPlayerXp(rewards.xp, 'turn_based');
                gameData.nganLuong += rewards.nganLuong;
                
                if (rewards.linhKhi) gameData.linhKhi = (gameData.linhKhi || 0) + rewards.linhKhi;
                
                // Drop items logic (simplified)
                if (rewards.loot) {
                    rewards.loot.forEach(loot => {
                        if (Math.random() * 100 < loot.chance) {
                            if (STATIC_ITEM_DB[loot.id]) addItem(loot.id, 1, 'turn_based');
                            else if (MATERIALS_DB[loot.id]) addMaterial(loot.id, 1, 'turn_based');
                        }
                    });
                }
                
                // Drop Equip
                if (Math.random() * 100 < (rewards.equipChance || 0)) {
                    const newItem = generateEquipment(enemyDB.level);
                    if (countInventorySlots() < MAX_INVENTORY_SLOTS) {
                        gameData.gearInventory.push(newItem);
                        addTurnBasedCombatLog(`Rơi trang bị: [${newItem.name}]`, 'reward');
                    }
                }
                
                addTurnBasedCombatLog(`Chiến thắng! Nhận ${rewards.xp} XP, ${rewards.nganLuong} NL.`, 'reward');
                setTimeout(spawnNextTurnBasedEnemy, 2000); // Auto next enemy
            } else {
                document.getElementById('tb-result-title').textContent = 'THẤT BẠI';
                document.getElementById('tb-result-title').className = 'text-3xl font-bold text-red-500 mb-4';
                document.getElementById('tb-result-rewards').innerHTML = `<p>Bạn đã bị đánh bại.</p>`;
                showModal('tb-result-modal');
                
                if (gameData.player.currentHp <= 0) gameData.player.currentHp = getTotalStats().hp;
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                hideModal('turn-based-combat-modal');
                updateUI();
            }
        }

        // [MODIFIED] Cập nhật hàm getTotalStats để thêm Bonus Bách Thắng
        // Bạn cần chèn đoạn logic này vào trong hàm getTotalStats (phần tính percentBonuses)
        /*
            // [NEW] 6. Add Bach Thang Bonus (Mỗi 10 tầng)
            if (gameData.sect && gameData.sect.bachThang && gameData.sect.bachThang.highestLayer > 0) {
                const layer = gameData.sect.bachThang.highestLayer;
                // +5% mỗi mốc 10, 20, 30...
                // Mốc 10: ATK | 20: DEF | 30: HP | 40: Dodge | 50: Crit | 60: All
                
                if (layer >= 10) percentBonuses.atk_p += 5;
                if (layer >= 20) percentBonuses.def_p += 5;
                if (layer >= 30) percentBonuses.hp_p += 5;
                if (layer >= 40) percentBonuses.dodgeChance += 5;
                if (layer >= 50) percentBonuses.critChance += 5;
                if (layer >= 60) { // All +5%
                    percentBonuses.hp_p += 5; percentBonuses.atk_p += 5; percentBonuses.def_p += 5; percentBonuses.spd_p += 5;
                }
                if (layer >= 70) percentBonuses.lifesteal += 2;
                if (layer >= 80) percentBonuses.critDamage += 20;
                if (layer >= 90) percentBonuses.ignoreDef_p += 10;
            }
        */
        
        // [FIX] Cập nhật lại hàm calculateDiscipleStats và getTotalStats để áp dụng Buff Bách Thắng
        /* Bạn cần thêm logic đọc `gameData.sect.bachThang.currentLayer` 
           và cộng % chỉ số tương ứng vào 2 hàm tính chỉ số.
           Ví dụ: 
           const bachThangLayer = (gameData.sect && gameData.sect.bachThang) ? gameData.sect.bachThang.currentLayer : 1;
           const milestonesPassed = Math.floor((bachThangLayer - 1) / 10);
           // Mỗi mốc tăng 5% toàn diện (ví dụ đơn giản)
           if (milestonesPassed > 0) {
               const buffPercent = milestonesPassed * 5;
               percentBonuses.hp_p += buffPercent;
               percentBonuses.atk_p += buffPercent;
               // ...
           }
        */
        function getPetStats(petInstance) {
            const petDB = SUNG_VAT_DB[petInstance.id];
            if (!petDB) return { hp: 0, atk: 0, def: 0, spd: 0 };

            const level = petInstance.level || 1;
            
            // [NEW] Pet Rebirth Multiplier (Mỗi lần trùng sinh tăng 10% toàn bộ chỉ số)
            const rebirthCount = petInstance.rebirthCount || 0;
            const rebirthMultiplier = 1 + (rebirthCount * 0.1); 

            const stats = {};
            for (const stat in petDB.baseStats) {
                // Base + (Potential * Level)
                let val = petDB.baseStats[stat] + (petDB.potential[stat] * (level - 1));
                
                // [NEW] Áp dụng Bonus Trùng Sinh
                val = Math.floor(val * rebirthMultiplier);
                
                stats[stat] = val;
            }

            // [NEW] Add stats from Allocated Potential Points
            if (petInstance.allocatedStats) {
                stats.hp += (petInstance.allocatedStats.hp || 0) * 20;   // 1 điểm = 20 HP
                stats.atk += (petInstance.allocatedStats.atk || 0) * 2;  // 1 điểm = 2 ATK
                stats.def += (petInstance.allocatedStats.def || 0) * 2;  // 1 điểm = 2 DEF
                stats.spd += (petInstance.allocatedStats.spd || 0) * 2;  // 1 điểm = 2 SPD
            }

            // [NEW] Apply passive skill bonuses (Tính sau cùng)
            if (petDB.passiveSkill && petDB.passiveSkill.effect) {
                const effect = petDB.passiveSkill.effect;
                if (effect.hp_p) stats.hp = Math.floor(stats.hp * (1 + effect.hp_p / 100));
                if (effect.atk_p) stats.atk = Math.floor(stats.atk * (1 + effect.atk_p / 100));
                if (effect.def_p) stats.def = Math.floor(stats.def * (1 + effect.def_p / 100));
                if (effect.spd_p) stats.spd = Math.floor(stats.spd * (1 + effect.spd_p / 100));
            }
            
            return stats;
        }

        // [NEW] Add XP to equipped pet (10% of player XP)
        // [FIX] Re-added missing function
        function addEquippedPetXp(xpAmount) {
            const equippedPetId = gameData.equippedSungVat;
            if (!equippedPetId) return; // No pet equipped

            const petInstance = gameData.sungVat.find(p => p.id === equippedPetId);
            if (!petInstance) return; // Pet not found
            
            // If max level, don't add XP
            // [MODIFIED] Check cap 2500
            if (petInstance.level >= 2500) { 
                if (petInstance.xp !== 0) petInstance.xp = 0;
                return;
            }

            petInstance.xp = (petInstance.xp || 0) + xpAmount;
            let levelledUp = false;

            while (petInstance.xp >= petInstance.xpToNext) {
                // [MODIFIED] Check cap 2500
                if (petInstance.level >= 2500) {
                    petInstance.level = 2500;
                    petInstance.xp = 0;
                    petInstance.xpToNext = Infinity;
                    // Log the level up
                    if (gameData.isTraining) {
                        addTrainingLog(`${SUNG_VAT_DB[petInstance.id].name} đã đạt cấp tối đa (2500)!`, 'system');
                    } else if (gameData.turnBasedCombat.active) {
                        addTurnBasedCombatLog(`${SUNG_VAT_DB[petInstance.id].name} đã đạt cấp tối đa (2500)!`, 'system');
                    }
                    levelledUp = true; // Mark as levelled up for the final UI update
                    break; 
                }
                
                levelledUp = true;
                petInstance.level++;
                petInstance.xp -= petInstance.xpToNext;
                petInstance.xpToNext = getPetXpToNext(petInstance.level);
                
                // [NEW] Cộng 5 điểm tiềm năng mỗi cấp
                if (petInstance.potentialPoints === undefined) petInstance.potentialPoints = 0;
                petInstance.potentialPoints += 5;

                // Log the level up
                if (gameData.isTraining) {
                    addTrainingLog(`${SUNG_VAT_DB[petInstance.id].name} đã thăng lên Cấp ${petInstance.level}! (+5 Tiềm Năng)`, 'reward');
                } else if (gameData.turnBasedCombat.active) {
                    addTurnBasedCombatLog(`${SUNG_VAT_DB[petInstance.id].name} đã thăng lên Cấp ${petInstance.level}! (+5 Tiềm Năng)`, 'reward');
                }
            }

            if (levelledUp) {
                // We only show toast/update UI if not in batch mode (e.g. not during turn-based combat)
                if (gameData.isTraining) {
                    showToast(`${SUNG_VAT_DB[petInstance.id].name} đã thăng lên Cấp ${petInstance.level}! (+5 Tiềm Năng)`, true);
                    // If pet modal is open, re-render it
                    if (!document.getElementById('sung-vat-modal').classList.contains('hidden')) {
                        renderSungVatModal();
                    }
                    // Stats changed, so update main UI
                    updateUI();
                } else if (gameData.turnBasedCombat.active) {
                    // Turn-based combat will handle its own UI refresh
                }
            }
        }
        
        // [END NEW] --- Pet Helper Functions ---

        // [NEW] Sect Upgrades Database
        const SECT_UPGRADES_DB = {
            'trial_xp_1': { 
                id: 'trial_xp_1', 
                name: 'Phúc Lợi Thí Luyện I', 
                desc: '+10% XP nhận được từ Tông Môn Thí Luyện.', 
                cost: 200, // [MODIFIED] x10 (20 -> 200)
                effect: { type: 'trialXp', value: 10 }, 
                requires: null 
            },
            // [NEW] Add more upgrades
            'trial_xp_2': { 
                id: 'trial_xp_2', 
                name: 'Phúc Lợi Thí Luyện II', 
                desc: '+15% XP nhận được từ Tông Môn Thí Luyện.', 
                cost: 500, // [MODIFIED] x10 (50 -> 500)
                effect: { type: 'trialXp', value: 15 }, 
                requires: 'trial_xp_1' 
            },
            // [NEW] Thêm cấp 3
            'trial_xp_3': { 
                id: 'trial_xp_3', 
                name: 'Phúc Lợi Thí Luyện III', 
                desc: '+20% XP nhận được từ Tông Môn Thí Luyện.',
                cost: 1200, // [MODIFIED] x10 (120 -> 1200)
                effect: { type: 'trialXp', value: 20 },
                requires: 'trial_xp_2' 
            },
            // [NEW] Thêm cấp 4, 5
            'trial_xp_4': { 
                id: 'trial_xp_4', 
                name: 'Phúc Lợi Thí Luyện IV', 
                desc: '+25% XP nhận được từ Tông Môn Thí Luyện.',
                cost: 2000, // [MODIFIED] x10 (200 -> 2000)
                effect: { type: 'trialXp', value: 25 },
                requires: 'trial_xp_3' 
            },
            'trial_xp_5': { 
                id: 'trial_xp_5', 
                name: 'Phúc Lợi Thí Luyện V', 
                desc: '+30% XP nhận được từ Tông Môn Thí Luyện.',
                cost: 3000, // [MODIFIED] x10 (300 -> 3000)
                effect: { type: 'trialXp', value: 30 },
                requires: 'trial_xp_4' 
            },
            
            'trial_cooldown_1': { 
                id: 'trial_cooldown_1', 
                name: 'Giảm Hồi Thí Luyện I', 
                desc: '-10% thời gian hồi Tông Môn Thí Luyện.', 
                cost: 750, // [MODIFIED] x10 (75 -> 750)
                effect: { type: 'trialCooldown', value: 10 }, 
                requires: 'trial_xp_1' 
            },
            // [NEW] Thêm cấp 2
            'trial_cooldown_2': { 
                id: 'trial_cooldown_2', 
                name: 'Giảm Hồi Thí Luyện II', 
                desc: '-15% thời gian hồi Tông Môn Thí Luyện.',
                cost: 1500, // [MODIFIED] x10 (150 -> 1500)
                effect: { type: 'trialCooldown', value: 15 },
                requires: 'trial_cooldown_1' 
            },
            // [NEW] Thêm cấp 3, 4
            'trial_cooldown_3': { 
                id: 'trial_cooldown_3', 
                name: 'Giảm Hồi Thí Luyện III', 
                desc: '-20% thời gian hồi Tông Môn Thí Luyện.',
                cost: 2500, // [MODIFIED] x10 (250 -> 2500)
                effect: { type: 'trialCooldown', value: 20 },
                requires: 'trial_cooldown_2' 
            },
            'trial_cooldown_4': { 
                id: 'trial_cooldown_4', 
                name: 'Giảm Hồi Thí Luyện IV', 
                desc: '-25% thời gian hồi Tông Môn Thí Luyện.',
                cost: 4000, // [MODIFIED] x10 (400 -> 4000)
                effect: { type: 'trialCooldown', value: 25 },
                requires: 'trial_cooldown_3' 
            },

            'tuluyen_reward_1': { 
                id: 'tuluyen_reward_1', 
                name: 'Phúc Lợi Tu Luyện I', 
                desc: '+10% Ngân Lượng nhận được từ Tu Luyện (2 phút).', 
                cost: 150, // [MODIFIED] x10 (15 -> 150)
                effect: { type: 'tuLuyenReward', value: 10 },
                requires: null 
            },
            // [NEW] Add more upgrades
            'tuluyen_reward_2': { 
                id: 'tuluyen_reward_2', 
                name: 'Phúc Lợi Tu Luyện II', 
                desc: '+15% Ngân Lượng nhận được từ Tu Luyện (2 phút).', 
                cost: 400, // [MODIFIED] x10 (40 -> 400)
                effect: { type: 'tuLuyenReward', value: 15 },
                requires: 'tuluyen_reward_1' 
            },
            // [NEW] Thêm cấp 3
            'tuluyen_reward_3': { 
                id: 'tuluyen_reward_3', 
                name: 'Phúc Lợi Tu Luyện III', 
                desc: '+20% Ngân Lượng nhận được từ Tu Luyện (2 phút).',
                cost: 1000, // [MODIFIED] x10 (100 -> 1000)
                effect: { type: 'tuLuyenReward', value: 20 },
                requires: 'tuluyen_reward_2' 
            },
            // [NEW] Thêm cấp 4, 5
            'tuluyen_reward_4': { 
                id: 'tuluyen_reward_4', 
                name: 'Phúc Lợi Tu Luyện IV', 
                desc: '+25% Ngân Lượng nhận được từ Tu Luyện (2 phút).',
                cost: 1800, // [MODIFIED] x10 (180 -> 1800)
                effect: { type: 'tuLuyenReward', value: 25 },
                requires: 'tuluyen_reward_3' 
            },
            'tuluyen_reward_5': { 
                id: 'tuluyen_reward_5', 
                name: 'Phúc Lợi Tu Luyện V', 
                desc: '+30% Ngân Lượng nhận được từ Tu Luyện (2 phút).',
                cost: 2500, // [MODIFIED] x10 (250 -> 2500)
                effect: { type: 'tuLuyenReward', value: 30 },
                requires: 'tuluyen_reward_4' 
            },

            // [NEW] Loại nâng cấp mới: Tăng Tư Chất Tối Thiểu
            'min_potential_1': {
                id: 'min_potential_1',
                name: 'Tụ Linh Trận I',
                desc: 'Cải thiện phong thủy, đảm bảo đệ tử chiêu mộ được có tư chất tối thiểu là [Bình Thường].',
                cost: 5000, // [MODIFIED] x10 (500 -> 5000)
                effect: { type: 'minPotential', value: 1 }, // 1 = Bình Thường
                requires: 'max_members_3' // Yêu cầu Mở Rộng Tông Môn III
            },
            'min_potential_2': {
                id: 'min_potential_2',
                name: 'Tụ Linh Trận II',
                desc: 'Tăng cường linh khí, đảm bảo đệ tử chiêu mộ được có tư chất tối thiểu là [Khá].',
                cost: 20000, // [MODIFIED] x10 (2000 -> 20000)
                effect: { type: 'minPotential', value: 2 }, // 2 = Khá
                requires: 'min_potential_1'
            },
            'min_potential_3': {
                id: 'min_potential_3',
                name: 'Tụ Linh Trận III',
                desc: 'Linh khí hóa sương, đảm bảo đệ tử chiêu mộ được có tư chất tối thiểu là [Tốt].',
                cost: 50000, // [MODIFIED] x10 (5000 -> 50000)
                effect: { type: 'minPotential', value: 3 }, // 3 = Tốt
                requires: 'min_potential_2'
            },

            // [NEW] Giảm thời gian nhiệm vụ (Mission Speed)
            'mission_speed_1': {
                id: 'mission_speed_1',
                name: 'Thần Hành Phù I',
                desc: 'Giảm 10% thời gian làm Nhiệm Vụ Tông Môn.',
                cost: 1000, // [MODIFIED] x10 (100 -> 1000)
                effect: { type: 'missionSpeed', value: 10 }, // %
                requires: 'max_members_1'
            },
            'mission_speed_2': {
                id: 'mission_speed_2',
                name: 'Thần Hành Phù II',
                desc: 'Giảm 20% thời gian làm Nhiệm Vụ Tông Môn.',
                cost: 3000, // [MODIFIED] x10 (300 -> 3000)
                effect: { type: 'missionSpeed', value: 20 },
                requires: 'mission_speed_1'
            },
            'mission_speed_3': {
                id: 'mission_speed_3',
                name: 'Thần Hành Phù III',
                desc: 'Giảm 30% thời gian làm Nhiệm Vụ Tông Môn.',
                cost: 8000, // [MODIFIED] x10 (800 -> 8000)
                effect: { type: 'missionSpeed', value: 30 },
                requires: 'mission_speed_2'
            },
            // [NEW] Cấp 4-6
            'mission_speed_4': {
                id: 'mission_speed_4',
                name: 'Thần Hành Phù IV',
                desc: 'Giảm 40% thời gian làm Nhiệm Vụ Tông Môn.',
                cost: 20000, // [MODIFIED] x10 (2000 -> 20000)
                effect: { type: 'missionSpeed', value: 40 },
                requires: 'mission_speed_3'
            },
            'mission_speed_5': {
                id: 'mission_speed_5',
                name: 'Thần Hành Phù V',
                desc: 'Giảm 50% thời gian làm Nhiệm Vụ Tông Môn.',
                cost: 50000, // [MODIFIED] x10 (5000 -> 50000)
                effect: { type: 'missionSpeed', value: 50 },
                requires: 'mission_speed_4'
            },
            'mission_speed_6': {
                id: 'mission_speed_6',
                name: 'Thần Hành Phù VI (Max)',
                desc: 'Giảm 60% thời gian làm Nhiệm Vụ Tông Môn.',
                cost: 100000, // [MODIFIED] x10 (10000 -> 100000)
                effect: { type: 'missionSpeed', value: 60 },
                requires: 'mission_speed_5'
            },

            // [NEW] Tăng thưởng nhiệm vụ (Mission Reward)
            'mission_reward_1': {
                id: 'mission_reward_1',
                name: 'Thưởng Phạt Phân Minh I',
                desc: 'Tăng 10% phần thưởng (ĐCH, NL, XP) từ Nhiệm Vụ.',
                cost: 1500, // [MODIFIED] x10 (150 -> 1500)
                effect: { type: 'missionReward', value: 10 }, // %
                requires: 'max_members_2'
            },
            'mission_reward_2': {
                id: 'mission_reward_2',
                name: 'Thưởng Phạt Phân Minh II',
                desc: 'Tăng 20% phần thưởng (ĐCH, NL, XP) từ Nhiệm Vụ.',
                cost: 4000, // [MODIFIED] x10 (400 -> 4000)
                effect: { type: 'missionReward', value: 20 },
                requires: 'mission_reward_1'
            },
            'mission_reward_3': {
                id: 'mission_reward_3',
                name: 'Thưởng Phạt Phân Minh III',
                desc: 'Tăng 30% phần thưởng (ĐCH, NL, XP) từ Nhiệm Vụ.',
                cost: 10000, // [MODIFIED] x10 (1000 -> 10000)
                effect: { type: 'missionReward', value: 30 },
                requires: 'mission_reward_2'
            },
            // [NEW] Cấp 4-6
            'mission_reward_4': {
                id: 'mission_reward_4',
                name: 'Thưởng Phạt Phân Minh IV',
                desc: 'Tăng 40% phần thưởng (ĐCH, NL, XP) từ Nhiệm Vụ.',
                cost: 25000, // [MODIFIED] x10 (2500 -> 25000)
                effect: { type: 'missionReward', value: 40 },
                requires: 'mission_reward_3'
            },
            'mission_reward_5': {
                id: 'mission_reward_5',
                name: 'Thưởng Phạt Phân Minh V',
                desc: 'Tăng 50% phần thưởng (ĐCH, NL, XP) từ Nhiệm Vụ.',
                cost: 60000, // [MODIFIED] x10 (6000 -> 60000)
                effect: { type: 'missionReward', value: 50 },
                requires: 'mission_reward_4'
            },
            'mission_reward_6': {
                id: 'mission_reward_6',
                name: 'Thưởng Phạt Phân Minh VI (Max)',
                desc: 'Tăng 60% phần thưởng (ĐCH, NL, XP) từ Nhiệm Vụ.',
                cost: 150000, // [MODIFIED] x10 (15000 -> 150000)
                effect: { type: 'missionReward', value: 60 },
                requires: 'mission_reward_5'
            },

            // [NEW] Giảm giá Cửa Hàng Tông Môn (Shop Discount)
            'shop_discount_1': {
                id: 'shop_discount_1',
                name: 'Thương Đạo I',
                desc: 'Giảm 10% giá mua vật phẩm trong Cửa Hàng Tông Môn.',
                cost: 5000, // [MODIFIED] x10 (500 -> 5000)
                effect: { type: 'shopDiscount', value: 10 }, // %
                requires: 'max_members_3'
            },
            'shop_discount_2': {
                id: 'shop_discount_2',
                name: 'Thương Đạo II',
                desc: 'Giảm 20% giá mua vật phẩm trong Cửa Hàng Tông Môn.',
                cost: 15000, // [MODIFIED] x10 (1500 -> 15000)
                effect: { type: 'shopDiscount', value: 20 },
                requires: 'shop_discount_1'
            },
            // [NEW] Cấp 3-6
            'shop_discount_3': {
                id: 'shop_discount_3',
                name: 'Thương Đạo III',
                desc: 'Giảm 30% giá mua vật phẩm trong Cửa Hàng Tông Môn.',
                cost: 40000, // [MODIFIED] x10 (4000 -> 40000)
                effect: { type: 'shopDiscount', value: 30 },
                requires: 'shop_discount_2'
            },
            'shop_discount_4': {
                id: 'shop_discount_4',
                name: 'Thương Đạo IV',
                desc: 'Giảm 40% giá mua vật phẩm trong Cửa Hàng Tông Môn.',
                cost: 100000, // [MODIFIED] x10 (10000 -> 100000)
                effect: { type: 'shopDiscount', value: 40 },
                requires: 'shop_discount_3'
            },
            'shop_discount_5': {
                id: 'shop_discount_5',
                name: 'Thương Đạo V',
                desc: 'Giảm 45% giá mua vật phẩm trong Cửa Hàng Tông Môn.',
                cost: 250000, // [MODIFIED] x10 (25000 -> 250000)
                effect: { type: 'shopDiscount', value: 45 },
                requires: 'shop_discount_4'
            },
            'shop_discount_6': {
                id: 'shop_discount_6',
                name: 'Thương Đạo VI (Max)',
                desc: 'Giảm 50% giá mua vật phẩm trong Cửa Hàng Tông Môn.',
                cost: 500000, // [MODIFIED] x10 (50000 -> 500000)
                effect: { type: 'shopDiscount', value: 50 },
                requires: 'shop_discount_5'
            }
        };

        // [NEW] Sect Trials Database (Simple Click-based)
        const SECT_TRIALS_DB = {
            'trial_1': { 
                id: 'trial_1', name: 'Diễn Võ Trường (Sơ)', 
                desc: 'Tổ chức một buổi diễn võ cơ bản cho toàn bộ đệ tử.', 
                levelReq: 10, // Yêu cầu cấp độ của người chơi (Tông Chủ)
                cooldown: 5 * 60 * 1000, // 5 phút
                rewards: { xp: 10000 } // XP cho MỖI đệ tử
            },
            'trial_2': { 
                id: 'trial_2', name: 'Diễn Giải Võ Học', 
                desc: 'Mở đàn diễn giải võ học, tăng cường kiến thức cho đệ tử.', 
                levelReq: 25,
                cooldown: 30 * 60 * 1000, // 30 phút
                rewards: { xp: 60000 }
            },
            'trial_3': { 
                id: 'trial_3', name: 'Thí Luyện Đối Kháng', 
                desc: 'Tổ chức thí luyện đối kháng, tăng kinh nghiệm thực chiến.', 
                levelReq: 40,
                cooldown: 2 * 60 * 60 * 1000, // 2 giờ
                rewards: { xp: 250000 }
            },
            // [NEW] Thêm 2 hoạt động mới theo yêu cầu
            'trial_4': { 
                id: 'trial_4', name: 'Thí Luyện Mê Cung', 
                desc: 'Rèn luyện đệ tử trong ảo ảnh mê cung, tăng cường ý chí.', 
                levelReq: 50, // Yêu cầu cấp độ của người chơi
                cooldown: 4 * 60 * 60 * 1000, // 4 giờ
                rewards: { xp: 500000 } // 500k XP
            },
            'trial_5': { 
                id: 'trial_5', name: 'Thí Luyện Sinh Tử', 
                desc: 'Đưa đệ tử vào thí luyện khắc nghiệt nhất, mô phỏng chiến đấu sinh tử.', 
                levelReq: 60, // Yêu cầu cấp độ của người chơi
                cooldown: 8 * 60 * 60 * 1000, // 8 giờ
                rewards: { xp: 1200000 } // 1.2M XP
            },
            // [NEW] Thêm 3 hoạt động mới theo yêu cầu
            'trial_6': { 
                id: 'trial_6', name: 'Thí Luyện Tâm Ma', 
                desc: 'Đệ tử đối mặt với tâm ma, chiến thắng bản thân.', 
                levelReq: 80, // Yêu cầu cấp độ của người chơi
                cooldown: 12 * 60 * 60 * 1000, // 12 giờ
                rewards: { xp: 2500000 } // 2.5M XP
            },
            'trial_7': { 
                id: 'trial_7', name: 'Vượt Thiên Kiếp (Mô Phỏng)', 
                desc: 'Mô phỏng thiên kiếp, rèn luyện thân thể và ý chí.', 
                levelReq: 100, // Yêu cầu cấp độ của người chơi
                cooldown: 18 * 60 * 60 * 1000, // 18 giờ
                rewards: { xp: 5000000 } // 5M XP
            },
            'trial_8': { 
                id: 'trial_8', name: 'Luận Đạo Cùng Trời', 
                desc: 'Cảm ngộ thiên địa, tất cả đệ tử cùng luận đạo, tăng mạnh tu vi.', 
                levelReq: 120, // Yêu cầu cấp độ của người chơi
                cooldown: 24 * 60 * 60 * 1000, // 24 giờ
                rewards: { xp: 10000000 } // 10M XP
            },
            // [NEW] Thêm 4 hoạt động mới theo yêu cầu
            'trial_9': { 
                id: 'trial_9', name: 'Thí Luyện Kiếm Trận', 
                desc: 'Đệ tử tham gia diễn luyện kiếm trận thượng cổ, tăng cường khả năng chiến đấu.', 
                levelReq: 130, // Yêu cầu cấp độ của người chơi
                cooldown: 30 * 60 * 60 * 1000, // 30 giờ
                rewards: { xp: 15000000 } // 15M XP
            },
            'trial_10': { 
                id: 'trial_10', name: 'Thí Luyện Hư Không', 
                desc: 'Rèn luyện trong Hư Không Giới, chống lại áp lực không gian.', 
                levelReq: 140, // Yêu cầu cấp độ của người chơi
                cooldown: 36 * 60 * 60 * 1000, // 36 giờ
                rewards: { xp: 22000000 } // 22M XP
            },
            'trial_11': { 
                id: 'trial_11', name: 'Thí Luyện Thánh Địa', 
                desc: 'Gửi đệ tử tinh anh đến Thánh Địa Võ Lâm để lĩnh ngộ.', 
                levelReq: 150, // Yêu cầu cấp độ của người chơi
                cooldown: 42 * 60 * 60 * 1000, // 42 giờ
                rewards: { xp: 30000000 } // 30M XP
            },
            'trial_12': { 
                id: 'trial_12', name: 'Luận Anh Hùng', 
                desc: 'Mời các anh hùng trong thiên hạ đến Tông Môn luận đạo.', 
                levelReq: 160, // Yêu cầu cấp độ của người chơi
                cooldown: 48 * 60 * 60 * 1000, // 48 giờ
                rewards: { xp: 40000000 } // 40M XP
            },
            // [NEW] Thêm các thí luyện cấp cao (170 - 200)
            'trial_13': { 
                id: 'trial_13', name: 'Thí Luyện Hỗn Độn', 
                desc: 'Đệ tử tiến vào không gian hỗn độn sơ khai để rèn luyện thân thể.', 
                levelReq: 170, 
                cooldown: 54 * 60 * 60 * 1000, // 54 giờ
                rewards: { xp: 55000000 } // 55M XP
            },
            'trial_14': { 
                id: 'trial_14', name: 'Thí Luyện Hồng Hoang', 
                desc: 'Đối mặt với các dị thú thời hồng hoang, sinh tồn là chiến thắng.', 
                levelReq: 180, 
                cooldown: 60 * 60 * 60 * 1000, // 60 giờ
                rewards: { xp: 75000000 } // 75M XP
            },
            'trial_15': { 
                id: 'trial_15', name: 'Thí Luyện Thiên Đạo', 
                desc: 'Cảm ngộ ý chí của Thiên Đạo, bước một chân vào ngưỡng cửa siêu thoát.', 
                levelReq: 190, 
                cooldown: 72 * 60 * 60 * 1000, // 72 giờ
                rewards: { xp: 100000000 } // 100M XP
            },
            'trial_16': { 
                id: 'trial_16', name: 'Thí Luyện Vĩnh Hằng', 
                desc: 'Thử thách cuối cùng. Tìm kiếm ý nghĩa của sự vĩnh hằng trong dòng sông thời gian.', 
                levelReq: 200, 
                cooldown: 96 * 60 * 60 * 1000, // 96 giờ (4 ngày)
                rewards: { xp: 200000000 } // 200M XP
            }
        };

        // [NEW] Sect Missions Database (Similar to Trials, but with duration)
        const SECT_MISSIONS_DB = {
            'mission_1': { 
                id: 'mission_1', name: 'Tuần Tra Sơn Môn', 
                desc: 'Một nhiệm vụ đơn giản, đảm bảo an toàn cho sơn môn.', 
                levelReq: 1, // Yêu cầu cấp độ của ĐỆ TỬ
                duration: 5 * 60 * 1000, // 5 phút
                rewards: { diemCongHien: 1, nganLuong: 50000, xp: 501000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 5
            'mission_1_5': {
                id: 'mission_1_5', name: 'Hái Dược Liệu (Sơ)',
                desc: 'Thu thập một số dược liệu cơ bản quanh sơn môn.',
                levelReq: 5,
                duration: 10 * 60 * 1000, // 10 phút
                rewards: { diemCongHien: 2, nganLuong: 75000, xp: 525000 } // [MODIFIED] Thêm XP
            },
            'mission_2': { 
                id: 'mission_2', name: 'Hộ Tống Thương Đội', 
                desc: 'Bảo vệ một thương đội khỏi sơn tặc tại Tương Dương.', 
                levelReq: 10,
                duration: 30 * 60 * 1000, // 30 phút
                rewards: { diemCongHien: 5, nganLuong: 300000, xp: 600000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 15
            'mission_2_5': {
                id: 'mission_2_5', name: 'Truyền Tin Tương Dương',
                desc: 'Gửi một bức thư đến trạm dịch tại Tương Dương Thành.',
                levelReq: 15,
                duration: 45 * 60 * 1000, // 45 phút
                rewards: { diemCongHien: 8, nganLuong: 500000, xp: 725000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 20
            'mission_2_6': {
                id: 'mission_2_6', name: 'Diệt Sơn Tặc (Sơ)',
                desc: 'Tiêu diệt nhóm sơn tặc nhỏ quấy nhiễu dân làng gần đó.',
                levelReq: 20,
                duration: 1 * 60 * 60 * 1000, // 1 giờ
                rewards: { diemCongHien: 12, nganLuong: 1000000, xp: 900000 } // [MODIFIED] Thêm XP
            },
            'mission_3': { 
                id: 'mission_3', name: 'Diệt Trừ Mã Tặc', 
                desc: 'Tiêu diệt một nhóm mã tặc tại Phục Ngưu Sơn.', 
                levelReq: 25,
                duration: 2 * 60 * 60 * 1000, // 2 giờ
                rewards: { diemCongHien: 20, nganLuong: 1500000, xp: 1125000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 30
            'mission_3_5': {
                id: 'mission_3_5', name: 'Trấn Giữ Yếu Đạo',
                desc: 'Trấn giữ một yếu đạo quan trọng, ngăn chặn gián điệp địch.',
                levelReq: 30,
                duration: 2 * 30 * 60 * 1000, // 2.5 giờ
                rewards: { diemCongHien: 30, nganLuong: 3000000, xp: 1400000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 35
            'mission_3_6': {
                id: 'mission_3_6', name: 'Hộ Tống Trưởng Lão',
                desc: 'Hộ tống Trưởng Lão Tông Môn đi du ngoạn an toàn.',
                levelReq: 35,
                duration: 3 * 60 * 60 * 1000, // 3 giờ
                rewards: { diemCongHien: 40, nganLuong: 4000000, xp: 1725000 } // [MODIFIED] Thêm XP
            },
            'mission_4': { 
                id: 'mission_4', name: 'Điều Tra Võ Đang', 
                desc: 'Thu thập thông tin về động tĩnh gần đây của Võ Đang.', 
                levelReq: 40,
                duration: 4 * 60 * 60 * 1000, // 4 giờ
                rewards: { diemCongHien: 50, nganLuong: 5000000, xp: 2100000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 45
            'mission_4_5': {
                id: 'mission_4_5', name: 'Tìm Dược Liệu Quý',
                desc: 'Tìm kiếm Băng Hỏa Thảo trong một hang động nguy hiểm.',
                levelReq: 45,
                duration: 5 * 60 * 60 * 1000, // 5 giờ
                rewards: { diemCongHien: 65, nganLuong: 8000000, xp: 2525000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 50
            'mission_4_6': {
                id: 'mission_4_6', name: 'Khiêu Chiến Cao Thủ',
                desc: 'Đại diện tông môn tham gia đại hội võ lâm nhỏ.',
                levelReq: 50,
                duration: 6 * 60 * 60 * 1000, // 6 giờ
                rewards: { diemCongHien: 80, nganLuong: 12000000, xp: 3000000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 55
            'mission_4_7': {
                id: 'mission_4_7', name: 'Luyện Đan Hộ Pháp',
                desc: 'Hộ pháp cho Trưởng Lão Luyện Đan, chống lại sự quấy nhiễu.',
                levelReq: 55,
                duration: 7 * 60 * 60 * 1000, // 7 giờ
                rewards: { diemCongHien: 100, nganLuong: 18000000, xp: 3525000 } // [MODIFIED] Thêm XP
            },
            'mission_5': { 
                id: 'mission_5', name: 'Thám Hiểm Cán Viên Động', 
                desc: 'Thám hiểm Cán Viên Động, thu thập một số khoáng thạch hiếm.', 
                levelReq: 60,
                duration: 8 * 60 * 60 * 1000, // 8 giờ
                rewards: { diemCongHien: 120, nganLuong: 25000000, xp: 4100000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 65
            'mission_5_5': {
                id: 'mission_5_5', name: 'Tuần Tra Biên Giới',
                desc: 'Tuần tra biên giới Tống Kim, báo cáo động tĩnh của địch.',
                levelReq: 65,
                duration: 9 * 60 * 60 * 1000, // 9 giờ
                rewards: { diemCongHien: 150, nganLuong: 35000000, xp: 4725000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 70
            'mission_5_6': {
                id: 'mission_5_6', name: 'Diệt Thủy Tặc (Cao)',
                desc: 'Tiêu diệt thủ lĩnh Thủy Tặc Thái Hồ.',
                levelReq: 70,
                duration: 10 * 60 * 60 * 1000, // 10 giờ
                rewards: { diemCongHien: 180, nganLuong: 42000000, xp: 5400000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Thêm nhiệm vụ Cấp 75
            'mission_5_7': {
                id: 'mission_5_7', name: 'Bảo Vệ Yếu Nhân',
                desc: 'Bảo Vệ Yếu Nhân quan trọng khỏi sự truy sát.',
                levelReq: 75,
                duration: 11 * 60 * 60 * 1000, // 11 giờ
                rewards: { diemCongHien: 215, nganLuong: 48000000, xp: 6125000 } // [MODIFIED] Thêm XP
            },
            // [NEW] Nhiệm vụ Cấp 80 - 200
            'mission_6': {
                id: 'mission_6', name: 'Thám Hiểm Thập Nhị Cung',
                desc: 'Tiến vào Thập Nhị Cung tìm kiếm chòm sao thất lạc.',
                levelReq: 80,
                duration: 12 * 60 * 60 * 1000, // 12 giờ
                rewards: { diemCongHien: 250, nganLuong: 55000000, xp: 7000000 }
            },
            'mission_6_5': {
                id: 'mission_6_5', name: 'Trấn Áp Yêu Thú',
                desc: 'Hỗ trợ dân lành trấn áp yêu thú đang nổi loạn.',
                levelReq: 85,
                duration: 13 * 60 * 60 * 1000, // 13 giờ
                rewards: { diemCongHien: 280, nganLuong: 65000000, xp: 8000000 }
            },
            'mission_7': {
                id: 'mission_7', name: 'Tìm Kiếm Ngọc Hư Thành',
                desc: 'Lần theo dấu vết cổ xưa để tìm lối vào Ngọc Hư Thành.',
                levelReq: 90,
                duration: 14 * 60 * 60 * 1000, // 14 giờ
                rewards: { diemCongHien: 320, nganLuong: 75000000, xp: 9500000 }
            },
            'mission_7_5': {
                id: 'mission_7_5', name: 'Hộ Tống Thánh Vật',
                desc: 'Hộ tống thánh vật của bộ lạc cổ đại về nơi an toàn.',
                levelReq: 95,
                duration: 15 * 60 * 60 * 1000, // 15 giờ
                rewards: { diemCongHien: 360, nganLuong: 85000000, xp: 11000000 }
            },
            'mission_8': {
                id: 'mission_8', name: 'Tu La Chiến Trường',
                desc: 'Tham gia chiến trường Tu La để rèn luyện bản lĩnh.',
                levelReq: 100,
                duration: 16 * 60 * 60 * 1000, // 16 giờ
                rewards: { diemCongHien: 400, nganLuong: 100000000, xp: 13000000 }
            },
            'mission_9': {
                id: 'mission_9', name: 'Giải Cứu Linh Hồn',
                desc: 'Đi vào Lục Đạo Luân Hồi giải cứu linh hồn oan khuất.',
                levelReq: 110,
                duration: 18 * 60 * 60 * 1000, // 18 giờ
                rewards: { diemCongHien: 500, nganLuong: 130000000, xp: 16000000 }
            },
            'mission_10': {
                id: 'mission_10', name: 'Truy Tìm Hư Thiên Đỉnh',
                desc: 'Tìm kiếm tung tích của Hư Thiên Đỉnh trong truyền thuyết.',
                levelReq: 120,
                duration: 20 * 60 * 60 * 1000, // 20 giờ
                rewards: { diemCongHien: 650, nganLuong: 170000000, xp: 20000000 }
            },
            'mission_11': {
                id: 'mission_11', name: 'Long Tộc Giao Hảo',
                desc: 'Mang cống phẩm đến Long Tộc để thiết lập quan hệ.',
                levelReq: 130,
                duration: 22 * 60 * 60 * 1000, // 22 giờ
                rewards: { diemCongHien: 800, nganLuong: 220000000, xp: 25000000 }
            },
            'mission_12': {
                id: 'mission_12', name: 'Hỗn Độn Khai Phá',
                desc: 'Khai phá vùng đất Hỗn Độn, mở rộng lãnh thổ.',
                levelReq: 140,
                duration: 24 * 60 * 60 * 1000, // 24 giờ (1 ngày)
                rewards: { diemCongHien: 1000, nganLuong: 300000000, xp: 32000000 }
            },
            'mission_13': {
                id: 'mission_13', name: 'Tam Thanh Vệ Đạo',
                desc: 'Hỗ trợ Tam Thanh bảo vệ đạo pháp trước tà ma.',
                levelReq: 150,
                duration: 26 * 60 * 60 * 1000, // 26 giờ
                rewards: { diemCongHien: 1250, nganLuong: 400000000, xp: 40000000 }
            },
            'mission_14': {
                id: 'mission_14', name: 'Phong Thần Bảng',
                desc: 'Tìm kiếm các mảnh vỡ thất lạc của Phong Thần Bảng.',
                levelReq: 160,
                duration: 28 * 60 * 60 * 1000, // 28 giờ
                rewards: { diemCongHien: 1500, nganLuong: 550000000, xp: 50000000 }
            },
            'mission_15': {
                id: 'mission_15', name: 'Viễn Cổ Bí Cảnh',
                desc: 'Khám phá bí cảnh từ thời viễn cổ, tìm kiếm bảo vật.',
                levelReq: 170,
                duration: 30 * 60 * 60 * 1000, // 30 giờ
                rewards: { diemCongHien: 1800, nganLuong: 750000000, xp: 65000000 }
            },
            'mission_16': {
                id: 'mission_16', name: 'Thống Nhất Chiến Tuyến',
                desc: 'Liên kết các thế lực để chống lại sự xâm lăng của Thiên Ma.',
                levelReq: 180,
                duration: 32 * 60 * 60 * 1000, // 32 giờ
                rewards: { diemCongHien: 2200, nganLuong: 1000000000, xp: 85000000 }
            },
            'mission_17': {
                id: 'mission_17', name: 'Tinh Không Tuần Tra',
                desc: 'Tuần tra khu vực Tinh Không Đại Vực, đảm bảo an ninh.',
                levelReq: 190,
                duration: 36 * 60 * 60 * 1000, // 36 giờ (1.5 ngày)
                rewards: { diemCongHien: 2600, nganLuong: 1500000000, xp: 110000000 }
            },
            'mission_18': {
                id: 'mission_18', name: 'Bảo Vệ Thiên Đạo',
                desc: 'Nhiệm vụ tối thượng: Bảo vệ sự cân bằng của Thiên Đạo.',
                levelReq: 200,
                duration: 48 * 60 * 60 * 1000, // 48 giờ (2 ngày)
                rewards: { diemCongHien: 3500, nganLuong: 2500000000, xp: 150000000 }
            }
        };

        // [NEW] KINH MACH DATABASE (FULL - Final Version)
        const KINH_MACH_DB = {
            // --- BÁT MẠCH CƠ BẢN (Basic 8) --- (Max: ~38k)
            'nham_mach': { 
                name: "Nhâm Mạch", 
                icon: "fa-solid fa-arrow-up-from-water", 
                color: "text-blue-400",
                desc: "Mạch chủ của âm khí, bể chứa của các kinh âm, nuôi dưỡng sinh mệnh.",
                stats: { hp: 500, def: 50 }, 
                costBase: 1000, costMultiplier: 1.5 
            },
            'doc_mach': { 
                name: "Đốc Mạch", 
                icon: "fa-solid fa-fire", 
                color: "text-red-400",
                desc: "Mạch chủ của dương khí, bể chứa của các kinh dương, gia tăng sức mạnh.",
                stats: { atk: 50, hp: 200 },
                costBase: 1000, costMultiplier: 1.5 
            },
            'xung_mach': { 
                name: "Xung Mạch", 
                icon: "fa-solid fa-bolt", 
                color: "text-yellow-400",
                desc: "Huyết hải của 12 kinh, điều hòa khí huyết, bộc phát sức mạnh.",
                stats: { critChance: 0.5, critDamage: 5 }, 
                isPercent: true,
                costBase: 1000, costMultiplier: 1.5 
            },
            'doi_mach': { 
                name: "Đới Mạch", 
                icon: "fa-solid fa-ring", 
                color: "text-green-400",
                desc: "Vòng đai quanh eo, thắt chặt các kinh mạch dọc, thân pháp linh hoạt.",
                stats: { spd: 20, dodgeChance: 0.5 },
                costBase: 1000, costMultiplier: 1.5 
            },
            'am_duy_mach': { 
                name: "Âm Duy Mạch", 
                icon: "fa-solid fa-moon", 
                color: "text-purple-400",
                desc: "Duy trì sự cân bằng bên trong, hộ thể chân khí vững chắc.",
                stats: { def: 100, hp_p: 1 }, 
                costBase: 1000, costMultiplier: 1.5 
            },
            'duong_duy_mach': { 
                name: "Dương Duy Mạch", 
                icon: "fa-solid fa-sun", 
                color: "text-orange-400",
                desc: "Duy trì sự cân bằng bên ngoài, cường hóa công kích ngoại tại.",
                stats: { atk: 100, atk_p: 1 }, 
                costBase: 1000, costMultiplier: 1.5 
            },
            'am_kieu_mach': { 
                name: "Âm Kiều Mạch", 
                icon: "fa-solid fa-shoe-prints", 
                color: "text-indigo-400",
                desc: "Chủ vận động của âm, giúp thân thể dẻo dai bền bỉ.",
                stats: { hp: 1000, lifesteal: 0.5 },
                costBase: 1000, costMultiplier: 1.5 
            },
            'duong_kieu_mach': { 
                name: "Dương Kiều Mạch", 
                icon: "fa-solid fa-shoe-prints", 
                color: "text-pink-400",
                desc: "Chủ vận động của dương, giúp xuất chiêu thần tốc.",
                stats: { spd: 50, ignoreDef_p: 0.5 },
                costBase: 1000, costMultiplier: 1.5 
            },

            // --- TỨ ĐẠI ẨN MẠCH (Hidden 4) --- (Max: ~192k)
            'thien_mon_mach': { 
                name: "Thiên Môn Mạch", 
                icon: "fa-solid fa-dungeon", 
                color: "text-cyan-300",
                desc: "Cánh cửa thông thiên, khai mở tiềm năng vô hạn của cơ thể.",
                stats: { atk_p: 0.5, hp_p: 0.5, def_p: 0.5, spd_p: 0.5 }, 
                costBase: 5000, costMultiplier: 1.5 
            },
            'dia_ho_mach': { 
                name: "Địa Hộ Mạch", 
                icon: "fa-solid fa-mountain-city", 
                color: "text-stone-400",
                desc: "Sức mạnh của đất mẹ, mình đồng da sắt, vạn pháp bất xâm.",
                stats: { def_p: 2, block_chance_p: 1 }, 
                costBase: 5000, costMultiplier: 1.5 
            },
            'sinh_tu_mach': { 
                name: "Sinh Tử Mạch", 
                icon: "fa-solid fa-skull-crossbones", 
                color: "text-gray-200",
                desc: "Nắm giữ quy luật sự sống và cái chết, đoạt sinh cơ kẻ địch.",
                stats: { lifesteal: 1, manasteal: 0.5 }, 
                costBase: 5000, costMultiplier: 1.5 
            },
            'luan_hoi_mach': { 
                name: "Luân Hồi Mạch", 
                icon: "fa-solid fa-infinity", 
                color: "text-rainbow-animation", 
                desc: "Vượt qua lục đạo luân hồi, vận mệnh nằm trong tay ta.",
                stats: { lck: 10, xp_boost: 5 }, 
                costBase: 5000, costMultiplier: 1.5 
            },

            // --- NGŨ HÀNH CHÂN MẠCH --- (Max: ~768k)
            'kim_mach': { 
                name: "Kim Mạch", 
                icon: "fa-solid fa-gavel", 
                color: "text-yellow-200", 
                desc: "Ngũ hành chi Kim, sắc bén vô song, công phá vạn vật.",
                stats: { atk_p: 1.5, ignoreDef_p: 1 }, 
                costBase: 20000, costMultiplier: 1.5 
            },
            'moc_mach': { 
                name: "Mộc Mạch", 
                icon: "fa-solid fa-tree", 
                color: "text-green-500", 
                desc: "Ngũ hành chi Mộc, sinh cơ dồi dào, hồi phục bất tận.",
                stats: { hp_p: 2, lifesteal: 0.5 }, 
                costBase: 20000, costMultiplier: 1.5 
            },
            'thuy_mach': { 
                name: "Thủy Mạch", 
                icon: "fa-solid fa-water", 
                color: "text-blue-500", 
                desc: "Ngũ hành chi Thủy, nhu hòa uyển chuyển, thân pháp vô định.",
                stats: { mana_p: 2, dodgeChance: 1 }, 
                costBase: 20000, costMultiplier: 1.5 
            },
            'hoa_mach': { 
                name: "Hỏa Mạch", 
                icon: "fa-solid fa-fire-flame-curved", 
                color: "text-red-500", 
                desc: "Ngũ hành chi Hỏa, bùng nổ dữ dội, thiêu rụi mọi thứ.",
                stats: { atk_p: 1, critDamage: 15 }, 
                costBase: 20000, costMultiplier: 1.5 
            },
            'tho_mach': { 
                name: "Thổ Mạch", 
                icon: "fa-solid fa-mountain", 
                color: "text-amber-700", 
                desc: "Ngũ hành chi Thổ, vững chãi như núi, phòng thủ kiên cố.",
                stats: { def_p: 2, block_chance_p: 1 }, 
                costBase: 20000, costMultiplier: 1.5 
            },

            // --- SONG TUYỆT TÂM MẠCH --- (Max: ~1.9M)
            'tien_tam_mach': { 
                name: "Tiên Tâm Mạch", 
                icon: "fa-solid fa-cloud-sun", 
                color: "text-pulse-holy-glow", 
                desc: "Tâm tĩnh như nước, vạn pháp bất xâm. Cảnh giới của Chân Tiên.",
                stats: { anti_crit_p: 2, anti_block_p: 2, xp_boost: 10 }, 
                costBase: 50000, costMultiplier: 1.5 
            },
            'ma_tam_mach': { 
                name: "Ma Tâm Mạch", 
                icon: "fa-solid fa-skull", 
                color: "text-purple-600", 
                desc: "Dục vọng vô tận, sức mạnh hủy diệt. Cảnh giới của Ma Tôn.",
                stats: { atk_p: 5, lifesteal: 2 }, 
                costBase: 50000, costMultiplier: 1.5 
            },

            // --- TỨ TƯỢNG TINH MẠCH --- (Max: ~3.8M)
            'thanh_long_mach': { 
                name: "Thanh Long Mạch", 
                icon: "fa-solid fa-dragon", 
                color: "text-teal-400", 
                desc: "Thanh Long ẩn hiện trong mây, mang lại sinh cơ và uy quyền đế vương.",
                stats: { hp_p: 2, atk_p: 1.5 }, 
                costBase: 100000, costMultiplier: 1.5 
            },
            'bach_ho_mach': { 
                name: "Bạch Hổ Mạch", 
                icon: "fa-solid fa-cat", 
                color: "text-slate-200", 
                desc: "Bạch Hổ chủ sát phạt, móng vuốt sắc bén xé toạc mọi phòng ngự.",
                stats: { critDamage: 15, ignoreDef_p: 1 }, 
                costBase: 100000, costMultiplier: 1.5 
            },
            'chu_tuoc_mach': { 
                name: "Chu Tước Mạch", 
                icon: "fa-solid fa-feather", 
                color: "text-red-600", 
                desc: "Chu Tước tắm lửa tái sinh, thân pháp nhanh như chớp giật.",
                stats: { spd: 50, lifesteal: 0.5 }, 
                costBase: 100000, costMultiplier: 1.5 
            },
            'huyen_vu_mach': { 
                name: "Huyền Vũ Mạch", 
                icon: "fa-solid fa-shield-virus", 
                color: "text-indigo-500", 
                desc: "Huyền Vũ vững chãi như núi Thái Sơn, lấy tĩnh chế động.",
                stats: { def_p: 2.5, block_chance_p: 1 }, 
                costBase: 100000, costMultiplier: 1.5 
            },

            // --- TỨ ĐẠI CỔ MẠCH --- (Max: ~9.6M)
            'ban_co_mach': { 
                name: "Bàn Cổ Mạch", 
                icon: "fa-solid fa-hammer", 
                color: "text-stone-500", 
                desc: "Sức mạnh Bàn Cổ khai thiên lập địa, thân thể vĩnh cửu bất diệt.",
                stats: { hp_p: 3, def_p: 3 }, 
                costBase: 250000, costMultiplier: 1.5 
            },
            'nu_oa_mach': { 
                name: "Nữ Oa Mạch", 
                icon: "fa-solid fa-dna", 
                color: "text-emerald-400", 
                desc: "Nữ Oa tạo ra muôn loài, sinh cơ bất diệt, hồi phục thần tốc.",
                stats: { mana_p: 3, lifesteal: 1 }, 
                costBase: 250000, costMultiplier: 1.5 
            },
            'xi_vuu_mach': { 
                name: "Xi Vưu Mạch", 
                icon: "fa-solid fa-skull", 
                color: "text-red-700", 
                desc: "Chiến thần thượng cổ, sát khí ngút trời, bách chiến bách thắng.",
                stats: { atk_p: 3, critDamage: 20 }, 
                costBase: 250000, costMultiplier: 1.5 
            },
            'de_tuan_mach': { 
                name: "Đế Tuấn Mạch", 
                icon: "fa-solid fa-crown", 
                color: "text-yellow-500", 
                desc: "Thượng cổ Thiên Đế, thống lĩnh yêu tộc, uy quyền tối thượng.",
                stats: { spd: 100, accuracy_p: 2 }, 
                costBase: 250000, costMultiplier: 1.5 
            },

            // --- THIÊN ĐỊA HUYỀN HOÀNG --- (Max: ~19.2M)
            'thien_mach': { 
                name: "Thiên Mạch", 
                icon: "fa-solid fa-cloud-bolt", 
                color: "text-sky-300", 
                desc: "Thiên đạo mênh mông, uy áp vạn vật. Lưới trời lồng lộng.",
                stats: { atk_p: 4, accuracy_p: 3 }, 
                costBase: 500000, costMultiplier: 1.5 
            },
            'dia_mach': { 
                name: "Địa Mạch", 
                icon: "fa-solid fa-mountain-sun", 
                color: "text-amber-600", 
                desc: "Địa đạo dày nặng, chở che chúng sinh. Đất dày tải vật.",
                stats: { hp_p: 4, block_chance_p: 2 }, 
                costBase: 500000, costMultiplier: 1.5 
            },
            'huyen_mach': { 
                name: "Huyền Mạch", 
                icon: "fa-solid fa-moon", 
                color: "text-indigo-400", 
                desc: "Huyền chi hựu huyền, chúng diệu chi môn. Sâu xa khôn lường.",
                stats: { mana_p: 4, dodgeChance: 1.5 }, 
                costBase: 500000, costMultiplier: 1.5 
            },
            'hoang_mach': { 
                name: "Hoàng Mạch", 
                icon: "fa-solid fa-sun", 
                color: "text-yellow-600", 
                desc: "Hoàng đạo chính thống, khí vận gia thân. Vạn tà bất xâm.",
                stats: { lck: 20, critDamage: 25 }, 
                costBase: 500000, costMultiplier: 1.5 
            },

            // --- LỤC ĐẠO CHÂN MẠCH --- (Max: ~38.4M)
            'thien_dao_mach': { 
                name: "Thiên Đạo Mạch", 
                icon: "fa-solid fa-cloud-sun-rain", 
                color: "text-sky-200", 
                desc: "Đứng đầu lục đạo, hưởng phước báu vô lượng. Thân thể gần với thần thánh.",
                stats: { hp_p: 1, atk_p: 1, def_p: 1, spd_p: 1, ignoreDef_p: 2 }, 
                costBase: 1000000, costMultiplier: 1.5 
            },
            'a_tu_la_mach': { 
                name: "A Tu La Mạch", 
                icon: "fa-solid fa-mask", 
                color: "text-red-600", 
                desc: "Chiến thần hiếu sát, sức mạnh dời non lấp biển nhưng tâm tính nóng nảy.",
                stats: { atk_p: 5, critDamage: 30 }, 
                costBase: 1000000, costMultiplier: 1.5 
            },
            'nhan_dao_mach': { 
                name: "Nhân Đạo Mạch", 
                icon: "fa-solid fa-user", 
                color: "text-yellow-200", 
                desc: "Cõi người trung dung, có trí tuệ và khí vận, dễ dàng tu luyện.",
                stats: { xp_boost: 20, lck: 30 }, 
                costBase: 1000000, costMultiplier: 1.5 
            },
            'suc_sinh_mach': { 
                name: "Súc Sinh Mạch", 
                icon: "fa-solid fa-paw", 
                color: "text-amber-600", 
                desc: "Bản năng hoang dã, sức sống mãnh liệt và tốc độ của loài thú.",
                stats: { hp_p: 6, spd: 150 }, 
                costBase: 1000000, costMultiplier: 1.5 
            },
            'nga_quy_mach': { 
                name: "Ngạ Quỷ Mạch", 
                icon: "fa-solid fa-face-grin-tongue-squint", 
                color: "text-purple-800", 
                desc: "Cơn đói khát vĩnh cửu, cắn nuốt sinh mệnh và linh lực kẻ khác.",
                stats: { lifesteal: 2, manasteal: 2 }, 
                costBase: 1000000, costMultiplier: 1.5 
            },
            'dia_nguc_mach': { 
                name: "Địa Ngục Mạch", 
                icon: "fa-solid fa-dungeon", 
                color: "text-gray-800 text-shadow-white", 
                desc: "Chịu đựng khổ hình muôn kiếp, rèn luyện ý chí sắt đá và thân thể kim cương.",
                stats: { def_p: 5, anti_crit_p: 5 }, 
                costBase: 1000000, costMultiplier: 1.5 
            },

            // --- TAM ĐẠI SÁT MẠCH --- (Max: ~76.8M)
            'that_sat_mach': { 
                name: "Thất Sát Mạch", 
                icon: "fa-solid fa-khanda", 
                color: "text-rose-600", 
                desc: "Chủ về quyền bính và sát phạt. Tướng tinh dũng mãnh, tiến chứ không lùi.",
                stats: { atk_p: 6, spd_p: 3 }, 
                costBase: 2000000, costMultiplier: 1.5 
            },
            'pha_quan_mach': { 
                name: "Phá Quân Mạch", 
                icon: "fa-solid fa-meteor", 
                color: "text-orange-600", 
                desc: "Chủ về hao tán và dũng cảm. Tiên phong phá trận, không gì cản nổi.",
                stats: { critChance: 2, ignoreDef_p: 3 }, 
                costBase: 2000000, costMultiplier: 1.5 
            },
            'tham_lang_mach': { 
                name: "Tham Lang Mạch", 
                icon: "fa-solid fa-wolf-pack-browser", 
                color: "text-purple-500", 
                desc: "Chủ về họa phúc và dục vọng. Biến hóa khôn lường, tham lam vô độ.",
                stats: { lifesteal: 3, lck: 50 }, 
                costBase: 2000000, costMultiplier: 1.5 
            },

            // --- TAM ĐẠI CHỦ MẠCH --- (Max: ~153M)
            'tu_vi_mach': { 
                name: "Tử Vi Mạch", 
                icon: "fa-solid fa-crown", 
                color: "text-yellow-400 text-shadow-gold", 
                desc: "Đế Tinh Bắc Cực, chủ tể các sao. Mệnh cách đế vương, thống lĩnh vạn vật.",
                stats: { hp_p: 2, atk_p: 2, def_p: 2, spd_p: 2, mana_p: 2, lck_p: 2 }, 
                costBase: 4000000, costMultiplier: 1.5 
            },
            'thien_phu_mach': { 
                name: "Thiên Phủ Mạch", 
                icon: "fa-solid fa-building-columns", 
                color: "text-emerald-300", 
                desc: "Lệnh Tinh chưởng quản tài khố. Phú quý vinh hoa, thân thể kim ngọc.",
                stats: { hp_p: 8, def_p: 8 }, 
                costBase: 4000000, costMultiplier: 1.5 
            },
            'thien_co_mach': { 
                name: "Thiên Cơ Mạch", 
                icon: "fa-solid fa-brain", 
                color: "text-sky-400", 
                desc: "Thiện Tinh chưởng quản trí tuệ. Mưu lược túc trí, thấu hiểu thiên cơ.",
                stats: { mana_p: 8, dodgeChance: 3 }, 
                costBase: 4000000, costMultiplier: 1.5 
            },

            // --- NGŨ THÁI KHỞI NGUYÊN --- (Max: ~230M)
            'thai_dich_mach': { 
                name: "Thái Dịch Mạch", 
                icon: "fa-solid fa-wind", 
                color: "text-gray-500", 
                desc: "Trạng thái hư vô tịch mịch, chưa thấy khí. Thân pháp như sương khói.",
                stats: { dodgeChance: 5, manasteal: 3 }, 
                costBase: 6000000, costMultiplier: 1.5 
            },
            'thai_so_mach': { 
                name: "Thái Sơ Mạch", 
                icon: "fa-solid fa-cloud", 
                color: "text-white", 
                desc: "Khởi nguồn của khí, vô hình vô chất. Sinh mệnh và nội lực vô tận.",
                stats: { hp_p: 10, mana_p: 10 }, 
                costBase: 6000000, costMultiplier: 1.5 
            },
            'thai_thuy_mach': { 
                name: "Thái Thủy Mạch", 
                icon: "fa-solid fa-cube", 
                color: "text-blue-300", 
                desc: "Khởi nguồn của hình, hữu hình vô chất. Thân thể kim cương bất hoại.",
                stats: { def_p: 10, block_chance_p: 5 }, 
                costBase: 6000000, costMultiplier: 1.5 
            },
            'thai_to_mach': { 
                name: "Thái Tố Mạch", 
                icon: "fa-solid fa-gem", 
                color: "text-rose-400", 
                desc: "Khởi nguồn của chất, hữu hình hữu chất. Sức mạnh dời non lấp biển.",
                stats: { atk_p: 10, critDamage: 50 }, 
                costBase: 6000000, costMultiplier: 1.5 
            },
            'thai_cuc_mach': { 
                name: "Thái Cực Mạch", 
                icon: "fa-solid fa-yin-yang", 
                color: "text-black border-white border-2 rounded-full", 
                desc: "Âm dương phân tách, vạn vật sinh sôi. Công thủ toàn diện.",
                stats: { hp_p: 5, atk_p: 5, def_p: 5, ignoreDef_p: 5 }, 
                costBase: 6000000, costMultiplier: 1.5 
            },

            // --- CHUNG CỰC --- (Max: ~307M)
            'dai_dao_mach': { 
                name: "Đại Đạo Mạch", 
                icon: "fa-solid fa-atom", 
                color: "text-rainbow-animation font-black text-xl", 
                desc: "Đạo khả đạo, phi thường Đạo. Nắm giữ quy luật vũ trụ, siêu thoát luân hồi.",
                stats: { 
                    hp_p: 10, atk_p: 10, def_p: 10, spd_p: 10, 
                    lck: 50, critChance: 5, critDamage: 50, 
                    dodgeChance: 5, block_chance_p: 5, ignoreDef_p: 5 
                }, 
                costBase: 8000000, costMultiplier: 1.5 
            },

            // --- THƯỢNG CỔ THẦN KHÍ --- (Max: ~384M)
            'dong_hoang_mach': {
                name: "Đông Hoàng Mạch",
                icon: "fa-solid fa-bell", 
                color: "text-yellow-500 text-shadow-gold", 
                desc: "Lấy Đông Hoàng Chung làm mạch. Tiếng chuông vang vọng, trấn áp hồng mông khí vận.",
                stats: { def_p: 20, anti_crit_p: 10, anti_block_p: 10 }, 
                costBase: 10000000, costMultiplier: 1.5
            },
            'hien_vien_mach': {
                name: "Hiên Viên Mạch",
                icon: "fa-solid fa-khanda", 
                color: "text-amber-400", 
                desc: "Lấy Hiên Viên Kiếm làm mạch. Thánh đạo chi kiếm, trảm yêu trừ ma, hiệu lệnh thiên hạ.",
                stats: { atk_p: 25, accuracy_p: 10 }, 
                costBase: 10000000, costMultiplier: 1.5
            },
            'khai_thien_mach': {
                name: "Khai Thiên Mạch",
                icon: "fa-solid fa-hammer", 
                color: "text-stone-200", 
                desc: "Lấy Bàn Cổ Phủ làm mạch. Một búa bổ ra thiên địa, phá vỡ mọi quy tắc hỗn độn.",
                stats: { critDamage: 100, ignoreDef_p: 10 }, 
                costBase: 10000000, costMultiplier: 1.5
            },
            'thoi_khong_mach': {
                name: "Thời Không Mạch",
                icon: "fa-solid fa-clock-rotate-left", 
                color: "text-cyan-400", 
                desc: "Lấy Côn Luân Kính làm mạch. Xuyên thấu thời gian và không gian, một ngày bằng ngàn năm.",
                stats: { spd: 500, dodgeChance: 5, xp_boost: 50 }, 
                costBase: 10000000, costMultiplier: 1.5
            },

            // --- VŨ TRỤ DIỄN HÓA --- (Max: ~461M)
            'hac_dong_mach': {
                name: "Hắc Động Mạch",
                icon: "fa-solid fa-circle-dot", 
                color: "text-black border-purple-500 border-2 rounded-full shadow-[0_0_15px_#a855f7]", 
                desc: "Hóa thân thành Hố Đen. Lực hút vô tận, không gì có thể thoát khỏi, kể cả ánh sáng.",
                stats: { lifesteal: 5, manasteal: 5, ignoreDef_p: 20 }, 
                costBase: 12000000, costMultiplier: 1.5
            },
            'tinh_van_mach': {
                name: "Tinh Vân Mạch",
                icon: "fa-solid fa-cloud-meatball", 
                color: "text-fuchsia-400 text-shadow-neon", 
                desc: "Nơi sinh ra các vì sao. Nguồn năng lượng vô tận, bùng nổ sự sống.",
                stats: { hp_p: 50, mana_p: 50 }, 
                costBase: 12000000, costMultiplier: 1.5
            },
            'thien_ha_mach': {
                name: "Thiên Hà Mạch",
                icon: "fa-solid fa-spinner fa-spin", 
                color: "text-blue-300", 
                desc: "Chứa đựng hàng tỷ ngôi sao. Mênh mông vô bờ bến.",
                stats: { def_p: 50, dodgeChance: 10 }, 
                costBase: 12000000, costMultiplier: 1.5
            },

            // --- CHÂN LÝ TỐI THƯỢNG --- (Max: ~499M)
            'nhan_qua_mach': {
                name: "Nhân Quả Mạch",
                icon: "fa-solid fa-scale-balanced", 
                color: "text-gray-200", 
                desc: "Gieo nhân nào gặt quả nấy. Lưới trời lồng lộng, tuy thưa mà khó lọt.",
                stats: { accuracy_p: 50, anti_block_p: 20, anti_crit_p: 20 }, 
                costBase: 13000000, costMultiplier: 1.5
            },
            'van_menh_mach': {
                name: "Vận Mệnh Mạch",
                icon: "fa-solid fa-dice-d20", 
                color: "text-yellow-300", 
                desc: "Nắm giữ vận mệnh, chúa tể của sự ngẫu nhiên. Mọi thứ đều nằm trong tính toán.",
                stats: { lck: 500, critChance: 20, critDamage: 200 }, 
                costBase: 13000000, costMultiplier: 1.5
            },

            // --- ĐẤNG SÁNG TẠO --- (Max: ~420M - Giảm Multiplier để an toàn)
            'sang_tao_mach': {
                name: "Sáng Tạo Mạch",
                icon: "fa-solid fa-code", 
                color: "text-green-400 font-mono", 
                desc: "Quyền năng của Lập Trình Viên. Sửa đổi thực tại, viết lại quy luật thế giới.",
                stats: { 
                    hp_p: 100, atk_p: 100, def_p: 100, spd_p: 100, 
                    xp_boost: 1000 
                }, 
                costBase: 15000000, costMultiplier: 1.45
            }
        };

        const initialGameData = {
            createdAt: 0, // [NEW] Thời gian tạo nhân vật
            player: {
                level: 1,
                xp: 0,
                xpToNext: getXpToNext(1), 
                currentHp: 100, 
                currentMana: 50,
                honLuc: 100, 
                monPhai: 'tieu_dao', 
                unlockedHonKy: [], 
                kinhMach: {}, 
                freeSectChange: true,
                // [NEW] Hệ thống Tiềm Năng
                potentialPoints: 0, // Điểm tiềm năng chưa dùng
                allocatedStats: {   // Điểm đã cộng
                    suc_manh: 0,    // Sức Mạnh
                    than_phap: 0,   // Thân Pháp
                    sinh_khi: 0,    // Sinh Khí
                    hon_luc: 0      // Hồn Lực
                }
            },
            nganLuong: 100000000,
            kimNguyenBao: 100,
            linhKhi: 0, // [NEW] Add Linh Khí
            linhThach: 0, // [NEW] Add Linh Thạch (Động Phủ)
            chanKhi: 0, // [NEW] Chân Khí (Kinh Mạch)
            lastChanKhiUpdate: Date.now(), // [NEW] Theo dõi thời gian nhận Chân Khí tự động
            uyDanh: 0, // [NEW] Added Uy Danh (Prestige)
            danhVong: 0, // [NEW] Add Danh Vong (Fame Points)
            rebirthCount: 0, // [NEW] Add Rebirth Count
            diemCongHien: 0, // [NEW] Add Sect Contribution Points
            sieuVietPoints: 0, // [NEW] Add Transcendence Points
            diemVinhDuLienDau: 0, // [NEW] Add Arena Points
            diemTichLuyTongKim: 0, // [NEW] Add Battlefield Points
            thanCach: 0, // [NEW] Thêm điểm Thần Cách
            linhHonThach: 0, // [NEW] Add Linh Hồn Thạch (Mệnh Cách)
            menhCachInventory: [], // [NEW] Kho chứa Mệnh Cách (Cát + Hung)
            summonHistory: [], // [NEW] Lịch sử quay Mệnh Cách
            equippedMenhCachSlots: Array(10).fill(null), // [NEW] 10 ô trang bị Mệnh Cách
            menhCachUnlockedSlots: 10, // [MODIFIED] Mở toàn bộ 10 ô
            
            // [NEW] Lưu trữ Kỳ Ngộ đang chờ xử lý
            pendingEvent: null,

            // [NEW] Arena Data (Võ Đài Thần Ma)
            arena: {
                rank: 1,
                points: 0,
                wins: 0,
                losses: 0,
                lastSalaryClaim: null, // Ngày nhận lương cuối (YYYY-MM-DD)
                opponents: [], // Danh sách đối thủ hiện tại { name, power, avatar, id, rewardPoints }
                lastRefresh: 0, // Thời gian làm mới đối thủ
                battleLog: [] // [NEW] Lịch sử đấu trường
            },

            // [NEW] Cultivation Data
            canhGioi: 'pham_nhan', // Realm ID
            tuVi: 0, // Cultivation progress in current realm
            tienLuc: 0, // [NEW] Ascension/Prestige currency
            lastTienLucClaim: null, // [NEW] Daily Tien Luc claim tracker

            // [NEW] Permanent Stats from Tinh Phach
            permanentStats: {
                hp: 0,
                def: 0,
                atk: 0,
                xp_boost: 0
            },

            // [NEW] Be Quan (AFK Cultivation) Data
            isBeQuan: false,
            beQuanStartTime: null,
            lastBeQuanClaim: null,
            
            gearInventory: [], // NEW: Holds { uniqueId, baseId, name, type, level, quality, affixes }
            items: { // { id: count } - Holds stackable potions
                'item_hp_small': 5,
                'item_mana_small': 3
            },
            materials: { // NEW: For idle skill materials
                // 'fish_common_1': 10
            },
            idleSkills: { // NEW: For idle skill progression
                fishing: { level: 1, xp: 0, xpToNext: 100 },
                mining: { level: 1, xp: 0, xpToNext: 100 },
                herbalism: { level: 1, xp: 0, xpToNext: 100 } // [NEW]
            },
            equippedSlots: { // NEW 6-slot system (will store uniqueId)
                weapon: null,
                armor: null,
                accessory1: null,
                accessory2: null,
                accessory3: null,
                accessory4: null,
                // [NEW] Add slots 5 and 6
                accessory5: null,
                accessory6: null,
            },
            
            unlockedDungeons: ['map01'],
            quests: {}, // Placeholder
            lastSave: null,
            lastQuestReset: new Date().toISOString().slice(0, 10),
            
            isTraining: false,
            currentMapId: null,
            trainingLog: [],
            
            isIdling: false, // NEW: Parallel to isTraining
            currentIdleAction: null, // NEW: e.g., 'fishing_spot_1'
            idleSkillType: null, // NEW: 'fishing'
            idleLog: [], // NEW: Log for idle actions
            idleLogMining: [], // [NEW] Separate log for mining
            idleLogHerbalism: [], // [NEW] Separate log for herbalism
            lastIdleTick: 0, // NEW: Timestamp for parallel idle loop

            autoSell: { // NEW: Added to fix error
                common: false,
                uncommon: false
            },

            // Turn-Based Combat State
            turnBasedCombat: {
                active: false,
                mapId: null,
                enemy: { // Sẽ lưu trữ 1 bản sao của Kẻ thù
                    // dbId: 'dll_mob_1',
                    // name: 'Hồn Thú...',
                    // stats: { ... },
                    // currentHp: 50,
                    // maxHp: 50
                },
                companion: null, // [MODIFIED] Renamed from 'disciple'
                log: [],
                playerTurn: true,
                playerBuffs: [], // [NEW]
                enemyBuffs: [] // [NEW]
            },

            // [FIX] Thêm dữ liệu Tông Môn còn thiếu vào đây
            sect: {
                founded: true,
                name: "Luân Hồi",
                level: 1,
                reputation: 0,
                maxMembers: 10, 
                combatChampionId: null, 
                upgrades: [], 
                log: [],
                missionCooldowns: {}, 
                trialCooldowns: {}, 
                challengeCooldowns: {}, 
                dungeonCooldowns: {}, 
                chienTruongCooldowns: {}, 
                warehouse: { materials: {}, items: {}, gear: [] }, 
                // [NEW] Add Linh Tri data
                linhTri: {
                    level: 1,
                    currentLinhKhi: 0,
                    lastUpdateTime: Date.now()
                },
                // [NEW] Add Lãnh Địa data
                capturedTerritories: {}, 
                territoryCaptureMission: null, 
                // [NEW] Động Phủ - Cập nhật đầy đủ các keys để tránh lỗi khi New Game
                dongPhu: {
                    'linh_dien': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'linh_dien_trung_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'linh_dien_cao_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'linh_dien_sieu_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'linh_dien_than_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    
                    'tu_luyen_dai': { level: 0, current: 0, lastUpdateTime: Date.now() }, 
                    'tu_luyen_dai_trung_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'tu_luyen_dai_cao_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'tu_luyen_dai_sieu_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'tu_luyen_dai_than_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    
                    'luyen_dan_phong': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'luyen_dan_phong_trung_cap': { level: 0, current: 0, lastUpdateTime: Date.now() }, 
                    'luyen_dan_phong_cao_cap': { level: 0, current: 0, lastUpdateTime: Date.now() }, 
                    'luyen_dan_phong_sieu_cap': { level: 0, current: 0, lastUpdateTime: Date.now() }, 
                    'luyen_dan_phong_than_cap': { level: 0, current: 0, lastUpdateTime: Date.now() }, 
                    
                    'luyen_khi_cac': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'luyen_khi_cac_trung_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'luyen_khi_cac_cao_cap': { level: 0, current: 0, lastUpdateTime: Date.now() }, 
                    'luyen_khi_cac_sieu_cap': { level: 0, current: 0, lastUpdateTime: Date.now() }, 
                    'luyen_khi_cac_than_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    
                    // [NEW] Dược Viên
                    'duoc_vien': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'duoc_vien_trung_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'duoc_vien_cao_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'duoc_vien_sieu_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'duoc_vien_than_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },

                    // [NEW] Khoáng Trường
                    'khoang_truong': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'khoang_truong_trung_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'khoang_truong_cao_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'khoang_truong_sieu_cap': { level: 0, current: 0, lastUpdateTime: Date.now() },
                    'khoang_truong_than_cap': { level: 0, current: 0, lastUpdateTime: Date.now() }
                },
                songTuPairs: [], 
                loiDaiRankings: [], 
                loiDaiLog: [], // [NEW] Khởi tạo log Lôi Đài
                // [NEW] Thêm dữ liệu cho Ám Ảnh Kiếm Ảnh vào gameData ban đầu
                amAnhKiemAnh: {
                    attempts: 0,
                    lastDate: null
                }
            }, 
            disciples: [], // [FIX] Initialize disciples array
            sungVat: [] // [FIX] Initialize sungVat array
        };

        // --- CORE GAME FUNCTIONS ---
        function showScreen(screenId) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
            
            // [NEW] Kích hoạt vòng lặp kiểm tra Chân Khí (độc lập với gameLoop chiến đấu)
            if (!window.chanKhiInterval) {
                window.chanKhiInterval = setInterval(updateChanKhiPassive, 1000); // Kiểm tra mỗi giây
            }
        }

        // [NEW] Hàm xử lý Chân Khí tự động (Online)
        function updateChanKhiPassive() {
            if (!gameData) return;
            
            const now = Date.now();
            const RATE_PER_MINUTE = 30;
            const MS_PER_TICK = 60000; // 1 phút = 60000ms
            
            if (!gameData.lastChanKhiUpdate) gameData.lastChanKhiUpdate = now;

            const diff = now - gameData.lastChanKhiUpdate;
            
            if (diff >= MS_PER_TICK) {
                // Tính số phút đã trôi qua
                const minutesPassed = Math.floor(diff / MS_PER_TICK);
                const gained = minutesPassed * RATE_PER_MINUTE;
                
                if (gained > 0) {
                    gameData.chanKhi = (gameData.chanKhi || 0) + gained;
                    // Cập nhật lại mốc thời gian (giữ lại phần dư giây lẻ để tính tiếp)
                    gameData.lastChanKhiUpdate += (minutesPassed * MS_PER_TICK);
                    
                    // Cập nhật UI nếu đang mở tab Kinh Mạch
                    const ckDisplay = document.getElementById('chankhi-display');
                    if (ckDisplay) ckDisplay.textContent = gameData.chanKhi.toLocaleString();
                    
                    const kmCkDisplay = document.getElementById('km-chankhi-display'); // ID mới trong panel
                    if (kmCkDisplay) kmCkDisplay.textContent = gameData.chanKhi.toLocaleString();
                    
                    // Log nhẹ (tùy chọn, tắt để đỡ spam)
                    // console.log(`[Đan Điền] Tự động thu nạp ${gained} Chân Khí.`);
                }
            }
        }

        // [MODIFIED] Nâng cấp thông báo (To hơn, lâu hơn)
        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            
            // Sử dụng innerHTML để hỗ trợ các thẻ in đậm nếu có
            toast.innerHTML = message;
            
            // [MODIFIED] Style mới: To hơn (text-lg, py-4, px-8), Nổi bật hơn (shadow-2xl, border-2)
            const baseClasses = "fixed bottom-8 right-8 text-white text-lg font-bold py-4 px-8 rounded-xl shadow-2xl z-[100] border-2 transition-all transform duration-300 flex items-center gap-3";
            const colorClasses = isSuccess 
                ? "bg-green-700/95 border-green-400 shadow-green-900/50" 
                : "bg-red-700/95 border-red-400 shadow-red-900/50";
            
            toast.className = `${baseClasses} ${colorClasses}`;
            toast.classList.remove('hidden');
            
            // Xóa timeout cũ nếu có để tránh bị đóng sớm khi spam thông báo
            if (window.toastTimeout) {
                clearTimeout(window.toastTimeout);
            }
            
            // [MODIFIED] Tăng thời gian lên 5 giây
            window.toastTimeout = setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        // --- [NEW] AUTO SAVE SYSTEM ---
        const AUTO_SAVE_KEY = 'VLLH_AUTO_SAVE_DATA';
        let autoSaveInterval = null;

        // Lưu vào LocalStorage (Chạy ngầm)
        function saveToLocalStorage() {
            if (!gameData) return;
            try {
                gameData.lastSave = new Date().toISOString();
                
                // Cắt bớt log để tránh quá tải dung lượng lưu trữ cục bộ
                const tempData = JSON.parse(JSON.stringify(gameData));
                
                // [FIX] Add safety checks for log arrays
                if (tempData.trainingLog && tempData.trainingLog.length > 50) tempData.trainingLog = tempData.trainingLog.slice(0, 50);
                if (tempData.idleLog && tempData.idleLog.length > 50) tempData.idleLog = tempData.idleLog.slice(0, 50);
                if (tempData.sect && tempData.sect.log && tempData.sect.log.length > 50) tempData.sect.log = tempData.sect.log.slice(0, 50);
                
                // [FIX] Clean up new logs if they exist
                if (tempData.idleLogMining && tempData.idleLogMining.length > 50) tempData.idleLogMining = tempData.idleLogMining.slice(0, 50);
                if (tempData.idleLogHerbalism && tempData.idleLogHerbalism.length > 50) tempData.idleLogHerbalism = tempData.idleLogHerbalism.slice(0, 50);

                // Xóa log turn-based vì không cần lưu
                if (tempData.turnBasedCombat) tempData.turnBasedCombat.log = [];

                localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(tempData));
                // console.log("Đã tự động lưu: " + new Date().toLocaleTimeString());
            } catch (e) {
                console.error("Lỗi Auto-Save:", e);
                // showToast("Lỗi: Không thể tự động lưu (Bộ nhớ đầy?)", false);
            }
        }

        // Bắt đầu vòng lặp Auto Save
        function startAutoSaveLoop() {
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(() => {
                saveToLocalStorage();
                // showToast("Đã tự động lưu game.", true); // Tùy chọn: Hiện thông báo hoặc không
            }, 60000); // 60 giây
        }

        // Kiểm tra xem có file save cũ không để hiện nút Tiếp Tục
        function checkAndShowContinueBtn() {
            const saveStr = localStorage.getItem(AUTO_SAVE_KEY);
            const btnContinue = document.getElementById('btn-continue');
            if (saveStr && btnContinue) {
                btnContinue.classList.remove('hidden');
            }
        }

        // Hàm Tiếp Tục Game
        function continueGame() {
            const saveStr = localStorage.getItem(AUTO_SAVE_KEY);
            if (!saveStr) {
                showToast("Không tìm thấy dữ liệu lưu!", false);
                return;
            }
            
            try {
                const loadedData = JSON.parse(saveStr);
                if (loadGame(loadedData)) {
                    showScreen('main-screen');
                    updateUI();
                    showToast("Chào mừng quay trở lại!", true);
                    startAutoSaveLoop(); // Bắt đầu auto save
                } else {
                    showToast("File lưu bị lỗi!", false);
                }
            } catch (e) {
                console.error("Lỗi tải auto-save:", e);
                showToast("File lưu tự động bị hỏng!", false);
            }
        }

        // --- MODAL FUNCTIONS ---
        function showModal(modalId) {
            document.getElementById(modalId)?.classList.remove('hidden');
            renderModalContent(modalId);
        }

        function hideModal(modalId) {
            document.getElementById(modalId)?.classList.add('hidden');
            // [NEW] Clear boosting disciple ID when modal closes
            if (modalId === 'boost-disciple-modal') {
                currentBoostingDiscipleId = null;
            }
        }

        // --- HELPER FUNCTIONS ---
        function getStars(rarity) {
            return Array(rarity).fill('★').join('');
        }
        
        function getRarityClass(rarity) {
            switch (rarity) {
                case 1: return 'text-gray-300'; // Common
                case 2: return 'text-blue-400'; // Uncommon
                case 3: return 'text-purple-400'; // Rare
                case 4: return 'text-yellow-400'; // Legendary
                case 5: return 'text-red-500'; // Mythic
                case 6: return 'text-orange-400'; // Ancient
                case 7: return 'text-pink-400';   // Divine
                case 8: return 'text-violet-400'; // Celestial
                case 9: return 'text-fuchsia-400 text-pulse-glow'; // Transcendent
                case 10: return 'quality-supergodly'; // Siêu Thần
                case 11: return 'text-rainbow-animation text-sparkle'; // Tối Thượng
                // [NEW] Hiệu ứng cho các cấp độ mới
                case 12: return 'text-rainbow-animation text-pulse-void-glow font-extrabold'; // Hỗn Độn
                case 13: return 'text-rainbow-animation text-pulse-abyss-glow font-extrabold'; // Hồng Hoang
                case 14: return 'text-rainbow-animation text-pulse-ascension-glow font-black tracking-widest'; // Vĩnh Hằng
                // [NEW] Cấp độ Thiên Đạo & Sáng Thế
                case 15: return 'text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 font-black text-pulse-glow text-shadow-lg'; // Thiên Đạo
                case 16: return 'text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 font-black text-pulse-holy-glow tracking-widest uppercase'; // Sáng Thế
                default: return 'text-white';
            }
        }

        function calculateFullStats(unit, level) {
            const stats = {};
            for (const stat in unit.baseStats) {
                stats[stat] = unit.baseStats[stat] + (unit.potential[stat] * (level - 1));
            }
            return stats;
        }

        // --- START & SAVE/LOAD ---
        // [MODIFIED] Renamed to startNewGame for clarity
        function startNewGame() {
            // Confirmation if overwrite? (Optional, for now assume New Game means New Game)
            if (localStorage.getItem(AUTO_SAVE_KEY)) {
                if (!confirm("Bạn có chắc muốn chơi mới? Dữ liệu lưu tự động cũ sẽ bị ghi đè.")) return;
            }

            gameData = JSON.parse(JSON.stringify(initialGameData));
            gameData.createdAt = Date.now(); // [NEW] Ghi lại thời điểm tạo nhân vật
            
            // Generate starting gear
            // [MODIFIED] Replaced random weapon with the custom starter weapon
            const startWeapon = {
                uniqueId: crypto.randomUUID(),
                baseId: 'w1',
                name: "Thần Kiếm Tân Thủ",
                type: 'weapon',
                level: 1,
                quality: 'legendary', // This is a legendary item
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 500, display: 'Công Kích +500', isPercent: false },
                    { id: 'spd_p', name: 'Tốc Độ Đánh', value: 30, display: 'Tốc Độ Đánh +30%', isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 30, display: 'Hút Sinh Lực 30%', isPercent: true },
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 30, display: 'Hút Nội Lực 30%', isPercent: true },
                    { id: 'xp_boost', name: 'Kinh Nghiệm', value: 2000, display: 'Kinh Nghiệm +2000%', isPercent: true }
                ],
                upgradeLevel: 0 // [NEW]
            };
            
            const startArmor = generateEquipment(1);
            startArmor.name = "Áo Vải Tân Thủ";
            startArmor.quality = "common";
            
            gameData.gearInventory.push(startWeapon);
            gameData.gearInventory.push(startArmor);
            
            // Automatically equip them
            gameData.equippedSlots.weapon = startWeapon.uniqueId;
            gameData.equippedSlots.armor = startArmor.uniqueId;

            // Set initial HP/Mana based on stats
            const stats = getTotalStats(); // This will now include the new gear
            gameData.player.currentHp = stats.hp;
            gameData.player.currentMana = stats.mana;

            // [FIX] Thêm khởi tạo đệ tử khi bắt đầu game mới
            if (!gameData.disciples || gameData.disciples.length === 0) {
                gameData.disciples = createStartingDisciples();
                gameData.sect.maxMembers = 50; // [MODIFIED]
            }

            // [NEW] Add starting pet if player doesn't have one
            if (!gameData.sungVat || gameData.sungVat.length === 0) {
                gameData.sungVat = [
                    {
                        id: 'pet_001', // ID from SUNG_VAT_DB
                        level: 1,
                        xp: 0,
                        xpToNext: getPetXpToNext(1) // [MODIFIED] Use the correct function
                    }
                ];
            }

            showScreen('main-screen');
            updateUI();
            showToast("Tạo nhân vật thành công!", true);
            
            startAutoSaveLoop(); // [NEW] Bắt đầu auto save
            saveToLocalStorage(); // [NEW] Lưu ngay lập tức
        }
        
        // [FIX] Bổ sung các hàm Lưu/Tải game
        function saveGame() {
            try {
                gameData.lastSave = new Date().toISOString();
                
                // [FIX] Check existance before slicing
                if (gameData.trainingLog && gameData.trainingLog.length > MAX_LOG_LINES) {
                    gameData.trainingLog = gameData.trainingLog.slice(0, MAX_LOG_LINES);
                }
                if (gameData.idleLog && gameData.idleLog.length > MAX_LOG_LINES) {
                    gameData.idleLog = gameData.idleLog.slice(0, MAX_LOG_LINES);
                }
                if (gameData.sect && gameData.sect.log && gameData.sect.log.length > MAX_LOG_LINES * 2) {
                     gameData.sect.log = gameData.sect.log.slice(0, MAX_LOG_LINES * 2);
                }

                const dataStr = JSON.stringify(gameData);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.download = `HuyHuyyTruyenKy_Save_${Date.now()}.json`;
                link.href = url;
                link.click();
                
                URL.revokeObjectURL(url);
                showToast("Đã xuất file lưu game!", true);
            } catch (error) {
                console.error("Lỗi khi lưu game:", error);
                showToast("Lưu game thất bại!", false);
            }
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (loadGame(loadedData)) {
                        showScreen('main-screen');
                        updateUI();
                        showToast("Tải game thành công!", true);
                        startAutoSaveLoop(); // [NEW] Bắt đầu auto save sau khi load file
                    } else {
                        showToast("File save không hợp lệ!", false);
                    }
                } catch (error) {
                    console.error("Lỗi khi đọc file save:", error);
                    showToast("Lỗi: File save bị hỏng hoặc không đúng định dạng.", false);
                }
                // Reset file input to allow loading the same file again
                event.target.value = null;
            };
            reader.readAsText(file);
        }

        function loadGame(loadedData) {
            if (!loadedData || !loadedData.player || loadedData.nganLuong === undefined) {
                return false; // Invalid save file
            }
            
            // --- Data Migration ---
            // Create a fresh copy of initial data
            let freshData = JSON.parse(JSON.stringify(initialGameData));
            
            // Overwrite fresh data with loaded data, ensuring new fields are preserved
            gameData = { ...freshData, ...loadedData };
            
            // Manually merge nested player properties if missing
            // ... existing migration ...

            // [NEW] Migration for Dong Phu (Ensure new buildings exist in old saves)
            if (gameData.sect && gameData.sect.dongPhu) {
                const dp = gameData.sect.dongPhu;
                const now = Date.now();

                // ... (các check cũ) ...

                // [NEW] Dược Viên
                if (!dp['duoc_vien']) dp['duoc_vien'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['duoc_vien_trung_cap']) dp['duoc_vien_trung_cap'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['duoc_vien_cao_cap']) dp['duoc_vien_cao_cap'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['duoc_vien_sieu_cap']) dp['duoc_vien_sieu_cap'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['duoc_vien_than_cap']) dp['duoc_vien_than_cap'] = { level: 0, current: 0, lastUpdateTime: now };

                // [NEW] Khoáng Trường
                if (!dp['khoang_truong']) dp['khoang_truong'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['khoang_truong_trung_cap']) dp['khoang_truong_trung_cap'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['khoang_truong_cao_cap']) dp['khoang_truong_cao_cap'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['khoang_truong_sieu_cap']) dp['khoang_truong_sieu_cap'] = { level: 0, current: 0, lastUpdateTime: now };
                if (!dp['khoang_truong_than_cap']) dp['khoang_truong_than_cap'] = { level: 0, current: 0, lastUpdateTime: now };

            } else if (gameData.sect) {
                // Nếu sect.dongPhu chưa tồn tại thì tạo mới từ initial
                gameData.sect.dongPhu = JSON.parse(JSON.stringify(initialGameData.sect.dongPhu));
            }

            // ... existing migrations ...
            return true;
        }
        // --- [END FIX] ---

        // --- [NEW] EQUIPMENT FUNCTIONS (6-Slot) ---
        function equipItem(uniqueId) {
            const item = gameData.gearInventory.find(i => i.uniqueId === uniqueId);
            if (!item) {
                showToast("Không tìm thấy vật phẩm!", false); return;
            }

            let slotToEquip = null;
            
            // Find the correct slot type
            if (item.type === 'weapon') {
                slotToEquip = 'weapon';
            } else if (item.type === 'armor') {
                slotToEquip = 'armor';
            } else if (item.type === 'accessory') {
                // Find the first available accessory slot from 1 to 6
                const accSlots = ['accessory1', 'accessory2', 'accessory3', 'accessory4', 'accessory5', 'accessory6']; // [MODIFIED] Check all 6
                for (const slot of accSlots) {
                    if (!gameData.equippedSlots[slot]) {
                        slotToEquip = slot;
                        break;
                    }
                }
                // If all are full, default to replacing the first one
                if (!slotToEquip) slotToEquip = 'accessory1';
            }
            
            if (!slotToEquip) {
                showToast("Loại trang bị không xác định!", false); return;
            }

            // Check if the slot is already full (this will unequip the old item)
            // No need to manually unequip, just swap the uniqueId
            const oldItemId = gameData.equippedSlots[slotToEquip];
            
            gameData.equippedSlots[slotToEquip] = uniqueId;
            showToast(`Đã trang bị ${item.name}.`, true);
            
            // Re-render inventory & main UI
            renderModalContent('equipment-modal');
            updateUI();
        }

        function unequipItem(slotName) {
            const uniqueId = gameData.equippedSlots[slotName];
            if (!uniqueId) {
                 showToast("Không có gì ở ô này!", false); return;
            }
            
            const item = gameData.gearInventory.find(i => i.uniqueId === uniqueId);
            if (!item) {
                 // This should not happen, but good to check
                 showToast("Lỗi: Không tìm thấy vật phẩm đang mặc!", false);
                 gameData.equippedSlots[slotName] = null; // Clear broken link
                 return;
            }
            
            if (countInventorySlots() >= MAX_INVENTORY_SLOTS) {
                showToast("Hành trang đã đầy!", false); return;
            }

            gameData.equippedSlots[slotName] = null;
            showToast(`Đã gỡ ${item.name}.`, true);

            // Re-render inventory & main UI
            renderModalContent('equipment-modal');
            updateUI();
        }
        
        // --- [NEW] TOOLTIP FUNCTIONS ---
        function showTooltip(event, type, id) {
             const tooltip = document.getElementById('item-tooltip');
             let content = '';

             try {
                 if (type === 'equipment' || type === 'item') {
                     // ... (Giữ nguyên code cũ cho trang bị/vật phẩm) ...
                     let item = gameData.gearInventory.find(i => i.uniqueId === id);
                     if (!item) item = STATIC_ITEM_DB[id];
                     if (!item) { tooltip.style.display = 'none'; return; }
                     
                     // Build content
                     const quality = item.quality ? QUALITY_DB[item.quality] : null;
                     const qualityClass = quality ? quality.className : getRarityClass(item.rarity);
                     
                     // [NEW] Add upgrade level display
                     const upgradeText = (item.upgradeLevel > 0) ? ` <span class="text-yellow-300">[+${item.upgradeLevel}]</span>` : '';

                     content = `<h4 class="font-bold text-base mb-1 ${qualityClass}">${item.name}${upgradeText}</h4>`;
                     
                     if (quality) {
                         content += `<p class="text-xs mb-2" style="color: ${quality.color};">[${quality.name} - Cấp ${item.level}]</p>`;
                         // [NEW] Calculate and show upgraded stats
                         const upgradeBonusPercent = getUpgradeBonusPercent(item.upgradeLevel || 0);
                         const upgradeMultiplier = 1 + (upgradeBonusPercent / 100);

                         content += `<div class="text-xs space-y-0.5">`;
                         item.affixes.forEach(affix => {
                             // [MODIFIED] Use stored rarityClass for enchant, default to gray for others
                             let colorClass = 'text-gray-300';
                             if (affix.isEnchant) {
                                 // Fallback to 'text-green-400' if rarityClass is missing (for old saves)
                                 colorClass = affix.rarityClass || 'text-green-400';
                             }
                             
                             if (affix.isPercent) {
                                content += `<div class="${colorClass}">${affix.display}</div>`;
                             } else {
                                 // Show base + bonus
                                 const baseValue = affix.value;
                                 const upgradedValue = Math.floor(baseValue * upgradeMultiplier);
                                 if (upgradedValue > baseValue) {
                                     content += `<div class="${colorClass}">${affix.name} +${upgradedValue} (<span class="text-gray-400">${baseValue}</span> + <span class="text-yellow-300">${upgradedValue - baseValue}</span>)</div>`;
                                 } else {
                                     content += `<div class="${colorClass}">${affix.display}</div>`;
                                 }
                             }
                         });
                         content += `</div>`;
                     } else if (item.desc) {
                         content += `<p class="text-xs text-gray-300">${item.desc}</p>`;
                     }
                 } 
                 // [NEW] Add block for 'menh_cach'
                 else if (type === 'menh_cach') {
                    // ... (Giữ nguyên code cũ cho mệnh cách) ...
                    const instanceId = id;
                    const mcInstance = gameData.menhCachInventory.find(inv => inv.instanceId === instanceId);
                    
                    if (!mcInstance) {
                        tooltip.style.display = 'none'; return;
                    }
                    
                    const mcDB = MENH_CACH_DB[mcInstance.id];
                    if (!mcDB) { 
                        tooltip.style.display = 'none'; return;
                    }
                    
                    const quality = QUALITY_DB[mcDB.quality];
                    const qualityClass = quality.className;

                    if (mcDB.type === 'cat') {
                        const currentValue = mcDB.baseValue + (mcDB.scaleValue * (mcInstance.level - 1));
                        let desc = mcDB.baseDesc.replace('{value}', `<strong>${currentValue}</strong>`);

                        content = `<h4 class="font-bold text-base mb-1 ${qualityClass}">${mcDB.name} (Cấp ${mcInstance.level})</h4>`;
                        content += `<p class="text-xs mb-2" style="color: ${quality.color};">[${quality.name} - Cát Mệnh]</p>`;
                        content += `<p class="text-sm text-yellow-300 mb-1">${desc}</p>`;
                        content += `<p class="text-xs text-gray-400">${mcDB.scaleDesc.replace('{scale}', mcDB.scaleValue)}</p>`;
                        content += `<p class="text-xs text-gray-500 mt-2">Bán nhận: ${mcDB.sellPrice || 0} LHT</p>`;
                    } else {
                        content = `<h4 class="font-bold text-base mb-1 ${qualityClass}">${mcDB.name}</h4>`;
                        content += `<p class="text-xs mb-2" style="color: ${quality.color};">[${quality.name} - Hung Mệnh]</p>`;
                        content += `<p class="text-sm text-red-400 mb-1">${mcDB.desc}</p>`;
                        content += `<p class="text-xs text-gray-500 mt-2">Tự động bán nhận: ${mcDB.sellPrice || 0} LHT</p>`;
                    }
                 }
                 // [NEW] Tooltip cho Cấp Bậc (Rank Bonus)
                 else if (type === 'rank_bonus') {
                    const rankName = id;
                    const bonus = RANK_BONUS_STATS[rankName];
                    
                    if (!bonus) {
                        tooltip.style.display = 'none'; return;
                    }

                    content = `<h4 class="font-bold text-base mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-200 text-center border-b border-gray-600 pb-1">${rankName}</h4>`;
                    content += `<p class="text-[10px] text-gray-400 mb-2 text-center italic">Thưởng thuộc tính cấp bậc</p>`;
                    content += `<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">`;
                    content += `<div class="flex justify-between"><span class="text-gray-400">HP:</span> <span class="text-red-400 font-mono font-bold">+${bonus.hp.toLocaleString()}</span></div>`;
                    content += `<div class="flex justify-between"><span class="text-gray-400">Công:</span> <span class="text-orange-400 font-mono font-bold">+${bonus.atk.toLocaleString()}</span></div>`;
                    content += `<div class="flex justify-between"><span class="text-gray-400">Thủ:</span> <span class="text-blue-400 font-mono font-bold">+${bonus.def.toLocaleString()}</span></div>`;
                    content += `<div class="flex justify-between"><span class="text-gray-400">Thân:</span> <span class="text-green-400 font-mono font-bold">+${bonus.spd.toLocaleString()}</span></div>`;
                    content += `</div>`;
                 }
                 // [NEW] Tooltip cho Phẩm Chất (Potential XP Bonus)
                 else if (type === 'potential_bonus') {
                    const potentialName = id;
                    const bonusPercent = POTENTIAL_XP_BONUS[potentialName] || 0;
                    const multiplier = 1 + (bonusPercent / 100);

                    // Xác định màu tiêu đề dựa trên tên phẩm chất (đơn giản hóa)
                    let headerClass = 'text-white';
                    if (['Thiên Tài', 'Tuyệt Thế', 'Thiên Kiêu Chi Tử'].includes(potentialName)) headerClass = 'text-yellow-300';
                    else if (['Nghịch Thiên Cải Mệnh', 'Vô Cực Đạo Thể', 'Vạn Đạo Chi Tổ'].includes(potentialName)) headerClass = 'text-red-400';
                    else if (['Chân Ngã Duy Nhất', 'Nhất Niệm Vĩnh Hằng'].includes(potentialName)) headerClass = 'text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 via-white to-cyan-300 animate-pulse';

                    content = `<h4 class="font-bold text-base mb-2 text-center border-b border-gray-600 pb-1 ${headerClass}">${potentialName}</h4>`;
                    content += `<p class="text-xs text-gray-400 mb-2 text-center uppercase tracking-wider">Hiệu quả Tu Luyện</p>`;
                    content += `<div class="text-center mb-2">`;
                    content += `<span class="text-2xl font-black text-green-400 drop-shadow-md">+${bonusPercent.toLocaleString()}%</span>`;
                    content += `<span class="text-xs text-gray-500 block mt-0.5">Kinh Nghiệm</span>`;
                    content += `</div>`;
                    content += `<div class="bg-black/40 rounded p-1.5 text-center border border-gray-700">`;
                    content += `<p class="text-[10px] text-gray-400">Tốc độ tu luyện thực tế:</p>`;
                    content += `<p class="text-sm font-bold text-yellow-300">x${multiplier.toLocaleString()} lần</p>`;
                    content += `</div>`;
                 }
                 // [NEW] Tooltip cho Khí Vận (Destiny Bonus) - Cập nhật giao diện đẹp
                 else if (type === 'destiny_bonus') {
                    const destinyKey = id;
                    const info = DESTINY_DB[destinyKey] || DESTINY_DB['PHAM_NHAN'];
                    
                    // Style header dynamic
                    let headerClass = 'text-white';
                    let glowStyle = '';
                    
                    if (destinyKey === 'THIEN_TIEN') {
                        headerClass = 'text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-300 via-pink-200 to-fuchsia-300 animate-pulse';
                        glowStyle = 'shadow-[0_0_15px_rgba(216,180,254,0.3)]';
                    }
                    else if (destinyKey === 'NGHICH_THIEN') {
                        headerClass = 'text-red-500 font-black';
                        glowStyle = 'shadow-[0_0_15px_rgba(239,68,68,0.3)]';
                    }
                    else if (destinyKey === 'TIEN_THIEN') {
                        headerClass = 'text-cyan-300 font-bold';
                        glowStyle = 'shadow-[0_0_15px_rgba(103,232,249,0.3)]';
                    }
                    else if (destinyKey === 'HOANG_GIA') {
                        headerClass = 'text-yellow-400 font-bold';
                        glowStyle = 'shadow-[0_0_15px_rgba(250,204,21,0.3)]';
                    }

                    content = `<div class="relative overflow-hidden rounded-lg">`;
                    // Background effect
                    if (destinyKey !== 'PHAM_NHAN') {
                        content += `<div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>`;
                    }
                    
                    content += `<h4 class="font-bold text-base mb-2 text-center border-b border-gray-600 pb-2 ${headerClass} flex items-center justify-center gap-2">
                        <i class="${info.icon}"></i> ${info.name}
                    </h4>`;
                    
                    content += `<div class="bg-black/30 p-2 rounded mb-3 border border-gray-700/50 italic text-center text-xs text-gray-400">`;
                    content += `"${info.desc}"`;
                    content += `</div>`;
                    
                    content += `<div class="bg-gray-800/80 rounded p-2 border border-gray-600 ${glowStyle}">`;
                    content += `<p class="text-[10px] text-gray-500 uppercase tracking-wide mb-1 font-bold text-center">Hiệu Quả Khí Vận</p>`;
                    content += `<p class="text-sm text-green-400 font-bold text-center">${info.bonus}</p>`;
                    content += `</div>`;
                    content += `</div>`;
                 }
                 // [NEW] Tooltip cho Cảnh Giới (Realm Bonus)
                 else if (type === 'realm_bonus') {
                    const realmId = id;
                    const realm = CANH_GIOI_DB[realmId];
                    if (!realm) { tooltip.style.display = 'none'; return; }

                    const bonuses = realm.bonusStats || {};
                    
                    // Header
                    content = `<h4 class="font-bold text-base mb-2 text-center text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-orange-300 to-yellow-200 border-b border-gray-600 pb-1">${realm.name}</h4>`;
                    content += `<p class="text-[10px] text-gray-400 mb-2 text-center italic">Chỉ số cộng thêm từ Cảnh Giới</p>`;
                    
                    content += `<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs bg-gray-800/50 p-2 rounded border border-gray-700">`;
                    
                    // Hiển thị các chỉ số cơ bản trước
                    if (bonuses.hp) content += `<div class="flex justify-between"><span class="text-gray-400">Sinh Lực:</span> <span class="text-red-400 font-mono font-bold">+${bonuses.hp.toLocaleString()}</span></div>`;
                    if (bonuses.atk) content += `<div class="flex justify-between"><span class="text-gray-400">Công Kích:</span> <span class="text-orange-400 font-mono font-bold">+${bonuses.atk.toLocaleString()}</span></div>`;
                    if (bonuses.def) content += `<div class="flex justify-between"><span class="text-gray-400">Phòng Thủ:</span> <span class="text-blue-400 font-mono font-bold">+${bonuses.def.toLocaleString()}</span></div>`;
                    
                    // Hiển thị các chỉ số phụ/đặc biệt
                    for (const key in bonuses) {
                        if (['hp', 'atk', 'def'].includes(key)) continue; // Đã hiển thị ở trên
                        
                        let label = key;
                        let val = bonuses[key];
                        let color = 'text-white';
                        let suffix = '';
                        
                        if (key === 'critChance') { label = 'Chí Mạng'; suffix = '%'; color = 'text-yellow-300'; }
                        else if (key === 'critDamage') { label = 'ST Bạo Kích'; suffix = '%'; color = 'text-red-500'; }
                        else if (key === 'spd') { label = 'Thân Pháp'; color = 'text-green-400'; }
                        else if (key === 'lifesteal') { label = 'Hút Máu'; suffix = '%'; color = 'text-rose-400'; }
                        else if (key === 'ignoreDef_p') { label = 'Xuyên Giáp'; suffix = '%'; color = 'text-purple-400'; }
                        else if (key === 'doubleAtkChance') { label = 'Liên Kích'; suffix = '%'; color = 'text-cyan-300'; }
                        else if (key === 'anti_crit_p') { label = 'Kháng Bạo'; suffix = '%'; color = 'text-indigo-300'; }
                        else if (key.endsWith('_p')) { 
                            // Xử lý các chỉ số % chung (hp_p, atk_p...)
                            const mapName = {
                                'hp_p': 'Sinh Lực', 'atk_p': 'Công Kích', 'def_p': 'Phòng Thủ', 
                                'spd_p': 'Thân Pháp', 'lck_p': 'May Mắn'
                            };
                            label = mapName[key] || key.replace('_p', '').toUpperCase();
                            suffix = '%';
                            color = 'text-green-300';
                        }
                        
                        content += `<div class="flex justify-between"><span class="text-gray-400">${label}:</span> <span class="${color} font-mono font-bold">+${val}${suffix}</span></div>`;
                    }
                    content += `</div>`;
                    
                    // Hiển thị thêm mô tả nếu có
                    if (realm.desc) {
                        content += `<p class="text-[10px] text-gray-500 mt-2 italic text-center border-t border-gray-700 pt-1">"${realm.desc}"</p>`;
                    }
                 }
                 // [NEW] Tooltip cho Thiên Phú (Talent)
                 else if (type === 'talent') {
                    const talentName = id;
                    // Tìm thiên phú trong TALENT_DB theo tên
                    const talent = TALENT_DB.find(t => t.name === talentName);
                    if (!talent) { tooltip.style.display = 'none'; return; }

                    const qualityClass = getTalentColorClass(talent.quality);
                    // Map phẩm chất sang tên hiển thị tiếng Việt
                    const QUALITY_NAMES = {
                        'eternal': 'Vĩnh Hằng',
                        'supergodly': 'Siêu Thần',
                        'supreme': 'Chí Tôn',
                        'mythic': 'Thần Thoại',
                        'epic': 'Sử Thi',
                        'rare': 'Quý',
                        'uncommon': 'Thường',
                        'common': 'Phàm'
                    };
                    const qualityName = QUALITY_NAMES[talent.quality] || 'Thường';

                    content = `<div class="relative overflow-hidden rounded-lg">`;
                    // Header
                    content += `<h4 class="font-bold text-base mb-1 text-center border-b border-gray-600 pb-2 ${qualityClass}">${talent.name}</h4>`;
                    content += `<p class="text-[10px] text-center text-gray-400 mb-3 bg-gray-900/50 py-0.5 rounded">[${qualityName} Thiên Phú]</p>`;
                    
                    // Mô tả
                    content += `<div class="bg-black/30 p-2 rounded mb-3 border border-gray-700/50 italic text-center text-xs text-gray-300 leading-relaxed">`;
                    content += `"${talent.desc}"`;
                    content += `</div>`;

                    // Stats Grid
                    if (talent.stats) {
                         content += `<div class="bg-gray-800/80 rounded p-2 border border-gray-600 shadow-inner">`;
                         content += `<p class="text-[9px] text-gray-500 uppercase tracking-widest mb-2 font-bold text-center border-b border-gray-700 pb-1">Chỉ Số Cộng Thêm</p>`;
                         content += `<div class="grid grid-cols-2 gap-x-3 gap-y-1 text-xs">`;
                         
                         for (const [key, val] of Object.entries(talent.stats)) {
                             let label = key;
                             let valDisplay = `+${val.toLocaleString()}`;
                             let color = 'text-white';
                             
                             if(key === 'hp') { label = 'Sinh Lực'; color = 'text-red-400'; }
                             else if(key === 'atk') { label = 'Công Kích'; color = 'text-orange-400'; }
                             else if(key === 'def') { label = 'Phòng Thủ'; color = 'text-blue-400'; }
                             else if(key === 'spd') { label = 'Thân Pháp'; color = 'text-green-400'; }
                             else if(key === 'lck') { label = 'May Mắn'; color = 'text-yellow-400'; }
                             else if(key === 'mana') { label = 'Nội Lực'; color = 'text-blue-300'; }
                             else if(key === 'honLuc') { label = 'Hồn Lực'; color = 'text-purple-400'; }
                             else if(key === 'crit') { label = 'Chí Mạng'; valDisplay += '%'; color = 'text-yellow-300'; }
                             else if(key === 'critDamage') { label = 'ST Bạo Kích'; valDisplay += '%'; color = 'text-red-500'; }
                             else if(key === 'dodge') { label = 'Né Tránh'; valDisplay += '%'; color = 'text-green-300'; }
                             else if(key === 'accuracy') { label = 'Chính Xác'; valDisplay += '%'; color = 'text-cyan-300'; }
                             else if(key === 'lifesteal') { label = 'Hút Máu'; valDisplay += '%'; color = 'text-rose-400'; }
                             else if(key === 'manasteal') { label = 'Hút Mana'; valDisplay += '%'; color = 'text-indigo-400'; }
                             else if(key === 'si_khi') { label = 'Sĩ Khí'; color = 'text-yellow-200'; }
                             else if(key === 'ignoreDef_p') { label = 'Xuyên Giáp'; valDisplay += '%'; color = 'text-gray-300'; }
                             
                             content += `<div class="flex justify-between items-center"><span class="text-gray-400">${label}</span> <span class="${color} font-mono font-bold">${valDisplay}</span></div>`;
                         }
                         content += `</div></div>`;
                    }
                    content += `</div>`;
                 }
                 // [END NEW]
                 else {
                     return; // Unknown tooltip type
                 }
             } catch (e) {
                 console.error("Tooltip error:", e);
                 tooltip.style.display = 'none';
                 return;
             }
             
             tooltip.innerHTML = content;
             // ... (Phần hiển thị và định vị tooltip giữ nguyên) ...
             tooltip.style.display = 'block';

             // Clear previous timeout if one exists
             if (tooltipTimeout) {
                 clearTimeout(tooltipTimeout);
             }

             // Position tooltip
             tooltipTimeout = setTimeout(() => {
                 const rect = event.target.getBoundingClientRect();
                 const tooltipRect = tooltip.getBoundingClientRect();
                 
                 let top = rect.top - tooltipRect.height - 10; // 10px offset above
                 let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2); // Centered
                 
                 // Adjust if off-screen top
                 if (top < 0) {
                     top = rect.bottom + 10; // 10px offset below
                 }
                 // Adjust if off-screen left
                 if (left < 0) {
                     left = 5;
                 }
                 // Adjust if off-screen right
                 if (left + tooltipRect.width > window.innerWidth) {
                     left = window.innerWidth - tooltipRect.width - 5;
                 }

                 tooltip.style.top = `${top + window.scrollY}px`;
                 tooltip.style.left = `${left + window.scrollX}px`;
             }, 10); // 10ms delay
        }

        function hideTooltip() {
            if (tooltipTimeout) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = null;
            }
            document.getElementById('item-tooltip').style.display = 'none';
        }
        
        // --- GAME DATABASE (Tiêu Dao Tử RPG Theme) ---

        const PLAYER_DATA = {
            name: 'Vạn Sinh Chủ', // [MODIFIED] Đổi tên nhân vật
            rarity: 5,
            baseStats: { hp: 100, mana: 50, honLuc: 100, atk: 9, def: 8, spd: 9, lck: 8 }, 
            potential: { hp: 9, mana: 5, honLuc: 10, atk: 5, def: 4, spd: 5, lck: 4 }, 
            icon: 'fa-solid fa-user-ninja', // Player icon (Fallback nếu không có ảnh)
            // [NEW] Ảnh Avatar nhân vật (Thay link ảnh của bạn vào đây)
            // Kích thước khuyến nghị: Hình vuông (1:1), tối thiểu 128x128px
            avatar: 'https://i.imgur.com/F5WRF5x.jpeg' 
        };

        // [DELETED] Old PLAYER_SKILLS_DB
        
        // [NEW] Master Skill Database for all Martial Sects (Môn Phái)
        const MON_PHAI_SKILLS_DB = {
            'tieu_dao': {
                name: 'Tiêu Dao Phái',
                icon: 'fa-solid fa-fan',
                className: 'text-cyan-300 text-shadow-cyan', // [NEW] Style
                desc: 'Môn phái giang hồ, võ công thanh thoát, tốc độ và sát thương cân bằng.',
                skills: [
                    { level: 1, name: 'Kiếm Khí Nhập Môn', type: 'Tấn công sơ cấp', desc: 'Gây sát thương vật lý cơ bản (ATK × 1.0). Tỉ lệ chí mạng +5%.', 
                      chance: 0, multiplier: 1, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Kiếm Ý Sơ Tâm', type: 'Bị động', desc: 'Mỗi 5 giây, đòn đánh kế tiếp tăng 5% sát thương (cộng dồn).', 
                      passive: true, manaCost: 0 }, // Passive logic needs implementation
                    { level: 20, name: 'Tản Hoa Kiếm Ảnh', type: 'Tấn công trung cấp', desc: 'Chém 2 lần liên tiếp, mỗi đòn ATK × 1.3. Tỉ lệ chí mạng +10%.', 
                      chance: 40, multiplier: 1.3, hits: 2, ignoreDef: 0, bonusCrit: 10, manaCost: 5 },
                    { level: 30, name: 'Văn Yên Kiếm Pháp', type: 'Buff tấn công', desc: 'Tăng tốc đánh +10% và sát thương +10% trong 15 giây.', 
                      chance: 30, effect: { type: 'buff', stat: 'spd', value: 0.1, duration: 15 }, effect2: { type: 'buff', stat: 'atk', value: 0.1, duration: 15 }, manaCost: 10 },
                    { level: 50, name: 'Độc Cô Tâm Kiếm', type: 'Sát thương trung cấp', desc: 'Ba nhát kiếm liên hoàn (Tổng ATK × 2.2), giảm DEF địch 10%.', 
                      chance: 45, multiplier: 0.73, hits: 3, ignoreDef: 0, effect: { type: 'debuff', stat: 'def', value: -0.1, duration: 10 }, manaCost: 15 },
                    { level: 60, name: 'Tử Hà Tâm Pháp', type: 'Buff phòng thủ', desc: 'Tăng Sinh lực tối đa +20%, tốc đánh +15% trong 15 giây.', 
                      chance: 25, effect: { type: 'buff', stat: 'hp', value: 0.2, duration: 15 }, effect2: { type: 'buff', stat: 'spd', value: 0.15, duration: 15 }, manaCost: 12 },
                    { level: 80, name: 'Vô Song Kiếm Trận', type: 'Sát thương cao cấp', desc: 'Gọi kiếm khí, gây ATK × 1.5 và +20% sát thương toàn đội trong 10 giây.', 
                      chance: 35, multiplier: 1.5, hits: 1, ignoreDef: 0.1, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 10 }, manaCost: 20 },
                    { level: 120, name: 'Tọa Vọng Kiếm Tâm', type: 'Buff cao cấp', desc: 'Tăng 20% sát thương, +15% kháng tất cả trong 15 giây.', 
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.15, duration: 15 }, manaCost: 25 },
                    { level: 150, name: 'Cửu Kiếm Hợp Nhất', type: 'Tấn công siêu cấp', desc: 'Một đòn cực mạnh, gây ATK × 5.0, 100% chí mạng, bỏ qua toàn bộ phòng ngự.', 
                      chance: 50, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 100, manaCost: 50 },
                    { level: 180, name: 'Lăng Ba Vi Bộ', type: 'Bị động', desc: 'Tăng 15% Né Tránh và 15% Tốc Độ Đánh.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 15 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 15 } }
                ]
            },
            'thieu_lam': {
                name: 'Thiếu Lâm Tự',
                icon: 'fa-solid fa-gopuram',
                className: 'text-yellow-400 text-shadow-gold', // [NEW] Style
                desc: 'Võ công ngoại gia, phòng thủ kiên cố, HP dồi dào và sát thương AoE.',
                skills: [
                    { level: 1, name: 'La Hán Quyền', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, có 10% làm choáng (bỏ qua lượt địch).', // Stun is not implemented, so just flavor
                      chance: 0, multiplier: 1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Kim Cang Bất Hoại', type: 'Bị động', desc: 'Tăng 15% HP và 10% Phòng Thủ cơ bản.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 10 } },
                    { level: 20, name: 'Vi Đà Chưởng', type: 'Tấn công trung cấp', desc: 'Gây ATK × 1.5, hồi 5% HP tối đa (chưa hỗ trợ).',
                      chance: 30, multiplier: 1.5, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 8 },
                    { level: 30, name: 'Như Lai Thiên Diệp', type: 'Tấn công AoE', desc: 'Gây ATK × 0.8 cho 3 mục tiêu (mô phỏng = 3 hits).',
                      chance: 40, multiplier: 0.8, hits: 3, ignoreDef: 0, bonusCrit: 0, manaCost: 15 },
                    { level: 50, name: 'Sư Tử Hống', type: 'Buff/Debuff', desc: 'Gây ATK x 0.5, giảm 20% ATK và DEF của địch trong 10 giây.',
                      chance: 25, multiplier: 0.5, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'atk', value: -0.2, duration: 10 }, effect2: { type: 'debuff', stat: 'def', value: -0.2, duration: 10 }, manaCost: 12 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Kim Cang Hộ Thể', type: 'Bị động', desc: 'Trấn phái. Tăng 15% HP tối đa và 15% Phòng Thủ tối đa.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 15 } },
                    { level: 80, name: 'Dịch Cân Kinh', type: 'Buff Siêu Cấp', desc: 'Tăng 50% Phòng Thủ, 20% Tốc Đánh và 20% Hút Máu trong 15 giây.',
                      chance: 20, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, effect2: { type: 'buff', stat: 'spd', value: 0.2, duration: 15 }, effect3: { type: 'buff', stat: 'lifesteal', value: 20, duration: 15 }, manaCost: 30 },
                    { level: 120, name: 'Bất Động Minh Vương', type: 'Buff', desc: 'Tăng 50% DEF trong 10s (Miễn ST 3s chưa hỗ trợ).',
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 10 }, manaCost: 40 },
                    { level: 150, name: 'Thiên Thủ Như Lai', type: 'Tấn công siêu cấp', desc: 'Tung 10 chưởng liên tiếp, mỗi chưởng ATK × 0.6, bỏ qua 30% phòng ngự.',
                      chance: 40, multiplier: 0.6, hits: 10, ignoreDef: 0.3, bonusCrit: 0, manaCost: 60 },
                    { level: 180, name: 'Tẩy Tủy Kinh', type: 'Bị động', desc: 'Tăng 10% HP tối đa và 10% Kháng sát thương (chưa hỗ trợ).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 10 } }
                ]
            },
            'vo_dang': {
                name: 'Võ Đang Phái',
                icon: 'fa-solid fa-yin-yang',
                className: 'text-white text-shadow-blue', // [NEW] Style
                desc: 'Võ công nội gia, mạnh về buff, phòng thủ và dùng nội lực (bỏ qua def).',
                skills: [
                    { level: 1, name: 'Võ Đang Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1, tiêu hao thêm mana.',
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 2 },
                    { level: 10, name: 'Thái Cực Quyền', type: 'Bị động', desc: 'Tăng 20% Né Tránh và 10% May Mắn (chỉ số gốc).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 20 }, effect2: { type: 'passive_buff', stat: 'lck', value: 10 } },
                    { level: 20, name: 'Thần Môn Thập Tam Kiếm', type: 'Tấn công trung cấp', desc: 'Gây ATK × 2.0, bỏ qua 20% phòng ngự.',
                      chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0.2, bonusCrit: 5, manaCost: 10 },
                    { level: 30, name: 'Chân Võ Thất Tiệt Trận', type: 'Buff phòng thủ', desc: 'Tăng 30% DEF trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, manaCost: 15 },
                    { level: 50, name: 'Thái Cực Kiếm Pháp', type: 'Tấn công nội lực', desc: 'Gây ATK × 1.5, 100% sát thương bỏ qua phòng ngự.',
                      chance: 40, multiplier: 1.5, hits: 1, ignoreDef: 1.0, bonusCrit: 0, manaCost: 20 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Lưỡng Nghi Kiếm Trận', type: 'Tấn công', desc: 'Trấn phái. Gây ATK × 3.0, bỏ qua 30% phòng ngự.',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.3, bonusCrit: 10, manaCost: 22 },
                    { level: 80, name: 'Hộ Thể Cương Khí', type: 'Buff Siêu Cấp', desc: 'Tăng 25% ATK và 25% LCK trong 15 giây.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.25, duration: 15 }, effect2: { type: 'buff', stat: 'lck', value: 0.25, duration: 15 }, manaCost: 35 },
                    { level: 120, name: 'Thái Cực Thần Công', type: 'Bị động', desc: 'Tăng 10% DEF (Phản đòn 15% chưa hỗ trợ).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 10 } },
                    { level: 150, name: 'Thái Ất Huyền Kiếm', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 4.0, bỏ qua 50% phòng ngự, 100% chí mạng.',
                      chance: 45, multiplier: 4.0, hits: 1, ignoreDef: 0.5, bonusCrit: 100, manaCost: 50 },
                    { level: 180, name: 'Võ Đang Cửu Dương Công', type: 'Buff', desc: 'Hồi 20% HP và Mana tối đa (chưa hỗ trợ).',
                      chance: 15, manaCost: 50 }
                ]
            },
            'duong_mon': {
                name: 'Đường Môn',
                icon: 'fa-solid fa-bahai',
                className: 'text-green-400 text-shadow-green', // [NEW] Style
                desc: 'Sử dụng ám khí, mạnh về tốc độ, chí mạng và tấn công liên hoàn.',
                skills: [
                    { level: 1, name: 'Phi Tiêu', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 0.9, bị động tăng 10% Tốc Độ Đánh.',
                      chance: 0, multiplier: 0.9, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 10 } },
                    { level: 10, name: 'Thân Pháp Quỷ Ảnh', type: 'Bị động', desc: 'Tăng 15% Tốc Độ Đánh và 10% Tỉ Lệ Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'critChance', value: 10 } },
                    { level: 20, name: 'Mãn Thiên Hoa Vũ', type: 'Tấn công liên hoàn', desc: 'Phóng 5 phi tiêu, mỗi tiêu ATK × 0.5. Tỉ lệ chí mạng +15%.',
                      chance: 45, multiplier: 0.5, hits: 5, ignoreDef: 0, bonusCrit: 15, manaCost: 12 },
                    { level: 30, name: 'Tẩm Độc', type: 'Buff', desc: 'Tăng 30% Sát Thương Chí Mạng và 10% Hút Máu trong 15 giây.',
                      chance: 30, effect: { type: 'buff', stat: 'critDamage', value: 30, duration: 15 }, effect2: { type: 'buff', stat: 'lifesteal', value: 10, duration: 15 }, manaCost: 10 },
                    { level: 50, name: 'Bạo Vũ Lê Hoa Châm', type: 'Tấn công liên hoàn', desc: 'Bắn 10 mũi kim, mỗi mũi ATK × 0.3, bỏ qua 20% DEF.',
                      chance: 40, multiplier: 0.3, hits: 10, ignoreDef: 0.2, bonusCrit: 10, manaCost: 20 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Tâm Nhãn', type: 'Bị động', desc: 'Trấn phái. Tăng 10% Tỉ Lệ Chí Mạng và 20% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critChance', value: 10 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 20 } },
                    { level: 80, name: 'Cửu Cung Phi Tinh', type: 'Tấn công cao cấp', desc: 'Gây ATK × 2.5, +30% Tỉ Lệ Chí Mạng cho đòn này.',
                      chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.1, bonusCrit: 30, manaCost: 25 },
                    { level: 120, name: 'Truy Hồn Đoạt Mệnh', type: 'Tấn công', desc: 'Gây ATK x 3.0 (100% Trúng Độc - chưa hỗ trợ).',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.1, bonusCrit: 10, manaCost: 30 },
                    { level: 150, name: 'Phật Nộ Đường Liên', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 3.0, 100% chí mạng, đánh 3 lần liên tiếp.',
                      chance: 50, multiplier: 3.0, hits: 3, ignoreDef: 0, bonusCrit: 100, manaCost: 60 },
                    { level: 180, name: 'Ám Khí Bách Giải', type: 'Bị động', desc: 'Tăng 10% Tỉ Lệ Chí Mạng và 20% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critChance', value: 10 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 20 } }
                ]
            },
            // [NEW] Thêm Cái Bang
            'cai_bang': {
                name: 'Cái Bang',
                icon: 'fa-solid fa-person-walking-with-cane',
                className: 'text-amber-500 text-shadow-orange', // [NEW] Style
                desc: 'Đệ nhất bang phái, nổi tiếng với "Túy Quyền" và "Hàng Long Thập Bát Chưởng", mạnh về sát thương và hồi phục.',
                skills: [
                    { level: 1, name: 'Hầu Quyền', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, có 10% gây "Say Rượu" (tăng 5% ST nhận vào).',
                      chance: 0, multiplier: 1, hits: 1, ignoreDef: 0, manaCost: 0, effect: { type: 'debuff', stat: 'atk', value: -0.05, duration: 5 } }, // Mô phỏng "tăng ST"
                    { level: 10, name: 'Túy Tiên Bộ', type: 'Bị động', desc: 'Tăng 10% HP và 5% Hút Máu.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 5 } },
                    { level: 20, name: 'Túy Quyền', type: 'Tấn công trung cấp', desc: 'Gây ATK × 1.8, 100% gây "Say Rượu" (tăng 10% ST nhận vào).',
                      chance: 40, multiplier: 1.8, hits: 1, ignoreDef: 0, manaCost: 8, effect: { type: 'debuff', stat: 'atk', value: -0.1, duration: 10 } },
                    { level: 30, name: 'Hàng Long Hữu Hối', type: 'Tấn công trung cấp', desc: 'Gây ATK × 2.5, bỏ qua 10% phòng ngự.',
                      chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.1, manaCost: 15 },
                    { level: 50, name: 'Kháng Long Hữu Hối', type: 'Hồi phục', desc: 'Gây ATK × 1.5 và hồi 10% HP tối đa (chưa hỗ trợ).',
                      chance: 25, multiplier: 1.5, hits: 1, ignoreDef: 0, manaCost: 20 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Tiêu Dao Du', type: 'Tấn công', desc: 'Trấn phái. Gây ATK × 2.0, đánh 2 lần, tăng 10% Hút Máu trong 10s.',
                      chance: 35, multiplier: 2.0, hits: 2, ignoreDef: 0.1, manaCost: 22, effect: { type: 'buff', stat: 'lifesteal', value: 10, duration: 10 } },
                    { level: 80, name: 'Đả Cẩu Bổng Pháp', type: 'Bị động', desc: 'Đòn đánh thường có 20% tỷ lệ đánh 2 lần.',
                      passive: true, manaCost: 0 }, // Logic cần thêm trong playerTurn
                    { level: 120, name: 'Long Chiến Vu Dã', type: 'Tấn công', desc: 'Gây ATK x 3.5 (30% Choáng - chưa hỗ trợ).',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, manaCost: 35 },
                    { level: 150, name: 'Hàng Long Thập Bát Chưởng', type: 'Tấn công siêu cấp', desc: 'Tung 5 chưởng liên tiếp, mỗi chưởng ATK × 2.0, bỏ qua 20% DEF.',
                      chance: 45, multiplier: 2.0, hits: 5, ignoreDef: 0.2, manaCost: 60 },
                    { level: 180, name: 'Túy Bát Tiên', type: 'Bị động', desc: 'Khi HP < 30%, tăng 50% ATK và 30% Hút Máu (chưa hỗ trợ).',
                      passive: true, manaCost: 0 }
                ]
            },
            // [NEW] Thêm Ngũ Độc Giáo
            'ngu_doc': {
                name: 'Ngũ Độc Giáo',
                icon: 'fa-solid fa-spider',
                className: 'text-purple-400 text-shadow-green', // [NEW] Style
                desc: 'Chuyên dùng độc thuật, gây sát thương theo thời gian (DoT) và làm suy yếu kẻ địch.',
                skills: [
                    { level: 1, name: 'Độc Chỉ', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 0.8, 30% gây "Trúng Độc" (gây 5% ATK/s trong 5s).',
                      chance: 0, multiplier: 0.8, hits: 1, ignoreDef: 0, manaCost: 1 }, // DoT chưa hỗ trợ
                    { level: 10, name: 'Vạn Độc Tâm Kinh', type: 'Bị động', desc: 'Tăng 20% Sát Thương Chí Mạng và 5% Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 20 }, effect2: { type: 'passive_buff', stat: 'critChance', value: 5 } },
                    { level: 20, name: 'Vạn Độc Thực Tâm', type: 'Tấn công DoT', desc: 'Gây ATK × 1.2, 100% gây "Trúng Độc" (10% ATK/s trong 10s).',
                      chance: 40, multiplier: 1.2, hits: 1, ignoreDef: 0, manaCost: 10 },
                    { level: 30, name: 'Hấp Huyết Độc Cổ', type: 'Tấn công hút máu', desc: 'Gây ATK × 1.5, hút 50% sát thương thành HP (chưa hỗ trợ).',
                      chance: 25, multiplier: 1.5, hits: 1, ignoreDef: 0, manaCost: 15 },
                    { level: 50, name: 'Vong Mệnh Độc', type: 'Debuff', desc: 'Giảm 30% DEF và 30% Tốc Độ Đánh của địch trong 10 giây.',
                      chance: 20, multiplier: 0, hits: 0, effect: { type: 'debuff', stat: 'def', value: -0.3, duration: 10 }, effect2: { type: 'debuff', stat: 'spd', value: -0.3, duration: 10 }, manaCost: 18 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Vạn Cổ Thực Tâm Chú', type: 'Tấn công DoT', desc: 'Trấn phái. Gây ATK × 2.0, 100% gây "Kịch Độc" (15% ATK/s, 10s - chưa hỗ trợ).',
                      chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0.1, manaCost: 22 },
                    { level: 80, name: 'Độc Kinh', type: 'Bị động', desc: 'Tăng 50% sát thương "Trúng Độc" (chưa hỗ trợ).',
                      passive: true, manaCost: 0 },
                    { level: 120, name: 'Thiên Cổ Độc Vương', type: 'Buff', desc: 'Triệu hồi Độc Vương (chưa hỗ trợ).',
                      chance: 15, manaCost: 40 },
                    { level: 150, name: 'Ngũ Độc Phệ Thiên', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 3.0, 100% gây "Kịch Độc" (25% ATK/s trong 10s) và giảm 50% DEF địch.',
                      chance: 50, multiplier: 3.0, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'def', value: -0.5, duration: 10 }, manaCost: 50 },
                    { level: 180, name: 'Vạn Độc Bất Xâm', type: 'Bị động', desc: 'Tăng 10% HP (Miễn nhiễm hiệu ứng - chưa hỗ trợ).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 10 } }
                ]
            },
            // [NEW] Thêm Minh Giáo
            'minh_giao': {
                name: 'Minh Giáo',
                icon: 'fa-solid fa-fire',
                className: 'text-red-500 text-shadow-red', // [NEW] Style
                desc: 'Võ công bá đạo, dùng Thánh Hỏa Lệnh, mạnh về sát thương bùng nổ và hút máu.',
                skills: [
                    { level: 1, name: 'Thánh Hỏa Lệnh', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1.',
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, manaCost: 0 },
                    { level: 10, name: 'Càn Khôn Đại Na Di', type: 'Bị động', desc: 'Tăng 10% Công Kích và 10% Né Tránh.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 10 } },
                    { level: 20, name: 'Liệt Hỏa Quyền', type: 'Tấn công trung cấp', desc: 'Gây ATK × 2.0, bỏ qua 15% phòng ngự.',
                      chance: 40, multiplier: 2.0, hits: 1, ignoreDef: 0.15, manaCost: 8 },
                    { level: 30, name: 'Thánh Hỏa Tâm Pháp', type: 'Buff', desc: 'Tăng 20% Tốc Độ Đánh và 20% Hút Máu trong 15 giây.',
                      chance: 25, effect: { type: 'buff', stat: 'spd', value: 0.2, duration: 15 }, effect2: { type: 'buff', stat: 'lifesteal', value: 20, duration: 15 }, manaCost: 15 },
                    { level: 50, name: 'Hàn Băng Chưởng', type: 'Tấn công trung cấp', desc: 'Gây ATK × 1.8, có 30% "Đóng Băng" (giảm 50% tốc độ địch - chưa hỗ trợ).',
                      chance: 35, multiplier: 1.8, hits: 1, ignoreDef: 0, manaCost: 12 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Thánh Hỏa Liêu Nguyên', type: 'Tấn công', desc: 'Trấn phái. Gây ATK × 3.5, 50% tỉ lệ chí mạng.',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 22 },
                    { level: 80, name: 'Quang Minh Đỉnh', type: 'Tấn công cao cấp', desc: 'Gây ATK × 3.0 và hồi 15% HP tối đa (chưa hỗ trợ).',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.1, manaCost: 25 },
                    { level: 120, name: 'Quang Minh Thánh Hỏa', type: 'Buff', desc: 'Tăng 30% ATK, 30% Tốc Độ Đánh (Mất 1% HP/s - chưa hỗ trợ).',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'spd', value: 0.3, duration: 15 }, manaCost: 30 },
                    { level: 150, name: 'Thánh Hỏa Vô Cực', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 6.0, 100% chí mạng, nhưng tự mất 10% HP hiện tại (chưa hỗ trợ).',
                      chance: 40, multiplier: 6.0, hits: 1, ignoreDef: 0.3, bonusCrit: 100, manaCost: 55 },
                    { level: 180, name: 'Bất Diệt Thánh Hỏa', type: 'Bị động', desc: 'Hồi sinh 1 lần/trận với 30% HP (chưa hỗ trợ).',
                      passive: true, manaCost: 0 }
                ]
            },
            // [NEW] Thêm Côn Lôn
            'con_lon': {
                name: 'Côn Lôn Phái',
                icon: 'fa-solid fa-mountain',
                className: 'text-sky-300 text-shadow-white', // [NEW] Style
                desc: 'Phái trung lập, võ công toàn diện, cân bằng công thủ, nổi tiếng với Lưỡng Nghi Kiếm Pháp.',
                skills: [
                    { level: 1, name: 'Côn Lôn Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.05, cân bằng.',
                      chance: 0, multiplier: 1.05, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Lưỡng Nghi Tâm Pháp', type: 'Bị động', desc: 'Tăng 10% HP, 5% Công Kích và 5% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 5 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 5 } },
                    { level: 20, name: 'Sương Tỏa Côn Lôn', type: 'Tấn công AoE', desc: 'Tung kiếm khí lạnh, gây ATK × 0.9 cho 3 mục tiêu (mô phỏng = 3 hits).',
                      chance: 40, multiplier: 0.9, hits: 3, ignoreDef: 0, manaCost: 10 },
                    { level: 30, name: 'Thái Cực Kiếm Khí', type: 'Buff', desc: 'Tăng 20% Công Kích và 20% Phòng Thủ trong 10 giây.',
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 10 }, effect2: { type: 'buff', stat: 'def', value: 0.2, duration: 10 }, manaCost: 15 },
                    { level: 50, name: 'Lôi Động Cửu Thiên', type: 'Tấn công trung cấp', desc: 'Gây ATK × 2.8, có 30% gây "Choáng" (vô hiệu hóa - chưa hỗ trợ).',
                      chance: 35, multiplier: 2.8, hits: 1, ignoreDef: 0.1, manaCost: 18 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Trí Mệnh Nhất Kích', type: 'Bị động', desc: 'Trấn phái. Đòn đánh có 15% tỉ lệ gây 250% sát thương.',
                      passive: true, manaCost: 0 }, // Cần logic trong playerTurn
                    { level: 80, name: 'Ngự Kiếm Thuật', type: 'Bị động', desc: 'Tất cả đòn đánh bỏ qua 10% phòng ngự của mục tiêu.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'ignoreDef_p', value: 10 } },
                    { level: 120, name: 'Hỗn Nguyên Nhất Khí', type: 'Buff', desc: 'Tạo khiên hấp thụ ST bằng 30% HP tối đa (chưa hỗ trợ).',
                      chance: 20, manaCost: 40 },
                    { level: 150, name: 'Thiên Thanh Địa Trọc', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 4.0, bỏ qua 50% phòng ngự và 50% tỉ lệ chí mạng.',
                      chance: 45, multiplier: 4.0, hits: 1, ignoreDef: 0.5, bonusCrit: 50, manaCost: 50 },
                    { level: 180, name: 'Kiếm Tiên Giáng Trần', type: 'Bị động', desc: 'Tăng 10% Công Kích và 10% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 10 } }
                ]
            },
            // [NEW] Thêm Thiên Nhẫn
            'thien_nhan': {
                name: 'Thiên Nhẫn Giáo',
                icon: 'fa-solid fa-fire-flame-curved',
                className: 'text-rose-500 text-shadow-red', // [NEW] Style
                desc: 'Sát thủ bí ẩn, chuyên về bạo kích, tốc độ và kết liễu nhanh gọn.',
                skills: [
                    { level: 1, name: 'Đoạn Hồn Đao', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, tăng 10% tỉ lệ chí mạng cho đòn này.',
                      chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 10, manaCost: 0 },
                    { level: 10, name: 'Ma Đao Huyết Sát', type: 'Bị động', desc: 'Tăng 20% Sát Thương Chí Mạng và 5% Tỉ Lệ Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 20 }, effect2: { type: 'passive_buff', stat: 'critChance', value: 5 } },
                    { level: 20, name: 'Tà Lang Kích', type: 'Tấn công trung cấp', desc: 'Gây ATK × 2.2, tăng 25% tỉ lệ chí mạng cho đòn này.',
                      chance: 40, multiplier: 2.2, hits: 1, ignoreDef: 0, bonusCrit: 25, manaCost: 8 },
                    { level: 30, name: 'Bí Pháp Ẩn Thân', type: 'Buff', desc: 'Tăng 50% Tốc Độ Đánh và 20% Né Tránh trong 10 giây.',
                      chance: 20, effect: { type: 'buff', stat: 'spd', value: 0.5, duration: 10 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 20, duration: 10 }, manaCost: 15 },
                    { level: 50, name: 'Tử Vong Chi Vũ', type: 'Tấn công kết liễu', desc: 'Gây ATK × 3.0 (gấp đôi ST nếu địch < 30% HP - chưa hỗ trợ).',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.1, manaCost: 20 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Huyết Sát Đao Pháp', type: 'Tấn công', desc: 'Trấn phái. Gây ATK × 3.2, 100% chí mạng, hồi 50% ST thành HP (chưa hỗ trợ).',
                      chance: 35, multiplier: 3.2, hits: 1, ignoreDef: 0.1, bonusCrit: 100, manaCost: 25 },
                    { level: 80, name: 'Thị Huyết', type: 'Bị động', desc: 'Tăng 10% Hút Máu.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'lifesteal', value: 10 } },
                    // [FIX] Bổ sung các kỹ năng bị thiếu/lỗi
                    { level: 120, name: 'Nhất Kích Tất Sát', type: 'Tấn công', desc: 'Gây ATK x 4.0, 100% chí mạng.',
                      chance: 30, multiplier: 4.0, hits: 1, ignoreDef: 0.1, bonusCrit: 100, manaCost: 35 },
                    { level: 150, name: 'Thiên Ngoại Ma Âm', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 5.0, 100% chí mạng, bỏ qua 25% DEF.',
                      chance: 45, multiplier: 5.0, hits: 1, ignoreDef: 0.25, bonusCrit: 100, manaCost: 50 },
                    { level: 180, name: 'Ma Đao Loạn Vũ', type: 'Bị động', desc: 'Đòn đánh thường có 15% tỷ lệ gây 300% sát thương.',
                      passive: true, manaCost: 0 }
                ]
            },
            // [NEW] Thêm lại Hoa Sơn Phái (bị mất)
            'hoa_son': {
                name: 'Hoa Sơn Phái',
                icon: 'fa-solid fa-mountain-sun',
                className: 'text-blue-300 text-shadow-white', // [NEW] Style
                desc: 'Kiếm Tông, chuyên về bạo kích, sát thương vật lý và "Độc Cô Cửu Kiếm".',
                skills: [
                    { level: 1, name: 'Hoa Sơn Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, +5% Tỉ Lệ Chí Mạng.',
                      chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Kiếm Tông Yếu Quyết', type: 'Bị động', desc: 'Tăng 10% Công Kích và 15% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 15 } },
                    { level: 20, name: 'Thương Tùng Nghênh Khách', type: 'Tấn công trung cấp', desc: 'Gây ATK × 2.0, tỉ lệ chí mạng +20%.',
                      chance: 40, multiplier: 2.0, hits: 1, ignoreDef: 0, bonusCrit: 20, manaCost: 8 },
                    { level: 30, name: 'Tử Hà Thần Công', type: 'Buff', desc: 'Tăng 20% Công Kích và 10% Tỉ Lệ Chí Mạng trong 10 giây.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 10 }, effect2: { type: 'buff', stat: 'critChance', value: 10, duration: 10 }, manaCost: 15 },
                    { level: 50, name: 'Hữu Phụng Lai Nghi', type: 'Tấn công cao cấp', desc: 'Một kiếm cực nhanh, gây ATK × 3.0, tỉ lệ chí mạng +30%.',
                      chance: 35, multiplier: 3.0, hits: 1, ignoreDef: 0.1, bonusCrit: 30, manaCost: 18 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Kiếm Khí Trường Giang', type: 'Tấn công', desc: 'Trấn phái. Gây ATK × 2.2, đánh 2 lần, +20% Chí Mạng.',
                      chance: 35, multiplier: 2.2, hits: 2, ignoreDef: 0.1, bonusCrit: 20, manaCost: 22 },
                    { level: 80, name: 'Phá Ngọc Kiếm Thức', type: 'Bị động', desc: 'Các đòn đánh có 10% tỉ lệ bỏ qua 50% phòng ngự của mục tiêu.',
                      passive: true, manaCost: 0 }, // Cần logic trong playerTurn
                    { level: 120, name: 'Vô Ngã Kiếm Cảnh', type: 'Buff', desc: 'Tăng 50% Sát Thương Chí Mạng và 20% Tỉ Lệ Chí Mạng trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'critDamage', value: 50, duration: 15 }, effect2: { type: 'buff', stat: 'critChance', value: 20, duration: 15 }, manaCost: 30 },
                    { level: 150, name: 'Độc Cô Cửu Kiếm - Phá Kiếm', type: 'Tấn công siêu cấp', desc: 'Tuyệt kỹ, gây ATK × 4.5, 100% chí mạng, 100% bỏ qua phòng ngự.',
                      chance: 40, multiplier: 4.5, hits: 1, ignoreDef: 1.0, bonusCrit: 100, manaCost: 50 },
                    { level: 180, name: 'Độc Cô Cửu Kiếm - Phá Khí', type: 'Bị động', desc: 'Tăng 20% Công Kích và 15% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 15 } }
                ]
            },
            // [NEW] Thêm Nga Mi
            'nga_mi': {
                name: 'Nga Mi Phái',
                icon: 'fa-solid fa-spa',
                className: 'text-pink-300 text-shadow-pink', // [NEW] Style
                desc: 'Môn phái của nữ, võ công mềm mại, chuyên về hỗ trợ, hồi phục (buff) và sát thương băng hàn.',
                skills: [
                    { level: 1, name: 'Nga Mi Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, +5% Tỉ Lệ Chí Mạng.',
                      chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Từ Hàng Phổ Độ', type: 'Bị động', desc: 'Tăng 15% HP tối đa và 15% Mana tối đa.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 15 } },
                    { level: 20, name: 'Băng Sương Kiếm', type: 'Tấn công trung cấp', desc: 'Chém 2 lần, mỗi đòn ATK x 1.5, giảm 30% tốc độ địch (chưa hỗ trợ).',
                      chance: 35, multiplier: 1.5, hits: 2, ignoreDef: 0, bonusCrit: 0, manaCost: 8 },
                    { level: 30, name: 'Phật Quang Hộ Thể', type: 'Buff', desc: 'Tăng 30% Phòng Thủ và 10% Né Tránh trong 15 giây.',
                      chance: 20, effect: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 10, duration: 15 }, manaCost: 15 },
                    { level: 50, name: 'Kim Đỉnh Phật Quang', type: 'Buff Tấn Công', desc: 'Tăng 20% Công Kích và 20% Hút Máu trong 15 giây.',
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 15 }, effect2: { type: 'buff', stat: 'lifesteal', value: 20, duration: 15 }, manaCost: 20 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Phổ Độ Chúng Sinh', type: 'Buff', desc: 'Trấn phái. Tăng 20% ATK, 20% DEF (Hồi 10% HP - chưa hỗ trợ).',
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.2, duration: 15 }, manaCost: 25 },
                    { level: 80, name: 'Phiêu Tuyết Xuyên Vân', type: 'Tấn công cao cấp', desc: 'Gây ATK × 3.0, bỏ qua 30% phòng ngự của mục tiêu.',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.3, bonusCrit: 10, manaCost: 25 },
                    { level: 120, name: 'Cửu Âm Chân Kinh', type: 'Bị động', desc: 'Tăng 10% Công Kích và 10% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 10 } },
                    { level: 150, name: 'Phật Pháp Vô Biên', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 2.5, đánh 3 lần, 100% chí mạng.',
                      chance: 40, multiplier: 2.5, hits: 3, ignoreDef: 0.1, bonusCrit: 100, manaCost: 50 },
                    { level: 180, name: 'Tế Thế Cứu Nhân', type: 'Buff', desc: 'Tăng 50% HP tối đa cho bản thân trong 15 giây (Hồi phục chưa hỗ trợ).',
                      chance: 15, effect: { type: 'buff', stat: 'hp', value: 0.5, duration: 15 }, manaCost: 40 }
                ]
            },
            // [NEW] Thêm Thúy Yên
            'thuy_yen': {
                name: 'Thúy Yên Môn',
                icon: 'fa-solid fa-snowflake',
                className: 'text-teal-300 text-shadow-cyan', // [NEW] Style
                desc: 'Môn phái bí ẩn, võ công dùng song đao, mạnh về tốc độ, chí mạng và sát thương băng (bỏ qua def).',
                skills: [
                    { level: 1, name: 'Thúy Yên Đao Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1.',
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Ngự Tuyết Tâm Kinh', type: 'Bị động', desc: 'Tăng 10% Tốc Độ Đánh và 10% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 10 } },
                    { level: 20, name: 'Băng Tâm Thiến Ảnh', type: 'Tấn công trung cấp', desc: 'Đánh 2 lần, mỗi đòn ATK x 1.4, +15% Tỉ Lệ Chí Mạng.',
                      chance: 40, multiplier: 1.4, hits: 2, ignoreDef: 0, bonusCrit: 15, manaCost: 10 },
                    { level: 30, name: 'Phong Vũ Tình', type: 'Buff', desc: 'Tăng 20% Tốc Độ Đánh và 20% Né Tránh trong 15 giây.',
                      chance: 20, effect: { type: 'buff', stat: 'spd', value: 0.2, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 20, duration: 15 }, manaCost: 15 },
                    { level: 50, name: 'Băng Tung Vô Ảnh', type: 'Tấn công cao cấp', desc: 'Gây ATK × 3.0, bỏ qua 25% phòng ngự của mục tiêu.',
                      chance: 35, multiplier: 3.0, hits: 1, ignoreDef: 0.25, bonusCrit: 5, manaCost: 18 },
                    // [NEW] Kỹ năng Trấn Phái Cấp 60
                    { level: 60, name: 'Ngự Tuyết Ẩn', type: 'Tấn công', desc: 'Trấn phái. Gây ATK × 3.3, bỏ qua 40% phòng ngự.',
                      chance: 35, multiplier: 3.3, hits: 1, ignoreDef: 0.4, bonusCrit: 10, manaCost: 22 },
                    { level: 80, name: 'Tuyết Ảnh', type: 'Bị động', desc: 'Tăng 10% Tỉ Lệ Chí Mạng và 10% Né Tránh.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critChance', value: 10 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 10 } },
                    { level: 120, name: 'Hàn Băng Hộ Thể', type: 'Tấn công', desc: 'Tạo khiên (chưa hỗ trợ), gây ATK × 2.0 cho mục tiêu.',
                      chance: 25, multiplier: 2.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 30 },
                    { level: 150, name: 'Tuyết Lạc Trường Không', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 4.0, 50% chí mạng, bỏ qua 50% phòng ngự.',
                      chance: 40, multiplier: 4.0, hits: 1, ignoreDef: 0.5, bonusCrit: 50, manaCost: 50 },
                    { level: 180, name: 'Vô Ảnh Thần Đao', type: 'Bị động', desc: 'Tăng 15% Công Kích và 15% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 15 } }
                ]
            },
            // [NEW] Thêm Toàn Chân Giáo
            'toan_chan': {
                name: 'Toàn Chân Giáo',
                icon: 'fa-solid fa-star-of-david',
                className: 'text-slate-200 text-shadow-blue', // [NEW] Style
                desc: 'Huyền môn chính tông, nội công thâm hậu, võ công thiên về phòng thủ và hồi phục (HP/Mana).',
                skills: [
                    { level: 1, name: 'Toàn Chân Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, hồi 10 Mana (chưa hỗ trợ).', 
                      chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Tiên Thiên Công', type: 'Bị động', desc: 'Tăng 15% HP và 15% Nội Lực tối đa.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 15 } },
                    { level: 20, name: 'Tam Hoa Tụ Đỉnh', type: 'Buff', desc: 'Hồi phục 20% HP và 20% Mana trong 10s (chưa hỗ trợ). Tăng 20% DEF.',
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.2, duration: 10 }, manaCost: 10 },
                    { level: 30, name: 'Kim Nhan Công', type: 'Buff', desc: 'Tăng 30% Phòng Thủ và 30% Kháng Bạo Kích trong 15s.',
                      chance: 20, effect: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'anti_crit_p', value: 30, duration: 15 }, manaCost: 15 },
                    { level: 50, name: 'Nhất Khí Hóa Tam Thanh', type: 'Tấn công liên hoàn', desc: 'Tấn công 3 lần liên tiếp, mỗi lần ATK × 0.8.',
                      chance: 35, multiplier: 0.8, hits: 3, ignoreDef: 0, bonusCrit: 5, manaCost: 20 },
                    // Trấn phái
                    { level: 60, name: 'Thiên Cang Bắc Đẩu Trận', type: 'Buff', desc: 'Trấn phái. Tăng 30% ATK, 30% DEF và 30% Chính Xác.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, effect3: { type: 'buff', stat: 'accuracy_p', value: 30, duration: 15 }, manaCost: 30 },
                    { level: 80, name: 'Hạo Nhiên Chính Khí', type: 'Bị động', desc: 'Tăng 20% Kháng Hiệu Ứng (Anti-Crit/Block) và 10% HP.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'anti_crit_p', value: 20 } },
                    { level: 120, name: 'Không Minh Quyền', type: 'Tấn công', desc: 'Gây ATK × 3.0, bỏ qua 30% Phòng Thủ.',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.3, bonusCrit: 0, manaCost: 35 },
                    { level: 150, name: 'Song Thủ Hổ Bác', type: 'Tấn công siêu cấp', desc: 'Thi triển 2 chiêu thức cùng lúc. Gây ATK × 2.5, đánh 2 lần (Tổng 5.0).',
                      chance: 40, multiplier: 2.5, hits: 2, ignoreDef: 0.2, bonusCrit: 20, manaCost: 50 },
                    { level: 180, name: 'Cửu Âm Chân Kinh (Thượng)', type: 'Bị động', desc: 'Tăng 20% Toàn bộ chỉ số cơ bản.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 20 }, effect4: { type: 'passive_buff', stat: 'mana_p', value: 20 } }
                ]
            },
            // [NEW] Thêm Nhật Nguyệt Thần Giáo
            'nhat_nguyet': {
                name: 'Nhật Nguyệt Thần Giáo',
                icon: 'fa-solid fa-moon',
                className: 'text-fuchsia-500 text-shadow-purple', // [NEW] Style
                desc: 'Giáo phái bí ẩn tây vực, võ công tà dị, chuyên về tốc độ cực hạn và hút sinh lực.',
                skills: [
                    { level: 1, name: 'Nhật Nguyệt Đao', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1.',
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Hấp Tinh Đại Pháp', type: 'Bị động', desc: 'Tăng 10% Hút Máu và 10% Hút Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'lifesteal', value: 10 }, effect2: { type: 'passive_buff', stat: 'manasteal', value: 10 } },
                    { level: 20, name: 'Sư Tử Hống', type: 'Debuff', desc: 'Gây choáng (chưa hỗ trợ), giảm 20% ATK và DEF của địch.',
                      chance: 25, multiplier: 0.5, hits: 1, effect: { type: 'debuff', stat: 'atk', value: -0.2, duration: 10 }, effect2: { type: 'debuff', stat: 'def', value: -0.2, duration: 10 }, manaCost: 15 },
                    { level: 30, name: 'Hướng Dương Thần Công', type: 'Buff', desc: 'Tăng 30% Tốc Độ Đánh và 20% Chí Mạng trong 15s.',
                      chance: 20, effect: { type: 'buff', stat: 'spd', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'critChance', value: 20, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Tịch Tà Kiếm Pháp', type: 'Tấn công siêu tốc', desc: 'Đánh 5 lần cực nhanh, mỗi lần ATK × 0.6, 50% Chí Mạng.',
                      chance: 35, multiplier: 0.6, hits: 5, ignoreDef: 0.1, bonusCrit: 50, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Quỳ Hoa Bảo Điển', type: 'Buff', desc: 'Trấn phái. Tăng 50% Tốc Độ Đánh, 30% Né Tránh, nhưng giảm 20% DEF.',
                      chance: 20, effect: { type: 'buff', stat: 'spd', value: 0.5, duration: 20 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 30, duration: 20 }, effect3: { type: 'buff', stat: 'def', value: -0.2, duration: 20 }, manaCost: 40 },
                    { level: 80, name: 'Nhật Nguyệt Đồng Huy', type: 'Bị động', desc: 'Tăng 20% Công Kích và 20% HP.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 20 } },
                    { level: 120, name: 'Độc Cô Cửu Kiếm', type: 'Tấn công', desc: 'Gây ATK × 3.5, bỏ qua 50% Phòng Thủ.',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.5, bonusCrit: 20, manaCost: 45 },
                    { level: 150, name: 'Thiên Ma Giải Thể', type: 'Buff Bùng Nổ', desc: 'Tăng 100% Công Kích và 100% Tốc Đánh trong 5s, sau đó giảm 50% HP (chưa hỗ trợ giảm HP).',
                      chance: 10, effect: { type: 'buff', stat: 'atk', value: 1.0, duration: 5 }, effect2: { type: 'buff', stat: 'spd', value: 1.0, duration: 5 }, manaCost: 100 },
                    { level: 180, name: 'Đông Phương Bất Bại', type: 'Bị động', desc: 'Tăng 30% Tốc Độ Đánh và 30% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 30 } }
                ]
            },
            // [NEW] Thêm Mộ Dung Thế Gia
            'mo_dung': {
                name: 'Mộ Dung Thế Gia',
                icon: 'fa-solid fa-arrows-rotate',
                className: 'text-indigo-400 text-shadow-blue', // [NEW] Style
                desc: 'Gia tộc hoàng tộc lưu vong, nổi tiếng với tuyệt kỹ "Gậy ông đập lưng ông", phản đòn và mượn lực.',
                skills: [
                    { level: 1, name: 'Mộ Dung Kiếm', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1.',
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Đẩu Chuyển Tinh Di', type: 'Bị động', desc: 'Tăng 15% Né Tránh và 15% Chống Đỡ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 15 }, effect2: { type: 'passive_buff', stat: 'block_chance_p', value: 15 } },
                    { level: 20, name: 'Tham Hợp Chỉ', type: 'Tấn công tầm xa', desc: 'Gây ATK × 2.0, +20% Chí Mạng.',
                      chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0.1, bonusCrit: 20, manaCost: 10 },
                    { level: 30, name: 'Tinh Di Vật Chuyển', type: 'Buff', desc: 'Tăng 30% Phòng Thủ và 20% Phản Đòn (chưa hỗ trợ) trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, manaCost: 15 },
                    { level: 50, name: 'Gậy Ông Đập Lưng Ông', type: 'Tấn công phản kích', desc: 'Gây ATK × 1.5 + 50% Sát thương vừa nhận (chưa hỗ trợ logic phản). Tạm tính ATK x 2.5.',
                      chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.2, bonusCrit: 0, manaCost: 20 },
                    // Trấn phái
                    { level: 60, name: 'Đẩu Chuyển Càn Khôn', type: 'Buff', desc: 'Trấn phái. Tăng 20% Tất cả chỉ số (ATK/DEF/HP/SPD) trong 10s.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 10 }, effect2: { type: 'buff', stat: 'def', value: 0.2, duration: 10 }, effect3: { type: 'buff', stat: 'hp', value: 0.2, duration: 10 }, effect4: { type: 'buff', stat: 'spd', value: 0.2, duration: 10 }, manaCost: 30 },
                    { level: 80, name: 'Di Hoa Tiếp Mộc', type: 'Bị động', desc: 'Tăng 20% Hút Máu và 20% Hút Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'lifesteal', value: 20 }, effect2: { type: 'passive_buff', stat: 'manasteal', value: 20 } },
                    { level: 120, name: 'Phục Quốc Mộng', type: 'Buff Sĩ Khí', desc: 'Tăng 50 Sĩ Khí và 30% Công Kích trong 20s.',
                      chance: 15, effect: { type: 'buff', stat: 'si_khi', value: 50, duration: 20 }, effect2: { type: 'buff', stat: 'atk', value: 0.3, duration: 20 }, manaCost: 40 },
                    { level: 150, name: 'Sâm La Vạn Tượng', type: 'Tấn công AoE', desc: 'Gây ATK × 3.5 cho toàn bộ kẻ địch (mô phỏng = 1 hit cực mạnh).',
                      chance: 40, multiplier: 3.5, hits: 1, ignoreDef: 0.3, bonusCrit: 30, manaCost: 50 },
                    { level: 180, name: 'Hoàng Tộc Khí Vận', type: 'Bị động', desc: 'Tăng 30% May Mắn và 30% Chính Xác.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'lck_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 30 } }
                ]
            },
            // [NEW] Thêm Đoàn Thị (Đại Lý)
            'doan_thi': {
                name: 'Đoàn Thị Đại Lý',
                icon: 'fa-solid fa-hand-point-up',
                className: 'text-yellow-200 text-shadow-gold', // [NEW] Style
                desc: 'Hoàng tộc Đại Lý, nổi danh thiên hạ với Nhất Dương Chỉ và Lục Mạch Thần Kiếm. Kiếm khí vô hình, sát thương cực lớn.',
                skills: [
                    { level: 1, name: 'Nhất Dương Chỉ', type: 'Tấn công sơ cấp', desc: 'Chỉ lực xuyên thấu, gây ATK × 1.2, bỏ qua 10% Phòng Thủ.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0.1, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Khô Vinh Thiền Công', type: 'Bị động', desc: 'Tăng 15% Nội Lực và 10% Công Kích.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 10 } },
                    { level: 20, name: 'Thiếu Thương Kiếm', type: 'Tấn công tầm xa', desc: 'Kiếm khí uy mãnh, gây ATK × 2.0, tăng 20% Tỉ Lệ Chí Mạng.',
                      chance: 40, multiplier: 2.0, hits: 1, ignoreDef: 0.1, bonusCrit: 20, manaCost: 15 },
                    { level: 30, name: 'Hoàng Gia Uy Nghi', type: 'Buff', desc: 'Tăng 30% Công Kích và 20% Chính Xác trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'accuracy_p', value: 20, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Thương Dương Kiếm', type: 'Tấn công linh hoạt', desc: 'Kiếm khí biến ảo, đánh 3 lần, mỗi lần ATK × 0.7, bỏ qua 20% DEF.',
                      chance: 35, multiplier: 0.7, hits: 3, ignoreDef: 0.2, bonusCrit: 5, manaCost: 25 },
                    // Trấn phái
                    { level: 60, name: 'Lục Mạch Thần Kiếm', type: 'Tấn công liên hoàn', desc: 'Trấn phái. Phóng 6 luồng kiếm khí, mỗi luồng ATK × 0.6. Tổng sát thương 3.6.',
                      chance: 30, multiplier: 0.6, hits: 6, ignoreDef: 0.3, bonusCrit: 10, manaCost: 50 },
                    { level: 80, name: 'Bắc Minh Thần Công', type: 'Bị động', desc: 'Tăng 20% Hút Nội Lực và 30% Nội Lực tối đa.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'manasteal', value: 20 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 30 } },
                    { level: 120, name: 'Quan Xung Kiếm', type: 'Tấn công', desc: 'Gây ATK × 3.5, 100% Bỏ qua Phòng Thủ (Sát thương chuẩn).',
                      chance: 25, multiplier: 3.5, hits: 1, ignoreDef: 1.0, bonusCrit: 0, manaCost: 60 },
                    { level: 150, name: 'Lục Mạch Quy Tông', type: 'Tấn công siêu cấp', desc: 'Vạn kiếm quy tông, gây ATK × 5.0 diện rộng, 50% Chí Mạng.',
                      chance: 45, multiplier: 5.0, hits: 1, ignoreDef: 0.4, bonusCrit: 50, manaCost: 100 },
                    { level: 180, name: 'Thiên Long Hộ Thể', type: 'Bị động', desc: 'Tăng 20% HP và 20% Kháng Bạo Kích.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'anti_crit_p', value: 20 } }
                ]
            },
            // [NEW] Thêm Tinh Túc Phái
            'tinh_tuc': {
                name: 'Tinh Túc Phái',
                icon: 'fa-solid fa-bug',
                className: 'text-lime-400 text-shadow-green', // [NEW] Style
                desc: 'Môn phái tà đạo Tây Vực, chuyên dùng độc trùng và Hóa Công Đại Pháp. Khiến kẻ địch suy yếu dần rồi chết.',
                skills: [
                    { level: 1, name: 'Hủ Thi Độc', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 0.9, gây thêm sát thương độc (mô phỏng bằng bonus dmg).', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Độc Công', type: 'Bị động', desc: 'Tăng 15% Công Kích và 15% Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 15 } },
                    { level: 20, name: 'Hóa Công Đại Pháp', type: 'Debuff', desc: 'Hút nội lực địch (mô phỏng: giảm ATK địch 20% và hồi 10% Mana bản thân).',
                      chance: 30, multiplier: 1.0, hits: 1, effect: { type: 'debuff', stat: 'atk', value: -0.2, duration: 10 }, manaCost: 0 }, // Hồi mana chưa hỗ trợ, dùng cost 0
                    { level: 30, name: 'Thần Mộc Vương Đỉnh', type: 'Buff', desc: 'Tăng 30% Phòng Thủ và 30% HP trong 15s (Triệu hồi độc trùng hộ thể).',
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'hp', value: 0.3, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Liên珠 Phụ Cốt Đinh', type: 'Ám khí độc', desc: 'Phóng đinh độc, gây ATK × 2.5, giảm 30% Tốc Độ Đánh của địch.',
                      chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.3, duration: 10 }, manaCost: 25 },
                    // Trấn phái
                    { level: 60, name: 'Thiên Địa Bất Dung', type: 'Tấn công AoE', desc: 'Trấn phái. Độc khí bao trùm, gây ATK × 3.0, giảm 30% DEF địch.',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.3, effect: { type: 'debuff', stat: 'def', value: -0.3, duration: 10 }, manaCost: 40 },
                    { level: 80, name: 'Hóa Cốt Miên Chưởng', type: 'Bị động', desc: 'Đòn đánh có 20% tỷ lệ bỏ qua 100% phòng ngự.',
                      passive: true, manaCost: 0 }, // Logic cần xử lý riêng hoặc dùng ignoreDef_p
                    { level: 120, name: 'Tam Tiếu Tiêu Dao Tán', type: 'Tấn công kết liễu', desc: 'Gây ATK × 4.0. Nếu địch còn dưới 30% HP, sát thương x2 (chưa hỗ trợ logic HP).',
                      chance: 20, multiplier: 4.0, hits: 1, ignoreDef: 0.2, bonusCrit: 30, manaCost: 50 },
                    { level: 150, name: 'Tinh Túc Lão Quái', type: 'Buff Siêu Cấp', desc: 'Tăng 50% Công Kích, 50% Hút Máu trong 20 giây.',
                      chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 20 }, effect2: { type: 'buff', stat: 'lifesteal', value: 50, duration: 20 }, manaCost: 80 },
                    { level: 180, name: 'Vạn Độc Chi Thể', type: 'Bị động', desc: 'Tăng 25% HP và 25% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 25 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 25 } }
                ]
            },
            // [NEW] Thêm Thiên Vương Bang
            'thien_vuong': {
                name: 'Thiên Vương Bang',
                icon: 'fa-solid fa-shield-halved',
                className: 'text-orange-500 text-shadow-red', // [NEW] Style
                desc: 'Chiến binh giáp sắt, thương pháp dũng mãnh, lấy công làm thủ. Sinh lực dồi dào nhất võ lâm.',
                skills: [
                    { level: 1, name: 'Thiên Vương Thương', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, tăng 10% DEF trong 3s.', 
                      chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'def', value: 0.1, duration: 3 } },
                    { level: 10, name: 'Kim Chung Tráo', type: 'Bị động', desc: 'Tăng 30% HP tối đa và 10% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 10 } },
                    { level: 20, name: 'Huyết Chiến Bát Phương', type: 'Tấn công AoE', desc: 'Xoay thương quét ngang, gây ATK × 0.8 cho 3 mục tiêu (3 hits).',
                      chance: 40, multiplier: 0.8, hits: 3, ignoreDef: 0, bonusCrit: 5, manaCost: 10 },
                    { level: 30, name: 'Bất Khuất', type: 'Buff', desc: 'Tăng 40% Phòng Thủ và hồi 10% HP (chưa hỗ trợ hồi) trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.4, duration: 15 }, manaCost: 15 },
                    { level: 50, name: 'Đoạn Hồn Thích', type: 'Tấn công đơn mục tiêu', desc: 'Lao tới đâm mạnh, gây ATK × 2.5, gây choáng (mô phỏng giảm tốc độ 50%).',
                      chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 20 },
                    // Trấn phái
                    { level: 60, name: 'Phá Thiên Trảm', type: 'Tấn công', desc: 'Trấn phái. Gây ATK × 3.0, bỏ qua 40% Phòng Thủ.',
                      chance: 35, multiplier: 3.0, hits: 1, ignoreDef: 0.4, bonusCrit: 10, manaCost: 30 },
                    { level: 80, name: 'Thiên Vương Bản Sinh', type: 'Bị động', desc: 'Tăng 20% HP và 20% Kháng Hiệu Ứng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 } }, // Kháng chưa có stat
                    { level: 120, name: 'Truy Tinh Trục Nguyệt', type: 'Tấn công liên hoàn', desc: 'Đâm liên tiếp 4 thương, mỗi thương ATK × 0.8, tăng tốc đánh 20%.',
                      chance: 30, multiplier: 0.8, hits: 4, ignoreDef: 0.1, effect: { type: 'buff', stat: 'spd', value: 0.2, duration: 5 }, manaCost: 45 },
                    { level: 150, name: 'Chiến Ý Hào Hùng', type: 'Buff Siêu Cấp', desc: 'Tăng 50% Công Kích, 50% HP trong 20 giây.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 20 }, effect2: { type: 'buff', stat: 'hp', value: 0.5, duration: 20 }, manaCost: 80 },
                    { level: 180, name: 'Bất Tử Chiến Thần', type: 'Bị động', desc: 'Tăng 30% HP và 10% Phản Đòn (chưa hỗ trợ).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 } }
                ]
            },
            // [NEW] Thêm Tuyết Sơn Phái
            'tuyet_son': {
                name: 'Tuyết Sơn Phái',
                icon: 'fa-solid fa-icicles',
                className: 'text-cyan-100 text-shadow-white', // [NEW] Style
                desc: 'Ẩn cư nơi núi tuyết vĩnh cửu, kiếm pháp lạnh lùng, sắc bén. Chuyên về sát thương bạo kích và khống chế băng giá.',
                skills: [
                    { level: 1, name: 'Tuyết Sơn Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1.', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Băng Tâm Quyết', type: 'Bị động', desc: 'Tăng 15% Nội Lực và 10% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 10 } },
                    { level: 20, name: 'Lăng Sương Kiếm', type: 'Tấn công bạo kích', desc: 'Kiếm khí lạnh thấu xương, gây ATK × 1.8, +30% Tỉ Lệ Chí Mạng.',
                      chance: 40, multiplier: 1.8, hits: 1, ignoreDef: 0, bonusCrit: 30, manaCost: 15 },
                    { level: 30, name: 'Sương Tuyết Mãn Thiên', type: 'Buff', desc: 'Tăng 40% Sát Thương Chí Mạng và 20% Chính Xác trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'critDamage', value: 40, duration: 15 }, effect2: { type: 'buff', stat: 'accuracy_p', value: 20, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Tuyết Hoa Lục Xuất', type: 'Tấn công liên hoàn', desc: 'Sáu bông tuyết kiếm khí, đánh 6 lần, mỗi lần ATK × 0.5.',
                      chance: 35, multiplier: 0.5, hits: 6, ignoreDef: 0.1, bonusCrit: 10, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Vạn Lý Tuyết Phiêu', type: 'Tấn công AoE', desc: 'Trấn phái. Bão tuyết bao trùm, gây ATK × 3.5, giảm 40% Tốc Độ Đánh của địch.',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.4, duration: 10 }, manaCost: 50 },
                    { level: 80, name: 'Hàn Băng Chân Khí', type: 'Bị động', desc: 'Tăng 20% Công Kích và 30% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 30 } },
                    { level: 120, name: 'Thần Đảo Nhất Kích', type: 'Tấn công', desc: 'Gây ATK × 4.0, nếu chí mạng sẽ gây thêm 50% sát thương (mô phỏng bằng bonus crit dmg).',
                      chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 60 },
                    { level: 150, name: 'Tuyết Sơn Phi Hồ', type: 'Tấn công siêu cấp', desc: 'Thân pháp như cáo tuyết, gây ATK × 5.5, 100% Né Tránh trong 5s (chưa hỗ trợ né tuyệt đối, tăng 100% né).',
                      chance: 40, multiplier: 5.5, hits: 1, ignoreDef: 0.3, effect: { type: 'buff', stat: 'dodgeChance', value: 100, duration: 5 }, manaCost: 80 },
                    { level: 180, name: 'Băng Phong Vạn Lý', type: 'Bị động', desc: 'Tăng 30% HP và 20% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } }
                ]
            },
            // [NEW] Thêm Huyết Đao Môn
            'huyet_dao': {
                name: 'Huyết Đao Môn',
                icon: 'fa-solid fa-droplet',
                className: 'text-red-600 text-shadow-red', // [NEW] Style
                desc: 'Môn phái tà ác vùng Tây Tạng, đao pháp tàn độc. Càng bị thương đánh càng hăng, hút máu nuôi chiến ý.',
                skills: [
                    { level: 1, name: 'Huyết Đao Đao Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.2, tăng 5% Hút Máu trong 3s.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, manaCost: 0, effect: { type: 'buff', stat: 'lifesteal', value: 5, duration: 3 } },
                    { level: 10, name: 'Thị Huyết', type: 'Bị động', desc: 'Tăng 10% Hút Máu và 10% HP.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'lifesteal', value: 10 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 10 } },
                    { level: 20, name: 'Huyết Hải Ma Công', type: 'Tấn công diện rộng', desc: 'Gây ATK × 1.5 cho 3 mục tiêu (3 hits), hồi 10% sát thương thành HP.',
                      chance: 40, multiplier: 1.5, hits: 3, ignoreDef: 0, manaCost: 15 }, // Lifesteal tự động áp dụng từ stat
                    { level: 30, name: 'Cuồng Nộ', type: 'Buff', desc: 'Hy sinh 10% HP (chưa hỗ trợ) để tăng 40% Công Kích trong 15s.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 15 }, manaCost: 0 },
                    { level: 50, name: 'Huyết Chiến Thiên Hạ', type: 'Tấn công', desc: 'Gây ATK × 3.0. Tăng 20% Tốc Độ Đánh trong 10s.',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.1, effect: { type: 'buff', stat: 'spd', value: 0.2, duration: 10 }, manaCost: 25 },
                    // Trấn phái
                    { level: 60, name: 'A Tỳ Đạo Tam Đao', type: 'Tấn công liên hoàn', desc: 'Trấn phái. Ba đao đoạt mệnh, mỗi đao ATK × 1.5, bỏ qua 50% DEF.',
                      chance: 30, multiplier: 1.5, hits: 3, ignoreDef: 0.5, bonusCrit: 20, manaCost: 50 },
                    { level: 80, name: 'Bất Tử Ma Thân', type: 'Bị động', desc: 'Tăng 30% HP và 20% Kháng Sát Thương (Def).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 120, name: 'Huyết Ma Trảm', type: 'Tấn công kết liễu', desc: 'Gây ATK × 4.5, 100% Chí Mạng.',
                      chance: 25, multiplier: 4.5, hits: 1, ignoreDef: 0.2, bonusCrit: 100, manaCost: 60 },
                    { level: 150, name: 'Tu La Huyết Tế', type: 'Buff Siêu Cấp', desc: 'Tăng 50% Hút Máu và 50% Công Kích trong 20s.',
                      chance: 15, effect: { type: 'buff', stat: 'lifesteal', value: 50, duration: 20 }, effect2: { type: 'buff', stat: 'atk', value: 0.5, duration: 20 }, manaCost: 80 },
                    { level: 180, name: 'Huyết Đao Lão Tổ', type: 'Bị động', desc: 'Tăng 20% Công Kích và 20% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } }
                ]
            },
            // [NEW] Thêm Linh Thứu Cung
            'linh_thuu': {
                name: 'Linh Thứu Cung',
                icon: 'fa-solid fa-mountain-city',
                className: 'text-violet-300 text-shadow-purple', // [NEW] Style
                desc: 'Cung điện bí ẩn trên đỉnh Thiên Sơn, chủ nhân là Thiên Sơn Đồng Lão. Tuyệt kỹ Sinh Tử Phù khiến người đời khiếp sợ.',
                skills: [
                    { level: 1, name: 'Thiên Sơn Chiết Mai Thủ', type: 'Tấn công sơ cấp', desc: 'Chiêu thức biến ảo, gây ATK × 1.1, +10% Chính Xác.', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'accuracy_p', value: 10, duration: 5 } },
                    { level: 10, name: 'Bát Hoang Lục Hợp', type: 'Bị động', desc: 'Tăng 10% Toàn bộ chỉ số cơ bản.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 10 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 10 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 10 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 10 } },
                    { level: 20, name: 'Thiên Sơn Lục Dương Chưởng', type: 'Tấn công nội lực', desc: 'Chưởng lực âm dương kết hợp, gây ATK × 2.0, +20% Hút Nội Lực.',
                      chance: 40, multiplier: 2.0, hits: 1, ignoreDef: 0.1, manaCost: 15, effect: { type: 'buff', stat: 'manasteal', value: 20, duration: 5 } },
                    { level: 30, name: 'Tiêu Dao Ngự Phong', type: 'Buff', desc: 'Tăng 40% Tốc Độ Đánh và 20% Né Tránh trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'spd', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 20, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Sinh Tử Phù', type: 'Debuff DoT', desc: 'Gieo bùa sinh tử, giảm 30% ATK, 30% DEF của địch và gây sát thương (mô phỏng = hit mạnh ATK x 2.5).',
                      chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.3, effect: { type: 'debuff', stat: 'atk', value: -0.3, duration: 15 }, effect2: { type: 'debuff', stat: 'def', value: -0.3, duration: 15 }, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Bắc Minh Chân Khí', type: 'Buff', desc: 'Trấn phái. Hộ thể chân khí, tăng 40% DEF và hồi 5% HP/s (chưa hỗ trợ hồi).',
                      chance: 20, effect: { type: 'buff', stat: 'def', value: 0.4, duration: 20 }, manaCost: 30 },
                    { level: 80, name: 'Tiểu Vô Tướng Công', type: 'Bị động', desc: 'Sao chép võ công (mô phỏng: Tăng 20% Công Kích và 20% Chính Xác).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 20 } },
                    { level: 120, name: 'Bạch Hồng Chưởng Lực', type: 'Tấn công điều khiển', desc: 'Chưởng lực bẻ cong, không thể né tránh. Gây ATK × 3.5, 100% Trúng Đích.',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 10, manaCost: 50 }, // Logic trúng đích trong core combat
                    { level: 150, name: 'Duy Ngã Độc Tôn', type: 'Buff Siêu Cấp', desc: 'Tăng 50% Toàn bộ chỉ số trong 20s.',
                      chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.5, duration: 20 }, effect3: { type: 'buff', stat: 'hp', value: 0.5, duration: 20 }, effect4: { type: 'buff', stat: 'spd', value: 0.5, duration: 20 }, manaCost: 100 },
                    { level: 180, name: 'Trường Xuân Bất Lão', type: 'Bị động', desc: 'Tăng 30% HP và 30% Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 30 } }
                ]
            },
            // [NEW] Thêm Thần Kiếm Sơn Trang
            'than_kiem': {
                name: 'Thần Kiếm Sơn Trang',
                icon: 'fa-solid fa-khanda',
                className: 'text-emerald-300 text-shadow-green', // [NEW] Style
                desc: 'Thánh địa kiếm thuật, nơi Tam Thiếu Gia từng tu luyện. Kiếm chiêu tinh diệu, sát thương vật lý cực đại, nhất kiếm định giang sơn.',
                skills: [
                    { level: 1, name: 'Tạ Thị Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.2, +5% Chính Xác.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'accuracy_p', value: 5, duration: 3 } },
                    { level: 10, name: 'Kiếm Thần Nhất Tiếu', type: 'Bị động', desc: 'Tăng 20% Công Kích và 10% Tỉ Lệ Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'critChance', value: 10 } },
                    { level: 20, name: 'Nhất Kiếm Tây Lai', type: 'Tấn công bạo kích', desc: 'Kiếm khí từ tây vực, gây ATK × 2.2, +20% Sát Thương Chí Mạng.',
                      chance: 35, multiplier: 2.2, hits: 1, ignoreDef: 0.1, bonusCrit: 10, manaCost: 15 },
                    { level: 30, name: 'Tẩy Kiếm Trì', type: 'Buff', desc: 'Tăng 30% Công Kích và 20% Bỏ qua Phòng Ngự trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'ignoreDef_p', value: 20, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Đoạt Mệnh Thập Tam Kiếm', type: 'Tấn công liên hoàn', desc: 'Mười ba chiêu kiếm đoạt mệnh, đánh 4 lần, mỗi lần ATK × 0.8.',
                      chance: 30, multiplier: 0.8, hits: 4, ignoreDef: 0.1, bonusCrit: 10, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Thiên Ngoại Phi Tiên', type: 'Tấn công tất sát', desc: 'Trấn phái. Kiếm như tiên giáng trần, gây ATK × 4.0, 100% Chí Mạng.',
                      chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.2, bonusCrit: 100, manaCost: 50 },
                    { level: 80, name: 'Nhân Kiếm Hợp Nhất', type: 'Bị động', desc: 'Tăng 30% Sát Thương Chí Mạng và 15% Công Kích.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 30 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 15 } },
                    { level: 120, name: 'Thần Kiếm Quyết', type: 'Tấn công', desc: 'Gây ATK × 5.0, bỏ qua 50% Phòng Thủ.',
                      chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 0.5, bonusCrit: 20, manaCost: 60 },
                    { level: 150, name: 'Vạn Kiếm Quy Tông', type: 'Tấn công diện rộng', desc: 'Triệu hồi vạn kiếm, gây ATK × 3.0 cho toàn bộ kẻ địch (mô phỏng hit mạnh), tăng 50% DEF.',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.2, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 10 }, manaCost: 80 },
                    { level: 180, name: 'Kiếm Đạo Vô Cực', type: 'Bị động', desc: 'Tăng 25% Công Kích và 25% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 25 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 25 } }
                ]
            },
            // [NEW] Thêm Di Hoa Cung
            'di_hoa': {
                name: 'Di Hoa Cung',
                icon: 'fa-brands fa-pagelines',
                className: 'text-pink-400 text-shadow-pink', // [NEW] Style
                desc: 'Cung điện trăm hoa đua nở, võ công âm nhu, quỷ dị. Sở hữu Minh Ngọc Công trẻ mãi không già và Di Hoa Tiếp Ngọc phản đòn đối thủ.',
                skills: [
                    { level: 1, name: 'Di Hoa Chưởng', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, hút 5% Nội Lực (Manasteal).', 
                      chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'manasteal', value: 5, duration: 3 } },
                    { level: 10, name: 'Minh Ngọc Công (Sơ)', type: 'Bị động', desc: 'Tăng 15% Nội Lực và 10% Thân Pháp.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 10 } },
                    { level: 20, name: 'Hoa Thần Thất Thức', type: 'Tấn công', desc: 'Chưởng pháp như hoa rơi, gây ATK × 2.0, giảm 20% Chính Xác của địch.',
                      chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'accuracy_p', value: -20, duration: 10 }, manaCost: 15 },
                    { level: 30, name: 'Di Hoa Tiếp Ngọc', type: 'Buff Phản Kích', desc: 'Mượn lực đánh lực. Tăng 30% Công Kích và 30% Phòng Thủ trong 15s.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, manaCost: 25 },
                    { level: 50, name: 'Lan Hoa Phất Huyệt', type: 'Khống chế', desc: 'Gây ATK × 1.5, làm chậm đối thủ 40% (giảm SPD) trong 10s.',
                      chance: 30, multiplier: 1.5, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.4, duration: 10 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Minh Ngọc Thần Công', type: 'Buff', desc: 'Trấn phái. Tăng 40% Nội Lực, 20% Hồi Máu (Lifesteal) và làm lạnh kẻ địch (giảm 20% ATK địch).',
                      chance: 25, effect: { type: 'buff', stat: 'mana_p', value: 40, duration: 20 }, effect2: { type: 'buff', stat: 'lifesteal', value: 20, duration: 20 }, effect3: { type: 'debuff', stat: 'atk', value: -0.2, duration: 20 }, manaCost: 50 },
                    { level: 80, name: 'Băng Cơ Ngọc Cốt', type: 'Bị động', desc: 'Tăng 20% HP và 20% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 120, name: 'Tuyệt Tình Trảm', type: 'Tấn công bạo kích', desc: 'Gây ATK × 3.5, 50% Chí Mạng.',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 45 },
                    { level: 150, name: 'Hỗn Nguyên Minh Ngọc', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 4.5, hút 20% sát thương thành Nội Lực và Sinh Lực.',
                      chance: 40, multiplier: 4.5, hits: 1, ignoreDef: 0.3, effect: { type: 'buff', stat: 'lifesteal', value: 20, duration: 5 }, manaCost: 70 },
                    { level: 180, name: 'Di Hoa Cung Chủ', type: 'Bị động', desc: 'Tăng 20% Tốc Độ Đánh và 20% Hút Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'manasteal', value: 20 } }
                ]
            },
            // [NEW] Thêm Từ Hàng Tịnh Trai
            'tu_hang': {
                name: 'Từ Hàng Tịnh Trai',
                icon: 'fa-solid fa-leaf',
                className: 'text-yellow-100 text-shadow-gold', // [NEW] Style
                desc: 'Đứng đầu chính đạo, môn nhân đều là tuyệt sắc giai nhân tu luyện thiên đạo. Kiếm Điển ảo diệu, có khả năng cảm ứng thiên nhân hợp nhất.',
                skills: [
                    { level: 1, name: 'Từ Hàng Kiếm Điển', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1, sát thương thuần khiết (bỏ qua 10% DEF).', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Kiếm Tâm Thông Minh', type: 'Bị động', desc: 'Tăng 15% Chính Xác và 15% Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'accuracy_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 15 } },
                    { level: 20, name: 'Sắc Không Kiếm', type: 'Tấn công phép', desc: 'Sắc tức thị không, gây ATK × 1.8, bỏ qua 30% Phòng Thủ.',
                      chance: 40, multiplier: 1.8, hits: 1, ignoreDef: 0.3, bonusCrit: 5, manaCost: 15 },
                    { level: 30, name: 'Tịnh Thế Chi Quang', type: 'Buff Hồi Phục', desc: 'Hồi phục 5% HP/s (mô phỏng bằng Lifesteal 30%) và tăng 20% DEF trong 10s.',
                      chance: 25, effect: { type: 'buff', stat: 'lifesteal', value: 30, duration: 10 }, effect2: { type: 'buff', stat: 'def', value: 0.2, duration: 10 }, manaCost: 25 },
                    { level: 50, name: 'Phi Dực Kiếm', type: 'Tấn công AoE', desc: 'Kiếm khí như cánh chim, gây ATK × 2.5, tăng 20% Tốc Độ Đánh.',
                      chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'buff', stat: 'spd', value: 0.2, duration: 10 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Kiếm Tâm', type: 'Buff Toàn Diện', desc: 'Trấn phái. Tăng 20% TẤT CẢ chỉ số (HP, Mana, ATK, DEF, SPD, LCK) trong 20s.',
                      chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.2, duration: 20 }, effect3: { type: 'buff', stat: 'hp', value: 0.2, duration: 20 }, effect4: { type: 'buff', stat: 'spd', value: 0.2, duration: 20 }, manaCost: 60 },
                    { level: 80, name: 'Tiên Thai', type: 'Bị động', desc: 'Tăng 20% HP và 20% May Mắn.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'lck_p', value: 20 } },
                    { level: 120, name: 'Bỉ Ngạn Kiếm', type: 'Tấn công', desc: 'Gây ATK × 4.0, nếu kẻ địch là Ma Đạo (mô phỏng ngẫu nhiên 50%) gây thêm 50% ST.',
                      chance: 30, multiplier: 4.0, hits: 1, ignoreDef: 0.2, bonusCrit: 20, manaCost: 50 },
                    { level: 150, name: 'Thiên Nhân Hợp Nhất', type: 'Buff Siêu Cấp', desc: 'Hòa mình vào thiên đạo, tăng 50% Chính Xác và 50% Bỏ qua Phòng Thủ trong 15s.',
                      chance: 20, effect: { type: 'buff', stat: 'accuracy_p', value: 50, duration: 15 }, effect2: { type: 'buff', stat: 'ignoreDef_p', value: 50, duration: 15 }, manaCost: 80 },
                    { level: 180, name: 'Phá Toái Hư Không', type: 'Bị động', desc: 'Tăng 20% Công Kích và 20% Kháng Hiệu Ứng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 } }
                ]
            },
            // [NEW] Thêm Bạch Đà Sơn
            'bach_da': {
                name: 'Bạch Đà Sơn',
                icon: 'fa-solid fa-staff-snake',
                className: 'text-stone-300 text-shadow-white', // [NEW] Style
                desc: 'Tây Độc Âu Dương Phong sáng lập. Nổi tiếng với Hàm Mô Công, lấy tĩnh chế động, tích tụ kình lực rồi bùng nổ dữ dội.',
                skills: [
                    { level: 1, name: 'Linh Xà Quyền', type: 'Tấn công sơ cấp', desc: 'Quyền pháp như rắn, gây ATK × 1.1, +5% Chính Xác.', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'accuracy_p', value: 5, duration: 3 } },
                    { level: 10, name: 'Bạch Đà Tâm Pháp', type: 'Bị động', desc: 'Tăng 20% Phòng Thủ và 10% HP.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 10 } },
                    { level: 20, name: 'Xà Hình Điêu Thủ', type: 'Tấn công hiểm hóc', desc: 'Chiêu thức quỷ dị, gây ATK × 2.0, bỏ qua 15% Phòng Thủ.',
                      chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0.15, bonusCrit: 5, manaCost: 15 },
                    { level: 30, name: 'Thần Đà Tuyết Sơn', type: 'Buff', desc: 'Tăng 30% Công Kích và 30% Phòng Thủ trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Linh Xà Trượng Pháp', type: 'Tấn công liên hoàn', desc: 'Trượng pháp dũng mãnh, đánh 3 lần, mỗi lần ATK × 0.9.',
                      chance: 35, multiplier: 0.9, hits: 3, ignoreDef: 0.1, bonusCrit: 5, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Hàm Mô Công', type: 'Tấn công bùng nổ', desc: 'Trấn phái. Tích tụ kình lực (Buff Def cực đại), sau đó gây ATK × 4.5 lên địch.',
                      chance: 20, multiplier: 4.5, hits: 1, ignoreDef: 0.2, bonusCrit: 30, manaCost: 50, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 5 } },
                    { level: 80, name: 'Nghịch Chuyển Kinh Mạch', type: 'Bị động', desc: 'Tăng 30% Kháng Hiệu Ứng và 20% Né Tránh (đổi chỗ huyệt đạo).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 20 } }, // Kháng chưa có stat riêng
                    { level: 120, name: 'Cáp Mô Công - Cực', type: 'Tấn công siêu cấp', desc: 'Một đòn toàn lực, gây ATK × 5.0, 100% Làm Choáng (mô phỏng giảm tốc độ 80%).',
                      chance: 15, multiplier: 5.0, hits: 1, ignoreDef: 0.3, bonusCrit: 50, manaCost: 80, effect: { type: 'debuff', stat: 'spd', value: -0.8, duration: 5 } },
                    { level: 150, name: 'Tây Độc Chi Uy', type: 'Buff Siêu Cấp', desc: 'Tăng 50% Công Kích, 50% ST Chí Mạng trong 20 giây.',
                      chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 20 }, effect2: { type: 'buff', stat: 'critDamage', value: 50, duration: 20 }, manaCost: 100 },
                    { level: 180, name: 'Vạn Độc Bất Xâm', type: 'Bị động', desc: 'Tăng 30% HP và 30% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 30 } }
                ]
            },
            // [NEW] Thêm Không Động Phái
            'khong_dong': {
                name: 'Không Động Phái',
                icon: 'fa-solid fa-hand-back-fist',
                className: 'text-amber-600 text-shadow-orange', // [NEW] Style
                desc: 'Nổi danh với Thất Thương Quyền - "Một người luyện, bảy người thương". Sức sát thương cực lớn nhưng gây tổn hại cơ thể (mô phỏng bằng Def thấp bù Atk cao).',
                skills: [
                    { level: 1, name: 'Thất Thương Quyền (Sơ)', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.3, sát thương cao hơn bình thường.', 
                      chance: 0, multiplier: 1.3, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Nguyên Khí Công', type: 'Bị động', desc: 'Tăng 25% HP (để bù đắp tổn thương).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 25 } },
                    { level: 20, name: 'Tổn Tâm Quyết', type: 'Tấn công xuyên thấu', desc: 'Gây ATK × 2.2, bỏ qua 30% Phòng Thủ.',
                      chance: 40, multiplier: 2.2, hits: 1, ignoreDef: 0.3, bonusCrit: 10, manaCost: 20 },
                    { level: 30, name: 'Hỗn Nguyên Nhất Khí', type: 'Buff', desc: 'Tăng 40% Công Kích trong 15s, nhưng giảm 20% Phòng Thủ.',
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: -0.2, duration: 15 }, manaCost: 25 },
                    { level: 50, name: 'Tạng Phủ Quyết', type: 'Tấn công nội lực', desc: 'Đánh thẳng vào nội tạng, gây ATK × 2.8, giảm 20% ATK địch.',
                      chance: 30, multiplier: 2.8, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'atk', value: -0.2, duration: 10 }, manaCost: 35 },
                    // Trấn phái
                    { level: 60, name: 'Thất Thương Tổng Quyết', type: 'Tấn công tất sát', desc: 'Trấn phái. Dồn toàn lực, gây ATK × 4.0, bỏ qua 50% DEF.',
                      chance: 30, multiplier: 4.0, hits: 1, ignoreDef: 0.5, bonusCrit: 30, manaCost: 60 },
                    { level: 80, name: 'Quyền Kình', type: 'Bị động', desc: 'Tăng 20% Công Kích và 20% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 20 } },
                    { level: 120, name: 'Đoạn Hồn Quyết', type: 'Tấn công', desc: 'Gây ATK × 5.0, 100% Chí Mạng.',
                      chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 0.2, bonusCrit: 100, manaCost: 80 },
                    { level: 150, name: 'Ngũ Hành Liên Hoàn', type: 'Tấn công liên hoàn', desc: 'Đấm liên tiếp 5 quyền, mỗi quyền ATK × 1.0, tăng tốc đánh 50%.',
                      chance: 35, multiplier: 1.0, hits: 5, ignoreDef: 0.1, effect: { type: 'buff', stat: 'spd', value: 0.5, duration: 5 }, manaCost: 90 },
                    { level: 180, name: 'Kim Cương Chi Thể', type: 'Bị động', desc: 'Tăng 40% HP và 10% Phản Đòn (để sống sót sau khi dùng Thất Thương).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 } }
                ]
            },
            // [NEW] Thêm Âm Quý Phái
            'am_quy': {
                name: 'Âm Quý Phái',
                icon: 'fa-solid fa-ribbon',
                className: 'text-purple-600 text-shadow-purple', // [NEW] Style
                desc: 'Đứng đầu Ma Môn, tu luyện Thiên Ma Đại Pháp. Võ công biến ảo, tạo ảo ảnh, mị hoặc chúng sinh.',
                skills: [
                    { level: 1, name: 'Thiên Ma Nhẫn', type: 'Tấn công sơ cấp', desc: 'Dùng dải lụa tấn công, gây ATK × 1.0, hút 5% HP.', 
                      chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'lifesteal', value: 5, duration: 3 } },
                    { level: 10, name: 'Ma Môn Mị Thuật', type: 'Bị động', desc: 'Tăng 15% Né Tránh và 15% Tốc Độ Đánh.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 15 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 15 } },
                    { level: 20, name: 'Thiên Ma Vũ', type: 'Debuff AoE', desc: 'Điệu múa ma mị, giảm 30% Chính Xác và 20% ATK của địch trong 15s.',
                      chance: 30, multiplier: 0.5, hits: 1, effect: { type: 'debuff', stat: 'accuracy_p', value: -30, duration: 15 }, effect2: { type: 'debuff', stat: 'atk', value: -0.2, duration: 15 }, manaCost: 20 },
                    { level: 30, name: 'Huyễn Ảnh', type: 'Buff', desc: 'Tạo ảo ảnh, tăng 40% Né Tránh trong 10s.',
                      chance: 20, effect: { type: 'buff', stat: 'dodgeChance', value: 40, duration: 10 }, manaCost: 25 },
                    { level: 50, name: 'Thiên Ma Tràng', type: 'Tấn công trường lực', desc: 'Tạo trường lực Thiên Ma, gây ATK × 2.5, hút địch lại (mô phỏng giảm tốc độ 50%).',
                      chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Thiên Ma Đại Pháp', type: 'Buff Toàn Diện', desc: 'Trấn phái. Tăng 30% Tốc Độ, 30% Công Kích và 20% Hút Máu trong 20s.',
                      chance: 15, effect: { type: 'buff', stat: 'spd', value: 0.3, duration: 20 }, effect2: { type: 'buff', stat: 'atk', value: 0.3, duration: 20 }, effect3: { type: 'buff', stat: 'lifesteal', value: 20, duration: 20 }, manaCost: 60 },
                    { level: 80, name: 'Tử Khí Thiên La', type: 'Bị động', desc: 'Tăng 30% Nội Lực và 20% Tốc Độ Đánh.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 20 } },
                    { level: 120, name: 'Kiếm Vũ', type: 'Tấn công liên hoàn', desc: 'Song kiếm như mưa, đánh 8 lần, mỗi lần ATK × 0.5.',
                      chance: 30, multiplier: 0.5, hits: 8, ignoreDef: 0.1, bonusCrit: 10, manaCost: 50 },
                    { level: 150, name: 'Trảm Tình', type: 'Tấn công siêu cấp', desc: 'Một kiếm đoạn tình, gây ATK × 5.0, bỏ qua 40% DEF.',
                      chance: 40, multiplier: 5.0, hits: 1, ignoreDef: 0.4, bonusCrit: 30, manaCost: 80 },
                    { level: 180, name: 'Thiên Ma Hợp Nhất', type: 'Bị động', desc: 'Tăng 20% Tất cả chỉ số cơ bản.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 20 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 20 } }
                ]
            },
            // [NEW] 1. Hạo Thiên Tông (Đấu La)
            'hao_thien': {
                name: 'Hạo Thiên Tông',
                icon: 'fa-solid fa-hammer',
                className: 'text-gray-300 text-shadow-white', // [NEW] Style
                desc: 'Tông môn sở hữu Hạo Thiên Chùy - Khí vũ hồn đệ nhất thiên hạ. Sức mạnh tuyệt đối, phá vỡ mọi phòng ngự.',
                skills: [
                    { level: 1, name: 'Hạo Thiên Cửu Tuyệt', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.3, bỏ qua 10% DEF.', chance: 0, multiplier: 1.3, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Loạn Phi Phong', type: 'Bị động', desc: 'Tăng 20% Công Kích và 10% Chính Xác.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 10 } },
                    { level: 20, name: 'Định Lực Chi Phá', type: 'Tấn công', desc: 'Một búa định càn khôn, gây ATK × 2.5, gây choáng (mô phỏng giảm tốc 50%).', chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 20 },
                    { level: 30, name: 'Thái Thản Thương Khung Phá', type: 'Buff', desc: 'Tăng 50% Công Kích trong 10s.', chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 10 }, manaCost: 30 },
                    { level: 50, name: 'Lăng Thiên Nhất Kích', type: 'Tấn công bạo kích', desc: 'Gây ATK × 3.0, +30% Tỉ Lệ Chí Mạng.', chance: 35, multiplier: 3.0, hits: 1, ignoreDef: 0.1, bonusCrit: 30, manaCost: 40 },
                    { level: 60, name: 'Hạo Thiên Chân Thân', type: 'Buff', desc: 'Trấn phái. Tăng 40% ATK, 40% DEF và 20% Bỏ qua DEF.', chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.4, duration: 20 }, effect3: { type: 'buff', stat: 'ignoreDef_p', value: 20, duration: 20 }, manaCost: 60 },
                    { level: 80, name: 'Tu Di Chùy', type: 'Bị động', desc: 'Tăng 30% Sát Thương Chí Mạng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 30 } },
                    { level: 120, name: 'Đại Tu Di Chùy', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 6.0, bỏ qua 50% DEF.', chance: 25, multiplier: 6.0, hits: 1, ignoreDef: 0.5, bonusCrit: 0, manaCost: 80 },
                    { level: 150, name: 'Tạc Hoàn', type: 'Buff Bùng Nổ', desc: 'Hy sinh 20% HP (chưa hỗ trợ) để tăng 100% ATK trong 5s.', chance: 10, effect: { type: 'buff', stat: 'atk', value: 1.0, duration: 5 }, manaCost: 0 },
                    { level: 180, name: 'Thần Kỹ: Hạo Thiên', type: 'Bị động', desc: 'Tăng 30% Công Kích và 30% Bỏ qua Phòng Ngự.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 30 } }
                ]
            },
            // [NEW] 2. Thất Bảo Lưu Ly Tông (Đấu La)
            'that_bao': {
                name: 'Thất Bảo Lưu Ly',
                icon: 'fa-solid fa-gem',
                className: 'text-rainbow-animation', // [NEW] Style
                desc: 'Hỗ trợ đệ nhất thiên hạ. Khả năng buff chỉ số kinh hoàng cho bản thân và đồng đội (mô phỏng buff bản thân).',
                skills: [
                    { level: 1, name: 'Lực Lượng Tăng Ph幅', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, tự tăng 10% ATK trong 5s.', chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'atk', value: 0.1, duration: 5 } },
                    { level: 10, name: 'Phân Tâm Khống Chế', type: 'Bị động', desc: 'Tăng 20% Nội Lực và 10% Tốc Độ Đánh.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 10 } },
                    { level: 20, name: 'Tốc Độ Tăng Ph幅', type: 'Buff', desc: 'Tăng 30% Tốc Độ Đánh và 20% Né Tránh trong 15s.', chance: 30, effect: { type: 'buff', stat: 'spd', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 20, duration: 15 }, manaCost: 20 },
                    { level: 30, name: 'Hồn Lực Tăng Ph幅', type: 'Buff', desc: 'Hồi 20% Mana và tăng 20% Công Kỹ (chưa hỗ trợ) trong 15s.', chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.2, duration: 15 }, manaCost: 25 },
                    { level: 50, name: 'Công Kích Tăng Ph幅', type: 'Buff', desc: 'Tăng 40% Công Kích và 20% Chính Xác trong 15s.', chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'accuracy_p', value: 20, duration: 15 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Cửu Bảo Chân Thân', type: 'Buff Toàn Diện', desc: 'Trấn phái. Tăng 30% TẤT CẢ chỉ số trong 20s.', chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.3, duration: 20 }, effect3: { type: 'buff', stat: 'hp', value: 0.3, duration: 20 }, effect4: { type: 'buff', stat: 'spd', value: 0.3, duration: 20 }, manaCost: 60 },
                    { level: 80, name: 'Lưu Ly Hộ Thể', type: 'Bị động', desc: 'Tăng 30% Phòng Thủ và 20% Kháng Hiệu Ứng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 30 } },
                    { level: 120, name: 'Cửu Bảo Vô Địch Thần Quang', type: 'Buff Bất Tử', desc: 'Tăng 200% Phòng Thủ và miễn nhiễm sát thương trong 3s (mô phỏng Def cực cao).', chance: 10, effect: { type: 'buff', stat: 'def', value: 2.0, duration: 3 }, manaCost: 50 },
                    { level: 150, name: 'Thất Bảo琉Ly Tháp', type: 'Tấn công phép', desc: 'Dùng tháp trấn áp, gây ATK × 4.0, làm choáng (giảm tốc 80%).', chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.8, duration: 5 }, manaCost: 70 },
                    { level: 180, name: 'Phục Hồi Chi Quang', type: 'Bị động', desc: 'Hồi 2% HP/s (chưa hỗ trợ). Tăng 40% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 } }
                ]
            },
            // [NEW] 3. Lam Điện Bá Vương Long (Đấu La)
            'ba_vuong_long': {
                name: 'Bá Vương Long',
                icon: 'fa-solid fa-bolt-lightning',
                className: 'text-blue-500 text-shadow-blue', // [NEW] Style
                desc: 'Gia tộc sở hữu Vũ Hồn Rồng Sét mạnh nhất. Sát thương Lôi đình, tê liệt kẻ địch và sức mạnh cơ bắp.',
                skills: [
                    { level: 1, name: 'Lôi Đình Long Trảo', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.2, 20% gây tê liệt (giảm tốc 20%).', chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0, effect: { type: 'debuff', stat: 'spd', value: -0.2, duration: 3 } },
                    { level: 10, name: 'Long Hóa', type: 'Bị động', desc: 'Tăng 15% HP, 15% ATK và 15% DEF.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 15 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 15 } },
                    { level: 20, name: 'Lôi Đình Vạn Quân', type: 'Tấn công AoE', desc: 'Phóng sét diện rộng, gây ATK × 1.5 cho 3 mục tiêu, 30% Tỉ Lệ Chí Mạng.', chance: 35, multiplier: 1.5, hits: 3, ignoreDef: 0, bonusCrit: 30, manaCost: 20 },
                    { level: 30, name: 'Lôi Đình Chi Nộ', type: 'Buff', desc: 'Tăng 40% Công Kích và 20% Tỉ Lệ Chí Mạng trong 15s.', chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'critChance', value: 20, duration: 15 }, manaCost: 30 },
                    { level: 50, name: 'Long Thủ Sấm Sét', type: 'Tấn công đơn', desc: 'Gây ATK × 3.0, bỏ qua 30% Phòng Thủ.', chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.3, bonusCrit: 10, manaCost: 35 },
                    // Trấn phái
                    { level: 60, name: 'Chân Long Giáng Thế', type: 'Buff Biến Hình', desc: 'Trấn phái. Hóa rồng, tăng 50% HP, 30% ATK, 30% DEF trong 20s.', chance: 15, effect: { type: 'buff', stat: 'hp', value: 0.5, duration: 20 }, effect2: { type: 'buff', stat: 'atk', value: 0.3, duration: 20 }, effect3: { type: 'buff', stat: 'def', value: 0.3, duration: 20 }, manaCost: 60 },
                    { level: 80, name: 'Lân Giáp Hộ Thể', type: 'Bị động', desc: 'Tăng 30% Phòng Thủ và 20% Phản Đòn (chưa hỗ trợ).', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 30 } },
                    { level: 120, name: 'Long Đằng Cửu Thiên', type: 'Tấn công', desc: 'Bay lên trời rồi lao xuống, gây ATK × 4.5, 100% Trúng Đích.', chance: 25, multiplier: 4.5, hits: 1, ignoreDef: 0.2, bonusCrit: 20, manaCost: 70 },
                    { level: 150, name: 'Cửu Thiên Huyền Lôi', type: 'Tấn công siêu cấp', desc: 'Triệu hồi sấm sét cửu thiên, gây ATK × 5.0 diện rộng, tê liệt cực mạnh.', chance: 30, multiplier: 5.0, hits: 1, ignoreDef: 0.4, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 90 },
                    { level: 180, name: 'Long Thần Chi Huyết', type: 'Bị động', desc: 'Tăng 40% HP và 20% Hồi Phục (Lifesteal).', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 20 } }
                ]
            },
            // [NEW] 4. Thanh Vân Môn (Tru Tiên)
            'thanh_van': {
                name: 'Thanh Vân Môn',
                icon: 'fa-solid fa-cloud-bolt',
                className: 'text-sky-400 text-shadow-cyan', // [NEW] Style
                desc: 'Đệ nhất chính phái Tru Tiên. Tu luyện Thái Cực Huyền Thanh Đạo, sở hữu Thần Kiếm Ngự Lôi Chân Quyết.',
                skills: [
                    { level: 1, name: 'Ngự Kiếm Quyết', type: 'Tấn công sơ cấp', desc: 'Điều khiển phi kiếm, gây ATK × 1.1, tầm xa.', chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Thái Cực Huyền Thanh', type: 'Bị động', desc: 'Tăng 20% Nội Lực và 10% Hồi Nội Lực.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'manasteal', value: 10 } },
                    { level: 20, name: 'Hàn Băng Chú', type: 'Tấn công phép', desc: 'Gây ATK × 1.5, làm chậm địch 30%.', chance: 35, multiplier: 1.5, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.3, duration: 5 }, manaCost: 15 },
                    { level: 30, name: 'Thiên Cơ Ấn', type: 'Buff', desc: 'Tạo khiên mana (tăng 50% DEF) trong 10s.', chance: 25, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 10 }, manaCost: 20 },
                    { level: 50, name: 'Thất Kiếp Trảm Long', type: 'Tấn công liên hoàn', desc: 'Bảy kiếm trảm rồng, đánh 7 lần, mỗi lần ATK × 0.6.', chance: 30, multiplier: 0.6, hits: 7, ignoreDef: 0.2, bonusCrit: 10, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Thần Kiếm Ngự Lôi', type: 'Tấn công AoE', desc: 'Trấn phái. Cửu thiên huyền sát, hóa vi thần lôi. Gây ATK × 4.0 diện rộng, 50% Chí Mạng.', chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.3, bonusCrit: 50, manaCost: 80 },
                    { level: 80, name: 'Đại Đạo Vô Hình', type: 'Bị động', desc: 'Tăng 20% Né Tránh và 20% Kháng Hiệu Ứng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 20 } },
                    { level: 120, name: 'Kiếm Tâm Thông Minh', type: 'Buff', desc: 'Tăng 40% Công Kích và 40% Chính Xác trong 20s.', chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 20 }, effect2: { type: 'buff', stat: 'accuracy_p', value: 40, duration: 20 }, manaCost: 50 },
                    { level: 150, name: 'Tru Tiên Kiếm Trận', type: 'Tấn công siêu cấp', desc: 'Kích hoạt trận pháp cổ xưa, gây ATK × 6.0, bỏ qua 60% DEF.', chance: 20, multiplier: 6.0, hits: 1, ignoreDef: 0.6, bonusCrit: 30, manaCost: 100 },
                    { level: 180, name: 'Thiên Nhân Hợp Nhất', type: 'Bị động', desc: 'Tăng 30% Công Kích và 30% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 30 } }
                ]
            },
            // [NEW] 5. Quỷ Vương Tông (Tru Tiên)
            'quy_vuong': {
                name: 'Quỷ Vương Tông',
                icon: 'fa-solid fa-ghost',
                className: 'text-red-800 text-shadow-red', // [NEW] Style
                desc: 'Ma giáo bá chủ, tu luyện từ Thiên Thư quyển 2. Sức mạnh điên cuồng, phòng thủ cực cao và phản kích mãnh liệt.',
                skills: [
                    { level: 1, name: 'Hỏa Diễm Đao', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.2, kèm sát thương lửa.', chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Thiên Thư Ma Điển', type: 'Bị động', desc: 'Tăng 20% Phòng Thủ và 10% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 10 } },
                    { level: 20, name: 'Tu La Trảm', type: 'Tấn công bạo kích', desc: 'Gây ATK × 2.0, +20% Chí Mạng, gây chảy máu (chưa hỗ trợ).', chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0.1, bonusCrit: 20, manaCost: 15 },
                    { level: 30, name: 'Cuồng Linh Nộ', type: 'Buff', desc: 'Tăng 40% Công Kích nhưng giảm 20% Phòng Thủ trong 15s.', chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: -0.2, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Hóa Huyết Thần Đao', type: 'Tấn công hút máu', desc: 'Gây ATK × 2.5, hút 30% sát thương thành HP (Lifesteal).', chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'buff', stat: 'lifesteal', value: 30, duration: 5 }, manaCost: 35 },
                    // Trấn phái
                    { level: 60, name: 'Si Tình Chú', type: 'Buff Hy Sinh', desc: 'Trấn phái. Hy sinh 30% HP (chưa hỗ trợ) để tạo khiên chặn mọi sát thương trong 5s và tăng 50% ATK.', chance: 10, effect: { type: 'buff', stat: 'def', value: 2.0, duration: 5 }, effect2: { type: 'buff', stat: 'atk', value: 0.5, duration: 10 }, manaCost: 0 },
                    { level: 80, name: 'Quỷ Vương Chiến Giáp', type: 'Bị động', desc: 'Tăng 30% Phòng Thủ và 20% Phản Đòn.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 30 } },
                    { level: 120, name: 'Tứ Linh Huyết Trận', type: 'Tấn công AoE', desc: 'Triệu hồi Tứ Linh, gây ATK × 4.0 diện rộng, hấp thụ sinh lực địch.', chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.2, effect: { type: 'buff', stat: 'lifesteal', value: 20, duration: 5 }, manaCost: 70 },
                    { level: 150, name: 'Vị Minh Đỉnh', type: 'Debuff', desc: 'Giam cầm địch, giảm 50% ATK và 50% DEF trong 10s.', chance: 20, effect: { type: 'debuff', stat: 'atk', value: -0.5, duration: 10 }, effect2: { type: 'debuff', stat: 'def', value: -0.5, duration: 10 }, manaCost: 60 },
                    { level: 180, name: 'Minh Vương Giáng Thế', type: 'Bị động', desc: 'Tăng 40% HP và 20% Sát Thương Chí Mạng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 20 } }
                ]
            },
            // [NEW] 6. Hợp Hoan Phái (Tru Tiên)
            'hop_hoan': {
                name: 'Hợp Hoan Phái',
                icon: 'fa-solid fa-heart',
                className: 'text-pink-500 text-shadow-pink', // [NEW] Style
                desc: 'Môn phái ma giáo, võ công quỷ dị, thân pháp nhanh như chớp. Chuyên về mê hoặc và sát thương chí mạng.',
                skills: [
                    { level: 1, name: 'Đoạn Tình Trảm', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.0, +10% Chí Mạng.', chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 10, manaCost: 0 },
                    { level: 10, name: 'Hợp Hoan Linh', type: 'Bị động', desc: 'Tăng 20% Tốc Độ Đánh và 10% Né Tránh.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 10 } },
                    { level: 20, name: 'Khuynh Thành', type: 'Debuff', desc: 'Mê hoặc địch, giảm 30% Chính Xác trong 10s.', chance: 30, effect: { type: 'debuff', stat: 'accuracy_p', value: -30, duration: 10 }, manaCost: 15 },
                    { level: 30, name: 'Khích Lệ', type: 'Buff', desc: 'Tăng 40% Tốc Độ Đánh và 20% Công Kích trong 15s.', chance: 25, effect: { type: 'buff', stat: 'spd', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'atk', value: 0.2, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Triền Miên', type: 'Tấn công khống chế', desc: 'Gây ATK × 2.5, làm chậm 40% (giảm SPD) trong 5s.', chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.4, duration: 5 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Cựu Mộng', type: 'Tấn công bạo kích', desc: 'Trấn phái. Gây ATK × 3.5, xóa buff của địch (chưa hỗ trợ), 50% Chí Mạng.', chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 45 },
                    { level: 80, name: 'Phong Hoa Tuyết Nguyệt', type: 'Tấn công liên hoàn', desc: 'Tấn công 4 lần, mỗi lần ATK × 0.8, hồi phục HP theo sát thương (Lifesteal 20%).', chance: 30, multiplier: 0.8, hits: 4, ignoreDef: 0.1, effect: { type: 'buff', stat: 'lifesteal', value: 20, duration: 5 }, manaCost: 50 },
                    { level: 120, name: 'Huyễn Chân', type: 'Buff', desc: 'Tăng 50% Né Tránh và hồi phục 30% Mana.', chance: 20, effect: { type: 'buff', stat: 'dodgeChance', value: 50, duration: 10 }, manaCost: 40 },
                    { level: 150, name: 'Liên Tích', type: 'Buff Bạo Kích', desc: 'Tăng 50% Tỉ Lệ Chí Mạng và 50% ST Chí Mạng trong 10s.', chance: 15, effect: { type: 'buff', stat: 'critChance', value: 50, duration: 10 }, effect2: { type: 'buff', stat: 'critDamage', value: 50, duration: 10 }, manaCost: 60 },
                    { level: 180, name: 'Tuyệt Đại Phong Hoa', type: 'Bị động', desc: 'Tăng 30% Tốc Độ Đánh và 30% Sát Thương Chí Mạng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 30 } }
                ]
            },
            // [NEW] 7. Thiên Âm Tự (Tru Tiên)
            'thien_am': {
                name: 'Thiên Âm Tự',
                icon: 'fa-solid fa-dharmachakra',
                className: 'text-yellow-500 text-shadow-gold', // [NEW] Style
                desc: 'Phật môn thanh tịnh, lấy từ bi làm gốc. Chuyên về hồi phục, tăng cường phòng thủ và phản sát thương.',
                skills: [
                    { level: 1, name: 'Đại Bi Chú', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 0.9, hồi 2% HP cho bản thân.', chance: 0, multiplier: 0.9, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 5, effect: { type: 'buff', stat: 'lifesteal', value: 10, duration: 2 } },
                    { level: 10, name: 'Bồ Đề Tâm Kinh', type: 'Bị động', desc: 'Tăng 20% HP và 10% Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 10 } },
                    { level: 20, name: 'Vãng Sinh Chú', type: 'Hồi phục', desc: 'Hồi phục 20% HP tối đa ngay lập tức (mô phỏng buff HP regen).', chance: 20, effect: { type: 'buff', stat: 'lifesteal', value: 100, duration: 2 }, manaCost: 30 },
                    { level: 30, name: 'Kim Cang Hộ Thể', type: 'Buff', desc: 'Tăng 50% Phòng Thủ trong 15s.', chance: 25, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Lục Tự Đại Minh Chú', type: 'Tấn công khống chế', desc: 'Niệm chú gây choáng (giảm tốc 60%), gây ATK × 2.0.', chance: 30, multiplier: 2.0, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'spd', value: -0.6, duration: 5 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Đại Phạm Bát Nhã', type: 'Buff Toàn Diện', desc: 'Trấn phái. Tăng 30% HP, 30% ATK và hồi máu liên tục.', chance: 15, effect: { type: 'buff', stat: 'hp', value: 0.3, duration: 20 }, effect2: { type: 'buff', stat: 'atk', value: 0.3, duration: 20 }, manaCost: 60 },
                    { level: 80, name: 'Nhân Quả Tuần Hoàn', type: 'Bị động', desc: 'Tăng 30% Phản Đòn (chưa hỗ trợ) và 20% DEF.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 120, name: 'Vô Lượng Chân Ngôn', type: 'Tấn công AoE', desc: 'Gây ATK × 3.0 diện rộng, giảm 30% ATK địch.', chance: 25, multiplier: 3.0, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'atk', value: -0.3, duration: 10 }, manaCost: 50 },
                    { level: 150, name: 'Vạn Tượng Sinh Phật', type: 'Hồi phục siêu cấp', desc: 'Hồi đầy 100% HP (mô phỏng buff lifesteal cực đại).', chance: 5, effect: { type: 'buff', stat: 'lifesteal', value: 500, duration: 2 }, manaCost: 100 },
                    { level: 180, name: 'Niết Bàn Trùng Sinh', type: 'Bị động', desc: 'Tăng 50% HP tối đa.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 50 } }
                ]
            },
            // [NEW] 8. Phần Hương Cốc (Tru Tiên)
            'phan_huong': {
                name: 'Phần Hương Cốc',
                icon: 'fa-solid fa-fire-burner',
                className: 'text-orange-600 text-shadow-red', // [NEW] Style
                desc: 'Thủ hộ giả của Nam Cương, sử dụng pháp thuật Hỏa hệ thượng cổ. Triệu hồi Hỏa Long, thiêu đốt vạn vật.',
                skills: [
                    { level: 1, name: 'Hỏa Diễm Trảm', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.2, sát thương lửa.', chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0.05, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Phần Hương Ngọc Sách', type: 'Bị động', desc: 'Tăng 20% Công Kích và 10% Chính Xác.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 10 } },
                    { level: 20, name: 'Nghiệp Hỏa Liên Thiên', type: 'Tấn công AoE', desc: 'Biển lửa bao trùm, gây ATK × 1.8 cho 3 mục tiêu (3 hits).', chance: 40, multiplier: 1.8, hits: 3, ignoreDef: 0.1, bonusCrit: 5, manaCost: 25 },
                    { level: 30, name: 'Hỏa Long Triệu Hoán', type: 'Buff', desc: 'Triệu hồi Hỏa Long trợ chiến, tăng 40% ATK trong 15s.', chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 15 }, manaCost: 30 },
                    { level: 50, name: 'Nam Cương Vu Thuật', type: 'Debuff', desc: 'Nguyền rủa địch, giảm 30% DEF và gây sát thương đốt cháy (chưa hỗ trợ).', chance: 30, multiplier: 1.0, hits: 1, effect: { type: 'debuff', stat: 'def', value: -0.3, duration: 10 }, manaCost: 35 },
                    // Trấn phái
                    { level: 60, name: 'Bát Hung Huyền Hỏa Trận', type: 'Tấn công siêu cấp', desc: 'Trấn phái. Triệu hồi Bát Hung Hỏa Long, gây ATK × 5.0, 100% Bỏ qua DEF.', chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 20, manaCost: 80 },
                    { level: 80, name: 'Chí Dương Chi Thể', type: 'Bị động', desc: 'Tăng 30% Kháng Hiệu Ứng và 20% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 } },
                    { level: 120, name: 'Huyền Hỏa Giám', type: 'Tấn công', desc: 'Dùng神器 tấn công, gây ATK × 3.5, tăng 30% Sát Thương Chí Mạng.', chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, effect: { type: 'buff', stat: 'critDamage', value: 30, duration: 5 }, manaCost: 50 },
                    { level: 150, name: 'Thiên Hỏa Diệt Thế', type: 'Tấn công AoE', desc: 'Mưa lửa từ trời, gây ATK × 4.5 diện rộng, thiêu đốt tất cả.', chance: 35, multiplier: 4.5, hits: 1, ignoreDef: 0.3, bonusCrit: 30, manaCost: 90 },
                    { level: 180, name: 'Hỏa Thần Giáng Lâm', type: 'Bị động', desc: 'Tăng 40% Công Kích và 20% Bỏ qua Phòng Ngự.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } }
                ]
            },
            // [NEW] 9. Vân Lam Tông (Đấu Phá)
            'van_lam': {
                name: 'Vân Lam Tông',
                icon: 'fa-solid fa-cloud',
                className: 'text-cyan-200 text-shadow-white', // [NEW] Style
                desc: 'Tông môn lớn nhất Gia Mã Đế Quốc. Chuyên tu luyện Phong hệ đấu khí, kiếm pháp nhanh như gió, biến ảo khôn lường.',
                skills: [
                    { level: 1, name: 'Phong Nhận', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.1, tăng 10% Tốc Độ Đánh trong 3s.', chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'spd', value: 0.1, duration: 3 } },
                    { level: 10, name: 'Thanh Phong Quyết', type: 'Bị động', desc: 'Tăng 20% Tốc Độ Đánh và 10% Né Tránh.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 10 } },
                    { level: 20, name: 'Phong Chi Cực: Vẫn Sát', type: 'Tấn công bạo kích', desc: 'Tụ khí thành tuyến, một điểm phá vỡ. Gây ATK × 2.5, +40% Chí Mạng.', chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.2, bonusCrit: 40, manaCost: 25 },
                    { level: 30, name: 'Vân Yên Phúc Nhật', type: 'Buff', desc: 'Tạo màn sương che mắt địch, tăng 40% Né Tránh trong 10s.', chance: 20, effect: { type: 'buff', stat: 'dodgeChance', value: 40, duration: 10 }, manaCost: 20 },
                    { level: 50, name: 'Thiên Phong Cương', type: 'Buff', desc: 'Tạo giáp gió, tăng 30% DEF và phản sát thương (chưa hỗ trợ).', chance: 25, effect: { type: 'buff', stat: 'def', value: 0.3, duration: 15 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Phong Chi Cực: Lạc Nhật Diệu', type: 'Tấn công AoE', desc: 'Trấn phái. Ánh sáng kiếm khí chói lòa, gây ATK × 4.0, giảm 50% Chính Xác địch.', chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'accuracy_p', value: -50, duration: 10 }, manaCost: 60 },
                    { level: 80, name: 'Vân Lam Kiếm Ý', type: 'Bị động', desc: 'Tăng 20% Công Kích và 20% Bỏ qua Phòng Ngự.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } },
                    { level: 120, name: 'Vân Vụ Ẩn', type: 'Buff', desc: 'Thân pháp quỷ mị, tăng 50% Tốc Độ Đánh và 30% Né Tránh.', chance: 20, effect: { type: 'buff', stat: 'spd', value: 0.5, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 30, duration: 15 }, manaCost: 40 },
                    { level: 150, name: 'Vạn Kiếm Xuyên Tâm', type: 'Tấn công liên hoàn', desc: 'Triệu hồi vạn kiếm, tấn công liên tục 10 lần, mỗi lần ATK × 0.5.', chance: 30, multiplier: 0.5, hits: 10, ignoreDef: 0.1, bonusCrit: 20, manaCost: 80 },
                    { level: 180, name: 'Đấu Tông Chi Lực', type: 'Bị động', desc: 'Tăng 30% TẤT CẢ chỉ số.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 30 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 30 } }
                ]
            },
            // [NEW] 10. Hồn Điện (Đấu Phá)
            'hon_dien': {
                name: 'Hồn Điện',
                icon: 'fa-solid fa-link',
                className: 'text-gray-500 text-shadow-purple', // [NEW] Style
                desc: 'Tổ chức bí ẩn chuyên thu thập linh hồn khắp đại lục. Sở hữu bí pháp quỷ dị, tấn công trực tiếp vào linh hồn.',
                skills: [
                    { level: 1, name: 'Câu Hồn Tác', type: 'Tấn công sơ cấp', desc: 'Xích linh hồn, gây ATK × 1.0, bỏ qua 20% DEF.', chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0.2, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Vụ Vụ Hộ Thể', type: 'Bị động', desc: 'Tăng 20% Né Tránh và 20% Kháng Sát Thương (Def).', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 20 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 20, name: 'Phệ Hồn', type: 'Tấn công hút máu', desc: 'Gây ATK × 1.5, hút 10% sinh lực và nội lực.', chance: 35, multiplier: 1.5, hits: 1, ignoreDef: 0.1, effect: { type: 'buff', stat: 'lifesteal', value: 10, duration: 5 }, effect2: { type: 'buff', stat: 'manasteal', value: 10, duration: 5 }, manaCost: 20 },
                    { level: 30, name: 'Vạn Hồn Phệ', type: 'Debuff', desc: 'Triệu hồi oan hồn cắn xé, giảm 40% ATK và DEF của địch.', chance: 25, effect: { type: 'debuff', stat: 'atk', value: -0.4, duration: 15 }, effect2: { type: 'debuff', stat: 'def', value: -0.4, duration: 15 }, manaCost: 30 },
                    { level: 50, name: 'Hư Vô Thôn Phệ', type: 'Tấn công', desc: 'Hóa thành hư vô nuốt chửng địch, gây ATK × 3.0, bỏ qua 50% DEF.', chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.5, bonusCrit: 10, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Táng Thiên Trận', type: 'Tấn công AoE', desc: 'Trấn phái. Trận pháp hiến tế, gây ATK × 5.0, 100% Bỏ qua DEF (Sát thương chuẩn).', chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 30, manaCost: 100 },
                    { level: 80, name: 'Hồn Diệt Sinh', type: 'Bị động', desc: 'Tăng 30% Công Kích và 30% Bỏ qua Phòng Ngự.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 30 } },
                    { level: 120, name: 'Cửu U Phong Viêm', type: 'Tấn công DoT', desc: 'Lửa tâm linh thiêu đốt, gây ATK × 3.5, giảm hồi phục địch (chưa hỗ trợ).', chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.3, bonusCrit: 20, manaCost: 60 },
                    { level: 150, name: 'Điện Chủ Chi Uy', type: 'Buff Siêu Cấp', desc: 'Tăng 100% Công Kích trong 10s, nhưng giảm 50% DEF.', chance: 10, effect: { type: 'buff', stat: 'atk', value: 1.0, duration: 10 }, effect2: { type: 'buff', stat: 'def', value: -0.5, duration: 10 }, manaCost: 80 },
                    { level: 180, name: 'Bất Tử Hồn', type: 'Bị động', desc: 'Khi chịu sát thương chí tử, có 30% cơ hội bất tử trong 1s (chưa hỗ trợ). Tăng 50% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 50 } }
                ]
            },
            // [NEW] 11. Thiên Hạ Hội (Phong Vân)
            'thien_ha_hoi': {
                name: 'Thiên Hạ Hội',
                icon: 'fa-solid fa-hand-back-fist',
                className: 'text-red-500 text-shadow-gold', // [NEW] Style
                desc: 'Bang phái bá chủ võ lâm trong Phong Vân. Tuyệt kỹ Tam Tuyệt: Phong Thần Cước, Bài Vân Chưởng, Thiên Sương Quyền.',
                skills: [
                    { level: 1, name: 'Phong Thần Cước', type: 'Tấn công tốc độ', desc: 'Cước pháp như gió lốc, gây ATK × 1.1, tăng 10% Tốc Độ Đánh.', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'spd', value: 0.1, duration: 3 } },
                    { level: 10, name: 'Hùng Bá Thiên Hạ', type: 'Bị động', desc: 'Tăng 15% Công Kích và 15% HP.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 15 } },
                    { level: 20, name: 'Bài Vân Chưởng', type: 'Tấn công nội lực', desc: 'Chưởng pháp hư ảo, gây ATK × 1.8, bỏ qua 20% Phòng Thủ.', 
                      chance: 35, multiplier: 1.8, hits: 1, ignoreDef: 0.2, bonusCrit: 5, manaCost: 15 },
                    { level: 30, name: 'Thiên Sương Quyền', type: 'Khống chế', desc: 'Quyền khí băng giá, gây ATK × 2.0, làm chậm 30% (giảm SPD).', 
                      chance: 30, multiplier: 2.0, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'spd', value: -0.3, duration: 10 }, manaCost: 20 },
                    { level: 50, name: 'Tam Phân Quy Nguyên Khí', type: 'Tấn công tầm xa', desc: 'Hợp nhất Phong Vân Sương, bắn ra cầu năng lượng gây ATK × 3.0.', 
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.1, bonusCrit: 20, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Tam Phân Thần Chỉ', type: 'Tấn công xuyên thấu', desc: 'Trấn phái. Chỉ lực xuyên tim, gây ATK × 4.0, bỏ qua 50% DEF.', 
                      chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.5, bonusCrit: 30, manaCost: 60 },
                    { level: 80, name: 'Mệnh Cách Bá Giả', type: 'Bị động', desc: 'Tăng 20% Sát Thương Chí Mạng và 20% Kháng Hiệu Ứng.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 20 } },
                    { level: 120, name: 'Ma Kha Vô Lượng', type: 'Tấn công siêu cấp', desc: 'Sức mạnh của Phong Vân hợp bích (mô phỏng), gây ATK × 5.5 diện rộng.', 
                      chance: 20, multiplier: 5.5, hits: 1, ignoreDef: 0.3, bonusCrit: 40, manaCost: 80 },
                    { level: 150, name: 'Quy Nguyên Nhất Kích', type: 'Kết liễu', desc: 'Gây ATK × 7.0, nếu địch dưới 50% HP nhân đôi sát thương (chưa hỗ trợ logic HP).', 
                      chance: 15, multiplier: 7.0, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 100 },
                    { level: 180, name: 'Cửu Tiêu Long Ngâm', type: 'Bị động', desc: 'Tăng 30% Công Kích và 30% Né Tránh.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 30 } }
                ]
            },
            // [NEW] 12. Vô Song Thành (Phong Vân)
            'vo_song': {
                name: 'Vô Song Thành',
                icon: 'fa-solid fa-khanda',
                className: 'text-yellow-300 text-shadow-red', // [NEW] Style
                desc: 'Thành trì đối địch với Thiên Hạ Hội, nơi Kiếm Thánh ngộ ra Thánh Linh Kiếm Pháp. Kiếm chiêu tàn khốc, hủy diệt linh hồn.',
                skills: [
                    { level: 1, name: 'Thánh Linh Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Gây ATK × 1.2, tăng 5% Tỉ Lệ Chí Mạng.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Kiếm Tâm', type: 'Bị động', desc: 'Tăng 20% Công Kích và 10% Sát Thương Chí Mạng.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 10 } },
                    { level: 20, name: 'Kiếm Bát', type: 'Tấn công liên hoàn', desc: 'Hai đường kiếm chéo, gây 2 lần ATK × 1.0.', 
                      chance: 40, multiplier: 1.0, hits: 2, ignoreDef: 0.1, bonusCrit: 10, manaCost: 15 },
                    { level: 30, name: 'Vô Song Bá Thể', type: 'Buff', desc: 'Tăng 40% Phòng Thủ trong 15s.', 
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.4, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Kiếm Nhị Thập Hai', type: 'Tấn công AoE', desc: 'Kiếm khí tung hoành, gây ATK × 3.5 cho toàn bộ địch (mô phỏng hit mạnh).', 
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 20, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Kiếm Nhị Thập Ba', type: 'Tấn công hủy diệt', desc: 'Trấn phái. Ngưng đọng thời gian, linh hồn xuất khiếu trảm địch. Gây ATK × 5.0, 100% Trúng, Bỏ qua 100% DEF.', 
                      chance: 15, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 100, manaCost: 100 },
                    { level: 80, name: 'Kiếm Ý Bất Diệt', type: 'Bị động', desc: 'Tăng 30% Công Kích khi HP thấp (mô phỏng tăng thẳng 30% ATK).', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 } },
                    { level: 120, name: 'Tình Nghĩa Lưỡng Nan', type: 'Tấn công', desc: 'Chiêu kiếm sầu bi, gây ATK × 4.5, giảm 40% ATK địch.', 
                      chance: 25, multiplier: 4.5, hits: 1, ignoreDef: 0.3, effect: { type: 'debuff', stat: 'atk', value: -0.4, duration: 10 }, manaCost: 60 },
                    { level: 150, name: 'Lục Diệt Kiếm Hai Ba', type: 'Tấn công siêu cấp', desc: 'Phiên bản hoàn thiện của Kiếm 23. Gây ATK × 8.0, chắc chắn chí mạng.', 
                      chance: 10, multiplier: 8.0, hits: 1, ignoreDef: 0.8, bonusCrit: 100, manaCost: 120 },
                    { level: 180, name: 'Vô Song Kiếm Hồn', type: 'Bị động', desc: 'Tăng 40% Sát Thương Chí Mạng và 20% Bỏ qua Phòng Ngự.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 40 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } }
                ]
            },
            // [NEW] 13. Trung Hoa Các (Phong Vân)
            'trung_hoa': {
                name: 'Trung Hoa Các',
                icon: 'fa-solid fa-medal',
                className: 'text-blue-300 text-shadow-white', // [NEW] Style
                desc: 'Nơi ở ẩn của Võ Lâm Thần Thoại - Vô Danh. Kiếm tông chính phái, đạt đến cảnh giới Thiên Kiếm.',
                skills: [
                    { level: 1, name: 'Mạc Danh Kiếm Pháp', type: 'Tấn công sơ cấp', desc: 'Kiếm chiêu vô danh, gây ATK × 1.2.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Thiên Kiếm Chi Khí', type: 'Bị động', desc: 'Tăng 20% Nội Lực và 10% Hồi Nội Lực.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'manasteal', value: 10 } },
                    { level: 20, name: 'Bi Thống Mơ Hồ', type: 'Tấn công', desc: 'Kiếm ý bi thương, gây ATK × 2.2, làm chậm đối thủ 30%.', 
                      chance: 35, multiplier: 2.2, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.3, duration: 5 }, manaCost: 20 },
                    { level: 30, name: 'Vô Thượng Kiếm Đạo', type: 'Buff', desc: 'Tăng 30% Công Kích và 30% Chính Xác trong 15s.', 
                      chance: 25, effect: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, effect2: { type: 'buff', stat: 'accuracy_p', value: 30, duration: 15 }, manaCost: 25 },
                    { level: 50, name: 'Nhất Kiếm Thành Danh', type: 'Tấn công bạo kích', desc: 'Gây ATK × 3.0, +40% Tỉ Lệ Chí Mạng.', 
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.2, bonusCrit: 40, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Vạn Kiếm Quy Tông', type: 'Tấn công AoE', desc: 'Trấn phái. Hàng vạn thanh kiếm tuân lệnh, gây ATK × 4.5 diện rộng, hút 20% sát thương thành HP.', 
                      chance: 20, multiplier: 4.5, hits: 1, ignoreDef: 0.3, effect: { type: 'buff', stat: 'lifesteal', value: 20, duration: 5 }, manaCost: 70 },
                    { level: 80, name: 'Tàn Huyết Kiếm', type: 'Bị động', desc: 'Khi máu thấp, tăng 50% DEF (mô phỏng tăng thẳng 20% DEF).', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 120, name: 'Cửu Thiên Kiếm Khí', type: 'Tấn công liên hoàn', desc: 'Bắn ra 9 đạo kiếm khí, mỗi đạo ATK × 0.6.', 
                      chance: 25, multiplier: 0.6, hits: 9, ignoreDef: 0.1, bonusCrit: 10, manaCost: 60 },
                    { level: 150, name: 'Thiên Kiếm', type: 'Buff Siêu Cấp', desc: 'Hóa thân thành Thiên Kiếm, tăng 50% Toàn bộ chỉ số trong 10s.', 
                      chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 10 }, effect2: { type: 'buff', stat: 'def', value: 0.5, duration: 10 }, effect3: { type: 'buff', stat: 'hp', value: 0.5, duration: 10 }, effect4: { type: 'buff', stat: 'spd', value: 0.5, duration: 10 }, manaCost: 100 },
                    { level: 180, name: 'Võ Lâm Thần Thoại', type: 'Bị động', desc: 'Tăng 30% HP, 30% Mana và 20% Hồi Phục.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 30 }, effect3: { type: 'passive_buff', stat: 'lifesteal', value: 20 } }
                ]
            },
            // [NEW] 14. Hiệp Khách Đảo (Ẩn Thế)
            'hiep_khach': {
                name: 'Hiệp Khách Đảo',
                icon: 'fa-solid fa-mask',
                className: 'text-green-300 text-shadow-cyan', // [NEW] Style
                desc: 'Hòn đảo bí ẩn nơi các cao thủ võ lâm một đi không trở lại. Sở hữu Thái Huyền Kinh vô địch thiên hạ.',
                skills: [
                    { level: 1, name: 'Ngũ Nhạc Đảo Viinh', type: 'Tấn công sơ cấp', desc: 'Quyền chưởng nặng như núi, gây ATK × 1.3.', 
                      chance: 0, multiplier: 1.3, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Triệu Khách Man Hồ Anh', type: 'Bị động', desc: 'Tăng 20% Công Kích và 10% Tốc Độ Đánh.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 10 } },
                    { level: 20, name: 'Ngô Câu Sương Tuyết Minh', type: 'Tấn công bạo kích', desc: 'Kiếm khí lạnh lẽo, gây ATK × 2.0, +25% Chí Mạng.', 
                      chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0, bonusCrit: 25, manaCost: 15 },
                    { level: 30, name: 'Ngân Yên Chiếu Bạch Mã', type: 'Buff', desc: 'Tăng 40% Tốc Độ Đánh và 20% Né Tránh trong 15s.', 
                      chance: 25, effect: { type: 'buff', stat: 'spd', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 20, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Tạp Đạp Như Lưu Tinh', type: 'Tấn công liên hoàn', desc: 'Thân pháp như sao băng, đánh 3 lần, mỗi lần ATK × 1.0.', 
                      chance: 30, multiplier: 1.0, hits: 3, ignoreDef: 0.1, bonusCrit: 5, manaCost: 35 },
                    // Trấn phái
                    { level: 60, name: 'Thập Bộ Sát Nhất Nhân', type: 'Tấn công tất sát', desc: 'Trấn phái. Mười bước giết một người. Gây ATK × 4.5, 100% Chí Mạng, Bỏ qua 30% DEF.', 
                      chance: 20, multiplier: 4.5, hits: 1, ignoreDef: 0.3, bonusCrit: 100, manaCost: 60 },
                    { level: 80, name: 'Thiên Lý Bất Lưu Hành', type: 'Bị động', desc: 'Tăng 30% Tốc Độ và 20% Bỏ qua Phòng Ngự.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } },
                    { level: 120, name: 'Cứu Triệu Lăng Hư', type: 'Buff Hồi Phục', desc: 'Hồi phục 30% HP và 30% Mana ngay lập tức (mô phỏng hồi cực mạnh).', 
                      chance: 15, effect: { type: 'buff', stat: 'lifesteal', value: 100, duration: 2 }, manaCost: 50 },
                    { level: 150, name: 'Bạch Thủ Thái Huyền Kinh', type: 'Tấn công siêu cấp', desc: 'Võ công trên vách đá, uy lực chấn động trời đất. Gây ATK × 6.0 diện rộng.', 
                      chance: 25, multiplier: 6.0, hits: 1, ignoreDef: 0.4, bonusCrit: 30, manaCost: 90 },
                    { level: 180, name: 'Thâm Tàng Thân Dữ Danh', type: 'Bị động', desc: 'Ẩn giấu tài năng. Tăng 30% Tất cả chỉ số.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 30 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 30 } }
                ]
            },
            // [NEW] 15. Ác Nhân Cốc (Ẩn Thế)
            'ac_nhan': {
                name: 'Ác Nhân Cốc',
                icon: 'fa-solid fa-face-angry',
                className: 'text-red-400 text-shadow-purple', // [NEW] Style
                desc: 'Nơi cư ngụ của Thập Đại Ác Nhân. Võ công tàn độc, quỷ kế đa đoan, không từ thủ đoạn.',
                skills: [
                    { level: 1, name: 'Huyết Thủ', type: 'Tấn công sơ cấp', desc: 'Đòn tay đẫm máu, gây ATK × 1.1, hút 5% HP.', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'lifesteal', value: 5, duration: 3 } },
                    { level: 10, name: 'Tiếu Lý Tàng Đao', type: 'Bị động', desc: 'Tăng 20% Sát Thương Chí Mạng và 10% Né Tránh.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 20 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 10 } },
                    { level: 20, name: 'Độc Hạt Vĩ', type: 'Tấn công độc', desc: 'Đuôi bọ cạp độc, gây ATK × 1.8, giảm 20% DEF địch.', 
                      chance: 35, multiplier: 1.8, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'def', value: -0.2, duration: 10 }, manaCost: 15 },
                    { level: 30, name: 'Bất Nam Bất Nữ', type: 'Buff quỷ dị', desc: 'Tăng 30% Né Tránh và 30% Phản Đòn (chưa hỗ trợ) trong 15s.', 
                      chance: 20, effect: { type: 'buff', stat: 'dodgeChance', value: 30, duration: 15 }, manaCost: 20 },
                    { level: 50, name: 'Âm Hồn Bất Tán', type: 'Debuff', desc: 'Ám ảnh kẻ thù, giảm 30% Chính Xác và 30% Công Kích của địch.', 
                      chance: 25, effect: { type: 'debuff', stat: 'accuracy_p', value: -30, duration: 15 }, effect2: { type: 'debuff', stat: 'atk', value: -0.3, duration: 15 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Thập Ác Bất Xá', type: 'Tấn công liên hoàn', desc: 'Trấn phái. Mười chiêu tàn độc, đánh 10 lần, mỗi lần ATK × 0.4, gây chảy máu.', 
                      chance: 30, multiplier: 0.4, hits: 10, ignoreDef: 0.2, bonusCrit: 10, manaCost: 50 },
                    { level: 80, name: 'Tuyệt Đại Song Kiêu', type: 'Bị động', desc: 'Tăng 20% Công Kích và 20% Tốc Độ Đánh.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 20 } },
                    { level: 120, name: 'Ngũ Độc Đồng Tâm', type: 'Tấn công AoE', desc: 'Phát tán kịch độc, gây ATK × 3.5 diện rộng, giảm tốc 40%.', 
                      chance: 25, multiplier: 3.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.4, duration: 10 }, manaCost: 60 },
                    { level: 150, name: 'Di Hoa Tiếp Mộc (Phiên bản Ác)', type: 'Phản kích', desc: 'Hút 50% HP và Mana từ sát thương gây ra trong 10s.', 
                      chance: 15, effect: { type: 'buff', stat: 'lifesteal', value: 50, duration: 10 }, effect2: { type: 'buff', stat: 'manasteal', value: 50, duration: 10 }, manaCost: 80 },
                    { level: 180, name: 'Ma Đầu Chi Vương', type: 'Bị động', desc: 'Tăng 30% Bỏ qua Phòng Ngự và 30% Kháng Bạo Kích.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'ignoreDef_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'anti_crit_p', value: 30 } }
                ]
            },
            // [NEW] 16. Tuyệt Tình Cốc (Ẩn Thế)
            'tuyet_tinh': {
                name: 'Tuyệt Tình Cốc',
                icon: 'fa-solid fa-plant-wilt',
                className: 'text-emerald-400 text-shadow-green', // [NEW] Style
                desc: 'Thung lũng biệt lập, nơi trồng loài hoa Tình Hoa độc địa. Võ công sử dụng ngư lưới trận và đao kiếm hợp bích.',
                skills: [
                    { level: 1, name: 'Tình Hoa Thích', type: 'Tấn công sơ cấp', desc: 'Gai tình hoa đâm, gây ATK × 1.1, gây độc nhẹ (DoT mô phỏng).', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Bế Huyệt Công', type: 'Bị động', desc: 'Tăng 20% Phòng Thủ và 10% Kháng Hiệu Ứng (đóng huyệt đạo).', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 20, name: 'Ngư Lưới Trận', type: 'Khống chế', desc: 'Quăng lưới kim cương, gây ATK × 1.5, trói chân địch (giảm tốc 50%).', 
                      chance: 30, multiplier: 1.5, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 20 },
                    { level: 30, name: 'Âm Dương Đảo Loạn', type: 'Buff', desc: 'Đao kiếm rối loạn, tăng 30% Né Tránh và 20% Phản Đòn trong 15s.', 
                      chance: 25, effect: { type: 'buff', stat: 'dodgeChance', value: 30, duration: 15 }, manaCost: 25 },
                    { level: 50, name: 'Tuyệt Tình Đan', type: 'Hồi phục/Buff', desc: 'Uống thuốc giải, hồi 20% HP và tăng 20% ATK.', 
                      chance: 20, effect: { type: 'buff', stat: 'lifesteal', value: 50, duration: 2 }, effect2: { type: 'buff', stat: 'atk', value: 0.2, duration: 10 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Âm Dương Nhẫn Pháp', type: 'Tấn công hỗn loạn', desc: 'Trấn phái. Đao kiếm cùng xuất, chiêu thức quái dị. Gây ATK × 3.5, 50% Chí Mạng.', 
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 50 },
                    { level: 80, name: 'Tình Hoa Độc', type: 'Bị động', desc: 'Đòn đánh thường có 30% làm giảm 20% ATK của địch (Trúng độc).', 
                      passive: true, manaCost: 0 }, // Logic cần thêm trong playerTurn hoặc dùng debuff effect
                    { level: 120, name: 'Cầu Thiên Xích', type: 'Tấn công', desc: 'Phun hạt táo/sắt cực mạnh, gây ATK × 4.0 tầm xa, bỏ qua 40% DEF.', 
                      chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.4, bonusCrit: 20, manaCost: 60 },
                    { level: 150, name: 'Công Tôn Kiếm Vũ', type: 'Tấn công liên hoàn', desc: 'Kiếm múa như rồng bay, đánh 6 lần, mỗi lần ATK × 0.8.', 
                      chance: 35, multiplier: 0.8, hits: 6, ignoreDef: 0.1, bonusCrit: 30, manaCost: 80 },
                    { level: 180, name: 'Vô Tình', type: 'Bị động', desc: 'Đoạn tuyệt tình ái. Tăng 30% Công Kích và 30% Kháng Bạo Kích.', 
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'anti_crit_p', value: 30 } }
                ]
            },
            // [NEW] 17. Tạc Thiên Bang (Tối Cường Phản Sáo Lộ)
            'tac_thien': {
                name: 'Tạc Thiên Bang',
                icon: 'fa-solid fa-bomb',
                className: 'text-yellow-400 text-shadow-red font-black', // [NEW] Style
                desc: 'Bang phái của "Bức Vương" Từ Khuyết. Khẩu hiệu: "Tạc Thiên Bang xuất chinh, thốn thảo bất sinh". Chuyên về bạo kích và những chiêu thức hủy diệt.',
                skills: [
                    { level: 1, name: 'Kháo Sơn Quyền', type: 'Tấn công sơ cấp', desc: 'Một quyền đánh bay núi, gây ATK × 1.2, +10% Chí Mạng.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 10, manaCost: 0 },
                    { level: 10, name: 'Bức Vương Chi Khí', type: 'Bị động', desc: 'Tăng 20% May Mắn và 15% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'lck_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 15 } },
                    { level: 20, name: 'Tam Thiên Lôi Động', type: 'Buff Tốc Độ', desc: 'Thân pháp như sấm sét, tăng 50% Tốc Độ Đánh trong 10s.',
                      chance: 30, effect: { type: 'buff', stat: 'spd', value: 0.5, duration: 10 }, manaCost: 15 },
                    { level: 30, name: 'Huyền Trọng Xích', type: 'Tấn công diện rộng', desc: 'Dùng thước sắt khổng lồ đập xuống, gây ATK × 2.0 cho 3 mục tiêu (3 hits).',
                      chance: 40, multiplier: 2.0, hits: 3, ignoreDef: 0.1, bonusCrit: 10, manaCost: 25 },
                    { level: 50, name: 'Cửu Bí: Giai Tự Bí', type: 'Buff Siêu Cấp', desc: 'Tăng gấp 10 lần chỉ số (mô phỏng tăng 100% ATK và 100% SPD) trong 5s.',
                      chance: 10, effect: { type: 'buff', stat: 'atk', value: 1.0, duration: 5 }, effect2: { type: 'buff', stat: 'spd', value: 1.0, duration: 5 }, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Phật Nộ Hỏa Liên', type: 'Tấn công hủy diệt', desc: 'Trấn phái. Dung hợp dị hỏa, gây nổ lớn. Gây ATK × 5.0, 100% Bỏ qua DEF.',
                      chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 30, manaCost: 80 },
                    { level: 80, name: 'Bất Tử Chi Thân', type: 'Bị động', desc: 'Tăng 30% HP và 20% Hồi Phục (Hệ thống phục sinh).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 20 } },
                    { level: 120, name: 'Tịch Diệt Phục Ma Liên', type: 'Tấn công siêu cấp', desc: 'Phiên bản nâng cấp của Hỏa Liên, gây ATK × 7.0 diện rộng.',
                      chance: 15, multiplier: 7.0, hits: 1, ignoreDef: 0.5, bonusCrit: 50, manaCost: 100 },
                    { level: 150, name: 'Triệu Hồi Tạc Thiên', type: 'Buff Hội Đồng', desc: 'Triệu hồi hàng vạn bang chúng (mô phỏng tăng 50% tất cả chỉ số) trong 15s.',
                      chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, effect3: { type: 'buff', stat: 'spd', value: 0.5, duration: 15 }, manaCost: 120 },
                    { level: 180, name: 'Vạn Vật Giai Khả Tạc', type: 'Bị động', desc: 'Mọi thứ đều có thể nổ. Tăng 40% Sát Thương Chí Mạng và 40% Bỏ qua Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 40 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 40 } }
                ]
            },
            // [NEW] 18. Hoàng Phong Cốc (Phàm Nhân Tu Tiên)
            'hoang_phong': {
                name: 'Hoàng Phong Cốc',
                icon: 'fa-solid fa-wind',
                className: 'text-yellow-200 text-shadow-white', // [NEW] Style
                desc: 'Môn phái tu tiên tại Việt Quốc, nơi Hàn Lập ("Hàn Chạy Trốn") gia nhập. Chú trọng thực dụng, đan dược và bảo mệnh.',
                skills: [
                    { level: 1, name: 'Hỏa Cầu Thuật', type: 'Tấn công phép', desc: 'Phóng cầu lửa, gây ATK × 1.1, tầm xa.', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Trường Xuân Công', type: 'Bị động', desc: 'Tăng 20% HP và 20% Nội Lực (Tuổi thọ dài lâu).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 20 } },
                    { level: 20, name: 'La Yên Bộ', type: 'Buff Tốc Độ', desc: 'Thân pháp quỷ mị, tăng 30% Né Tránh và 20% Tốc Độ Đánh trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'dodgeChance', value: 30, duration: 15 }, effect2: { type: 'buff', stat: 'spd', value: 0.2, duration: 15 }, manaCost: 15 },
                    { level: 30, name: 'Định Hồn Phù', type: 'Khống chế', desc: 'Dán bùa định thân, gây ATK × 1.5, làm choáng (giảm tốc 70%) trong 5s.',
                      chance: 30, multiplier: 1.5, hits: 1, ignoreDef: 0, effect: { type: 'debuff', stat: 'spd', value: -0.7, duration: 5 }, manaCost: 20 },
                    { level: 50, name: 'Trúc Cơ Đan', type: 'Hồi phục', desc: 'Uống thuốc quý, hồi 30% HP và 30% Mana ngay lập tức (mô phỏng hồi cực mạnh).',
                      chance: 20, effect: { type: 'buff', stat: 'lifesteal', value: 200, duration: 1 }, manaCost: 30 },
                    // Trấn phái
                    { level: 60, name: 'Thanh Nguyên Kiếm Quyết', type: 'Tấn công liên hoàn', desc: 'Trấn phái. Kiếm quang phân hóa, đánh 5 lần, mỗi lần ATK × 0.8, bỏ qua 20% DEF.',
                      chance: 35, multiplier: 0.8, hits: 5, ignoreDef: 0.2, bonusCrit: 10, manaCost: 40 },
                    { level: 80, name: 'Tâm Tư Cẩn Mật', type: 'Bị động', desc: 'Tăng 20% Phòng Thủ và 20% Chính Xác (Tính toán kỹ lưỡng).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 20 } },
                    { level: 120, name: 'Đại Canh Kiếm Trận', type: 'Tấn công AoE', desc: 'Kiếm trận kim sắc, gây ATK × 4.0 diện rộng, sát thương cực lớn.',
                      chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.3, bonusCrit: 20, manaCost: 70 },
                    { level: 150, name: 'Thần Thông: Kinh Trập', type: 'Tấn công biến hình', desc: 'Hóa thân thành cự vượn/côn trùng (mô phỏng), tăng 50% ATK và 50% DEF trong 15s.',
                      chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, manaCost: 60 },
                    { level: 180, name: 'Chưởng Thiên Bình', type: 'Bị động', desc: 'Tăng 50% Tốc độ Tu Luyện (XP Boost) và 20% Tất cả chỉ số.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'xp_boost', value: 50 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 20 } }
                ]
            },
            // [NEW] 19. Tuyết Nguyệt Thành (Thiếu Niên Ca Hành)
            'tuyet_nguyet': {
                name: 'Tuyết Nguyệt Thành',
                icon: 'fa-solid fa-moon',
                className: 'text-pink-200 text-shadow-white', // [NEW] Style
                desc: 'Thành trì đệ nhất thiên hạ. Nơi hội tụ của phong hoa tuyết nguyệt, kiếm tiên và rượu ngon.',
                skills: [
                    { level: 1, name: 'Tuyết Nguyệt Kiếm', type: 'Tấn công sơ cấp', desc: 'Kiếm khí lạnh lẽo, gây ATK × 1.1, làm chậm 10%.', 
                      chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'debuff', stat: 'spd', value: -0.1, duration: 3 } },
                    { level: 10, name: 'Chỉ Thủy Kiếm Ý', type: 'Bị động', desc: 'Tâm như nước lặng. Tăng 15% Công Kích và 15% Chính Xác.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 15 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 15 } },
                    { level: 20, name: 'Mạnh Bà Thang', type: 'Buff/Debuff', desc: 'Một chén quên sầu. Hồi 20% HP nhưng giảm 10% Chính Xác địch (say rượu).',
                      chance: 30, effect: { type: 'buff', stat: 'lifesteal', value: 20, duration: 2 }, effect2: { type: 'debuff', stat: 'accuracy_p', value: -10, duration: 10 }, manaCost: 20 },
                    { level: 30, name: 'Nguyệt Tịch Hoa Sáng', type: 'Tấn công AoE', desc: 'Kiếm chiêu đẹp nhất thế gian. Gây ATK × 2.5 diện rộng, mê hoặc địch.',
                      chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.1, bonusCrit: 10, manaCost: 30 },
                    { level: 50, name: 'Tửu Tiên Quyết', type: 'Buff', desc: 'Uống rượu tăng sức mạnh. Tăng 40% Công Kích và 30% Né Tránh trong 20s.',
                      chance: 20, effect: { type: 'buff', stat: 'atk', value: 0.4, duration: 20 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 30, duration: 20 }, manaCost: 25 },
                    // Trấn phái
                    { level: 60, name: 'Thiết Mã Băng Hà', type: 'Tấn công băng giá', desc: 'Trấn phái. Dòng sông băng sắt thép. Gây ATK × 4.0, đóng băng (giảm tốc 60%) và bỏ qua 30% DEF.',
                      chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.3, effect: { type: 'debuff', stat: 'spd', value: -0.6, duration: 5 }, manaCost: 60 },
                    { level: 80, name: 'Đa Tình Kiếm Khách', type: 'Bị động', desc: 'Tăng 20% Tỉ Lệ Chí Mạng và 20% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critChance', value: 20 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 20 } },
                    { level: 120, name: 'Nhất Kiếm Nhập Tiên', type: 'Tấn công siêu cấp', desc: 'Một kiếm hóa tiên. Gây ATK × 5.5, 100% Trúng Đích, 50% Chí Mạng.',
                      chance: 20, multiplier: 5.5, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 80 },
                    { level: 150, name: 'Tây Sở Bá Vương Thương', type: 'Tấn công bạo kích', desc: 'Thương pháp bá đạo (từ Thương Tiên). Gây ATK × 6.0, phá giáp 50%.',
                      chance: 25, multiplier: 6.0, hits: 1, ignoreDef: 0.5, bonusCrit: 20, manaCost: 90 },
                    { level: 180, name: 'Phong Hoa Tuyết Nguyệt', type: 'Bị động', desc: 'Tăng 30% Toàn bộ chỉ số.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 30 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 30 } }
                ]
            },
            // [NEW] 20. Luyện Hồn Tông (Tiên Nghịch)
            'luyen_hon': {
                name: 'Luyện Hồn Tông',
                icon: 'fa-solid fa-flag-black',
                className: 'text-purple-900 text-shadow-red', // [NEW] Style
                desc: 'Tông môn tà đạo Triệu Quốc, nơi Vương Lâm bắt đầu con đường tu ma. Sở hữu Cực Cảnh Thần Thức, Cấm Chế và Cổ Thần Chi Lực.',
                skills: [
                    { level: 1, name: 'Dẫn Lực Thuật', type: 'Tấn công sơ cấp', desc: 'Điều khiển vật thể tấn công, gây ATK × 1.2, tầm xa.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Cực Cảnh Thần Thức', type: 'Bị động', desc: 'Thần thức bá đạo, tăng 30% Tỉ Lệ Chí Mạng và 30% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critChance', value: 30 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 30 } },
                    { level: 20, name: 'Tử Chú Thuật', type: 'Debuff', desc: 'Nguyền rủa kẻ thù, giảm 30% DEF và gây sát thương theo thời gian (mô phỏng hit nhỏ).',
                      chance: 30, multiplier: 0.5, hits: 3, effect: { type: 'debuff', stat: 'def', value: -0.3, duration: 10 }, manaCost: 20 },
                    { level: 30, name: 'Cấm Chế Bản Nguyên', type: 'Khống chế', desc: 'Phong ấn kẻ thù, gây ATK × 2.0 và làm choáng (giảm tốc 80%) trong 5s.',
                      chance: 25, multiplier: 2.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.8, duration: 5 }, manaCost: 30 },
                    { level: 50, name: 'Hoàng Tuyền Chỉ', type: 'Tấn công tử vong', desc: 'Một chỉ đoạn sinh tử. Gây ATK × 3.5, hút 10% sinh lực.',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.3, effect: { type: 'buff', stat: 'lifesteal', value: 10, duration: 3 }, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Cổ Thần Biến', type: 'Buff Biến Hình', desc: 'Trấn phái. Hóa thân Cổ Thần khổng lồ. Tăng 100% HP, 50% DEF, 50% ATK trong 20s.',
                      chance: 15, effect: { type: 'buff', stat: 'hp', value: 1.0, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.5, duration: 20 }, effect3: { type: 'buff', stat: 'atk', value: 0.5, duration: 20 }, manaCost: 80 },
                    { level: 80, name: 'Sát Lục Chi Khí', type: 'Bị động', desc: 'Tăng 30% Công Kích và 20% Bỏ qua Phòng Ngự.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } },
                    { level: 120, name: 'Hư Vô Chi Hỏa', type: 'Tấn công xuyên thấu', desc: 'Thiêu đốt linh hồn, gây ATK × 5.0, 100% Bỏ qua DEF.',
                      chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 20, manaCost: 70 },
                    { level: 150, name: 'Mộng Đạo', type: 'Buff Hồi Sinh', desc: 'Trong mộng ngàn năm. Hồi phục 100% HP và Mana ngay lập tức.',
                      chance: 10, effect: { type: 'buff', stat: 'lifesteal', value: 500, duration: 2 }, effect2: { type: 'buff', stat: 'manasteal', value: 500, duration: 2 }, manaCost: 100 },
                    { level: 180, name: 'Nghịch Thiên Cải Mệnh', type: 'Bị động', desc: 'Tăng 40% Tất cả chỉ số.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 40 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 40 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 40 } }
                ]
            },
            // [NEW] 21. Bổ Thiên Các (Thế Giới Hoàn Mỹ)
            'bo_thien': {
                name: 'Bổ Thiên Các',
                icon: 'fa-solid fa-tree',
                className: 'text-green-500 text-shadow-gold', // [NEW] Style
                desc: 'Tịnh thổ thượng cổ, nơi Hoang Thiên Đế từng tu hành. Chuyên tu luyện thân thể, sử dụng Bảo Thuật hung thú trấn áp vạn cổ.',
                skills: [
                    { level: 1, name: 'Toan Nghê Bảo Thuật', type: 'Tấn công sơ cấp', desc: 'Sấm sét bao phủ, gây ATK × 1.2 diện rộng (AoE nhẹ).', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Động Thiên Phúc Địa', type: 'Bị động', desc: 'Mở ra Động Thiên, tăng 30% HP và 30% Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 30 } },
                    { level: 20, name: 'Chu Tước Tứ Kích', type: 'Tấn công liên hoàn', desc: 'Cánh chim lửa chém xuống, đánh 4 lần, mỗi lần ATK × 0.8.',
                      chance: 40, multiplier: 0.8, hits: 4, ignoreDef: 0.1, bonusCrit: 10, manaCost: 20 },
                    { level: 30, name: 'Thanh Lân Ưng Bảo Thuật', type: 'Buff', desc: 'Tăng 50% Phòng Thủ và 20% Phản Đòn trong 15s.',
                      chance: 25, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, manaCost: 25 },
                    { level: 50, name: 'Chí Tôn Cốt: Thượng Thương Chi Thủ', type: 'Tấn công áp chế', desc: 'Bàn tay trời cao ấn xuống, gây ATK × 3.0, làm chậm 50%.',
                      chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Côn Bằng Pháp', type: 'Buff Tốc Độ', desc: 'Trấn phái. Âm Dương nhị khí, hóa thân Côn Bằng. Tăng 100% Tốc Độ Đánh và 50% Né Tránh trong 10s.',
                      chance: 20, effect: { type: 'buff', stat: 'spd', value: 1.0, duration: 10 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 50, duration: 10 }, manaCost: 60 },
                    { level: 80, name: 'Bất Diệt Kinh', type: 'Bị động', desc: 'Tăng 40% HP và hồi phục 5% HP mỗi lượt (mô phỏng Hút Máu 10%).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 10 } },
                    { level: 120, name: 'Thảo Tự Kiếm Quyết', type: 'Tấn công AoE', desc: 'Một ngọn cỏ chém rụng trăng sao. Gây ATK × 5.0 diện rộng, 100% Bỏ qua DEF.',
                      chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 20, manaCost: 80 },
                    { level: 150, name: 'Luân Hồi Quyền', type: 'Tấn công bạo kích', desc: 'Lục đạo luân hồi trong nắm tay. Gây ATK × 6.0, 100% Chí Mạng.',
                      chance: 15, multiplier: 6.0, hits: 1, ignoreDef: 0.3, bonusCrit: 100, manaCost: 90 },
                    { level: 180, name: 'Độc Đoạn Vạn Cổ', type: 'Bị động', desc: 'Một mình trấn áp vạn cổ. Tăng 50% Công Kích và 50% HP.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 50 } }
                ]
            },
            // [NEW] 22. Cực Hạn Võ Quán (Thôn Phệ Tinh Không)
            'cuc_han': {
                name: 'Cực Hạn Võ Quán',
                icon: 'fa-solid fa-star',
                className: 'text-slate-300 text-shadow-blue', // [NEW] Style
                desc: 'Tổ chức của đệ nhất cường giả La Phong. Kết hợp võ đạo, công nghệ và tinh thần niệm lực. Tốc độ siêu thanh, phòng thủ bất hoại.',
                skills: [
                    { level: 1, name: 'Cửu Trọng Lôi Đao', type: 'Tấn công liên hoàn', desc: 'Đao thế như sấm, đánh 2 lần, mỗi lần ATK × 0.8, tăng 20% Tốc độ.', 
                      chance: 0, multiplier: 0.8, hits: 2, ignoreDef: 0, bonusCrit: 5, manaCost: 0, effect: { type: 'buff', stat: 'spd', value: 0.2, duration: 3 } },
                    { level: 10, name: 'Tinh Thần Niệm Sư', type: 'Bị động', desc: 'Tăng 20% Chính Xác và 20% Nội Lực.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'accuracy_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 20 } },
                    { level: 20, name: 'Độn Thiên Thoi', type: 'Tấn công tầm xa', desc: 'Binh khí niệm lực, gây ATK × 2.2, 100% Trúng Đích (Bỏ qua né tránh).',
                      chance: 35, multiplier: 2.2, hits: 1, ignoreDef: 0.1, bonusCrit: 10, manaCost: 15 },
                    { level: 30, name: 'Hắc Thần Bộ', type: 'Buff', desc: 'Bộ giáp sinh học, tăng 100% Phòng Thủ trong 10s.',
                      chance: 20, effect: { type: 'buff', stat: 'def', value: 1.0, duration: 10 }, manaCost: 30 },
                    { level: 50, name: 'Diễn Thần Binh: Thích', type: 'Tấn công xuyên thấu', desc: 'Tụ hợp 9 lưỡi dao vàng, gây ATK × 3.5, bỏ qua 40% DEF.',
                      chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.4, bonusCrit: 20, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Kim Giác Cự Thú', type: 'Buff Biến Hình', desc: 'Trấn phái. Hóa thân tinh không cự thú. Tăng 200% HP, 50% ATK, 50% DEF trong 20s.',
                      chance: 10, effect: { type: 'buff', stat: 'hp', value: 2.0, duration: 20 }, effect2: { type: 'buff', stat: 'atk', value: 0.5, duration: 20 }, effect3: { type: 'buff', stat: 'def', value: 0.5, duration: 20 }, manaCost: 100 },
                    { level: 80, name: 'Bản Tôn Thiên Địa', type: 'Bị động', desc: 'Phân thân tu luyện (mô phỏng tăng 30% XP và 20% All Stats).',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'xp_boost', value: 30 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 20 } },
                    { level: 120, name: 'Thí Ngô Vũ Dực', type: 'Buff Tốc Độ', desc: 'Cánh chim bạc, tăng 100% Tốc Độ Đánh và 50% Né Tránh trong 10s.',
                      chance: 20, effect: { type: 'buff', stat: 'spd', value: 1.0, duration: 10 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 50, duration: 10 }, manaCost: 60 },
                    { level: 150, name: 'Tinh Thần Tháp', type: 'Tấn công linh hồn', desc: 'Trấn áp linh hồn, gây ATK × 5.0, làm choáng tuyệt đối (giảm tốc 100%).',
                      chance: 15, multiplier: 5.0, hits: 1, ignoreDef: 0.5, effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 5 }, manaCost: 80 },
                    { level: 180, name: 'Vũ Trụ Chi Chủ', type: 'Bị động', desc: 'Làm chủ quy tắc. Tăng 40% Bỏ qua Phòng Thủ và 40% Sát Thương Chí Mạng.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'ignoreDef_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 40 } }
                ]
            },
            // [NEW] 23. Vu Tộc (Hồng Hoang)
            'vu_toc': {
                name: 'Vu Tộc',
                icon: 'fa-solid fa-dumbbell',
                className: 'text-stone-400 text-shadow-red', // [NEW] Style
                desc: 'Hậu duệ của Bàn Cổ Đại Thần. Không tu nguyên thần, chỉ tu nhục thân, lấy sức mạnh cơ bắp chứng đạo. Chiến thần bất tử của trời đất.',
                skills: [
                    { level: 1, name: 'Bàn Cổ Quyền', type: 'Tấn công sơ cấp', desc: 'Nắm đấm khai thiên, gây ATK × 1.2. Tăng 10% HP trong 5s.', 
                      chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'hp', value: 0.1, duration: 5 } },
                    { level: 10, name: 'Cửu Chuyển Huyền Công', type: 'Bị động', desc: 'Thân thể kim cương. Tăng 40% HP và 20% Phòng Thủ.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 20, name: 'Khoa Phụ Trục Nhật', type: 'Buff Tốc Độ', desc: 'Bước chân vượt mặt trời. Tăng 50% Tốc Độ Đánh trong 10s.',
                      chance: 30, effect: { type: 'buff', stat: 'spd', value: 0.5, duration: 10 }, manaCost: 0 }, // Vu Tộc không tốn mana
                    { level: 30, name: 'Hậu Nghệ Xạ Nhật', type: 'Tấn công bạo kích', desc: 'Mũi tên rụng mặt trời. Gây ATK × 3.0, 100% Trúng Đích, 30% Chí Mạng.',
                      chance: 35, multiplier: 3.0, hits: 1, ignoreDef: 0.1, bonusCrit: 30, manaCost: 0 },
                    { level: 50, name: 'Cộng Công Nộ', type: 'Tấn công AoE', desc: 'Đầu húc Bất Chu Sơn. Gây ATK × 2.5 diện rộng, gây choáng (giảm tốc 80%).',
                      chance: 25, multiplier: 2.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.8, duration: 5 }, manaCost: 0 },
                    // Trấn phái
                    { level: 60, name: 'Đô Thiên Thần Sát', type: 'Triệu hồi', desc: 'Trấn phái. Triệu hồi hư ảnh Bàn Cổ. Tăng 100% ATK, 100% DEF trong 20s.',
                      chance: 15, effect: { type: 'buff', stat: 'atk', value: 1.0, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 1.0, duration: 20 }, manaCost: 0 },
                    { level: 80, name: 'Tổ Vu Chi Huyết', type: 'Bị động', desc: 'Hồi phục siêu cấp. Tăng 50% Hồi Máu (Lifesteal) và 50% HP.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'lifesteal', value: 50 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 50 } },
                    { level: 120, name: 'Hình Thiên Vũ Can Thích', type: 'Tấn công bất tử', desc: 'Chiến ý bất diệt. Gây ATK × 5.0. Nếu HP < 30%, sát thương x2 (chưa hỗ trợ logic HP).',
                      chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 0.3, bonusCrit: 50, manaCost: 0 },
                    { level: 150, name: 'Thời Không Chi Chúc', type: 'Buff', desc: 'Sức mạnh Chúc Cửu Âm. Tăng 100% Tốc Độ và Né Tránh trong 15s.',
                      chance: 10, effect: { type: 'buff', stat: 'spd', value: 1.0, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 100, duration: 15 }, manaCost: 0 },
                    { level: 180, name: 'Nhục Thân Thành Thánh', type: 'Bị động', desc: 'Thân thể là vũ khí mạnh nhất. Tăng 100% HP và 50% DEF.',
                      passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 100 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 50 } }
                ]
            },
            // [NEW] 24. Yêu Tộc (Cổ Thiên Đình)
            'yeu_toc': {
                name: 'Yêu Tộc Cổ Thiên Đình',
                icon: 'fa-solid fa-crow',
                className: 'text-orange-300 text-shadow-gold', // [NEW] Style
                desc: 'Thống lĩnh thiên địa thời thượng cổ. Đế Tuấn và Đông Hoàng Thái Nhất lập nên Thiên Đình, chưởng quản tinh tú và thái dương.',
                skills: [
                    { level: 1, name: 'Thái Dương Chân Hỏa', type: 'Tấn công sơ cấp', desc: 'Lửa mặt trời thiêu đốt, gây ATK × 1.3, bỏ qua 10% DEF.', chance: 0, multiplier: 1.3, hits: 1, ignoreDef: 0.1, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Kim Ô Hóa Hồng', type: 'Bị động', desc: 'Tốc độ ánh sáng. Tăng 30% Tốc Độ Đánh và 20% Né Tránh.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 20 } },
                    { level: 20, name: 'Hà Đồ Lạc Thư', type: 'Buff', desc: 'Tiên thiên linh bảo hộ thể. Tăng 50% Phòng Thủ và 30% Kháng Hiệu Ứng trong 15s.', chance: 25, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, manaCost: 25 },
                    { level: 30, name: 'Yêu Sư Côn Bằng', type: 'Tấn công liên hoàn', desc: 'Thân pháp cực nhanh, đánh 5 lần, mỗi lần ATK × 0.7.', chance: 35, multiplier: 0.7, hits: 5, ignoreDef: 0.1, bonusCrit: 10, manaCost: 35 },
                    { level: 50, name: 'Đông Hoàng Chung', type: 'Tấn công khống chế', desc: 'Tiếng chuông trấn áp hồng mông. Gây ATK × 3.5, choáng địch (giảm tốc 90%) trong 5s.', chance: 20, multiplier: 3.5, hits: 1, ignoreDef: 0.3, effect: { type: 'debuff', stat: 'spd', value: -0.9, duration: 5 }, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Chu Thiên Tinh Đấu Trận', type: 'Tấn công AoE', desc: 'Trấn phái. Triệu hồi sức mạnh 365 ngôi sao. Gây ATK × 6.0 diện rộng, 100% Trúng Đích.', chance: 15, multiplier: 6.0, hits: 1, ignoreDef: 0.4, bonusCrit: 30, manaCost: 100 },
                    { level: 80, name: 'Đế Vương Chi Khí', type: 'Bị động', desc: 'Tăng 30% Công Kích và 30% Chính Xác.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 30 } },
                    { level: 120, name: 'Nhật Nguyệt Tinh Thần', type: 'Buff Siêu Cấp', desc: 'Hấp thụ tinh hoa trời đất. Tăng 50% Toàn bộ chỉ số trong 15s.', chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, effect3: { type: 'buff', stat: 'hp', value: 0.5, duration: 15 }, effect4: { type: 'buff', stat: 'spd', value: 0.5, duration: 15 }, manaCost: 120 },
                    { level: 150, name: 'Thập Nhật Đồng Thiên', type: 'Tấn công hủy diệt', desc: 'Mười mặt trời cùng xuất hiện. Gây ATK × 8.0, thiêu rụi mọi thứ (Bỏ qua 60% DEF).', chance: 10, multiplier: 8.0, hits: 1, ignoreDef: 0.6, bonusCrit: 50, manaCost: 150 },
                    { level: 180, name: 'Thánh Nhân Chi Hạ Giai Vi Nghĩ', type: 'Bị động', desc: 'Dưới Thánh Nhân đều là kiến. Tăng 50% Sát Thương Chí Mạng và 40% Bỏ qua Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 50 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 40 } }
                ]
            },
            // [NEW] 25. Triệt Giáo (Phong Thần)
            'triet_giao': {
                name: 'Triệt Giáo',
                icon: 'fa-solid fa-xmarks-lines',
                className: 'text-indigo-300 text-shadow-cyan', // [NEW] Style
                desc: 'Đại giáo của Thông Thiên Giáo Chủ tại Bích Du Cung. Chủ trương "Hữu Giáo Vô Loại", vạn tiên lai triều. Sở hữu Tru Tiên Tứ Kiếm sát phạt đệ nhất.',
                skills: [
                    { level: 1, name: 'Thanh Bình Kiếm', type: 'Tấn công sơ cấp', desc: 'Kiếm khí tung hoành, gây ATK × 1.4, +10% Chí Mạng.', chance: 0, multiplier: 1.4, hits: 1, ignoreDef: 0.1, bonusCrit: 10, manaCost: 0 },
                    { level: 10, name: 'Thượng Thanh Tiên Pháp', type: 'Bị động', desc: 'Tăng 30% Nội Lực và 20% Công Kích.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 20 } },
                    { level: 20, name: 'Lục Hồn Phiên', type: 'Debuff', desc: 'Nguyền rủa linh hồn, giảm 50% DEF và 30% ATK của địch trong 10s.', chance: 30, effect: { type: 'debuff', stat: 'def', value: -0.5, duration: 10 }, effect2: { type: 'debuff', stat: 'atk', value: -0.3, duration: 10 }, manaCost: 30 },
                    { level: 30, name: 'Hỗn Nguyên Kim Đấu', type: 'Tấn công', desc: 'Cắt gọt tu vi (mô phỏng giảm cấp độ/chỉ số). Gây ATK × 3.0, giảm 40% Toàn bộ chỉ số địch.', chance: 25, multiplier: 3.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'atk', value: -0.4, duration: 10 }, manaCost: 40 },
                    { level: 50, name: 'Ngư Cổ Lôi', type: 'Tấn công bạo kích', desc: 'Sấm sét tím, gây ATK × 4.0, 50% Chí Mạng.', chance: 30, multiplier: 4.0, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Tru Tiên Kiếm Trận', type: 'Tấn công hủy diệt', desc: 'Trấn phái. Đệ nhất sát trận. Gây ATK × 6.0, 100% Bỏ qua DEF, 100% Chí Mạng.', chance: 15, multiplier: 6.0, hits: 1, ignoreDef: 1.0, bonusCrit: 100, manaCost: 150 },
                    { level: 80, name: 'Tiệt Thủ Nhất Tuyến', type: 'Bị động', desc: 'Tìm đường sống trong chỗ chết. Tăng 50% Né Tránh khi HP < 50%.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 50 } },
                    { level: 120, name: 'Vạn Tiên Trận', type: 'Buff Hội Đồng', desc: 'Triệu tập vạn tiên. Tăng 60% ATK, 60% DEF, 60% HP trong 20s.', chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.6, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.6, duration: 20 }, effect3: { type: 'buff', stat: 'hp', value: 0.6, duration: 20 }, manaCost: 200 },
                    { level: 150, name: 'Tử Điện Chùy', type: 'Tấn công siêu cấp', desc: 'Gây ATK × 7.0, tê liệt vĩnh viễn (mô phỏng giảm tốc 100% trong 5s).', chance: 20, multiplier: 7.0, hits: 1, ignoreDef: 0.5, effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 5 }, manaCost: 100 },
                    { level: 180, name: 'Hỗn Nguyên Đại La Kim Tiên', type: 'Bị động', desc: 'Bất sinh bất diệt. Tăng 100% Công Kích và 50% Tất cả chỉ số khác.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 100 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 50 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 50 } }
                ]
            },
            // [NEW] 26. Linh Khê Tông (Nhất Niệm Vĩnh Hằng)
            'linh_khe': {
                name: 'Linh Khê Tông',
                icon: 'fa-solid fa-shield-cat',
                className: 'text-teal-400 text-shadow-green', // [NEW] Style
                desc: 'Tông môn của Bạch Tiểu Thuần. Nổi tiếng với thuật Luyện Đan "nổ lò" và Quy Văn Nồi phòng thủ vô địch. Phong cách chiến đấu: Vừa đánh vừa chạy, lấy thủ làm công.',
                skills: [
                    { level: 1, name: 'Ngự Đỉnh Quyết', type: 'Tấn công sơ cấp', desc: 'Dùng đỉnh đập người, gây ATK × 1.1, tăng 10% DEF.', chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'def', value: 0.1, duration: 3 } },
                    { level: 10, name: 'Bất Tử Trường Sinh Công', type: 'Bị động', desc: 'Da dày thịt béo. Tăng 30% HP và 20% Hồi Phục.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 20 } },
                    { level: 20, name: 'Hám Sơn Chàng', type: 'Tấn công khống chế', desc: 'Dựa vai húc mạnh, gây ATK × 2.0, làm choáng (giảm tốc 60%).', chance: 30, multiplier: 2.0, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.6, duration: 5 }, manaCost: 20 },
                    { level: 30, name: 'Phát Tình Đan', type: 'Debuff Quỷ Dị', desc: 'Ném đan dược kỳ quái, giảm 40% Chính Xác và 30% DEF của địch.', chance: 25, effect: { type: 'debuff', stat: 'accuracy_p', value: -40, duration: 15 }, effect2: { type: 'debuff', stat: 'def', value: -0.3, duration: 15 }, manaCost: 25 },
                    { level: 50, name: 'Tử Khí Ngự Đỉnh', type: 'Tấn công phép', desc: 'Điều khiển đỉnh tím tấn công, gây ATK × 3.0, bỏ qua 30% DEF.', chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.3, bonusCrit: 10, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Quy Văn Nồi', type: 'Buff Bất Tử', desc: 'Trấn phái. Triệu hồi nồi đen hộ thể. Tăng 100% Phòng Thủ và Phản Đòn 50% (chưa hỗ trợ) trong 10s.', chance: 15, effect: { type: 'buff', stat: 'def', value: 1.0, duration: 10 }, manaCost: 60 },
                    { level: 80, name: 'Thảo Mộc Giai Binh', type: 'Bị động', desc: 'Tăng 30% Công Kích và 30% Nội Lực (Triệu hồi thực vật hỗ trợ - mô phỏng).', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 30 } },
                    { level: 120, name: 'Thủy Trạch Quốc Độ', type: 'Tấn công AoE', desc: 'Triệu hồi bản mệnh linh thú, gây ATK × 4.5 diện rộng, làm chậm 50%.', chance: 20, multiplier: 4.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 10 }, manaCost: 80 },
                    { level: 150, name: 'Bất Tử Cốt', type: 'Buff Hồi Phục', desc: 'Xương cốt kim cương. Hồi 50% HP và tăng 50% Kháng Hiệu Ứng trong 15s.', chance: 10, effect: { type: 'buff', stat: 'lifesteal', value: 200, duration: 3 }, manaCost: 100 },
                    { level: 180, name: 'Vĩnh Hằng Chi Niệm', type: 'Bị động', desc: 'Nhất niệm vĩnh hằng. Tăng 50% HP và 40% Tất cả chỉ số khác.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 40 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 40 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 40 } }
                ]
            },
            // [NEW] 27. Đạo Tông (Vũ Động Càn Khôn)
            'dao_tong': {
                name: 'Đạo Tông',
                icon: 'fa-solid fa-scroll',
                className: 'text-yellow-100 text-shadow-orange', // [NEW] Style
                desc: 'Một trong bát đại siêu cấp tông phái. Nơi Lâm Động tu luyện, sở hữu Đại Hoang Vu Kinh có khả năng thôn phệ sinh lực trời đất.',
                skills: [
                    { level: 1, name: 'Hoang Kình', type: 'Tấn công sơ cấp', desc: 'Kình lực hoang vu, gây ATK × 1.2, ăn mòn (Bỏ qua 10% DEF).', chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0.1, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Hoang Vu Quyết', type: 'Bị động', desc: 'Tăng 20% HP và 10% Hút Máu.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 10 } },
                    { level: 20, name: 'Đại Hoang Phân Hải Ấn', type: 'Tấn công', desc: 'Một ấn chia biển, gây ATK × 2.5, tăng 20% Sát Thương Chí Mạng.', chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'buff', stat: 'critDamage', value: 20, duration: 5 }, manaCost: 20 },
                    { level: 30, name: 'Ứng Huyền Tử', type: 'Buff', desc: 'Tăng 40% Nội Lực và 30% Công Kích trong 15s.', chance: 25, effect: { type: 'buff', stat: 'mana_p', value: 40, duration: 15 }, effect2: { type: 'buff', stat: 'atk', value: 0.3, duration: 15 }, manaCost: 30 },
                    { level: 50, name: 'Đại Hoang Tù Thiên Chỉ', type: 'Tấn công bạo kích', desc: 'Một chỉ tù thiên. Gây ATK × 4.0, 50% Chí Mạng. (Chiêu thức làm nên tên tuổi Lâm Động).', chance: 20, multiplier: 4.0, hits: 1, ignoreDef: 0.3, bonusCrit: 50, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Đại Hoang Vu Kinh', type: 'Tấn công hút máu AoE', desc: 'Trấn phái. Hóa mặt đất thành hoang vu. Gây ATK × 4.5 diện rộng, hút 30% Sinh Lực.', chance: 20, multiplier: 4.5, hits: 1, ignoreDef: 0.2, effect: { type: 'buff', stat: 'lifesteal', value: 30, duration: 5 }, manaCost: 80 },
                    { level: 80, name: 'Bát Tổ Phù (Mô Phỏng)', type: 'Bị động', desc: 'Sức mạnh của Tổ Phù. Tăng 20% Kháng Hiệu Ứng, 20% Tốc Độ, 20% Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 20 } },
                    { level: 120, name: 'Thanh Thiên Hóa Long Quyết', type: 'Buff Biến Hình', desc: 'Hóa thân Nhân Long. Tăng 60% ATK và 60% DEF trong 20s.', chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.6, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.6, duration: 20 }, manaCost: 100 },
                    { level: 150, name: 'Càn Khôn Cổ Trận', type: 'Tấn công khống chế', desc: 'Vây khốn kẻ địch, gây ATK × 6.0, cấm dùng kỹ năng (mô phỏng giảm ATK 50%).', chance: 15, multiplier: 6.0, hits: 1, ignoreDef: 0.4, effect: { type: 'debuff', stat: 'atk', value: -0.5, duration: 10 }, manaCost: 120 },
                    { level: 180, name: 'Võ Tổ Chi Uy', type: 'Bị động', desc: 'Uy áp Võ Tổ. Tăng 40% Bỏ qua Phòng Thủ và 40% Sát Thương Chí Mạng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'ignoreDef_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 40 } }
                ]
            },
            // [NEW] 28. Vạn Cổ Tông (Vạn Cổ Tối Cường Tông)
            'van_co': {
                name: 'Vạn Cổ Tông',
                icon: 'fa-solid fa-torii-gate',
                className: 'text-rainbow-animation', // [NEW] Style
                desc: 'Tông môn "lầy lội" nhất lịch sử do Quân Thường Tiếu dẫn dắt. Kết hợp võ học và vũ khí hiện đại (Súng, Pháo). Phong cách "lấy thịt đè người".',
                skills: [
                    { level: 1, name: 'Trảm Mã Đao', type: 'Tấn công sơ cấp', desc: 'Đao pháp cơ bản nhưng uy lực, gây ATK × 1.2.', chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Thiết Cốt Tranh Tranh', type: 'Bị động', desc: 'Đệ tử Vạn Cổ Tông mình đồng da sắt. Tăng 25% Phòng Thủ và 15% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 25 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 15 } },
                    { level: 20, name: 'Lăng Ba Vi Bộ (Fake)', type: 'Buff Tốc Độ', desc: 'Tốc độ chạy trốn cực nhanh. Tăng 40% Tốc Độ Đánh và 20% Né Tránh trong 10s.', chance: 30, effect: { type: 'buff', stat: 'spd', value: 0.4, duration: 10 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 20, duration: 10 }, manaCost: 15 },
                    { level: 30, name: 'Súng Bắn Tỉa AWM', type: 'Tấn công tầm xa', desc: 'Ám khí cơ giới, gây ATK × 3.0, 100% Bỏ qua Phòng Thủ (Sát thương chuẩn).', chance: 20, multiplier: 3.0, hits: 1, ignoreDef: 1.0, bonusCrit: 20, manaCost: 30 },
                    { level: 50, name: 'Pháo Thần Công', type: 'Tấn công AoE', desc: 'Khai hỏa pháo thần công, gây ATK × 2.5 diện rộng, gây choáng (giảm tốc 50%).', chance: 25, multiplier: 2.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Thiên Hạ Đệ Nhất Tông', type: 'Triệu hồi', desc: 'Trấn phái. "Gọi hội" đệ tử ra đánh. Gây 10 lần sát thương, mỗi lần ATK × 0.5 (Tổng 5.0).', chance: 20, multiplier: 0.5, hits: 10, ignoreDef: 0.1, bonusCrit: 10, manaCost: 80 },
                    { level: 80, name: 'Hệ Thống Gian Thương', type: 'Bị động', desc: 'Mua đồ buff sức mạnh. Tăng 30% Công Kích và 30% May Mắn.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'lck_p', value: 30 } },
                    { level: 120, name: 'Nan Giải Chi Đề', type: 'Buff Toàn Diện', desc: 'Giải toán tăng IQ và sức mạnh. Tăng 50% Chính Xác và 50% Bỏ qua DEF trong 15s.', chance: 15, effect: { type: 'buff', stat: 'accuracy_p', value: 50, duration: 15 }, effect2: { type: 'buff', stat: 'ignoreDef_p', value: 50, duration: 15 }, manaCost: 60 },
                    { level: 150, name: 'Vạn Cổ Kiếm Ngục', type: 'Tấn công siêu cấp', desc: 'Tuyệt kỹ kiếm đạo, gây ATK × 6.5, phong tỏa kẻ địch (giảm 50% ATK địch).', chance: 15, multiplier: 6.5, hits: 1, ignoreDef: 0.4, effect: { type: 'debuff', stat: 'atk', value: -0.5, duration: 10 }, manaCost: 100 },
                    { level: 180, name: 'Quân Thường Tiếu', type: 'Bị động', desc: 'Tông chủ bảo kê. Tăng 50% HP và 30% Hồi Phục (Lifesteal).', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 30 } }
                ]
            },
            // [NEW] 29. Tử Tiêu Cung (Hồng Hoang - Đạo Tổ)
            'tu_tieu': {
                name: 'Tử Tiêu Cung',
                icon: 'fa-solid fa-circle-notch',
                className: 'text-fuchsia-300 text-shadow-purple', // [NEW] Style
                desc: 'Đạo tràng của Đạo Tổ Hồng Quân bên ngoài 33 tầng trời. Nắm giữ Thiên Đạo, coi vạn vật như rơm rác. Sức mạnh của quy tắc.',
                skills: [
                    { level: 1, name: 'Tử Tiêu Thần Lôi', type: 'Tấn công sơ cấp', desc: 'Sấm sét hủy diệt, gây ATK × 1.5, bỏ qua 20% DEF.', chance: 0, multiplier: 1.5, hits: 1, ignoreDef: 0.2, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Thiên Đạo Vô Thân', type: 'Bị động', desc: 'Vô cảm trước vạn vật. Tăng 30% Công Kích và 30% Nội Lực.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'mana_p', value: 30 } },
                    { level: 20, name: 'Tạo Hóa Ngọc Điệp', type: 'Buff', desc: 'Suy diễn vạn pháp. Tăng 50% Chính Xác và 50% Kháng Hiệu Ứng trong 20s.', chance: 25, effect: { type: 'buff', stat: 'accuracy_p', value: 50, duration: 20 }, manaCost: 30 },
                    { level: 30, name: 'Tam Thi Chứng Đạo', type: 'Triệu hồi', desc: 'Triệu hồi 3 bản thể (Thiện, Ác, Chấp). Tăng 100% Tốc Độ Đánh trong 10s.', chance: 20, effect: { type: 'buff', stat: 'spd', value: 1.0, duration: 10 }, manaCost: 40 },
                    { level: 50, name: 'Thiên Phạt', type: 'Tấn công chuẩn', desc: 'Thay trời hành đạo. Gây ATK × 4.0, 100% Bỏ qua Phòng Thủ.', chance: 30, multiplier: 4.0, hits: 1, ignoreDef: 1.0, bonusCrit: 10, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Nhất Khí Hóa Tam Thanh', type: 'Tấn công liên hoàn', desc: 'Trấn phái. Hóa thành 3 Thanh Thiên Tôn. Gây 3 lần sát thương, mỗi lần ATK × 2.5 (Tổng 7.5).', chance: 20, multiplier: 2.5, hits: 3, ignoreDef: 0.5, bonusCrit: 30, manaCost: 100 },
                    { level: 80, name: 'Thân Hợp Thiên Đạo', type: 'Bị động', desc: 'Hòa mình vào hư không. Tăng 50% Né Tránh và 30% Phản Đòn (chưa hỗ trợ).', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 50 } },
                    { level: 120, name: 'Đại Đạo Tam Thiên', type: 'Tấn công AoE', desc: 'Ba ngàn đại đạo trấn áp. Gây ATK × 6.0 diện rộng, làm choáng (giảm tốc 90%).', chance: 15, multiplier: 6.0, hits: 1, ignoreDef: 0.4, effect: { type: 'debuff', stat: 'spd', value: -0.9, duration: 5 }, manaCost: 120 },
                    { level: 150, name: 'Ngôn Xuất Pháp Tùy', type: 'Khống chế tuyệt đối', desc: 'Nói ra pháp tắc tuân theo. Giảm 100% ATK và DEF của địch trong 5s (Biến địch thành phế nhân).', chance: 10, effect: { type: 'debuff', stat: 'atk', value: -1.0, duration: 5 }, effect2: { type: 'debuff', stat: 'def', value: -1.0, duration: 5 }, manaCost: 150 },
                    { level: 180, name: 'Hồng Quân Lão Tổ', type: 'Bị động', desc: 'Sư phụ của Thánh Nhân. Tăng 100% Tất cả chỉ số.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 100 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 100 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 100 }, effect4: { type: 'passive_buff', stat: 'spd_p', value: 100 } }
                ]
            },
            // [NEW] 30. Tây Thiên Linh Sơn (Tây Du - Phật Tổ)
            'linh_son': {
                name: 'Tây Thiên Linh Sơn',
                icon: 'fa-solid fa-hand-spock',
                className: 'text-amber-200 text-shadow-gold', // [NEW] Style
                desc: 'Thánh địa Phật Giáo, nơi Như Lai Phật Tổ ngự trị. Phật pháp vô biên, lấy đức độ hóa chúng sinh, kim thân bất hoại.',
                skills: [
                    { level: 1, name: 'Đại Uy Thiên Long', type: 'Tấn công sơ cấp', desc: 'Rồng thiêng hộ pháp, gây ATK × 1.3, tăng 20% DEF.', chance: 0, multiplier: 1.3, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'def', value: 0.2, duration: 3 } },
                    { level: 10, name: 'Trượng Lục Kim Thân', type: 'Bị động', desc: 'Thân thể vàng ròng. Tăng 50% Phòng Thủ và 30% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 30 } },
                    { level: 20, name: 'Phật Quang Phổ Chiếu', type: 'Tấn công AoE', desc: 'Ánh sáng Phật tẩy rửa tội lỗi. Gây ATK × 2.0 diện rộng, hồi 20% HP.', chance: 30, multiplier: 2.0, hits: 1, ignoreDef: 0, effect: { type: 'buff', stat: 'lifesteal', value: 100, duration: 1 }, manaCost: 20 },
                    { level: 30, name: 'Ngũ Hành Sơn', type: 'Khống chế', desc: 'Bàn tay hóa núi. Gây ATK × 3.0, trói chân địch (Giảm tốc 100%) trong 5s.', chance: 25, multiplier: 3.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 5 }, manaCost: 40 },
                    { level: 50, name: 'Sư Tử Hống (Phật)', type: 'Debuff', desc: 'Tiếng gầm chấn động tam giới. Giảm 50% ATK địch và gây choáng.', chance: 30, effect: { type: 'debuff', stat: 'atk', value: -0.5, duration: 10 }, manaCost: 35 },
                    // Trấn phái
                    { level: 60, name: 'Như Lai Thần Chưởng', type: 'Tấn công hủy diệt', desc: 'Trấn phái. Vạn Phật Triều Tông. Gây ATK × 5.5 diện rộng, 100% Bỏ qua DEF.', chance: 20, multiplier: 5.5, hits: 1, ignoreDef: 1.0, bonusCrit: 50, manaCost: 80 },
                    { level: 80, name: 'Nhân Quả Báo Ứng', type: 'Bị động', desc: 'Phản đòn 50% sát thương (chưa hỗ trợ) và tăng 40% Kháng Bạo Kích.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'anti_crit_p', value: 40 } },
                    { level: 120, name: 'Chưởng Trung Phật Quốc', type: 'Khống chế vĩnh cửu', desc: 'Nhốt địch vào thế giới trong lòng bàn tay. Gây ATK × 4.0, giảm 50% Mọi chỉ số địch.', chance: 15, multiplier: 4.0, hits: 1, ignoreDef: 0.5, effect: { type: 'debuff', stat: 'atk', value: -0.5, duration: 10 }, effect2: { type: 'debuff', stat: 'def', value: -0.5, duration: 10 }, manaCost: 100 },
                    { level: 150, name: 'Vạn Phật Quy Tông', type: 'Buff Bất Tử', desc: 'Hồi 100% HP và Tăng 100% DEF trong 15s.', chance: 10, effect: { type: 'buff', stat: 'lifesteal', value: 500, duration: 2 }, effect2: { type: 'buff', stat: 'def', value: 1.0, duration: 15 }, manaCost: 120 },
                    { level: 180, name: 'Thế Tôn Như Lai', type: 'Bị động', desc: '天上天下，唯我独尊 (Thiên thượng thiên hạ, duy ngã độc tôn). Tăng 100% HP và 50% Công Kích.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 100 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 50 } }
                ]
            },
            // [NEW] 31. Vô Tận Hỏa Vực (Đấu Phá Hậu Truyện)
            'hoa_vuc': {
                name: 'Vô Tận Hỏa Vực',
                icon: 'fa-solid fa-fire-flame-simple',
                className: 'text-red-500 text-shadow-orange', // [NEW] Style
                desc: 'Lãnh địa của Viêm Đế Tiêu Viêm tại Đại Thiên Thế Giới. Sở hữu 23 loại Dị Hỏa, bá đạo vô song, thiêu rụi mọi kẻ thù.',
                skills: [
                    { level: 1, name: 'Huyền Trọng Xích', type: 'Tấn công sơ cấp', desc: 'Thước đen đập nát hư không. Gây ATK × 1.4, 100% Trúng Đích.', chance: 0, multiplier: 1.4, hits: 1, ignoreDef: 0.1, bonusCrit: 10, manaCost: 0 },
                    { level: 10, name: 'Phần Quyết', type: 'Bị động', desc: 'Công pháp nuốt chửng dị hỏa. Tăng 30% Công Kích và 20% Hồi Phục.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'lifesteal', value: 20 } },
                    { level: 20, name: 'Phật Nộ Hỏa Liên', type: 'Tấn công bạo kích', desc: 'Dung hợp 2 loại dị hỏa. Gây ATK × 3.0, 50% Chí Mạng.', chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 30 },
                    { level: 30, name: 'Thiên Yêu Khôi', type: 'Buff', desc: 'Triệu hồi khôi lỗi hộ thể. Tăng 50% Phòng Thủ và 30% Kháng Hiệu Ứng.', chance: 25, effect: { type: 'buff', stat: 'def', value: 0.5, duration: 15 }, manaCost: 40 },
                    { level: 50, name: 'Ngũ Luân Ly Hỏa Pháp', type: 'Tấn công liên hoàn', desc: 'Năm con thú lửa tấn công. Đánh 5 lần, mỗi lần ATK × 0.8, thiêu đốt (DoT).', chance: 35, multiplier: 0.8, hits: 5, ignoreDef: 0.1, bonusCrit: 20, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Viêm Thần Pháp Tướng', type: 'Buff Biến Hình', desc: 'Trấn phái. Hóa thân Viêm Thần khổng lồ. Tăng 100% HP, 100% ATK trong 20s.', chance: 15, effect: { type: 'buff', stat: 'hp', value: 1.0, duration: 20 }, effect2: { type: 'buff', stat: 'atk', value: 1.0, duration: 20 }, manaCost: 100 },
                    { level: 80, name: 'Đế Viêm Chi Thể', type: 'Bị động', desc: 'Thân thể lửa bất diệt. Tăng 40% HP và 40% Sát Thương Chí Mạng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 40 } },
                    { level: 120, name: 'Phật Nộ Luân Hồi', type: 'Tấn công cưa máy', desc: 'Đĩa lửa xoay tròn cắt nát không gian. Gây ATK × 6.0, bỏ qua 50% DEF.', chance: 20, multiplier: 6.0, hits: 1, ignoreDef: 0.5, bonusCrit: 30, manaCost: 90 },
                    { level: 150, name: 'Dị Hỏa Hằng Cổ Xích', type: 'Tấn công siêu cấp', desc: 'Dung hợp toàn bộ 23 Dị Hỏa vào thước. Gây ATK × 8.0, 100% Bỏ qua DEF, Thiêu rụi linh hồn.', chance: 10, multiplier: 8.0, hits: 1, ignoreDef: 1.0, bonusCrit: 50, manaCost: 150 },
                    { level: 180, name: 'Viêm Đế', type: 'Bị động', desc: 'Chúa tể của lửa. Tăng 50% Công Kích và 50% Bỏ qua Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 50 } }
                ]
            },
            // [NEW] 32. Võ Cảnh (Vũ Động Hậu Truyện)
            'vo_canh': {
                name: 'Võ Cảnh',
                icon: 'fa-solid fa-hand-fist',
                className: 'text-blue-400 text-shadow-cyan', // [NEW] Style
                desc: 'Lãnh địa của Vũ Tổ Lâm Động. Nắm giữ Bát Đại Tổ Phù, khống chế càn khôn, thôn phệ vạn vật.',
                skills: [
                    { level: 1, name: 'Thanh Thiên Hóa Long', type: 'Tấn công sơ cấp', desc: 'Hóa tay rồng tấn công, gây ATK × 1.3, tăng 10% DEF.', chance: 0, multiplier: 1.3, hits: 1, ignoreDef: 0.1, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'def', value: 0.1, duration: 3 } },
                    { level: 10, name: 'Tổ Phù Chi Chủ', type: 'Bị động', desc: 'Tăng 20% Tất cả chỉ số cơ bản.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 20 }, effect4: { type: 'passive_buff', stat: 'mana_p', value: 20 } },
                    { level: 20, name: 'Đại Hoang Tù Thiên Chỉ', type: 'Tấn công bạo kích', desc: 'Một chỉ nát trời xanh. Gây ATK × 3.5, 40% Chí Mạng.', chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 40, manaCost: 30 },
                    { level: 30, name: 'Thôn Phệ Tổ Phù', type: 'Buff Hồi Phục', desc: 'Hút năng lượng trời đất. Hồi 30% HP và Mana trong 5s.', chance: 25, effect: { type: 'buff', stat: 'lifesteal', value: 50, duration: 5 }, effect2: { type: 'buff', stat: 'manasteal', value: 50, duration: 5 }, manaCost: 0 },
                    { level: 50, name: 'Lôi Đình Tổ Phù', type: 'Tấn công AoE', desc: 'Sấm sét hủy diệt, gây ATK × 3.0 diện rộng, làm choáng (giảm tốc 50%).', chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 5 }, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Bát Phù Thủ', type: 'Tấn công liên hoàn', desc: 'Trấn phái. Tám loại năng lượng kết hợp. Đánh 8 lần, mỗi lần ATK × 0.8.', chance: 20, multiplier: 0.8, hits: 8, ignoreDef: 0.3, bonusCrit: 20, manaCost: 80 },
                    { level: 80, name: 'Càn Khôn Cổ Trận', type: 'Bị động', desc: 'Phản đòn 40% và giảm 20% Sát thương nhận vào.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 20 } },
                    { level: 120, name: 'Vị Diện Chi Thai', type: 'Buff Siêu Cấp', desc: 'Mượn sức mạnh cả một thế giới. Tăng 80% Toàn bộ chỉ số trong 15s.', chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.8, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.8, duration: 15 }, effect3: { type: 'buff', stat: 'hp', value: 0.8, duration: 15 }, effect4: { type: 'buff', stat: 'spd', value: 0.8, duration: 15 }, manaCost: 100 },
                    { level: 150, name: 'Trảm Đế Quỷ Huyết Nhẫn', type: 'Tấn công kết liễu', desc: 'Vũ khí chém Dị Ma Hoàng. Gây ATK × 7.0, 100% Bỏ qua DEF.', chance: 10, multiplier: 7.0, hits: 1, ignoreDef: 1.0, bonusCrit: 50, manaCost: 120 },
                    { level: 180, name: 'Hồn Thiên Đế', type: 'Bị động', desc: 'Đại BOSS cuối cùng. Tăng 60% Công Kích và 40% Bỏ qua Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 60 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 40 } }
                ]
            },
            // [NEW] 57. Dương Môn (VLTK 2 - Dương Gia Tướng)
            'duong_mon_vltk': {
                name: 'Dương Môn',
                icon: 'fa-solid fa-horse',
                className: 'text-red-400 text-shadow-gold', // [NEW] Style
                desc: 'Trung liệt Dương Gia Tướng. Thương pháp cái thế, cung thuật vô song. Chiến đấu trên lưng ngựa, dũng mãnh thiện chiến.',
                skills: [
                    { level: 1, name: 'Dương Gia Thương Pháp', type: 'Tấn công sơ cấp', desc: 'Thương pháp cơ bản, gây ATK × 1.2, tăng 10% DEF.', chance: 0, multiplier: 1.2, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'def', value: 0.1, duration: 3 } },
                    { level: 10, name: 'Bích Huyết Đan Tâm', type: 'Bị động', desc: 'Lòng son sắt đá. Tăng 20% HP và 20% Kháng Hiệu Ứng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'def_p', value: 20 } }, // Kháng dùng tạm def_p
                    { level: 20, name: 'Liên Xạ Thuật', type: 'Tấn công tầm xa', desc: 'Bắn liên tiếp 3 mũi tên, mỗi mũi ATK × 0.7.', chance: 35, multiplier: 0.7, hits: 3, ignoreDef: 0.1, bonusCrit: 10, manaCost: 20 },
                    { level: 30, name: 'Ngự Mã Thuật', type: 'Buff Tốc Độ', desc: 'Tăng tốc độ di chuyển và né tránh. Tăng 40% SPD và 30% Né Tránh trong 15s.', chance: 25, effect: { type: 'buff', stat: 'spd', value: 0.4, duration: 15 }, effect2: { type: 'buff', stat: 'dodgeChance', value: 30, duration: 15 }, manaCost: 30 },
                    { level: 50, name: 'Đảo Hải Thương', type: 'Tấn công AoE', desc: 'Thương pháp đảo hải, gây ATK × 3.0 diện rộng, làm choáng nhẹ.', chance: 30, multiplier: 3.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.3, duration: 3 }, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Lê Hoa Thương', type: 'Tấn công liên hoàn', desc: 'Trấn phái. Thương đâm như mưa hoa lê. Đánh 8 lần, mỗi lần ATK × 0.6, tăng 50% Chính Xác.', chance: 20, multiplier: 0.6, hits: 8, ignoreDef: 0.2, bonusCrit: 20, manaCost: 70, effect: { type: 'buff', stat: 'accuracy_p', value: 50, duration: 5 } },
                    { level: 80, name: 'Thiên Hoành', type: 'Bị động', desc: 'Khí thế áp đảo. Tăng 30% Công Kích và 20% Bỏ qua Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } },
                    { level: 120, name: 'Xuyên Vân Tiễn', type: 'Tấn công xuyên thấu', desc: 'Một tên xuyên mây. Gây ATK × 5.0, 100% Bỏ qua DEF, 50% Chí Mạng.', chance: 15, multiplier: 5.0, hits: 1, ignoreDef: 1.0, bonusCrit: 50, manaCost: 90 },
                    { level: 150, name: 'Dương Môn Nữ Tướng', type: 'Buff Sĩ Khí', desc: 'Hào khí ngất trời. Tăng 60% Công Kích và 60% Phòng Thủ trong 20s.', chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.6, duration: 20 }, effect2: { type: 'buff', stat: 'def', value: 0.6, duration: 20 }, manaCost: 120 },
                    { level: 180, name: 'Trung Liệt Anh Hồn', type: 'Bị động', desc: 'Bất khuất. Tăng 50% HP và khi HP < 30% tăng 100% ATK (chưa hỗ trợ logic HP, tăng thẳng 30% ATK).', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 30 } }
                ]
            },
            // [NEW] 58. Bá Đao Sơn Trang (VLTK 3 - Bắc Bá Đao)
            'ba_dao': {
                name: 'Bá Đao',
                icon: 'fa-solid fa-khanda',
                className: 'text-blue-800 text-shadow-white', // [NEW] Style
                desc: 'Bắc Bá Đao, danh gia vọng tộc. Sử dụng đại đao hạng nặng, phong cách hào sảng, cương mãnh. Sở hữu kỹ năng tạo tường gió chặn sát thương độc nhất.',
                skills: [
                    { level: 1, name: 'Hạng Vương Kích', type: 'Tấn công AoE sơ cấp', desc: 'Múa đao quét ngang, gây ATK × 1.0 diện rộng.', chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Bắc Ngạo Quyết', type: 'Bị động', desc: 'Ngạo khí lăng vân. Tăng 20% Công Kích và 10% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 10 } },
                    { level: 20, name: 'Tán Lưu Toái', type: 'Buff Phòng Thủ', desc: 'Tạo tường khí hộ thân (Tường Gió). Tăng 100% Phòng Thủ trong 5s.', chance: 30, effect: { type: 'buff', stat: 'def', value: 1.0, duration: 5 }, manaCost: 30 },
                    { level: 30, name: 'Kiên Bích Thanh Dã', type: 'Tấn công DoT', desc: 'Rải thảm đao khí, gây ATK × 2.5 và thiêu đốt mặt đất (DoT) trong 10s.', chance: 25, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'def', value: -0.2, duration: 10 }, manaCost: 40 },
                    { level: 50, name: 'Tây Sở Bi Ca', type: 'Khống chế', desc: 'Tiếng hát bi tráng. Làm choáng địch (giảm tốc 80%) trong 4s, gây ATK × 3.0.', chance: 25, multiplier: 3.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.8, duration: 4 }, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Thượng Tướng Quân Ấn', type: 'Tấn công hủy diệt', desc: 'Trấn phái. Triệu hồi đao khí khổng lồ chém xuống. Gây ATK × 6.5 diện rộng, sát thương cực lớn.', chance: 15, multiplier: 6.5, hits: 1, ignoreDef: 0.3, bonusCrit: 40, manaCost: 100 },
                    { level: 80, name: 'Lực Bạt Sơn', type: 'Bị động', desc: 'Sức mạnh dời non. Tăng 40% Sát Thương Chí Mạng và 20% Bỏ qua Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'critDamage', value: 40 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 20 } },
                    { level: 120, name: 'Phá Phủ Trầm Chu', type: 'Tấn công liều mạng', desc: 'Đập nồi dìm thuyền. Gây ATK × 8.0, nhưng giảm 50% DEF bản thân trong 5s.', chance: 10, multiplier: 8.0, hits: 1, ignoreDef: 0.5, bonusCrit: 50, effect: { type: 'buff', stat: 'def', value: -0.5, duration: 5 }, manaCost: 120 },
                    { level: 150, name: 'Bá Vương Tức Giận', type: 'Buff Bùng Nổ', desc: 'Cơn giận của Bá Vương. Tăng 100% Công Kích và 50% Hút Máu trong 10s.', chance: 10, effect: { type: 'buff', stat: 'atk', value: 1.0, duration: 10 }, effect2: { type: 'buff', stat: 'lifesteal', value: 50, duration: 10 }, manaCost: 150 },
                    { level: 180, name: 'Bá Đao Vô Địch', type: 'Bị động', desc: 'Thiên hạ vô địch thủ. Tăng 60% Công Kích và 40% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 60 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 40 } }
                ]
            },
            // [NEW] 59. Tàng Kiếm Sơn Trang (VLTK 3 - Tây Hồ)
            'tang_kiem': {
                name: 'Tàng Kiếm',
                icon: 'fa-solid fa-scale-balanced',
                className: 'text-yellow-400 text-shadow-gold', // [NEW] Style
                desc: 'Tây Hồ Tàng Kiếm, danh môn chính phái. Sử dụng Song Kiếm (Khinh Kiếm & Trọng Kiếm). Kiếm khí xoay chuyển như rồng, miễn nhiễm khống chế.',
                skills: [
                    { level: 1, name: 'Cửu Khê Di Hoa', type: 'Tấn công AoE sơ cấp', desc: 'Kiếm khí lan tỏa, gây ATK × 1.0 cho nhiều mục tiêu.', chance: 0, multiplier: 1.0, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0 },
                    { level: 10, name: 'Tâm Pháp Quân Tử', type: 'Bị động', desc: 'Kiếm khí nội liễm. Tăng 20% Nội Lực và 15% Tốc Độ Đánh.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 15 } },
                    { level: 20, name: 'Bình Hồ Đoạn Nguyệt', type: 'Tấn công tiếp cận', desc: 'Lướt tới chém mạnh (Trọng Kiếm). Gây ATK × 2.5, tăng 20% Chí Mạng.', chance: 35, multiplier: 2.5, hits: 1, ignoreDef: 0.1, bonusCrit: 20, manaCost: 20 },
                    { level: 30, name: 'Khiếu Nhật', type: 'Buff Giải Khống', desc: 'Chuyển đổi kiếm ý, giải trừ mọi khống chế (mô phỏng tăng 100% Kháng) và tăng 30% ATK trong 10s.', chance: 20, effect: { type: 'buff', stat: 'anti_crit_p', value: 100, duration: 10 }, effect2: { type: 'buff', stat: 'atk', value: 0.3, duration: 10 }, manaCost: 30 }, // Dùng anti_crit để mô phỏng kháng hiệu ứng
                    { level: 50, name: 'Vân Phi Ngọc Hoàng', type: 'Tấn công bạo kích', desc: 'Trọng kiếm vung lên, gây ATK × 4.0, 50% Chí Mạng nếu địch đứng yên (mô phỏng luôn crit cao).', chance: 30, multiplier: 4.0, hits: 1, ignoreDef: 0.2, bonusCrit: 50, manaCost: 50 },
                    // Trấn phái
                    { level: 60, name: 'Phong Lai Ngô Sơn', type: 'Tấn công xoay tròn', desc: 'Trấn phái. "Cối xay gió" huyền thoại. Xoay kiếm liên tục gây sát thương diện rộng. Đánh 10 lần, mỗi lần ATK × 0.6.', chance: 15, multiplier: 0.6, hits: 10, ignoreDef: 0.1, bonusCrit: 10, manaCost: 100 },
                    { level: 80, name: 'Mộng Tuyền Hổ Bào', type: 'Bị động', desc: 'Thân pháp linh hoạt. Tăng 40% Né Tránh và 20% Tốc Độ Đánh.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'dodgeChance', value: 40 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 20 } },
                    { level: 120, name: 'Hạc Quy Cô Sơn', type: 'Tấn công khống chế', desc: 'Dùng trọng kiếm đập xuống. Gây ATK × 5.0, làm choáng 3s (giảm tốc 100%).', chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 0.3, effect: { type: 'debuff', stat: 'spd', value: -1.0, duration: 3 }, manaCost: 80 },
                    { level: 150, name: 'Tịch Chiếu Lôi Phong', type: 'Tấn công kết liễu', desc: 'Kiếm khí như sấm sét. Gây ATK × 7.0, bỏ qua 50% DEF.', chance: 15, multiplier: 7.0, hits: 1, ignoreDef: 0.5, bonusCrit: 30, manaCost: 120 },
                    { level: 180, name: 'Tâm Kiếm Hợp Nhất', type: 'Bị động', desc: 'Kiếm là người, người là kiếm. Tăng 50% Công Kích và 50% Sát Thương Chí Mạng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 50 } }
                ]
            },
            // [NEW] 60. Trường Ca Môn (VLTK 3 - Cầm Sư)
            'truong_ca': {
                name: 'Trường Ca Môn',
                icon: 'fa-solid fa-music',
                className: 'text-green-200 text-shadow-white', // [NEW] Style
                desc: 'Nho môn thánh địa, lấy Cầm (Đàn) nhập đạo. "Mạc Vấn" kiếm khí, "Tương Tri" trị liệu. Dùng âm công vô hình và tạo ảo ảnh (Bóng).',
                skills: [
                    { level: 1, name: 'Cung Thương Giốc Chủy Vũ', type: 'Tấn công sơ cấp', desc: 'Gảy đàn phóng kình lực. Gây ATK × 1.1, tăng 10% Nội Lực.', chance: 0, multiplier: 1.1, hits: 1, ignoreDef: 0, bonusCrit: 0, manaCost: 0, effect: { type: 'buff', stat: 'mana', value: 0.1, duration: 3 } },
                    { level: 10, name: 'Khúc Phong Nhã Tụng', type: 'Bị động', desc: 'Tiếng đàn thanh tao. Tăng 20% Nội Lực và 20% Kháng Hiệu Ứng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'mana_p', value: 20 }, effect2: { type: 'passive_buff', stat: 'anti_crit_p', value: 20 } }, // Kháng dùng anti_crit
                    { level: 20, name: 'Bình Sa Lạc Nhạn', type: 'Tấn công khống chế', desc: 'Tiếng đàn làm chim sa. Gây ATK × 2.0, làm chậm 40% trong 5s.', chance: 30, multiplier: 2.0, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.4, duration: 5 }, manaCost: 20 },
                    { level: 30, name: 'Sơ Ảnh Ngư', type: 'Buff Bóng', desc: 'Tạo ảo ảnh (Bóng) hộ thể. Tăng 40% Né Tránh và 20% Giảm sát thương (Def) trong 15s.', chance: 25, effect: { type: 'buff', stat: 'dodgeChance', value: 40, duration: 15 }, effect2: { type: 'buff', stat: 'def', value: 0.2, duration: 15 }, manaCost: 30 },
                    { level: 50, name: 'Cô Ảnh Hóa Đôi', type: 'Tấn công liên hoàn', desc: 'Bóng cùng tấn công. Đánh 2 lần, mỗi lần ATK × 1.5 (Tổng 3.0).', chance: 35, multiplier: 1.5, hits: 2, ignoreDef: 0.1, bonusCrit: 10, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Giang Trục Nguyệt Thiên', type: 'Khống chế diện rộng', desc: 'Trấn phái. Âm vực bao trùm. Gây ATK × 3.5 diện rộng, làm choáng (giảm tốc 80%) và giảm 40% ATK địch trong 5s.', chance: 20, multiplier: 3.5, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'spd', value: -0.8, duration: 5 }, effect2: { type: 'debuff', stat: 'atk', value: -0.4, duration: 5 }, manaCost: 80 },
                    { level: 80, name: 'Thanh Tiêu Phi Vũ', type: 'Bị động', desc: 'Thân pháp nhẹ nhàng. Tăng 30% Tốc Độ Đánh và hồi 5% Mana/lượt.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'manasteal', value: 5 } },
                    { level: 120, name: 'Dương Xuân Bạch Tuyết', type: 'Tấn công xuyên thấu', desc: 'Khúc nhạc cao sang. Gây ATK × 5.0, bỏ qua 50% Phòng Thủ.', chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 0.5, bonusCrit: 20, manaCost: 100 },
                    { level: 150, name: 'Cao Sơn Lưu Thủy', type: 'Buff Toàn Diện', desc: 'Tri kỷ khó tìm. Tăng 50% Công Kích, 50% Chính Xác và 50% Chí Mạng trong 15s.', chance: 15, effect: { type: 'buff', stat: 'atk', value: 0.5, duration: 15 }, effect2: { type: 'buff', stat: 'accuracy_p', value: 50, duration: 15 }, effect3: { type: 'buff', stat: 'critChance', value: 50, duration: 15 }, manaCost: 120 },
                    { level: 180, name: 'Cầm Trung Kiếm', type: 'Bị động', desc: 'Kiếm giấu trong đàn. Tăng 40% Công Kích và 40% Bỏ qua Phòng Thủ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 40 }, effect2: { type: 'passive_buff', stat: 'ignoreDef_p', value: 40 } }
                ]
            },
            // [NEW] 61. Thiên Sách Phủ (VLTK 3 - Kỵ Binh)
            'thien_sach': {
                name: 'Thiên Sách Phủ',
                icon: 'fa-solid fa-shield-dog',
                className: 'text-red-600 text-shadow-white', // [NEW] Style
                desc: '"Đông Đô Chi Lang". Quân đội trấn thủ Đại Đường. Kỹ thuật chiến đấu trên ngựa (Mã Chiến) đỉnh cao, dũng mãnh, không lùi bước.',
                skills: [
                    { level: 1, name: 'Xuyên Vân', type: 'Tấn công sơ cấp', desc: 'Thương đâm thẳng, gây ATK × 1.3.', chance: 0, multiplier: 1.3, hits: 1, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Thiết Lao Luật', type: 'Bị động', desc: 'Kỷ luật thép. Tăng 30% Phòng Thủ và 20% HP.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'def_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'hp_p', value: 20 } },
                    { level: 20, name: 'Đột Kích', type: 'Tấn công nhanh', desc: 'Lao ngựa vào địch. Gây ATK × 2.0, tăng 30% Tốc Độ Đánh trong 5s.', chance: 35, multiplier: 2.0, hits: 1, ignoreDef: 0, effect: { type: 'buff', stat: 'spd', value: 0.3, duration: 5 }, manaCost: 15 },
                    { level: 30, name: 'Ngự Bôn Đột', type: 'Khống chế', desc: 'Ngựa chồm lên đạp. Gây ATK × 2.5, làm choáng (giảm tốc 60%) trong 3s.', chance: 25, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.6, duration: 3 }, manaCost: 25 },
                    { level: 50, name: 'Long Nha', type: 'Tấn công bạo kích', desc: 'Nanh rồng cắn xé. Gây ATK × 3.5, 40% Chí Mạng.', chance: 30, multiplier: 3.5, hits: 1, ignoreDef: 0.2, bonusCrit: 40, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Khiếu Như Hổ', type: 'Buff Bất Tử', desc: 'Trấn phái. Tiếng gầm của mãnh hổ. Hồi 50% HP, tăng 100% DEF và miễn nhiễm tử vong (chưa hỗ trợ) trong 10s.', chance: 15, effect: { type: 'buff', stat: 'lifesteal', value: 200, duration: 1 }, effect2: { type: 'buff', stat: 'def', value: 1.0, duration: 10 }, manaCost: 80 },
                    { level: 80, name: 'Tật Như Phong', type: 'Bị động', desc: 'Nhanh như gió. Tăng 30% Tốc Độ Đánh và 20% Chính Xác.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'spd_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'accuracy_p', value: 20 } },
                    { level: 120, name: 'Phá Kiên Trận', type: 'Tấn công phá giáp', desc: 'Phá vỡ đội hình. Gây ATK × 5.0, giảm 50% DEF địch trong 10s.', chance: 20, multiplier: 5.0, hits: 1, ignoreDef: 0.3, effect: { type: 'debuff', stat: 'def', value: -0.5, duration: 10 }, manaCost: 90 },
                    { level: 150, name: 'Thương Hồn Bất Diệt', type: 'Buff Sức Mạnh', desc: 'Ý chí chiến đấu. Tăng 80% Công Kích và 40% Hút Máu trong 15s.', chance: 10, effect: { type: 'buff', stat: 'atk', value: 0.8, duration: 15 }, effect2: { type: 'buff', stat: 'lifesteal', value: 40, duration: 15 }, manaCost: 120 },
                    { level: 180, name: 'Đông Đô Lang Vương', type: 'Bị động', desc: 'Vua sói. Tăng 50% HP, 50% Công Kích và 30% Phản Đòn.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'hp_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'atk_p', value: 50 }, effect3: { type: 'passive_buff', stat: 'def_p', value: 30 } }
                ]
            },
            // [NEW] 62. Thần Cơ Trại (VLTK 2 - Nỏ & Bẫy)
            'than_co': {
                name: 'Thần Cơ Trại',
                icon: 'fa-solid fa-crosshairs',
                className: 'text-stone-400 text-shadow-green', // [NEW] Style
                desc: 'Môn phái tinh thông cơ quan, ám khí và hỏa dược. Sử dụng Nỏ tấn công tầm xa cực nhanh và đặt bẫy khống chế kẻ địch.',
                skills: [
                    { level: 1, name: 'Liên Nỏ', type: 'Tấn công sơ cấp', desc: 'Bắn liên tiếp 2 mũi tên, mỗi mũi ATK × 0.7.', chance: 0, multiplier: 0.7, hits: 2, ignoreDef: 0, bonusCrit: 5, manaCost: 0 },
                    { level: 10, name: 'Thần Cơ Diệu Toán', type: 'Bị động', desc: 'Tính toán chính xác. Tăng 30% Chính Xác và 10% Tốc Độ.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'accuracy_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'spd_p', value: 10 } },
                    { level: 20, name: 'Địa Lôi Chấn', type: 'Bẫy/AoE', desc: 'Kích hoạt bẫy mìn. Gây ATK × 2.5 diện rộng, làm choáng (giảm tốc 50%).', chance: 30, multiplier: 2.5, hits: 1, ignoreDef: 0.1, effect: { type: 'debuff', stat: 'spd', value: -0.5, duration: 3 }, manaCost: 20 },
                    { level: 30, name: 'Ẩn Thân Thuật', type: 'Buff Né Tránh', desc: 'Ngụy trang vào môi trường. Tăng 60% Né Tránh trong 10s.', chance: 25, effect: { type: 'buff', stat: 'dodgeChance', value: 60, duration: 10 }, manaCost: 25 },
                    { level: 50, name: 'Thiên Tý Nỏ', type: 'Tấn công liên hoàn', desc: 'Nỏ thần ngàn tay. Bắn 5 mũi tên, mỗi mũi ATK × 0.6, +20% Chí Mạng.', chance: 35, multiplier: 0.6, hits: 5, ignoreDef: 0.1, bonusCrit: 20, manaCost: 40 },
                    // Trấn phái
                    { level: 60, name: 'Mạn Thiên Hoa Vũ', type: 'Tấn công AoE', desc: 'Trấn phái. Mưa tên che trời. Gây ATK × 5.5 diện rộng, sát thương cực lớn.', chance: 20, multiplier: 5.5, hits: 1, ignoreDef: 0.2, bonusCrit: 30, manaCost: 80 },
                    { level: 80, name: 'Xuyên Tâm Tiễn', type: 'Bị động', desc: 'Mũi tên xuyên tim. Tăng 30% Bỏ qua Phòng Thủ và 20% Sát Thương Chí Mạng.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'ignoreDef_p', value: 30 }, effect2: { type: 'passive_buff', stat: 'critDamage', value: 20 } },
                    { level: 120, name: 'Độc Hỏa Pháo', type: 'Tấn công DoT', desc: 'Bắn pháo độc. Gây ATK × 4.0, giảm 40% DEF và thiêu đốt (DoT).', chance: 25, multiplier: 4.0, hits: 1, ignoreDef: 0.2, effect: { type: 'debuff', stat: 'def', value: -0.4, duration: 10 }, manaCost: 70 },
                    { level: 150, name: 'Truy Hồn Đoạt Mệnh', type: 'Tấn công tất sát', desc: 'Mũi tên đuổi theo linh hồn. Gây ATK × 7.0, 100% Trúng Đích, 100% Chí Mạng.', chance: 10, multiplier: 7.0, hits: 1, ignoreDef: 0.5, bonusCrit: 100, manaCost: 120 },
                    { level: 180, name: 'Cơ Quan Đại Sư', type: 'Bị động', desc: 'Bậc thầy bẫy rập. Tăng 50% Công Kích và 40% Né Tránh.', passive: true, manaCost: 0, effect: { type: 'passive_buff', stat: 'atk_p', value: 50 }, effect2: { type: 'passive_buff', stat: 'dodgeChance', value: 40 } }
                ]
            }
        }; // [FIX] Đã đóng 'MON_PHAI_SKILLS_DB' và xóa dấu phẩy (,) thừa

        // *** NEW: Static Item DB (Potions, Food, etc.) ***
        // [FIX] Thêm khai báo 'const STATIC_ITEM_DB = {'
        const STATIC_ITEM_DB = {
             // [NEW] --- CÁ CHÍ TÔN (V1.96) ---
             'food_xp_god': { 
                 name: 'Cá Chí Tôn', rarity: 10, // Rarity 10 = Siêu Thần
                 desc: 'Món ăn của thần linh, hội tụ tinh hoa tứ hải. Nhận 3,500,000,000 Kinh nghiệm.',
                 type: 'potion', 
                 effect: { target: 'xp', value: 3500000000, isPercent: false },
                 sellPrice: 10000000, 
                 icon: 'fa-solid fa-dragon' 
             },

             // [NEW] --- CÁ SIÊU THẦN (V1.97) ---
             'food_xp_super_god': { 
                 name: 'Cá Siêu Thần', rarity: 11, // Rarity 11 = Tối Thượng
                 desc: 'Món ăn vượt qua giới hạn thiên địa. Nhận 35,000,000,000 Kinh nghiệm.',
                 type: 'potion', 
                 effect: { target: 'xp', value: 35000000000, isPercent: false },
                 sellPrice: 50000000, 
                 icon: 'fa-solid fa-dragon text-rainbow-animation' 
             },

             // [NEW] --- VĨNH HẰNG CHI NGƯ (V1.98) ---
             'food_xp_eternal_fish': { 
                 name: 'Vĩnh Hằng Chi Ngư', rarity: 14, // Rarity 14 = Vĩnh Hằng (Rainbow + Ascension Glow)
                 desc: 'Cá bơi ngược dòng thời gian, ăn vào trường sinh bất tử. Nhận 175,000,000,000 Kinh nghiệm.',
                 type: 'potion', 
                 effect: { target: 'xp', value: 175000000000, isPercent: false },
                 sellPrice: 200000000, 
                 icon: 'fa-solid fa-fish text-rainbow-animation text-pulse-ascension-glow' 
             },

             // [NEW] --- BẤT DIỆT NGƯ (V1.99) ---
             'food_xp_immortal_fish': { 
                 name: 'Bất Diệt Ngư', rarity: 15, // Rarity 15 = Thiên Đạo
                 desc: 'Sinh vật tồn tại từ thuở khai thiên lập địa, cơ thể bất diệt. Nhận 500,000,000,000 Kinh nghiệm.',
                 type: 'potion', 
                 effect: { target: 'xp', value: 500000000000, isPercent: false },
                 sellPrice: 1000000000, 
                 icon: 'fa-solid fa-infinity text-rainbow-animation text-pulse-glow' // Icon Vô Cực
             },

             // [NEW] --- THÁI SƠ NGƯ (V1.99b) ---
             'food_xp_primordial_fish': { 
                 name: 'Thái Sơ Ngư', rarity: 16, // Rarity 16 = Sáng Thế
                 desc: 'Nguyên bản của vạn vật, chứa đựng sức mạnh khởi nguyên vũ trụ. Nhận 2,500,000,000,000 Kinh nghiệm.',
                 type: 'potion', 
                 effect: { target: 'xp', value: 2500000000000, isPercent: false },
                 sellPrice: 5000000000, 
                 icon: 'fa-solid fa-atom text-rainbow-animation text-pulse-holy-glow' // Icon Nguyên Tử
             },

             // [NEW] --- VẬT PHẨM CHẾ TẠO TỪ BẠCH KIM (Platinum Items) ---
             'pill_stat_platinum_atk': {
                name: 'Bạch Kim Chiến Đan', rarity: 10, // Siêu Thần
                desc: 'Đan dược luyện từ tinh hoa Bạch Kim. Tăng vĩnh viễn +1000 Công Kích.',
                type: 'potion',
                effect: { target: 'disciple_stat', stat: 'atk', value: 1000 }, // Dùng chung logic tăng stat đệ tử (đang áp dụng cho player qua hàm useItem custom hoặc logic chung)
                // Lưu ý: Logic useItem hiện tại hỗ trợ 'hp', 'mana', 'chan_khi', 'xp'. 
                // Cần đảm bảo logic useItem hoặc logic pill đệ tử hỗ trợ player dùng cái này.
                // Tạm thời set type là 'potion' đặc biệt, ta sẽ cập nhật hàm useItem để hỗ trợ tăng stat vĩnh viễn cho nhân vật.
                effectType: 'permanent_stat', // Đánh dấu loại mới
                statKey: 'atk',
                statValue: 1000,
                sellPrice: 5000000,
                icon: 'fa-solid fa-khanda text-yellow-300'
             },
             'pill_stat_platinum_hp': {
                name: 'Bạch Kim Huyết Đan', rarity: 10,
                desc: 'Đan dược luyện từ tinh hoa Bạch Kim. Tăng vĩnh viễn +10,000 Sinh Lực.',
                type: 'potion',
                effectType: 'permanent_stat',
                statKey: 'hp',
                statValue: 10000,
                sellPrice: 5000000,
                icon: 'fa-solid fa-heart text-red-500'
             },
             'box_gear_godly': {
                name: 'Rương Thần Ma (Ngẫu Nhiên)', rarity: 11,
                desc: 'Chứa trang bị ngẫu nhiên phẩm chất từ Sử Thi (Vàng) đến Chí Tôn (Đỏ).',
                type: 'box', // Cần xử lý mở rương
                sellPrice: 10000000,
                icon: 'fa-solid fa-box-open text-rainbow-animation'
             },

             // [NEW] --- Chân Khí Đan (5 Cấp độ) ---
             'item_chankhi_1': { 
                 name: 'Chân Khí Đan (Sơ)', rarity: 1, 
                 desc: 'Tụ tập linh khí đất trời. Sử dụng nhận 100 Chân Khí.', 
                 type: 'potion', 
                 effect: { target: 'chan_khi', value: 100 }, 
                 buyPrice: 1000000, currency: 'nl',
                 icon: 'fa-solid fa-circle-dot'
             },
             'item_chankhi_2': { 
                 name: 'Chân Khí Đan (Trung)', rarity: 2, 
                 desc: 'Luyện hóa tinh hoa nhật nguyệt. Sử dụng nhận 500 Chân Khí.', 
                 type: 'potion', 
                 effect: { target: 'chan_khi', value: 500 }, 
                 buyPrice: 4900000, currency: 'nl',
                 icon: 'fa-regular fa-circle-dot'
             },
             'item_chankhi_3': { 
                 name: 'Chân Khí Đan (Cao)', rarity: 3, 
                 desc: 'Chứa đựng sức mạnh của tu sĩ Trúc Cơ. Sử dụng nhận 2,500 Chân Khí.', 
                 type: 'potion', 
                 effect: { target: 'chan_khi', value: 2500 }, 
                 buyPrice: 23500000, currency: 'nl',
                 icon: 'fa-solid fa-bullseye'
             },
             'item_chankhi_4': { 
                 name: 'Chân Khí Đan (Siêu)', rarity: 4, 
                 desc: 'Tinh chế từ lõi của yêu thú ngàn năm. Sử dụng nhận 10,000 Chân Khí.', 
                 type: 'potion', 
                 effect: { target: 'chan_khi', value: 10000 }, 
                 buyPrice: 98000000, currency: 'nl',
                 icon: 'fa-solid fa-certificate'
             },
             'item_chankhi_5': { 
                 name: 'Chân Khí Đan (Thần)', rarity: 5, 
                 desc: 'Vật phẩm trong truyền thuyết. Sử dụng nhận 50,000 Chân Khí.', 
                 type: 'potion', 
                 effect: { target: 'chan_khi', value: 50000 }, 
                 buyPrice: 475000000, currency: 'nl',
                 icon: 'fa-solid fa-sun'
             },

             // [NEW] --- THỨC ĂN SỦNG VẬT (PET FOOD) ---
             'pet_food_1': { 
                 name: 'Thịt Tươi (Sơ)', rarity: 1, 
                 desc: 'Thức ăn cơ bản cho sủng vật. Tăng 1,000 XP.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 1000 }, 
                 buyPrice: 5000, currency: 'nl',
                 icon: 'fa-solid fa-drumstick-bite'
             },
             'pet_food_2': { 
                 name: 'Thịt Loại A (Trung)', rarity: 2, 
                 desc: 'Thịt hảo hạng. Tăng 5,000 XP cho sủng vật.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 5000 }, 
                 buyPrice: 25000, currency: 'nl',
                 icon: 'fa-solid fa-bone'
             },
             'pet_food_3': { 
                 name: 'Linh Thú Đan (Cao)', rarity: 3, 
                 desc: 'Đan dược dành riêng cho linh thú. Tăng 25,000 XP.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 25000 }, 
                 buyPrice: 100000, currency: 'nl',
                 icon: 'fa-solid fa-cookie-bite'
             },
             'pet_food_4': { 
                 name: 'Thần Thú Huyết (Siêu)', rarity: 4, 
                 desc: 'Tinh huyết thần thú. Tăng 100,000 XP.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 100000 }, 
                 buyPrice: 500000, currency: 'nl',
                 icon: 'fa-solid fa-flask'
             },

             // [NEW] --- THỨC ĂN SỦNG VẬT CAO CẤP (100M - 5 TỶ) ---
             'pet_food_5': { 
                 name: 'Long Diên Hương (Thần)', rarity: 5, 
                 desc: 'Báu vật kết tinh từ rồng. Tăng 100,000,000 XP cho sủng vật.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 100000000 }, 
                 buyPrice: 10000, currency: 'knb', // Mua bằng KNB
                 icon: 'fa-solid fa-dragon text-red-400'
             },
             'pet_food_6': { 
                 name: 'Kỳ Lân Chi Giác (Siêu Thần)', rarity: 9, 
                 desc: 'Sừng của Kỳ Lân, chứa linh lực khổng lồ. Tăng 500,000,000 XP cho sủng vật.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 500000000 }, 
                 buyPrice: 45000, currency: 'knb',
                 icon: 'fa-solid fa-bolt text-yellow-300'
             },
             'pet_food_7': { 
                 name: 'Phượng Hoàng Tâm (Tối Thượng)', rarity: 11, 
                 desc: 'Trái tim rực lửa tái sinh. Tăng 2,000,000,000 XP cho sủng vật.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 2000000000 }, 
                 buyPrice: 150000, currency: 'knb',
                 icon: 'fa-solid fa-fire text-orange-500'
             },
             'pet_food_8': { 
                 name: 'Hỗn Độn Thú Nguyên (Vĩnh Hằng)', rarity: 14, 
                 desc: 'Tinh hoa của quái vật hỗn độn sơ khai. Tăng 5,000,000,000 XP cho sủng vật.', 
                 type: 'potion', 
                 effect: { target: 'pet_xp', value: 5000000000 }, 
                 buyPrice: 350000, currency: 'knb',
                 icon: 'fa-solid fa-atom text-rainbow-animation text-pulse-void-glow'
             },

             // ... (Scrolls Enchant section remains same) ...
             // --- NHÓM TẤN CÔNG CƠ BẢN (Rarity 3-4) ---
             'scroll_enchant_atk': {
                name: 'Phù Phép: Mãnh Hổ', rarity: 3, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Công Kích +50.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'atk', name: 'Công Kích', value: 50, isPercent: false },
                buyPrice: 2000, currency: 'knb'
             },
             'scroll_enchant_atk_p': {
                name: 'Phù Phép: Cuồng Nộ', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Công Kích +5%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'atk_p', name: 'Công Kích %', value: 5, isPercent: true },
                buyPrice: 6000, currency: 'knb'
             },
             'scroll_enchant_crit': {
                name: 'Phù Phép: Chí Mạng', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Chí Mạng +2%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'critChance', name: 'Chí Mạng', value: 2, isPercent: true },
                buyPrice: 5000, currency: 'knb'
             },
             'scroll_enchant_crit_dmg': {
                name: 'Phù Phép: Tàn Bạo', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Sát Thương Bạo Kích +10%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'critDamage', name: 'ST Chí Mạng', value: 10, isPercent: true },
                buyPrice: 7500, currency: 'knb'
             },
             'scroll_enchant_accuracy': {
                name: 'Phù Phép: Tâm Nhãn', rarity: 3, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Chính Xác +3%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'accuracy_p', name: 'Chính Xác', value: 3, isPercent: true },
                buyPrice: 3000, currency: 'knb'
             },

             // --- NHÓM PHÒNG THỦ & SINH TỒN CƠ BẢN (Rarity 3-4) ---
             'scroll_enchant_def': {
                name: 'Phù Phép: Kim Cang', rarity: 3, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Phòng Thủ +30.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'def', name: 'Phòng Thủ', value: 30, isPercent: false },
                buyPrice: 2000, currency: 'knb'
             },
             'scroll_enchant_def_p': {
                name: 'Phù Phép: Thiết Bích', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Phòng Thủ +5%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'def_p', name: 'Phòng Thủ %', value: 5, isPercent: true },
                buyPrice: 6000, currency: 'knb'
             },
             'scroll_enchant_hp': {
                name: 'Phù Phép: Trường Thọ', rarity: 3, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Sinh Lực +500.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'hp', name: 'Sinh Lực', value: 500, isPercent: false },
                buyPrice: 2000, currency: 'knb'
             },
             'scroll_enchant_hp_p': {
                name: 'Phù Phép: Bàn Thạch', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Sinh Lực +5%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'hp_p', name: 'Sinh Lực %', value: 5, isPercent: true },
                buyPrice: 6000, currency: 'knb'
             },
             'scroll_enchant_dodge': {
                name: 'Phù Phép: Huyễn Ảnh', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Né Tránh +2%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'dodgeChance', name: 'Né Tránh', value: 2, isPercent: true },
                buyPrice: 5000, currency: 'knb'
             },
             'scroll_enchant_block': {
                name: 'Phù Phép: Hộ Thân', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Chống Đỡ +3%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'block_chance_p', name: 'Chống Đỡ', value: 3, isPercent: true },
                buyPrice: 4500, currency: 'knb'
             },
             'scroll_enchant_anti_crit': {
                name: 'Phù Phép: Hộ Tâm', rarity: 3, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Kháng Bạo Kích +5%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'anti_crit_p', name: 'Kháng Bạo', value: 5, isPercent: true },
                buyPrice: 3000, currency: 'knb'
             },

             // --- NHÓM HỖ TRỢ & ĐẶC BIỆT (Rarity 3-5) ---
             'scroll_enchant_mana': {
                name: 'Phù Phép: Tụ Khí', rarity: 3, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Nội Lực +200.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'mana', name: 'Nội Lực', value: 200, isPercent: false },
                buyPrice: 2000, currency: 'knb'
             },
             'scroll_enchant_spd': {
                name: 'Phù Phép: Thần Tốc', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Thân Pháp +20.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'spd', name: 'Thân Pháp', value: 20, isPercent: false },
                buyPrice: 5000, currency: 'knb'
             },
             'scroll_enchant_lck': {
                name: 'Phù Phép: Hồng Phúc', rarity: 3, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: May Mắn +10.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'lck', name: 'May Mắn', value: 10, isPercent: false },
                buyPrice: 3000, currency: 'knb'
             },
             'scroll_enchant_ignore_def': {
                name: 'Phù Phép: Phá Giáp', rarity: 5, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Bỏ qua Phòng Thủ +2%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 2, isPercent: true },
                buyPrice: 12000, currency: 'knb'
             },
             'scroll_enchant_lifesteal': {
                name: 'Phù Phép: Hấp Huyết', rarity: 5, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Hút Sinh Lực +1%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'lifesteal', name: 'Hút Sinh Lực', value: 1, isPercent: true },
                buyPrice: 10000, currency: 'knb'
             },
             'scroll_enchant_manasteal': {
                name: 'Phù Phép: Phệ Linh', rarity: 5, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Hút Nội Lực +1%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'manasteal', name: 'Hút Nội Lực', value: 1, isPercent: true },
                buyPrice: 10000, currency: 'knb'
             },
             'scroll_enchant_xp': {
                name: 'Phù Phép: Thông Tuệ', rarity: 4, type: 'enchant_scroll',
                desc: 'Dùng để phù phép trang bị. Thêm dòng: Kinh Nghiệm +5%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'xp_boost', name: 'Kinh Nghiệm', value: 5, isPercent: true },
                buyPrice: 8000, currency: 'knb'
             },

             // [NEW] --- NHÓM CHÍ TÔN (MYTHIC - Rarity 9) ---
             'scroll_enchant_mythic_atk': {
                name: 'Chí Tôn: Chiến Thần Ấn', rarity: 9, type: 'enchant_scroll',
                desc: 'Phù phép cao cấp. Thêm dòng: Công Kích +15%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'atk_p', name: 'Công Kích %', value: 15, isPercent: true },
                buyPrice: 20000, currency: 'knb'
             },
             'scroll_enchant_mythic_hp': {
                name: 'Chí Tôn: Bất Diệt Thể', rarity: 9, type: 'enchant_scroll',
                desc: 'Phù phép cao cấp. Thêm dòng: Sinh Lực +15%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'hp_p', name: 'Sinh Lực %', value: 15, isPercent: true },
                buyPrice: 20000, currency: 'knb'
             },
             'scroll_enchant_mythic_lifesteal': {
                name: 'Chí Tôn: Huyết Ma Chú', rarity: 9, type: 'enchant_scroll',
                desc: 'Phù phép tà đạo. Thêm dòng: Hút Sinh Lực +3%.',
                icon: 'fa-solid fa-droplet',
                stat: { id: 'lifesteal', name: 'Hút Sinh Lực', value: 3, isPercent: true },
                buyPrice: 30000, currency: 'knb'
             },
             'scroll_enchant_mythic_crit_dmg': {
                name: 'Chí Tôn: Long Nộ', rarity: 9, type: 'enchant_scroll',
                desc: 'Sức giận của rồng. Thêm dòng: ST Chí Mạng +30%.',
                icon: 'fa-solid fa-dragon',
                stat: { id: 'critDamage', name: 'ST Chí Mạng', value: 30, isPercent: true },
                buyPrice: 35000, currency: 'knb'
             },

             // [NEW] --- NHÓM SIÊU THẦN (SUPER GODLY - Rarity 10) ---
             'scroll_enchant_super_atk': {
                name: 'Chân Ngôn: Diệt Thế', rarity: 10, type: 'enchant_scroll',
                desc: 'Lời nguyền hủy diệt thế giới. Thêm dòng: Công Kích +30%.',
                icon: 'fa-solid fa-scroll',
                stat: { id: 'atk_p', name: 'Công Kích %', value: 30, isPercent: true },
                buyPrice: 100000, currency: 'knb'
             },
             'scroll_enchant_super_def': {
                name: 'Chân Ngôn: Vĩnh Cửu', rarity: 10, type: 'enchant_scroll',
                desc: 'Phòng ngự tuyệt đối. Thêm dòng: Phòng Thủ +30%.',
                icon: 'fa-solid fa-shield-halved',
                stat: { id: 'def_p', name: 'Phòng Thủ %', value: 30, isPercent: true },
                buyPrice: 100000, currency: 'knb'
             },
             'scroll_enchant_super_ignore': {
                name: 'Chân Ngôn: Hư Vô', rarity: 10, type: 'enchant_scroll',
                desc: 'Biến mọi phòng ngự thành hư vô. Thêm dòng: Bỏ qua Phòng Thủ +10%.',
                icon: 'fa-solid fa-ghost',
                stat: { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 10, isPercent: true },
                buyPrice: 150000, currency: 'knb'
             },

             // [NEW] --- NHÓM TỐI THƯỢNG (ULTIMATE - Rarity 11) ---
             'scroll_enchant_ultimate_xp': {
                name: 'Thiên Thư: Vạn Pháp Quy Tông', rarity: 11, type: 'enchant_scroll',
                desc: 'Thấu hiểu vạn vật. Thêm dòng: Kinh Nghiệm +50%.',
                icon: 'fa-solid fa-book-journal-whills',
                stat: { id: 'xp_boost', name: 'Kinh Nghiệm', value: 50, isPercent: true },
                buyPrice: 500000, currency: 'knb'
             },
             'scroll_enchant_ultimate_all': {
                name: 'Thần Điển: Nghịch Thiên Cải Mệnh', rarity: 11, type: 'enchant_scroll',
                desc: 'Thay đổi số mệnh. Thêm dòng: May Mắn +100.',
                icon: 'fa-solid fa-dice-d20',
                stat: { id: 'lck', name: 'May Mắn', value: 100, isPercent: false },
                buyPrice: 800000, currency: 'knb'
             },
             'scroll_enchant_ultimate_power': {
                name: 'Thần Điển: Thái Cổ Thần Lực', rarity: 11, type: 'enchant_scroll',
                desc: 'Sức mạnh của thần thái cổ. Thêm dòng: Công Kích +5000.',
                icon: 'fa-solid fa-hand-fist',
                stat: { id: 'atk', name: 'Công Kích', value: 5000, isPercent: false },
                buyPrice: 1000000, currency: 'knb'
             },

             // [NEW] --- NHÓM HỖN ĐỘN (CHAOS - Rarity 12 - Song Tu Chỉ Số) ---
             'scroll_enchant_chaos_atk_lifesteal': {
                name: 'Hỗn Độn: Ma Thần Lực', rarity: 12, type: 'enchant_scroll',
                desc: 'Sức mạnh ma thần. Thêm dòng: Công Kích +40% VÀ Hút Máu +5%.',
                icon: 'fa-solid fa-skull-crossbones',
                stats: [
                    { id: 'atk_p', name: 'Công Kích %', value: 40, isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 5, isPercent: true }
                ],
                buyPrice: 2000000, currency: 'knb'
             },
             'scroll_enchant_chaos_def_hp': {
                name: 'Hỗn Độn: Bất Hoại Thể', rarity: 12, type: 'enchant_scroll',
                desc: 'Thân thể bất hoại. Thêm dòng: Sinh Lực +40% VÀ Phòng Thủ +40%.',
                icon: 'fa-solid fa-shield-virus',
                stats: [
                    { id: 'hp_p', name: 'Sinh Lực %', value: 40, isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 40, isPercent: true }
                ],
                buyPrice: 2000000, currency: 'knb'
             },

             // [NEW] --- NHÓM HỒNG HOANG (PRIMORDIAL - Rarity 13 - Phá Vỡ Giới Hạn) ---
             'scroll_enchant_primordial_offense': {
                name: 'Hồng Hoang: Khai Thiên Tịch Địa', rarity: 13, type: 'enchant_scroll',
                desc: 'Sức mạnh khai thiên. Thêm: ST Bạo Kích +100% VÀ Bỏ qua DEF +15%.',
                icon: 'fa-solid fa-hammer',
                stats: [
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 100, isPercent: true },
                    { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 15, isPercent: true }
                ],
                buyPrice: 5000000, currency: 'knb'
             },
             'scroll_enchant_primordial_speed': {
                name: 'Hồng Hoang: Thời Không Bộ', rarity: 13, type: 'enchant_scroll',
                desc: 'Bước đi trong thời không. Thêm: Thân Pháp +300 VÀ Né Tránh +10%.',
                icon: 'fa-solid fa-wind',
                stats: [
                    { id: 'spd', name: 'Thân Pháp', value: 300, isPercent: false },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 10, isPercent: true }
                ],
                buyPrice: 5000000, currency: 'knb'
             },

             // [NEW] --- NHÓM VĨNH HẰNG (ETERNAL - Rarity 14 - Chỉ Số Tối Thượng) ---
             'scroll_enchant_eternal_power': {
                name: 'Vĩnh Hằng: Chúa Tể Chi Uy', rarity: 14, type: 'enchant_scroll',
                desc: 'Quyền năng của chúa tể. Thêm: Công Kích +100%!',
                icon: 'fa-solid fa-crown',
                stat: { id: 'atk_p', name: 'Công Kích %', value: 100, isPercent: true },
                buyPrice: 10000000, currency: 'knb'
             },
             'scroll_enchant_eternal_life': {
                name: 'Vĩnh Hằng: Bất Tử Chi Hồn', rarity: 14, type: 'enchant_scroll',
                desc: 'Linh hồn bất tử. Thêm: Sinh Lực +100%!',
                icon: 'fa-solid fa-heart-circle-bolt',
                stat: { id: 'hp_p', name: 'Sinh Lực %', value: 100, isPercent: true },
                buyPrice: 10000000, currency: 'knb'
             },

             // [NEW] --- NHÓM THIÊN ĐẠO (HEAVENLY DAO - Rarity 15 - Sức Mạnh Tuyệt Đối) ---
             'scroll_enchant_dao_all': {
                name: 'Thiên Đạo: Vô Cực', rarity: 15, type: 'enchant_scroll',
                desc: 'Đạt tới cảnh giới vô cực. Thêm: Toàn bộ chỉ số cơ bản +20%.',
                icon: 'fa-solid fa-infinity',
                stats: [
                    { id: 'hp_p', name: 'HP %', value: 20, isPercent: true },
                    { id: 'mana_p', name: 'Mana %', value: 20, isPercent: true },
                    { id: 'atk_p', name: 'Công %', value: 20, isPercent: true },
                    { id: 'def_p', name: 'Thủ %', value: 20, isPercent: true },
                    { id: 'spd_p', name: 'Thân %', value: 20, isPercent: true },
                    { id: 'lck_p', name: 'May %', value: 20, isPercent: true }
                ],
                buyPrice: 20000000, currency: 'knb'
             },
             'scroll_enchant_dao_destroy': {
                name: 'Thiên Đạo: Hủy Diệt', rarity: 15, type: 'enchant_scroll',
                desc: 'Sức mạnh hủy diệt thiên địa. Thêm: Công Kích +200% VÀ ST Bạo Kích +200%.',
                icon: 'fa-solid fa-burst',
                stats: [
                    { id: 'atk_p', name: 'Công Kích %', value: 200, isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 200, isPercent: true }
                ],
                buyPrice: 25000000, currency: 'knb'
             },
             'scroll_enchant_dao_immortal': {
                name: 'Thiên Đạo: Bất Tử', rarity: 15, type: 'enchant_scroll',
                desc: 'Thân thể bất tử bất diệt. Thêm: Sinh Lực +300% VÀ Hồi Phục +10% (Hút Máu).',
                icon: 'fa-solid fa-ankh',
                stats: [
                    { id: 'hp_p', name: 'Sinh Lực %', value: 300, isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 10, isPercent: true }
                ],
                buyPrice: 25000000, currency: 'knb'
             },

             // [NEW] --- NHÓM SÁNG THẾ (CREATOR - Rarity 16 - Game Breaking) ---
             'scroll_enchant_creator_time': {
                name: 'Sáng Thế: Thời Không', rarity: 16, type: 'enchant_scroll',
                desc: 'Điều khiển thời gian. Thêm: Thân Pháp +1000, Tốc Độ Đánh +50% VÀ Bỏ qua DEF +50%.',
                icon: 'fa-solid fa-clock-rotate-left',
                stats: [
                    { id: 'spd', name: 'Thân Pháp', value: 1000, isPercent: false },
                    { id: 'spd_p', name: 'Tốc Độ Đánh', value: 50, isPercent: true },
                    { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 50, isPercent: true }
                ],
                buyPrice: 50000000, currency: 'knb'
             },
             'scroll_enchant_creator_origin': {
                name: 'Sáng Thế: Khởi Nguyên', rarity: 16, type: 'enchant_scroll',
                desc: 'Nguồn gốc vạn vật. Thêm: Toàn bộ chỉ số +50% VÀ Kinh Nghiệm +200%.',
                icon: 'fa-solid fa-atom',
                stats: [
                    { id: 'hp_p', name: 'HP %', value: 50, isPercent: true },
                    { id: 'atk_p', name: 'Công %', value: 50, isPercent: true },
                    { id: 'def_p', name: 'Thủ %', value: 50, isPercent: true },
                    { id: 'spd_p', name: 'Thân %', value: 50, isPercent: true },
                    { id: 'xp_boost', name: 'Kinh Nghiệm', value: 200, isPercent: true }
                ],
                buyPrice: 100000000, currency: 'knb'
             },

             // [NEW] --- NHÓM ĐA DÒNG (MULTI-STAT) - MUA BẰNG KNB + DANH VỌNG ---
             'scroll_enchant_dual_atk_def': {
                name: 'Song Tu: Long Tranh Hổ Đấu', rarity: 6, type: 'enchant_scroll',
                desc: 'Vừa công vừa thủ. Thêm: Công Kích +1000 VÀ Phòng Thủ +500.',
                icon: 'fa-solid fa-dragon',
                stats: [
                    { id: 'atk', name: 'Công Kích', value: 1000, isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 500, isPercent: false }
                ],
                mixCosts: { kimNguyenBao: 10000, danhVong: 500 }
             },
             'scroll_enchant_dual_spd_crit': {
                name: 'Song Tu: Phong Lâm Hỏa Sơn', rarity: 7, type: 'enchant_scroll',
                desc: 'Nhanh như gió, mạnh như lửa. Thêm: Thân Pháp +100 VÀ Chí Mạng +5%.',
                icon: 'fa-solid fa-wind',
                stats: [
                    { id: 'spd', name: 'Thân Pháp', value: 100, isPercent: false },
                    { id: 'critChance', name: 'Chí Mạng', value: 5, isPercent: true }
                ],
                mixCosts: { kimNguyenBao: 15000, danhVong: 800 }
             },
             'scroll_enchant_dual_hp_lifesteal': {
                name: 'Song Tu: Thiên Địa Đồng Thọ', rarity: 8, type: 'enchant_scroll',
                desc: 'Sức sống vô tận. Thêm: Sinh Lực +10000 VÀ Hút Máu +2%.',
                icon: 'fa-solid fa-tree',
                stats: [
                    { id: 'hp', name: 'Sinh Lực', value: 10000, isPercent: false },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 2, isPercent: true }
                ],
                mixCosts: { kimNguyenBao: 25000, danhVong: 1500 }
             },
             'scroll_enchant_tri_general': {
                name: 'Tam Hợp: Càn Khôn Nhất Trịch', rarity: 9, type: 'enchant_scroll',
                desc: 'Tinh hoa tam giới. Thêm: Công +10%, Thủ +10%, Máu +10%.',
                icon: 'fa-solid fa-yin-yang',
                stats: [
                    { id: 'atk_p', name: 'Công Kích %', value: 10, isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 10, isPercent: true },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 10, isPercent: true }
                ],
                mixCosts: { kimNguyenBao: 50000, danhVong: 3000 }
             },
             
             // [NEW] Phôi Chế Tạo Trang Bị (Trắng) - Bán bằng KNB
             'crafting_blank_white': {
                name: 'Phôi Chế Tạo Trang Bị (Trắng)', 
                rarity: 11, // Rarity 11 triggers rainbow effect
                desc: 'Nguyên liệu chế tác thần bí chứa đựng sức mạnh vô song.<br><span class="text-gray-400">Chỉ số ẩn: Sinh lực +100, Nội lực +100, Công Kỹ +1%, Tấn công +100, Phòng thủ +100, Kinh Nghiệm +10%, Hút SL 1%, Hút NL 1%.</span>',
                type: 'material', 
                icon: 'fa-solid fa-cube',
                buyPrice: 5000, // [MODIFIED] Giá tăng lên 5000
                currency: 'knb' // Mua bằng KNB
             },

             // [NEW] Phôi Chế Tạo Vũ Khí (Trắng)
             'crafting_blank_weapon_white': {
                name: 'Phôi Chế Tạo Vũ Khí (Trắng)', 
                rarity: 11, 
                // [MODIFIED] Cập nhật mô tả chỉ số mới
                desc: 'Phôi vũ khí chứa sát khí kinh người.<br><span class="text-gray-400">Chỉ số ẩn: Công kích +150, Công kích +5%, ST Chí Mạng +50%, Chính xác +5%, Tốc Độ đánh +30%, Bỏ qua phòng thủ +5%, Kinh Nghiệm +200%, Kĩ năng vốn có +2.</span>',
                type: 'material', 
                icon: 'fa-solid fa-khanda',
                buyPrice: 20000, // [MODIFIED] Giá điều chỉnh lên 20.000 KNB
                currency: 'knb' 
             },

             // [NEW] Phôi Chế Tạo Y Phục (Trắng)
             'crafting_blank_armor_white': {
                name: 'Phôi Chế Tạo Y Phục (Trắng)', 
                rarity: 11, 
                desc: 'Phôi y phục phòng thủ tuyệt đối.<br><span class="text-gray-400">Chỉ số ẩn: Sinh lực +100, Sinh lực +5%, Nội lực +100, Nội lực +5%, Phòng thủ +100, Phòng thủ +5%, Né tránh +2%, Kĩ năng vốn có +2.</span>',
                type: 'material', 
                icon: 'fa-solid fa-shirt',
                buyPrice: 20000, 
                currency: 'knb' 
             },

             'item_hp_small': { 
                 name: 'Tiểu Hồng Dược', rarity: 1, 
                 desc: 'Hồi phục 10% Sinh lực tối đa.', // [MODIFIED] Desc
                 type: 'potion', 
                 effect: { target: 'hp', value: 10, isPercent: true }, // [MODIFIED] Value 10%, isPercent added
                 buyPrice: 25,
                 icon: 'fa-solid fa-flask' // [NEW] Icon for potion
             },
             'item_mana_small': { 
                 name: 'Tiểu Lam Dược', rarity: 1, 
                 desc: 'Hồi phục 20 Nội Lực.', 
                 type: 'potion', 
                 effect: { target: 'mana', value: 20 }, 
                 buyPrice: 15,
                 icon: 'fa-solid fa-flask' // [NEW] Icon for potion
             },
             // [NEW] Higher Tier Potions
             'item_hp_medium': { 
                 name: 'Đại Hồng Dược', rarity: 2, 
                 desc: 'Hồi phục 250 Sinh Lực.', 
                 type: 'potion', 
                 effect: { target: 'hp', value: 250 }, 
                 buyPrice: 100,
                 icon: 'fa-solid fa-flask' // [NEW] Icon for potion
             },
             'item_mana_medium': { 
                 name: 'Đại Lam Dược', rarity: 2, 
                 desc: 'Hồi phục 100 Nội Lực.', 
                 type: 'potion', 
                 effect: { target: 'mana', value: 100 }, 
                 buyPrice: 75,
                 icon: 'fa-solid fa-flask' // [NEW] Icon for potion
             },
             // [NEW] Highest Tier Potions
             'item_hp_large': { 
                 name: 'Tinh Khiết Hồng Dược', rarity: 3, 
                 desc: 'Hồi phục 5000 Sinh Lực.', 
                 type: 'potion', 
                 effect: { target: 'hp', value: 5000 }, 
                 buyPrice: 1500,
                 icon: 'fa-solid fa-flask' // [NEW] Icon for potion
             },
             'item_mana_large': { 
                 name: 'Tinh Khiết Lam Dược', rarity: 3, 
                 desc: 'Hồi phục 5000 Nội Lực.', 
                 type: 'potion', 
                 effect: { target: 'mana', value: 5000 }, 
                 buyPrice: 1000,
                 icon: 'fa-solid fa-flask' // [NEW] Icon for potion
             },
             
             // [MODIFIED] Food Items (Changed to Fixed XP)
             'food_xp_1': { 
                 name: 'Canh Cá XP (Sơ)', rarity: 2, 
                 desc: 'Một món canh bồi bổ. Nhận 5,000,000 Kinh nghiệm.', // [MODIFIED] Desc
                 type: 'potion', 
                 effect: { target: 'xp', value: 5000000, isPercent: false }, // [MODIFIED] Value 5M fixed
                 sellPrice: 10,
                 icon: 'fa-solid fa-bowl-food' // [NEW] Icon for food
             },
             'food_xp_2': { 
                 name: 'Canh Cá XP (Trung)', rarity: 3, 
                 desc: 'Một món canh hảo hạng. Nhận 25,000,000 Kinh nghiệm.', // [MODIFIED] Desc
                 type: 'potion', 
                 effect: { target: 'xp', value: 25000000, isPercent: false }, // [MODIFIED] Value 25M fixed
                 sellPrice: 40,
                 icon: 'fa-solid fa-bowl-food' // [NEW] Icon for food
             },
             'food_xp_3': { 
                 name: 'Canh Cá XP (Cao)', rarity: 4, 
                 desc: 'Một món canh thần thánh. Nhận 100,000,000 Kinh nghiệm.', // [MODIFIED] Desc
                 type: 'potion', 
                 effect: { target: 'xp', value: 100000000, isPercent: false }, // [MODIFIED] Value 100M fixed
                 sellPrice: 160,
                 icon: 'fa-solid fa-bowl-food' // [NEW] Icon for food
             },
             'food_xp_4': { 
                 name: 'Canh Cá XP (Thần)', rarity: 5, 
                 desc: 'Tuyệt phẩm trần gian. Nhận 500,000,000 Kinh nghiệm.', // [MODIFIED] Desc
                 type: 'potion', 
                 effect: { target: 'xp', value: 500000000, isPercent: false }, // [MODIFIED] Value 500M fixed
                 sellPrice: 1300,
                 icon: 'fa-solid fa-bowl-food' // [NEW] Icon for food
             },

            // [NEW] --- Đồ Phổ Sơ Cấp (Tier 1 - 9) - Cập nhật theo yêu cầu ---
            'blueprint_thanh_cau': { 
                name: 'Đồ Phổ Thanh Câu', rarity: 2, type: 'blueprint', 
                desc: 'Rèn trang bị Thanh Câu. Khởi đầu của sức mạnh hoàng kim.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 100, danhVong: 100, diemCongHien: 200 },
                statMultiplier: 1.1,
                percentBonus: 1,
                craftCostKNB: 1000,
                tier: 1
            },
            'blueprint_van_loc': { 
                name: 'Đồ Phổ Vân Lộc', rarity: 3, type: 'blueprint', 
                desc: 'Rèn trang bị Vân Lộc. Nhẹ tựa mây trời, lộc đến nhà.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 250, danhVong: 250, diemCongHien: 500 },
                statMultiplier: 1.15,
                percentBonus: 2,
                craftCostKNB: 2500,
                tier: 2
            },
            'blueprint_thuong_lang': { 
                name: 'Đồ Phổ Thương Lang', rarity: 4, type: 'blueprint', 
                desc: 'Rèn trang bị Thương Lang. Sức mạnh dã thú.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 500, danhVong: 500, diemCongHien: 1000 },
                statMultiplier: 1.2,
                percentBonus: 3,
                craftCostKNB: 5000,
                tier: 3
            },
            'blueprint_huyen_vien': { 
                name: 'Đồ Phổ Huyền Viên', rarity: 5, type: 'blueprint', 
                desc: 'Rèn trang bị Huyền Viên. Bí ẩn và mạnh mẽ.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 1000, danhVong: 1000, diemCongHien: 2000 },
                statMultiplier: 1.25,
                percentBonus: 4,
                craftCostKNB: 10000,
                tier: 4
            },
            'blueprint_tu_mang': { 
                name: 'Đồ Phổ Tử Mãng', rarity: 5, type: 'blueprint', 
                desc: 'Rèn trang bị Tử Mãng. Uy lực như mãng xà tím.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 2000, danhVong: 2000, diemCongHien: 4000 },
                statMultiplier: 1.3,
                percentBonus: 5,
                craftCostKNB: 20000,
                tier: 5
            },
            'blueprint_kim_o': { 
                name: 'Đồ Phổ Kim Ô', rarity: 6, type: 'blueprint', 
                desc: 'Rèn trang bị Kim Ô. Rực rỡ như quạ vàng mặt trời.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 3500, danhVong: 3500, diemCongHien: 7000 },
                statMultiplier: 1.35,
                percentBonus: 6,
                craftCostKNB: 35000,
                tier: 6
            },
            'blueprint_bach_ho': { 
                name: 'Đồ Phổ Bạch Hổ', rarity: 7, type: 'blueprint', 
                desc: 'Rèn trang bị Bạch Hổ. Sát phạt chi khí.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 5000, danhVong: 5000, diemCongHien: 10000 },
                statMultiplier: 1.4,
                percentBonus: 7,
                craftCostKNB: 50000,
                tier: 7
            },
            'blueprint_dang_long': { 
                name: 'Đồ Phổ Đằng Long', rarity: 8, type: 'blueprint', 
                desc: 'Rèn trang bị Đằng Long. Rồng bay lên trời.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 7500, danhVong: 7500, diemCongHien: 15000 },
                statMultiplier: 1.45,
                percentBonus: 8,
                craftCostKNB: 75000,
                tier: 8
            },
            'blueprint_tinh_suong': { 
                name: 'Đồ Phổ Tinh Sương', rarity: 9, type: 'blueprint', 
                desc: 'Rèn trang bị Tinh Sương. Lạnh lẽo như sương sao.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 10000, danhVong: 10000, diemCongHien: 20000 },
                statMultiplier: 1.5,
                percentBonus: 9,
                craftCostKNB: 100000,
                tier: 9
            },

            // [NEW] --- Đồ Phổ Cao Cấp (Tier 10 - 15) - Giá mềm hơn ---
            'blueprint_nhat_nguyet': { 
                name: 'Đồ Phổ Nhật Nguyệt', rarity: 10, type: 'blueprint', 
                desc: 'Rèn trang bị Nhật Nguyệt. Hấp thụ tinh hoa mặt trời và mặt trăng.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 12000, danhVong: 12000, diemCongHien: 25000 },
                statMultiplier: 1.65,
                percentBonus: 10,
                craftCostKNB: 150000,
                tier: 10
            },
            'blueprint_can_khon': { 
                name: 'Đồ Phổ Càn Khôn', rarity: 11, type: 'blueprint', 
                desc: 'Rèn trang bị Càn Khôn. Chứa đựng sức mạnh trời đất.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 18000, danhVong: 18000, diemCongHien: 35000 },
                statMultiplier: 1.65,
                percentBonus: 11,
                craftCostKNB: 250000,
                tier: 11
            },
            'blueprint_hu_khong': { 
                name: 'Đồ Phổ Hư Không', rarity: 12, type: 'blueprint', 
                desc: 'Rèn trang bị Hư Không. Xuyên thấu mọi không gian.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 25000, danhVong: 25000, diemCongHien: 50000 },
                statMultiplier: 1.65,
                percentBonus: 12,
                craftCostKNB: 400000,
                tier: 12
            },
            'blueprint_thai_co': { 
                name: 'Đồ Phổ Thái Cổ', rarity: 13, type: 'blueprint', 
                desc: 'Rèn trang bị Thái Cổ. Sức mạnh từ thuở hồng hoang.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 35000, danhVong: 35000, diemCongHien: 75000 },
                statMultiplier: 1.65,
                percentBonus: 13,
                craftCostKNB: 600000,
                tier: 13
            },
            'blueprint_hon_don': { 
                name: 'Đồ Phổ Hỗn Độn', rarity: 14, type: 'blueprint', 
                desc: 'Rèn trang bị Hỗn Độn. Quay về trạng thái hỗn mang.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 50000, danhVong: 50000, diemCongHien: 100000 },
                statMultiplier: 1.65,
                percentBonus: 14,
                craftCostKNB: 900000,
                tier: 14
            },
            'blueprint_hong_mong': { 
                name: 'Đồ Phổ Hồng Mông', rarity: 15, type: 'blueprint', 
                desc: 'Rèn trang bị Hồng Mông. Khởi nguyên của vạn vật, sức mạnh tối thượng.',
                icon: 'fa-solid fa-scroll',
                mixCosts: { uyDanh: 75000, danhVong: 75000, diemCongHien: 150000 },
                statMultiplier: 1.65,
                percentBonus: 15,
                craftCostKNB: 1500000,
                tier: 15
            },

            // [NEW] --- Đồ Phổ Siêu Thoát (Tier 16 - 20) - Giá "cày được" ---
            'blueprint_sang_the': { 
                name: 'Đồ Phổ Sáng Thế', rarity: 16, type: 'blueprint', 
                desc: 'Rèn trang bị Sáng Thế. Nắm giữ quyền năng kiến tạo vũ trụ.',
                icon: 'fa-solid fa-sun',
                mixCosts: { uyDanh: 120000, danhVong: 120000, diemCongHien: 250000 },
                statMultiplier: 1.65,
                percentBonus: 16,
                craftCostKNB: 2500000,
                tier: 16
            },
            'blueprint_hu_vo': { 
                name: 'Đồ Phổ Hư Vô', rarity: 16, type: 'blueprint', 
                desc: 'Rèn trang bị Hư Vô. Biến mọi thứ trở về cõi không.',
                icon: 'fa-solid fa-ghost',
                mixCosts: { uyDanh: 200000, danhVong: 200000, diemCongHien: 400000 },
                statMultiplier: 1.65,
                percentBonus: 17,
                craftCostKNB: 4000000,
                tier: 17
            },
            'blueprint_vinh_hang': { 
                name: 'Đồ Phổ Vĩnh Hằng', rarity: 16, type: 'blueprint', 
                desc: 'Rèn trang bị Vĩnh Hằng. Vượt qua dòng chảy thời gian, bất diệt.',
                icon: 'fa-solid fa-infinity',
                mixCosts: { uyDanh: 350000, danhVong: 350000, diemCongHien: 700000 },
                statMultiplier: 1.65,
                percentBonus: 18,
                craftCostKNB: 6500000,
                tier: 18
            },
            'blueprint_thien_dao': { 
                name: 'Đồ Phổ Thiên Đạo', rarity: 16, type: 'blueprint', 
                desc: 'Rèn trang bị Thiên Đạo. Hóa thân thành quy luật của vũ trụ.',
                icon: 'fa-solid fa-yin-yang',
                mixCosts: { uyDanh: 600000, danhVong: 600000, diemCongHien: 1200000 },
                statMultiplier: 1.65,
                percentBonus: 19,
                craftCostKNB: 10000000,
                tier: 19
            },
            'blueprint_chua_te': { 
                name: 'Đồ Phổ Chúa Tể', rarity: 16, type: 'blueprint', 
                desc: 'Rèn trang bị Chúa Tể. Đứng trên vạn vật, sức mạnh tuyệt đối.',
                icon: 'fa-solid fa-crown',
                mixCosts: { uyDanh: 1000000, danhVong: 1000000, diemCongHien: 2500000 },
                statMultiplier: 1.65,
                percentBonus: 20,
                craftCostKNB: 20000000,
                tier: 20
            },
            // [END NEW]

             // [NEW] Disciple XP Pill
             'disciple_xp_pill_1': {
                name: 'Đệ Tử Tu Luyện Đan', rarity: 2,
                desc: 'Cho Đệ tử sử dụng để nhận 10000 Kinh nghiệm.',
                type: 'potion', // Use 'potion' type so it's stackable
                effect: { target: 'disciple_xp', value: 10000 }, // Custom effect
                sellPrice: 50, // Can be sold
                icon: 'fa-solid fa-pills' // [NEW] Icon for disciple pill
             },
             // ... existing pills ...
             'disciple_xp_pill_2': { name: 'Đệ Tử Đan (Trung)', rarity: 3, desc: 'Cho Đệ tử sử dụng để nhận 500000 Kinh nghiệm.', type: 'potion', effect: { target: 'disciple_xp', value: 500000 }, sellPrice: 200, icon: 'fa-solid fa-pills' },
             'disciple_xp_pill_3': { name: 'Đệ Tử Đan (Cao)', rarity: 4, desc: 'Cho Đệ tử sử dụng để nhận 2500000 Kinh nghiệm.', type: 'potion', effect: { target: 'disciple_xp', value: 2500000 }, sellPrice: 800, icon: 'fa-solid fa-pills' },
             'disciple_atk_pill_1': { name: 'Luyện Cốt Đan (Sơ)', rarity: 2, desc: 'Tăng vĩnh viễn +2 Công Kích cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'atk', value: 2 }, sellPrice: 1000, icon: 'fa-solid fa-fist-raised' },
             'disciple_hp_pill_1': { name: 'Tẩy Tủy Đan (Sơ)', rarity: 2, desc: 'Tăng vĩnh viễn +10 Sinh Lực cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'hp', value: 10 }, sellPrice: 1000, icon: 'fa-solid fa-heart-pulse' },
             'disciple_def_pill_1': { name: 'Thiết Cốt Đan (Sơ)', rarity: 2, desc: 'Tăng vĩnh viễn +2 Phòng Thủ cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'def', value: 2 }, sellPrice: 1000, icon: 'fa-solid fa-shield-halved' },
             'disciple_spd_pill_1': { name: 'Linh Tốc Đan (Sơ)', rarity: 2, desc: 'Tăng vĩnh viễn +2 Thân Pháp cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'spd', value: 2 }, sellPrice: 1000, icon: 'fa-solid fa-wind' },
             // [NEW] --- Tier 2 (Trung Cấp) Stat Pills ---
             'disciple_atk_pill_2': { name: 'Luyện Cốt Đan (Trung)', rarity: 3, desc: 'Tăng vĩnh viễn +10 Công Kích cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'atk', value: 10 }, sellPrice: 5000, icon: 'fa-solid fa-fist-raised' },
             'disciple_hp_pill_2': { name: 'Tẩy Tủy Đan (Trung)', rarity: 3, desc: 'Tăng vĩnh viễn +50 Sinh Lực cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'hp', value: 50 }, sellPrice: 5000, icon: 'fa-solid fa-heart-pulse' },
             'disciple_def_pill_2': { name: 'Thiết Cốt Đan (Trung)', rarity: 3, desc: 'Tăng vĩnh viễn +10 Phòng Thủ cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'def', value: 10 }, sellPrice: 5000, icon: 'fa-solid fa-shield-halved' },
             'disciple_spd_pill_2': { name: 'Linh Tốc Đan (Trung)', rarity: 3, desc: 'Tăng vĩnh viễn +10 Thân Pháp cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'spd', value: 10 }, sellPrice: 5000, icon: 'fa-solid fa-wind' },
             // [NEW] --- Tier 3 (Cao Cấp) Stat Pills ---
             'disciple_atk_pill_3': { name: 'Luyện Cốt Đan (Cao)', rarity: 4, desc: 'Tăng vĩnh viễn +25 Công Kích cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'atk', value: 25 }, sellPrice: 20000, icon: 'fa-solid fa-fist-raised' },
             'disciple_hp_pill_3': { name: 'Tẩy Tủy Đan (Cao)', rarity: 4, desc: 'Tăng vĩnh viễn +125 Sinh Lực cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'hp', value: 125 }, sellPrice: 20000, icon: 'fa-solid fa-heart-pulse' },
             'disciple_def_pill_3': { name: 'Thiết Cốt Đan (Cao)', rarity: 4, desc: 'Tăng vĩnh viễn +25 Phòng Thủ cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'def', value: 25 }, sellPrice: 20000, icon: 'fa-solid fa-shield-halved' },
             'disciple_spd_pill_3': { name: 'Linh Tốc Đan (Cao)', rarity: 4, desc: 'Tăng vĩnh viễn +25 Thân Pháp cơ bản cho đệ tử.', type: 'potion', effect: { target: 'disciple_stat', stat: 'spd', value: 25 }, sellPrice: 20000, icon: 'fa-solid fa-wind' },
        };

        // *** NEW: Shop Equipment Database ***
        // [MODIFIED] Replaced with new tiered items
        const SHOP_EQUIPMENT_DB = {
            // [NEW] --- Set An Bang Định Quốc (Mua bằng điểm PvP) ---
            'ab_weapon': {
                baseId: 'w6', name: "Vũ Khí An Bang", type: 'weapon', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'atk_p', name: 'Công Kích %', value: 30, display: 'Công Kích +30%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 10, display: 'Chí Mạng +10%', isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 60, display: 'ST Chí Mạng +60%', isPercent: true },
                    { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 20, display: 'Bỏ qua DEF +20%', isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 7, display: 'Hút Sinh Lực 7%', isPercent: true }
                ],
                buyPrice: 10000, currency: 'diemVinhDuLienDau' // 10k Vinh Dự
            },
            'ab_armor': {
                baseId: 'a6', name: "Giáp An Bang", type: 'armor', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'hp_p', name: 'Sinh Lực %', value: 30, display: 'Sinh Lực +30%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 30, display: 'Phòng Thủ +30%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 12, display: 'Né Tránh +12%', isPercent: true },
                    { id: 'hp', name: 'Sinh Lực', value: 6500, display: 'Sinh Lực +6500', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 650, display: 'Phòng Thủ +650', isPercent: false }
                ],
                buyPrice: 10000, currency: 'diemVinhDuLienDau' // 10k Vinh Dự
            },
            'ab_acc1': {
                baseId: 'r4', name: "Phù An Bang", type: 'accessory', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'atk_p', name: 'Công Kích %', value: 12, display: 'Công Kích +12%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 12, display: 'Phòng Thủ +12%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 7, display: 'Chí Mạng +7%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 7, display: 'Né Tránh +7%', isPercent: true },
                    { id: 'lck', name: 'May Mắn', value: 60, display: 'May Mắn +60', isPercent: false }
                ],
                buyPrice: 5000, currency: 'diemVinhDuLienDau' // [FIX] Đổi sang Vinh Dự
            },
            'ab_acc2': {
                baseId: 'r5', name: "Chỉ An Bang", type: 'accessory', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'hp_p', name: 'Sinh Lực %', value: 18, display: 'Sinh Lực +18%', isPercent: true },
                    { id: 'atk', name: 'Công Kích', value: 1300, display: 'Công Kích +1300', isPercent: false },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 50, display: 'ST Chí Mạng +50%', isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 5, display: 'Hút Sinh Lực 5%', isPercent: true },
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 5, display: 'Hút Nội Lực 5%', isPercent: true }
                ],
                buyPrice: 5000, currency: 'diemVinhDuLienDau' // [FIX] Đổi sang Vinh Dự
            },
            'ab_acc3': {
                baseId: 'r6', name: "Bội An Bang", type: 'accessory', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'spd_p', name: 'Thân Pháp %', value: 18, display: 'Thân Pháp +18%', isPercent: true },
                    { id: 'spd', name: 'Thân Pháp', value: 120, display: 'Thân Pháp +120', isPercent: false },
                    { id: 'xp_boost', name: 'Tăng KN', value: 120, display: 'Tăng KN +120%', isPercent: true },
                    { id: 'atk_p', name: 'Công Kích %', value: 10, display: 'Công Kích +10%', isPercent: true },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 10, display: 'Sinh Lực +10%', isPercent: true }
                ],
                buyPrice: 5000, currency: 'diemVinhDuLienDau' // [FIX] Đổi sang Vinh Dự
            },
            // --- HẾT SET AN BANG ---

            // [NEW] --- Set Định Quốc (Mua bằng điểm PvP) ---
            'dq_weapon': {
                baseId: 'w6', name: "Vũ Khí Định Quốc", type: 'weapon', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'atk_p', name: 'Công Kích %', value: 25, display: 'Công Kích +25%', isPercent: true },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 18, display: 'Sinh Lực +18%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 8, display: 'Chí Mạng +8%', isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 50, display: 'ST Chí Mạng +50%', isPercent: true },
                    { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 15, display: 'Bỏ qua DEF +15%', isPercent: true }
                ],
                buyPrice: 10000, currency: 'diemTichLuyTongKim' // [FIX] Đổi sang Tích Lũy
            },
            'dq_armor': {
                baseId: 'a6', name: "Giáp Định Quốc", type: 'armor', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'hp_p', name: 'Sinh Lực %', value: 25, display: 'Sinh Lực +25%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 25, display: 'Phòng Thủ +25%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 10, display: 'Né Tránh +10%', isPercent: true },
                    { id: 'hp', name: 'Sinh Lực', value: 10000, display: 'Sinh Lực +10000', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 400, display: 'Phòng Thủ +400', isPercent: false }
                ],
                buyPrice: 10000, currency: 'diemTichLuyTongKim' // [FIX] Đổi sang Tích Lũy
            },
            'dq_acc1': {
                baseId: 'r4', name: "Phù Định Quốc", type: 'accessory', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'atk_p', name: 'Công Kích %', value: 10, display: 'Công Kích +10%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 10, display: 'Phòng Thủ +10%', isPercent: true },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 10, display: 'Sinh Lực +10%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 5, display: 'Chí Mạng +5%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 5, display: 'Né Tránh +5%', isPercent: true }
                ],
                buyPrice: 5000, currency: 'diemTichLuyTongKim' // 5k Tích Lũy
            },
            'dq_acc2': {
                baseId: 'r5', name: "Chỉ Định Quốc", type: 'accessory', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'hp_p', name: 'Sinh Lực %', value: 12, display: 'Sinh Lực +12%', isPercent: true },
                    { id: 'atk', name: 'Công Kích', value: 1800, display: 'Công Kích +1800', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 250, display: 'Phòng Thủ +250', isPercent: false },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 40, display: 'ST Chí Mạng +40%', isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 4, display: 'Hút Sinh Lực 4%', isPercent: true }
                ],
                buyPrice: 5000, currency: 'diemTichLuyTongKim' // 5k Tích Lũy
            },
            'dq_acc3': {
                baseId: 'r6', name: "Bội Định Quốc", type: 'accessory', level: 100, quality: 'anbang',
                affixes: [
                    { id: 'spd_p', name: 'Thân Pháp %', value: 12, display: 'Thân Pháp +12%', isPercent: true },
                    { id: 'spd', name: 'Thân Pháp', value: 150, display: 'Thân Pháp +150', isPercent: false },
                    { id: 'lck', name: 'May Mắn', value: 60, display: 'May Mắn +60', isPercent: false },
                    { id: 'xp_boost', name: 'Tăng KN', value: 90, display: 'Tăng KN +90%', isPercent: true },
                    { id: 'atk_p', name: 'Công Kích %', value: 7, display: 'Công Kích +7%', isPercent: true }
                ],
                buyPrice: 5000, currency: 'diemTichLuyTongKim' // 5k Tích Lũy
            },
            // --- HẾT SET ĐỊNH QUỐC ---

            // --- Quan Ấn (Mua bằng KNB) ---
            'qa_rare': {
                baseId: 'r3', name: "Quan Ấn Thừa Tướng", type: 'accessory', level: 30, quality: 'rare',
                affixes: [
                    { id: 'hp', name: 'Sinh Lực', value: 200, display: 'Sinh Lực +200', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 40, display: 'Phòng Thủ +40', isPercent: false },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 3, display: 'Sinh Lực +3%', isPercent: true }
                ],
                buyPrice: 100, currency: 'knb'
            },
            'qa_legendary': {
                baseId: 'r3', name: "Quan Ấn Thái Thú", type: 'accessory', level: 50, quality: 'legendary',
                affixes: [
                    { id: 'hp', name: 'Sinh Lực', value: 1500, display: 'Sinh Lực +1500', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 80, display: 'Phòng Thủ +80', isPercent: false },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 6, display: 'Sinh Lực +6%', isPercent: true }
                ],
                buyPrice: 1800, currency: 'knb'
            },
            'qa_epic': {
                baseId: 'r3', name: "Quan ấn Vương Gia", type: 'accessory', level: 70, quality: 'epic',
                affixes: [
                    { id: 'hp', name: 'Sinh Lực', value: 3000, display: 'Sinh Lực +3000', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 150, display: 'Phòng Thủ +150', isPercent: false },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 10, display: 'Sinh Lực +10%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 5, display: 'Phòng Thủ +5%', isPercent: true }
                ],
                buyPrice: 2750, currency: 'knb'
            },
            'qa_mythic': {
                baseId: 'r3', name: "Quan ấn Hoàng Đế", type: 'accessory', level: 90, quality: 'mythic',
                affixes: [
                    { id: 'hp', name: 'Sinh Lực', value: 5000, display: 'Sinh Lực +5000', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 1300, display: 'Phòng Thủ +1300', isPercent: false },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 15, display: 'Sinh Lực +15%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 20, display: 'Phòng Thủ +20%', isPercent: true }
                ],
                buyPrice: 10000, currency: 'knb'
            },
            
            // --- Phi Phong (Mua bằng KNB) ---
            'pp_uncommon': {
                baseId: 'r4', name: "Phi Phong Siêu Phàm", type: 'accessory', level: 10, quality: 'uncommon',
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 10, display: 'Công Kích +10', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 5, display: 'Thân Pháp +5', isPercent: false }
                ],
                buyPrice: 20, currency: 'knb'
            },
            'pp_rare': {
                baseId: 'r4', name: "Phi Phong Lăng Tuyệt", type: 'accessory', level: 30, quality: 'rare',
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 40, display: 'Công Kích +40', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 15, display: 'Thân Pháp +15', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 3, display: 'Công Kích +3%', isPercent: true }
                ],
                buyPrice: 100, currency: 'knb'
            },
             'pp_legendary': {
                baseId: 'r4', name: "Phi Phong Ngự Không", type: 'accessory', level: 50, quality: 'rare', // [MODIFIED] Vàng -> Tím
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 80, display: 'Công Kích +80', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 30, display: 'Thân Pháp +30', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 6, display: 'Công Kích +6%', isPercent: true }
                ],
                buyPrice: 300, currency: 'knb'
            },
            'pp_epic': {
                baseId: 'r4', name: "Phi Phong Hỗn Thiên", type: 'accessory', level: 70, quality: 'rare', // [MODIFIED] Cam -> Tím
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 150, display: 'Công Kích +150', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 50, display: 'Thân Pháp +50', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 10, display: 'Công Kích +10%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 5, display: 'Chí Mạng +5%', isPercent: true }
                ],
                buyPrice: 750, currency: 'knb'
            },
            'pp_mythic_1': {
                baseId: 'r4', name: "Phi Phong Sồ Phượng", type: 'accessory', level: 90, quality: 'legendary', // [MODIFIED] Đỏ -> Vàng
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 300, display: 'Công Kích +300', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 80, display: 'Thân Pháp +80', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 15, display: 'Công Kích +15%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 8, display: 'Chí Mạng +8%', isPercent: true }
                ],
                buyPrice: 2000, currency: 'knb'
            },
             'pp_mythic_2': {
                baseId: 'r4', name: "Phi Phong Tiềm Long", type: 'accessory', level: 100, quality: 'legendary', // [MODIFIED] Đỏ -> Vàng
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 950, display: 'Công Kích +950', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 90, display: 'Thân Pháp +90', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 38, display: 'Công Kích +38%', isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 105, display: 'ST Chí Mạng +105%', isPercent: true }
                ],
                buyPrice: 9000, currency: 'knb'
            },
             'pp_mythic_3': {
                baseId: 'r4', name: "Phi Phong Chí Tôn", type: 'accessory', level: 120, quality: 'epic', // [MODIFIED] Đỏ -> Cam
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 1450, display: 'Công Kích +1450', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 110, display: 'Thân Pháp +110', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 52, display: 'Công Kích +52%', isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 125, display: 'ST Chí Mạng +125%', isPercent: true }
                ],
                buyPrice: 15000, currency: 'knb'
            },
             'pp_mythic_4': {
                baseId: 'r4', name: "Phi Phong Vô Song", type: 'accessory', level: 150, quality: 'mythic', // [MODIFIED] Đỏ (Giữ nguyên)
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 2600, display: 'Công Kích +2600', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 150, display: 'Thân Pháp +150', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 90, display: 'Công Kích +90%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 10, display: 'Chí Mạng +10%', isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 140, display: 'ST Chí Mạng +140%', isPercent: true }
                ],
                buyPrice: 25000, currency: 'knb'
            },
            
            // --- [NEW] Mật Tịch Hoa Sơn (Mua bằng KNB) ---
            'mt_hoa_son_1': {
                baseId: 'r5', name: "Mật Tịch Hoa Sơn (Sơ)", type: 'accessory', level: 30, quality: 'rare',
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 200, display: 'Công Kích +200', isPercent: false },
                    { id: 'critChance', name: 'Chí Mạng', value: 3, display: 'Chí Mạng +3%', isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 1, display: 'Hút Sinh Lực 1%', isPercent: true },
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 1, display: 'Hút Nội Lực 1%', isPercent: true }
                ],
                buyPrice: 150, currency: 'knb'
            },
            'mt_hoa_son_2': {
                baseId: 'r5', name: "Mật Tịch Hoa Sơn (Trung)", type: 'accessory', level: 60, quality: 'epic',
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 800, display: 'Công Kích +800', isPercent: false },
                    { id: 'critChance', name: 'Chí Mạng', value: 6, display: 'Chí Mạng +6%', isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 3, display: 'Hút Sinh Lực 3%', isPercent: true },
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 3, display: 'Hút Nội Lực 3%', isPercent: true }
                ],
                buyPrice: 800, currency: 'knb'
            },
            'mt_hoa_son_3': {
                baseId: 'r5', name: "Mật Tịch Hoa Sơn (Cao)", type: 'accessory', level: 90, quality: 'mythic',
                affixes: [
                    { id: 'atk', name: 'Công Kích', value: 1400, display: 'Công Kích +1400', isPercent: false },
                    { id: 'critChance', name: 'Chí Mạng', value: 10, display: 'Chí Mạng +10%', isPercent: true }, // [MODIFIED] Giữ nguyên 10%
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 5, display: 'Hút Sinh Lực 5%', isPercent: true },
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 5, display: 'Hút Nội Lực 5%', isPercent: true }
                ],
                buyPrice: 2500, currency: 'knb'
            },
            // [MODIFIED] Super Godly Items (Buy with Uy Danh) - Capped Crit Chance
            'sg_weapon_ud': {
                baseId: 'w6', name: "Vô Tận Ma Kiếm", type: 'weapon', level: 200, quality: 'supergodly',
                affixes: [ // Total 7 lines
                    { id: 'atk', name: 'Công Kích', value: 2600, display: 'Công Kích +2600', isPercent: false }, 
                    { id: 'atk_p', name: 'Công Kích %', value: 28, display: 'Công Kích +28%', isPercent: true }, 
                    { id: 'critChance', name: 'Chí Mạng', value: 10, display: 'Chí Mạng +10%', isPercent: true }, // [MODIFIED] Giảm từ 17 -> 10
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 55, display: 'ST Chí Mạng +55%', isPercent: true }, 
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 9, display: 'Hút Sinh Lực 9%', isPercent: true }, 
                    { id: 'spd_p', name: 'Tốc Độ Đánh %', value: 50, display: 'Tốc Độ Đánh +50%', isPercent: true }, 
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 7, display: 'Hút Nội Lực 7%', isPercent: true } 
                ],
                buyPrice: 10000, currency: 'uyDanh' 
            },
            'sg_armor_ud': { // No crit chance here
                baseId: 'a6', name: "Bất Diệt Thánh Giáp", type: 'armor', level: 200, quality: 'supergodly',
                affixes: [ // Total 7 lines
                    { id: 'hp', name: 'Sinh Lực', value: 5500, display: 'Sinh Lực +5500', isPercent: false }, 
                    { id: 'def', name: 'Phòng Thủ', value: 880, display: 'Phòng Thủ +880', isPercent: false }, 
                    { id: 'hp_p', name: 'Sinh Lực %', value: 22, display: 'Sinh Lực +22%', isPercent: true }, 
                    { id: 'def_p', name: 'Phòng Thủ %', value: 17, display: 'Phòng Thủ +17%', isPercent: true }, 
                    { id: 'dodgeChance', name: 'Né Tránh', value: 8, display: 'Né Tránh +8%', isPercent: true }, 
                    { id: 'spd', name: 'Thân Pháp', value: 50, display: 'Thân Pháp +50', isPercent: false }, 
                    { id: 'lck', name: 'May Mắn', value: 30, display: 'May Mắn +30', isPercent: false } 
                ],
                buyPrice: 10000, currency: 'uyDanh' 
            },
            'sg_ring_ud': {
                baseId: 'r6', name: "Nhẫn Luân Hồi", type: 'accessory', level: 200, quality: 'supergodly',
                affixes: [ // Total 8 lines
                    { id: 'lck', name: 'May Mắn', value: 110, display: 'May Mắn +110', isPercent: false }, 
                    { id: 'xp_boost', name: 'Tăng KN', value: 300, display: 'Tăng KN +300%', isPercent: true }, 
                    { id: 'critChance', name: 'Chí Mạng', value: 10, display: 'Chí Mạng +10%', isPercent: true }, // [MODIFIED] Giảm từ 11 -> 10
                    { id: 'dodgeChance', name: 'Né Tránh', value: 11, display: 'Né Tránh +11%', isPercent: true }, 
                    { id: 'atk_p', name: 'Công Kích %', value: 10, display: 'Công Kích +10%', isPercent: true }, 
                    { id: 'def_p', name: 'Phòng Thủ %', value: 10, display: 'Phòng Thủ +10%', isPercent: true }, 
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 4, display: 'Hút Sinh Lực 4%', isPercent: true }, 
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 4, display: 'Hút Nội Lực 4%', isPercent: true } 
                ],
                buyPrice: 10000, currency: 'uyDanh' 
            },
            'sg_pendant_ud': { // Vô Ảnh Bội - Crit Chance was already 8%
                baseId: 'r5', 
                name: "Vô Ảnh Bội", type: 'accessory', level: 200, quality: 'supergodly',
                affixes: [ // 8 lines
                    { id: 'spd', name: 'Thân Pháp', value: 150, display: 'Thân Pháp +150', isPercent: false },
                    { id: 'spd_p', name: 'Thân Pháp %', value: 20, display: 'Thân Pháp +20%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 15, display: 'Né Tránh +15%', isPercent: true },
                    { id: 'lck', name: 'May Mắn', value: 80, display: 'May Mắn +80', isPercent: false },
                    { id: 'critChance', name: 'Chí Mạng', value: 8, display: 'Chí Mạng +8%', isPercent: true }, // Already <= 10
                    { id: 'atk', name: 'Công Kích', value: 1300, display: 'Công Kích +1300', isPercent: false },
                    { id: 'hp', name: 'Sinh Lực', value: 1000, display: 'Sinh Lực +1000', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 100, display: 'Phòng Thủ +100', isPercent: false }
                ],
                buyPrice: 10000, currency: 'uyDanh' 
            },
             'sg_necklace_ud': { // Huyết Ma Liên - No crit chance
                baseId: 'r4', 
                name: "Huyết Ma Liên", type: 'accessory', level: 200, quality: 'supergodly',
                affixes: [ // 8 lines
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 12, display: 'Hút Sinh Lực 12%', isPercent: true },
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 12, display: 'Hút Nội Lực 12%', isPercent: true },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 15, display: 'Sinh Lực +15%', isPercent: true },
                    { id: 'mana_p', name: 'Nội Lực %', value: 15, display: 'Nội Lực +15%', isPercent: true }, 
                    { id: 'hp', name: 'Sinh Lực', value: 2000, display: 'Sinh Lực +2000', isPercent: false },
                    { id: 'mana', name: 'Nội Lực', value: 1000, display: 'Nội Lực +1000', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 8, display: 'Công Kích +8%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 8, display: 'Phòng Thủ +8%', isPercent: true },
                ],
                buyPrice: 10000, currency: 'uyDanh' 
            },
            // [NEW] Phi Phong Đại Đế (Mua bằng Uy Danh)
            'sg_pp_dai_de_ud': {
                baseId: 'r4', name: "Phi Phong Đại Đế", type: 'accessory', level: 210, quality: 'supergodly',
                affixes: [ // 8 lines
                    { id: 'atk', name: 'Công Kích', value: 3800, display: 'Công Kích +3800', isPercent: false },
                    { id: 'spd', name: 'Thân Pháp', value: 200, display: 'Thân Pháp +200', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 55, display: 'Công Kích +55%', isPercent: true },
                    { id: 'spd_p', name: 'Thân Pháp %', value: 25, display: 'Thân Pháp +25%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 10, display: 'Chí Mạng +10%', isPercent: true }, // Capped at 10
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 150, display: 'ST Chí Mạng +150%', isPercent: true },
                    { id: 'lck', name: 'May Mắn', value: 100, display: 'May Mắn +100', isPercent: false },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 10, display: 'Né Tránh +10%', isPercent: true }
                ],
                buyPrice: 15000, currency: 'uyDanh'
            },
            // [FIX] Toàn bộ khối vật phẩm bên dưới đã bị hỏng do lỗi sao chép-dán.
            // Đã viết lại định nghĩa cho 4 vật phẩm này.

            // [NEW] Hồng Ảnh (Mua bằng Uy Danh)
            'sg_hong_anh_ud': {
                baseId: 'r6', name: "Hồng Ảnh", type: 'accessory', level: 210, quality: 'supergodly',
                affixes: [ // 8 lines
                    { id: 'hp', name: 'Sinh Lực', value: 3500, display: 'Sinh Lực +3500', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 400, display: 'Phòng Thủ +400', isPercent: false },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 20, display: 'Sinh Lực +20%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 20, display: 'Phòng Thủ +20%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 12, display: 'Né Tránh +12%', isPercent: true },
                    { id: 'lck', name: 'May Mắn', value: 90, display: 'May Mắn +90', isPercent: false },
                    { id: 'critChance', name: 'Chí Mạng', value: 8, display: 'Chí Mạng +8%', isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 80, display: 'ST Chí Mạng +80%', isPercent: true }
                ],
                buyPrice: 15000, currency: 'uyDanh'
            },
            'sg_vo_cuc_ud': {
                baseId: 'r6', name: "Vô Cực", type: 'accessory', level: 210, quality: 'supergodly',
                affixes: [ // 8 lines
                    { id: 'hp_p', name: 'Sinh Lực %', value: 15, display: 'Sinh Lực +15%', isPercent: true },
                    { id: 'atk_p', name: 'Công Kích %', value: 15, display: 'Công Kích +15%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 15, display: 'Phòng Thủ +15%', isPercent: true },
                    { id: 'spd_p', name: 'Thân Pháp %', value: 15, display: 'Thân Pháp +15%', isPercent: true },
                    { id: 'lck_p', name: 'May Mắn %', value: 15, display: 'May Mắn +15%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 7, display: 'Chí Mạng +7%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 7, display: 'Né Tránh +7%', isPercent: true },
                    { id: 'xp_boost', name: 'Tăng KN', value: 200, display: 'Tăng KN +200%', isPercent: true }
                ],
                buyPrice: 15000, currency: 'uyDanh'
            },
            // [NEW] Bổ sung 2 món cuối cùng
            'sg_than_ngoc_ud': {
                baseId: 'r6', name: "Thần Ngọc", type: 'accessory', level: 210, quality: 'supergodly',
                affixes: [ // 8 lines
                    { id: 'hp', name: 'Sinh Lực', value: 8000, display: 'Sinh Lực +8000', isPercent: false },
                    { id: 'def', name: 'Phòng Thủ', value: 600, display: 'Phòng Thủ +600', isPercent: false },
                    { id: 'hp_p', name: 'Sinh Lực %', value: 30, display: 'Sinh Lực +30%', isPercent: true },
                    { id: 'def_p', name: 'Phòng Thủ %', value: 20, display: 'Phòng Thủ +20%', isPercent: true },
                    { id: 'dodgeChance', name: 'Né Tránh', value: 10, display: 'Né Tránh +10%', isPercent: true },
                    { id: 'lck', name: 'May Mắn', value: 50, display: 'May Mắn +50', isPercent: false },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 50, display: 'ST Chí Mạng +50%', isPercent: true },
                    { id: 'mana_p', name: 'Nội Lực %', value: 15, display: 'Nội Lực +15%', isPercent: true }
                ],
                buyPrice: 15000, currency: 'uyDanh'
            },
            'sg_bach_ho_ud': {
                baseId: 'r6', name: "Bạch Hổ", type: 'accessory', level: 210, quality: 'supergodly',
                affixes: [ // 8 lines
                    { id: 'atk', name: 'Công Kích', value: 3000, display: 'Công Kích +3000', isPercent: false },
                    { id: 'atk_p', name: 'Công Kích %', value: 30, display: 'Công Kích +30%', isPercent: true },
                    { id: 'critChance', name: 'Chí Mạng', value: 10, display: 'Chí Mạng +10%', isPercent: true },
                    { id: 'critDamage', name: 'ST Chí Mạng', value: 120, display: 'ST Chí Mạng +120%', isPercent: true },
                    { id: 'lifesteal', name: 'Hút Sinh Lực', value: 8, display: 'Hút Sinh Lực 8%', isPercent: true },
                    { id: 'manasteal', name: 'Hút Nội Lực', value: 8, display: 'Hút Nội Lực 8%', isPercent: true },
                    { id: 'spd', name: 'Thân Pháp', value: 100, display: 'Thân Pháp +100', isPercent: false },
                    { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 10, display: 'Bỏ qua DEF +10%', isPercent: true }
                ],
                buyPrice: 15000, currency: 'uyDanh'
            }
        };

        // *** NEW: Materials Database (Fish, Ores, etc.) ***
        // [MODIFIED] Added mining materials alongside fish
        const MATERIALS_DB = {
            // Fish (Kept for compatibility)
            'fish_common_1': { name: 'Cá Diếc', rarity: 1, type: 'fish', sellPrice: 2, xp: 3, icon: 'fa-solid fa-fish' }, // [MODIFIED] xp: 1 -> 3
            'fish_common_2': { name: 'Cá Rô', rarity: 1, type: 'fish', sellPrice: 3, xp: 6, icon: 'fa-solid fa-fish' }, // [MODIFIED] xp: 2 -> 6
            'fish_uncommon_1': { name: 'Cá Chép', rarity: 2, type: 'fish', sellPrice: 10, xp: 15, icon: 'fa-solid fa-fish-fins' }, // [MODIFIED] xp: 5 -> 15
            // [NEW FISH]
            'fish_uncommon_2': { name: 'Cá Lóc', rarity: 2, type: 'fish', sellPrice: 15, xp: 25, icon: 'fa-solid fa-fish-fins' },
            'fish_rare_1': { name: 'Cá Vàng', rarity: 3, type: 'fish', sellPrice: 50, xp: 60, icon: 'fa-solid fa-fish-fins' }, // [MODIFIED] xp: 20 -> 60
            // [NEW FISH]
            'fish_rare_2': { name: 'Cá Trắm Cỏ', rarity: 3, type: 'fish', sellPrice: 75, xp: 90, icon: 'fa-solid fa-fish-fins' },
            // [NEW] New Fish
            'fish_epic_1': { name: 'Cá Rồng', rarity: 4, type: 'fish', sellPrice: 500, xp: 300, icon: 'fa-solid fa-dragon' },
            // Mining (Kept for compatibility/future use)
            'gem_fragment_t1': { name: 'Mảnh Ngọc', rarity: 1, type: 'gem', sellPrice: 5, xp: 2, icon: 'fa-solid fa-burst' },
            'crystal_t1': { name: 'Đá Cường Hóa', rarity: 2, type: 'crystal', sellPrice: 15, xp: 5, icon: 'fa-solid fa-gem' }, // Renamed from Đá Cường Hóa Sơ for clarity
            'ruby_t1': { name: 'Tinh Hồng Bảo Thạch', rarity: 3, type: 'gem', sellPrice: 40, xp: 10, icon: 'fa-solid fa-heart-crack' }, // Example icon
            // Upgrade Stones [NEW]
            'upgrade_stone_low': { name: 'Đá Cường Hóa Sơ', rarity: 1, type: 'upgrade_stone', sellPrice: 20, icon: 'fa-solid fa-circle' },
            'upgrade_stone_medium': { name: 'Đá Cường Hóa Trung', rarity: 2, type: 'upgrade_stone', sellPrice: 100, icon: 'fa-solid fa-square' },
            'upgrade_stone_high': { name: 'Đá Cường Hóa Cao', rarity: 3, type: 'upgrade_stone', sellPrice: 500, icon: 'fa-solid fa-star' },
            // [NEW] Mining Ores
            'ore_common_1': { name: 'Mảnh Sắt', rarity: 1, type: 'ore', sellPrice: 3, xp: 3, icon: 'fa-solid fa-mound' },
            'ore_uncommon_1': { name: 'Mảnh Đồng', rarity: 2, type: 'ore', sellPrice: 12, xp: 15, icon: 'fa-solid fa-mound' },
            'ore_rare_1': { name: 'Mảnh Bạc', rarity: 3, type: 'ore', sellPrice: 60, xp: 60, icon: 'fa-solid fa-mound' },
            'ore_epic_1': { name: 'Mảnh Vàng', rarity: 4, type: 'ore', sellPrice: 600, xp: 300, icon: 'fa-solid fa-gem' },
            'ore_mythic_1': { name: 'Mảnh Bạch Kim', rarity: 5, type: 'ore', sellPrice: 2000, xp: 1000, icon: 'fa-solid fa-diamond' }, // [NEW]
            // [NEW] Herbalism Herbs
            'herb_common_1': { name: 'Cỏ Dại', rarity: 1, type: 'herb', sellPrice: 3, xp: 3, icon: 'fa-solid fa-seedling' },
            'herb_uncommon_1': { name: 'Bạc Hà', rarity: 2, type: 'herb', sellPrice: 12, xp: 15, icon: 'fa-solid fa-leaf' },
            'herb_rare_1': { name: 'Linh Chi', rarity: 3, type: 'herb', sellPrice: 60, xp: 60, icon: 'fa-solid fa-hat-wizard' }, // Re-using icon
            'herb_epic_1': { name: 'Nhân Sâm Ngàn Năm', rarity: 4, type: 'herb', sellPrice: 600, xp: 300, icon: 'fa-solid fa-spa' },
            'herb_mythic_1': { name: 'Thiên Sơn Tuyết Liên', rarity: 5, type: 'herb', sellPrice: 2000, xp: 1000, icon: 'fa-solid fa-snowflake' }, // [NEW]
            // [NEW] Tu Chan Gioi Material
            'manh_phap_bao': { name: 'Mảnh Pháp Bảo', rarity: 2, type: 'material', sellPrice: 20, icon: 'fa-solid fa-scroll' },
            // [NEW] Higher Tier Tu Chan Gioi Materials
            'manh_phap_bao_trung': { name: 'Mảnh Pháp Bảo (Trung)', rarity: 3, type: 'material', sellPrice: 100, icon: 'fa-solid fa-scroll' },
            'manh_phap_bao_cao': { name: 'Mảnh Pháp Bảo (Cao)', rarity: 4, type: 'material', sellPrice: 500, icon: 'fa-solid fa-scroll' },
            
            // [NEW] Socket Gems (Gems for socketing) - Thêm Thủy Tinh
            'gem_green_1': { name: 'Lục Thủy Tinh (Sơ)', rarity: 2, type: 'gem', sellPrice: 50, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 1. Sẽ dùng để khảm vào trang bị.' },
            'gem_blue_1': { name: 'Lam Thủy Tinh (Sơ)', rarity: 3, type: 'gem', sellPrice: 250, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 1. Sẽ dùng để khảm vào trang bị.' },
            'gem_purple_1': { name: 'Tử Thủy Tinh (Sơ)', rarity: 4, type: 'gem', sellPrice: 1000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 1. Sẽ dùng để khảm vào trang bị.' },
            'gem_yellow_1': { name: 'Hoàng Thủy Tinh (Sơ)', rarity: 5, type: 'gem', sellPrice: 5000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 1. Sẽ dùng để khảm vào trang bị.' }, // [FIX] Sửa lỗi icon (fa.gem -> fa-gem)
            // [NEW] Trung Cấp Gems (Tier 2)
            'gem_green_2': { name: 'Lục Thủy Tinh (Trung)', rarity: 3, type: 'gem', sellPrice: 500, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 2.' },
            'gem_blue_2': { name: 'Lam Thủy Tinh (Trung)', rarity: 4, type: 'gem', sellPrice: 2500, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 2.' },
            'gem_purple_2': { name: 'Tử Thủy Tinh (Trung)', rarity: 5, type: 'gem', sellPrice: 10000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 2.' },
            'gem_yellow_2': { name: 'Hoàng Thủy Tinh (Trung)', rarity: 6, type: 'gem', sellPrice: 50000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 2.' },
            // [NEW] Cao Cấp Gems (Tier 3)
            'gem_green_3': { name: 'Lục Thủy Tinh (Cao)', rarity: 4, type: 'gem', sellPrice: 2500, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 3.' },
            'gem_blue_3': { name: 'Lam Thủy Tinh (Cao)', rarity: 5, type: 'gem', sellPrice: 12500, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 3.' },
            'gem_purple_3': { name: 'Tử Thủy Tinh (Cao)', rarity: 6, type: 'gem', sellPrice: 50000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 3.' },
            'gem_yellow_3': { name: 'Hoàng Thủy Tinh (Cao)', rarity: 7, type: 'gem', sellPrice: 250000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 3.' },
            // [NEW] Siêu Cấp Gems (Tier 4)
            'gem_green_4': { name: 'Lục Thủy Tinh (Siêu)', rarity: 5, type: 'gem', sellPrice: 12500, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 4.' },
            'gem_blue_4': { name: 'Lam Thủy Tinh (Siêu)', rarity: 6, type: 'gem', sellPrice: 62500, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 4.' },
            'gem_purple_4': { name: 'Tử Thủy Tinh (Siêu)', rarity: 7, type: 'gem', sellPrice: 250000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 4.' },
            'gem_yellow_4': { name: 'Hoàng Thủy Tinh (Siêu)', rarity: 8, type: 'gem', sellPrice: 1250000, icon: 'fa-solid fa-gem', desc: 'Ngọc khảm cấp 4.' },
            
            // [NEW] Chìa Khóa Rương Báu (cho Vòng Quay)
            'key_common': { name: 'Chìa Khóa Đồng', rarity: 2, type: 'key', sellPrice: 1000, icon: 'fa-solid fa-key' },
            'key_rare': { name: 'Chìa Khóa Bạc', rarity: 3, type: 'key', sellPrice: 5000, icon: 'fa-solid fa-key' },
            
            // [NEW] Vong Quay Ticket
            'luot_quay_may_man': { name: 'Lượt Quay Vòng Quay', rarity: 3, type: 'ticket', sellPrice: 0, icon: 'fa-solid fa-ticket' },
        };

        // *** NEW: Idle Action Database ***
        const IDLE_ACTION_DB = {
            'fishing_spot_1': {
                id: 'fishing_spot_1', skill: 'fishing', levelReq: 1, name: 'Vô Tận Hải Vực',
                loot: [ // [MODIFIED] Re-balanced loot table to include all new fish
                    { id: 'fish_common_1', chance: 50 },   // 50% Cá Diếc
                    { id: 'fish_common_2', chance: 25 },   // 25% Cá Rô
                    { id: 'fish_uncommon_1', chance: 10 }, // 10% Cá Chép
                    { id: 'fish_uncommon_2', chance: 7 },    // 7% Cá Lóc
                    { id: 'fish_rare_1', chance: 4 },       // 4% Cá Vàng [NEW]
                    { id: 'fish_rare_2', chance: 3 },       // 3% Cá Trắm Cỏ [MODIFIED]
                    { id: 'fish_epic_1', chance: 1 }       // 1% Cá Rồng [NEW]
                ],
                tickRate: 10000 // 10 seconds per attempt [MODIFIED] 8000 -> 10000
            },
            // [NEW] Mining Spot
            'mining_spot_1': {
                id: 'mining_spot_1', skill: 'mining', levelReq: 1, name: 'Tinh Không Địa Vực',
                loot: [
                    { id: 'ore_common_1', chance: 50 },   // 50% Mảnh Sắt
                    { id: 'ore_uncommon_1', chance: 25 }, // 25% Mảnh Đồng
                    { id: 'ore_rare_1', chance: 15 },     // 15% Mảnh Bạc
                    { id: 'ore_epic_1', chance: 5 },      // 5% Mảnh Vàng
                    { id: 'upgrade_stone_low', chance: 5 } // 5% Đá Cường Hóa Sơ
                ],
                tickRate: 10000 // 10 seconds
            },
            // [NEW] Herbalism Spot
            'herbalism_spot_1': {
                id: 'herbalism_spot_1', skill: 'herbalism', levelReq: 1, name: 'Vĩnh Hằng Sâm Lâm',
                loot: [
                    { id: 'herb_common_1', chance: 50 },   // 50% Cỏ Dại
                    { id: 'herb_uncommon_1', chance: 25 }, // 25% Bạc Hà
                    { id: 'herb_rare_1', chance: 15 },     // 15% Linh Chi
                    { id: 'herb_epic_1', chance: 5 },      // 5% Nhân Sâm
                    { id: 'upgrade_stone_low', chance: 5 } // 5% Đá Cường Hóa Sơ
                ],
                tickRate: 10000 // 10 seconds
            },
        };

        // [NEW] Sect Shop Database (Purchase with diemCongHien)
        const SECT_SHOP_DB = {
            // --- XP Pills (Kinh Nghiệm) ---
            'buy_disciple_xp_1': {
                itemId: 'disciple_xp_pill_1', // 10k XP
                cost: 10, 
                currency: 'linhThach'
            },
            'buy_disciple_xp_2': {
                itemId: 'disciple_xp_pill_2', // 500k XP
                cost: 200,
                currency: 'linhThach'
            },
            'buy_disciple_xp_3': {
                itemId: 'disciple_xp_pill_3', // 2.5M XP
                cost: 800,
                currency: 'linhThach'
            },

            // --- ATK Pills (Công Kích) ---
            'buy_disciple_atk_1': {
                itemId: 'disciple_atk_pill_1', // +2 ATK
                cost: 50,
                currency: 'linhThach'
            },
            'buy_disciple_atk_2': {
                itemId: 'disciple_atk_pill_2', // +10 ATK
                cost: 200,
                currency: 'linhThach'
            },
            'buy_disciple_atk_3': {
                itemId: 'disciple_atk_pill_3', // +25 ATK
                cost: 500,
                currency: 'linhThach'
            },

            // --- HP Pills (Sinh Lực) ---
            'buy_disciple_hp_1': {
                itemId: 'disciple_hp_pill_1', // +10 HP
                cost: 50,
                currency: 'linhThach'
            },
            'buy_disciple_hp_2': {
                itemId: 'disciple_hp_pill_2', // +50 HP
                cost: 200,
                currency: 'linhThach'
            },
            'buy_disciple_hp_3': {
                itemId: 'disciple_hp_pill_3', // +125 HP
                cost: 500,
                currency: 'linhThach'
            },

            // --- DEF Pills (Phòng Thủ) ---
            'buy_disciple_def_1': {
                itemId: 'disciple_def_pill_1', // +2 DEF
                cost: 50,
                currency: 'linhThach'
            },
            'buy_disciple_def_2': {
                itemId: 'disciple_def_pill_2', // +10 DEF
                cost: 200,
                currency: 'linhThach'
            },
            'buy_disciple_def_3': {
                itemId: 'disciple_def_pill_3', // +25 DEF
                cost: 500,
                currency: 'linhThach'
            },

            // --- SPD Pills (Thân Pháp) ---
            'buy_disciple_spd_1': {
                itemId: 'disciple_spd_pill_1', // +2 SPD
                cost: 50,
                currency: 'linhThach'
            },
            'buy_disciple_spd_2': {
                itemId: 'disciple_spd_pill_2', // +10 SPD
                cost: 200,
                currency: 'linhThach'
            },
            'buy_disciple_spd_3': {
                itemId: 'disciple_spd_pill_3', // +25 SPD
                cost: 500,
                currency: 'linhThach'
            },

            // [NEW] --- Sách Kỹ Năng (Ví dụ) ---
            'buy_manual_crit_1': {
                itemId: 'manual_crit_1', // Giả sử item này tồn tại hoặc để placeholder
                cost: 5000,
                currency: 'linhThach'
            }
        };

        // [NEW] --- BẢNG KỸ NĂNG CƠ BẢN ĐỆ TỬ (Học bằng Cống Hiến) ---
        // [MODIFIED] Cân bằng lại toàn bộ: Giảm chỉ số 1/6, Max Level 3, Thêm tầng cao
        const BASIC_DISCIPLE_SKILLS = {
            // --- TẦNG 1: SƠ CẤP (Cost: 100 ĐCH) ---
            'skill_basic_hp': {
                name: 'Tẩy Tủy Kinh (Quyển 1)',
                desc: 'Pháp môn nhập môn, tẩy trừ tạp chất, củng cố căn cơ.',
                icon: 'fa-solid fa-heart',
                color: 'text-gray-400',
                cost: 100,
                effect: { stat: 'hp', value: 2 }, // 8/6 ~ 1.3 -> 2
                maxLevel: 3
            },
            'skill_basic_atk': {
                name: 'La Hán Quyền',
                desc: 'Quyền pháp cơ bản, rèn luyện gân cốt.',
                icon: 'fa-solid fa-fist-raised',
                color: 'text-gray-400',
                cost: 100,
                effect: { stat: 'atk', value: 1 }, // 2/6 -> 1
                maxLevel: 3
            },
            'skill_basic_def': {
                name: 'Thiết Bố Sam',
                desc: 'Da thịt cứng như sắt, đao thương khó vào.',
                icon: 'fa-solid fa-shield',
                color: 'text-gray-400',
                cost: 100,
                effect: { stat: 'def', value: 1 },
                maxLevel: 3
            },
            'skill_basic_spd': {
                name: 'Thảo Thượng Phi',
                desc: 'Khinh công nhập môn, lướt trên ngọn cỏ.',
                icon: 'fa-solid fa-wind',
                color: 'text-gray-400',
                cost: 100,
                effect: { stat: 'spd', value: 1 },
                maxLevel: 3
            },

            // --- TẦNG 2: TRUNG CẤP (Cost: 300 ĐCH) ---
            'skill_inter_hp': {
                name: 'Trường Sinh Quyết',
                desc: 'Hấp thụ tinh hoa trời đất bồi bổ nguyên khí.',
                icon: 'fa-solid fa-leaf',
                color: 'text-blue-400',
                cost: 300,
                effect: { stat: 'hp', value: 8 }, // 50/6 ~ 8
                maxLevel: 3
            },
            'skill_inter_atk': {
                name: 'Phục Hổ Quyền',
                desc: 'Quyền pháp cương mãnh như hổ gầm.',
                icon: 'fa-solid fa-paw',
                color: 'text-blue-400',
                cost: 300,
                effect: { stat: 'atk', value: 2 }, // 10/6 ~ 1.6 -> 2
                maxLevel: 3
            },
            'skill_inter_def': {
                name: 'Kim Chung Tráo',
                desc: 'Chuông vàng hộ thể, chấn vỡ binh khí.',
                icon: 'fa-solid fa-bell',
                color: 'text-blue-400',
                cost: 300,
                effect: { stat: 'def', value: 1 }, // 5/6 -> 1
                maxLevel: 3
            },
            'skill_inter_spd': {
                name: 'Thủy Thượng Phiêu',
                desc: 'Đạp nước mà đi, không để lại gợn sóng.',
                icon: 'fa-solid fa-water',
                color: 'text-blue-400',
                cost: 300,
                effect: { stat: 'spd', value: 1 },
                maxLevel: 3
            },

            // --- TẦNG 3: CAO CẤP (Cost: 1,000 ĐCH) ---
            'skill_adv_hp': {
                name: 'Dịch Cân Kinh',
                desc: 'Cải tạo gân mạch, sinh lực vô tận.',
                icon: 'fa-solid fa-book-medical',
                color: 'text-yellow-400',
                cost: 1000,
                effect: { stat: 'hp', value: 35 }, // 200/6 ~ 33
                maxLevel: 3
            },
            'skill_adv_atk': {
                name: 'Cửu Dương Thần Công',
                desc: 'Nội lực chí dương cuồn cuộn không dứt.',
                icon: 'fa-solid fa-sun',
                color: 'text-yellow-400',
                cost: 1000,
                effect: { stat: 'atk', value: 7 }, // 40/6 ~ 6.6
                maxLevel: 3
            },
            'skill_adv_def': {
                name: 'Bất Hoại Kim Thân',
                desc: 'Thân thể vàng ròng, thủy hỏa bất hại.',
                icon: 'fa-solid fa-gem',
                color: 'text-yellow-400',
                cost: 1000,
                effect: { stat: 'def', value: 3 }, // 20/6 ~ 3.3
                maxLevel: 3
            },
            'skill_adv_spd': {
                name: 'Thần Hành Bách Biến',
                desc: 'Biến hóa khôn lường, nhanh không tàn ảnh.',
                icon: 'fa-solid fa-bolt',
                color: 'text-yellow-400',
                cost: 1000,
                effect: { stat: 'spd', value: 3 },
                maxLevel: 3
            },

            // --- TẦNG 4: TUYỆT THẾ (Cost: 5,000 ĐCH) ---
            'skill_ult_hp': {
                name: 'Bắc Minh Thần Công',
                desc: 'Hấp thụ nội lực thiên hạ làm của riêng.',
                icon: 'fa-solid fa-water',
                color: 'text-purple-400',
                cost: 5000,
                effect: { stat: 'hp', value: 160 }, // 1000/6 ~ 166
                maxLevel: 3
            },
            'skill_ult_atk': {
                name: 'Độc Cô Cửu Kiếm',
                desc: 'Vô chiêu thắng hữu chiêu, phá giải mọi võ công.',
                icon: 'fa-solid fa-khanda',
                color: 'text-purple-400',
                cost: 5000,
                effect: { stat: 'atk', value: 35 }, // 200/6 ~ 33
                maxLevel: 3
            },
            'skill_ult_def': {
                name: 'Càn Khôn Đại Na Di',
                desc: 'Chuyển hướng đòn tấn công, mượn lực đánh lực.',
                icon: 'fa-solid fa-arrows-rotate',
                color: 'text-purple-400',
                cost: 5000,
                effect: { stat: 'def', value: 16 }, // 100/6 ~ 16
                maxLevel: 3
            },
            'skill_ult_spd': {
                name: 'Lăng Ba Vi Bộ (Cực)',
                desc: 'Đạp gió cưỡi mây, người chưa tới bóng đã tan.',
                icon: 'fa-solid fa-feather',
                color: 'text-purple-400',
                cost: 5000,
                effect: { stat: 'spd', value: 16 },
                maxLevel: 3
            },

            // --- TẦNG 5: THẦN THOẠI (Cost: 20,000 ĐCH) ---
            'skill_myth_hp': {
                name: 'Bất Diệt Kinh',
                desc: 'Chỉ còn một giọt máu cũng có thể tái sinh.',
                icon: 'fa-solid fa-infinity',
                color: 'text-red-500 text-shadow-red',
                cost: 20000,
                effect: { stat: 'hp', value: 830 }, // 5000/6
                maxLevel: 3
            },
            'skill_myth_atk': {
                name: 'Thảo Tự Kiếm Quyết',
                desc: 'Một ngọn cỏ chém rụng trăng sao.',
                icon: 'fa-solid fa-leaf',
                color: 'text-red-500 text-shadow-red',
                cost: 20000,
                effect: { stat: 'atk', value: 160 }, // 1000/6
                maxLevel: 3
            },
            'skill_myth_def': {
                name: 'Bàn Cổ Chân Thân',
                desc: 'Thân thể khổng lồ đứng vững giữa hỗn độn.',
                icon: 'fa-solid fa-mountain',
                color: 'text-red-500 text-shadow-red',
                cost: 20000,
                effect: { stat: 'def', value: 80 }, // 500/6
                maxLevel: 3
            },
            'skill_myth_spd': {
                name: 'Côn Bằng Bảo Thuật',
                desc: 'Vỗ cánh chín vạn dặm, xuyên thấu thời không.',
                icon: 'fa-solid fa-crow',
                color: 'text-red-500 text-shadow-red',
                cost: 20000,
                effect: { stat: 'spd', value: 80 },
                maxLevel: 3
            },

            // --- TẦNG 6: CHÍ TÔN (Cost: 100,000 ĐCH) ---
            'skill_supreme_hp': {
                name: 'Thôn Phệ Tinh Không',
                desc: 'Biến cơ thể thành lỗ đen vũ trụ, nuốt chửng vạn vật.',
                icon: 'fa-solid fa-meteor',
                color: 'text-fuchsia-400 text-shadow-purple',
                cost: 100000,
                effect: { stat: 'hp', value: 4000 }, // 25000/6
                maxLevel: 3
            },
            'skill_supreme_atk': {
                name: 'Vạn Kiếm Quy Tông',
                desc: 'Kiếm ý hủy diệt càn khôn, trảm diệt chư thần.',
                icon: 'fa-solid fa-khanda',
                color: 'text-fuchsia-400 text-shadow-purple',
                cost: 100000,
                effect: { stat: 'atk', value: 800 }, // 5000/6
                maxLevel: 3
            },
            'skill_supreme_def': {
                name: 'Huyền Vũ Chân Công',
                desc: 'Phòng ngự tuyệt đối, vạn kiếp không suy.',
                icon: 'fa-solid fa-shield-virus',
                color: 'text-fuchsia-400 text-shadow-purple',
                cost: 100000,
                effect: { stat: 'def', value: 400 }, // 2500/6
                maxLevel: 3
            },
            'skill_supreme_spd': {
                name: 'Hư Không Đại Na Di',
                desc: 'Dịch chuyển tức thời, vượt qua quy tắc không gian.',
                icon: 'fa-solid fa-ghost',
                color: 'text-fuchsia-400 text-shadow-purple',
                cost: 100000,
                effect: { stat: 'spd', value: 400 },
                maxLevel: 3
            },

            // --- TẦNG 7: SÁNG THẾ (Cost: 500,000 ĐCH) ---
            'skill_creator_hp': {
                name: 'Hồng Mông Đạo Thể',
                desc: 'Thân thể đúc từ khí Hồng Mông, cùng tuổi trời đất.',
                icon: 'fa-solid fa-dna',
                color: 'text-rainbow-animation font-black',
                cost: 500000,
                effect: { stat: 'hp', value: 16000 }, // 100000/6
                maxLevel: 3
            },
            'skill_creator_atk': {
                name: 'Khai Thiên Tịch Địa',
                desc: 'Sức mạnh kiến tạo thế giới mới.',
                icon: 'fa-solid fa-hammer',
                color: 'text-rainbow-animation font-black',
                cost: 500000,
                effect: { stat: 'atk', value: 3300 }, // 20000/6
                maxLevel: 3
            },
            'skill_creator_def': {
                name: 'Thiên Đạo Hộ Thể',
                desc: 'Vạn pháp bất xâm, mọi đòn tấn công hóa hư vô.',
                icon: 'fa-solid fa-user-shield',
                color: 'text-rainbow-animation font-black',
                cost: 500000,
                effect: { stat: 'def', value: 1600 }, // 10000/6
                maxLevel: 3
            },
            'skill_creator_spd': {
                name: 'Nhất Niệm Vĩnh Hằng',
                desc: 'Tồn tại ở mọi nơi cùng lúc trong một ý niệm.',
                icon: 'fa-solid fa-clock',
                color: 'text-rainbow-animation font-black',
                cost: 500000,
                effect: { stat: 'spd', value: 1600 },
                maxLevel: 3
            },

            // --- TẦNG 8: HƯ VÔ (Cost: 1,000,000 ĐCH) ---
            'skill_void_hp': {
                name: 'Hư Vô Chi Thể',
                desc: 'Hòa vào hư vô, vượt qua khái niệm sinh tử.',
                icon: 'fa-solid fa-cloud',
                color: 'text-gray-500 font-black text-shadow-black',
                cost: 1000000,
                effect: { stat: 'hp', value: 80000 }, // 500000/6
                maxLevel: 3
            },
            'skill_void_atk': {
                name: 'Tịch Diệt Chỉ',
                desc: 'Một chỉ điểm ra, vạn vật quay về cát bụi.',
                icon: 'fa-solid fa-hand-point-up',
                color: 'text-gray-500 font-black text-shadow-black',
                cost: 1000000,
                effect: { stat: 'atk', value: 16000 }, // 100000/6
                maxLevel: 3
            },
            'skill_void_def': {
                name: 'Vô Tướng Vô Hình',
                desc: 'Không hình tướng, phòng ngự đạt cảnh giới hư ảo.',
                icon: 'fa-solid fa-ghost',
                color: 'text-gray-500 font-black text-shadow-black',
                cost: 1000000,
                effect: { stat: 'def', value: 8000 }, // 50000/6
                maxLevel: 3
            },
            'skill_void_spd': {
                name: 'Hư Không Bộ',
                desc: 'Bước đi trong khe hở không gian.',
                icon: 'fa-solid fa-shoe-prints',
                color: 'text-gray-500 font-black text-shadow-black',
                cost: 1000000,
                effect: { stat: 'spd', value: 8000 }, // 50000/6
                maxLevel: 3
            },

            // --- TẦNG 9: ĐẠO NGUYÊN (Cost: 5,000,000 ĐCH) ---
            'skill_origin_all': {
                name: 'Đạo Sinh Nhất',
                desc: 'Nắm giữ nguồn gốc sức mạnh, tăng mạnh TOÀN BỘ chỉ số.',
                icon: 'fa-solid fa-yin-yang',
                color: 'text-white font-black text-pulse-holy-glow',
                cost: 5000000,
                effect: { stat: 'atk', value: 80000 }, // 500000/6 ~ 83k
                maxLevel: 3
            },

            // --- TẦNG 10: CHÂN LÝ (Cost: 10,000,000 ĐCH) ---
            'skill_truth_hp': {
                name: 'Vĩnh Sinh Chân Giải',
                desc: 'Thấu hiểu chân lý sự sống, sinh mệnh vô tận.',
                icon: 'fa-solid fa-seedling',
                color: 'text-cyan-300 font-black text-shadow-cyan',
                cost: 10000000,
                effect: { stat: 'hp', value: 330000 }, // 2M/6
                maxLevel: 3
            },
            'skill_truth_atk': {
                name: 'Nhất Quyền Phá Vạn Pháp',
                desc: 'Một quyền đấm nát hư không, phá vỡ mọi quy tắc.',
                icon: 'fa-solid fa-hand-fist',
                color: 'text-cyan-300 font-black text-shadow-cyan',
                cost: 10000000,
                effect: { stat: 'atk', value: 80000 }, // 500k/6
                maxLevel: 3
            },
            'skill_truth_def': {
                name: 'Tuyệt Đối Phòng Ngự',
                desc: 'Tạo kết giới quy tắc, từ chối mọi tổn thương.',
                icon: 'fa-solid fa-shield-halved',
                color: 'text-cyan-300 font-black text-shadow-cyan',
                cost: 10000000,
                effect: { stat: 'def', value: 40000 }, // 250k/6
                maxLevel: 3
            },
            'skill_truth_spd': {
                name: 'Thuấn Gian Di Động',
                desc: 'Ý niệm vừa động thân đã tới, bỏ qua khoảng cách.',
                icon: 'fa-solid fa-bolt',
                color: 'text-cyan-300 font-black text-shadow-cyan',
                cost: 10000000,
                effect: { stat: 'spd', value: 40000 }, // 250k/6
                maxLevel: 3
            },

            // --- TẦNG 11: SIÊU THOÁT (Cost: 50,000,000 ĐCH) ---
            'skill_transcend_hp': {
                name: 'Bất Hủ Chi Hồn',
                desc: 'Linh hồn vượt qua luân hồi, vũ trụ sụp đổ ta vẫn còn.',
                icon: 'fa-solid fa-ankh',
                color: 'text-yellow-300 font-black text-pulse-glow',
                cost: 50000000,
                effect: { stat: 'hp', value: 1600000 }, // 10M/6
                maxLevel: 3
            },
            'skill_transcend_atk': {
                name: 'Diệt Thế Ma Đồng',
                desc: 'Ánh nhìn chiếu tới đâu, vạn vật hóa thành hư vô.',
                icon: 'fa-solid fa-eye',
                color: 'text-yellow-300 font-black text-pulse-glow',
                cost: 50000000,
                effect: { stat: 'atk', value: 330000 }, // 2M/6
                maxLevel: 3
            },
            'skill_transcend_def': {
                name: 'Hư Không Bích Lũy',
                desc: 'Hóa thân hư không, không ai tổn thương được cái không tồn tại.',
                icon: 'fa-solid fa-dungeon',
                color: 'text-yellow-300 font-black text-pulse-glow',
                cost: 50000000,
                effect: { stat: 'def', value: 160000 }, // 1M/6
                maxLevel: 3
            },
            'skill_transcend_spd': {
                name: 'Thời Gian Nghịch Lưu',
                desc: 'Bước đi trên dòng sông thời gian.',
                icon: 'fa-solid fa-hourglass-half',
                color: 'text-yellow-300 font-black text-pulse-glow',
                cost: 50000000,
                effect: { stat: 'spd', value: 160000 }, // 1M/6
                maxLevel: 3
            },

            // --- TẦNG 12: VÔ CỰC (Cost: 100,000,000 ĐCH) ---
            'skill_infinity_all': {
                name: 'Chúa Tể Vô Cực',
                desc: 'Khởi đầu và kết thúc. Sức mạnh không thể đo đếm.',
                icon: 'fa-solid fa-infinity',
                color: 'text-rainbow-animation font-black text-4xl',
                cost: 100000000,
                effect: { stat: 'atk', value: 830000 }, // 5M/6
                maxLevel: 3
            }
        };

        // [NEW] Blacksmith Upgrade Rates
        // Defines the cost, success rate, and stat bonus for each level +1, +2, etc.
        const UPGRADE_RATES_DB = {
            // Level 0 -> 1 (Item is +0)
            0: { stoneId: 'upgrade_stone_low', stoneAmount: 1, cost: 100, success: 95.0, statBonusPercent: 5 },
            // Level 1 -> 2
            1: { stoneId: 'upgrade_stone_low', stoneAmount: 2, cost: 250, success: 90.0, statBonusPercent: 6 },
            // Level 2 -> 3
            2: { stoneId: 'upgrade_stone_low', stoneAmount: 4, cost: 500, success: 85.0, statBonusPercent: 7 },
            // Level 3 -> 4
            3: { stoneId: 'upgrade_stone_medium', stoneAmount: 1, cost: 1000, success: 75.0, statBonusPercent: 8 },
            // Level 4 -> 5
            4: { stoneId: 'upgrade_stone_medium', stoneAmount: 2, cost: 2000, success: 65.0, statBonusPercent: 9 },
            // Level 5 -> 6
            5: { stoneId: 'upgrade_stone_medium', stoneAmount: 3, cost: 4000, success: 55.0, statBonusPercent: 10 },
            // Level 6 -> 7
            6: { stoneId: 'upgrade_stone_high', stoneAmount: 1, cost: 8000, success: 45.0, statBonusPercent: 12 },
            // Level 7 -> 8
            7: { stoneId: 'upgrade_stone_high', stoneAmount: 2, cost: 15000, success: 35.0, statBonusPercent: 14 },
            // Level 8 -> 9
            8: { stoneId: 'upgrade_stone_high', stoneAmount: 3, cost: 30000, success: 25.0, statBonusPercent: 16 },
            // Level 9 -> 10 (Max)
            9: { stoneId: 'upgrade_stone_high', stoneAmount: 5, cost: 50000, success: 15.0, statBonusPercent: 20 },
            // Max level
            10: { max: true }
        };

        // [NEW] Blacksmith Crafting Recipes
        const CRAFTING_DB = {
            'craft_stone_medium': {
                name: 'Chế Đá Cường Hóa (Trung)',
                desc: 'Chế tạo 1 Đá Cường Hóa (Trung) từ 5 Đá (Sơ).',
                icon: 'fa-solid fa-square',
                cost: [
                    { type: 'material', id: 'upgrade_stone_low', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 100 }
                ],
                reward: { type: 'material', id: 'upgrade_stone_medium', amount: 1 }
            },
            'craft_stone_high': {
                name: 'Chế Đá Cường Hóa (Cao)',
                desc: 'Chế tạo 1 Đá Cường Hóa (Cao) từ 5 Đá (Trung).',
                icon: 'fa-solid fa-star',
                cost: [
                    { type: 'material', id: 'upgrade_stone_medium', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 500 }
                ],
                reward: { type: 'material', id: 'upgrade_stone_high', amount: 1 }
            },
            // [MODIFIED] BỘ TRANG BỊ CÁ RỒNG (Dragon Fish Set) - LEVELING GOD SET
            'craft_special_sword': {
                name: 'Chế Tác Kiếm Cá Rồng',
                desc: 'Vũ khí sắc bén rèn từ vảy Cá Rồng. Hút sinh lực và tăng tốc độ tu luyện cực đại.',
                icon: 'fa-solid fa-khanda', // Kiếm
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 5 }, 
                    { type: 'currency', id: 'nganLuong', amount: 20000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'w6', name: "Kiếm Cá Rồng", type: 'weapon', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'atk', name: 'Công Kích', value: 600, display: 'Công Kích +600', isPercent: false },
                            { id: 'lifesteal', name: 'Hút Sinh Lực', value: 5, display: 'Hút Sinh Lực 5%', isPercent: true },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } 
                        ]
                    } 
                }
            },
            'craft_special_armor': {
                name: 'Chế Tác Giáp Cá Rồng',
                desc: 'Giáp nhẹ làm từ da Cá Rồng. Bền bỉ và hỗ trợ tu luyện.',
                icon: 'fa-solid fa-shield-heart', // [MODIFIED] Icon Giáp Vảy (Bảo vệ tim)
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 5 }, 
                    { type: 'currency', id: 'nganLuong', amount: 20000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'a6', name: "Giáp Cá Rồng", type: 'armor', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'hp', name: 'Sinh Lực', value: 3500, display: 'Sinh Lực +3500', isPercent: false },
                            { id: 'def', name: 'Phòng Thủ', value: 500, display: 'Phòng Thủ +500', isPercent: false },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } 
                        ]
                    } 
                }
            },
            'craft_special_ring': {
                name: 'Chế Tác Nhẫn Cá Rồng',
                desc: 'Nhẫn khảm mắt Cá Rồng. Tăng cường vận may và ngộ tính.',
                icon: 'fa-solid fa-ring', // [MODIFIED] Icon Nhẫn
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 3 }, 
                    { type: 'currency', id: 'nganLuong', amount: 10000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'r6', name: "Nhẫn Cá Rồng", type: 'accessory', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'lck', name: 'May Mắn', value: 20, display: 'May Mắn +20', isPercent: false },
                            { id: 'mana', name: 'Nội Lực', value: 300, display: 'Nội Lực +300', isPercent: false },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } 
                        ]
                    } 
                }
            },
            'craft_special_pendant': {
                name: 'Chế Tác Bội Cá Rồng',
                desc: 'Ngọc bội hình Cá Rồng. Giúp tu luyện thần tốc.',
                icon: 'fa-solid fa-yin-yang', // [MODIFIED] Icon Ngọc Bội (Âm Dương)
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 3 }, 
                    { type: 'currency', id: 'nganLuong', amount: 15000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'r5', name: "Bội Cá Rồng", type: 'accessory', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'spd', name: 'Thân Pháp', value: 80, display: 'Thân Pháp +80', isPercent: false },
                            { id: 'lck', name: 'May Mắn', value: 25, display: 'May Mắn +25', isPercent: false },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } 
                        ]
                    } 
                }
            },
            // [MODIFIED] Hạng Liên Cá Rồng (Necklace)
            'craft_special_necklace': {
                name: 'Chế Tác Hạng Liên Cá Rồng',
                desc: 'Dây chuyền kết từ vây Cá Rồng. Tăng khả năng tấn công và tu luyện.',
                icon: 'fa-solid fa-link', // [MODIFIED] Icon Dây chuyền (Xích)
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 4 }, 
                    { type: 'currency', id: 'nganLuong', amount: 18000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'r3', name: "Hạng Liên Cá Rồng", type: 'accessory', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'atk', name: 'Công Kích', value: 300, display: 'Công Kích +300', isPercent: false },
                            { id: 'lifesteal', name: 'Hút Sinh Lực', value: 3, display: 'Hút Sinh Lực 3%', isPercent: true },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } 
                        ]
                    } 
                }
            },
            // [MODIFIED] Mật Tịch Cá Rồng (Manual)
            'craft_special_manual': {
                name: 'Chế Tác Mật Tịch Cá Rồng',
                desc: 'Bí kíp ghi chép long ngữ. Gia tăng kinh nghiệm cực đại.',
                icon: 'fa-solid fa-book-atlas', // [MODIFIED] Icon Sách Cổ/Bản Đồ
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 4 }, 
                    { type: 'currency', id: 'nganLuong', amount: 18000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'r5', name: "Mật Tịch Cá Rồng", type: 'accessory', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'mana', name: 'Nội Lực', value: 800, display: 'Nội Lực +800', isPercent: false },
                            { id: 'manasteal', name: 'Hút Nội Lực', value: 3, display: 'Hút Nội Lực 3%', isPercent: true },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } 
                        ]
                    } 
                }
            },
            // [MODIFIED] Phi Phong Cá Rồng (Cloak)
            'craft_special_cloak': {
                name: 'Chế Tác Phi Phong Cá Rồng',
                desc: 'Áo choàng dệt từ râu Cá Rồng. Nhẹ tựa lông hồng, tu hành ngàn dặm.',
                icon: 'fa-solid fa-wind', // [MODIFIED] Icon Gió (Tốc độ/Bay)
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 5 }, 
                    { type: 'currency', id: 'nganLuong', amount: 20000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'r4', name: "Phi Phong Cá Rồng", type: 'accessory', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'spd', name: 'Thân Pháp', value: 120, display: 'Thân Pháp +120', isPercent: false },
                            { id: 'dodgeChance', name: 'Né Tránh', value: 8, display: 'Né Tránh +8%', isPercent: true },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } 
                        ]
                    } 
                }
            },
            // [MODIFIED] Bảo Vật Cá Rồng (Artifact)
            'craft_special_artifact': {
                name: 'Chế Tác Bảo Vật Cá Rồng',
                desc: 'Bảo châu long khí. Tăng toàn diện chỉ số và kinh nghiệm.',
                icon: 'fa-solid fa-dragon', // [MODIFIED] Icon Rồng
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 6 }, 
                    { type: 'currency', id: 'nganLuong', amount: 25000 }
                ],
                reward: { 
                    type: 'equipment', 
                    item: {
                        baseId: 'r6', name: "Bảo Vật Cá Rồng", type: 'accessory', level: 60, quality: 'rare', upgradeLevel: 0,
                        affixes: [
                            { id: 'hp_p', name: 'Sinh Lực %', value: 8, display: 'Sinh Lực +8%', isPercent: true },
                            { id: 'atk_p', name: 'Công Kích %', value: 8, display: 'Công Kích +8%', isPercent: true },
                            { id: 'xp_boost', name: 'Kinh Nghiệm', value: 500, display: 'Kinh Nghiệm +500%', isPercent: true } // [NEW]
                        ]
                    } 
                }
            },
            
            // [NEW] Recipe 4: Disciple XP Pill
            'craft_disciple_pill_1': {
                name: 'Luyện Đan Đệ Tử (Sơ)',
                desc: 'Chế tạo 1 Đệ Tử Tu Luyện Đan.',
                cost: [
                    { type: 'material', id: 'fish_uncommon_1', amount: 10 }, // 10 Cá Chép
                    { type: 'material', id: 'fish_uncommon_2', amount: 5 },  // 5 Cá Lóc
                    { type: 'currency', id: 'nganLuong', amount: 500 }
                ],
                reward: { type: 'item', id: 'disciple_xp_pill_1', amount: 1 } // Reward is an 'item'
            },
            // [MODIFIED] Replaced HP/Mana potions with Disciple Potions
            'craft_disciple_pill_2': {
                name: 'Luyện Đan Đệ Tử (Trung)',
                desc: 'Chế tạo 1 Đệ Tử Đan (Trung).',
                cost: [
                    { type: 'material', id: 'fish_rare_1', amount: 10 },    // 10 Cá Vàng
                    { type: 'material', id: 'fish_rare_2', amount: 5 },     // 5 Cá Trắm Cỏ
                    { type: 'currency', id: 'nganLuong', amount: 2000 }
                ],
                reward: { type: 'item', id: 'disciple_xp_pill_2', amount: 1 }
            },
            'craft_disciple_pill_3': {
                name: 'Luyện Đan Đệ Tử (Cao)',
                desc: 'Chế tạo 1 Đệ Tử Đan (Cao).',
                cost: [
                    { type: 'material', id: 'fish_rare_2', amount: 10 },    // 10 Cá Trắm Cỏ
                    { type: 'material', id: 'fish_epic_1', amount: 5 },     // 5 Cá Rồng
                    { type: 'currency', id: 'nganLuong', amount: 10000 }
                ],
                reward: { type: 'item', id: 'disciple_xp_pill_3', amount: 1 }
            }
            // [NEW] --- Disciple Permanent Stat Pill Recipes ---
            ,'craft_disciple_atk_pill_1': {
                name: 'Luyện Luyện Cốt Đan (Sơ)',
                desc: 'Chế tạo 1 Luyện Cốt Đan (Sơ) (+2 Công).',
                cost: [
                    { type: 'material', id: 'ore_uncommon_1', amount: 10 }, // 10 Mảnh Đồng
                    { type: 'material', id: 'herb_uncommon_1', amount: 10 }, // 10 Bạc Hà
                    { type: 'currency', id: 'nganLuong', amount: 5000 }
                ],
                reward: { type: 'item', id: 'disciple_atk_pill_1', amount: 1 }
            },
            'craft_disciple_hp_pill_1': {
                name: 'Luyện Tẩy Tủy Đan (Sơ)',
                desc: 'Chế tạo 1 Tẩy Tủy Đan (Sơ) (+10 HP).',
                cost: [
                    { type: 'material', id: 'ore_common_1', amount: 20 }, // 20 Mảnh Sắt
                    { type: 'material', id: 'herb_common_1', amount: 20 }, // 20 Cỏ Dại
                    { type: 'currency', id: 'nganLuong', amount: 5000 }
                ],
                reward: { type: 'item', id: 'disciple_hp_pill_1', amount: 1 }
            },
            'craft_disciple_def_pill_1': {
                name: 'Luyện Thiết Cốt Đan (Sơ)',
                desc: 'Chế tạo 1 Thiết Cốt Đan (Sơ) (+2 Thủ).',
                cost: [
                    { type: 'material', id: 'ore_uncommon_1', amount: 15 }, // 15 Mảnh Đồng
                    { type: 'material', id: 'herb_common_1', amount: 10 }, // 10 Cỏ Dại
                    { type: 'currency', id: 'nganLuong', amount: 7500 }
                ],
                reward: { type: 'item', id: 'disciple_def_pill_1', amount: 1 }
            },
            'craft_disciple_spd_pill_1': {
                name: 'Luyện Linh Tốc Đan (Sơ)',
                desc: 'Chế tạo 1 Linh Tốc Đan (Sơ) (+2 Thân).',
                cost: [
                    { type: 'material', id: 'ore_common_1', amount: 10 }, // 10 Mảnh Sắt
                    { type: 'material', id: 'herb_uncommon_1', amount: 15 }, // 15 Bạc Hà
                    { type: 'currency', id: 'nganLuong', amount: 7500 }
                ],
                reward: { type: 'item', id: 'disciple_spd_pill_1', amount: 1 }
            }
            // [NEW] --- Disciple Permanent Stat Pill Recipes (Tier 2) ---
            ,'craft_disciple_atk_pill_2': {
                name: 'Luyện Luyện Cốt Đan (Trung)',
                desc: 'Chế tạo 1 Luyện Cốt Đan (Trung) (+10 Công).',
                cost: [
                    { type: 'material', id: 'ore_rare_1', amount: 10 }, // 10 Mảnh Bạc
                    { type: 'material', id: 'herb_rare_1', amount: 10 }, // 10 Linh Chi
                    { type: 'currency', id: 'nganLuong', amount: 25000 }
                ],
                reward: { type: 'item', id: 'disciple_atk_pill_2', amount: 1 }
            },
            'craft_disciple_hp_pill_2': {
                name: 'Luyện Tẩy Tủy Đan (Trung)',
                desc: 'Chế tạo 1 Tẩy Tủy Đan (Trung) (+50 HP).',
                cost: [
                    { type: 'material', id: 'ore_rare_1', amount: 20 }, // 20 Mảnh Bạc
                    { type: 'material', id: 'herb_rare_1', amount: 20 }, // 20 Linh Chi
                    { type: 'currency', id: 'nganLuong', amount: 25000 }
                ],
                reward: { type: 'item', id: 'disciple_hp_pill_2', amount: 1 }
            },
            'craft_disciple_def_pill_2': {
                name: 'Luyện Thiết Cốt Đan (Trung)',
                desc: 'Chế tạo 1 Thiết Cốt Đan (Trung) (+10 Thủ).',
                cost: [
                    { type: 'material', id: 'ore_rare_1', amount: 15 }, // 15 Mảnh Bạc
                    { type: 'material', id: 'herb_rare_1', amount: 10 }, // 10 Linh Chi
                    { type: 'currency', id: 'nganLuong', amount: 35000 }
                ],
                reward: { type: 'item', id: 'disciple_def_pill_2', amount: 1 }
            },
            'craft_disciple_spd_pill_2': {
                name: 'Luyện Linh Tốc Đan (Trung)',
                desc: 'Chế tạo 1 Linh Tốc Đan (Trung) (+10 Thân).',
                cost: [
                    { type: 'material', id: 'ore_rare_1', amount: 10 }, // 10 Mảnh Bạc
                    { type: 'material', id: 'herb_rare_1', amount: 15 }, // 15 Linh Chi
                    { type: 'currency', id: 'nganLuong', amount: 35000 }
                ],
                reward: { type: 'item', id: 'disciple_spd_pill_2', amount: 1 }
            }
            // [NEW] --- Disciple Permanent Stat Pill Recipes (Tier 3) ---
            ,'craft_disciple_atk_pill_3': {
                name: 'Luyện Luyện Cốt Đan (Cao)',
                desc: 'Chế tạo 1 Luyện Cốt Đan (Cao) (+25 Công).',
                cost: [
                    { type: 'material', id: 'ore_epic_1', amount: 10 }, // 10 Mảnh Vàng
                    { type: 'material', id: 'herb_epic_1', amount: 10 }, // 10 Nhân Sâm
                    { type: 'currency', id: 'nganLuong', amount: 100000 }
                ],
                reward: { type: 'item', id: 'disciple_atk_pill_3', amount: 1 }
            },
            'craft_disciple_hp_pill_3': {
                name: 'Luyện Tẩy Tủy Đan (Cao)',
                desc: 'Chế tạo 1 Tẩy Tủy Đan (Cao) (+125 HP).',
                cost: [
                    { type: 'material', id: 'ore_epic_1', amount: 20 }, // 20 Mảnh Vàng
                    { type: 'material', id: 'herb_epic_1', amount: 20 }, // 20 Nhân Sâm
                    { type: 'currency', id: 'nganLuong', amount: 100000 }
                ],
                reward: { type: 'item', id: 'disciple_hp_pill_3', amount: 1 }
            },
            'craft_disciple_def_pill_3': {
                name: 'Luyện Thiết Cốt Đan (Cao)',
                desc: 'Chế tạo 1 Thiết Cốt Đan (Cao) (+25 Thủ).',
                cost: [
                    { type: 'material', id: 'ore_epic_1', amount: 15 }, // 15 Mảnh Vàng
                    { type: 'material', id: 'herb_epic_1', amount: 10 }, // 10 Nhân Sâm
                    { type: 'currency', id: 'nganLuong', amount: 150000 }
                ],
                reward: { type: 'item', id: 'disciple_def_pill_3', amount: 1 }
            },
            'craft_disciple_spd_pill_3': {
                name: 'Luyện Linh Tốc Đan (Cao)',
                desc: 'Chế tạo 1 Linh Tốc Đan (Cao) (+25 Thân).',
                cost: [
                    { type: 'material', id: 'ore_epic_1', amount: 10 }, // 10 Mảnh Vàng
                    { type: 'material', id: 'herb_epic_1', amount: 15 }, // 15 Nhân Sâm
                    { type: 'currency', id: 'nganLuong', amount: 150000 }
                ],
                reward: { type: 'item', id: 'disciple_spd_pill_3', amount: 1 }
            }
            // [NEW] --- Player XP Food Recipes (Canh Cá) ---
            ,'craft_food_xp_1': {
                name: 'Nấu Canh Cá XP (Sơ)',
                desc: 'Chế tạo 1 Canh Cá XP (Sơ) (+5% XP).',
                cost: [
                    { type: 'material', id: 'fish_common_1', amount: 5 }, // 5 Cá Diếc
                    { type: 'material', id: 'fish_common_2', amount: 5 }, // 5 Cá Rô
                    { type: 'currency', id: 'nganLuong', amount: 100 }
                ],
                reward: { type: 'item', id: 'food_xp_1', amount: 1 }
            },
            'craft_food_xp_2': {
                name: 'Nấu Canh Cá XP (Trung)',
                desc: 'Chế tạo 1 Canh Cá XP (Trung) (+15% XP).',
                cost: [
                    { type: 'material', id: 'fish_uncommon_1', amount: 5 }, // 5 Cá Chép
                    { type: 'material', id: 'fish_uncommon_2', amount: 5 }, // 5 Cá Lóc
                    { type: 'currency', id: 'nganLuong', amount: 500 }
                ],
                reward: { type: 'item', id: 'food_xp_2', amount: 1 }
            },
            'craft_food_xp_3': {
                name: 'Nấu Canh Cá XP (Cao)',
                desc: 'Chế tạo 1 Canh Cá XP (Cao) (+30% XP).',
                cost: [
                    { type: 'material', id: 'fish_rare_1', amount: 5 }, // 5 Cá Vàng
                    { type: 'material', id: 'fish_rare_2', amount: 5 }, // 5 Cá Trắm Cỏ
                    { type: 'currency', id: 'nganLuong', amount: 2000 }
                ],
                reward: { type: 'item', id: 'food_xp_3', amount: 1 }
            },
            'craft_food_xp_4': {
                name: 'Nấu Canh Cá XP (Thần)',
                desc: 'Chế tạo 1 Canh Cá XP (Thần) (+50% XP).',
                cost: [
                    { type: 'material', id: 'fish_epic_1', amount: 5 }, // 5 Cá Rồng
                    { type: 'currency', id: 'nganLuong', amount: 10000 }
                ],
                reward: { type: 'item', id: 'food_xp_4', amount: 1 }
            },

            // [NEW] --- CÔNG THỨC CHẾ TẠO BẠCH KIM (PLATINUM RECIPES) ---
            'craft_platinum_atk': {
                name: 'Luyện Bạch Kim Chiến Đan',
                desc: 'Chế tạo đan dược tăng 1000 Công Kích vĩnh viễn.',
                icon: 'fa-solid fa-fist-raised',
                cost: [
                    { type: 'material', id: 'ore_mythic_1', amount: 5 }, // 5 Mảnh Bạch Kim
                    { type: 'material', id: 'ore_epic_1', amount: 10 },  // 10 Mảnh Vàng
                    { type: 'currency', id: 'nganLuong', amount: 5000000 } // 5M NL
                ],
                reward: { type: 'item', id: 'pill_stat_platinum_atk', amount: 1 }
            },
            'craft_platinum_hp': {
                name: 'Luyện Bạch Kim Huyết Đan',
                desc: 'Chế tạo đan dược tăng 10,000 Sinh Lực vĩnh viễn.',
                icon: 'fa-solid fa-heart',
                cost: [
                    { type: 'material', id: 'ore_mythic_1', amount: 5 }, // 5 Mảnh Bạch Kim
                    { type: 'material', id: 'herb_mythic_1', amount: 5 }, // 5 Tuyết Liên (Nếu có) hoặc dùng 10 Linh Chi
                    // Fallback nếu chưa có herb_mythic_1: dùng ore_epic_1
                    { type: 'material', id: 'ore_epic_1', amount: 10 },
                    { type: 'currency', id: 'nganLuong', amount: 5000000 }
                ],
                reward: { type: 'item', id: 'pill_stat_platinum_hp', amount: 1 }
            },
            'craft_godly_box': {
                name: 'Chế Rương Thần Ma',
                desc: 'Hợp thành Rương chứa trang bị cao cấp ngẫu nhiên.',
                icon: 'fa-solid fa-box',
                cost: [
                    { type: 'material', id: 'ore_mythic_1', amount: 10 }, // 10 Mảnh Bạch Kim
                    { type: 'currency', id: 'kimNguyenBao', amount: 1000 } // 1000 KNB
                ],
                reward: { type: 'item', id: 'box_gear_godly', amount: 1 }
            },

            // [NEW] Công thức chế Cá Siêu Thần (V1.97)
            'craft_food_xp_super_god': {
                name: 'Nấu Cá Siêu Thần',
                desc: 'Chế tạo 1 Cá Siêu Thần (35 Tỷ XP). Tinh hoa hội tụ, đất trời dung hợp.',
                cost: [
                    { type: 'material', id: 'fish_common_1', amount: 500 },   
                    { type: 'material', id: 'fish_common_2', amount: 500 },   
                    { type: 'material', id: 'fish_uncommon_1', amount: 250 }, 
                    { type: 'material', id: 'fish_uncommon_2', amount: 250 }, 
                    { type: 'material', id: 'fish_rare_1', amount: 100 },     
                    { type: 'material', id: 'fish_rare_2', amount: 100 },     
                    { type: 'material', id: 'fish_epic_1', amount: 25 },      
                    { type: 'currency', id: 'nganLuong', amount: 25000000 }   
                ],
                reward: { type: 'item', id: 'food_xp_super_god', amount: 1 }
            },

            // [NEW] Công thức chế Vĩnh Hằng Chi Ngư (V1.98) - Gấp 3 lần Cá Siêu Thần
            'craft_food_xp_eternal_fish': {
                name: 'Nấu Vĩnh Hằng Chi Ngư',
                desc: 'Chế tạo 1 Vĩnh Hằng Chi Ngư (175 Tỷ XP). Món ăn xuyên thấu thời không.',
                cost: [
                    { type: 'material', id: 'fish_common_1', amount: 1500 },  // 500 * 3
                    { type: 'material', id: 'fish_common_2', amount: 1500 },  // 500 * 3
                    { type: 'material', id: 'fish_uncommon_1', amount: 750 }, // 250 * 3
                    { type: 'material', id: 'fish_uncommon_2', amount: 750 }, // 250 * 3
                    { type: 'material', id: 'fish_rare_1', amount: 300 },     // 100 * 3
                    { type: 'material', id: 'fish_rare_2', amount: 300 },     // 100 * 3
                    { type: 'material', id: 'fish_epic_1', amount: 75 },      // 25 * 3
                    { type: 'currency', id: 'nganLuong', amount: 500000000 }  // 500 Triệu NL
                ],
                reward: { type: 'item', id: 'food_xp_eternal_fish', amount: 1 }
            },

            // [NEW] Công thức chế Bất Diệt Ngư (V1.99) - Gấp 2 Vĩnh Hằng Chi Ngư
            'craft_food_xp_immortal_fish': {
                name: 'Nấu Bất Diệt Ngư',
                desc: 'Chế tạo 1 Bất Diệt Ngư (500 Tỷ XP). Món ăn trường sinh bất tử.',
                cost: [
                    { type: 'material', id: 'fish_common_1', amount: 3000 },  // 1500 * 2
                    { type: 'material', id: 'fish_common_2', amount: 3000 },  // 1500 * 2
                    { type: 'material', id: 'fish_uncommon_1', amount: 1500 }, // 750 * 2
                    { type: 'material', id: 'fish_uncommon_2', amount: 1500 }, // 750 * 2
                    { type: 'material', id: 'fish_rare_1', amount: 600 },     // 300 * 2
                    { type: 'material', id: 'fish_rare_2', amount: 600 },     // 300 * 2
                    { type: 'material', id: 'fish_epic_1', amount: 150 },     // 75 * 2
                    { type: 'currency', id: 'nganLuong', amount: 2000000000 } // 2 Tỷ NL
                ],
                reward: { type: 'item', id: 'food_xp_immortal_fish', amount: 1 }
            },

            // [NEW] Công thức chế Thái Sơ Ngư (V1.99b) - Gấp 2 Bất Diệt Ngư
            'craft_food_xp_primordial_fish': {
                name: 'Nấu Thái Sơ Ngư',
                desc: 'Chế tạo 1 Thái Sơ Ngư (2500 Tỷ XP). Thủy tổ của loài cá.',
                cost: [
                    { type: 'material', id: 'fish_common_1', amount: 6000 },  // 3000 * 2
                    { type: 'material', id: 'fish_common_2', amount: 6000 },  // 3000 * 2
                    { type: 'material', id: 'fish_uncommon_1', amount: 3000 }, // 1500 * 2
                    { type: 'material', id: 'fish_uncommon_2', amount: 3000 }, // 1500 * 2
                    { type: 'material', id: 'fish_rare_1', amount: 1200 },    // 600 * 2
                    { type: 'material', id: 'fish_rare_2', amount: 1200 },    // 600 * 2
                    { type: 'material', id: 'fish_epic_1', amount: 300 },     // 150 * 2
                    { type: 'currency', id: 'nganLuong', amount: 5000000000 } // 5 Tỷ NL
                ],
                reward: { type: 'item', id: 'food_xp_primordial_fish', amount: 1 }
            },

            // [NEW] Socket Gem Crafting Recipes - Thêm công thức chế Thủy Tinh
            'craft_gem_green': {
                name: 'Chế Tác Lục Thủy Tinh (Sơ)',
                desc: 'Chế tạo 1 Lục Thủy Tinh (Sơ).',
                cost: [
                    { type: 'material', id: 'ore_common_1', amount: 5 }, // 5 Mảnh Sắt
                    { type: 'currency', id: 'nganLuong', amount: 100 }
                ],
                reward: { type: 'material', id: 'gem_green_1', amount: 1 }
            },
            'craft_gem_blue': {
                name: 'Chế Tác Lam Thủy Tinh (Sơ)',
                desc: 'Chế tạo 1 Lam Thủy Tinh (Sơ).',
                cost: [
                    { type: 'material', id: 'ore_uncommon_1', amount: 5 }, // 5 Mảnh Đồng
                    { type: 'currency', id: 'nganLuong', amount: 500 }
                ],
                reward: { type: 'material', id: 'gem_blue_1', amount: 1 }
            },
            'craft_gem_purple': {
                name: 'Chế Tác Tử Thủy Tinh (Sơ)',
                desc: 'Chế tạo 1 Tử Thủy Tinh (Sơ).',
                cost: [
                    { type: 'material', id: 'ore_rare_1', amount: 5 }, // 5 Mảnh Bạc
                    { type: 'currency', id: 'nganLuong', amount: 2000 }
                ],
                reward: { type: 'material', id: 'gem_purple_1', amount: 1 }
            },
            'craft_gem_yellow': {
                name: 'Chế Tác Hoàng Thủy Tinh (Sơ)',
                desc: 'Chế tạo 1 Hoàng Thủy Tinh (Sơ).',
                cost: [
                    { type: 'material', id: 'ore_epic_1', amount: 5 }, // 5 Mảnh Vàng
                    { type: 'currency', id: 'nganLuong', amount: 10000 }
                ],
                reward: { type: 'material', id: 'gem_yellow_1', amount: 1 }
            }
            // [NEW] --- Nâng Cấp (Ghép) Thủy Tinh (Tier 2) ---
            ,'craft_gem_green_2': {
                name: 'Ghép Lục Thủy Tinh (Trung)',
                desc: 'Ghép 5 Lục Thủy Tinh (Sơ) thành 1 (Trung).',
                cost: [
                    { type: 'material', id: 'gem_green_1', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 1000 }
                ],
                reward: { type: 'material', id: 'gem_green_2', amount: 1 }
            },
            'craft_gem_blue_2': {
                name: 'Ghép Lam Thủy Tinh (Trung)',
                desc: 'Ghép 5 Lam Thủy Tinh (Sơ) thành 1 (Trung).',
                cost: [
                    { type: 'material', id: 'gem_blue_1', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 5000 }
                ],
                reward: { type: 'material', id: 'gem_blue_2', amount: 1 }
            },
            'craft_gem_purple_2': {
                name: 'Ghép Tử Thủy Tinh (Trung)',
                desc: 'Ghép 5 Tử Thủy Tinh (Sơ) thành 1 (Trung).',
                cost: [
                    { type: 'material', id: 'gem_purple_1', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 20000 }
                ],
                reward: { type: 'material', id: 'gem_purple_2', amount: 1 }
            },
            'craft_gem_yellow_2': {
                name: 'Ghép Hoàng Thủy Tinh (Trung)',
                desc: 'Ghép 5 Hoàng Thủy Tinh (Sơ) thành 1 (Trung).',
                cost: [
                    { type: 'material', id: 'gem_yellow_1', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 100000 }
                ],
                reward: { type: 'material', id: 'gem_yellow_2', amount: 1 }
            }
            // [NEW] --- Nâng Cấp (Ghép) Thủy Tinh (Tier 3) ---
            ,'craft_gem_green_3': {
                name: 'Ghép Lục Thủy Tinh (Cao)',
                desc: 'Ghép 5 Lục Thủy Tinh (Trung) thành 1 (Cao).',
                cost: [
                    { type: 'material', id: 'gem_green_2', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 5000 }
                ],
                reward: { type: 'material', id: 'gem_green_3', amount: 1 }
            },
            'craft_gem_blue_3': {
                name: 'Ghép Lam Thủy Tinh (Cao)',
                desc: 'Ghép 5 Lam Thủy Tinh (Trung) thành 1 (Cao).',
                cost: [
                    { type: 'material', id: 'gem_blue_2', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 25000 }
                ],
                reward: { type: 'material', id: 'gem_blue_3', amount: 1 }
            },
            'craft_gem_purple_3': {
                name: 'Ghép Tử Thủy Tinh (Cao)',
                desc: 'Ghép 5 Tử Thủy Tinh (Trung) thành 1 (Cao).',
                cost: [
                    { type: 'material', id: 'gem_purple_2', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 100000 }
                ],
                reward: { type: 'material', id: 'gem_purple_3', amount: 1 }
            },
            'craft_gem_yellow_3': {
                name: 'Ghép Hoàng Thủy Tinh (Cao)',
                desc: 'Ghép 5 Hoàng Thủy Tinh (Trung) thành 1 (Cao).',
                cost: [
                    { type: 'material', id: 'gem_yellow_2', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 500000 }
                ],
                reward: { type: 'material', id: 'gem_yellow_3', amount: 1 }
            }
            // [NEW] --- Nâng Cấp (Ghép) Thủy Tinh (Tier 4) ---
            ,'craft_gem_green_4': {
                name: 'Ghép Lục Thủy Tinh (Siêu)',
                desc: 'Ghép 5 Lục Thủy Tinh (Cao) thành 1 (Siêu).',
                cost: [
                    { type: 'material', id: 'gem_green_3', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 25000 }
                ],
                reward: { type: 'material', id: 'gem_green_4', amount: 1 }
            },
            'craft_gem_blue_4': {
                name: 'Ghép Lam Thủy Tinh (Siêu)',
                desc: 'Ghép 5 Lam Thủy Tinh (Cao) thành 1 (Siêu).',
                cost: [
                    { type: 'material', id: 'gem_blue_3', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 125000 }
                ],
                reward: { type: 'material', id: 'gem_blue_4', amount: 1 }
            },
            'craft_gem_purple_4': {
                name: 'Ghép Tử Thủy Tinh (Siêu)',
                desc: 'Ghép 5 Tử Thủy Tinh (Cao) thành 1 (Siêu).',
                cost: [
                    { type: 'material', id: 'gem_purple_3', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 500000 }
                ],
                reward: { type: 'material', id: 'gem_purple_4', amount: 1 }
            },
            'craft_gem_yellow_4': {
                name: 'Ghép Hoàng Thủy Tinh (Siêu)',
                desc: 'Ghép 5 Hoàng Thủy Tinh (Cao) thành 1 (Siêu).',
                cost: [
                    { type: 'material', id: 'gem_yellow_3', amount: 5 },
                    { type: 'currency', id: 'nganLuong', amount: 2500000 }
                ],
                reward: { type: 'material', id: 'gem_yellow_4', amount: 1 }
            }
        };

        // [NEW] Item Exchange Database (For Tien Trang)
        const ITEM_EXCHANGE_DB = {
            'exchange_fish_uncommon': {
                name: 'Đổi Cá (Hiếm)',
                desc: 'Đổi 5 Cá Diếc và 5 Cá Rô lấy 1 Cá Chép.',
                cost: [
                    { type: 'material', id: 'fish_common_1', amount: 5 },
                    { type: 'material', id: 'fish_common_2', amount: 5 }
                ],
                reward: { type: 'material', id: 'fish_uncommon_1', amount: 1 }
            },
            'exchange_fish_rare': {
                name: 'Đổi Cá (Quý)',
                desc: 'Đổi 5 Cá Chép và 5 Cá Lóc lấy 1 Cá Vàng.',
                cost: [
                    { type: 'material', id: 'fish_uncommon_1', amount: 5 },
                    { type: 'material', id: 'fish_uncommon_2', amount: 5 }
                ],
                reward: { type: 'material', id: 'fish_rare_1', amount: 1 }
            },
            'exchange_ore_uncommon': {
                name: 'Đổi Khoáng (Hiếm)',
                desc: 'Đổi 5 Mảnh Sắt lấy 1 Mảnh Đồng.',
                cost: [
                    { type: 'material', id: 'ore_common_1', amount: 5 }
                ],
                reward: { type: 'material', id: 'ore_uncommon_1', amount: 1 }
            },
            'exchange_ore_rare': {
                name: 'Đổi Khoáng (Quý)',
                desc: 'Đổi 5 Mảnh Đồng lấy 1 Mảnh Bạc.',
                cost: [
                    { type: 'material', id: 'ore_uncommon_1', amount: 5 }
                ],
                reward: { type: 'material', id: 'ore_rare_1', amount: 1 }
            },
            'exchange_herb_uncommon': {
                name: 'Đổi Thảo Dược (Hiếm)',
                desc: 'Đổi 5 Cỏ Dại lấy 1 Bạc Hà.',
                cost: [
                    { type: 'material', id: 'herb_common_1', amount: 5 }
                ],
                reward: { type: 'material', id: 'herb_uncommon_1', amount: 1 }
            },
            'exchange_herb_rare': {
                name: 'Đổi Thảo Dược (Quý)',
                desc: 'Đổi 5 Bạc Hà lấy 1 Linh Chi.',
                cost: [
                    { type: 'material', id: 'herb_uncommon_1', amount: 5 }
                ],
                reward: { type: 'material', id: 'herb_rare_1', amount: 1 }
            }
        };

        // *** NEW: Loot Generation Databases (Lò Rèn) ***
        
        // [MODIFIED] Adjusted chances and added Siêu Thần (Super Godly)
        // [FIX] Đổi màu color của supergodly từ #27272a (đen) sang #facc15 (vàng) để hiển thị rõ chữ
        const QUALITY_DB = {
            'common':    { name: 'Thường', chance: 59.89, minAffix: 0, maxAffix: 1, multiplier: 1.0, className: 'quality-common', color: '#ffffff' },
            'uncommon':  { name: 'Hiếm',   chance: 25.0, minAffix: 1, maxAffix: 2, multiplier: 1.5, className: 'quality-uncommon', color: '#60a5fa' },
            'rare':      { name: 'Quý',    chance: 10.0, minAffix: 2, maxAffix: 3, multiplier: 2.2, className: 'quality-rare', color: '#c084fc' },
            'legendary': { name: 'Sử Thi', chance: 4.0,  minAffix: 3, maxAffix: 4, multiplier: 3.5, className: 'quality-legendary', color: '#facc15' },
            'epic':      { name: 'Thần Thoại', chance: 0.9, minAffix: 4, maxAffix: 5, multiplier: 5.0, className: 'quality-epic', color: '#f97316' }, 
            'mythic':    { name: 'Chí Tôn', chance: 0.2, minAffix: 5, maxAffix: 6, multiplier: 7.0, className: 'quality-mythic', color: '#ef4444' },
            // [NEW] An Bang Set (Không rớt, chỉ bán)
            'anbang':    { name: 'An Bang', chance: 0.0, minAffix: 5, maxAffix: 5, multiplier: 7.5, className: 'quality-anbang', color: '#a3e635' },
            
            // [FIX] Cập nhật màu chữ hiển thị
            'supergodly':{ name: 'Siêu Thần', chance: 0.01, minAffix: 6, maxAffix: 7, multiplier: 10.0, className: 'quality-supergodly', color: '#facc15' } 
        };
        
        // [FIX] Bổ sung lại AFFIX_DB (Database Dòng Chỉ Số) bị thiếu
        const AFFIX_DB = [
            // Primary Stats
            { id: 'hp', name: 'Sinh Lực', baseValue: 8, isPercent: false },
            { id: 'mana', name: 'Nội Lực', baseValue: 4, isPercent: false },
            { id: 'atk', name: 'Công Kích', baseValue: 1, isPercent: false },
            { id: 'def', name: 'Phòng Thủ', baseValue: 1, isPercent: false },
            { id: 'spd', name: 'Thân Pháp', baseValue: 0.5, isPercent: false },
            { id: 'lck', name: 'May Mắn', baseValue: 0.5, isPercent: false },
            // Percentage Stats
            { id: 'hp_p', name: 'Sinh Lực %', baseValue: 0.5, isPercent: true },
            { id: 'atk_p', name: 'Công Kích %', baseValue: 0.5, isPercent: true },
            { id: 'def_p', name: 'Phòng Thủ %', baseValue: 0.5, isPercent: true },
            // Special Stats
            { id: 'critChance', name: 'Chí Mạng', baseValue: 0.2, isPercent: true },
            { id: 'critDamage', name: 'ST Chí Mạng', baseValue: 1.0, isPercent: true },
            { id: 'dodgeChance', name: 'Né Tránh', baseValue: 0.2, isPercent: true },
            { id: 'lifesteal', name: 'Hút Sinh Lực', baseValue: 0.1, isPercent: true },
            { id: 'manasteal', name: 'Hút Nội Lực', baseValue: 0.1, isPercent: true },
            { id: 'xp_boost', name: 'Tăng KN', baseValue: 0.5, isPercent: true },
            { id: 'ignoreDef_p', name: 'Bỏ qua DEF', baseValue: 0.2, isPercent: true }
        ];

        // [FIX] Bổ sung lại BASE_ITEM_DB (Database Trang Bị Cơ Bản) bị thiếu
        const BASE_ITEM_DB = {
            'weapon': [
                // Giai đoạn Tân Thủ (1-20)
                { id: 'w1', name: 'Mộc Kiếm', level: 1 },
                { id: 'w2', name: 'Thanh Đồng Kiếm', level: 5 },
                { id: 'w3', name: 'Tinh Thiết Đao', level: 10 },
                { id: 'w4', name: 'Bạch Ngân Thương', level: 15 },
                { id: 'w5', name: 'Xích Đồng Côn', level: 20 },
                
                // Giai đoạn Giang Hồ (25-50)
                { id: 'w6', name: 'Liễu Diệp Đao', level: 25 },
                { id: 'w7', name: 'Phá Phong Kiếm', level: 30 },
                { id: 'w8', name: 'Bách Luyện Cang Đao', level: 35 },
                { id: 'w9', name: 'Hàn Thiết Trọng Kiếm', level: 40 },
                { id: 'w10', name: 'Tử Kim Bát Quái Đao', level: 45 },
                { id: 'w11', name: 'Truy Hồn Đoạt Mệnh Thương', level: 50 },

                // Giai đoạn Cao Thủ (55-80)
                { id: 'w12', name: 'Lãnh Nguyệt Bảo Đao', level: 55 },
                { id: 'w13', name: 'Thanh Long Yển Nguyệt', level: 60 },
                { id: 'w14', name: 'Huyết Ảnh Ma Kiếm', level: 65 },
                { id: 'w15', name: 'Bích Thủy Hàn Kiếm', level: 70 },
                { id: 'w16', name: 'Hỏa Long Đao', level: 75 },
                { id: 'w17', name: 'Phượng Hoàng Vũ', level: 80 },

                // Giai đoạn Tông Sư (85-110)
                { id: 'w18', name: 'Thất Tinh Long Uyên', level: 85 },
                { id: 'w19', name: 'Cửu Thiên Lôi Trượng', level: 90 },
                { id: 'w20', name: 'Đồ Long Đao', level: 95 },
                { id: 'w21', name: 'Ỷ Thiên Kiếm', level: 100 },
                { id: 'w22', name: 'Huyền Thiết Trọng Kiếm', level: 105 },
                { id: 'w23', name: 'Càn Khôn Nhật Nguyệt Đao', level: 110 },

                // Giai đoạn Tiên Nhân (115-140)
                { id: 'w24', name: 'Tru Tiên Kiếm', level: 115 },
                { id: 'w25', name: 'Hiên Viên Thần Kiếm', level: 120 },
                { id: 'w26', name: 'Bàn Cổ Khai Thiên Phủ', level: 125 },
                { id: 'w27', name: 'Thần Nông Xích', level: 130 },
                { id: 'w28', name: 'Phục Hy Cầm', level: 135 },
                { id: 'w29', name: 'Đông Hoàng Chung', level: 140 },

                // Giai đoạn Thần Thoại (145-170)
                { id: 'w30', name: 'Luyện Yêu Hồ', level: 145 },
                { id: 'w31', name: 'Hạo Thiên Tháp', level: 150 },
                { id: 'w32', name: 'Côn Luân Kính', level: 155 },
                { id: 'w33', name: 'Thái Hư Thần Giáp', level: 160 }, // Tên vũ khí đặc biệt
                { id: 'w34', name: 'Tinh Không Kiếm', level: 165 },
                { id: 'w35', name: 'Diệt Thế Ma Đao', level: 170 },

                // Giai đoạn Chí Tôn (175-200)
                { id: 'w36', name: 'Hư Vô Chi Nhẫn', level: 175 },
                { id: 'w37', name: 'Vĩnh Hằng Thánh Thương', level: 180 },
                { id: 'w38', name: 'Hỗn Độn Khai Thiên Kiếm', level: 185 },
                { id: 'w39', name: 'Chúa Tể Chi Quyền', level: 190 },
                { id: 'w40', name: 'Sáng Thế Thần Kiếm', level: 195 },
                { id: 'w41', name: 'Đạo - Vô Cực', level: 200 }
            ],
            'armor': [
                // Giai đoạn Tân Thủ (1-20)
                { id: 'a1', name: 'Áo Vải Thô', level: 1 },
                { id: 'a2', name: 'Áo Da Sói', level: 5 },
                { id: 'a3', name: 'Khải Giáp Đồng', level: 10 },
                { id: 'a4', name: 'Hộ Tâm Kính Sắt', level: 15 },
                { id: 'a5', name: 'Chiến Bào Mỏng', level: 20 },

                // Giai đoạn Giang Hồ (25-50)
                { id: 'a6', name: 'Hắc Thiết Giáp', level: 25 },
                { id: 'a7', name: 'Ngân Lân Giáp', level: 30 },
                { id: 'a8', name: 'Kim Tơ Nhuyễn Giáp', level: 35 },
                { id: 'a9', name: 'Bách Luyện Chiến Giáp', level: 40 },
                { id: 'a10', name: 'Tử Kim Khải', level: 45 },
                { id: 'a11', name: 'Mãnh Hổ Chiến Y', level: 50 },

                // Giai đoạn Cao Thủ (55-80)
                { id: 'a12', name: 'Huyền Vũ Giáp', level: 55 },
                { id: 'a13', name: 'Thiên T蚕 Bảo Y', level: 60 },
                { id: 'a14', name: 'Huyết Ma Khải', level: 65 },
                { id: 'a15', name: 'Băng Tàm Ti Y', level: 70 },
                { id: 'a16', name: 'Liệt Hỏa Chiến Giáp', level: 75 },
                { id: 'a17', name: 'Kim Cang Hộ Thể', level: 80 },

                // Giai đoạn Tông Sư (85-110)
                { id: 'a18', name: 'Long Lân Bảo Giáp', level: 85 },
                { id: 'a19', name: 'Phượng Vũ Nghê Thường', level: 90 },
                { id: 'a20', name: 'Kỳ Lân Chiến Khải', level: 95 },
                { id: 'a21', name: 'Thiên Ma Bá Thể', level: 100 },
                { id: 'a22', name: 'Thái Cực Đạo Bào', level: 105 },
                { id: 'a23', name: 'Càn Khôn Chiến Giáp', level: 110 },

                // Giai đoạn Tiên Nhân (115-140)
                { id: 'a24', name: 'Cửu Thiên Huyền Giáp', level: 115 },
                { id: 'a25', name: 'Hạo Thiên Chiến Y', level: 120 },
                { id: 'a26', name: 'Thái Ất Tiên Y', level: 125 },
                { id: 'a27', name: 'Hỗn Nguyên Đạo Bào', level: 130 },
                { id: 'a28', name: 'Tử Tiêu Thần Khải', level: 135 },
                { id: 'a29', name: 'Ngũ Hành Bảo Giáp', level: 140 },

                // Giai đoạn Thần Thoại (145-170)
                { id: 'a30', name: 'Vô Cực Thánh Y', level: 145 },
                { id: 'a31', name: 'Bất Diệt Kim Thân', level: 150 },
                { id: 'a32', name: 'Tinh Hà Chiến Giáp', level: 155 },
                { id: 'a33', name: 'Hư Không Pháp Bào', level: 160 },
                { id: 'a34', name: 'Chân Long Thần Giáp', level: 165 },
                { id: 'a35', name: 'Phượng Hoàng Niết Bàn Y', level: 170 },

                // Giai đoạn Chí Tôn (175-200)
                { id: 'a36', name: 'Hồng Hoang Cổ Giáp', level: 175 },
                { id: 'a37', name: 'Vĩnh Hằng Thánh Khải', level: 180 },
                { id: 'a38', name: 'Hỗn Độn Ma Giáp', level: 185 },
                { id: 'a39', name: 'Chúa Tể Thần Y', level: 190 },
                { id: 'a40', name: 'Sáng Thế Thánh Giáp', level: 195 },
                { id: 'a41', name: 'Vỏ Bọc Hư Vô', level: 200 }
            ],
            'accessory': [
                // Giai đoạn Tân Thủ (1-20)
                { id: 'r1', name: 'Nhẫn Cỏ Khô', level: 1 },
                { id: 'r2', name: 'Vòng Tay Gỗ', level: 5 },
                { id: 'r3', name: 'Nhẫn Đồng Thau', level: 10 },
                { id: 'r4', name: 'Ngọc Bội Sứt', level: 15 },
                { id: 'r5', name: 'Dây Chuyền Bạc', level: 20 },

                // Giai đoạn Giang Hồ (25-50)
                { id: 'r6', name: 'Nhẫn Mã Não', level: 25 },
                { id: 'r7', name: 'Ngọc Bội Tinh Xảo', level: 30 },
                { id: 'r8', name: 'Hạng Liên Vàng', level: 35 },
                { id: 'r9', name: 'Nhẫn Phỉ Thúy', level: 40 },
                { id: 'r10', name: 'Hộ Phù Bình An', level: 45 },
                { id: 'r11', name: 'Nhẫn Huyết Ngọc', level: 50 },

                // Giai đoạn Cao Thủ (55-80)
                { id: 'r12', name: 'Ngọc Bội Rồng', level: 55 },
                { id: 'r13', name: 'Dây Chuyền Xương Thú', level: 60 },
                { id: 'r14', name: 'Nhẫn Lam Ngọc', level: 65 },
                { id: 'r15', name: 'Mật Tịch Võ Lâm', level: 70 },
                { id: 'r16', name: 'Ấn Tín Tướng Quân', level: 75 },
                { id: 'r17', name: 'Nhẫn Kim Cương', level: 80 },

                // Giai đoạn Tông Sư (85-110)
                { id: 'r18', name: 'Cửu Long Bội', level: 85 },
                { id: 'r19', name: 'Phượng Hoàng Trâm', level: 90 },
                { id: 'r20', name: 'Kỳ Lân Ấn', level: 95 },
                { id: 'r21', name: 'Bảo Vật Trấn Phái', level: 100 },
                { id: 'r22', name: 'Nhẫn Huyền Băng', level: 105 },
                { id: 'r23', name: 'Hạng Liên Hỏa Tinh', level: 110 },

                // Giai đoạn Tiên Nhân (115-140)
                { id: 'r24', name: 'Tiên Đan Hồ Lô', level: 115 },
                { id: 'r25', name: 'Ngọc Bội Thông Linh', level: 120 },
                { id: 'r26', name: 'Nhẫn Không Gian', level: 125 },
                { id: 'r27', name: 'Pháp Bảo Hộ Thân', level: 130 },
                { id: 'r28', name: 'Ấn Tín Tiên Quan', level: 135 },
                { id: 'r29', name: 'Gương Chiếu Yêu', level: 140 },

                // Giai đoạn Thần Thoại (145-170)
                { id: 'r30', name: 'Định Hải Thần Châm (Thu Nhỏ)', level: 145 },
                { id: 'r31', name: 'Vòng Kim Cô', level: 150 },
                { id: 'r32', name: 'Liên Hoa Bảo Tọa', level: 155 },
                { id: 'r33', name: 'Ngọc Tỷ Truyền Quốc', level: 160 },
                { id: 'r34', name: 'Nhẫn Tinh Tú', level: 165 },
                { id: 'r35', name: 'Dây Chuyền Hư Không', level: 170 },

                // Giai đoạn Chí Tôn (175-200)
                { id: 'r36', name: 'Trái Tim Rồng', level: 175 },
                { id: 'r37', name: 'Mắt Thần Horus', level: 180 },
                { id: 'r38', name: 'Nhẫn Vô Cực', level: 185 },
                { id: 'r39', name: 'Hạt Giống Thế Giới', level: 190 },
                { id: 'r40', name: 'Ấn Chúa Tể', level: 195 },
                { id: 'r41', name: 'Đá Vô Cực', level: 200 }
            ]
        };
        
        // [FIX] Đã xóa khối SHOP_EQUIPMENT_DB bị trùng lặp ở đây.
 
        
        // *** NEW: Static Item DB (Potions, Food, etc.) ***
        // [FIX] Đã xóa toàn bộ khối code bị hỏng, lỗi từ 'ab_weapon' đến 'break; } }'

        function generateEquipment(monsterLevel, forceQuality = null, forceType = null) {
            // 1. Chọn Phẩm Chất
            // [FIX] Xóa toàn bộ khối code bị hỏng (từ dòng 2053 đến 2167) đã được dán vào đây.
            // Bắt đầu lại logic của hàm generateEquipment
            const qualityRoll = Math.random() * 100;
            let selectedQualityId = 'common'; // Default
            
            // [FIX] Khôi phục logic chọn Phẩm Chất đã bị khối code hỏng ghi đè
            if (forceQuality) {
                selectedQualityId = forceQuality;
            } else {
                let cumulativeChance = 0;
                for (const id in QUALITY_DB) {
                    // [FIX] Chỉ roll các item có chance > 0 (tránh roll ra đồ An Bang)
                    if (QUALITY_DB[id].chance > 0) { 
                        cumulativeChance += QUALITY_DB[id].chance;
                        if (qualityRoll <= cumulativeChance) {
                            selectedQualityId = id;
                            break;
                        }
                    }
                }
            }
            // [END FIX]

            const quality = { id: selectedQualityId, ...QUALITY_DB[selectedQualityId] };

            // 2. Chọn Loại Trang Bị (Weapon, Armor, Accessory)
            const itemTypes = ['weapon', 'armor', 'accessory'];
            const selectedType = itemTypes[Math.floor(Math.random() * itemTypes.length)];
            
            // 3. Chọn Trang Bị Cơ Bản (Base Item)
            const availableBaseItems = BASE_ITEM_DB[selectedType].filter(item => item.level <= monsterLevel);
            const baseItem = availableBaseItems.length > 0 ? availableBaseItems[Math.floor(Math.random() * availableBaseItems.length)] : BASE_ITEM_DB[selectedType][0];
            
            // 4. Xác định Cấp độ & Tên
            const itemLevel = Math.max(1, monsterLevel + Math.floor(Math.random() * 6) - 3); // Lvl quái +/- 3
            const itemName = `${baseItem.name} ${quality.name}`;

            // 5. Tạo các Dòng Chỉ Số (Generate Affixes)
            const numAffixes = Math.floor(Math.random() * (quality.maxAffix - quality.minAffix + 1)) + quality.minAffix;
            const affixes = [];
            let availableAffixes = [...AFFIX_DB];

            for (let i = 0; i < numAffixes; i++) {
                if (availableAffixes.length === 0) break;
                
                // Chọn 1 dòng
                const affixIndex = Math.floor(Math.random() * availableAffixes.length);
                const affixTpl = availableAffixes[affixIndex];
                
                // Xóa dòng đã chọn để tránh trùng lặp
                availableAffixes.splice(affixIndex, 1);

                // Tính giá trị
                const valueMultiplier = 1 + (Math.random() * 0.4 - 0.2); // +/- 20%
                let value = affixTpl.baseValue * (itemLevel * 0.5) * quality.multiplier * valueMultiplier;
                
                let displayValue = '';
                if (affixTpl.isPercent) {
                    value = Math.max(0.1, Math.round(value * 10) / 10);
                    // [NEW] Apply Crit Chance Cap
                    if (affixTpl.id === 'critChance') {
                        value = Math.min(value, 10.0); // Cap at 10%
                    }
                    displayValue = `+${value}%`;
                } else {
                    value = Math.max(1, Math.round(value));
                    displayValue = `+${value}`;
                }
                
                affixes.push({
                    id: affixTpl.id,
                    name: affixTpl.name,
                    value: value,
                    display: `${affixTpl.name} ${displayValue}`,
                    isPercent: affixTpl.isPercent
                });
            }

            // 6. Trả về đối tượng trang bị
            return {
                uniqueId: crypto.randomUUID(), // ID duy nhất cho món đồ này
                baseId: baseItem.id,            // ID của loại cơ bản (vd: 'w1')
                name: itemName,
                type: selectedType,
                level: itemLevel,
                quality: quality.id,
                affixes: affixes,
                upgradeLevel: 0 // [NEW] Add upgrade level
            };
        }
        // [FIX] Đã xóa dấu ; bị lỗi ở đây

        // --- DUNGEON/TRAINING LOGIC ---

        // [NEW] Rebirth Functions
        function confirmRebirth() {
            const currentMaxLevel = getMaxLevel();
            
            // [MODIFIED] Check dynamic max level
            if (gameData.player.level < currentMaxLevel) {
                showToast(`Bạn cần đạt Cấp ${currentMaxLevel} để Trùng Sinh!`, false);
                return;
            }

            // Calculate rewards
            // Level factor increases as max level increases (e.g., 200-199=1, 201-199=2)
            const levelFactor = gameData.player.level - 199;
            const uyDanhGained = Math.max(1, Math.floor(levelFactor * 15)); 
            const nganLuongGained = Math.max(1, Math.floor(levelFactor * 50000)); 
            const danhVongGained = Math.max(1, Math.floor(levelFactor * 5));    

            // Use the generic dungeon confirm modal
            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Xác Nhận Trùng Sinh';
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2">Bạn có chắc muốn Trùng Sinh?</p>
                    <p class="text-gray-300 mb-1">Nhân vật của bạn sẽ trở về Cấp 1.</p>
                    <p class="text-gray-300 mb-1">Bạn sẽ giữ lại toàn bộ Tiền, Trang Bị, Vật Phẩm và Đệ Tử.</p>
                    <p class="font-bold text-yellow-300 text-lg mt-4">Phần thưởng:</p>
                    <ul class="list-disc list-inside ml-4 text-gray-300">
                        <li><span class="text-purple-400 font-semibold">${uyDanhGained} Uy Danh</span></li>
                        <li><span class="text-gray-300 font-semibold">${nganLuongGained.toLocaleString()} Ngân Lượng</span></li> <!-- [NEW] Display NL -->
                        <li><span class="text-teal-400 font-semibold">${danhVongGained} Danh Vọng</span></li> <!-- [NEW] Display DV -->
                        <li><span class="text-cyan-300 font-semibold">+1 Điểm Siêu Việt</span></li> <!-- [NEW] -->
                    </ul>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button onclick="performRebirth()" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Trùng Sinh</button>
                `;
            }
            
            showModal('dungeon-confirm-modal');
        }

        function performRebirth() {
            const currentMaxLevel = getMaxLevel();

            // [MODIFIED] Check dynamic max level
            if (gameData.player.level < currentMaxLevel) {
                showToast(`Bạn cần đạt Cấp ${currentMaxLevel} để Trùng Sinh!`, false);
                return;
            }

            // 1. Stop all activities
            if (gameData.isTraining) stopTraining();
            if (gameData.isIdling) stopIdleAction();

            // 2. Calculate and add rewards
            const levelFactor = gameData.player.level - 199;
            const uyDanhGained = Math.max(1, Math.floor(levelFactor * 15)); 
            const nganLuongGained = Math.max(1, Math.floor(levelFactor * 50000)); 
            const danhVongGained = Math.max(1, Math.floor(levelFactor * 5));    

            gameData.uyDanh += uyDanhGained;
            gameData.nganLuong += nganLuongGained; 
            gameData.danhVong += danhVongGained;   
            gameData.rebirthCount = (gameData.rebirthCount || 0) + 1; // Increment rebirth count
            gameData.sieuVietPoints = (gameData.sieuVietPoints || 0) + 1; 

            // 3. Reset player stats
            gameData.player.level = 1;
            gameData.player.xp = 0;
            gameData.player.xpToNext = getXpToNext(1);

            // 4. Refill HP/Mana based on new (Level 1 + Gear) stats
            const stats = getTotalStats(); 
            gameData.player.currentHp = stats.hp;
            gameData.player.currentMana = stats.mana;

            // 5. Hide modal, show toast, update UI
            hideModal('dungeon-confirm-modal');
            
            const nextMaxLevel = getMaxLevel(); // Will be +1 compared to before
            showToast(`Trùng Sinh thành công! Giới hạn cấp độ tăng lên ${nextMaxLevel}. Nhận thưởng hậu hĩnh!`, true);
            updateUI();
        }
        // [END NEW] Rebirth Functions


        function unlockDungeon(mapId) {
            const mapData = DUNGEONS_DB[mapId];
            if (!mapData) { console.error("Map not found:", mapId); return; }
            
            // [NEW] Kiểm tra yêu cầu Trùng Sinh
            if (mapData.rebirthReq && (gameData.rebirthCount || 0) < mapData.rebirthReq) {
                showToast(`Bạn cần đạt Trùng Sinh cấp ${mapData.rebirthReq} để mở khóa bản đồ này!`, false);
                return;
            }

            if (gameData.nganLuong >= mapData.unlockCost) {
                gameData.nganLuong -= mapData.unlockCost;
                gameData.unlockedDungeons.push(mapId);
                showToast(`Đã mở khóa bản đồ ${mapData.name}!`);
                updateUI();
                renderModalContent('dungeons-modal');
            } else { showToast("Không đủ Ngân Lượng!", false); }
        }

        function confirmAdventure(mapId) {
            const mapData = DUNGEONS_DB[mapId];
             if (!mapData) { console.error("Map not found:", mapId); return; }
            if (gameData.isTraining) {
                showToast("Hãy dừng luyện công trước khi vào bản đồ mới!", false); return;
            }
            
            document.getElementById('dungeon-confirm-title').textContent = `Xác Nhận Luyện Công: ${mapData.name}`;
            
            const playerStats = getTotalStats();
            let summary = `<p class="font-bold text-lg mb-2">Nhân vật:</p><p>${PLAYER_DATA.name} (Cấp ${gameData.player.level})</p>`;
             
             // *** UPDATED: Show weapon and armor from slots ***
             if(gameData.equippedSlots.weapon) {
                const item = gameData.gearInventory.find(i => i.uniqueId === gameData.equippedSlots.weapon);
                if(item) summary += `<p>Vũ khí: <span class="${QUALITY_DB[item.quality].className}">${item.name}</span></p>`;
             } else {
                 summary += `<p>Vũ khí: Chưa trang bị</p>`;
             }
             if(gameData.equippedSlots.armor) {
                const item = gameData.gearInventory.find(i => i.uniqueId === gameData.equippedSlots.armor);
                if(item) summary += `<p>Giáp: <span class="${QUALITY_DB[item.quality].className}">${item.name}</span></p>`;
             } else {
                 summary += `<p>Giáp: Chưa trang bị</p>`;
             }
             
            summary += `<p class="font-bold text-lg mt-4 mb-2">Thuộc tính:</p><div class="grid grid-cols-2 gap-1 text-sm"><span>Sinh Lực: ${playerStats.hp}</span><span>Nội Lực: ${playerStats.mana}</span><span>Công Kích: ${playerStats.atk}</span><span>Phòng Thủ: ${playerStats.def}</span><span>Thân Pháp: ${playerStats.spd}</span><span>May Mắn: ${playerStats.lck}</span></div>`;
            
            document.getElementById('dungeon-confirm-summary').innerHTML = summary;
            document.getElementById('dungeon-confirm-buttons').innerHTML = `<button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button><button onclick="startTraining('${mapId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Luyện Công</button>`;
            showModal('dungeon-confirm-modal');
        }
        

        // --- IDLE LOOP FUNCTIONS ---

        // NEW: Added missing function
        function addTrainingLog(message, type = 'info') {
             if (!gameData.trainingLog) gameData.trainingLog = [];
             
             // Create the log entry with the correct class
             const logEntry = `<p class="log-${type}">${message}</p>`;
             
             gameData.trainingLog.unshift(logEntry); // Add to the top
             if (gameData.trainingLog.length > MAX_LOG_LINES) gameData.trainingLog.pop(); // Trim old logs

             // Update the log display immediately
             const logContainer = document.getElementById('training-log');
             if (logContainer) {
                 logContainer.innerHTML = gameData.trainingLog.map(entry => entry).join('');
                 logContainer.scrollTop = 0; // Scroll to top
             }
         }

        function startTraining(mapId) {
            hideModal('dungeon-confirm-modal');
            hideModal('dungeons-modal');
            
            if (gameData.isTraining) {
                showToast("Đã đang luyện công!", false); return;
            }
            
            gameData.isTraining = true;
            gameData.currentMapId = mapId;
            gameData.trainingLog = []; // Clear log
            addTrainingLog(`Bắt đầu luyện công tại ${DUNGEONS_DB[mapId].name}.`, 'system');
            
            // Reset combat state just in case
            gameData.combatState = { ...initialGameData.combatState };
            
            updateUI(); // Show training panel
            
            // Start the loop
            // [MODIFIED] Only start if not already running
            if (!gameLoopInterval) {
                gameLoopInterval = setInterval(gameLoop, GAME_TICK_MS);
            }
        }
        
        function stopTraining(isDeath = false) {
            if (!gameData.isTraining) return;
            
            // [MODIFIED] Stop the loop ONLY if not idling
            if (gameLoopInterval && !gameData.isIdling) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
            }
            
            gameData.isTraining = false;
            gameData.currentMapId = null;
            
            // Reset combat state
            gameData.combatState = { ...initialGameData.combatState };

            if (!isDeath) {
                addTrainingLog("Đã dừng luyện công.", 'info');
                showToast("Đã dừng luyện công.", true);
            } else {
                // Death logic (penalty applied in gameLoop)
                const playerStats = getTotalStats();
                gameData.player.currentHp = playerStats.hp; // Refill HP
                gameData.player.currentMana = playerStats.mana; // Refill Mana
            }
            
            updateUI(); // Hide training panel
            
            // IMPORTANT: Refresh dungeon list modal content if it's open
            if(!document.getElementById('dungeons-modal').classList.contains('hidden')) {
                renderModalContent('dungeons-modal');
            }
        }
        
        // GAME LOOP (Turn-Based)
        // [FIX] Replaced incomplete gameLoop with full combat logic
        // [MODIFIED] To run both training and idling
        function gameLoop() {
            // Check if both are stopped, then stop the loop
            if (!gameData.isTraining && !gameData.isIdling) {
                if (gameLoopInterval) {
                    clearInterval(gameLoopInterval);
                    gameLoopInterval = null;
                }
                return;
            }
            
            // --- 3. Parallel Idle Action Check ---
            if (gameData.isIdling && gameData.currentIdleAction) {
                const actionData = IDLE_ACTION_DB[gameData.currentIdleAction];
                if (actionData) {
                    const now = Date.now();
                    const startTime = gameData.lastIdleTick || now;
                    const timePassed = now - startTime;
                    const tickRate = actionData.tickRate || 8000;
                    
                    if (timePassed >= tickRate) {
                        performIdleTick(); // Run the idle action
                        gameData.lastIdleTick = now; // Reset timer
                    } else {
                        // Update progress bar
                        updateIdleActionProgress(timePassed, tickRate);
                    }
                }
            }

            // --- 4. Combat Logic (Only if training) ---
            if (gameData.isTraining) {
                if (!gameData.currentMapId) { 
                    addTrainingLog("Lỗi: Không tìm thấy bản đồ. Dừng luyện.", 'error'); 
                    stopTraining(); 
                    // We don't return here, as idling might still be active
                } else {
                    const mapData = DUNGEONS_DB[gameData.currentMapId];
                    if (!mapData) { 
                        addTrainingLog("Lỗi: Không tìm thấy bản đồ. Dừng luyện.", 'error'); 
                        stopTraining(); 
                        // We don't return here
                    } else {
                        // --- 1. Check if player is dead ---
                        if (gameData.player.currentHp <= 0) {
                            const xpLoss = Math.floor(gameData.player.xp * 0.03);
                            gameData.player.xp = Math.max(0, gameData.player.xp - xpLoss);
                            addTrainingLog(`Bạn đã tử vong! Về Thành Dưỡng Sức.`, 'error');
                            addTrainingLog(`Mất ${xpLoss} Kinh nghiệm.`, 'error');
                            stopTraining(true);
                            // We don't return here
                        }
                        // --- 2. Auto-potion logic ---
                        else { // Only run potions/combat if NOT dead
                            const playerStats = getTotalStats();
                            if (gameData.player.currentHp / playerStats.hp < 0.5 && gameData.items['item_hp_small'] > 0) {
                                useItem('item_hp_small', true); // Pass true to indicate auto-use for less verbose logging
                            } else if (gameData.player.currentMana / playerStats.mana < 0.3 && gameData.items['item_mana_small'] > 0) {
                                useItem('item_mana_small', true);
                            }
                            
                            // --- Combat Logic ---
                            if (!gameData.combatState.active) {
                                // Not in combat, start a new one
                                startNewCombat(mapData);
                            } else {
                                // In combat, execute turn
                                gameData.combatState.turnCount++;
                                
                                if (gameData.combatState.turn === 'player') {
                                    playerTurn();
                                    // Check if enemy is dead
                                    if (gameData.combatState.enemyCurrentHp <= 0) {
                                        endCombat(mapData, gameData.combatState.enemyId);
                                    } else {
                                        gameData.combatState.turn = 'enemy';
                                    }
                                } else {
                                    enemyTurn();
                                    // Check if player is dead (will be caught at start of next loop)
                                    if (gameData.player.currentHp > 0) {
                                        gameData.combatState.turn = 'player';
                                    }
                                }
                            }
                        }
                    }
                }
            } // --- [END if (gameData.isTraining)] ---
            
            // --- [END Combat Logic] ---

            // [NEW] Kích hoạt sự kiện ngẫu nhiên
            triggerRandomEvent();

            updateUI();
        }
        
        // --- [NEW] Added missing combat helper functions ---
        
        // [NEW] Function to add visual flash to HP bars
        function flashHP(target) {
            let barElement;
            if (target === 'player') {
                barElement = document.getElementById('combat-player-hp-bar');
            } else { // 'enemy'
                barElement = document.getElementById('combat-enemy-hp-bar');
            }
            
            if (barElement) {
                barElement.classList.add('hp-flash');
                setTimeout(() => {
                    barElement.classList.remove('hp-flash');
                }, 300); // Must match animation duration
            }
        }
        
        // [NEW] Function to add visual shake to combatant
        function shakeCombatant(target) {
            let iconElement;
            if (target === 'player') {
                // [MODIFIED] Player icon doesn't have an ID, use querySelector
                iconElement = document.querySelector('#combat-display-panel .combatant:first-child i');
            } else { // 'enemy'
                iconElement = document.getElementById('combat-enemy-icon');
            }
            
            if (iconElement) {
                iconElement.classList.add('enemy-hit'); // Using the new CSS class
                setTimeout(() => {
                    iconElement.classList.remove('enemy-hit');
                }, 300); // Phải khớp với thời gian animation (0.3s)
            }
        }

        function endCombat(mapData, enemyId) {
            const enemyDB = ENEMIES_DB[enemyId];
            if (!enemyDB) return;
            
            addTrainingLog(`Đã đánh bại ${enemyDB.name}!`, 'system');
            
            // --- [NEW] Custom rewards for Super Rare Boss ---
            let goldGained, xpGained, equipRollChance, materialRollChance, danhVongGained = 0; // [MODIFIED] Added danhVongGained = 0

            if (enemyId === 'boss_rare_01') {
                // MASSIVE rewards
                goldGained = Math.floor(Math.random() * 20000) + 30000; // 30k-50k Gold
                xpGained = Math.floor(Math.random() * 50000) + 100000;  // 100k-150k XP
                equipRollChance = 1.0; // 100% chance for an equip roll
                materialRollChance = 1.0; // 100% chance for a material roll
                danhVongGained = 50; // [MODIFIED] Set DV gain
                
                addTrainingLog(`Phần thưởng <span class="text-red-500 font-bold">VÔ SONG!</span>`, 'reward');
                
            } else {
                // --- Standard Rewards ---
                goldGained = Math.floor(Math.random() * (mapData.rewards.gold[1] - mapData.rewards.gold[0] + 1)) + mapData.rewards.gold[0];
                xpGained = Math.floor(Math.random() * (mapData.rewards.xp[1] - mapData.rewards.xp[0] + 1)) + mapData.rewards.xp[0];
                equipRollChance = mapData.rewards.equipChance || 0.1;
                materialRollChance = mapData.rewards.materialDropChance || 0; // NEW: Chance for stones
            }
            
            // [NEW] Grant Danh Vong
            // [MODIFIED] Only grant DV for map10 kills OR the rare boss
            if (enemyId !== 'boss_rare_01' && gameData.currentMapId === 'map10') {
                danhVongGained = 1; // 1 DV for any kill in map10 (that isn't the rare boss)
            }
            // Note: danhVongGained is already 50 if it *is* boss_rare_01
            // All other maps (map01-map09) will have danhVongGained = 0 (its default)

            // Add the gained DV (if any)
            if (danhVongGained > 0) {
                gameData.danhVong += danhVongGained;
                addTrainingLog(`Nhận được <span class="text-teal-400 font-bold">${danhVongGained} Danh Vọng</span>!`, 'reward');
            }
            
            // [NEW] 0. Roll for Linh Khí (GLOBAL DROP)
            if (Math.random() < 0.90) { // [MODIFIED] 20% -> 90% chance
                const linhKhiGained = 1 + Math.floor(enemyDB.level / 20);
                gameData.linhKhi = (gameData.linhKhi || 0) + linhKhiGained;
                addTrainingLog(`Nhận được <span class="text-purple-300">${linhKhiGained} Linh Khí</span>.`, 'reward');
            }
            
            // [NEW] 0b. Roll for Linh Hon Thach (Special Maps Only)
            if (mapData.rewards.linhHonThachDrop) {
                const lhtData = mapData.rewards.linhHonThachDrop;
                if (Math.random() < lhtData.chance) {
                    const lhtGained = Math.floor(Math.random() * (lhtData.amount[1] - lhtData.amount[0] + 1)) + lhtData.amount[0];
                    gameData.linhHonThach = (gameData.linhHonThach || 0) + lhtGained;
                    addTrainingLog(`Nhận được <span class="text-gray-200 font-bold">${lhtGained} Linh Hồn Thạch</span>!`, 'reward');
                }
            }
            
            // 1. Grant Rewards (Gold, XP)
            
            // [MODIFIED] Logic tính XP đã được thay đổi hoàn toàn
            // [REMOVED] Khối logic "rebirthFlatXpBonus" cũ đã bị xóa

            // [MODIFIED] Apply XP Boost from stats AND Rebirth
            const playerStats = getTotalStats(); // Get stats to check for XP boost
            const gearXpBoostPercent = playerStats.xp_boost;

            // [NEW] Get Rebirth XP Boost
            const rebirthXpBoostPercent = (gameData.rebirthCount || 0) * 100; // 100% per rebirth

            const totalXpBoostPercent = gearXpBoostPercent + rebirthXpBoostPercent;
            const xpMultiplier = 1 + (totalXpBoostPercent / 100);

            if (xpMultiplier > 1) {
                const boostedXp = Math.floor(xpGained * xpMultiplier);
                let logMsg = `(Thưởng ${totalXpBoostPercent.toLocaleString()}% XP`;
                if (rebirthXpBoostPercent > 0) {
                    logMsg += ` [Trùng Sinh +${rebirthXpBoostPercent.toLocaleString()}%]`;
                }
                logMsg += `!)`;
                addTrainingLog(logMsg, 'reward');
                xpGained = boostedXp;
            }
            // [END MODIFIED]
            
            gameData.nganLuong += goldGained;
            addTrainingLog(`Nhận được ${goldGained.toLocaleString()} Ngân Lượng.`, 'reward'); // [MODIFIED] Thêm toLocaleString
            addPlayerXp(xpGained, 'combat'); // [MODIFIED] Pass source

            // [NEW] Add XP to equipped pet (10% of player XP)
            const petXpGained = Math.floor(xpGained * 0.1);
            if (petXpGained > 0) {
                addEquippedPetXp(petXpGained);
            }

            <!-- [NEW] 2. Roll for Key Drop (Bosses Only) -->
            if (enemyDB.rarity >= 3) { // Only bosses
                // [NEW] Roll for Vong Quay Ticket (Bosses Only)
                if (Math.random() < 0.05) { // [MODIFIED] Giảm tỷ lệ từ 15% xuống 5%
                    addMaterial('luot_quay_may_man', 1, 'combat');
                }
            }

            // 3. Roll for Potion Drop (e.g., 15% chance)
            if (Math.random() < 0.15) {
                const potionId = Math.random() < 0.5 ? 'item_hp_small' : 'item_mana_small';
                addItem(potionId, 1, 'combat'); // [MODIFIED] Pass source
            }

            // 3. Roll for Equipment Drop OR Upgrade Stone Drop
            // [MODIFIED] Use the new variables
            const dropRoll = Math.random();

            if (dropRoll < materialRollChance) {
                // Roll for Upgrade Stone (Only if map has materialDropChance > 0)
                let stoneDropped = null;
                if (enemyId === 'boss_rare_01') {
                    // 50% High, 50% Medium
                    stoneDropped = Math.random() < 0.5 ? 'upgrade_stone_high' : 'upgrade_stone_medium';
                    // And give 5 of them
                    addMaterial(stoneDropped, 5, 'combat');
                } else {
                    // [MODIFIED] Check for Cán Viên Động first
                    if (gameData.currentMapId === 'map06') {
                        // Only drop low stones in Cán Viên Động
                        stoneDropped = 'upgrade_stone_low';
                    } else {
                        // Original stone drop logic for other maps
                        const stoneRoll = Math.random() * 100;
                        if (stoneRoll < 60) { // 60% chance for Low
                            stoneDropped = 'upgrade_stone_low';
                        } else if (stoneRoll < 90) { // 30% chance for Medium (60 -> 90)
                            stoneDropped = 'upgrade_stone_medium';
                        } else { // 10% chance for High
                            stoneDropped = 'upgrade_stone_high';
                        }
                    }
                    addMaterial(stoneDropped, 1, 'combat'); // Use addMaterial to add to inventory
                }
            } 
            else if (dropRoll < (materialRollChance + equipRollChance)) {
                // Roll for Equipment
                // [MODIFIED] Check auto-sell first
                let newItem;
                if (enemyId === 'boss_rare_01') {
                    newItem = generateEquipment(enemyDB.level);
                    addTrainingLog(`Rơi ra trang bị <span class="text-red-500">Thần Ma</span>!`, 'reward');
                } else {
                    newItem = generateEquipment(enemyDB.level || 1);
                }
                
                const qualityId = newItem.quality;
                
                if ((qualityId === 'common' && gameData.autoSell.common) || (qualityId === 'uncommon' && gameData.autoSell.uncommon)) {
                    // Auto-sell
                    const sellPrice = calculateSellPrice(newItem);
                    gameData.nganLuong += sellPrice;
                    const quality = QUALITY_DB[qualityId];
                    addTrainingLog(`(Tự bán) [${newItem.name}] nhận ${sellPrice} NL.`, 'info');
                }
                else if (countInventorySlots() < MAX_INVENTORY_SLOTS) {
                    // Add to inventory
                    gameData.gearInventory.push(newItem);
                    const quality = QUALITY_DB[qualityId];
                    addTrainingLog(`Nhận được [${newItem.name}]!`, 'reward');
                } else {
                    addTrainingLog(`Nhặt được trang bị nhưng <span class="text-red-400">Hành trang đầy</span>!`, 'error');
                }
            }
            
            // 4. Reset combat state
            gameData.combatState.active = false;
        }

        // --- Helper functions for rewards ---
        function addPlayerXp(xpAmount, source = 'combat') { 
            const currentMaxLevel = getMaxLevel(); // [NEW] Get dynamic max level

            // [NEW] If max level, don't add XP
            if (gameData.player.level >= currentMaxLevel) {
                if (gameData.player.xp !== 0) gameData.player.xp = 0; 
                return;
            }
            
            gameData.player.xp += xpAmount;
            
            // [MODIFIED] Only log for combat
            if (source === 'combat') {
                addTrainingLog(`Nhận được ${xpAmount} Kinh nghiệm.`, 'reward');
            }
            
            while (gameData.player.xp >= gameData.player.xpToNext) {
                // [NEW] Add max level cap check (Dynamic)
                if (gameData.player.level >= currentMaxLevel) {
                    gameData.player.xp = 0; 
                    addTrainingLog(`--- <span class="text-yellow-300 font-bold">Đã Đạt Cấp Tối Đa (${currentMaxLevel})!</span> ---`, 'system');
                    break; 
                }
                
                gameData.player.level++;
                gameData.player.xp -= gameData.player.xpToNext;
                gameData.player.xpToNext = getXpToNext(gameData.player.level); 
                
                // [NEW] Cộng 5 Điểm Tiềm Năng khi lên cấp
                gameData.player.potentialPoints = (gameData.player.potentialPoints || 0) + 5;

                // Full heal on level up
                const stats = getTotalStats();
                gameData.player.currentHp = stats.hp;
                gameData.player.currentMana = stats.mana;
                
                addTrainingLog(`--- <span class="text-yellow-300 font-bold">Thăng Cấp ${gameData.player.level}! (+5 Tiềm Năng)</span> ---`, 'system');
                showToast(`Thăng cấp ${gameData.player.level}! Nhận 5 điểm tiềm năng.`, true);
            }
        }
        
        function addItem(itemId, amount, source = null) { // [MODIFIED] Added source
            const itemDB = STATIC_ITEM_DB[itemId];
            if (!itemDB) return;
            
            const currentAmount = gameData.items[itemId] || 0;
            const newAmount = Math.min(MAX_STACK_SIZE, currentAmount + amount);
            const actualAdded = newAmount - currentAmount;
            
            if (actualAdded > 0) {
                gameData.items[itemId] = newAmount;
                // [MODIFIED] Only log if from combat
                if (source === 'combat') {
                    addTrainingLog(`Nhận được ${itemDB.name} x${actualAdded}.`, 'reward');
                }
                // [NEW] Log for turn-based combat
                else if (source === 'turn_based') {
                    addTurnBasedCombatLog(`Nhận được ${itemDB.name} x${actualAdded}.`, 'reward');
                }
            } else if (amount > 0) {
                 addTrainingLog(`Không thể nhặt thêm ${itemDB.name} (Tối đa: ${MAX_STACK_SIZE}).`, 'info');
            }
        }
        
        function useItem(itemId, isAuto = false) {
             const itemDB = STATIC_ITEM_DB[itemId];
             // [MODIFIED] Cho phép dùng 'box' type
             if (!itemDB || (itemDB.type !== 'potion' && itemDB.type !== 'box')) return;
             
             if (!gameData.items[itemId] || gameData.items[itemId] <= 0) {
                 if (!isAuto) showToast(`Hết ${itemDB.name}!`, false);
                 return;
             }
             
             const stats = getTotalStats();
             let recovered = 0;
             let logMsg = '';
             let shouldConsume = false;
             
             // [NEW] Xử lý mở Rương (Box)
             if (itemDB.type === 'box') {
                 gameData.items[itemId]--; // Trừ item trước
                 if (gameData.items[itemId] <= 0) delete gameData.items[itemId];
                 
                 if (itemId === 'box_gear_godly') {
                     // Random đồ Vàng (Legendary) -> Đỏ (Mythic) -> Siêu Thần (SuperGodly)
                     const roll = Math.random();
                     let quality = 'legendary';
                     if (roll < 0.05) quality = 'supergodly'; // 5%
                     else if (roll < 0.25) quality = 'mythic'; // 20%
                     else if (roll < 0.55) quality = 'epic';   // 30%
                     
                     // Level theo nhân vật, tối thiểu 100
                     const level = Math.max(100, gameData.player.level);
                     
                     const newItem = generateEquipment(level, quality, null);
                     
                     if (countInventorySlots() < MAX_INVENTORY_SLOTS) {
                         gameData.gearInventory.push(newItem);
                         const qInfo = QUALITY_DB[quality];
                         logMsg = `Mở Rương Thần Ma: Nhận được <span class="${qInfo.className}">[${newItem.name}]</span>!`;
                         if (!isAuto) showToast(logMsg, true);
                         addTrainingLog(logMsg, 'reward');
                     } else {
                         // Full kho -> Hoàn trả rương
                         gameData.items[itemId] = (gameData.items[itemId] || 0) + 1;
                         showToast("Hành trang đầy! Không thể mở rương.", false);
                         return;
                     }
                 }
                 updateUI();
                 return; // Kết thúc xử lý box
             }

             // [NEW] Xử lý Tăng chỉ số vĩnh viễn (Permanent Stat Pill)
             if (itemDB.effectType === 'permanent_stat') {
                 const statKey = itemDB.statKey;
                 const statVal = itemDB.statValue;
                 
                 // Cộng vào permanentStats
                 if (gameData.permanentStats[statKey] !== undefined) {
                     gameData.permanentStats[statKey] += statVal;
                     shouldConsume = true;
                     const statName = statKey.toUpperCase();
                     logMsg = `Dùng ${itemDB.name}, tăng vĩnh viễn <span class="text-yellow-300">+${statVal.toLocaleString()} ${statName}</span>.`;
                 }
             }
             // Xử lý Hồi Máu (HP)
             else if (itemDB.effect.target === 'hp') {
                 const healAmount = itemDB.effect.isPercent ? Math.floor(stats.hp * (itemDB.effect.value / 100)) : itemDB.effect.value;
                 const missing = stats.hp - gameData.player.currentHp;
                 if (missing > 0) {
                     recovered = Math.min(missing, healAmount);
                     gameData.player.currentHp += recovered;
                     shouldConsume = true;
                     logMsg = `Dùng ${itemDB.name}, hồi ${recovered.toLocaleString()} HP.`;
                 } else if (!isAuto) {
                     showToast("Sinh lực đã đầy!", false);
                     return;
                 }
             } 
             // Xử lý Hồi Nội Lực (Mana)
             else if (itemDB.effect.target === 'mana') {
                 const manaAmount = itemDB.effect.isPercent ? Math.floor(stats.mana * (itemDB.effect.value / 100)) : itemDB.effect.value;
                 const missing = stats.mana - gameData.player.currentMana;
                 if (missing > 0) {
                     recovered = Math.min(missing, manaAmount);
                     gameData.player.currentMana += recovered;
                     shouldConsume = true;
                     logMsg = `Dùng ${itemDB.name}, hồi ${recovered.toLocaleString()} Nội Lực.`;
                 } else if (!isAuto) {
                     showToast("Nội lực đã đầy!", false);
                     return;
                 }
             }
             // Xử lý Chân Khí
             else if (itemDB.effect.target === 'chan_khi') {
                 const amount = itemDB.effect.value;
                 gameData.chanKhi = (gameData.chanKhi || 0) + amount;
                 shouldConsume = true;
                 logMsg = `Dùng ${itemDB.name}, nhận ${amount.toLocaleString()} Chân Khí.`;
             }
             // Xử lý Kinh Nghiệm (XP)
             else if (itemDB.effect.target === 'xp') {
                 const xpGained = itemDB.effect.value;
                 addPlayerXp(xpGained, 'item');
                 shouldConsume = true;
                 logMsg = `Dùng ${itemDB.name}, nhận ${xpGained.toLocaleString()} Kinh nghiệm.`;
             }
             
             // Tiêu thụ vật phẩm và cập nhật UI
             if (shouldConsume) {
                 gameData.items[itemId]--;
                 if (gameData.items[itemId] <= 0) delete gameData.items[itemId];
                 
                 if (!isAuto) {
                     showToast(logMsg, true);
                     addTrainingLog(logMsg, 'player');
                 } else {
                     addTrainingLog(`(Tự động) ${logMsg}`, 'info');
                 }
                 
                 updateUI();
                 // Refresh inventory if open
                 if (!document.getElementById('equipment-modal').classList.contains('hidden')) {
                     // Nếu đang ở tab Bồi Dưỡng đệ tử thì refresh modal đó, còn không thì refresh hành trang
                     // (Ở đây giả sử dùng trong hành trang)
                     if (typeof renderCollectionList === 'function') {
                        renderCollectionList('equipment');
                     }
                 }
             }
        }
        
        function countInventorySlots() {
            let gearSlots = gameData.gearInventory.length;
            let itemSlots = 0;
            for (const id in gameData.items) {
                if (gameData.items[id] > 0) {
                    itemSlots++;
                }
            }
            return gearSlots + itemSlots;
        }
        
        // --- [END NEW FUNCTIONS] ---

        function startNewCombat(mapData) {
            let enemyId = null;
            
            // [NEW] Check for Super Rare Boss first
            const RARE_BOSS_ID = 'boss_rare_01';
            const RARE_BOSS_CHANCE = 0.0001; // 0.01%
            
            if (Math.random() < RARE_BOSS_CHANCE) {
                enemyId = RARE_BOSS_ID;
                // Log this special event!
                addTrainingLog(`!!! <span class="text-red-500 font-bold">KHẨN CẤP!</span> ${ENEMIES_DB[RARE_BOSS_ID].name} đã xuất hiện!!!`, 'system');
            } else {
                // [MODIFIED] Handle boss-only maps
                if (mapData.boss && (!mapData.enemies || mapData.enemies.length === 0)) {
                    // If map has a boss and no regular enemies, always fight the boss
                    enemyId = mapData.boss;
                } else if (mapData.boss && Math.random() < 0.2) { 
                    // If map has both, 20% chance for boss
                    enemyId = mapData.boss; 
                } else if (mapData.enemies && mapData.enemies.length > 0) {
                    // Otherwise, pick a random regular enemy
                    enemyId = mapData.enemies[Math.floor(Math.random() * mapData.enemies.length)]; 
                }
            }
            
            // Fallback if no enemies defined at all (shouldn't happen with validation)
            if (!enemyId) { 
                 addTrainingLog(`Lỗi: Bản đồ ${mapData.name} không có quái vật. Dừng luyện.`, 'error'); 
                 stopTraining(); 
                 return;
             }
            
            const enemyDB = ENEMIES_DB[enemyId];
            if (!enemyDB) { addTrainingLog(`Lỗi: Không tìm thấy quái ${enemyId}.`, 'error'); return; }
            
            gameData.combatState = {
                active: true, enemyId: enemyId, enemyCurrentHp: enemyDB.stats.hp, enemyMaxHp: enemyDB.stats.hp,
                turn: 'player', turnCount: 1, playerBuffs: [], enemyDebuffs: []
            };
            
            addTrainingLog(`Đã gặp <span class="text-yellow-400">${enemyDB.name}</span> (Cấp ${enemyDB.level})!`, 'system');
            updateCombatUI(enemyDB);
        }

        // UPDATED: playerTurn - Added color class
        function playerTurn() {
            const playerStats = getTotalStats();
            const enemyDB = ENEMIES_DB[gameData.combatState.enemyId];
            let enemyStats = { ...enemyDB.stats };
            
            // [FIX] Initialize totalDamage and wasCrit at the top of the function
            let totalDamage = 0;
            let wasCrit = false;
            
            // TODO: Apply buffs/debuffs
            
            // [MODIFIED] Get skills based on player's chosen sect
            const playerSectId = gameData.player.monPhai || 'tieu_dao';
            const sectSkillList = MON_PHAI_SKILLS_DB[playerSectId]?.skills || MON_PHAI_SKILLS_DB['tieu_dao'].skills;
            
            const unlockedSkills = sectSkillList.filter(s => s.level <= gameData.player.level);
            const basicAttack = unlockedSkills.find(s => s.chance === 0) || sectSkillList[0];
            
            // Skill Selection
            let availableSkills = unlockedSkills.filter(skill => !skill || !skill.passive && gameData.player.currentMana >= skill.manaCost);
            if (availableSkills.length === 0) availableSkills = [basicAttack]; 
            let activatedSkills = availableSkills.filter(s => s.chance > 0 && (Math.random() * 100 < s.chance));
            let usedSkill = basicAttack;
            if (activatedSkills.length > 0) {
                activatedSkills.sort((a, b) => (b.multiplier || 0) - (a.multiplier || 0));
                usedSkill = activatedSkills[0];
            } else { usedSkill = availableSkills.find(s => s.chance === 0) || availableSkills[0]; }
            if (gameData.player.currentMana < usedSkill.manaCost) { usedSkill = basicAttack; }
            
            gameData.player.currentMana -= usedSkill.manaCost;

            let logMessage = `Bạn dùng <span class="text-teal-300">${usedSkill.name}</span>`;
            
            // TODO: Apply skill effects
            
            // Apply Damage
            if (usedSkill.multiplier > 0) {
                // [FIX] totalDamage and wasCrit are already defined above
                let hits = usedSkill.hits || 1; 
                for(let i=0; i < hits; i++) {
                    const overtimeDamage = Math.max(0, gameData.combatState.turnCount - 20);
                    // [MODIFIED] Apply passive ignoreDef
                    const defenseFactor = Math.max(0, 1 - (usedSkill.ignoreDef || 0) - (playerStats.ignoreDef_p / 100));
                    let damage = Math.max(1, playerStats.atk * (usedSkill.multiplier || 1) - (enemyStats.def * defenseFactor));
                    const critChance = Math.min(100, (playerStats.critChance + (usedSkill.bonusCrit || 0)));
                    if (Math.random() * 100 < critChance) {
                        wasCrit = true; // [FIX] Remove 'let'
                        // [MODIFIED] Apply passive ignoreDef
                        const critDefenseFactor = Math.max(0, 1 - (usedSkill.ignoreDef || 0) * 0.5 - (playerStats.ignoreDef_p / 100));
                        let critDamage = Math.max(1, playerStats.atk * (usedSkill.multiplier || 1) * 1.5 - (enemyStats.def * critDefenseFactor));
                        totalDamage += Math.floor(critDamage + overtimeDamage);
                    } else { totalDamage += Math.floor(damage + overtimeDamage); }
                }
                gameData.combatState.enemyCurrentHp -= totalDamage;
                
                // [NEW] Lifesteal/Manasteal Logic
                if (totalDamage > 0) {
                    // Lifesteal
                    const lifestealAmount = Math.floor(totalDamage * (playerStats.lifesteal / 100));
                    if (lifestealAmount > 0) {
                        gameData.player.currentHp = Math.min(playerStats.hp, gameData.player.currentHp + lifestealAmount);
                    }
                    // Manasteal
                    const manastealAmount = Math.floor(totalDamage * (playerStats.manasteal / 100));
                    if (manastealAmount > 0) {
                        gameData.player.currentMana = Math.min(playerStats.mana, gameData.player.currentMana + manastealAmount);
                    }
                }
                
                if(wasCrit) logMessage += ` <span class="text-yellow-300">(Chí mạng!)</span>`;
                logMessage += ` gây ${totalDamage} sát thương.`;
            }
            logMessage += ` (${enemyDB.name}: ${Math.max(0, gameData.combatState.enemyCurrentHp)}/${gameData.combatState.enemyMaxHp})`;
            
            // Add log with player class
            addTrainingLog(logMessage, 'player'); 
            flashHP('enemy');
            shakeCombatant('enemy'); // [NEW] Add shake effect
            playAttackAnimation('enemy'); // [NEW] Add spark effect
            
            // [FIX] Only show damage number if damage was dealt
            if (totalDamage > 0) {
                showDamageNumber(totalDamage, 'enemy', wasCrit); // [NEW] Show damage
            }
            
            // --- [NEW] SĨ KHÍ LOGIC ---
            // Check if enemy is still alive after the first hit
            if (gameData.combatState.enemyCurrentHp > 0) {
                // Check for Si Khi bonus attack
                // [MODIFIED] Check new stat from playerStats
                if (playerStats.si_khi >= 50) { 
                    if (Math.random() < 0.30) { // 30% chance
                        addTrainingLog(`Sĩ Khí cao, bạn tấn công thêm lần nữa!`, 'player');
                        
                        // Perform a basic attack (ATK - DEF)
                        // [MODIFIED] Apply passive ignoreDef
                        const defenseFactor = Math.max(0, 1 - (playerStats.ignoreDef_p / 100)); 
                        let bonusDamage = Math.max(1, playerStats.atk - (enemyStats.def * defenseFactor));
                        let bonusWasCrit = false; // [NEW]
                        
                        // Check for crit on bonus attack
                        const critChance = Math.min(100, playerStats.critChance); // Use base crit
                        if (Math.random() * 100 < critChance) {
                            // [MODIFIED] Apply passive ignoreDef (50% effectiveness on crit)
                            const critDefenseFactor = Math.max(0, 1 - (playerStats.ignoreDef_p / 100) * 0.5); 
                            let critDamageVal = Math.max(1, playerStats.atk * (playerStats.critDamage / 100) - (enemyStats.def * critDefenseFactor)); // [MODIFIED] Use critDamage stat
                            bonusDamage = Math.floor(critDamageVal);
                            bonusWasCrit = true; // [NEW]
                            addTrainingLog(`Đòn đánh bồi <span class="text-yellow-300">(Chí mạng!)</span> gây ${bonusDamage} sát thương.`, 'player');
                        } else {
                            bonusDamage = Math.floor(bonusDamage);
                            addTrainingLog(`Đòn đánh bồi gây ${bonusDamage} sát thương.`, 'player');
                        }
                        
                        // Apply damage
                        gameData.combatState.enemyCurrentHp -= bonusDamage;
                        
                        // Apply lifesteal/manasteal for bonus attack
                        if (bonusDamage > 0) {
                            const lifestealAmount = Math.floor(bonusDamage * (playerStats.lifesteal / 100));
                            if (lifestealAmount > 0) gameData.player.currentHp = Math.min(playerStats.hp, gameData.player.currentHp + lifestealAmount);
                            const manastealAmount = Math.floor(bonusDamage * (playerStats.manasteal / 100));
                            if (manastealAmount > 0) gameData.player.currentMana = Math.min(playerStats.mana, gameData.player.currentMana + manastealAmount);
                        }
                        
                        flashHP('enemy');
                        shakeCombatant('enemy'); // [NEW] Add shake effect for bonus hit
                        playAttackAnimation('enemy'); // [NEW] Add spark effect for bonus hit
                        showDamageNumber(bonusDamage, 'enemy', bonusWasCrit); // [NEW] Show damage
                    }
                }
            }
            // --- [END SĨ KHÍ LOGIC] ---
        }
        
        // UPDATED: enemyTurn - Added color class
        function enemyTurn() {
            const playerStats = getTotalStats();
            const enemyDB = ENEMIES_DB[gameData.combatState.enemyId];
            let enemyStats = { ...enemyDB.stats };

            // TODO: Apply buffs/debuffs

            let logMessage = '';
            const dodgeChance = playerStats.dodgeChance; // Use the calculated dodge chance
            if (Math.random() * 100 < dodgeChance) {
                logMessage = `${enemyDB.name} tấn công, bạn đã <span class="text-green-400">né</span> đòn!`;
            } else {
                const enemySkill = enemyDB.skills[0] || { multiplier: 1 };
                const overtimeDamage = Math.max(0, gameData.combatState.turnCount - 20);
                let damage = Math.max(1, enemyStats.atk * (enemySkill.multiplier || 1) - playerStats.def);
                damage = Math.floor(damage + overtimeDamage); // Apply overtime
                
                gameData.player.currentHp -= damage;
                
                logMessage = `${enemyDB.name} dùng ${enemySkill.name || 'đòn đánh'} gây ${damage} sát thương.`;
                logMessage += ` (Bạn: ${Math.max(0, gameData.player.currentHp)}/${playerStats.hp})`;
                flashHP('player');
                shakeCombatant('player'); // [NEW] Add shake effect
                playAttackAnimation('player'); // [NEW] Add spark effect
                showDamageNumber(damage, 'player', false); // [NEW] Show damage
            }
            
            addTrainingLog(logMessage, 'enemy');
        }
        
        // --- [NEW] IDLE SKILL FUNCTIONS ---

        function getIdleSkillXpToNext(level) {
            return Math.floor(100 * Math.pow(1.25, level - 1));
        }

        // [NEW] Added missing function to render the Fishing UI panel
        function renderFishingPanel() {
            if (!gameData || !gameData.idleSkills) return; // Guard
            
            const skillId = 'fishing'; // Hardcode for fishing
            const skill = gameData.idleSkills[skillId];
            if (!skill) return;

            const startBtn = document.getElementById('start-fishing-btn');
            const stopBtn = document.getElementById('stop-fishing-btn');
            const actionBar = document.getElementById('fishing-action-bar')?.parentElement; // Get the container
            const actionText = document.getElementById('fishing-action-text');

            if (gameData.isIdling && gameData.idleSkillType === skillId) {
                // Idling (Fishing)
                if (startBtn) startBtn.classList.add('hidden');
                if (stopBtn) stopBtn.classList.remove('hidden');
                // [MODIFIED] Use invisible toggle
                if (actionBar) actionBar.classList.remove('invisible');
                if (actionText) actionText.textContent = 'Đang...'; // Default text
            } else {
                // Not idling this skill
                if (startBtn) startBtn.classList.remove('hidden');
                if (stopBtn) stopBtn.classList.add('hidden');
                // [MODIFIED] Use invisible toggle
                if (actionBar) actionBar.classList.add('invisible');
            }

            // Always update the skill bar and log
            updateIdleSkillUI(skillId);
            renderIdleLog(); // Renders the 'fishing' log
        }
        
        // [NEW] Render Mining Panel
        function renderMiningPanel() {
            if (!gameData || !gameData.idleSkills) return; // Guard
            
            const skillId = 'mining'; // Hardcode for mining
            const skill = gameData.idleSkills[skillId];
            if (!skill) return;

            const startBtn = document.getElementById('start-mining-btn');
            const stopBtn = document.getElementById('stop-mining-btn');
            const actionBar = document.getElementById('mining-action-bar')?.parentElement;
            const actionText = document.getElementById('mining-action-text');

            if (gameData.isIdling && gameData.idleSkillType === skillId) {
                // Idling (Mining)
                if (startBtn) startBtn.classList.add('hidden');
                if (stopBtn) stopBtn.classList.remove('hidden');
                // [MODIFIED] Use invisible toggle
                if (actionBar) actionBar.classList.remove('invisible');
                if (actionText) actionText.textContent = 'Đang...'; // Default text
            } else {
                // Not idling this skill
                if (startBtn) startBtn.classList.remove('hidden');
                if (stopBtn) stopBtn.classList.add('hidden');
                // [MODIFIED] Use invisible toggle
                if (actionBar) actionBar.classList.add('invisible');
            }

            // Always update the skill bar and log
            updateIdleSkillUI(skillId);
            renderIdleLog('mining'); // Renders the 'mining' log
        }

        // [NEW] Render Herbalism Panel (Copied from Mining)
        function renderHerbalismPanel() {
            if (!gameData || !gameData.idleSkills) return; // Guard
            
            const skillId = 'herbalism'; // Hardcode for herbalism
            const skill = gameData.idleSkills[skillId];
            if (!skill) return;

            const startBtn = document.getElementById('start-herbalism-btn');
            const stopBtn = document.getElementById('stop-herbalism-btn');
            const actionBar = document.getElementById('herbalism-action-bar')?.parentElement;
            const actionText = document.getElementById('herbalism-action-text');

            if (gameData.isIdling && gameData.idleSkillType === skillId) {
                // Idling (Herbalism)
                if (startBtn) startBtn.classList.add('hidden');
                if (stopBtn) stopBtn.classList.remove('hidden');
                // [MODIFIED] Use invisible toggle
                if (actionBar) actionBar.classList.remove('invisible');
                if (actionText) actionText.textContent = 'Đang...'; // Default text
            } else {
                // Not idling this skill
                if (startBtn) startBtn.classList.remove('hidden');
                if (stopBtn) stopBtn.classList.add('hidden');
                // [MODIFIED] Use invisible toggle
                if (actionBar) actionBar.classList.add('invisible');
            }

            // Always update the skill bar and log
            updateIdleSkillUI(skillId);
            renderIdleLog('herbalism'); // Renders the 'herbalism' log
        }

        // [NEW] Helper to render both idle panels
        function renderIdlePanels() {
            renderFishingPanel();
            renderMiningPanel();
            renderHerbalismPanel(); // [NEW]
        }

        function startIdleAction(actionId) {
            const actionData = IDLE_ACTION_DB[actionId];
            if (!actionData) {
                showToast("Hành động không hợp lệ!", false); return;
            }
            if (gameData.isIdling) {
                showToast("Đã đang thực hiện hành động khác!", false); return;
            }

            const skillId = actionData.skill;
            if (gameData.idleSkills[skillId].level < actionData.levelReq) {
                showToast(`Cần kỹ năng [${skillId}] cấp ${actionData.levelReq}!`, false);
                return;
            }

            gameData.isIdling = true;
            gameData.currentIdleAction = actionId;
            gameData.idleSkillType = skillId;
            gameData.idleLog = [];
            gameData.lastIdleTick = Date.now(); // Start timer
            
            addIdleLog(`Bắt đầu [${actionData.name}]...`, 'system');
            
            // Update UI
            renderIdlePanels(); // [MODIFIED]
            
            // [MODIFIED] Start the loop IF NOT ALREADY RUNNING
            if (!gameLoopInterval) {
                gameLoopInterval = setInterval(gameLoop, GAME_TICK_MS);
            }
        }

        function stopIdleAction() {
            if (!gameData.isIdling) return;

            // [MODIFIED] Stop the loop ONLY if not training
            if (gameLoopInterval && !gameData.isTraining) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
            }

            gameData.lastIdleTick = 0; // Stop the timer

            const actionData = IDLE_ACTION_DB[gameData.currentIdleAction];
            addIdleLog(`Đã dừng [${actionData.name}].`, 'info');

            gameData.isIdling = false;
            gameData.currentIdleAction = null;
            // Keep idleSkillType to know which tab was last active
            
            showToast("Đã dừng hoạt động.", true);
            
            // Update UI
            renderIdlePanels(); // [MODIFIED]
        }

        function performIdleTick() {
            if (!gameData.isIdling || !gameData.currentIdleAction) {
                stopIdleAction(); return;
            }

            // [FIX] Thêm dòng này để định nghĩa actionData
            const actionData = IDLE_ACTION_DB[gameData.currentIdleAction];
            if (!actionData) {
                console.error("Lỗi: Không tìm thấy actionData cho:", gameData.currentIdleAction);
                stopIdleAction();
                return;
            }
            // [END FIX]

            // [REMOVED] Xóa bỏ toàn bộ logic Dynamic Loot Table (dựa theo cấp kỹ năng)
            /*
            let dynamicLootTable = [];
            const fishingLevel = gameData.idleSkills.fishing.level;

            if (actionData.id === 'fishing_spot_1') {
                // Mặc định (Cấp 1-19)
                dynamicLootTable = [
                    { id: 'fish_common_1', chance: 65 }, // Cá Diếc
                    { id: 'fish_common_2', chance: 25 }, // Cá Rô
                    { id: 'fish_uncommon_1', chance: 10 } // Cá Chép
                ];

                if (fishingLevel >= 50) {
                    // Cấp 50+: Thêm Cá Trắm Cỏ
                    dynamicLootTable = [
                        { id: 'fish_uncommon_1', chance: 30 }, // Bỏ cá common
                        { id: 'fish_uncommon_2', chance: 30 }, // Cá Lóc
                        { id: 'fish_rare_1', chance: 25 },     // Cá Vàng
                        { id: 'fish_rare_2', chance: 15 }      // Thêm Cá Trắm Cỏ
                    ];
                } else if (fishingLevel >= 35) {
                    // Cấp 35-49: Thêm Cá Vàng
                     dynamicLootTable = [
                        { id: 'fish_common_1', chance: 20 }, 
                        { id: 'fish_common_2', chance: 20 }, 
                        { id: 'fish_uncommon_1', chance: 25 },
                        { id: 'fish_uncommon_2', chance: 20 }, // Cá Lóc
                        { id: 'fish_rare_1', chance: 15 }     // Thêm Cá Vàng
                    ];
                } else if (fishingLevel >= 20) {
                    // Cấp 20-34: Thêm Cá Lóc
                    dynamicLootTable = [
                        { id: 'fish_common_1', chance: 40 }, 
                        { id: 'fish_common_2', chance: 25 }, 
                        { id: 'fish_uncommon_1', chance: 20 },
                        { id: 'fish_uncommon_2', chance: 15 } // Thêm Cá Lóc
                    ];
                }
                
            } else {
                // Fallback cho các hành động khác (nếu có)
                dynamicLootTable = actionData.loot;
            }
            */
            // [END REMOVAL]

            // Roll for loot
            let foundLoot = false;
            const roll = Math.random() * 100;
            let cumulativeChance = 0;

            for (const lootItem of actionData.loot) { // [MODIFIED] Trở về logic cũ (dùng actionData.loot)
                cumulativeChance += lootItem.chance;
                if (roll <= cumulativeChance) {
                    const itemDB = MATERIALS_DB[lootItem.id];
                    if(itemDB) {
                        addMaterial(lootItem.id, 1, 'idle');
                        addIdleSkillXp(actionData.skill, itemDB.xp || 1);
                        foundLoot = true;
                    }
                    break;
                }
            }

            if (!foundLoot) {
                addIdleLog("Không nhận được gì...", 'info');
                // [MODIFIED] Chỉ cộng 1 XP nếu có bảng loot
                if (actionData.loot.length > 0) { // [MODIFIED] Trở về logic cũ
                    addIdleSkillXp(actionData.skill, 1);
                }
            }
            
            // Update log UI
            renderIdleLog();
            renderIdleLog('mining'); // [NEW] Update mining log too
            renderIdleLog('herbalism'); // [NEW] Update herbalism log
         }
        
        function addMaterial(itemId, amount, source = null) { // [MODIFIED] Added source
            const itemDB = MATERIALS_DB[itemId];
            if (!itemDB) return;

            gameData.materials[itemId] = (gameData.materials[itemId] || 0) + amount;
            
            // [MODIFIED] Log based on source
            if (source === 'idle') {
                const skillName = SKILL_NAMES_DB[gameData.idleSkillType] || 'Hoạt động';
                addIdleLog(`Nhận được ${itemDB.name} x${amount}.`, 'reward', skillName);
            } else if (source === 'combat') {
                 addTrainingLog(`Nhận được ${itemDB.name} x${amount}.`, 'reward');
            }
            // [NEW] Log for turn-based combat
            else if (source === 'turn_based') {
                addTurnBasedCombatLog(`Nhận được ${itemDB.name} x${amount}.`, 'reward');
            }
            // No log for 'exchange' or null, handled by toast
        }

        function addIdleSkillXp(skillId, xpAmount) {
            if (!gameData.idleSkills[skillId]) return;

            gameData.idleSkills[skillId].xp += xpAmount;
            addIdleLog(`+${xpAmount} XP [${skillId}].`, 'reward');
            checkIdleSkillLevelUp(skillId);
        }
        
        function checkIdleSkillLevelUp(skillId) {
            const skill = gameData.idleSkills[skillId];
            if (!skill) return;
            
            const skillName = SKILL_NAMES_DB[skillId] || 'Kỹ năng'; // [NEW]

            while (skill.xp >= skill.xpToNext) {
                skill.level++;
                skill.xp -= skill.xpToNext;
                skill.xpToNext = getIdleSkillXpToNext(skill.level);
                addIdleLog(`Kỹ năng [${skillName}] đã thăng lên Cấp ${skill.level}!`, 'system'); // [MODIFIED]
            }
            
            // Update skill UI
            updateIdleSkillUI(skillId);
        }
        
         function addIdleLog(message, type = 'info') {
             if (!gameData.isIdling) return; // Don't log if not idling
             
             // [NEW] Determine which log to add to
             const skillId = gameData.idleSkillType;
             let logArray;
             if (skillId === 'mining') {
                if (!gameData.idleLogMining) gameData.idleLogMining = [];
                logArray = gameData.idleLogMining;
             } else if (skillId === 'herbalism') { // [NEW]
                if (!gameData.idleLogHerbalism) gameData.idleLogHerbalism = []; // [NEW]
                logArray = gameData.idleLogHerbalism; // [NEW]
             } else {
                if (!gameData.idleLog) gameData.idleLog = [];
                logArray = gameData.idleLog; // Default to fishing log
             }
             
             const logEntry = `<p class="log-${type}">${message}</p>`;
             
             // [FIX] Actually add the log entry to the array
             logArray.unshift(logEntry); 
             if (logArray.length > MAX_LOG_LINES) logArray.pop();

             // [MODIFIED] Render only the relevant log
             if (skillId === 'mining') {
                renderIdleLog('mining');
             } else if (skillId === 'herbalism') { // [NEW]
                renderIdleLog('herbalism'); // [NEW]
             } else {
                renderIdleLog(); // Renders fishing log
             }
         }
         
         function renderIdleLog(logType = 'fishing') { // [MODIFIED]
            let logContainer, logArray;

            if (logType === 'mining') {
                logContainer = document.getElementById('idle-log-mining');
                logArray = gameData.idleLogMining || [];
            } else if (logType === 'herbalism') { // [NEW]
                logContainer = document.getElementById('idle-log-herbalism'); // [NEW]
                logArray = gameData.idleLogHerbalism || []; // [NEW]
            } else {
                logContainer = document.getElementById('idle-log');
                logArray = gameData.idleLog || [];
            }

            if (logContainer) {
                logContainer.innerHTML = logArray.map(entry => entry).join('');
                logContainer.scrollTop = 0;
            }
         }
        
        /**
         * [NEW] Hiển thị số sát thương bay lên
         * @param {number} damage - Lượng sát thương
         * @param {'player' | 'enemy'} targetSide - Vị trí để hiển thị
         * @param {boolean} isCrit - Có phải chí mạng không?
         */
        function showDamageNumber(damage, targetSide, isCrit = false) {
            try {
                const overlay = document.getElementById('combat-animation-overlay');
                if (!overlay) return;

                const damageEl = document.createElement('div');
                damageEl.className = 'combat-damage-number';
                damageEl.textContent = damage;

                // Vị trí ngẫu nhiên một chút
                const randomX = Math.floor(Math.random() * 40) - 20; // -20px đến +20px

                // Đặt vị trí dựa trên mục tiêu
                if (targetSide === 'enemy') {
                    damageEl.style.top = '40%';
                    damageEl.style.right = '20%';
                    damageEl.style.transform = `translateX(${randomX}px)`;
                } else { // 'player'
                    damageEl.style.top = '40%';
                    damageEl.style.left = '20%';
                    damageEl.style.transform = `translateX(${randomX}px)`;
                }
                
                // Màu sắc và kích thước dựa trên chí mạng
                if (isCrit) {
                    damageEl.classList.add('text-yellow-300', 'text-2xl'); // [MODIFIED] To hơn
                } else {
                    damageEl.classList.add('text-white', 'text-lg');
                }

                overlay.appendChild(damageEl);

                // Tự động xóa
                setTimeout(() => {
                    damageEl.remove();
                }, 1000); // Khớp với thời gian animation (1s)
            } catch (e) {
                console.warn("Lỗi khi chạy showDamageNumber:", e);
            }
        }
        
        /**
         * [NEW] Chạy hiệu ứng tấn công (spark)
         * @param {'player' | 'enemy'} targetSide - Vị trí để hiển thị hiệu ứng
         */
        function playAttackAnimation(targetSide) {
            try {
                const overlay = document.getElementById('combat-animation-overlay');
                if (!overlay) return;

                const spark = document.createElement('div');
                spark.className = 'combat-spark';

                // Đặt vị trí dựa trên mục tiêu
                if (targetSide === 'enemy') {
                    spark.style.top = '50%'; // Khoảng giữa
                    spark.style.right = '20%'; // Bên phải (vị trí quái)
                } else { // 'player'
                    spark.style.top = '50%'; // Khoảng giữa
                    spark.style.left = '20%'; // Bên trái (vị trí người chơi)
                }

                overlay.appendChild(spark);

                // Tự động xóa tia lửa sau khi animation kết thúc (0.3s)
                setTimeout(() => {
                    spark.remove();
                }, 300);
            } catch (e) {
                console.warn("Lỗi khi chạy playAttackAnimation:", e);
            }
        }
        
        function updateIdleSkillUI(skillId) {
            if (!gameData || !gameData.idleSkills) return; // Add guard
            const skill = gameData.idleSkills[skillId];
            if (!skill) return;

            const levelEl = document.getElementById(`${skillId}-skill-level`);
            const xpEl = document.getElementById(`${skillId}-skill-xp`);
            const barEl = document.getElementById(`${skillId}-skill-bar`);

            if (levelEl) levelEl.textContent = `Cấp ${skill.level}`;
            if (xpEl) xpEl.textContent = `${skill.xp} / ${skill.xpToNext} XP`;
            if (barEl) barEl.style.width = `${(skill.xp / skill.xpToNext) * 100}%`;
        }
        
        function updateIdleActionProgress(timePassed, tickRate) {
            const skillId = gameData.idleSkillType; // [NEW]
            if (!skillId) return; // [NEW]

            const barEl = document.getElementById(`${skillId}-action-bar`); // [MODIFIED]
            const textEl = document.getElementById(`${skillId}-action-text`); // [MODIFIED]
            const percent = (timePassed / tickRate) * 100;
            
            // [NEW] Determine action name
            let actionName = '...';
            if (skillId === 'fishing') actionName = 'câu';
            else if (skillId === 'mining') actionName = 'đào';
            else if (skillId === 'herbalism') actionName = 'hái';
            
            if (barEl) barEl.style.width = `${Math.min(100, percent)}%`;
            if (textEl) textEl.textContent = `Đang ${actionName}... (${Math.floor((tickRate - timePassed) / 1000)}s)`; // [MODIFIED]
        }

        // --- END IDLE SKILL FUNCTIONS ---

        // --- UI RENDERING ---
        function updateUI() {
            if (!gameData || gameData.nganLuong === undefined) {
                 gameData = JSON.parse(JSON.stringify(initialGameData));
            };

            const playerStats = getTotalStats(); // Get MAX stats
            
            // Update currency
            document.getElementById('nganluong-display').textContent = gameData.nganLuong.toLocaleString(); // [FIX] Format number
            document.getElementById('knb-display').textContent = gameData.kimNguyenBao.toLocaleString(); // [FIX] Format number
            document.getElementById('linhkhi-display').textContent = (gameData.linhKhi || 0).toLocaleString(); 
            document.getElementById('linhthach-display').textContent = (gameData.linhThach || 0).toLocaleString(); 
            document.getElementById('tuvi-display').textContent = (gameData.tuVi || 0).toLocaleString(); 
            document.getElementById('linhhonthach-display').textContent = (gameData.linhHonThach || 0).toLocaleString(); 
            document.getElementById('chankhi-display').textContent = (gameData.chanKhi || 0).toLocaleString(); 

            // [NEW] Cập nhật trạng thái nút Tông Môn (Cấp 40 mở)
            const sectBtn = document.getElementById('btn-open-sect');
            if (sectBtn) {
                if (gameData.player.level < 40) {
                    sectBtn.classList.add('opacity-50', 'grayscale');
                    // Hiển thị text yêu cầu
                    sectBtn.innerHTML = `Tông Môn <span class="text-[10px] block text-red-300 font-normal">(Cấp 40)</span>`;
                } else {
                    sectBtn.classList.remove('opacity-50', 'grayscale');
                    sectBtn.innerHTML = `Tông Môn`;
                }
            }

            // [NEW] Cập nhật trạng thái nút Sủng Vật (Cấp 30 mở)
            const petBtn = document.getElementById('btn-open-pet');
            if (petBtn) {
                if (gameData.player.level < 30) {
                    petBtn.classList.add('opacity-50', 'grayscale');
                    petBtn.innerHTML = `Sủng Vật <span class="text-[10px] block text-red-300 font-normal">(Cấp 30)</span>`;
                } else {
                    petBtn.classList.remove('opacity-50', 'grayscale');
                    petBtn.innerHTML = `Sủng Vật`;
                }
            }

            // [NEW] Cập nhật trạng thái nút Mệnh Cách (Cấp 60 mở)
            const mcBtn = document.getElementById('btn-open-menh-cach');
            if (mcBtn) {
                if (gameData.player.level < 60) {
                    mcBtn.classList.add('opacity-50', 'grayscale');
                    mcBtn.innerHTML = `Mệnh Cách <span class="text-[10px] block text-red-300 font-normal">(Cấp 60)</span>`;
                } else {
                    mcBtn.classList.remove('opacity-50', 'grayscale');
                    mcBtn.innerHTML = `Mệnh Cách`;
                }
            }

            // [MODIFIED] Update Player Title with Realm & Tooltip - HIỆU ỨNG RIÊNG CHO TỪNG CẢNH GIỚI
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            const playerTitleEl = document.getElementById('player-title-display');

            // [NEW] Định nghĩa Style cho từng cảnh giới
            const REALM_STYLES = {
                'pham_nhan': 'text-gray-400 font-medium hover:text-gray-200 transition', // Xám bình thường
                'luyen_khi': 'text-cyan-300 font-bold hover:text-white hover:drop-shadow-[0_0_8px_rgba(34,211,238,0.8)] transition', // Xanh lơ sáng
                'truc_co': 'text-green-400 font-bold hover:text-green-100 hover:drop-shadow-[0_0_8px_rgba(74,222,128,0.8)] transition', // Xanh lá
                'kim_dan': 'text-yellow-400 font-bold hover:text-yellow-100 hover:drop-shadow-[0_0_10px_rgba(250,204,21,0.8)] transition', // Vàng kim đan
                'nguyen_anh': 'text-purple-400 font-bold hover:text-purple-100 hover:drop-shadow-[0_0_10px_rgba(192,132,252,0.8)] transition', // Tím nguyên anh
                'hoa_than': 'text-red-500 font-bold hover:text-red-100 hover:drop-shadow-[0_0_12px_rgba(248,113,113,0.9)] transition', // Đỏ hóa thần
                'dai_thua': 'text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-amber-400 to-yellow-200 font-black hover:drop-shadow-[0_0_20px_rgba(251,191,36,1)] transition transform hover:scale-105', // Đại thừa: Gradient Vàng
                
                // Các cảnh giới cao cấp
                'do_kiep': 'text-red-600 font-black animate-pulse hover:text-red-200 hover:drop-shadow-[0_0_20px_rgba(220,38,38,1)]', // Đỏ chớp nháy
                'hu_tien': 'text-cyan-200 font-black text-shadow-cyan hover:scale-105 transition', 
                'chan_tien': 'text-emerald-300 font-black text-shadow-green hover:scale-105 transition',
                'kim_tien': 'text-yellow-300 font-black text-shadow-gold hover:scale-105 transition',
                'huyen_tien': 'text-indigo-400 font-black text-shadow-purple hover:scale-105 transition',
                'thai_at_tien': 'text-pink-300 font-black text-shadow-pink hover:scale-105 transition',
                'dai_la_kim_tien': 'text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-fuchsia-500 to-purple-400 font-black hover:drop-shadow-[0_0_20px_rgba(216,180,254,1)] transition',
                'thanh_nhan': 'text-rainbow-animation font-black text-xl hover:scale-110 transition-transform cursor-help'
            };

            const realmClass = REALM_STYLES[realmId] || 'text-gray-400';

            if (playerTitleEl && realm) {
                // Áp dụng class động
                playerTitleEl.innerHTML = `Luân Hồi Giả - <span class="${realmClass} cursor-help" onmouseover="showTooltip(event, 'realm_bonus', '${realmId}')" onmouseout="hideTooltip()">${realm.name}</span>`;
            } else if (playerTitleEl) {
                 playerTitleEl.innerHTML = `Lãng Tử Giang Hồ - <span class="text-gray-400">Phàm Nhân</span>`; // Fallback
            }

            // Update Player display & Stats
            // [MODIFIED] UI Nâng Cấp cho Thẻ Thông Tin Nhân Vật
            
            // Prepare Rebirth Text
            let rebirthCount = gameData.rebirthCount || 0;
            let rebirthHtml = '';
            if (rebirthCount > 0) {
                rebirthHtml = `<span class="text-[10px] font-bold bg-red-900/40 text-red-300 px-2 py-0.5 rounded border border-red-500/30 ml-2">Trùng Sinh ${rebirthCount}</span>`;
            }

            // [NEW] Logic hiển thị Avatar: Ưu tiên Ảnh -> Icon
            let avatarContent = '';
            if (PLAYER_DATA.avatar) {
                avatarContent = `<img src="${PLAYER_DATA.avatar}" alt="Avatar" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">`;
            } else {
                avatarContent = `<i class="${PLAYER_DATA.icon || 'fa-solid fa-user-ninja'} text-3xl text-yellow-100"></i>`;
            }

            // [NEW] Logic hiển thị nút Kỳ Ngộ
            let kyNgoBtnClass = "text-[10px] bg-indigo-900/50 hover:bg-indigo-800 border border-indigo-500/30 text-indigo-200 px-2 py-0.5 rounded transition cursor-pointer select-none";
            let kyNgoBtnText = "Kỳ Ngộ";
            
            // Nếu có sự kiện đang chờ, nút sẽ nổi bật
            if (gameData.pendingEvent) {
                kyNgoBtnClass = "text-[10px] bg-yellow-600 hover:bg-yellow-500 border border-yellow-400 text-white px-2 py-0.5 rounded transition cursor-pointer select-none animate-pulse shadow-[0_0_10px_rgba(234,179,8,0.5)] font-bold";
                kyNgoBtnText = '<i class="fa-solid fa-exclamation-circle mr-1"></i>Kỳ Ngộ Mới!';
            }

            const characterCardHtml = `
                <div class="relative overflow-hidden rounded-xl p-4 border border-gray-600 bg-gradient-to-br from-gray-800/90 to-black/80 shadow-xl group">
                    <!-- Decorative Background Elements -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none"></div>
                    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
                    
                    <!-- Header: Avatar & Name -->
                    <div class="flex items-center gap-4 mb-4 border-b border-gray-700/50 pb-4 relative z-10">
                        <!-- Avatar Circle [MODIFIED] Added overflow-hidden for image -->
                        <div class="w-16 h-16 rounded-full border-2 border-yellow-500/50 flex items-center justify-center bg-black/40 shadow-[0_0_15px_rgba(234,179,8,0.2)] flex-shrink-0 overflow-hidden">
                            ${avatarContent}
                        </div>
                        
                        <div class="flex-grow min-w-0">
                            <div class="flex items-center gap-2">
                                <h4 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-orange-300 to-yellow-200 tracking-wide drop-shadow-sm truncate">
                                    ${PLAYER_DATA.name}
                                </h4>
                                <!-- [MODIFIED] Nút Kỳ Ngộ (Panel cạnh tên) -->
                                <button onclick="openKyNgoModal()" class="${kyNgoBtnClass}">
                                    ${kyNgoBtnText}
                                </button>
                            </div>
                            <div class="flex items-center flex-wrap gap-1 mt-1">
                                <span class="text-xs font-bold bg-blue-900/40 text-blue-300 px-2 py-0.5 rounded border border-blue-500/30">
                                    Cấp ${gameData.player.level}
                                </span>
                                ${rebirthHtml}
                            </div>
                        </div>
                    </div>

                    <!-- Stats List -->
                    <div class="space-y-1.5 relative z-10">
                        <!-- Uy Danh -->
                        <div class="flex justify-between items-center bg-white/5 p-1.5 rounded hover:bg-white/10 transition duration-200">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-purple-900/30 flex items-center justify-center border border-purple-500/20 shadow-sm"><i class="fa-solid fa-crown text-purple-400 text-[10px]"></i></div>
                                <span class="text-xs text-purple-200/80 font-medium">Uy Danh</span>
                            </div>
                            <span class="text-sm font-mono font-bold text-purple-300 text-shadow-purple">${gameData.uyDanh.toLocaleString()}</span>
                        </div>
                        
                        <!-- Danh Vọng -->
                        <div class="flex justify-between items-center bg-white/5 p-1.5 rounded hover:bg-white/10 transition duration-200">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-teal-900/30 flex items-center justify-center border border-teal-500/20 shadow-sm"><i class="fa-solid fa-scroll text-teal-400 text-[10px]"></i></div>
                                <span class="text-xs text-teal-200/80 font-medium">Danh Vọng</span>
                            </div>
                            <span class="text-sm font-mono font-bold text-teal-300 text-shadow-cyan">${gameData.danhVong.toLocaleString()}</span>
                        </div>

                        <!-- Cống Hiến -->
                        <div class="flex justify-between items-center bg-white/5 p-1.5 rounded hover:bg-white/10 transition duration-200">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-lime-900/30 flex items-center justify-center border border-lime-500/20 shadow-sm"><i class="fa-solid fa-hand-holding-heart text-lime-400 text-[10px]"></i></div>
                                <span class="text-xs text-lime-200/80 font-medium">Cống Hiến</span>
                            </div>
                            <span class="text-sm font-mono font-bold text-lime-300 text-shadow-green">${(gameData.diemCongHien || 0).toLocaleString()}</span>
                        </div>

                        <!-- Vinh Dự -->
                        <div class="flex justify-between items-center bg-white/5 p-1.5 rounded hover:bg-white/10 transition duration-200">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-orange-900/30 flex items-center justify-center border border-orange-500/20 shadow-sm"><i class="fa-solid fa-medal text-orange-400 text-[10px]"></i></div>
                                <span class="text-xs text-orange-200/80 font-medium">Vinh Dự</span>
                            </div>
                            <span class="text-sm font-mono font-bold text-orange-300 text-shadow-orange">${(gameData.diemVinhDuLienDau || 0).toLocaleString()}</span>
                        </div>

                        <!-- Tích Lũy -->
                        <div class="flex justify-between items-center bg-white/5 p-1.5 rounded hover:bg-white/10 transition duration-200">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-pink-900/30 flex items-center justify-center border border-pink-500/20 shadow-sm"><i class="fa-solid fa-ticket text-pink-400 text-[10px]"></i></div>
                                <span class="text-xs text-pink-200/80 font-medium">Tích Lũy</span>
                            </div>
                            <span class="text-sm font-mono font-bold text-pink-300 text-shadow-pink">${(gameData.diemTichLuyTongKim || 0).toLocaleString()}</span>
                        </div>

                        <!-- [NEW] Thần Cách -->
                        <div class="flex justify-between items-center bg-white/5 p-1.5 rounded hover:bg-white/10 transition duration-200">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-red-900/30 flex items-center justify-center border border-red-500/20 shadow-sm"><i class="fa-solid fa-sun text-red-400 text-[10px] animate-pulse"></i></div>
                                <span class="text-xs text-red-200/80 font-medium">Thần Cách</span>
                            </div>
                            <span class="text-sm font-mono font-bold text-red-300 text-shadow-red">${(gameData.thanCach || 0).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;

            // [MODIFIED] Thay thế innerHTML bằng nội dung mới, xóa class cũ
            const charInfoContainer = document.getElementById('equipped-character');
            charInfoContainer.className = "mb-6"; // Xóa bg-gray-700 cũ, chỉ giữ margin
            charInfoContainer.innerHTML = characterCardHtml;

            // Update HP/Mana Bars (Main Panel)
            document.getElementById('hp-display').textContent = `${gameData.player.currentHp} / ${playerStats.hp}`;
            document.getElementById('hp-bar').style.width = `${(gameData.player.currentHp / playerStats.hp) * 100}%`;
            document.getElementById('mana-display').textContent = `${gameData.player.currentMana} / ${playerStats.mana}`;
            document.getElementById('mana-bar').style.width = `${(gameData.player.currentMana / playerStats.mana) * 100}%`;
            // [NEW] Update Hon Luc Bar
            document.getElementById('honluc-display').textContent = `${gameData.player.honLuc} / ${playerStats.honLuc}`;
            document.getElementById('honluc-bar').style.width = `${(gameData.player.honLuc / playerStats.honLuc) * 100}%`;

            // Update XP Bar
            document.getElementById('xp-display').textContent = `${gameData.player.xp} / ${gameData.player.xpToNext}`;
            document.getElementById('xp-bar').style.width = `${(gameData.player.xp / gameData.player.xpToNext) * 100}%`;

            // *** UPDATED: Update 6-Slot Equipment display (GRID UI UPGRADE) ***
            const equipContainer = document.getElementById('equipped-equipment');
            equipContainer.innerHTML = ''; 
            
            // [MODIFIED] Chuyển sang Grid 2 cột, gap nhỏ
            equipContainer.className = 'grid grid-cols-1 sm:grid-cols-2 gap-2'; 
            
            // Cấu hình hiển thị cho từng slot
            const slotConfig = {
                weapon: { name: 'Vũ Khí', icon: 'fa-khanda' },
                armor: { name: 'Hộ Giáp', icon: 'fa-shirt' },
                accessory1: { name: 'Giới Chỉ', icon: 'fa-ring' },
                accessory2: { name: 'Ngọc Bội', icon: 'fa-gem' },
                accessory3: { name: 'Hạng Liên', icon: 'fa-medal' }, 
                accessory4: { name: 'Mật Tịch', icon: 'fa-book-journal-whills' },
                accessory5: { name: 'Phi Phong', icon: 'fa-feather-pointed' },
                accessory6: { name: 'Bảo Vật', icon: 'fa-box-open' },
            };
            
            // Thứ tự hiển thị cố định
            const slotOrder = ['weapon', 'armor', 'accessory1', 'accessory2', 'accessory3', 'accessory4', 'accessory5', 'accessory6'];

            slotOrder.forEach(slotName => {
                const id = gameData.equippedSlots[slotName]; 
                const config = slotConfig[slotName] || { name: slotName, icon: 'fa-question' };
                let slotHTML = '';

                if (id) {
                    const item = gameData.gearInventory.find(i => i.uniqueId === id);
                    if (item) {
                        const quality = QUALITY_DB[item.quality];
                        const upgradeText = item.upgradeLevel > 0 ? ` <span class="text-yellow-300 text-[10px] font-bold">[+${item.upgradeLevel}]</span>` : '';
                        
                        // Custom icon logic based on slot (để override icon mặc định của item nếu cần)
                        let itemIcon = config.icon;
                        // Nếu muốn dùng icon của item: itemIcon = item.icon || config.icon;
                        // Ở đây ta dùng icon theo slot để đồng bộ giao diện

                        // [MODIFIED] UI Card nhỏ gọn
                        slotHTML = `
                            <div class="bg-black/20 backdrop-blur-sm border border-gray-700/50 rounded p-2 flex items-center gap-3 relative group hover:bg-white/5 transition cursor-help"
                                 onmouseover="showTooltip(event, 'equipment', '${id}')" 
                                 onmouseout="hideTooltip()">
                                
                                <!-- Icon Box -->
                                <div class="w-10 h-10 rounded bg-gray-900/80 border border-gray-600 flex items-center justify-center flex-shrink-0 shadow-inner group-hover:border-gray-400 transition relative overflow-hidden">
                                    <i class="fa-solid ${itemIcon} text-lg ${quality.className} relative z-10"></i>
                                    <!-- Background Glow nhẹ cho đồ xịn -->
                                    <div class="absolute inset-0 bg-${quality.color} opacity-10 z-0"></div>
                                </div>
                                
                                <!-- Info -->
                                <!-- [MODIFIED] Removed 'overflow-hidden' to allow text wrap, removed 'truncate', added 'break-words' -->
                                <div class="flex-grow min-w-0">
                                    <p class="text-[9px] text-gray-500 uppercase tracking-wider leading-none mb-1">${config.name}</p>
                                    <p class="font-bold text-xs ${quality.className} break-words leading-tight">${item.name}${upgradeText}</p>
                                </div>

                                <!-- Unequip Button (Hiện khi hover) -->
                                <button onclick="unequipItem('${slotName}')" class="absolute -top-1.5 -right-1.5 bg-red-900/90 text-red-200 rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition hover:bg-red-600 hover:scale-110 shadow-sm z-20 border border-red-500/50" title="Gỡ bỏ">
                                    <i class="fa-solid fa-xmark text-[10px]"></i>
                                </button>
                            </div>`;
                    } else {
                         gameData.equippedSlots[slotName] = null; // Fix dữ liệu lỗi
                    }
                }
                
                // Empty Slot UI
                if (!id || !gameData.equippedSlots[slotName]) { 
                    slotHTML = `
                        <div class="bg-black/10 border border-gray-800 border-dashed rounded p-2 flex items-center gap-3 opacity-50 hover:opacity-80 transition select-none">
                            <div class="w-10 h-10 rounded bg-gray-900/30 flex items-center justify-center flex-shrink-0">
                                <i class="fa-solid ${config.icon} text-gray-600 text-lg"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="text-[9px] text-gray-600 uppercase tracking-wider mb-0.5">${config.name}</p>
                                <p class="text-xs text-gray-500 italic">Trống</p>
                            </div>
                        </div>`;
                }
                equipContainer.innerHTML += slotHTML;
            });
            // *** END 6-Slot Display Update ***

            // Update Total Stats Display
            // [FIX]: This block was removed, as this logic is now correctly handled inside getTotalStats()
            
            // Update Training Panel Visibility
            if (gameData.isTraining) {
                document.getElementById('combat-display-panel').classList.remove('hidden');
                // [REMOVED] document.getElementById('quick-use-panel').classList.remove('hidden');
                document.getElementById('training-status-panel').classList.remove('hidden');
                document.getElementById('training-map-name').textContent = DUNGEONS_DB[gameData.currentMapId]?.name || '???';
                document.getElementById('training-log').innerHTML = gameData.trainingLog.map(entry => entry).join('');
            } else {
                document.getElementById('combat-display-panel').classList.add('hidden');
                // [REMOVED] document.getElementById('quick-use-panel').classList.add('hidden');
                document.getElementById('training-status-panel').classList.add('hidden');
            }
            
            // [REMOVED] Update Quick Potion Counts
            // document.getElementById('quick-hp-pot').textContent = gameData.items['item_hp_small'] || 0;
            // document.getElementById('quick-mana-pot').textContent = gameData.items['item_mana_small'] || 0;
            
            // Update Combat UI (if active)
            if (gameData.isTraining && gameData.combatState.active) {
                updateCombatUI(ENEMIES_DB[gameData.combatState.enemyId]);
            } else if (gameData.isTraining) {
                // If training but no enemy, show placeholder
                updateCombatUI(null);
            }
            
            // [NEW] Update Rebirth Button State
            const rebirthBtn = document.getElementById('rebirth-btn');
            if (rebirthBtn) {
                const currentMaxLevel = getMaxLevel(); // [NEW]
                if (gameData.player.level >= currentMaxLevel) {
                    rebirthBtn.disabled = false;
                    rebirthBtn.textContent = 'Trùng Sinh (Nhận Uy Danh)';
                    rebirthBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    rebirthBtn.disabled = true;
                    // [MODIFIED] Show dynamic requirement
                    rebirthBtn.textContent = `Trùng Sinh (Cần Cấp ${currentMaxLevel})`;
                    rebirthBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
            
            renderIdlePanels(); // [MODIFIED]
        }
        
        function updateCombatUI(enemyDB) {
            const playerStats = getTotalStats();
            document.getElementById('combat-player-level').textContent = gameData.player.level;
            document.getElementById('combat-player-hp-bar').style.width = `${(gameData.player.currentHp / playerStats.hp) * 100}%`;

            const enemyPanel = document.getElementById('combat-display-panel');
            if (enemyDB) {
                // [MODIFIED] Get rarity class for the enemy
                const rarityClass = getRarityClass(enemyDB.rarity);
                
                // Update enemy icon
                document.getElementById('combat-enemy-icon').className = `${enemyDB.icon} ${rarityClass}`; // Apply color to icon too
                
                // [MODIFIED] Update enemy name with color and sparkle
                const enemyNameEl = document.getElementById('combat-enemy-name');
                // Apply sparkle if rarity is > 1 (common)
                const sparkleClass = (enemyDB.rarity > 1) ? ' text-sparkle' : '';
                enemyNameEl.innerHTML = `<span class="${rarityClass}${sparkleClass}">${enemyDB.name}</span>`;
                
                document.getElementById('combat-enemy-level').textContent = `Cấp ${enemyDB.level}`;
                
                // Update enemy stats
                document.getElementById('combat-enemy-stats').innerHTML = `
                    <span title="Máu"><i class="fa-solid fa-heart text-red-400"></i> ${gameData.combatState.enemyCurrentHp}</span>
                    <span title="Công"><i class="fa-solid fa-khanda text-orange-400"></i> ${enemyDB.stats.atk}</span>
                    <span title="Thủ"><i class="fa-solid fa-shield-halved text-blue-400"></i> ${enemyDB.stats.def}</span>
                `;
                
                // Update enemy HP bar
                document.getElementById('combat-enemy-hp-bar').style.width = `${(gameData.combatState.enemyCurrentHp / gameData.combatState.enemyMaxHp) * 100}%`;
                
            } else {
                 // No enemy, show "Searching..."
                document.getElementById('combat-enemy-icon').className = `fa-solid fa-magnifying-glass text-gray-400`;
                document.getElementById('combat-enemy-name').textContent = "Tìm quái...";
                document.getElementById('combat-enemy-level').textContent = `...`;
                document.getElementById('combat-enemy-stats').innerHTML = ``;
                document.getElementById('combat-enemy-hp-bar').style.width = `100%`;
            }
        }
        
        // [NEW] Helper function to calculate total upgrade bonus percentage
        function getUpgradeBonusPercent(upgradeLevel) {
            if (!upgradeLevel || upgradeLevel <= 0) return 0;
            let totalBonus = 0;
            for (let i = 0; i < upgradeLevel; i++) {
                if (UPGRADE_RATES_DB[i] && !UPGRADE_RATES_DB[i].max) {
                    totalBonus += UPGRADE_RATES_DB[i].statBonusPercent;
                }
            }
            return totalBonus;
        }

        // [NEW] Helper function to apply passive skill bonuses
        function applyPassiveAffix(stats, percentBonuses, effect) {
            if (!effect || effect.type !== 'passive_buff') return;

            // [MODIFIED] Add ignoreDef_p
            if (effect.stat.endsWith('_p') || ['critChance', 'critDamage', 'dodgeChance', 'lifesteal', 'manasteal', 'xp_boost', 'ignoreDef_p'].includes(effect.stat)) {
                // It's a percentage bonus
                percentBonuses[effect.stat] = (percentBonuses[effect.stat] || 0) + effect.value;
            } else {
                // It's a flat bonus
                stats[effect.stat] = (stats[effect.stat] || 0) + effect.value;
            }
        }

        // *** UPDATED: getTotalStats to read from 6 slots AND affixes ***
        function getTotalStats() {
            const stats = { hp: 0, mana: 0, honLuc: 0, atk: 0, def: 0, spd: 0, lck: 0, si_khi: 0 }; 
            stats.atk_ky = 0;
            stats.atk_phep = 0;
            stats.def_ky = 0;
            stats.def_phep = 0;
            
            const percentBonuses = { 
                hp_p: 0, mana_p: 0, honLuc_p: 0, atk_p: 0, def_p: 0, spd_p: 0, lck_p: 0, 
                critChance: 0, critDamage: 0, dodgeChance: 0, lifesteal: 0, manasteal: 0, 
                xp_boost: 0, ignoreDef_p: 0, atk_ky_p: 0, atk_phep_p: 0, def_ky_p: 0, 
                def_phep_p: 0, block_chance_p: 0, anti_block_p: 0, anti_crit_p: 0, 
                accuracy_p: 0, doubleAtkChance: 0 
            }; 

            // 1. Add player base stats (from level)
            const playerBaseCalculated = calculateFullStats(PLAYER_DATA, gameData.player.level);
             for (const stat in playerBaseCalculated) {
                 stats[stat] = (stats[stat] || 0) + playerBaseCalculated[stat];
             }

            // [NEW] 1c. Add stats from Cultivation Realm (Cảnh Giới)
            // Logic: Tự động cộng dựa trên cảnh giới hiện tại. Khi Phi Thăng (về Phàm Nhân), bonus sẽ tự về 0.
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realmData = CANH_GIOI_DB[realmId];
            if (realmData && realmData.bonusStats) {
                if (realmData.bonusStats.hp) stats.hp += realmData.bonusStats.hp;
                if (realmData.bonusStats.atk) stats.atk += realmData.bonusStats.atk;
                if (realmData.bonusStats.def) stats.def += realmData.bonusStats.def;
            }

            // [NEW] 1b. Add stats from Potential Points (Tiềm Năng)
            if (gameData.player.allocatedStats) {
                const allocated = gameData.player.allocatedStats;
                
                // Sức Mạnh: +2 ATK
                stats.atk += (allocated.suc_manh || 0) * 2;
                
                // Thân Pháp: +2 SPD
                stats.spd += (allocated.than_phap || 0) * 2;
                
                // Sinh Khí: +20 HP
                stats.hp += (allocated.sinh_khi || 0) * 20;
                
                // Hồn Lực: +10 Max Hồn Lực, +10 Max Mana
                const honLucBonus = (allocated.hon_luc || 0) * 10;
                stats.honLuc += honLucBonus;
                stats.mana += honLucBonus;
            }

            // 2. Add stats from equipment slots (weapon, armor, 6 accessories) [MODIFIED]
            for (const slotName in gameData.equippedSlots) {
                const id = gameData.equippedSlots[slotName];
                if (!id) continue;
                
                // Find the item in inventory
                const item = gameData.gearInventory.find(i => i.uniqueId === id);
                if (!item) continue;
                
                // [NEW] Calculate upgrade bonus
                const upgradeBonusPercent = getUpgradeBonusPercent(item.upgradeLevel || 0);
                const upgradeMultiplier = 1 + (upgradeBonusPercent / 100);
                
                // 3. Add stats from item's affixes
                for (const affix of item.affixes) {
                    if (affix.isPercent) {
                        // Add to percent bonuses
                        percentBonuses[affix.id] = (percentBonuses[affix.id] || 0) + affix.value;
                    } else {
                        // Add to flat stats
                        // [MODIFIED] Apply upgrade bonus
                        stats[affix.id] = (stats[affix.id] || 0) + Math.floor(affix.value * upgradeMultiplier);
                    }
                }
            }

            // [NEW] 2b. Add stats from Passive Skills
            const playerSectId = gameData.player.monPhai || 'tieu_dao';
            const sectSkillList = MON_PHAI_SKILLS_DB[playerSectId]?.skills || MON_PHAI_SKILLS_DB['tieu_dao'].skills;
            
            // Apply passives from skills
            const passiveSkills = sectSkillList.filter(s => s.passive && s.level <= gameData.player.level);
            passiveSkills.forEach(skill => {
                if (skill.effect) applyPassiveAffix(stats, percentBonuses, skill.effect);
                if (skill.effect2) applyPassiveAffix(stats, percentBonuses, skill.effect2);
                if (skill.effect3) applyPassiveAffix(stats, percentBonuses, skill.effect3);
            });
            
            // [NEW] Apply passive from basic attack (if any)
            const basicAttack = sectSkillList.find(s => s.chance === 0 && s.level <= gameData.player.level);
            if (basicAttack && basicAttack.effect && basicAttack.effect.type === 'passive_buff') {
                 applyPassiveAffix(stats, percentBonuses, basicAttack.effect);
            }
            if (basicAttack && basicAttack.effect2 && basicAttack.effect2.type === 'passive_buff') {
                 applyPassiveAffix(stats, percentBonuses, basicAttack.effect2);
            }

            // [NEW] 2c. Add stats from Tinh Phách (Permanent Stats)
            stats.hp += gameData.permanentStats.hp;
            stats.def += gameData.permanentStats.def;
            stats.atk += gameData.permanentStats.atk;
            percentBonuses.xp_boost += gameData.permanentStats.xp_boost;

            // [NEW] 2d. Add stats from Equipped Pet
            if (gameData.equippedSungVat) {
                const petInstance = gameData.sungVat.find(p => p.id === gameData.equippedSungVat);
                if (petInstance) {
                    const petStats = getPetStats(petInstance); // Get calculated stats
                    stats.hp += petStats.hp;
                    stats.atk += petStats.atk;
                    stats.def += petStats.def;
                    stats.spd += petStats.spd;
                    
                    // [NEW] Apply pet passive to player (if applicable)
                    const petDB = SUNG_VAT_DB[petInstance.id];
                    if (petDB && petDB.passiveSkill && petDB.passiveSkill.effect) {
                        const effect = petDB.passiveSkill.effect;
                        // Loop through effects and apply if they are player-compatible stats
                        for (const key in effect) {
                             if (key.endsWith('_p') || ['critChance', 'critDamage', 'dodgeChance', 'lifesteal', 'manasteal', 'xp_boost', 'ignoreDef_p'].includes(key)) {
                                 percentBonuses[key] = (percentBonuses[key] || 0) + effect[key];
                             }
                        }
                    }
                }
            }

            // [NEW] 2g. Add stats from Deployed Disciple (Hộ Chủ)
            if (gameData.sect && gameData.sect.combatChampionId) {
                const champion = gameData.disciples.find(d => d.id === gameData.sect.combatChampionId);
                if (champion) {
                    // Cộng 30% chỉ số của đệ tử cho nhân vật chính
                    const bonusRatio = 0.3;
                    
                    stats.hp += Math.floor(champion.stats.hp * bonusRatio);
                    stats.atk += Math.floor(champion.stats.atk * bonusRatio);
                    stats.def += Math.floor((champion.stats.def || 0) * bonusRatio);
                    stats.spd += Math.floor((champion.stats.spd || 0) * bonusRatio);
                }
            }

            // [NEW] 2e. Add stats from Menh Cach
            if (gameData.equippedMenhCachSlots && gameData.menhCachInventory) {
                gameData.equippedMenhCachSlots.forEach(instanceId => {
                    if (!instanceId) return; // Skip empty slot

                    const mcInstance = gameData.menhCachInventory.find(inv => inv.instanceId === instanceId);
                    if (!mcInstance) return; // Skip if not found in inventory (shouldn't happen)

                    const mcDB = MENH_CACH_DB[mcInstance.id];
                    // Chỉ áp dụng chỉ số từ "Cát Mệnh"
                    if (!mcDB || mcDB.type !== 'cat') return; 

                    // Tính toán giá trị hiện tại dựa trên cấp độ
                    const currentValue = mcDB.baseValue + (mcDB.scaleValue * (mcInstance.level - 1));
                    
                    // Thêm vào
                    if (mcDB.isPercent) {
                        // Đây là bonus %
                        percentBonuses[mcDB.stat] = (percentBonuses[mcDB.stat] || 0) + currentValue;
                    } else {
                        // Đây là bonus điểm
                        stats[mcDB.stat] = (stats[mcDB.stat] || 0) + currentValue;
                    }
                });
            }
            // [END NEW]

            // [NEW] 2f. Add stats from Kinh Mạch (Meridians)
            if (gameData.player.kinhMach) {
                for (const kmId in gameData.player.kinhMach) {
                    const level = gameData.player.kinhMach[kmId];
                    if (level > 0 && KINH_MACH_DB[kmId]) {
                        const kmStats = KINH_MACH_DB[kmId].stats;
                        for (const statKey in kmStats) {
                            const valuePerLevel = kmStats[statKey];
                            const totalValue = valuePerLevel * level;

                            // Kiểm tra xem chỉ số này thuộc nhóm % hay nhóm điểm phẳng
                            if (percentBonuses.hasOwnProperty(statKey)) {
                                percentBonuses[statKey] += totalValue;
                            } else if (stats.hasOwnProperty(statKey)) {
                                stats[statKey] += totalValue;
                            }
                        }
                    }
                }
            }

            // [NEW] 3. Add Rebirth Bonus (Trùng Sinh)
            const rebirthBonusPercent = (gameData.rebirthCount || 0) * 1; // 1% per rebirth
            if (rebirthBonusPercent > 0) {
                percentBonuses.hp_p += rebirthBonusPercent;
                percentBonuses.mana_p += rebirthBonusPercent;
                percentBonuses.honLuc_p += rebirthBonusPercent; 
                percentBonuses.atk_p += rebirthBonusPercent;
                percentBonuses.def_p += rebirthBonusPercent;
                percentBonuses.spd_p += rebirthBonusPercent;
                percentBonuses.lck_p += rebirthBonusPercent;
                percentBonuses.atk_ky_p += rebirthBonusPercent;
                percentBonuses.atk_phep_p += rebirthBonusPercent;
                percentBonuses.def_ky_p += rebirthBonusPercent;
                percentBonuses.def_phep_p += rebirthBonusPercent;
            }

            // [NEW] 4. Add Phi Thăng (Tiên Lực) Bonus - THIS WAS MISSING IN DISPLAY LOGIC
            const tienLucBonusPercent = (gameData.tienLuc || 0) * 1; // +1% all stats per Tien Luc
            if (tienLucBonusPercent > 0) {
                percentBonuses.hp_p += tienLucBonusPercent;
                percentBonuses.mana_p += tienLucBonusPercent;
                percentBonuses.honLuc_p += tienLucBonusPercent; 
                percentBonuses.atk_p += tienLucBonusPercent;
                percentBonuses.def_p += tienLucBonusPercent;
                percentBonuses.spd_p += tienLucBonusPercent;
                percentBonuses.lck_p += tienLucBonusPercent;
                // Add bonus to sub-stats too
                percentBonuses.atk_ky_p += tienLucBonusPercent;
                percentBonuses.atk_phep_p += tienLucBonusPercent;
                percentBonuses.def_ky_p += tienLucBonusPercent;
                percentBonuses.def_phep_p += tienLucBonusPercent;
            }

            // [NEW] 5. Add Sieu Viet Bonus
            const sieuVietPoints = gameData.sieuVietPoints || 0;
            const sieuVietBonusPercent = sieuVietPoints * 2; // 2% per point
            if (sieuVietBonusPercent > 0) {
                 percentBonuses.hp_p += sieuVietBonusPercent;
                 percentBonuses.mana_p += sieuVietBonusPercent;
                 percentBonuses.honLuc_p += sieuVietBonusPercent;
                 percentBonuses.atk_p += sieuVietBonusPercent;
                 percentBonuses.def_p += sieuVietBonusPercent;
                 percentBonuses.spd_p += sieuVietBonusPercent;
                 percentBonuses.lck_p += sieuVietBonusPercent;
                 percentBonuses.atk_ky_p += sieuVietBonusPercent;
                 percentBonuses.atk_phep_p += sieuVietBonusPercent;
                 percentBonuses.def_ky_p += sieuVietBonusPercent;
                 percentBonuses.def_phep_p += sieuVietBonusPercent;
            }

            // 4. Apply Percent Bonuses
            stats.hp = Math.floor(stats.hp * (1 + percentBonuses.hp_p / 100));
            stats.mana = Math.floor(stats.mana * (1 + percentBonuses.mana_p / 100)); // [NEW] Apply Mana %
            stats.honLuc = Math.floor(stats.honLuc * (1 + percentBonuses.honLuc_p / 100)); // [NEW] Apply Hon Luc %
            stats.atk = Math.floor(stats.atk * (1 + percentBonuses.atk_p / 100));
            stats.def = Math.floor(stats.def * (1 + percentBonuses.def_p / 100));
            stats.spd = Math.floor(stats.spd * (1 + percentBonuses.spd_p / 100)); // [NEW] Apply Spd %
            stats.lck = Math.floor(stats.lck * (1 + percentBonuses.lck_p / 100)); // [NEW] Apply Lck %
            
            // [NEW] Apply % bonuses for new stats
            stats.atk_ky = Math.floor(stats.atk_ky * (1 + percentBonuses.atk_ky_p / 100));
            stats.atk_phep = Math.floor(stats.atk_phep * (1 + percentBonuses.atk_phep_p / 100));
            stats.def_ky = Math.floor(stats.def_ky * (1 + percentBonuses.def_ky_p / 100));
            stats.def_phep = Math.floor(stats.def_phep * (1 + percentBonuses.def_phep_p / 100));
            stats.si_khi = Math.floor(stats.si_khi); // [NEW] Sĩ khí is flat
            
            // [NEW] Summing logic as per user request
            // Combine atk, atk_ky, and atk_phep into the main 'atk' stat for combat and total display
            stats.atk = stats.atk + stats.atk_ky + stats.atk_phep;
            // Combine def, def_ky, and def_phep into the main 'def' stat for combat and total display
            stats.def = stats.def + stats.def_ky + stats.def_phep;

            // 5. Add secondary stats (Crit, Dodge)
            // Note: These base values come from player stats (lck, spd)
            // [MODIFIED] Base values are now 0, only equipment provides these stats.
            const baseCrit = 0; // Math.floor(stats.lck / 2);
            const baseDodge = 0; // Math.min(75, Math.floor(stats.spd / 2));
            
            // We store them directly in the 'stats' object for display, though they aren't base stats
            stats.critChance = baseCrit + percentBonuses.critChance;
            stats.critDamage = 150 + percentBonuses.critDamage; // Base 150% crit damage
            stats.dodgeChance = Math.min(60, baseDodge + percentBonuses.dodgeChance); // [MODIFIED] Cap dodge at 60%

            // [NEW] Add block and anti-stats
            stats.block_chance_p = percentBonuses.block_chance_p;
            stats.anti_block_p = percentBonuses.anti_block_p;
            stats.anti_crit_p = percentBonuses.anti_crit_p;
            stats.accuracy_p = percentBonuses.accuracy_p; // [NEW]

            // [NEW] Add special stats
            stats.lifesteal = Math.min(30, percentBonuses.lifesteal); // [MODIFIED] Cap lifesteal at 30%
            stats.manasteal = Math.min(30, percentBonuses.manasteal); // [MODIFIED] Cap manasteal at 30%
            stats.xp_boost = percentBonuses.xp_boost;
            stats.ignoreDef_p = percentBonuses.ignoreDef_p; // [NEW] Add ignoreDef_p

            // TODO: Apply passive skills from combatState.playerBuffs if needed
            // ...

            for (const stat in stats) { stats[stat] = Math.floor(stats[stat]); }
            
            // Update display values (they are calculated differently)
            const displayStats = { ...stats };
            displayStats.critChance = Math.round(stats.critChance * 10) / 10;
            displayStats.critDamage = Math.round(stats.critDamage);
            displayStats.dodgeChance = Math.round(stats.dodgeChance * 10) / 10;
            // [NEW] Add new stats to display
            displayStats.lifesteal = Math.round(stats.lifesteal * 10) / 10;
            displayStats.manasteal = Math.round(stats.manasteal * 10) / 10;
            displayStats.xp_boost = Math.round(stats.xp_boost);
            displayStats.ignoreDef_p = Math.round(stats.ignoreDef_p * 10) / 10; // [NEW]

            // [NEW] Add new stats to displayStats
            displayStats.block_chance_p = Math.round(stats.block_chance_p * 10) / 10;
            displayStats.anti_block_p = Math.round(stats.anti_block_p * 10) / 10;
            displayStats.anti_crit_p = Math.round(stats.anti_crit_p * 10) / 10;
            displayStats.si_khi = Math.round(stats.si_khi); // [NEW]
            displayStats.accuracy_p = Math.round(stats.accuracy_p * 10) / 10; // [NEW]

            // Update Total Stats Display (Redesigned UI)
            const totalStatsContainer = document.getElementById('total-stats');
            if (totalStatsContainer) {
                // [MODIFIED] Reset class cũ để áp dụng style mới (bỏ grid cũ)
                totalStatsContainer.className = 'bg-black/20 backdrop-blur-md p-3 rounded-lg border border-gray-700/50 shadow-inner';
                
                // 1. Global Buffs Header
                let buffsHtml = '';
                if (rebirthBonusPercent > 0 || tienLucBonusPercent > 0 || sieuVietBonusPercent > 0) {
                    buffsHtml = `<div class="flex flex-wrap gap-2 mb-3 border-b border-gray-700/50 pb-2">`;
                    if (rebirthBonusPercent > 0) 
                        buffsHtml += `<span class="bg-pink-900/30 text-pink-300 text-[10px] px-2 py-0.5 rounded border border-pink-500/30" title="Cộng toàn bộ chỉ số">Trùng Sinh +${rebirthBonusPercent}%</span>`;
                    if (tienLucBonusPercent > 0) 
                        buffsHtml += `<span class="bg-cyan-900/30 text-cyan-300 text-[10px] px-2 py-0.5 rounded border border-cyan-500/30" title="Cộng toàn bộ chỉ số">Phi Thăng +${tienLucBonusPercent}%</span>`;
                    if (sieuVietBonusPercent > 0) 
                        buffsHtml += `<span class="bg-yellow-900/30 text-yellow-300 text-[10px] px-2 py-0.5 rounded border border-yellow-500/30" title="Cộng toàn bộ chỉ số">Siêu Việt +${sieuVietBonusPercent}%</span>`;
                    buffsHtml += `</div>`;
                }

                // Helper to generate a stat row
                const statRow = (label, value, icon, color, isPercent = false) => `
                    <div class="flex justify-between items-center p-1 hover:bg-white/5 rounded transition-colors">
                        <div class="flex items-center gap-2">
                            <div class="w-5 text-center"><i class="${icon} ${color} text-xs"></i></div>
                            <span class="text-gray-400 text-xs">${label}</span>
                        </div>
                        <span class="font-mono text-xs font-bold ${color}">${value.toLocaleString()}${isPercent ? '%' : ''}</span>
                    </div>
                `;

                totalStatsContainer.innerHTML = `
                    ${buffsHtml}
                    
                    <div class="space-y-3">
                        <!-- Nhóm 1: Cơ Bản -->
                        <div>
                            <h6 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 pl-1">Cơ Bản</h6>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-0.5">
                                ${statRow('Sinh Lực', displayStats.hp, 'fa-solid fa-heart', 'text-red-400')}
                                ${statRow('Nội Lực', displayStats.mana, 'fa-solid fa-droplet', 'text-blue-400')}
                                ${statRow('Hồn Lực', displayStats.honLuc, 'fa-solid fa-ghost', 'text-purple-400')}
                                ${statRow('Công Kích', displayStats.atk, 'fa-solid fa-khanda', 'text-orange-400')}
                                ${statRow('Phòng Thủ', displayStats.def, 'fa-solid fa-shield-halved', 'text-blue-300')}
                                ${statRow('Thân Pháp', displayStats.spd, 'fa-solid fa-wind', 'text-green-400')}
                                ${statRow('May Mắn', displayStats.lck, 'fa-solid fa-clover', 'text-yellow-400')}
                                ${statRow('Sĩ Khí', displayStats.si_khi, 'fa-solid fa-bolt-lightning', 'text-yellow-200')}
                            </div>
                        </div>

                        <!-- Nhóm 2: Chiến Đấu -->
                        <div>
                            <h6 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 pl-1 border-t border-gray-700/30 pt-2">Chiến Đấu</h6>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-0.5">
                                ${statRow('Chí Mạng', displayStats.critChance, 'fa-solid fa-bolt', 'text-yellow-300', true)}
                                ${statRow('ST Bạo Kích', displayStats.critDamage, 'fa-solid fa-burst', 'text-red-500', true)}
                                ${statRow('Chính Xác', displayStats.accuracy_p, 'fa-solid fa-crosshairs', 'text-cyan-300', true)}
                                ${statRow('Xuyên Giáp', displayStats.ignoreDef_p, 'fa-solid fa-arrow-right-to-bracket', 'text-gray-300', true)}
                                ${statRow('Công Kỹ', displayStats.atk_ky, 'fa-solid fa-hand-fist', 'text-orange-300')}
                                ${statRow('Công Phép', displayStats.atk_phep, 'fa-solid fa-wand-sparkles', 'text-orange-300')}
                            </div>
                        </div>

                        <!-- Nhóm 3: Phòng Ngự & Khác -->
                        <div>
                            <h6 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 pl-1 border-t border-gray-700/30 pt-2">Phòng Ngự & Hiệu Ứng</h6>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-0.5">
                                ${statRow('Né Tránh', displayStats.dodgeChance, 'fa-solid fa-person-running', 'text-green-300', true)}
                                ${statRow('Chống Đỡ', displayStats.block_chance_p, 'fa-solid fa-shield', 'text-gray-400', true)}
                                ${statRow('Hút Máu', displayStats.lifesteal, 'fa-solid fa-tooth', 'text-red-400', true)}
                                ${statRow('Hút Mana', displayStats.manasteal, 'fa-solid fa-droplet-slash', 'text-blue-400', true)}
                                ${statRow('Kháng Bạo', displayStats.anti_crit_p, 'fa-solid fa-shield-heart', 'text-pink-300', true)}
                                ${statRow('Kinh Nghiệm', displayStats.xp_boost, 'fa-solid fa-book-open', 'text-yellow-200', true)}
                            </div>
                        </div>
                    </div>
                `;
            }

            return stats;
        }

        function renderSkillTree() {
            const listContainer = document.getElementById('skill-tree-list');
            const titleEl = document.getElementById('skills-modal-title');
            if (!listContainer || !titleEl) return;

            // [MODIFIED] Get skills based on player's chosen sect
            const playerSectId = gameData.player.monPhai || 'tieu_dao';
            const sectData = MON_PHAI_SKILLS_DB[playerSectId] || MON_PHAI_SKILLS_DB['tieu_dao'];
            const sectSkillList = sectData.skills;

            titleEl.textContent = `Kỹ Năng - ${sectData.name}`;

            listContainer.innerHTML = sectSkillList.map(skill => {
                const isUnlocked = gameData.player.level >= skill.level;
                const nodeClass = isUnlocked ? 'unlocked' : 'locked';

                let desc = skill.desc;
                if (skill.manaCost > 0) desc += ` (Tiêu hao: ${skill.manaCost} Nội Lực)`;

                return `<div class="skill-node ${nodeClass} pl-6 pb-6">
                            <h4 class="text-lg font-bold ${isUnlocked ? 'text-yellow-400' : 'text-gray-500'}">Cấp ${skill.level}: ${skill.name}</h4>
                            <p class="text-sm font-semibold ${isUnlocked ? 'text-cyan-400' : 'text-gray-400'} mb-1">[${skill.type}]</p>
                            <p class="text-sm ${isUnlocked ? 'text-gray-200' : 'text-gray-400'}">${desc}</p>
                        </div>`;
            }).join('');
        }

        // *** UPDATED: renderCollectionList (Inventory) for 6 slots ***
        function renderCollectionList(type) {
             if (type !== 'equipment') return;

             const listContainer = document.getElementById('equipment-list');
             if (!listContainer) return; // Guard clause
             const ownedGear = gameData.gearInventory;
             const ownedItems = gameData.items; // Potions
             
             // Get all currently equipped item IDs
             const allEquippedIds = Object.values(gameData.equippedSlots); 
             
             const totalSlots = countInventorySlots();
             const slotCountEl = document.getElementById('inventory-slot-count');
             if (slotCountEl) slotCountEl.textContent = `Số ô: ${totalSlots}/${MAX_INVENTORY_SLOTS}`;

             let displayItems = [];
             // Get all gear
             ownedGear.forEach(item => {
                 displayItems.push({ ...item, isItem: false });
             });
             // Get all potions/consumables
             Object.keys(ownedItems).filter(id => STATIC_ITEM_DB[id] && STATIC_ITEM_DB[id].type === 'potion' && ownedItems[id] > 0).forEach(id => {
                 displayItems.push({ id, ...STATIC_ITEM_DB[id], count: ownedItems[id], isItem: true });
             });

             // Sort: Equipped first, then items, then by quality/level
             displayItems.sort((a, b) => {
                 const equippedA = !a.isItem && allEquippedIds.includes(a.uniqueId) ? -1 : 0; 
                 const equippedB = !b.isItem && allEquippedIds.includes(b.uniqueId) ? -1 : 0;
                 if (equippedA !== equippedB) return equippedA - equippedB;
                 
                 const itemA = a.isItem ? 1 : 0; const itemB = b.isItem ? 1 : 0;
                 if (itemA !== itemB) return itemA - itemB;
                 
                 if (!a.isItem && !b.isItem) {
                     // Sort by quality (Highest first)
                     const qualityA = Object.keys(QUALITY_DB).indexOf(a.quality);
                     const qualityB = Object.keys(QUALITY_DB).indexOf(b.quality);
                     if (qualityB !== qualityA) return qualityB - qualityA;
                     // Then by level (Highest first)
                     return (b.level || 0) - (a.level || 0);
                 } else if (a.isItem && b.isItem) { 
                     return (b.rarity || 0) - (a.rarity || 0); 
                 }
                 return 0;
             });

            if (displayItems.length === 0) { 
                listContainer.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center h-64 text-gray-500">
                    <i class="fa-solid fa-box-open text-6xl mb-4 opacity-50"></i>
                    <p>Hành trang trống rỗng.</p>
                </div>`; 
                return; 
            }

            // Use a more responsive grid class if not already set in HTML
            listContainer.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-2";

            listContainer.innerHTML = displayItems.map(item => {
                 let itemHTML = '';
                 let isEquipped = false;
                 let tooltipId = '';
                 let cardClass = '';
                 let iconHtml = '';
                 
                 // --- Render Equipment ---
                 if (!item.isItem) {
                     const quality = QUALITY_DB[item.quality];
                     isEquipped = allEquippedIds.includes(item.uniqueId);
                     tooltipId = item.uniqueId;
                     const upgradeText = item.upgradeLevel > 0 ? ` <span class="text-yellow-300 text-xs font-bold">[+${item.upgradeLevel}]</span>` : '';
                     
                     // Determine Icon based on type
                     let iconClass = 'fa-sack';
                     if (item.type === 'weapon') iconClass = 'fa-khanda';
                     else if (item.type === 'armor') iconClass = 'fa-shirt';
                     else if (item.type === 'accessory') iconClass = 'fa-ring';

                     // Styling based on quality
                     // [MODIFIED] Logic áp dụng Class cho Siêu Thần - Đảm bảo không bị null
                     if (item.quality === 'supergodly') {
                         // Áp dụng class đặc biệt
                         cardClass = 'bg-quality-supergodly';
                         
                         // Nếu đang trang bị, thêm viền xanh (dùng ring để không ghi đè border vàng của class)
                         if (isEquipped) {
                             cardClass += ' ring-2 ring-green-500 ring-offset-1 ring-offset-gray-900';
                         }
                     } else {
                         // Logic cũ cho các phẩm chất khác
                         let borderClass = 'border-gray-600';
                         let bgGradient = 'from-gray-800 to-gray-900';
                         let glowClass = '';

                         if (item.quality === 'mythic') { borderClass = 'border-red-500'; bgGradient = 'from-red-900/40 to-black'; glowClass = 'shadow-[0_0_8px_rgba(239,68,68,0.3)]'; }
                         else if (item.quality === 'epic') { borderClass = 'border-orange-500'; bgGradient = 'from-orange-900/40 to-black'; }
                         else if (item.quality === 'legendary') { borderClass = 'border-yellow-500'; bgGradient = 'from-yellow-900/40 to-black'; }
                         else if (item.quality === 'rare') { borderClass = 'border-purple-500'; bgGradient = 'from-purple-900/40 to-black'; }
                         else if (item.quality === 'uncommon') { borderClass = 'border-blue-500'; bgGradient = 'from-blue-900/40 to-black'; }

                         if (isEquipped) {
                             borderClass = 'border-green-500';
                             glowClass = 'shadow-[0_0_10px_rgba(34,197,94,0.4)] ring-1 ring-green-500/50';
                         }
                         // Mặc định dùng gradient
                         cardClass = `bg-gradient-to-br ${bgGradient} border ${borderClass} ${glowClass}`;
                     }
                     
                     // Stats rendering
                     const statsHtml = item.affixes.map(affix => {
                        let colorClass = 'text-gray-400';
                        let icon = '<i class="fa-solid fa-caret-right text-[8px] mr-1 opacity-50"></i>';
                        if (affix.isEnchant) {
                            colorClass = affix.rarityClass || 'text-green-400';
                            icon = '<i class="fa-solid fa-wand-magic-sparkles text-[8px] mr-1 text-green-400"></i>';
                        }
                        return `<div class="flex items-center justify-between text-[11px] ${colorClass}">
                                    <span>${icon}${affix.name}</span>
                                    <span class="font-mono font-bold">${affix.isPercent ? `+${affix.value}%` : `+${affix.value}`}</span>
                                </div>`;
                     }).join('');

                     // [MODIFIED] Thêm z-index: 10 cho nội dung để nổi lên trên hiệu ứng nền
                     itemHTML = `
                        <div class="flex items-start gap-3 mb-3 pb-2 border-b border-gray-700/50 relative z-10">
                            <div class="w-12 h-12 rounded bg-black/40 flex items-center justify-center border border-gray-600 flex-shrink-0 shadow-inner">
                                <i class="fa-solid ${iconClass} text-2xl ${quality.className}"></i>
                            </div>
                            <div class="min-w-0 flex-grow">
                                <div class="flex justify-between items-start">
                                    <!-- [MODIFIED] Removed 'truncate', added 'break-words' to allow full name display -->
                                    <h5 class="font-bold text-sm ${quality.className} break-words leading-tight mr-1">${item.name}</h5>
                                    ${isEquipped ? '<i class="fa-solid fa-shield-halved text-green-500 text-xs ml-1 flex-shrink-0 mt-1" title="Đang trang bị"></i>' : ''}
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-[10px] text-gray-500 border border-gray-600 rounded px-1.5 bg-black/20">Cấp ${item.level}</span>
                                    ${upgradeText}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-grow space-y-0.5 mb-3 relative z-10">
                            ${statsHtml}
                        </div>

                        <div class="mt-auto relative z-10">
                            ${isEquipped ? 
                                `<button onclick="unequipItem('${Object.keys(gameData.equippedSlots).find(key => gameData.equippedSlots[key] === item.uniqueId)}')" class="w-full bg-red-900/80 hover:bg-red-800 text-red-200 border border-red-700/50 text-xs font-bold py-1.5 rounded transition">
                                    Gỡ Bỏ
                                </button>` : 
                                `<button onclick="equipItem('${item.uniqueId}')" class="w-full bg-blue-600/80 hover:bg-blue-500 text-white border border-blue-400/50 text-xs font-bold py-1.5 rounded transition shadow-lg shadow-blue-900/20">
                                    Trang Bị
                                </button>`
                            }
                        </div>
                     `;
                 }
                 // --- Render Items (Potions) ---
                 else {
                     // ... (Giữ nguyên logic potion) ...
                     tooltipId = item.id;
                     const rarityClass = getRarityClass(item.rarity);
                     let icon = item.icon || 'fa-flask'; // Fallback
                     
                     cardClass = `bg-gray-800 border border-gray-600 hover:border-gray-500`;

                     itemHTML = `
                        <div class="flex items-center gap-3 mb-3 relative z-10">
                            <div class="w-10 h-10 rounded bg-black/30 flex items-center justify-center border border-gray-600 flex-shrink-0">
                                <i class="fa-solid ${icon} text-xl ${rarityClass}"></i>
                            </div>
                            <div class="flex-grow min-w-0">
                                <p class="font-bold text-sm ${rarityClass} truncate">${item.name}</p>
                                <p class="text-xs text-gray-400 mt-0.5">Số lượng: <span class="text-white font-bold">${item.count.toLocaleString()}</span></p>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mb-3 line-clamp-2 h-8 leading-tight relative z-10">
                            ${item.desc || 'Vật phẩm tiêu hao.'}
                        </div>
                        <button onclick="useItem('${item.id}')" class="w-full mt-auto bg-green-700 hover:bg-green-600 text-white text-xs font-bold py-1.5 rounded border border-green-500/50 transition relative z-10">
                            Sử Dụng
                        </button>
                     `;
                 }
                 
                 // Create the wrapper div
                 // [MODIFIED] Added relative and z-0 to container to establish stacking context
                 return `
                 <div class="relative rounded-lg p-3 flex flex-col shadow-md hover:-translate-y-1 transition-all duration-200 ${cardClass}" style="z-index: 0;">
                    ${itemHTML}
                 </div>`;
                 
            }).join('');
        }

        function showDungeonInfo(mapId) {
            const mapData = DUNGEONS_DB[mapId];
             if (!mapData) { console.error("Map not found for info:", mapId); return; }
            document.getElementById('dungeon-info-title').textContent = `Thông Tin Bản Đồ: ${mapData.name}`;

            let content = `<p class="text-sm text-gray-300 mb-4">Quái vật: Cấp ${mapData.levelRange}</p>`;
            content += `<h4 class="font-bold text-lg mb-2 text-cyan-400">Phần Thưởng / Quái:</h4>`;
            content += `<p class="text-sm text-gray-300">Ngân Lượng: ${mapData.rewards.gold[0]} - ${mapData.rewards.gold[1]}</p>`;
            content += `<p class="text-sm text-gray-300 mb-4">Kinh Nghiệm: ${mapData.rewards.xp[0]} - ${mapData.rewards.xp[1]}</p>`;

             content += `<h4 class="font-bold text-lg mb-2 text-cyan-400">Quái Vật Có Thể Gặp:</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">`;
             const enemyIdsToShow = [...(mapData.enemies || [])];
             if (mapData.boss && !enemyIdsToShow.includes(mapData.boss)) enemyIdsToShow.push(mapData.boss);

             if (enemyIdsToShow.length > 0) {
                 enemyIdsToShow.forEach(enemyId => {
                     const enemyDB = ENEMIES_DB[enemyId];
                     if (enemyDB) {
                         const tierDisplay = enemyDB.tier ? `(${enemyDB.tier.charAt(0).toUpperCase() + enemyDB.tier.slice(1)})` : '';
                         content += `<div class="bg-gray-700 p-2 rounded">
                                        <p class="font-bold ${getRarityClass(enemyDB.rarity)}">${enemyDB.name} ${tierDisplay}</p>
                                        <p class="text-sm text-gray-400">Cấp ${enemyDB.level}</p>
                                     </div>`;
                     }
                 });
             } else { content += '<p class="text-gray-400 text-sm col-span-2">Chưa có thông tin quái vật.</p>'; }
             content += '</div>';

            content += `<h4 class="font-bold text-lg mb-2 text-cyan-400">Vật Phẩm Có Thể Rơi (Tỷ lệ ${mapData.rewards.equipChance * 100}%):</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-2">`;
             // *** REMOVED STATIC ITEM LIST ***
             content += '<p class="text-gray-400 text-sm col-span-2">Trang bị rơi ra ngẫu nhiên theo cấp độ bản đồ.</p>';
             
             // Show static drops (potions)
             const staticDrops = ['item_hp_small', 'item_mana_small']; // Example
             staticDrops.forEach(equipId => {
                 const equipDB = STATIC_ITEM_DB[equipId];
                 if (equipDB) {
                     content += `<div class="bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600" onclick="showItemDetail('item', '${equipId}')">
                                    <p class="font-bold ${getRarityClass(equipDB.rarity)}">${equipDB.name}</p>
                                    <p class="text-sm text-yellow-400">${getStars(equipDB.rarity)}</p>
                                </div>`;
                 }
             });
             
            content += '</div>';

            document.getElementById('dungeon-info-content').innerHTML = content;
            showModal('dungeon-info-modal');
        }
        
        function renderDungeonList() { // <-- [FIX] Thêm lại định nghĩa hàm bị thiếu
            const listContainer = document.getElementById('dungeon-list');
             let mapKeys = Object.keys(DUNGEONS_DB);
             
             // [MODIFIED] Filter out all special maps
             const specialMaps = new Set(['map_ngu_thon', 'map_to_chau', 'map_kinh_thanh', 'map_thuc_son', 'map_ngoc_hu', 'map_hu_thien', 'map_dai_ly', 'map_thap_nhi_cung', 'map_luc_dao', 'map_quan_long', 'map_tchh', 'map_ttdt', 'map_ptdc', 'map_vctp', 'map_tntg', 'map_tkdv']); 
             mapKeys = mapKeys.filter(id => !specialMaps.has(id)); 
             
             let maps = mapKeys.map(id => ({ id, ...DUNGEONS_DB[id] })); // <-- [FIX] Thêm lại dòng khởi tạo 'maps'

            maps.sort((a, b) => {
                const aUnlocked = gameData.unlockedDungeons.includes(a.id);
                const bUnlocked = gameData.unlockedDungeons.includes(b.id);
                if (aUnlocked && !bUnlocked) return -1;
                if (!aUnlocked && bUnlocked) return 1;
                return a.rarity - b.rarity; // Sort by rarity
            });
            
             listContainer.innerHTML = maps.map(mapData => {
                const isUnlocked = gameData.unlockedDungeons.includes(mapData.id);
                const isTrainingHere = gameData.isTraining && gameData.currentMapId === mapData.id;
                
                // [MODIFIED] Determine text color class, including Siêu Thần
                let mapNameColorClass = getRarityClass(mapData.rarity); 
                // ... (Giữ nguyên logic màu sắc map đặc biệt) ...
                if (mapData.id === 'map06') { 
                    mapNameColorClass = 'text-orange-400';
                } else if (mapData.id === 'map07' || mapData.id === 'map08' || mapData.id === 'map09') { 
                    mapNameColorClass = 'text-red-500'; 
                } else if (mapData.id === 'map_phonglangdo' || mapData.id === 'map_vuot_ai') { 
                    mapNameColorClass = 'text-rainbow-animation'; 
                } else if (mapData.id === 'map_dinh_phong_500') { 
                    mapNameColorClass = 'text-yellow-300 text-pulse-glow'; 
                } else if (mapData.id === 'map_vlmc_650') { 
                    mapNameColorClass = 'text-pulse-holy-glow'; 
                } else if (mapData.id === 'map_tanlang_750') { 
                    mapNameColorClass = 'text-pulse-jade-glow'; 
                } else if (mapData.id === 'map_cttd_850') { 
                    mapNameColorClass = 'text-pulse-violet-glow'; 
                } else if (mapData.id === 'map_ummu_950') { 
                    mapNameColorClass = 'text-pulse-abyss-glow'; 
                } else if (mapData.id === 'map_trutien_1150') { 
                    mapNameColorClass = 'text-pulse-divine-glow'; 
                } else if (mapData.id === 'map_luc_dao_350') { 
                } else if (mapData.id === 'map_thap_nhi_cung_400') { 
                    mapNameColorClass = 'text-pulse-orange-glow'; 
                } else if (mapData.id === 'map_phithanglo_1450') { 
                    mapNameColorClass = 'text-pulse-ascension-glow'; 
                } else if (mapData.id === 'map_cctk_1850') { 
                    mapNameColorClass = 'text-pulse-sky-glow'; 
                } else if (mapData.id === 'map_hdth_2200') { 
                    mapNameColorClass = 'text-rainbow-animation text-pulse-void-glow font-bold'; 
                } else if (mapData.id === 'map_tptk_2500') { 
                    mapNameColorClass = 'text-pulse-void-glow'; 
                } else if (mapData.id === 'map_taiji_realm') {
                    mapNameColorClass = 'text-rainbow-animation text-pulse-ascension-glow font-extrabold';
                } else if (mapData.id === 'map_void_forbidden') {
                    // [NEW] Style cho Hư Vô Cấm Địa
                    mapNameColorClass = 'text-rainbow-animation text-pulse-void-glow font-extrabold tracking-widest';
                } else if (mapData.id === 'map_dao_origin') {
                    // [NEW] Style cho Đạo Nguyên Thánh Cảnh
                    mapNameColorClass = 'text-rainbow-animation text-pulse-holy-glow font-black tracking-widest uppercase text-shadow-gold';
                } else if (mapData.id === 'map_hongmeng_realm') {
                    // [NEW] Style ĐẶC BIỆT cho Hồng Mông Tiên Cảnh: Gradient Tím-Hồng-Chàm + Shadow
                    mapNameColorClass = 'text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-500 via-purple-600 to-indigo-500 font-black text-xl tracking-widest uppercase filter drop-shadow-[0_0_8px_rgba(192,132,252,0.8)] animate-pulse';
                } else if (mapData.id === 'map_genesis_domain') {
                    // [NEW] Style ĐẶC BIỆT cho Sáng Thế Thần Vực: Divine Gold (Vàng - Trắng - Cam) + Glow
                    mapNameColorClass = 'text-transparent bg-clip-text bg-gradient-to-r from-orange-300 via-yellow-100 to-amber-400 font-black text-xl tracking-widest uppercase filter drop-shadow-[0_0_10px_rgba(251,191,36,0.8)] animate-pulse';
                } else if (mapData.id === 'map_heavenly_dao') {
                    // [NEW] Style ĐẶC BIỆT cho Thiên Đạo Vô Cực Giới: Heavenly Dao (Cyan - Blue - Purple) + Glow Cyan
                    mapNameColorClass = 'text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 font-black text-xl tracking-widest uppercase filter drop-shadow-[0_0_10px_rgba(34,211,238,0.8)] animate-pulse';
                } else if (mapData.id === 'map_eternal_ruler') {
                    // [NEW] Style ĐẶC BIỆT cho Chúa Tể Vĩnh Hằng Giới: Ultimate Destruction (Red - Black - Gold)
                    mapNameColorClass = 'text-ultimate-style';
                } else if (mapData.id === 'map_astral_path') {
                    // [NEW] Style ĐẶC BIỆT cho Tinh Hà Cổ Lộ: Astral (Blue - Purple - White)
                    mapNameColorClass = 'text-astral-style';
                } else if (mapData.id === 'map_primordial_chaos') {
                    // [NEW] Style ĐẶC BIỆT cho Nguyên Sơ Hỗn Mang: Chaos (Silver - Black - Multi)
                    mapNameColorClass = 'text-chaos-style';
                } else if (mapData.id === 'map_endless_samsara') {
                    // [NEW] Style ĐẶC BIỆT cho Vô Tận Luân Hồi: Samsara (Black - White - Gold)
                    mapNameColorClass = 'text-samsara-style';
                } else if (mapData.id === 'map_twilight_gods') {
                    // [NEW] Style ĐẶC BIỆT cho Chư Thần Hoàng Hôn: Twilight (Orange - Red - Black)
                    mapNameColorClass = 'text-twilight-style';
                } else if (mapData.id === 'map_era_of_destruction') {
                    // [NEW] Style ĐẶC BIỆT cho Kỷ Nguyên Hủy Diệt: Destruction (Black - Red - Grey) - Bỏ rung lắc
                    mapNameColorClass = 'text-destruction-style';
                } else if (mapData.id === 'map_primordial_saint') {
                    // [NEW] Style ĐẶC BIỆT cho Hỗn Nguyên Thánh Cảnh: Divine Truth (White - Gold - Cyan)
                    mapNameColorClass = 'text-divine-truth-style';
                } else if (mapData.id === 'map_ancient_void') {
                    // [NEW] Style ĐẶC BIỆT cho Thái Hư Cổ Giới: Ancient Void (Silver - Black - Grey)
                    mapNameColorClass = 'text-ancient-void-style';
                } else if (mapData.id === 'map_ultimate_dao') {
                    // [NEW] Style ĐẶC BIỆT cho Cực Đạo Chung Yên: Ultimate Dao (Gold - Black - White)
                    mapNameColorClass = 'text-ultimate-dao-style';
                } else if (mapData.id === 'map_eternal_truth') {
                    // [NEW] Style ĐẶC BIỆT cho Vĩnh Hằng Chân Giới: Eternal Truth (Platinum - Gold - Cyan)
                    mapNameColorClass = 'text-eternal-truth-style';
                } else if (mapData.id === 'map_destroy_god_realm') {
                    // [NEW] Style ĐẶC BIỆT cho Thần Vực Hủy Diệt: Destroy God (Red - Black - Silver)
                    mapNameColorClass = 'text-destroy-god-style';
                } else if (mapData.id === 'map_multiverse_peak') {
                    // [NEW] Style ĐẶC BIỆT cho Đa Vũ Trụ Chi Đỉnh: Singularity (Black - Indigo - White)
                    mapNameColorClass = 'text-singularity-style';
                } else if (mapData.id === 'map_nirvana_void') {
                    // [NEW] Style ĐẶC BIỆT cho Bỉ Ngạn Hư Vô: Nirvana (White - Cyan - Platinum)
                    mapNameColorClass = 'text-nirvana-style';
                } else if (mapData.id === 'map_infinite_saint') {
                    // [NEW] Style ĐẶC BIỆT cho Thánh Vực Vô Cực: Infinite (White - Silver - Black)
                    mapNameColorClass = 'text-infinite-style';
                } else if (mapData.id === 'map_origin_god_realm') {
                    // [NEW] Style ĐẶC BIỆT cho Thần Giới Khởi Nguyên: Origin God (Gold - White - Platinum)
                    mapNameColorClass = 'text-origin-god-style';
                } else if (mapData.id === 'map_great_dao_peak') {
                    // [NEW] Style ĐẶC BIỆT cho Đại Đạo Chi Đỉnh: Great Dao (Platinum - Diamond - Rainbow)
                    mapNameColorClass = 'text-great-dao-style';
                } else if (mapData.id === 'map_origin_source') {
                    // [NEW] Style ĐẶC BIỆT cho Bản Nguyên Giới: Origin Source (Black - Deep Purple - Core White)
                    mapNameColorClass = 'text-origin-source-style';
                } else if (mapData.id === 'map_absolute_truth') {
                    // [NEW] Style ĐẶC BIỆT cho Chân Lý Tối Thượng: Absolute Truth (Deep Blue - Cyan - Gold)
                    mapNameColorClass = 'text-absolute-truth-style';
                } else if (mapData.id === 'map_outer_void') {
                    // [NEW] Style ĐẶC BIỆT cho Thiên Ngoại Hư Không: Outer Void (Black - Dark Blue - White)
                    mapNameColorClass = 'text-outer-void-style';
                } else if (mapData.id === 'map_eternal_genesis') {
                    // [NEW] Style ĐẶC BIỆT cho Hồng Mông Khởi Nguyên: Eternal Genesis (Platinum - Gold - Rainbow)
                    mapNameColorClass = 'text-genesis-style';
                } else if (mapData.id === 'map_eternal_antiquity') {
                    // [NEW] Style ĐẶC BIỆT cho Vạn Cổ Bất Diệt: Eternal Antiquity (Stone - Gold - Time Blue)
                    mapNameColorClass = 'text-eternal-antiquity-style';
                } else if (mapData.id === 'map_ultimate_end') {
                    // [NEW] Style ĐẶC BIỆT cho Thiên Địa Chung Cực: Omega (Black - White - Violet)
                    mapNameColorClass = 'text-omega-style';
                } else if (mapData.id === 'map_supreme_chaos') {
                    // [NEW] Style ĐẶC BIỆT cho Hỗn Độn Vô Thượng: Supreme Chaos (Purple - Red - Black)
                    mapNameColorClass = 'text-supreme-chaos-style';
                } else if (mapData.id === 'map_true_self') {
                    // [NEW] Style ĐẶC BIỆT cho Chân Ngã Độc Tôn: True Self (White - Light Purple - Ice Blue)
                    mapNameColorClass = 'text-true-self-style';
                } else if (mapData.id === 'map_eternal_samsara') {
                    // [NEW] Style ĐẶC BIỆT cho Vạn Kiếp Luân Hồi: Endless Samsara (Gold - Dark Red - Black)
                    mapNameColorClass = 'text-endless-samsara-style';
                } else if (mapData.id === 'map_absolute_null') {
                    // [NEW] Style ĐẶC BIỆT cho Chân Không Tuyệt Đối: Absolute Null (Black/White Glitch)
                    mapNameColorClass = 'text-absolute-null-style';
                } else if (mapData.id === 'map_endless_origin') {
                    // [NEW] Style ĐẶC BIỆT cho Vô Tận Chi Nguyên: Endless Origin (White - Cyan - Pink)
                    mapNameColorClass = 'text-endless-origin-style';
                } else if (mapData.id === 'map_infinite_true_realm') {
                    // [NEW] Style ĐẶC BIỆT cho Vô Cực Chân Giới: Supreme Void (Black - Indigo - White Core)
                    mapNameColorClass = 'text-supreme-void-style';
                } else if (mapData.id === 'map_mythical_era') {
                    // [NEW] Style ĐẶC BIỆT cho Thần Thoại Kỷ Nguyên: Mythical Era (Gold - Red - Purple)
                    mapNameColorClass = 'text-mythical-era-style';
                } else if (mapData.id === 'map_supreme_god') {
                    // [NEW] Style ĐẶC BIỆT cho Chí Tôn Vô Thượng: Supreme God (Gold - Red - Platinum)
                    mapNameColorClass = 'text-supreme-god-style';
                }

                if (mapData.id !== 'map_phonglangdo' && mapData.id !== 'map01' && mapData.id !== 'map_vuot_ai' && mapData.id !== 'map_dinh_phong_500' && mapData.id !== 'map_vlmc_650' && mapData.id !== 'map_tanlang_750' && mapData.id !== 'map_cttd_850' && mapData.id !== 'map_ummu_950' && mapData.id !== 'map_trutien_1150' && mapData.id !== 'map_luc_dao_350' && mapData.id !== 'map_thap_nhi_cung_400' && mapData.id !== 'map_phithanglo_1450' && mapData.id !== 'map_cctk_1850' && mapData.id !== 'map_hdth_2200' && mapData.id !== 'map_tptk_2500' && mapData.id !== 'map_taiji_realm' && mapData.id !== 'map_void_forbidden' && mapData.id !== 'map_dao_origin' && mapData.id !== 'map_hongmeng_realm' && mapData.id !== 'map_genesis_domain' && mapData.id !== 'map_heavenly_dao' && mapData.id !== 'map_eternal_ruler' && mapData.id !== 'map_astral_path' && mapData.id !== 'map_primordial_chaos' && mapData.id !== 'map_endless_samsara' && mapData.id !== 'map_twilight_gods' && mapData.id !== 'map_era_of_destruction' && mapData.id !== 'map_primordial_saint' && mapData.id !== 'map_ancient_void' && mapData.id !== 'map_ultimate_dao' && mapData.id !== 'map_eternal_truth' && mapData.id !== 'map_destroy_god_realm' && mapData.id !== 'map_multiverse_peak' && mapData.id !== 'map_nirvana_void' && mapData.id !== 'map_infinite_saint' && mapData.id !== 'map_origin_god_realm' && mapData.id !== 'map_great_dao_peak' && mapData.id !== 'map_origin_source' && mapData.id !== 'map_absolute_truth' && mapData.id !== 'map_outer_void' && mapData.id !== 'map_eternal_genesis' && mapData.id !== 'map_eternal_antiquity' && mapData.id !== 'map_ultimate_end' && mapData.id !== 'map_supreme_chaos' && mapData.id !== 'map_true_self' && mapData.id !== 'map_eternal_samsara' && mapData.id !== 'map_absolute_null' && mapData.id !== 'map_endless_origin' && mapData.id !== 'map_infinite_true_realm' && mapData.id !== 'map_mythical_era' && mapData.id !== 'map_supreme_god') { 
                    mapNameColorClass += ' text-sparkle';
                }

                let buttonHTML = '';
                if (isTrainingHere) {
                    buttonHTML = `<span class="text-sm font-bold text-yellow-400 px-3 py-2 rounded-full bg-gray-800">Đang Luyện...</span>`;
                } else if (isUnlocked) {
                    buttonHTML = `<button onclick="confirmAdventure('${mapData.id}')" class="text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" ${gameData.isTraining ? 'disabled' : ''}>Luyện Công</button>`;
                } else {
                     // [NEW] Logic hiển thị nút Mở hoặc Khóa theo Trùng Sinh
                     if (mapData.rebirthReq && (gameData.rebirthCount || 0) < mapData.rebirthReq) {
                         buttonHTML = `<button class="text-sm bg-gray-800 text-gray-500 font-bold py-2 px-4 rounded border border-gray-600 cursor-not-allowed opacity-70" disabled><i class="fa-solid fa-lock mr-1"></i>Cần TS ${mapData.rebirthReq}</button>`;
                     } else {
                         // [MODIFIED] Hiển thị "Miễn Phí" nếu cost = 0
                         const costDisplay = mapData.unlockCost > 0 ? `(${mapData.unlockCost.toLocaleString()} NL)` : '(Miễn Phí)';
                         buttonHTML = `<button onclick="unlockDungeon('${mapData.id}')" class="text-sm bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Mở ${costDisplay}</button>`; 
                     }
                }

                return `<div class="bg-black/30 backdrop-blur-sm border border-gray-700 rounded-lg p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 ${!isUnlocked ? 'opacity-60' : ''} ${gameData.isTraining && !isTrainingHere ? 'opacity-40' : ''}">
                            <div class="mb-2 sm:mb-0 cursor-pointer" onclick="showDungeonInfo('${mapData.id}')">
                                <p class="font-bold text-base sm:text-lg ${mapNameColorClass} hover:underline">${mapData.name}</p>
                                <p class="text-xs sm:text-sm text-yellow-400">${getStars(mapData.rarity)}</p>
                                <p class="text-xs sm:text-sm text-gray-300">Quái vật: ${mapData.levelRange}</p>
                            </div>
                            <div class="self-end sm:self-center">
                                ${buttonHTML}
                            </div>
                        </div>`;
            }).join('');
        }
        
        function renderModalContent(modalId) {
            try {
                switch(modalId) {
                    case 'skills-modal': 
                        // [NEW] Update sieu viet points display regardless of tab
                        // [FIX] Added null check
                        const svPointsEl = document.getElementById('sieu-viet-points');
                        if (svPointsEl) {
                            svPointsEl.textContent = gameData.sieuVietPoints || 0;
                        }
                        // [MODIFIED] Default to the first tab
                        switchSkillTab('mon-phai');
                        renderSkillTree(); 
                        break;
                    case 'equipment-modal': if (document.getElementById('equipment-list')) renderCollectionList('equipment'); break;
                    case 'dungeons-modal': if (document.getElementById('dungeon-list')) renderDungeonList(); break;
                    case 'tien-trang-modal': 
                        // [MODIFIED] Cập nhật hiển thị cả NL và KNB khi mở modal
                        const nlEl = document.getElementById('tien-trang-nl');
                        if(nlEl) nlEl.textContent = gameData.nganLuong.toLocaleString(); 
                        
                        const knbEl = document.getElementById('tien-trang-knb');
                        if(knbEl) knbEl.textContent = gameData.kimNguyenBao.toLocaleString();

                        // [FIXED] Cập nhật hiển thị Thần Cách khi mở Tiền Trang
                        const tcEl = document.getElementById('tien-trang-thancach-display');
                        if(tcEl) tcEl.textContent = (gameData.thanCach || 0).toLocaleString();

                        // [NEW] Reset to default tab and render sell lists
                        switchTienTrangTab('exchange'); // Default to exchange tab
                        renderBuyList(); // NEW: Pre-render buy list
                        renderBuyScrollList(); // [NEW] Render scroll list
                        renderBuyEquipmentList(); // NEW: Pre-render buy equip list
                        renderSellList(); // Pre-render gear sell list
                        renderMaterialSellList(); // NEW: Pre-render material sell list
                        renderItemExchangeList(); // NEW: Pre-render exchange list
                        break;
                    // [NEW] Case for Tho Ren
                    case 'tho-ren-modal':
                        selectedUpgradeItemId = null; // Reset selection
                        switchThoRenTab('cuong-hoa'); // Default to upgrade tab
                        renderUpgradePanel();
                        renderCraftingList();
                        renderTinhPhachPanel(); // [NEW] Render Tinh Phach tab
                        break;
                    // [NEW] Case for Tong Mon (Đã sửa đổi)
                    case 'tong-mon-modal':
                        // [NEW] Kiểm tra Cấp độ 40
                        const mainPanel = document.getElementById('main-sect-panel');
                        const titleEl = document.getElementById('tong-mon-title');
                        const contentDiv = document.getElementById('tong-mon-content');

                        if (gameData.player.level < 40) {
                            // Ẩn Panel chính
                            if (mainPanel) mainPanel.classList.add('hidden');
                            
                            // Cập nhật tiêu đề
                            if (titleEl) titleEl.textContent = "Tông Môn (Chưa mở)";
                            
                            // Tạo hoặc hiển thị thông báo khóa
                            let lockMsg = document.getElementById('sect-lock-message');
                            if (!lockMsg) {
                                lockMsg = document.createElement('div');
                                lockMsg.id = 'sect-lock-message';
                                lockMsg.className = 'flex flex-col items-center justify-center h-96 text-center animate-fade-in';
                                lockMsg.innerHTML = `
                                    <div class="bg-gray-800/80 p-8 rounded-xl border border-red-900/50 shadow-2xl backdrop-blur-sm max-w-sm">
                                        <div class="w-20 h-20 bg-gray-900 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-red-500/30">
                                            <i class="fa-solid fa-lock text-4xl text-red-500 animate-pulse"></i>
                                        </div>
                                        <h4 class="text-2xl font-bold text-gray-200 mb-2">Chức Năng Bị Khóa</h4>
                                        <p class="text-gray-400 text-sm mb-4">Cần đạt <span class="text-yellow-400 font-bold text-lg">Cấp 40</span> để khai tông lập phái.</p>
                                        <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                            <div class="bg-red-500 h-full" style="width: ${(gameData.player.level / 40) * 100}%"></div>
                                        </div>
                                        <p class="text-[10px] text-gray-500 mt-1">Tiến độ: ${gameData.player.level}/40</p>
                                    </div>
                                `;
                                if (contentDiv) contentDiv.appendChild(lockMsg);
                            }
                            lockMsg.classList.remove('hidden');
                            return; // Dừng xử lý
                        }

                        // Nếu đủ cấp: Ẩn thông báo khóa (nếu có) và hiện panel chính
                        const lockMsg = document.getElementById('sect-lock-message');
                        if (lockMsg) lockMsg.classList.add('hidden');

                        // [MODIFIED] Bỏ qua bước thành lập, đi thẳng vào tab Bồi Dưỡng
                        
                        mainPanel?.classList.remove('hidden'); // Đảm bảo main panel hiện
                        document.getElementById('found-sect-panel')?.classList.add('hidden'); // Ẩn panel thành lập
                        
                        if (titleEl) {
                            // [MODIFIED] Áp dụng class hiệu ứng mới cho tên Tông Môn
                            // titleEl.textContent = gameData.sect.name; // Cũ
                            titleEl.innerHTML = `<span class="sect-name-ultimate">${gameData.sect.name}</span>`;
                        } 
                        
                        // [MODIFIED] Mặc định mở tab Bồi Dưỡng
                        switchTongMonTab('boi-duong'); 
                        renderDiscipleList(); // Render danh sách
                        break;
                    // [NEW] Case for Mon Phai Selection
                    case 'mon-phai-modal':
                        renderMonPhaiList();
                        break;
                    <!-- [NEW] Case for Vong Quay -->
                    case 'vong-quay-modal':
                        renderVongQuayModal();
                        break;
                    // [NEW] Case for World Map
                    case 'world-map-modal':
                        // No dynamic content, just shows
                        break;
                    // [NEW] Case for Changelog/About
                    case 'changelog-modal':
                        // No dynamic content
                        break;
                    case 'about-modal':
                        // No dynamic content
                        break;
                    // [NEW] Case for Khe Nut Thoi Khong
                    case 'khe-nut-thoi-khong-modal':
                        renderKheNutList(); // New function to be created
                        break;
                    // [NEW] Add cases for Dau La Dai Luc
            case 'dauladailuc-modal':
                renderDauLaDaiLucModal();
                break;
            // [NEW] Add case for Tu Chan Gioi
            case 'tuchangioi-modal':
                renderTuChanGioiModal();
                break;
            // [NEW] Add case for Kiem The Gioi
            case 'kiemthe-modal':
                renderKiemTheModal();
                break;
            case 'turn-based-combat-modal':
                        // This modal is usually rendered by startTurnBasedCombat()
                        // But we can add a refresh just in case
                        renderTurnBasedCombatUI();
                        break;
            // [NEW] Add case for Menh Cach
            case 'menh-cach-modal':
                // [NEW] Kiểm tra Yêu cầu Cấp 60
                if (gameData.player.level < 60) {
                    // 1. Ẩn Tabs
                    const tabHeaders = document.querySelector('#menh-cach-modal .flex.border-b');
                    if(tabHeaders) tabHeaders.classList.add('hidden');
                    
                    // 2. Ẩn Panels nội dung
                    document.getElementById('panel-menh-ban').classList.add('hidden');
                    document.getElementById('panel-chieu-menh').classList.add('hidden');

                    // 3. Hiển thị thông báo khóa (Tạo nếu chưa có)
                    let lockMsg = document.getElementById('menh-cach-lock-msg');
                    if (!lockMsg) {
                        const modalBody = document.querySelector('#menh-cach-modal .modal');
                        lockMsg = document.createElement('div');
                        lockMsg.id = 'menh-cach-lock-msg';
                        lockMsg.className = 'flex flex-col items-center justify-center flex-grow p-10 text-center animate-fade-in';
                        lockMsg.innerHTML = `
                            <div class="bg-gray-800/80 p-8 rounded-xl border border-teal-500/50 shadow-2xl backdrop-blur-sm max-w-sm">
                                <div class="w-20 h-20 bg-gray-900 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-teal-500/30">
                                    <i class="fa-solid fa-lock text-4xl text-teal-500 animate-pulse"></i>
                                </div>
                                <h4 class="text-2xl font-bold text-gray-200 mb-2">Chức Năng Bị Khóa</h4>
                                <p class="text-gray-400 text-sm mb-4">Cần đạt <span class="text-yellow-400 font-bold text-lg">Cấp 60</span> để khai mở Mệnh Cách.</p>
                                <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                    <div class="bg-teal-500 h-full" style="width: ${(gameData.player.level / 60) * 100}%"></div>
                                </div>
                                <p class="text-[10px] text-gray-500 mt-1">Tiến độ: ${gameData.player.level}/60</p>
                            </div>
                        `;
                        // Chèn vào trước Footer
                        const footer = modalBody.querySelector('.bg-gray-900.rounded-b-lg');
                        if(footer) modalBody.insertBefore(lockMsg, footer);
                    }
                    lockMsg.classList.remove('hidden');
                    return; // Dừng xử lý render tiếp theo
                } else {
                    // Nếu đủ cấp: Ẩn thông báo khóa, hiện lại Tabs
                    const lockMsg = document.getElementById('menh-cach-lock-msg');
                    if(lockMsg) lockMsg.classList.add('hidden');
                    
                    const tabHeaders = document.querySelector('#menh-cach-modal .flex.border-b');
                    if(tabHeaders) tabHeaders.classList.remove('hidden');
                }

                // [NEW] Default to first tab
                switchMenhCachTab('menh-ban');
                renderChieuMenhPanel(); // [NEW] Cập nhật UI tab Liệp Mệnh
                renderMenhBanPanel(); // [NEW] Render Mệnh Bàn và Kho
                renderSummonHistoryLog(); // [NEW] Render lịch sử
                break;
            // [NEW] Add case for Sung Vat
            case 'sung-vat-modal':
                // [NEW] Kiểm tra Yêu cầu Cấp 30
                if (gameData.player.level < 30) {
                    const contentDiv = document.querySelector('#sung-vat-modal .overflow-y-auto');
                    if (contentDiv) {
                        contentDiv.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-center animate-fade-in col-span-3 min-h-[300px]">
                            <div class="bg-gray-800/80 p-8 rounded-xl border border-cyan-500/50 shadow-2xl backdrop-blur-sm max-w-sm">
                                <div class="w-20 h-20 bg-gray-900 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-cyan-500/30">
                                    <i class="fa-solid fa-lock text-4xl text-cyan-500 animate-pulse"></i>
                                </div>
                                <h4 class="text-2xl font-bold text-gray-200 mb-2">Chức Năng Bị Khóa</h4>
                                <p class="text-gray-400 text-sm mb-4">Cần đạt <span class="text-yellow-400 font-bold text-lg">Cấp 30</span> để mở Sủng Vật.</p>
                                <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                                    <div class="bg-cyan-500 h-full" style="width: ${(gameData.player.level / 30) * 100}%"></div>
                                </div>
                                <p class="text-[10px] text-gray-500 mt-1">Tiến độ: ${gameData.player.level}/30</p>
                            </div>
                        </div>`;
                    }
                    return;
                }
                
                renderSungVatModal();
                break;
            // [NEW] Case for About
            case 'about-modal':
                // No dynamic content
                break;
                // [FIX] Đã thêm các dấu ngoặc và khối catch còn thiếu để đóng hàm
                }
            } catch (error) {
                console.error(`Error rendering modal content for ${modalId}:`, error);
            }
        }
        
        // [NEW] --- Skill Tab Switching ---
        function switchSkillTab(tabId) {
            const modal = document.getElementById('skills-modal');
            if (!modal) return;
            
            modal.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'text-yellow-400', 'border-b-2', 'border-yellow-400'); // [MODIFIED] Xóa border active cũ nếu có
                btn.classList.add('text-gray-400');
            });
            
            const panel = document.getElementById(`panel-${tabId}`);
            const tab = document.getElementById(`tab-${tabId}`);
            
            if (panel) panel.classList.remove('hidden');
            if (tab) {
                tab.classList.add('tab-active', 'text-yellow-400'); 
                tab.classList.remove('text-gray-400');
            }
            
            if (tabId === 'mon-phai') {
                renderSkillTree(); 
            } else if (tabId === 'hon-ky') { 
                renderHonKyPanel();
            } else if (tabId === 'sieu-viet') {
                const svPointsEl = document.getElementById('sieu-viet-points');
                if (svPointsEl) {
                    svPointsEl.textContent = gameData.sieuVietPoints || 0; 
                }
                renderSieuVietPanel(); 
            } else if (tabId === 'tiem-nang') { 
                renderTiemNangPanel();
            } else if (tabId === 'ky-nang-song') { // [NEW] Xử lý tab Kỹ Năng Sống
                renderIdlePanels(); // Cập nhật hiển thị của các panel con
            }
        }
        
        // [NEW] Render Tiem Nang Panel (4 Ô Chỉ Số)
        function renderTiemNangPanel() {
            const panel = document.getElementById('panel-tiem-nang');
            if (!panel) return;

            // Khởi tạo data nếu chưa có
            if (!gameData.player.allocatedStats) {
                gameData.player.allocatedStats = { suc_manh: 0, than_phap: 0, sinh_khi: 0, hon_luc: 0 };
            }
            if (gameData.player.potentialPoints === undefined) {
                gameData.player.potentialPoints = 0;
            }

            const availablePoints = gameData.player.potentialPoints;
            const allocated = gameData.player.allocatedStats;

            // Cấu hình 4 loại tiềm năng
            const potentials = [
                { id: 'suc_manh', name: 'Sức Mạnh', icon: 'fa-solid fa-hand-fist', color: 'text-red-500', desc: '1 điểm = +2 Công Kích.' },
                { id: 'than_phap', name: 'Thân Pháp', icon: 'fa-solid fa-wind', color: 'text-green-500', desc: '1 điểm = +2 Tốc Độ (Thân Pháp).' },
                { id: 'sinh_khi', name: 'Sinh Khí', icon: 'fa-solid fa-heart-pulse', color: 'text-pink-500', desc: '1 điểm = +20 Sinh Lực.' },
                { id: 'hon_luc', name: 'Hồn Lực', icon: 'fa-solid fa-ghost', color: 'text-purple-500', desc: '1 điểm = +10 Hồn Lực & +10 Nội Lực.' }
            ];

            let html = `
                <div class="text-center mb-6">
                    <h4 class="text-xl font-bold text-cyan-400 uppercase tracking-widest mb-2">Tiềm Năng Nhân Vật</h4>
                    <div class="inline-block bg-gray-800 px-4 py-2 rounded-full border border-yellow-600/50 shadow-lg">
                        <p class="text-sm text-gray-300">Điểm Tiềm Năng: <span class="text-yellow-400 font-bold text-xl ml-2 animate-pulse">${availablePoints}</span></p>
                    </div>
                    <p class="text-[10px] text-gray-500 italic mt-2">Lên cấp nhận 5 điểm.</p>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            `;

            potentials.forEach(p => {
                const currentValue = allocated[p.id] || 0;
                const canAdd = availablePoints > 0;

                html += `
                <div class="bg-gray-800/80 border border-gray-700 p-4 rounded-xl flex flex-col items-center text-center shadow-lg relative overflow-hidden group hover:border-gray-500 transition duration-300">
                    <!-- Background glow -->
                    <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                    
                    <div class="w-14 h-14 rounded-full bg-gray-900 border border-gray-600 flex items-center justify-center mb-3 shadow-inner relative z-10">
                        <i class="${p.icon} ${p.color} text-2xl"></i>
                    </div>
                    
                    <h5 class="font-bold text-gray-200 text-lg mb-1 relative z-10">${p.name}</h5>
                    <p class="text-xs text-gray-400 mb-4 h-4 relative z-10">${p.desc}</p>
                    
                    <!-- Input Controls -->
                    <div class="flex items-center justify-center gap-2 w-full mt-auto relative z-10 bg-black/30 p-2 rounded-lg border border-gray-700">
                        <span class="font-mono text-lg font-bold text-yellow-300 mr-auto pl-2">${currentValue}</span>
                        
                        <!-- Input Amount -->
                        <input type="number" id="player-pot-input-${p.id}" 
                               class="w-12 h-8 bg-gray-900 border border-gray-600 rounded text-center text-xs text-white focus:border-yellow-400 outline-none" 
                               value="1" min="1" max="${availablePoints > 0 ? availablePoints : 1}"
                               onfocus="this.select()" 
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                               
                        <!-- Max Button -->
                        <button onclick="document.getElementById('player-pot-input-${p.id}').value = ${availablePoints > 0 ? availablePoints : 1}" class="h-8 px-1 bg-gray-700 hover:bg-gray-600 text-[10px] text-yellow-300 rounded border border-gray-600 transition" title="Tối đa">MAX</button>

                        <button onclick="allocatePotential('${p.id}')" class="w-8 h-8 rounded ${canAdd ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-md' : 'bg-gray-700 text-gray-500 cursor-not-allowed opacity-50'} transition flex items-center justify-center active:scale-95" ${!canAdd ? 'disabled' : ''}>
                            <i class="fa-solid fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>
                `;
            });

            html += `</div>`;
            panel.innerHTML = html;
        }

        // [NEW] Hàm cộng điểm tiềm năng
        function allocatePotential(statId) {
            // [MODIFIED] Lấy giá trị từ input
            const inputEl = document.getElementById(`player-pot-input-${statId}`);
            let amount = 1;
            if (inputEl) {
                amount = parseInt(inputEl.value, 10);
                if (isNaN(amount) || amount < 1) amount = 1;
            }

            if (gameData.player.potentialPoints < amount) {
                if (gameData.player.potentialPoints > 0) {
                     amount = gameData.player.potentialPoints; // Cộng hết số còn lại
                     showToast(`Chỉ còn ${amount} điểm, đã cộng toàn bộ.`, true);
                } else {
                    showToast("Không đủ điểm tiềm năng!", false);
                    return;
                }
            }

            // Trừ điểm
            gameData.player.potentialPoints -= amount;
            
            // Cộng chỉ số
            if (!gameData.player.allocatedStats) gameData.player.allocatedStats = {};
            gameData.player.allocatedStats[statId] = (gameData.player.allocatedStats[statId] || 0) + amount;

            // [FIX] Cập nhật ngay lập tức chỉ số hiện tại (Current) để đồng bộ với Max vừa tăng
            if (statId === 'sinh_khi') {
                // Sinh Khí: Tăng 20 HP Max -> Hồi ngay 20 HP hiện tại * amount
                gameData.player.currentHp = (gameData.player.currentHp || 0) + (20 * amount); 
            } else if (statId === 'hon_luc') {
                // Hồn Lực: Tăng 10 Mana & 10 Hồn Lực Max -> Hồi ngay 10 Mana & 10 Hồn Lực hiện tại * amount
                gameData.player.currentMana = (gameData.player.currentMana || 0) + (10 * amount);
                gameData.player.honLuc = (gameData.player.honLuc || 0) + (10 * amount);
            }

            // Cập nhật UI
            renderTiemNangPanel();
            updateUI(); // Cập nhật chỉ số tổng lực chiến/HP/Mana ngay lập tức
        }

        // [NEW] Render Hon Ky Panel Content (Giao diện Hồn Kỹ - Võ Hồn Chân Thân)
        function renderHonKyPanel() {
            const panel = document.getElementById('panel-hon-ky');
            if (!panel) return;

            // Danh sách ID hồn kỹ đã học
            const unlocked = gameData.player.unlockedHonKy || [];
            const currentThanCach = gameData.thanCach || 0;
            
            let html = `
                <div class="text-center mb-6 bg-black/30 p-4 rounded-lg border border-purple-500/30 backdrop-blur-sm shadow-lg">
                    <h4 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 mb-2 uppercase tracking-widest filter drop-shadow-lg">Võ Hồn Chân Thân</h4>
                    <p class="text-xs text-gray-300 italic">"Dùng điểm <strong class="text-red-400">Thần Cách</strong> để khai mở sức mạnh tiềm ẩn của Võ Hồn."</p>
                    <div class="flex justify-center gap-4 mt-2">
                        <p class="text-xs text-gray-400">Đã lĩnh ngộ: <span class="text-yellow-300 font-bold">${unlocked.length}</span> / ${Object.keys(HON_KY_DB).length}</p>
                        <p class="text-xs text-gray-400">Thần Cách hiện có: <span class="text-red-400 font-bold text-lg">${currentThanCach.toLocaleString()}</span> <i class="fa-solid fa-sun text-red-500"></i></p>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">(Thần Cách có thể hợp thành tại Tiền Trang)</p>
                </div>
            `;

            html += `<div class="grid grid-cols-1 gap-4">`;

            // Lấy toàn bộ Hồn Kỹ trong DB để hiển thị
            const allSkills = Object.values(HON_KY_DB);
            
            // Sắp xếp: Đã mở lên đầu, sau đó theo levelReq
            allSkills.sort((a, b) => {
                const aUnlocked = unlocked.includes(a.id);
                const bUnlocked = unlocked.includes(b.id);
                if (aUnlocked && !bUnlocked) return -1;
                if (!aUnlocked && bUnlocked) return 1;
                return a.levelReq - b.levelReq;
            });
            
            if (allSkills.length === 0) {
                 html += `<p class="text-gray-500 text-center italic col-span-full">Chưa có dữ liệu Hồn Kỹ.</p>`;
            } else {
                allSkills.forEach(skill => {
                    const isUnlocked = unlocked.includes(skill.id);
                    const canAfford = currentThanCach >= skill.thanCachCost;
                    // [MODIFIED] Bỏ kiểm tra Level
                    // const isLevelEnough = gameData.player.level >= skill.levelReq; 
                    
                    // Style động dựa trên trạng thái khóa/mở
                    const cardBg = isUnlocked ? 'bg-gradient-to-r from-gray-800 to-gray-900' : 'bg-black/40 grayscale opacity-80';
                    const borderClass = isUnlocked ? 'border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.15)]' : 'border-gray-700 border-dashed';
                    const textColor = skill.color || 'text-white'; 
                    
                    // Hiệu ứng Hồn Hoàn (Vòng tròn quanh icon)
                    let ringColor = 'border-gray-600';
                    let ringGlow = '';
                    let ringAnim = '';
                    
                    if (isUnlocked) {
                        ringAnim = 'animate-pulse';
                        if (skill.color.includes('yellow-300')) { // Trăm năm (Vàng)
                            ringColor = 'border-yellow-400'; 
                            ringGlow = 'shadow-[0_0_5px_#facc15]'; 
                        } else if (skill.color.includes('purple')) { // Ngàn năm (Tím)
                            ringColor = 'border-purple-500'; 
                            ringGlow = 'shadow-[0_0_8px_#a855f7]'; 
                        } else if (skill.color.includes('gray-800') || skill.color.includes('gray-200')) { // Vạn năm (Đen)
                            ringColor = 'border-gray-900'; 
                            ringGlow = 'shadow-[0_0_5px_#000] border-4'; 
                        } else if (skill.color.includes('red')) { // 10 Vạn năm (Đỏ)
                            ringColor = 'border-red-600'; 
                            ringGlow = 'shadow-[0_0_15px_#dc2626]'; 
                        } else if (skill.color.includes('yellow-400') || skill.color.includes('rainbow')) { // Thần Cấp
                            ringColor = 'border-yellow-500';
                            ringGlow = 'shadow-[0_0_20px_#eab308]';
                        }
                    }

                    // Nút hành động
                    let actionBtn = '';
                    if (isUnlocked) {
                        actionBtn = `<div class="absolute top-2 right-2 text-green-500 text-xs font-bold pointer-events-none"><i class="fa-solid fa-check-circle mr-1"></i>Đã Lĩnh Ngộ</div>`;
                    } else {
                        // [MODIFIED] Luôn hiển thị nút Khai Mở (trừ khi không đủ tiền thì mờ đi)
                        actionBtn = `<button onclick="unlockHonKy('${skill.id}')" class="absolute top-2 right-2 bg-red-700 hover:bg-red-600 text-white text-xs font-bold px-3 py-1.5 rounded border border-red-500 shadow-md transition transform active:scale-95 ${!canAfford ? 'opacity-50 cursor-not-allowed' : 'animate-pulse'}" ${!canAfford ? 'disabled' : ''}>
                            Khai Mở (${skill.thanCachCost} <i class="fa-solid fa-sun text-[10px]"></i>)
                        </button>`;
                    }

                    html += `
                    <div class="${cardBg} border ${borderClass} p-3 sm:p-4 rounded-xl flex items-start gap-4 relative overflow-hidden group transition-all duration-300 hover:border-opacity-100">
                        ${actionBtn}
                        
                        <!-- Visual Hồn Hoàn -->
                        <div class="relative w-16 h-16 flex-shrink-0 flex items-center justify-center mt-1">
                            <!-- Vòng Hồn Hoàn -->
                            <div class="absolute inset-0 rounded-full border-[3px] ${ringColor} ${ringGlow} ${ringAnim} opacity-90"></div>
                            <!-- Icon -->
                            <i class="fa-solid fa-ring text-3xl ${isUnlocked ? textColor : 'text-gray-600'} relative z-10 filter drop-shadow-md"></i>
                            <!-- Cấp độ Hoàn -->
                            <div class="absolute -bottom-1 bg-black/80 text-[9px] px-1.5 rounded text-gray-300 border border-gray-600 z-20">Lv.${skill.levelReq}</div>
                        </div>
                        
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <h5 class="font-bold text-base sm:text-lg ${isUnlocked ? textColor : 'text-gray-500'} pr-24 leading-tight">${skill.name}</h5>
                            </div>
                            
                            <p class="text-xs sm:text-sm text-gray-300 mb-2 leading-relaxed pr-20">${skill.desc}</p>
                            
                            <!-- Info Tags -->
                            <div class="flex flex-wrap gap-2 text-[10px]">
                                <span class="bg-black/40 px-2 py-0.5 rounded text-blue-300 border border-blue-900/30 flex items-center">
                                    <i class="fa-solid fa-flask mr-1"></i>HL: <span class="font-bold ml-1 text-white">${skill.honLucCost}</span>
                                </span>
                                ${skill.type === 'attack' ? 
                                    `<span class="bg-black/40 px-2 py-0.5 rounded text-red-300 border border-red-900/30 flex items-center">
                                        <i class="fa-solid fa-khanda mr-1"></i>DMG: <span class="font-bold ml-1 text-white">${(skill.multiplier * 100).toFixed(0)}%</span>
                                    </span>` : 
                                    `<span class="bg-black/40 px-2 py-0.5 rounded text-green-300 border border-green-900/30 flex items-center">
                                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Hỗ Trợ
                                    </span>`
                                }
                            </div>
                        </div>
                    </div>
                    `;
                });
            }

            html += `</div>`;
            panel.innerHTML = html;
        }

        // [NEW] Hàm Mở Khóa Hồn Kỹ
        function unlockHonKy(skillId) {
            const skill = HON_KY_DB[skillId];
            if (!skill) return;

            // 1. Kiểm tra đã mở chưa
            if (gameData.player.unlockedHonKy.includes(skillId)) {
                showToast("Bạn đã lĩnh ngộ kỹ năng này rồi!", false);
                return;
            }

            // [MODIFIED] 2. Đã xóa kiểm tra Cấp độ
            /*
            if (gameData.player.level < skill.levelReq) {
                showToast(`Cần đạt Cấp ${skill.levelReq} để lĩnh ngộ!`, false);
                return;
            }
            */

            // 3. Kiểm tra Thần Cách
            const cost = skill.thanCachCost || 0;
            if ((gameData.thanCach || 0) < cost) {
                showToast(`Không đủ điểm Thần Cách! Cần ${cost}.`, false);
                return;
            }

            // 4. Thực hiện giao dịch
            gameData.thanCach -= cost;
            gameData.player.unlockedHonKy.push(skillId);
            
            // Sắp xếp lại danh sách kỹ năng (mạnh nhất lên đầu để combat tự chọn)
            gameData.player.unlockedHonKy.sort((a, b) => HON_KY_DB[b].levelReq - HON_KY_DB[a].levelReq);

            // 5. Hiệu ứng & Thông báo
            showToast(`Khai mở thành công [${skill.name}]!`, true);
            addSectLog(`Tông chủ đã dùng ${cost} Thần Cách để lĩnh ngộ tuyệt kỹ: ${skill.name}.`, 'reward');

            // 6. Cập nhật UI
            renderHonKyPanel();
            
            // Cập nhật hiển thị Thần Cách ở Tiền Trang nếu đang mở (dù ít khả năng mở cùng lúc 2 modal)
            const tcEl = document.getElementById('tien-trang-thancach-display');
            if(tcEl) tcEl.textContent = (gameData.thanCach || 0).toLocaleString();
            
            updateUI(); // Cập nhật các chỉ số hiển thị chung
        }

        // [NEW] Render Sieu Viet Panel Content
        function renderSieuVietPanel() {
            const panel = document.getElementById('panel-sieu-viet');
            if (!panel) return;

            const points = gameData.sieuVietPoints || 0;
            
            // Đảm bảo data lưu trữ cấp độ kỹ năng siêu việt
            if (!gameData.player.sieuVietSkills) {
                gameData.player.sieuVietSkills = {};
            }

            let skillsHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            for (const [skillId, skillData] of Object.entries(SIEU_VIET_SKILLS_DB)) {
                const currentLevel = gameData.player.sieuVietSkills[skillId] || 0;
                const maxLevel = skillData.maxLevel;
                const cost = skillData.costPerLevel; // Chi phí cố định mỗi cấp (ví dụ: 3 điểm)
                const isMax = currentLevel >= maxLevel;
                const canAfford = points >= cost;
                
                // Tính giá trị hiện tại
                const currentValue = (currentLevel * skillData.valuePerLevel).toFixed(1);
                const nextValue = ((currentLevel + 1) * skillData.valuePerLevel).toFixed(1);
                
                let btnHtml = '';
                if (isMax) {
                    btnHtml = `<button class="w-full bg-gray-600 text-gray-400 font-bold py-2 px-3 rounded text-xs cursor-not-allowed border border-gray-500">Đã Max</button>`;
                } else {
                    btnHtml = `<button onclick="upgradeSieuVietSkill('${skillId}')" 
                        class="w-full font-bold py-2 px-3 rounded text-xs flex items-center justify-center gap-2 transition transform active:scale-95
                        ${canAfford ? 'bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}" 
                        ${!canAfford ? 'disabled' : ''}>
                        <span>Nâng Cấp</span>
                        <span class="${canAfford ? 'text-white' : 'text-red-400'}">(${cost} Điểm)</span>
                    </button>`;
                }

                // Mô tả hiệu ứng
                let desc = skillData.desc.replace('{value}', `<span class="text-green-400 font-bold">${currentValue}</span>`);
                let nextDesc = !isMax ? `<span class="text-xs text-gray-500">Cấp sau: +${nextValue}%</span>` : '';

                skillsHtml += `
                <div class="bg-gray-800/80 rounded-xl p-4 border ${currentLevel > 0 ? 'border-yellow-500/50' : 'border-gray-700'} hover:border-yellow-400 transition duration-200 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 bg-gray-900 px-2 py-1 rounded-bl-lg border-b border-l border-gray-700 z-10">
                        <span class="text-[10px] text-gray-400">Cấp <span class="text-yellow-400 font-bold text-sm">${currentLevel}</span>/${maxLevel}</span>
                    </div>
                    
                    <div class="flex items-start gap-3 mb-3">
                        <div class="w-12 h-12 rounded-lg bg-gray-900 flex items-center justify-center text-2xl shadow-inner flex-shrink-0 border border-gray-600">
                            <i class="${skillData.icon} text-yellow-500"></i>
                        </div>
                        <div>
                            <p class="font-bold text-sm text-yellow-200 mb-1">${skillData.name}</p>
                            <p class="text-xs text-gray-400 h-8 leading-tight overflow-hidden">${desc}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2">
                        ${nextDesc}
                    </div>
                    
                    <div>${btnHtml}</div>
                </div>`;
            }
            skillsHtml += '</div>';

            panel.innerHTML = `
                <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Kỹ Năng Siêu Việt</h4>
                
                <div class="bg-black/20 backdrop-blur-sm border border-yellow-600/30 p-4 rounded-lg mb-4 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-500/5 to-transparent pointer-events-none"></div>
                    <p class="text-gray-300 mb-1 text-sm">Điểm Siêu Việt Khả Dụng</p>
                    <p id="sieu-viet-points" class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 filter drop-shadow-sm">${points}</p>
                    <p class="text-[10px] text-gray-500 mt-2 italic">* Nhận điểm khi Trùng Sinh. Nâng cấp để gia tăng sức mạnh vĩnh viễn.</p>
                </div>
                
                ${skillsHtml}
            `;
        }

        // [NEW] Hàm xử lý nâng cấp Kỹ Năng Siêu Việt
        function upgradeSieuVietSkill(skillId) {
            const skillData = SIEU_VIET_SKILLS_DB[skillId];
            if (!skillData) return;

            // Init data nếu chưa có
            if (!gameData.player.sieuVietSkills) gameData.player.sieuVietSkills = {};
            
            const currentLevel = gameData.player.sieuVietSkills[skillId] || 0;
            const cost = skillData.costPerLevel;

            if (currentLevel >= skillData.maxLevel) {
                showToast("Kỹ năng đã đạt cấp tối đa!", false);
                return;
            }

            if (gameData.sieuVietPoints < cost) {
                showToast("Không đủ Điểm Siêu Việt!", false);
                return;
            }

            // Trừ điểm
            gameData.sieuVietPoints -= cost;
            // Tăng cấp
            gameData.player.sieuVietSkills[skillId] = currentLevel + 1;

            showToast(`Nâng cấp [${skillData.name}] thành công!`, true);
            
            // Cập nhật UI & Stats
            renderSieuVietPanel();
            updateUI(); // Cập nhật chỉ số nhân vật (cần update getTotalStats để đọc data này)
        }
        // *** UPDATED: getTotalStats to read from 6 slots AND affixes ***
        function getTotalStats() {
            const stats = { hp: 0, mana: 0, honLuc: 0, atk: 0, def: 0, spd: 0, lck: 0, si_khi: 0 }; 
            stats.atk_ky = 0;
            stats.atk_phep = 0;
            stats.def_ky = 0;
            stats.def_phep = 0;
            
            const percentBonuses = { 
                hp_p: 0, mana_p: 0, honLuc_p: 0, atk_p: 0, def_p: 0, spd_p: 0, lck_p: 0, 
                critChance: 0, critDamage: 0, dodgeChance: 0, lifesteal: 0, manasteal: 0, 
                xp_boost: 0, ignoreDef_p: 0, atk_ky_p: 0, atk_phep_p: 0, def_ky_p: 0, 
                def_phep_p: 0, block_chance_p: 0, anti_block_p: 0, anti_crit_p: 0, 
                accuracy_p: 0, doubleAtkChance: 0 
            }; 

            // 1. Add player base stats (from level)
            const playerBaseCalculated = calculateFullStats(PLAYER_DATA, gameData.player.level);
             for (const stat in playerBaseCalculated) {
                 stats[stat] = (stats[stat] || 0) + playerBaseCalculated[stat];
             }

            // [NEW] 1b. Add stats from Potential Points (Tiềm Năng)
            if (gameData.player.allocatedStats) {
                const allocated = gameData.player.allocatedStats;
                // Sức Mạnh: +2 ATK
                stats.atk += (allocated.suc_manh || 0) * 2;
                // Thân Pháp: +2 SPD
                stats.spd += (allocated.than_phap || 0) * 2;
                // Sinh Khí: +20 HP
                stats.hp += (allocated.sinh_khi || 0) * 20;
                // Hồn Lực: +10 Max Hồn Lực, +10 Max Mana
                const honLucBonus = (allocated.hon_luc || 0) * 10;
                stats.honLuc += honLucBonus;
                stats.mana += honLucBonus;
            }

            // [NEW] 1c. Add stats from Cultivation Realm (Cảnh Giới)
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realmData = CANH_GIOI_DB[realmId];
            if (realmData && realmData.bonusStats) {
                if (realmData.bonusStats.hp) stats.hp += realmData.bonusStats.hp;
                if (realmData.bonusStats.atk) stats.atk += realmData.bonusStats.atk;
                if (realmData.bonusStats.def) stats.def += realmData.bonusStats.def;
            }

            // 2. Add stats from equipment slots (weapon, armor, 6 accessories)
            for (const slotName in gameData.equippedSlots) {
                const id = gameData.equippedSlots[slotName];
                if (!id) continue;
                
                // Find the item in inventory
                const item = gameData.gearInventory.find(i => i.uniqueId === id);
                if (!item) continue;
                
                // Calculate upgrade bonus
                const upgradeBonusPercent = getUpgradeBonusPercent(item.upgradeLevel || 0);
                const upgradeMultiplier = 1 + (upgradeBonusPercent / 100);
                
                // Add stats from item's affixes
                for (const affix of item.affixes) {
                    if (affix.isPercent) {
                        percentBonuses[affix.id] = (percentBonuses[affix.id] || 0) + affix.value;
                    } else {
                        stats[affix.id] = (stats[affix.id] || 0) + Math.floor(affix.value * upgradeMultiplier);
                    }
                }
            }

            // [NEW] 2b. Add stats from Passive Skills
            const playerSectId = gameData.player.monPhai || 'tieu_dao';
            const sectSkillList = MON_PHAI_SKILLS_DB[playerSectId]?.skills || MON_PHAI_SKILLS_DB['tieu_dao'].skills;
            
            const passiveSkills = sectSkillList.filter(s => s.passive && s.level <= gameData.player.level);
            passiveSkills.forEach(skill => {
                if (skill.effect) applyPassiveAffix(stats, percentBonuses, skill.effect);
                if (skill.effect2) applyPassiveAffix(stats, percentBonuses, skill.effect2);
                if (skill.effect3) applyPassiveAffix(stats, percentBonuses, skill.effect3);
            });
            
            const basicAttack = sectSkillList.find(s => s.chance === 0 && s.level <= gameData.player.level);
            if (basicAttack && basicAttack.effect && basicAttack.effect.type === 'passive_buff') {
                 applyPassiveAffix(stats, percentBonuses, basicAttack.effect);
            }
            if (basicAttack && basicAttack.effect2 && basicAttack.effect2.type === 'passive_buff') {
                 applyPassiveAffix(stats, percentBonuses, basicAttack.effect2);
            }

            // [NEW] 2c. Add stats from Tinh Phách (Permanent Stats)
            stats.hp += gameData.permanentStats.hp;
            stats.def += gameData.permanentStats.def;
            stats.atk += gameData.permanentStats.atk;
            percentBonuses.xp_boost += gameData.permanentStats.xp_boost;

            // [NEW] 2d. Add stats from Equipped Pet
            if (gameData.equippedSungVat) {
                const petInstance = gameData.sungVat.find(p => p.id === gameData.equippedSungVat);
                if (petInstance) {
                    const petStats = getPetStats(petInstance);
                    stats.hp += petStats.hp;
                    stats.atk += petStats.atk;
                    stats.def += petStats.def;
                    stats.spd += petStats.spd;
                    
                    const petDB = SUNG_VAT_DB[petInstance.id];
                    if (petDB && petDB.passiveSkill && petDB.passiveSkill.effect) {
                        const effect = petDB.passiveSkill.effect;
                        for (const key in effect) {
                             if (key.endsWith('_p') || ['critChance', 'critDamage', 'dodgeChance', 'lifesteal', 'manasteal', 'xp_boost', 'ignoreDef_p'].includes(key)) {
                                 percentBonuses[key] = (percentBonuses[key] || 0) + effect[key];
                             }
                        }
                    }
                }
            }

            // [NEW] 2g. Add stats from Deployed Disciple (Hộ Chủ)
            if (gameData.sect && gameData.sect.combatChampionId) {
                const champion = gameData.disciples.find(d => d.id === gameData.sect.combatChampionId);
                if (champion) {
                    const bonusRatio = 0.3;
                    stats.hp += Math.floor(champion.stats.hp * bonusRatio);
                    stats.atk += Math.floor(champion.stats.atk * bonusRatio);
                    stats.def += Math.floor((champion.stats.def || 0) * bonusRatio);
                    stats.spd += Math.floor((champion.stats.spd || 0) * bonusRatio);
                }
            }

            // [NEW] 2e. Add stats from Menh Cach
            if (gameData.equippedMenhCachSlots && gameData.menhCachInventory) {
                gameData.equippedMenhCachSlots.forEach(instanceId => {
                    if (!instanceId) return;
                    const mcInstance = gameData.menhCachInventory.find(inv => inv.instanceId === instanceId);
                    if (!mcInstance) return;
                    const mcDB = MENH_CACH_DB[mcInstance.id];
                    if (!mcDB || mcDB.type !== 'cat') return; 
                    const currentValue = mcDB.baseValue + (mcDB.scaleValue * (mcInstance.level - 1));
                    if (mcDB.isPercent) {
                        percentBonuses[mcDB.stat] = (percentBonuses[mcDB.stat] || 0) + currentValue;
                    } else {
                        stats[mcDB.stat] = (stats[mcDB.stat] || 0) + currentValue;
                    }
                });
            }

            // [NEW] 2f. Add stats from Kinh Mạch (Meridians)
            if (gameData.player.kinhMach) {
                for (const kmId in gameData.player.kinhMach) {
                    const level = gameData.player.kinhMach[kmId];
                    if (level > 0 && KINH_MACH_DB[kmId]) {
                        const kmStats = KINH_MACH_DB[kmId].stats;
                        for (const statKey in kmStats) {
                            const valuePerLevel = kmStats[statKey];
                            const totalValue = valuePerLevel * level;
                            if (percentBonuses.hasOwnProperty(statKey)) {
                                percentBonuses[statKey] += totalValue;
                            } else if (stats.hasOwnProperty(statKey)) {
                                stats[statKey] += totalValue;
                            }
                        }
                    }
                }
            }

            // [MODIFIED] 6. Add Bach Thang Bonus (Cơ chế Mới: Mỗi 10 tầng + Mốc Lớn)
            if (gameData.sect && gameData.sect.bachThang && gameData.sect.bachThang.highestLayer > 0) {
                const layer = gameData.sect.bachThang.highestLayer;
                
                // --- A. Thưởng Định Kỳ (Mỗi 10 tầng) ---
                // Cứ 10 tầng tăng 1% Toàn Diện (HP, ATK, DEF, SPD)
                const periodicBonus = Math.floor(layer / 10) * 1; 
                if (periodicBonus > 0) {
                    percentBonuses.hp_p += periodicBonus;
                    percentBonuses.atk_p += periodicBonus;
                    percentBonuses.def_p += periodicBonus;
                    percentBonuses.spd_p += periodicBonus;
                }

                // --- B. Thưởng Mốc Lớn (Giữ nguyên cũ + Mới) ---
                if (layer >= 10) percentBonuses.atk_p += 5;
                if (layer >= 50) percentBonuses.critChance += 5;
                if (layer >= 300) { percentBonuses.hp_p += 10; percentBonuses.atk_p += 10; percentBonuses.def_p += 10; percentBonuses.spd_p += 10; }
                if (layer >= 800) percentBonuses.lifesteal += 10;
                if (layer >= 1500) percentBonuses.def_p += 50;
                if (layer >= 2500) percentBonuses.hp_p += 50;
                if (layer >= 3000) percentBonuses.atk_p += 50;
                if (layer >= 4000) percentBonuses.critDamage += 100;
                if (layer >= 6000) percentBonuses.xp_boost += 100;
                if (layer >= 7000) percentBonuses.ignoreDef_p += 30;
                if (layer >= 8000) stats.si_khi += 50;
                if (layer >= 9000) { percentBonuses.hp_p += 50; percentBonuses.atk_p += 50; percentBonuses.def_p += 50; percentBonuses.spd_p += 50; }
                
                // Mốc Cao Cấp Mới (20k - 1M)
                if (layer >= 20000) percentBonuses.lifesteal += 20;
                if (layer >= 35000) percentBonuses.manasteal += 20;
                if (layer >= 50000) percentBonuses.critDamage += 200;
                if (layer >= 75000) percentBonuses.accuracy_p += 100;
                if (layer >= 150000) percentBonuses.atk_p += 150;
                if (layer >= 200000) percentBonuses.def_p += 100;
                if (layer >= 250000) percentBonuses.dodgeChance += 50;
                if (layer >= 350000) percentBonuses.xp_boost += 300;
                if (layer >= 500000) percentBonuses.ignoreDef_p += 50;
                if (layer >= 750000) { percentBonuses.hp_p += 100; percentBonuses.atk_p += 100; percentBonuses.def_p += 100; percentBonuses.spd_p += 100; }
            }

            // [NEW] 3. Add Rebirth Bonus (Trùng Sinh)
            const rebirthBonusPercent = (gameData.rebirthCount || 0) * 1; 
            if (rebirthBonusPercent > 0) {
                percentBonuses.hp_p += rebirthBonusPercent;
                percentBonuses.mana_p += rebirthBonusPercent;
                percentBonuses.honLuc_p += rebirthBonusPercent; 
                percentBonuses.atk_p += rebirthBonusPercent;
                percentBonuses.def_p += rebirthBonusPercent;
                percentBonuses.spd_p += rebirthBonusPercent;
                percentBonuses.lck_p += rebirthBonusPercent;
                percentBonuses.atk_ky_p += rebirthBonusPercent;
                percentBonuses.atk_phep_p += rebirthBonusPercent;
                percentBonuses.def_ky_p += rebirthBonusPercent;
                percentBonuses.def_phep_p += rebirthBonusPercent;
            }

            // [NEW] 4. Add Phi Thăng (Tiên Lực) Bonus
            const tienLucBonusPercent = (gameData.tienLuc || 0) * 1; 
            if (tienLucBonusPercent > 0) {
                percentBonuses.hp_p += tienLucBonusPercent;
                percentBonuses.mana_p += tienLucBonusPercent;
                percentBonuses.honLuc_p += tienLucBonusPercent; 
                percentBonuses.atk_p += tienLucBonusPercent;
                percentBonuses.def_p += tienLucBonusPercent;
                percentBonuses.spd_p += tienLucBonusPercent;
                percentBonuses.lck_p += tienLucBonusPercent;
                percentBonuses.atk_ky_p += tienLucBonusPercent;
                percentBonuses.atk_phep_p += tienLucBonusPercent;
                percentBonuses.def_ky_p += tienLucBonusPercent;
                percentBonuses.def_phep_p += tienLucBonusPercent;
            }

            // [NEW] 5. Add Sieu Viet Bonus
            const sieuVietPoints = gameData.sieuVietPoints || 0;
            const sieuVietBonusPercent = sieuVietPoints * 2; // Chỉ dùng cho header display nếu cần, tính toán chi tiết bên dưới

            if (gameData.player.sieuVietSkills) {
                for (const [skillId, level] of Object.entries(gameData.player.sieuVietSkills)) {
                    if (level > 0 && SIEU_VIET_SKILLS_DB[skillId]) {
                        const skillData = SIEU_VIET_SKILLS_DB[skillId];
                        const bonusVal = level * skillData.valuePerLevel;
                        if (percentBonuses.hasOwnProperty(skillData.stat)) {
                            percentBonuses[skillData.stat] += bonusVal;
                        }
                    }
                }
            }

            // 4. Apply Percent Bonuses
            stats.hp = Math.floor(stats.hp * (1 + percentBonuses.hp_p / 100));
            stats.mana = Math.floor(stats.mana * (1 + percentBonuses.mana_p / 100)); 
            stats.honLuc = Math.floor(stats.honLuc * (1 + percentBonuses.honLuc_p / 100)); 
            stats.atk = Math.floor(stats.atk * (1 + percentBonuses.atk_p / 100));
            stats.def = Math.floor(stats.def * (1 + percentBonuses.def_p / 100));
            stats.spd = Math.floor(stats.spd * (1 + percentBonuses.spd_p / 100)); 
            stats.lck = Math.floor(stats.lck * (1 + percentBonuses.lck_p / 100)); 
            
            stats.atk_ky = Math.floor(stats.atk_ky * (1 + percentBonuses.atk_ky_p / 100));
            stats.atk_phep = Math.floor(stats.atk_phep * (1 + percentBonuses.atk_phep_p / 100));
            stats.def_ky = Math.floor(stats.def_ky * (1 + percentBonuses.def_ky_p / 100));
            stats.def_phep = Math.floor(stats.def_phep * (1 + percentBonuses.def_phep_p / 100));
            stats.si_khi = Math.floor(stats.si_khi); 
            
            stats.atk = stats.atk + stats.atk_ky + stats.atk_phep;
            stats.def = stats.def + stats.def_ky + stats.def_phep;

            // 5. Add secondary stats
            const baseCrit = 0; 
            const baseDodge = 0; 
            
            stats.critChance = baseCrit + percentBonuses.critChance;
            stats.critDamage = 150 + percentBonuses.critDamage; 
            stats.dodgeChance = Math.min(60, baseDodge + percentBonuses.dodgeChance); 

            stats.block_chance_p = percentBonuses.block_chance_p;
            stats.anti_block_p = percentBonuses.anti_block_p;
            stats.anti_crit_p = percentBonuses.anti_crit_p;
            stats.accuracy_p = percentBonuses.accuracy_p; 

            stats.lifesteal = Math.min(30, percentBonuses.lifesteal); 
            stats.manasteal = Math.min(30, percentBonuses.manasteal); 
            stats.xp_boost = percentBonuses.xp_boost;
            stats.ignoreDef_p = percentBonuses.ignoreDef_p;
            
            stats.doubleAtkChance = percentBonuses.doubleAtkChance || 0;

            for (const stat in stats) { stats[stat] = Math.floor(stats[stat]); }
            
            // Update display values
            const displayStats = { ...stats };
            displayStats.critChance = Math.round(stats.critChance * 10) / 10;
            displayStats.critDamage = Math.round(stats.critDamage);
            displayStats.dodgeChance = Math.round(stats.dodgeChance * 10) / 10;
            displayStats.lifesteal = Math.round(stats.lifesteal * 10) / 10;
            displayStats.manasteal = Math.round(stats.manasteal * 10) / 10;
            displayStats.xp_boost = Math.round(stats.xp_boost);
            displayStats.ignoreDef_p = Math.round(stats.ignoreDef_p * 10) / 10;
            displayStats.block_chance_p = Math.round(stats.block_chance_p * 10) / 10;
            displayStats.anti_block_p = Math.round(stats.anti_block_p * 10) / 10;
            displayStats.anti_crit_p = Math.round(stats.anti_crit_p * 10) / 10;
            displayStats.si_khi = Math.round(stats.si_khi); 
            displayStats.accuracy_p = Math.round(stats.accuracy_p * 10) / 10; 
            displayStats.doubleAtkChance = Math.round(stats.doubleAtkChance * 10) / 10;

            const totalStatsContainer = document.getElementById('total-stats');
            if (totalStatsContainer) {
                totalStatsContainer.className = 'bg-black/20 backdrop-blur-md p-3 rounded-lg border border-gray-700/50 shadow-inner';
                let buffsHtml = '';
                if (rebirthBonusPercent > 0 || tienLucBonusPercent > 0 || sieuVietBonusPercent > 0) {
                    buffsHtml = `<div class="flex flex-wrap gap-2 mb-3 border-b border-gray-700/50 pb-2">`;
                    if (rebirthBonusPercent > 0) buffsHtml += `<span class="bg-pink-900/30 text-pink-300 text-[10px] px-2 py-0.5 rounded border border-pink-500/30" title="Cộng toàn bộ chỉ số">Trùng Sinh +${rebirthBonusPercent}%</span>`;
                    if (tienLucBonusPercent > 0) buffsHtml += `<span class="bg-cyan-900/30 text-cyan-300 text-[10px] px-2 py-0.5 rounded border border-cyan-500/30" title="Cộng toàn bộ chỉ số">Phi Thăng +${tienLucBonusPercent}%</span>`;
                    if (sieuVietBonusPercent > 0) buffsHtml += `<span class="bg-yellow-900/30 text-yellow-300 text-[10px] px-2 py-0.5 rounded border border-yellow-500/30" title="Cộng toàn bộ chỉ số">Siêu Việt +${sieuVietBonusPercent}%</span>`;
                    buffsHtml += `</div>`;
                }

                const statRow = (label, value, icon, color, isPercent = false) => `
                    <div class="flex justify-between items-center p-1 hover:bg-white/5 rounded transition-colors">
                        <div class="flex items-center gap-2">
                            <div class="w-5 text-center"><i class="${icon} ${color} text-xs"></i></div>
                            <span class="text-gray-400 text-xs">${label}</span>
                        </div>
                        <span class="font-mono text-xs font-bold ${color}">${value.toLocaleString()}${isPercent ? '%' : ''}</span>
                    </div>
                `;

                totalStatsContainer.innerHTML = `
                    ${buffsHtml}
                    <div class="space-y-3">
                        <div>
                            <h6 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 pl-1">Cơ Bản</h6>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-0.5">
                                ${statRow('Sinh Lực', displayStats.hp, 'fa-solid fa-heart', 'text-red-400')}
                                ${statRow('Nội Lực', displayStats.mana, 'fa-solid fa-droplet', 'text-blue-400')}
                                ${statRow('Hồn Lực', displayStats.honLuc, 'fa-solid fa-ghost', 'text-purple-400')}
                                ${statRow('Công Kích', displayStats.atk, 'fa-solid fa-khanda', 'text-orange-400')}
                                ${statRow('Phòng Thủ', displayStats.def, 'fa-solid fa-shield-halved', 'text-blue-300')}
                                ${statRow('Thân Pháp', displayStats.spd, 'fa-solid fa-wind', 'text-green-400')}
                                ${statRow('May Mắn', displayStats.lck, 'fa-solid fa-clover', 'text-yellow-400')}
                                ${statRow('Sĩ Khí', displayStats.si_khi, 'fa-solid fa-bolt-lightning', 'text-yellow-200')}
                            </div>
                        </div>
                        <div>
                            <h6 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 pl-1 border-t border-gray-700/30 pt-2">Chiến Đấu</h6>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-0.5">
                                ${statRow('Chí Mạng', displayStats.critChance, 'fa-solid fa-bolt', 'text-yellow-300', true)}
                                ${statRow('ST Bạo Kích', displayStats.critDamage, 'fa-solid fa-burst', 'text-red-500', true)}
                                ${statRow('Chính Xác', displayStats.accuracy_p, 'fa-solid fa-crosshairs', 'text-cyan-300', true)}
                                ${statRow('Xuyên Giáp', displayStats.ignoreDef_p, 'fa-solid fa-arrow-right-to-bracket', 'text-gray-300', true)}
                                ${statRow('Liên Kích', displayStats.doubleAtkChance, 'fa-solid fa-angles-right', 'text-fuchsia-300', true)}
                                ${statRow('Công Phép', displayStats.atk_phep, 'fa-solid fa-wand-sparkles', 'text-orange-300')}
                            </div>
                        </div>
                        <div>
                            <h6 class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1 pl-1 border-t border-gray-700/30 pt-2">Phòng Ngự & Hiệu Ứng</h6>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-0.5">
                                ${statRow('Né Tránh', displayStats.dodgeChance, 'fa-solid fa-person-running', 'text-green-300', true)}
                                ${statRow('Chống Đỡ', displayStats.block_chance_p, 'fa-solid fa-shield', 'text-gray-400', true)}
                                ${statRow('Hút Máu', displayStats.lifesteal, 'fa-solid fa-tooth', 'text-red-400', true)}
                                ${statRow('Hút Mana', displayStats.manasteal, 'fa-solid fa-droplet-slash', 'text-blue-400', true)}
                                ${statRow('Kháng Bạo', displayStats.anti_crit_p, 'fa-solid fa-shield-heart', 'text-pink-300', true)}
                                ${statRow('Kinh Nghiệm', displayStats.xp_boost, 'fa-solid fa-book-open', 'text-yellow-200', true)}
                            </div>
                        </div>
                    </div>
                `;
            }
            return stats;
        }

        // [NEW] --- Tien Trang Tabbed Interface ---
        function switchTienTrangTab(tabId) {
            const modal = document.getElementById('tien-trang-modal');
            if (!modal) return;
            
            modal.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'text-yellow-400');
                btn.classList.add('text-gray-400');
                // Reset màu đặc biệt cho tab phù phép nếu không active
                if (btn.id === 'tab-buy-scrolls') btn.classList.remove('text-purple-400');
                // [NEW] Reset màu cho tab Thương Nhân
                if (btn.id === 'tab-buy-blueprints') btn.classList.remove('text-purple-400');
            });
            
            const panel = document.getElementById(`panel-${tabId}`);
            const tab = document.getElementById(`tab-${tabId}`);
            
            if (panel) panel.classList.remove('hidden');
            if (tab) {
                tab.classList.add('tab-active', 'text-yellow-400');
                tab.classList.remove('text-gray-400');
                // Màu đặc biệt cho tab phù phép khi active
                if (tabId === 'buy-scrolls') tab.classList.add('text-purple-400');
                // [NEW] Màu đặc biệt cho tab Thương Nhân khi active
                if (tabId === 'buy-blueprints') tab.classList.add('text-purple-400');
            }
            
            // [NEW] Refresh currency displays when switching tabs, specially for exchange
            if (tabId === 'exchange') {
                const nlEl = document.getElementById('tien-trang-nl');
                if(nlEl) nlEl.textContent = gameData.nganLuong.toLocaleString();
                const knbEl = document.getElementById('tien-trang-knb');
                if(knbEl) knbEl.textContent = gameData.kimNguyenBao.toLocaleString();
            } else if (tabId === 'sell') {
                renderSellList();
            } else if (tabId === 'sell-materials') { 
                renderMaterialSellList();
            } else if (tabId === 'buy') { 
                renderBuyList();
            } else if (tabId === 'buy-scrolls') { // [NEW]
                renderBuyScrollList();
            } else if (tabId === 'buy-equip') { 
                renderBuyEquipmentList();
            } else if (tabId === 'exchange-items') { 
                renderItemExchangeList();
            } else if (tabId === 'buy-blueprints') { // [NEW] Handle Merchant Tab
                renderMysteriousMerchantList();
            }
        }

        // [NEW] Render function for Mysterious Merchant (Blueprints)
        function renderMysteriousMerchantList() {
            const listContainer = document.getElementById('buy-blueprint-list');
            if (!listContainer) return;

            // Filter blueprints
            const merchantItems = Object.keys(STATIC_ITEM_DB).filter(id => 
                STATIC_ITEM_DB[id].type === 'blueprint'
            );

            // Sort by tier/rarity
            merchantItems.sort((a, b) => {
                const tierA = STATIC_ITEM_DB[a].tier || 0;
                const tierB = STATIC_ITEM_DB[b].tier || 0;
                return tierA - tierB;
            });

            if (merchantItems.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full py-8">Thương nhân hiện đang đi vắng...</p>`;
                return;
            }

            listContainer.innerHTML = merchantItems.map(id => {
                const item = STATIC_ITEM_DB[id];
                const owned = gameData.items[id] || 0;
                const qualityClass = getRarityClass(item.rarity);
                
                // [NEW] Check Rebirth Requirement
                const playerRebirth = gameData.rebirthCount || 0;
                const rebirthReq = item.rebirthReq || 0;
                const isRebirthEnough = playerRebirth >= rebirthReq;

                // Cost Logic (Mixed Costs)
                let costDisplay = '';
                let canAfford = isRebirthEnough; // [MODIFIED] Must meet rebirth requirement first
                
                if (item.mixCosts) {
                    const c = item.mixCosts;
                    const myUD = gameData.uyDanh || 0;
                    const myDV = gameData.danhVong || 0;
                    const myCH = gameData.diemCongHien || 0;
                    const myKNB = gameData.kimNguyenBao || 0;

                    // Check logic
                    if (c.uyDanh && myUD < c.uyDanh) canAfford = false;
                    if (c.danhVong && myDV < c.danhVong) canAfford = false;
                    if (c.diemCongHien && myCH < c.diemCongHien) canAfford = false;
                    if (c.kimNguyenBao && myKNB < c.kimNguyenBao) canAfford = false;

                    let costParts = [];
                    if (c.uyDanh) costParts.push(`<div class="flex justify-between"><span class="text-gray-400">Uy Danh:</span> <span class="${myUD >= c.uyDanh ? 'text-purple-300' : 'text-red-400'} font-bold">${c.uyDanh.toLocaleString()}</span></div>`);
                    if (c.danhVong) costParts.push(`<div class="flex justify-between"><span class="text-gray-400">Danh Vọng:</span> <span class="${myDV >= c.danhVong ? 'text-teal-300' : 'text-red-400'} font-bold">${c.danhVong.toLocaleString()}</span></div>`);
                    if (c.diemCongHien) costParts.push(`<div class="flex justify-between"><span class="text-gray-400">Cống Hiến:</span> <span class="${myCH >= c.diemCongHien ? 'text-lime-300' : 'text-red-400'} font-bold">${c.diemCongHien.toLocaleString()}</span></div>`);
                    if (c.kimNguyenBao) costParts.push(`<div class="flex justify-between"><span class="text-gray-400">KNB:</span> <span class="${myKNB >= c.kimNguyenBao ? 'text-yellow-300' : 'text-red-400'} font-bold">${c.kimNguyenBao.toLocaleString()}</span></div>`);
                    
                    costDisplay = `<div class="text-xs mt-3 bg-black/40 p-2 rounded border border-gray-700 space-y-1">${costParts.join('')}</div>`;
                }

                // [NEW] Button Text Logic
                let btnText = `<span>Trao Đổi</span> <i class="fa-solid fa-handshake-simple"></i>`;
                if (!isRebirthEnough) {
                    btnText = `<span>Cần TS ${rebirthReq}</span> <i class="fa-solid fa-lock"></i>`;
                }

                return `
                <div class="merchant-card rounded-lg p-4 relative overflow-hidden group flex flex-col h-full ${!isRebirthEnough ? 'opacity-60 grayscale' : ''}">
                    <!-- Tier Badge -->
                    <div class="absolute top-0 right-0 bg-purple-900/80 text-purple-200 text-[10px] font-bold px-2 py-1 rounded-bl-lg z-10 border-b border-l border-purple-500/30">
                        Cấp ${item.tier || '?'}
                    </div>
                    
                    <!-- Header: Icon & Name -->
                    <div class="flex items-start gap-3 mb-2">
                        <div class="w-14 h-14 rounded-lg bg-black/40 border border-gray-600 flex items-center justify-center flex-shrink-0 group-hover:border-purple-400 transition">
                            <i class="${item.icon} text-3xl ${qualityClass}"></i>
                        </div>
                        <div class="flex-grow min-w-0"> <!-- min-w-0 needed for truncate in flex child -->
                            <h5 class="font-bold text-sm ${qualityClass} truncate" title="${item.name}">${item.name}</h5>
                            <p class="text-[10px] text-gray-400 mt-0.5">Đang có: <span class="text-white font-bold">${owned}</span></p>
                        </div>
                    </div>
                    
                    <!-- Desc -->
                    <p class="text-xs text-gray-300 h-8 overflow-hidden leading-tight mb-auto opacity-80 group-hover:opacity-100 transition line-clamp-2">
                        ${item.desc}
                    </p>
                    
                    <!-- Stats Preview (Optional, nice for blueprints) -->
                    <div class="text-[10px] text-gray-400 mt-2 mb-1 flex gap-2">
                        <span class="bg-gray-800 px-1.5 py-0.5 rounded">Chỉ số x${item.statMultiplier || 1}</span>
                        <span class="bg-gray-800 px-1.5 py-0.5 rounded">Bonus +${item.percentBonus || 0}%</span>
                    </div>

                    <!-- Cost -->
                    ${costDisplay}

                    <!-- Button -->
                    <div class="mt-3 pt-2 border-t border-gray-700/50">
                         <button onclick="buyItem('${id}', 1)" class="w-full bg-gradient-to-r from-purple-700 to-indigo-800 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-2 px-4 rounded text-xs shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                            ${btnText}
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // [NEW] --- Menh Cach Tabbed Interface ---
        function switchMenhCachTab(tabId) {
            const modal = document.getElementById('menh-cach-modal');
            if (!modal) return;
            
            modal.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'text-yellow-400');
                btn.classList.add('text-gray-400');
            });
            
            const panel = document.getElementById(`panel-${tabId}`);
            const tab = document.getElementById(`tab-${tabId}`);
            
            if (panel) panel.classList.remove('hidden');
            if (tab) {
                tab.classList.add('tab-active', 'text-yellow-400');
                tab.classList.remove('text-gray-400');
            }
            
            if (tabId === 'menh-ban') {
                renderMenhBanPanel(); // [NEW] Render Mệnh Bàn và Kho
            } else if (tabId === 'chieu-menh') {
                renderChieuMenhPanel(); // [NEW] Cập nhật UI khi chuyển tab
                renderSummonHistoryLog(); // [NEW] Render lịch sử
            }
        }

        // [NEW] Added missing function for currency exchange
        function exchangeCurrency() {
            const inputEl = document.getElementById('nl-to-exchange');
            if (!inputEl) return;

            const amountToExchange = parseInt(inputEl.value, 10);

            if (isNaN(amountToExchange) || amountToExchange < 1000000) {
                showToast("Cần đổi ít nhất 1,000,000 Ngân Lượng.", false);
                return;
            }
            
            if (gameData.nganLuong < amountToExchange) {
                showToast("Không đủ Ngân Lượng!", false);
                return;
            }
            
            // Round down to the nearest 1M
            const actualAmount = Math.floor(amountToExchange / 1000000) * 1000000;
            if (actualAmount <= 0) {
                 showToast("Số tiền đổi không hợp lệ.", false);
                 return;
            }
            
            const knbGained = actualAmount / 1000000;

            // Process transaction
            gameData.nganLuong -= actualAmount;
            gameData.kimNguyenBao += knbGained;
            
            showToast(`Đã đổi ${actualAmount.toLocaleString()} NL lấy ${knbGained.toLocaleString()} KNB!`, true);

            // Clear input
            inputEl.value = '';
            
            // Re-render currency in modal
            const nlEl = document.getElementById('tien-trang-nl');
            if(nlEl) nlEl.textContent = gameData.nganLuong.toLocaleString();
            
            const knbEl = document.getElementById('tien-trang-knb'); // [NEW] Update KNB display too
            if(knbEl) knbEl.textContent = gameData.kimNguyenBao.toLocaleString();
            
            // Update main UI
            updateUI();
        }

        // [NEW] Hàm đổi KNB sang Ngân Lượng
        function exchangeKNBToNL() {
            const inputEl = document.getElementById('knb-to-exchange');
            if (!inputEl) return;

            const amountToExchange = parseInt(inputEl.value, 10);

            if (isNaN(amountToExchange) || amountToExchange < 1) {
                showToast("Cần đổi ít nhất 1 KNB.", false);
                return;
            }
            
            if (gameData.kimNguyenBao < amountToExchange) {
                showToast("Không đủ Kim Nguyên Bảo!", false);
                return;
            }
            
            const EXCHANGE_RATE = 888888;
            const nlGained = amountToExchange * EXCHANGE_RATE;

            // Process transaction
            gameData.kimNguyenBao -= amountToExchange;
            gameData.nganLuong += nlGained;
            
            showToast(`Đã đổi ${amountToExchange.toLocaleString()} KNB lấy ${nlGained.toLocaleString()} NL!`, true);

            // Clear input
            inputEl.value = '';
            
            // Re-render currency in modal
            const nlEl = document.getElementById('tien-trang-nl');
            if(nlEl) nlEl.textContent = gameData.nganLuong.toLocaleString(); 
            
            const knbEl = document.getElementById('tien-trang-knb');
            if(knbEl) knbEl.textContent = gameData.kimNguyenBao.toLocaleString();
            
            // Update main UI
            updateUI();
        }

        // [NEW] Hàm Hợp Thành Thần Cách (Đổi 5 loại tiền)
        function exchangeThanCach() {
            const inputEl = document.getElementById('thancach-to-exchange');
            if (!inputEl) return;

            const amountToBuy = parseInt(inputEl.value, 10);

            if (isNaN(amountToBuy) || amountToBuy < 1) {
                showToast("Cần hợp thành ít nhất 1 Thần Cách.", false);
                return;
            }

            // Định nghĩa tỷ giá
            const costUD = 2;
            const costDV = 2;
            const costVD = 50;  // Vinh Dự
            const costTL = 100; // Tích Lũy
            const costCH = 200; // Cống Hiến

            // Tính tổng chi phí
            const totalUD = costUD * amountToBuy;
            const totalDV = costDV * amountToBuy;
            const totalVD = costVD * amountToBuy;
            const totalTL = costTL * amountToBuy;
            const totalCH = costCH * amountToBuy;

            // Lấy tài sản hiện có (xử lý undefined = 0)
            const myUD = gameData.uyDanh || 0;
            const myDV = gameData.danhVong || 0;
            const myVD = gameData.diemVinhDuLienDau || 0;
            const myTL = gameData.diemTichLuyTongKim || 0;
            const myCH = gameData.diemCongHien || 0;

            // Kiểm tra đủ tiền
            if (myUD < totalUD) { showToast(`Thiếu ${totalUD - myUD} Uy Danh!`, false); return; }
            if (myDV < totalDV) { showToast(`Thiếu ${totalDV - myDV} Danh Vọng!`, false); return; }
            if (myVD < totalVD) { showToast(`Thiếu ${totalVD - myVD} điểm Vinh Dự!`, false); return; }
            if (myTL < totalTL) { showToast(`Thiếu ${totalTL - myTL} điểm Tích Lũy!`, false); return; }
            if (myCH < totalCH) { showToast(`Thiếu ${totalCH - myCH} điểm Cống Hiến!`, false); return; }

            // Trừ tiền
            gameData.uyDanh -= totalUD;
            gameData.danhVong -= totalDV;
            gameData.diemVinhDuLienDau -= totalVD;
            gameData.diemTichLuyTongKim -= totalTL;
            gameData.diemCongHien -= totalCH;

            // Cộng Thần Cách
            gameData.thanCach = (gameData.thanCach || 0) + amountToBuy;

            showToast(`Hợp thành thành công ${amountToBuy} điểm Thần Cách!`, true);
            
            // Clear input
            inputEl.value = '';

            // [FIXED] Cập nhật hiển thị số lượng Thần Cách ngay lập tức
            const tcEl = document.getElementById('tien-trang-thancach-display');
            if(tcEl) tcEl.textContent = (gameData.thanCach || 0).toLocaleString();

            // Cập nhật UI (Render lại tab Exchange để thấy số dư mới)
            // renderModalContent('tien-trang-modal'); // Không cần gọi lại toàn bộ modal gây giật
            updateUI();
        }

        function calculateSellPrice(item) {
            if (!item) return 0;
            // [MODIFIED] Base price slightly increased, multiplier adjusted
            const basePrice = (item.level || 1) * 10; 
            let qualityMultiplier = 1;
            
            switch (item.quality) {
                case 'uncommon': qualityMultiplier = 1.5; break; // Reduced
                case 'rare':     qualityMultiplier = 2.5; break; // Reduced
                case 'legendary':qualityMultiplier = 4.0; break; // Reduced
                case 'epic':     qualityMultiplier = 6.0; break; // New
                case 'mythic':   qualityMultiplier = 10.0; break; // Higher for Uy Danh base calc later
                case 'supergodly': qualityMultiplier = 20.0; break; // New
                default:         qualityMultiplier = 1.0; break;
            }
            
            const affixBonus = item.affixes ? item.affixes.length * (item.level || 1) * 0.5 : 0; // Reduced affix bonus impact
            
            return Math.floor((basePrice * qualityMultiplier) + affixBonus);
        }

        // [MODIFIED] renderSellList to show Uy Danh reward for Mythic items
        function renderSellList() {
            const listContainer = document.getElementById('sell-item-list');
            if (!listContainer) return;

            const allEquippedIds = Object.values(gameData.equippedSlots);
            const sellableItems = gameData.gearInventory.filter(item => !allEquippedIds.includes(item.uniqueId));

            // Sort by quality (lowest first) then level
            sellableItems.sort((a, b) => {
                 const qualityA = Object.keys(QUALITY_DB).indexOf(a.quality);
                 const qualityB = Object.keys(QUALITY_DB).indexOf(b.quality);
                 if (qualityA !== qualityB) return qualityA - qualityB;
                 return (a.level || 0) - (b.level || 0);
            });

            if (sellableItems.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-400">Không có trang bị nào để bán.</p>`;
                return;
            }

            listContainer.innerHTML = sellableItems.map(item => {
                const quality = QUALITY_DB[item.quality];
                let buttonHTML = '';
                
                // --- Determine Sell Reward ---
                if (item.quality === 'mythic') {
                    // Sell Mythic for Uy Danh
                    const uyDanhReward = Math.max(1, Math.floor(calculateSellPrice(item) / 100)); // Example: Uy Danh = NL price / 100 (min 1)
                    buttonHTML = `<button onclick="sellItem('${item.uniqueId}', true)" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                                    Bán (<span class="text-purple-300">${uyDanhReward} Uy Danh</span>)
                                </button>`;
                } else {
                    // Sell other qualities for Ngân Lượng
                    const price = calculateSellPrice(item);
                    buttonHTML = `<button onclick="sellItem('${item.uniqueId}', false)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                                    Bán (${price} NL)
                                </button>`;
                }
                
                return `
                <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-grow">
                        <p class="font-bold text-sm ${quality.className}">${item.name} <span class="text-xs" style="color: ${quality.color};">[Cấp ${item.level}]</span></p>
                        <div class="text-xs text-gray-300 mt-1">
                            <!-- [MODIFIED] Apply color from affix.rarityClass -->
                            ${item.affixes.map(affix => {
                                let colorClass = 'text-gray-300';
                                if (affix.isEnchant) colorClass = affix.rarityClass || 'text-green-400';
                                return `<span class="${colorClass}">${affix.display}</span>`;
                            }).join(', ')}
                        </div>
                    </div>
                    ${buttonHTML} 
                </div>
                `;
            }).join('');
        }

        // [MODIFIED] sellItem to handle selling for Uy Danh
        function sellItem(uniqueId, sellForUyDanh = false) {
            const allEquippedIds = Object.values(gameData.equippedSlots);
            if (allEquippedIds.includes(uniqueId)) {
                showToast("Không thể bán trang bị đang mặc!", false);
                return;
            }

            const itemIndex = gameData.gearInventory.findIndex(item => item.uniqueId === uniqueId);
            if (itemIndex === -1) {
                showToast("Không tìm thấy vật phẩm!", false);
                return;
            }

            const item = gameData.gearInventory[itemIndex];

            // Determine reward
            if (sellForUyDanh && item.quality === 'mythic') {
                 // --- Sell for Uy Danh ---
                 const uyDanhReward = Math.max(1, Math.floor(calculateSellPrice(item) / 100)); // Same formula as renderSellList
                 
                 // Remove item
                 gameData.gearInventory.splice(itemIndex, 1);
                 // Add Uy Danh
                 gameData.uyDanh += uyDanhReward;
                 
                 showToast(`Đã bán ${item.name} nhận ${uyDanhReward} Uy Danh.`, true);
                 
            } else if (!sellForUyDanh && item.quality !== 'mythic') {
                 // --- Sell for Ngân Lượng (non-mythic only) ---
                 const price = calculateSellPrice(item);
                 
                 // Remove item
                 gameData.gearInventory.splice(itemIndex, 1);
                 // Add currency
                 gameData.nganLuong += price;

                 showToast(`Đã bán ${item.name} nhận ${price} NL.`, true);
                 
                 // Update currency in exchange tab if NL was gained
                 const nlEl = document.getElementById('tien-trang-nl');
                 if(nlEl) nlEl.textContent = gameData.nganLuong; 
                 
            } else {
                 // Prevent selling mythic for NL or non-mythic for Uy Danh via console manipulation
                 showToast("Hành động bán không hợp lệ!", false);
                 return;
            }

            // Re-render sell list
            renderSellList();
            // Update main UI currency/Uy Danh
            updateUI();
        }
        
        // [MODIFIED] sellItemsByQuality to prevent selling Mythic items
        function sellItemsByQuality(qualityId) {
             // --- Prevent selling Mythic ---
             if (qualityId === 'mythic') {
                 showToast("Không thể bán hết đồ Chí Tôn!", false);
                 return;
             }
             // --- Prevent selling Super Godly ---
              if (qualityId === 'supergodly') {
                 showToast("Không thể bán hết đồ Siêu Thần!", false);
                 return;
             }
             // --- End Prevent ---

            const allEquippedIds = Object.values(gameData.equippedSlots);
            const itemsToSell = gameData.gearInventory.filter(item => 
                item.quality === qualityId && 
                !allEquippedIds.includes(item.uniqueId)
            );

            if (itemsToSell.length === 0) {
                showToast(`Không có đồ [${QUALITY_DB[qualityId].name}] để bán.`, false);
                return;
            }

            let totalGained = 0;
            let itemsSoldCount = 0;

            // Loop backwards to safely remove items
            for (let i = gameData.gearInventory.length - 1; i >= 0; i--) {
                const item = gameData.gearInventory[i];
                if (item.quality === qualityId && !allEquippedIds.includes(item.uniqueId)) {
                    totalGained += calculateSellPrice(item);
                    itemsSoldCount++;
                    gameData.gearInventory.splice(i, 1); // Remove item
                }
            }

            gameData.nganLuong += totalGained;
            showToast(`Đã bán ${itemsSoldCount} món [${QUALITY_DB[qualityId].name}] nhận ${totalGained} NL.`, true);

            // Re-render
            renderSellList();
            updateUI();
            const nlEl = document.getElementById('tien-trang-nl');
            if(nlEl) nlEl.textContent = gameData.nganLuong;
        }
        
        // --- [NEW] Material Selling Functions ---
        function renderMaterialSellList() {
            const listContainer = document.getElementById('sell-material-list');
            if (!listContainer) return;

            let html = '';
            
            // --- 1. Get Materials ---
            const ownedMaterials = Object.keys(gameData.materials).filter(id => 
                gameData.materials[id] > 0 && 
                MATERIALS_DB[id] && 
                MATERIALS_DB[id].sellPrice
            );
            ownedMaterials.sort((a, b) => (MATERIALS_DB[a]?.rarity || 0) - (MATERIALS_DB[b]?.rarity || 0));

            // --- 2. Get Consumable Items ---
            const ownedItems = Object.keys(gameData.items).filter(id => 
                gameData.items[id] > 0 && 
                STATIC_ITEM_DB[id] && 
                (STATIC_ITEM_DB[id].buyPrice || STATIC_ITEM_DB[id].sellPrice) // Can be sold if it has a buyPrice (to derive from) or an explicit sellPrice
            );
            ownedItems.sort((a, b) => (STATIC_ITEM_DB[a]?.rarity || 0) - (STATIC_ITEM_DB[b]?.rarity || 0));

            // --- 3. Render Items ---
            if (ownedItems.length > 0) {
                html += `<h4 class="text-center text-cyan-300 font-bold text-sm mb-2">Vật Phẩm Tiêu Hao (Máu/Mana/XP)</h4>`;
                html += ownedItems.map(id => {
                    const item = STATIC_ITEM_DB[id];
                    const owned = gameData.items[id] || 0;
                    // Calculate sell price: Use explicit sellPrice, or 40% of buyPrice
                    const price = item.sellPrice || Math.floor(item.buyPrice * 0.4); 
                    
                    return `
                    <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                        <div class="flex-grow">
                            <p class="font-bold text-sm ${getRarityClass(item.rarity)}">${item.name} (Đang có: ${owned})</p>
                            <p class="text-xs text-gray-300 mt-1">Giá: ${price} NL / món</p>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                             <!-- [MODIFIED] Call new function with type 'item' -->
                             <button onclick="sellListedItem('item', '${id}', 1)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-xs flex-shrink-0 w-1/3 sm:w-auto">
                                Bán 1
                            </button>
                            <button onclick="sellListedItem('item', '${id}', 10)" class="bg-green-800 hover:bg-green-900 text-white font-bold py-1 px-2 rounded text-xs flex-shrink-0 w-1/3 sm:w-auto">
                                Bán 10
                            </button>
                             <button onclick="sellListedItem('item', '${id}', 'all')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs flex-shrink-0 w-1/3 sm:w-auto">
                                Bán Hết
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
            }
            
            // --- 4. Render Materials ---
            if (ownedMaterials.length > 0) {
                html += `<h4 class="text-center text-cyan-300 font-bold text-sm mt-4 mb-2">Nguyên Liệu Chế Tác (Cá/Đá)</h4>`;
                html += ownedMaterials.map(id => {
                    const item = MATERIALS_DB[id];
                    const owned = gameData.materials[id] || 0;
                    const price = item.sellPrice;
                    
                    return `
                    <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                        <div class="flex-grow">
                            <p class="font-bold text-sm ${getRarityClass(item.rarity)}">${item.name} (Đang có: ${owned})</p>
                            <p class="text-xs text-gray-300 mt-1">Giá: ${price} NL / món</p>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                             <!-- [MODIFIED] Call new function with type 'material' -->
                             <button onclick="sellListedItem('material', '${id}', 1)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-xs flex-shrink-0 w-1/3 sm:w-auto">
                                Bán 1
                            </button>
                            <button onclick="sellListedItem('material', '${id}', 10)" class="bg-green-800 hover:bg-green-900 text-white font-bold py-1 px-2 rounded text-xs flex-shrink-0 w-1/3 sm:w-auto">
                                Bán 10
                            </button>
                             <button onclick="sellListedItem('material', '${id}', 'all')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs flex-shrink-0 w-1/3 sm:w-auto">
                                Bán Hết
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            if (html === '') {
                listContainer.innerHTML = `<p class="text-center text-gray-400">Không có vật phẩm nào để bán.</p>`;
                return;
            }
            
            listContainer.innerHTML = html;
        }
        
        // [MODIFIED] Renamed from sellMaterial and added itemType logic
        function sellListedItem(itemType, itemId, amount) {
            let itemDB, inventory, price;
            
            if (itemType === 'material') {
                itemDB = MATERIALS_DB[itemId];
                inventory = gameData.materials;
                price = itemDB?.sellPrice;
            } else { // 'item'
                itemDB = STATIC_ITEM_DB[itemId];
                inventory = gameData.items;
                price = itemDB?.sellPrice || Math.floor(itemDB?.buyPrice * 0.4);
            }

            if (!itemDB || !price) {
                showToast("Vật phẩm này không thể bán!", false); return;
            }

            const ownedAmount = inventory[itemId] || 0;
            let amountToSell = 0;

            if (amount === 'all') {
                amountToSell = ownedAmount;
            } else {
                amountToSell = parseInt(amount, 10);
                if (amountToSell > ownedAmount) {
                    amountToSell = ownedAmount;
                }
            }
            
            if (amountToSell <= 0) {
                showToast(`Không có ${itemDB.name} để bán.`, false); return;
            }

            const totalPrice = price * amountToSell;

            // Process transaction
            inventory[itemId] -= amountToSell;
            if (inventory[itemId] <= 0) {
                delete inventory[itemId]; // Remove from object if 0
            }
            gameData.nganLuong += totalPrice;
            
            showToast(`Đã bán ${itemDB.name} x${amountToSell} nhận ${totalPrice} NL.`, true);
            
            // Re-render sell list & exchange list
            renderMaterialSellList(); // This now renders both
            renderItemExchangeList(); // Items might be needed for exchange
        }

        // [NEW] Toggle Auto-Sell
        function toggleAutoSell(quality) {
            if (quality === 'common') {
                gameData.autoSell.common = document.getElementById('auto-sell-common').checked;
            } else if (quality === 'uncommon') {
                gameData.autoSell.uncommon = document.getElementById('auto-sell-uncommon').checked;
            }
                showToast(`Đã ${gameData.autoSell[quality] ? 'BẬT' : 'TẮT'} tự động bán đồ [${quality}].`, true);
        }

        // [DELETED] Đã xóa hàm 'calculateSellPrice' bị hỏng và trùng lặp ở đây.
        // Đây chính là nguyên nhân gây ra lỗi 'Unexpected end of input' và 'startGame is not defined'.
        // Hàm 'calculateSellPrice' chính xác đã được định nghĩa ở trên (khoảng dòng 1923).
        
        // --- [FIX] ADDED MISSING FUNCTIONS for Buying Consumables ---
        function renderBuyList() {
            const listContainer = document.getElementById('buy-item-list');
            if (!listContainer) return;

            // [MODIFIED] Lọc item: Có giá mua VÀ KHÔNG PHẢI là cuộn phù phép VÀ KHÔNG PHẢI là Đồ Phổ (blueprint)
            const buyableItems = Object.keys(STATIC_ITEM_DB).filter(id => 
                (STATIC_ITEM_DB[id].buyPrice || STATIC_ITEM_DB[id].mixCosts) && 
                STATIC_ITEM_DB[id].type !== 'enchant_scroll' &&
                STATIC_ITEM_DB[id].type !== 'blueprint' // [NEW] Ẩn Đồ Phổ ở đây để tránh trùng lặp với tab Thương Nhân
            );

            if (buyableItems.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-400">Không có vật phẩm nào đang bán.</p>`;
                return;
            }

            listContainer.innerHTML = buyableItems.map(id => {
                // ... (Giữ nguyên logic render cũ cho hàm này) ...
                const item = STATIC_ITEM_DB[id];
                const owned = gameData.items[id] || 0;
                
                // [NEW] Handle Mixed Cost Display
                let costDisplay = '';
                let buttonsHtml = '';
                
                if (item.mixCosts) {
                    const c = item.mixCosts;
                    const myUD = gameData.uyDanh || 0;
                    const myDV = gameData.danhVong || 0;
                    const myCH = gameData.diemCongHien || 0;
                    
                    const canAfford1 = (myUD >= c.uyDanh) && (myDV >= c.danhVong) && (myCH >= c.diemCongHien);
                    
                    costDisplay = `
                        <div class="text-xs grid grid-cols-1 gap-0.5 mt-1">
                            <span class="${myUD >= c.uyDanh ? 'text-purple-300' : 'text-red-400'}">${c.uyDanh.toLocaleString()} Uy Danh</span>
                            <span class="${myDV >= c.danhVong ? 'text-teal-300' : 'text-red-400'}">${c.danhVong.toLocaleString()} Danh Vọng</span>
                            <span class="${myCH >= c.diemCongHien ? 'text-lime-300' : 'text-red-400'}">${c.diemCongHien.toLocaleString()} Cống Hiến</span>
                        </div>
                    `;
                    
                    buttonsHtml = `
                        <button onclick="buyItem('${id}', 1)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-xs flex-shrink-0 ${!canAfford1 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford1 ? 'disabled' : ''}>
                            Mua 1
                        </button>
                    `;
                } else {
                    const price = item.buyPrice;
                    const currency = item.currency || 'nl';
                    
                    let currencyName = 'NL';
                    let currencyClass = 'text-gray-300';
                    let playerBalance = gameData.nganLuong;

                    if (currency === 'knb') {
                        currencyName = 'KNB';
                        currencyClass = 'text-yellow-300';
                        playerBalance = gameData.kimNguyenBao;
                    }

                    const canAfford1 = playerBalance >= price;
                    const canAfford10 = playerBalance >= price * 10;
                    
                    costDisplay = `<p class="text-xs ${currencyClass} mt-1">Giá: ${price.toLocaleString()} ${currencyName}</p>`;
                    
                    buttonsHtml = `
                        <div class="flex gap-2 w-full">
                            <button onclick="buyItem('${id}', 1)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-1/2 ${!canAfford1 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford1 ? 'disabled' : ''}>
                                Mua 1
                            </button>
                            <button onclick="buyItem('${id}', 10)" class="bg-green-800 hover:bg-green-900 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-1/2 ${!canAfford10 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford10 ? 'disabled' : ''}>
                                Mua 10
                            </button>
                        </div>
                    `;
                }
                
                return `
                <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2">
                            ${item.icon ? `<i class="${item.icon} text-xl ${getRarityClass(item.rarity)}"></i>` : ''}
                            <p class="font-bold text-sm ${getRarityClass(item.rarity)}">${item.name} <span class="text-gray-400 font-normal text-xs">(Có: ${owned})</span></p>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">${item.desc}</p>
                        ${costDisplay}
                    </div>
                    <div class="flex flex-col justify-center w-full sm:w-auto mt-2 sm:mt-0" style="min-width: 120px;">
                        ${buttonsHtml}
                    </div>
                </div>
                `;
            }).join('');
        }

        // [NEW] Render list for Enchant Scrolls ONLY
        function renderBuyScrollList() {
            const listContainer = document.getElementById('buy-scroll-list');
            if (!listContainer) return;

            // [MODIFIED] Filter ONLY enchant scrolls
            const scrollItems = Object.keys(STATIC_ITEM_DB).filter(id => 
                STATIC_ITEM_DB[id].type === 'enchant_scroll'
            );

            // Sort by rarity, then price
            scrollItems.sort((a, b) => {
                if (STATIC_ITEM_DB[a].rarity !== STATIC_ITEM_DB[b].rarity) {
                    return STATIC_ITEM_DB[a].rarity - STATIC_ITEM_DB[b].rarity;
                }
                return (STATIC_ITEM_DB[a].buyPrice || 0) - (STATIC_ITEM_DB[b].buyPrice || 0);
            });

            if (scrollItems.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-400">Không có cuộn phù phép nào đang bán.</p>`;
                return;
            }

            listContainer.innerHTML = scrollItems.map(id => {
                const item = STATIC_ITEM_DB[id];
                const owned = gameData.items[id] || 0;
                
                // [MODIFIED] Logic hiển thị giá (Hỗ trợ cả đơn giá và giá hỗn hợp)
                let costDisplay = '';
                let buttonsHtml = '';

                if (item.mixCosts) {
                    // --- HIỂN THỊ GIÁ HỖN HỢP (KNB + Danh Vọng...) ---
                    const c = item.mixCosts;
                    const myKNB = gameData.kimNguyenBao || 0;
                    const myDV = gameData.danhVong || 0;
                    const myUD = gameData.uyDanh || 0;
                    const myCH = gameData.diemCongHien || 0;

                    // Kiểm tra đủ tiền (mặc định hỗ trợ 4 loại, hiển thị những loại có trong mixCosts)
                    let canAfford1 = true;
                    let costHtmlParts = [];

                    if (c.kimNguyenBao) {
                        if (myKNB < c.kimNguyenBao) canAfford1 = false;
                        costHtmlParts.push(`<span class="${myKNB >= c.kimNguyenBao ? 'text-yellow-300' : 'text-red-400'}">${c.kimNguyenBao.toLocaleString()} KNB</span>`);
                    }
                    if (c.danhVong) {
                        if (myDV < c.danhVong) canAfford1 = false;
                        costHtmlParts.push(`<span class="${myDV >= c.danhVong ? 'text-teal-300' : 'text-red-400'}">${c.danhVong.toLocaleString()} DV</span>`);
                    }
                    if (c.uyDanh) {
                         if (myUD < c.uyDanh) canAfford1 = false;
                         costHtmlParts.push(`<span class="${myUD >= c.uyDanh ? 'text-purple-300' : 'text-red-400'}">${c.uyDanh.toLocaleString()} UD</span>`);
                    }
                    if (c.diemCongHien) {
                         if (myCH < c.diemCongHien) canAfford1 = false;
                         costHtmlParts.push(`<span class="${myCH >= c.diemCongHien ? 'text-lime-300' : 'text-red-400'}">${c.diemCongHien.toLocaleString()} ĐCH</span>`);
                    }

                    costDisplay = `<div class="text-xs mt-1 font-bold grid grid-cols-2 gap-x-2">${costHtmlParts.join('')}</div>`;

                    buttonsHtml = `
                        <button onclick="buyItem('${id}', 1)" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded text-xs flex-shrink-0 ${!canAfford1 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford1 ? 'disabled' : ''}>
                            Mua 1
                        </button>
                    `;

                } else {
                    // --- HIỂN THỊ ĐƠN GIÁ (Logic cũ) ---
                    const price = item.buyPrice;
                    const currency = item.currency || 'knb';
                    
                    let currencyName = 'KNB';
                    let currencyClass = 'text-yellow-300';
                    let playerBalance = gameData.kimNguyenBao;

                    if (currency === 'nl') {
                        currencyName = 'NL';
                        currencyClass = 'text-gray-300';
                        playerBalance = gameData.nganLuong;
                    }

                    const canAfford1 = playerBalance >= price;
                    const canAfford10 = playerBalance >= price * 10;

                    costDisplay = `<p class="text-xs ${currencyClass} mt-1 font-bold">Giá: ${price.toLocaleString()} ${currencyName}</p>`;
                    
                    buttonsHtml = `
                        <div class="flex flex-col justify-center gap-1 w-full sm:w-auto mt-2 sm:mt-0" style="min-width: 100px;">
                            <button onclick="buyItem('${id}', 1)" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded text-xs w-full ${!canAfford1 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford1 ? 'disabled' : ''}>
                                Mua 1
                            </button>
                            <button onclick="buyItem('${id}', 10)" class="bg-purple-800 hover:bg-purple-900 text-white font-bold py-1 px-3 rounded text-xs w-full ${!canAfford10 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford10 ? 'disabled' : ''}>
                                Mua 10
                            </button>
                        </div>
                    `;
                }

                // [NEW] Add effect class for higher rarities
                let effectClass = '';
                if (item.rarity >= 14) effectClass = 'text-rainbow-animation text-pulse-ascension-glow font-black tracking-widest';
                else if (item.rarity >= 12) effectClass = 'text-rainbow-animation text-pulse-void-glow font-extrabold';
                else if (item.rarity >= 10) effectClass = 'text-rainbow-animation';
                else if (item.rarity === 9) effectClass = 'text-pulse-glow';
                
                return `
                <div class="bg-gray-800 border border-gray-600 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2">
                            <i class="${item.icon} text-2xl ${getRarityClass(item.rarity)} ${effectClass}"></i>
                            <div>
                                <p class="font-bold text-sm ${getRarityClass(item.rarity)} ${effectClass}">${item.name}</p>
                                <p class="text-[10px] text-gray-400">Đang có: ${owned}</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">${item.desc}</p>
                        ${costDisplay}
                    </div>
                    <div class="flex-shrink-0 ml-2">
                        ${buttonsHtml}
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function buyItem(itemId, amount) {
            const item = STATIC_ITEM_DB[itemId];
            if (!item) {
                showToast("Vật phẩm không tồn tại!", false); return;
            }
            
            // [NEW] Check Rebirth Requirement
            if (item.rebirthReq !== undefined) {
                const playerRebirth = gameData.rebirthCount || 0;
                if (playerRebirth < item.rebirthReq) {
                    showToast(`Yêu cầu Trùng Sinh cấp ${item.rebirthReq} để mua vật phẩm này!`, false);
                    return;
                }
            }

            // [NEW] SPECIAL LOGIC FOR CRAFTING BLANKS (PHÔI TRANG BỊ & VŨ KHÍ & Y PHỤC)
            // Nếu mua Phôi, biến nó thành Trang Bị ngay lập tức
            // [MODIFIED] Thêm check cho crafting_blank_armor_white
            if (itemId === 'crafting_blank_white' || itemId === 'crafting_blank_weapon_white' || itemId === 'crafting_blank_armor_white') { 
                if (countInventorySlots() + amount > MAX_INVENTORY_SLOTS) {
                    showToast("Hành trang đã đầy! Không thể chứa thêm trang bị.", false); return;
                }
                
                const totalCost = item.buyPrice * amount;
                if (gameData.kimNguyenBao < totalCost) {
                    showToast("Không đủ Kim Nguyên Bảo!", false); return;
                }
                
                // Deduct Cost
                gameData.kimNguyenBao -= totalCost;
                
                // Generate Gear Items
                for (let i = 0; i < amount; i++) {
                    let newGear;

                    if (itemId === 'crafting_blank_white') {
                        // Phôi Trang Bị (Accessory)
                        newGear = {
                            uniqueId: crypto.randomUUID(),
                            baseId: 'crafting_blank_white', 
                            name: item.name, 
                            type: 'accessory', 
                            level: 1,
                            quality: 'supergodly', 
                            rarity: 11, 
                            upgradeLevel: 0,
                            affixes: [
                                { id: 'hp', name: 'Sinh Lực', value: 100, display: 'Sinh Lực +100', isPercent: false },
                                { id: 'mana', name: 'Nội Lực', value: 100, display: 'Nội Lực +100', isPercent: false },
                                { id: 'atk', name: 'Công Kích', value: 100, display: 'Công Kích +100', isPercent: false },
                                { id: 'def', name: 'Phòng Thủ', value: 100, display: 'Phòng Thủ +100', isPercent: false },
                                { id: 'atk_ky_p', name: 'Công Kỹ %', value: 1, display: 'Công Kỹ +1%', isPercent: true },
                                { id: 'xp_boost', name: 'Kinh Nghiệm %', value: 10, display: 'Kinh Nghiệm +10%', isPercent: true },
                                { id: 'lifesteal', name: 'Hút Sinh Lực', value: 1, display: 'Hút Sinh Lực 1%', isPercent: true },
                                { id: 'manasteal', name: 'Hút Nội Lực', value: 1, display: 'Hút Nội Lực 1%', isPercent: true }
                            ]
                        };
                    } else if (itemId === 'crafting_blank_weapon_white') {
                        // [NEW] Phôi Vũ Khí (Weapon)
                        newGear = {
                            uniqueId: crypto.randomUUID(),
                            baseId: 'crafting_blank_weapon_white', 
                            name: item.name, 
                            type: 'weapon', 
                            level: 1,
                            quality: 'supergodly', 
                            rarity: 11, 
                            upgradeLevel: 0,
                            // [MODIFIED] Cập nhật Affixes theo yêu cầu
                            affixes: [
                                { id: 'atk', name: 'Công Kích', value: 150, display: 'Công Kích +150', isPercent: false },
                                { id: 'atk_p', name: 'Công Kích %', value: 5, display: 'Công Kích +5%', isPercent: true },
                                { id: 'critDamage', name: 'ST Chí Mạng', value: 50, display: 'ST Chí Mạng +50%', isPercent: true },
                                { id: 'accuracy_p', name: 'Chính Xác', value: 5, display: 'Chính Xác +5%', isPercent: true },
                                { id: 'spd_p', name: 'Tốc Độ Đánh', value: 30, display: 'Tốc Độ Đánh +30%', isPercent: true },
                                { id: 'ignoreDef_p', name: 'Bỏ qua DEF', value: 5, display: 'Bỏ qua DEF +5%', isPercent: true },
                                { id: 'xp_boost', name: 'Kinh Nghiệm', value: 200, display: 'Kinh Nghiệm +200%', isPercent: true },
                                { id: 'skill_level', name: 'Kĩ năng vốn có', value: 2, display: 'Kĩ năng vốn có +2', isPercent: false } // Dòng hiển thị
                            ]
                        };
                    } else {
                        // [NEW] Phôi Y Phục (Armor)
                        newGear = {
                            uniqueId: crypto.randomUUID(),
                            baseId: 'crafting_blank_armor_white', 
                            name: item.name, 
                            type: 'armor', 
                            level: 1,
                            quality: 'supergodly', 
                            rarity: 11, 
                            upgradeLevel: 0,
                            affixes: [
                                { id: 'hp', name: 'Sinh Lực', value: 100, display: 'Sinh Lực +100', isPercent: false },
                                { id: 'hp_p', name: 'Sinh Lực %', value: 5, display: 'Sinh Lực +5%', isPercent: true },
                                { id: 'mana', name: 'Nội Lực', value: 100, display: 'Nội Lực +100', isPercent: false },
                                { id: 'mana_p', name: 'Nội Lực %', value: 5, display: 'Nội Lực +5%', isPercent: true },
                                { id: 'def', name: 'Phòng Thủ', value: 100, display: 'Phòng Thủ +100', isPercent: false },
                                { id: 'def_p', name: 'Phòng Thủ %', value: 5, display: 'Phòng Thủ +5%', isPercent: true },
                                { id: 'dodgeChance', name: 'Né Tránh', value: 2, display: 'Né Tránh +2%', isPercent: true },
                                { id: 'skill_level', name: 'Kĩ năng vốn có', value: 2, display: 'Kĩ năng vốn có +2', isPercent: false }
                            ]
                        };
                    }
                    
                    gameData.gearInventory.push(newGear);
                }
                
                showToast(`Đã mua ${amount} x ${item.name}! Kiểm tra Hành Trang.`, true);
                updateUI();
                
                // Refresh relevant views
                const nlEl = document.getElementById('tien-trang-nl');
                if(nlEl) nlEl.textContent = gameData.nganLuong;
                
                // Refresh inventory if open
                if (!document.getElementById('equipment-modal').classList.contains('hidden')) {
                     renderCollectionList('equipment');
                }
                
                return; // Stop here, don't run normal item logic
            }
            // [END NEW SPECIAL LOGIC]

            // [MODIFIED] Material type items like "Phôi" go to materials inventory, others to items
            const isMaterial = (item.type === 'material');
            const currentAmount = isMaterial ? (gameData.materials[itemId] || 0) : (gameData.items[itemId] || 0);

            // [MODIFIED] Stack limit check (allow higher limit for materials if needed)
            if (currentAmount + amount > MAX_STACK_SIZE) {
                showToast(`Không thể mua thêm, vượt quá ${MAX_STACK_SIZE} vật phẩm!`, false); return;
            }

            // [NEW] Handle Mixed Costs (e.g., Blueprints)
            if (item.mixCosts) {
                const c = item.mixCosts;
                const totalUD = c.uyDanh * amount;
                const totalDV = c.danhVong * amount;
                const totalCH = c.diemCongHien * amount;
                
                if ((gameData.uyDanh || 0) < totalUD) { showToast(`Thiếu ${totalUD - (gameData.uyDanh||0)} Uy Danh!`, false); return; }
                if ((gameData.danhVong || 0) < totalDV) { showToast(`Thiếu ${totalDV - (gameData.danhVong||0)} Danh Vọng!`, false); return; }
                if ((gameData.diemCongHien || 0) < totalCH) { showToast(`Thiếu ${totalCH - (gameData.diemCongHien||0)} Cống Hiến!`, false); return; }
                
                // Deduct
                gameData.uyDanh -= totalUD;
                gameData.danhVong -= totalDV;
                gameData.diemCongHien -= totalCH;
                
                // Add Item
                if (isMaterial) {
                     gameData.materials[itemId] = currentAmount + amount;
                } else {
                     gameData.items[itemId] = currentAmount + amount;
                }
                
                showToast(`Đã mua ${item.name} x${amount}!`, true);
                
            } else if (item.buyPrice) {
                // [MODIFIED] Handle Standard Cost (NL or KNB)
                const totalCost = item.buyPrice * amount;
                const currency = item.currency || 'nl';
                
                if (currency === 'knb') {
                    if (gameData.kimNguyenBao < totalCost) {
                        showToast("Không đủ Kim Nguyên Bảo!", false); return;
                    }
                    gameData.kimNguyenBao -= totalCost;
                    showToast(`Đã mua ${item.name} x${amount} với ${totalCost.toLocaleString()} KNB.`, true);
                } else {
                    if (gameData.nganLuong < totalCost) {
                        showToast("Không đủ Ngân Lượng!", false); return;
                    }
                    gameData.nganLuong -= totalCost;
                    showToast(`Đã mua ${item.name} x${amount} với ${totalCost.toLocaleString()} NL.`, true);
                }
                
                // Add Item
                if (isMaterial) {
                     gameData.materials[itemId] = currentAmount + amount;
                } else {
                     gameData.items[itemId] = currentAmount + amount;
                }
            } else {
                 showToast("Vật phẩm này không thể mua!", false); return;
            }
            
            // Re-render buy list to show new owned count
            renderBuyList();
            // Update main UI currency & quick slots
            updateUI();
            // Update currency in other tabs
            const nlEl = document.getElementById('tien-trang-nl');
            if(nlEl) nlEl.textContent = gameData.nganLuong; 
            
            // [NEW] Refresh Hoang Kim Panel if it's open (since user might have bought a blueprint or phoi)
            if (!document.getElementById('tho-ren-modal').classList.contains('hidden')) {
                 renderHoangKimPanel(); // Re-check blueprints
            }
        }
        // --- [END FIX] ---

        // --- [NEW] Equipment Buying Functions ---
        function renderBuyEquipmentList() {
            const listContainer = document.getElementById('buy-equip-list');
            if (!listContainer) return;

            const buyableItems = Object.keys(SHOP_EQUIPMENT_DB);

            if (buyableItems.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-400">Không có trang bị nào đang bán.</p>`;
                return;
            }

            listContainer.innerHTML = buyableItems.map(id => {
                const item = SHOP_EQUIPMENT_DB[id];
                const quality = QUALITY_DB[item.quality];
                const price = item.buyPrice;
                // [MODIFIED] Check currency type and set display name/class
                let currencyName = 'NL';
                let currencyClass = 'text-gray-300';
                if (item.currency === 'knb') {
                    currencyName = 'KNB';
                    currencyClass = 'text-yellow-300';
                } else if (item.currency === 'uyDanh') { // [NEW] Handle Uy Danh display
                    currencyName = 'Uy Danh';
                    currencyClass = 'text-purple-400';
                // [NEW] Handle PvP currencies
                } else if (item.currency === 'diemVinhDuLienDau') {
                    currencyName = 'Vinh Dự';
                    currencyClass = 'text-orange-400';
                } else if (item.currency === 'diemTichLuyTongKim') {
                    currencyName = 'Tích Lũy';
                    currencyClass = 'text-pink-400';
                }
                
                return `
                <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-grow">
                        <p class="font-bold text-sm ${quality.className}">${item.name} <span class="text-xs" style="color: ${quality.color};">[Cấp ${item.level}]</span></p>
                        <div class="text-xs text-gray-300 mt-1">
                            <!-- [MODIFIED] Apply color only if enchanted -->
                            ${item.affixes.map(affix => {
                                let colorClass = 'text-gray-300';
                                if (affix.isEnchant) colorClass = affix.rarityClass || 'text-green-400';
                                return `<span class="${colorClass}">${affix.display}</span>`;
                            }).join(', ')}
                        </div>
                    </div>
                    <button onclick="buyEquipment('${id}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0">
                        Mua (<span class="${currencyClass} font-bold">${price} ${currencyName}</span>)
                    </button>
                </div>
                `;
            }).join('');
        }

        // [MODIFIED] buyEquipment to handle Uy Danh
        function buyEquipment(itemId) {
            const itemTpl = SHOP_EQUIPMENT_DB[itemId];
            if (!itemTpl) {
                showToast("Vật phẩm này không thể mua!", false); return;
            }
            
            if (countInventorySlots() >= MAX_INVENTORY_SLOTS) {
                showToast("Hành trang đã đầy!", false); return;
            }
            
            const totalCost = itemTpl.buyPrice;
            const currencyType = itemTpl.currency || 'nl'; // Default to NL
            let currencyName = 'NL'; // For toast message

            // [MODIFIED] Check and deduct correct currency
            if (currencyType === 'knb') {
                if (gameData.kimNguyenBao < totalCost) {
                    showToast("Không đủ Kim Nguyên Bảo!", false); return;
                }
                gameData.kimNguyenBao -= totalCost;
                currencyName = 'KNB';
            } else if (currencyType === 'uyDanh') { // [NEW] Handle Uy Danh
                 if (gameData.uyDanh < totalCost) {
                    showToast("Không đủ điểm Uy Danh!", false); return;
                }
                gameData.uyDanh -= totalCost;
                currencyName = 'Uy Danh';
            // [NEW] Handle PvP currencies
            } else if (currencyType === 'diemVinhDuLienDau') {
                 if ((gameData.diemVinhDuLienDau || 0) < totalCost) {
                    showToast("Không đủ điểm Vinh Dự Liên Đấu!", false); return;
                }
                gameData.diemVinhDuLienDau -= totalCost;
                currencyName = 'Vinh Dự';
            } else if (currencyType === 'diemTichLuyTongKim') {
                 if ((gameData.diemTichLuyTongKim || 0) < totalCost) {
                    showToast("Không đủ điểm Tích Lũy Tống Kim!", false); return;
                }
                gameData.diemTichLuyTongKim -= totalCost;
                currencyName = 'Tích Lũy';
            } else { // Default to Ngân Lượng
                if (gameData.nganLuong < totalCost) {
                    showToast("Không đủ Ngân Lượng!", false); return;
                }
                gameData.nganLuong -= totalCost;
                currencyName = 'NL';
            }

            // Process transaction (Item creation remains the same)
            const newItem = {
                ...itemTpl,
                uniqueId: crypto.randomUUID(),
                affixes: JSON.parse(JSON.stringify(itemTpl.affixes)) // Deep copy affixes
            };
            delete newItem.buyPrice;
            delete newItem.currency;
            
            gameData.gearInventory.push(newItem);
            
            // [MODIFIED] Show correct toast using currencyName
            showToast(`Đã mua ${newItem.name} với ${totalCost} ${currencyName}.`, true);
            
            // Update currency in other tabs (Only if NL was spent)
            if (currencyType === 'nl') {
                const nlEl = document.getElementById('tien-trang-nl');
                if(nlEl) nlEl.textContent = gameData.nganLuong.toLocaleString(); // [MODIFIED] Format
            }
            // Update main UI (will update all currencies)
            updateUI();
            // Re-render buy list to potentially disable buttons if currency is low
            renderBuyEquipmentList(); 
        } 

        // --- [NEW] Item Exchange Functions ---
        
        // [NEW] Added missing function
        function renderItemExchangeList() {
            const listContainer = document.getElementById('item-exchange-list');
            if (!listContainer) return;

            const recipes = Object.keys(ITEM_EXCHANGE_DB);

            if (recipes.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-400">Chưa có công thức đổi vật phẩm nào.</p>`;
                return;
            }

            listContainer.innerHTML = recipes.map(id => {
                const recipe = ITEM_EXCHANGE_DB[id];
                let costHTML = '';
                let canAfford = true;

                recipe.cost.forEach(costItem => {
                    // Should only be materials for now
                    const itemDB = MATERIALS_DB[costItem.id];
                    const owned = gameData.materials[costItem.id] || 0;
                    const hasEnough = owned >= costItem.amount;
                    
                    if (!hasEnough) canAfford = false;
                    
                    costHTML += `<span class="text-xs ${hasEnough ? 'text-gray-300' : 'text-red-400'}">Yêu cầu: ${costItem.amount} x ${itemDB.name} (Có: ${owned})</span><br>`;
                });
                
                // Get reward item name
                let rewardItemDB;
                if (recipe.reward.type === 'item') {
                     rewardItemDB = STATIC_ITEM_DB[recipe.reward.id];
                } else {
                     rewardItemDB = MATERIALS_DB[recipe.reward.id];
                }
                const rewardName = rewardItemDB.name;
                const rewardAmount = recipe.reward.amount || 1;

                return `
                <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-grow">
                        <p class="font-bold text-sm text-yellow-300">${recipe.name}</p>
                        <p class="text-xs text-cyan-300 mt-1">Nhận: ${rewardAmount} x ${rewardName}</p>
                        <p class="text-xs text-gray-400 mt-1">${recipe.desc}</p>
                        <div class="text-xs text-gray-300 mt-1">${costHTML}</div>
                    </div>
                    <button onclick="performExchange('${id}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-full sm:w-auto mt-2 sm:mt-0 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        Đổi
                    </button>
                </div>
                `;
            }).join('');
        }

        // [NEW] Added missing function
        function performExchange(recipeId) {
            const recipe = ITEM_EXCHANGE_DB[recipeId];
            if (!recipe) {
                showToast("Không tìm thấy công thức!", false); return;
            }

            // 1. Check cost
            let canAfford = true;
            for (const costItem of recipe.cost) {
                const owned = (gameData.materials[costItem.id] || 0);
                if (owned < costItem.amount) {
                    canAfford = false;
                    break;
                }
            }

            if (!canAfford) {
                showToast("Không đủ nguyên liệu!", false);
                return;
            }

            // 2. Subtract cost
            for (const costItem of recipe.cost) {
                gameData.materials[costItem.id] -= costItem.amount;
                if (gameData.materials[costItem.id] <= 0) {
                    delete gameData.materials[costItem.id];
                }
            }
            
            // 3. Add reward
            let rewardName = '';
            if (recipe.reward.type === 'item') {
                const itemDB = STATIC_ITEM_DB[recipe.reward.id];
                rewardName = itemDB.name;
                addItem(recipe.reward.id, recipe.reward.amount, 'exchange');
            } else { // material
                const itemDB = MATERIALS_DB[recipe.reward.id];
                rewardName = itemDB.name;
                addMaterial(recipe.reward.id, recipe.reward.amount, 'exchange');
            }
            
            showToast(`Đã đổi thành công 1 x ${rewardName}!`, true);

            // 4. Re-render
            renderItemExchangeList();
            renderMaterialSellList(); // Ingredients were used
        }

        // [NEW] --- Menh Cach (Destiny) Functions ---

        /**
         * [NEW] Cập nhật UI cho tab Liệp Mệnh (số LHT, trạng thái nút)
         */
        function renderChieuMenhPanel() {
            const lhtDisplay = document.getElementById('chieu-menh-lht-display');
            if (lhtDisplay) {
                lhtDisplay.textContent = gameData.linhHonThach.toLocaleString();
            }

            // Vô hiệu hóa các nút nếu chưa đủ cấp
            const playerLevel = gameData.player.level;

            // Pool 1 (Cấp 20)
            const pool1Buttons = ['summon-btn-1', 'summon-btn-10'];
            pool1Buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (playerLevel < SUMMON_POOLS_DB['pool_1'].levelReq) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });

            // Pool 2 (Cấp 40)
            const pool2Buttons = ['summon-btn-2', 'summon-btn-20'];
            pool2Buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (playerLevel < SUMMON_POOLS_DB['pool_2'].levelReq) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });

            // Pool 3 (Cấp 60)
            const pool3Buttons = ['summon-btn-3', 'summon-btn-30'];
            pool3Buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (playerLevel < SUMMON_POOLS_DB['pool_3'].levelReq) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });
        }

        /**
         * [NEW] Quay ngẫu nhiên 1 Mệnh Cách từ 1 gói
         */
        function rollMenhCach(poolId) {
            const pool = SUMMON_POOLS_DB[poolId];
            const roll = Math.random() * 100;
            let cumulativeChance = 0;
            let chosenQuality = 'uncommon'; // Mặc định

            // 1. Xác định Phẩm chất
            for (const quality in pool.rates) {
                cumulativeChance += pool.rates[quality];
                if (roll <= cumulativeChance) {
                    chosenQuality = quality;
                    break;
                }
            }

            // 2. Lấy danh sách Mệnh Cách theo phẩm chất
            const availableMcIds = MENH_CACH_BY_QUALITY[chosenQuality];
            if (!availableMcIds || availableMcIds.length === 0) {
                // Fallback: Nếu không có Mệnh Cách phẩm chất đó (ví dụ: chưa định nghĩa Epic),
                // thử lại với phẩm chất thấp hơn
                if (chosenQuality === 'epic') chosenQuality = 'legendary';
                else if (chosenQuality === 'legendary') chosenQuality = 'rare';
                else chosenQuality = 'uncommon';
                
                // Lấy lại danh sách
                const fallbackIds = MENH_CACH_BY_QUALITY[chosenQuality];
                if (!fallbackIds || fallbackIds.length === 0) {
                    return 'mc_hung_001'; // Fallback an toàn nhất
                }
                // Chọn ngẫu nhiên từ danh sách fallback
                return fallbackIds[Math.floor(Math.random() * fallbackIds.length)];
            }
            
            // 3. Chọn ngẫu nhiên 1 Mệnh Cách từ danh sách
            return availableMcIds[Math.floor(Math.random() * availableMcIds.length)];
        }

        /**
         * [NEW] Thực hiện Chiêu Mệnh
         */
        function performSummon(poolId, amount) {
            const pool = SUMMON_POOLS_DB[poolId];
            if (!pool) {
                showToast("Lỗi: Gói chiêu mộ không tồn tại!", false); return;
            }

            // 1. Kiểm tra Cấp
            if (gameData.player.level < pool.levelReq) {
                showToast(`Cần Cấp ${pool.levelReq} để chiêu mộ!`, false); return;
            }

            // 2. Kiểm tra Chi phí
            const cost = (amount === 10) ? pool.cost_10 : pool.cost;
            if (gameData.linhHonThach < cost) {
                showToast("Không đủ Linh Hồn Thạch!", false); return;
            }

            // 3. Trừ chi phí
            gameData.linhHonThach -= cost;

            let results = [];
            let totalLhtGained = 0;
            let logMessages = []; // [NEW] Store log messages

            // 4. Quay và Xử lý
            for (let i = 0; i < amount; i++) {
                const mcId = rollMenhCach(poolId);
                const result = grantMenhCach(mcId);
                const mcDB = MENH_CACH_DB[mcId];
                const quality = QUALITY_DB[mcDB.quality];

                results.push(result);

                if (result.lhtGained > 0) {
                    totalLhtGained += result.lhtGained;
                    // [NEW] Log auto-sell
                    logMessages.push({
                        msg: `Nhận [Hung] <span class="${quality.className}">${mcDB.name}</span>, tự động bán +${result.lhtGained} LHT.`,
                        type: 'info' // Dùng màu xám
                    });
                } else if (result.added) {
                    // [NEW] Log item added
                    logMessages.push({
                        msg: `Nhận [Cát] <span class="${quality.className}">${mcDB.name}</span>!`,
                        type: 'reward' // Dùng màu xanh cyan
                    });
                }
            }
            
            // [NEW] Add batch log message
            if (amount > 1) {
                addSummonHistoryLog(`--- Thực hiện Chiêu Mộ x10 (Gói ${poolId}) ---`, 'system'); // Màu vàng
            } else {
                 addSummonHistoryLog(`--- Thực hiện Chiêu Mộ x1 (Gói ${poolId}) ---`, 'system'); // Màu vàng
            }

            // [NEW] Add individual log messages
            logMessages.forEach(log => {
                addSummonHistoryLog(log.msg, log.type);
            });

            // 5. Hoàn trả LHT (nếu có)
            if (totalLhtGained > 0) {
                gameData.linhHonThach += totalLhtGained;
                const msg = `Đã tự động bán Hung Mệnh, hoàn trả ${totalLhtGained} LHT.`;
                showToast(msg, true);
                addSummonHistoryLog(msg, 'system'); // [NEW] Log it
            }

            // 6. Hiển thị Kết quả
            const resultsPanel = document.getElementById('summon-results-panel');
            resultsPanel.innerHTML = results.map(res => {
                const mc = MENH_CACH_DB[res.id];
                const quality = QUALITY_DB[mc.quality];
                let textClass = quality.className;
                let bgColor = 'bg-gray-700';
                
                if (mc.type === 'hung') {
                    // Hiển thị mờ đi cho Hung Mệnh
                    textClass = 'text-gray-500';
                    bgColor = 'bg-gray-800 opacity-60';
                }

                return `
                    <div class="${bgColor} p-2 rounded" title="${mc.name}">
                        <i class="${mc.icon} text-2xl ${textClass}"></i>
                    </div>
                `;
            }).join('');

            // 7. Cập nhật UI
            renderChieuMenhPanel(); // Cập nhật số LHT
            renderSummonHistoryLog(); // [NEW] Cập nhật lịch sử
            renderMenhBanPanel(); // [NEW] Cập nhật kho
            updateUI(); // Cập nhật LHT ở panel chính
        }

        /**
         * [NEW] Xử lý Mệnh Cách quay được (Thêm vào kho hoặc bán)
         */
        function grantMenhCach(mcId) {
            const mc = MENH_CACH_DB[mcId];
            if (!mc) return { id: mcId, lhtGained: 0 }; // Lỗi
            if (!mc) return { id: mcId, lhtGained: 0, added: false }; // Lỗi

            // [LOGIC MỚI] Bán Hung Mệnh ngay lập tức
            if (mc.type === 'hung') {
                const lhtGained = mc.sellPrice || 0;
                return { id: mcId, lhtGained: lhtGained, added: false };
            }

            // [LOGIC MỚI] Thêm Cát Mệnh vào kho
            if (!gameData.menhCachInventory) {
                gameData.menhCachInventory = [];
            }
            
            // Tạo 1 bản sao (instance) của Mệnh Cách
            const mcInstance = {
                instanceId: crypto.randomUUID(),
                id: mcId,
                level: 1,
                xp: 0,
                xpToNext: getMenhCachXpToNext(1) // [NEW] Thêm XP tối đa
                // (Các chỉ số sẽ được lấy từ DB khi trang bị)
            };
            gameData.menhCachInventory.push(mcInstance);
            
            return { id: mcId, lhtGained: 0, added: true }; // [MODIFIED]
        }
        
        /**
         * [NEW] Bán tất cả Hung Mệnh trong KHO (Không phải kết quả)
         * Chức năng này sẽ được dùng cho Mệnh Bàn sau này,
         * hiện tại nó bán Hung Mệnh từ kết quả quay (Logic cũ)
         * -> [SỬA LẠI] Logic Bán Hung Mệnh đã được tích hợp vào performSummon.
         * Hàm này sẽ bán Hung Mệnh từ KHO (menhCachInventory)
         */
        function sellAllHungMenh() {
            if (!gameData.menhCachInventory || gameData.menhCachInventory.length === 0) {
                showToast("Không có Mệnh Cách nào trong kho.", false);
                return;
            }

            let lhtGained = 0;
            let itemsSold = 0;
            
            // Lọc ra danh sách mới, loại bỏ Hung Mệnh
            const newInventory = gameData.menhCachInventory.filter(mcInstance => {
                const mcDB = MENH_CACH_DB[mcInstance.id];
                if (mcDB.type === 'hung') {
                    lhtGained += (mcDB.sellPrice || 0);
                    itemsSold++;
                    return false; // Loại bỏ
                }
                return true; // Giữ lại
            });

            if (itemsSold === 0) {
                showToast("Trong kho không có Hung Mệnh nào để bán.", false);
                return;
            }

            // Cập nhật kho
            gameData.menhCachInventory = newInventory;
            gameData.linhHonThach += lhtGained;

            showToast(`Đã bán ${itemsSold} Hung Mệnh, nhận ${lhtGained} LHT!`, true);

            // Cập nhật UI
            renderChieuMenhPanel();
            renderMenhBanPanel(); // [NEW] Cập nhật kho
            updateUI();
            // (Sau này cần cập nhật cả Mệnh Bàn)
        }

        // [NEW] Adds a log message to the summon history (Styled like training-log)
        function addSummonHistoryLog(message, type = 'info') {
            if (!gameData.summonHistory) gameData.summonHistory = [];
            
            const timestamp = new Date().toLocaleTimeString();
            // Use the same log classes as training-log
            const logEntry = `<p class="log-${type}">${timestamp} - ${message}</p>`; 
            
            gameData.summonHistory.unshift(logEntry); // Add to the top
            if (gameData.summonHistory.length > MAX_LOG_LINES) gameData.summonHistory.pop(); // Trim old logs

            // Update the log display immediately
            renderSummonHistoryLog();
        }

        // [NEW] Renders the summon history log
        function renderSummonHistoryLog() {
            const logContainer = document.getElementById('summon-history-log');
            if (logContainer) {
                if (gameData.summonHistory && gameData.summonHistory.length > 0) {
                    logContainer.innerHTML = gameData.summonHistory.join('');
                } else {
                    logContainer.innerHTML = '<p class="log-info text-center">Chưa có lịch sử.</p>';
                }
                logContainer.scrollTop = 0; // Scroll to top
            }
        }

        // [NEW] Renders the Menh Ban (Destiny Board) and Inventory
        function renderMenhBanPanel() {
            const slotContainer = document.getElementById('menh-cach-equipped-slots'); // [MODIFIED] ID
            const inventoryContainer = document.getElementById('menh-cach-inventory-list');
            if (!slotContainer || !inventoryContainer) return; // [MODIFIED] Check both

            const unlockedSlots = gameData.menhCachUnlockedSlots || 1;
            const equippedSlots = gameData.equippedMenhCachSlots || Array(10).fill(null);

            // 1. Render Equipped Slots
            let slotHtml = '';
            for (let i = 0; i < 10; i++) {
                const instanceId = equippedSlots[i];
                if (i < unlockedSlots) {
                    // Ô đã mở
                    if (instanceId) {
                        const mcInstance = gameData.menhCachInventory.find(inv => inv.instanceId === instanceId);
                        const mcDB = mcInstance ? MENH_CACH_DB[mcInstance.id] : null;
                        if (mcDB) {
                            const quality = QUALITY_DB[mcDB.quality];
                            slotHtml += `
                                <div class="menh-cach-slot bg-gray-700 border-solid border-gray-500 cursor-pointer" 
                                     onclick="unequipMenhCach(${i})" 
                                     onmouseover="showTooltip(event, 'menh_cach', '${instanceId}')" 
                                     onmouseout="hideTooltip()">
                                    <i class="${mcDB.icon} ${quality.className}" title="${mcDB.name} (Cấp ${mcInstance.level})"></i>
                                    <span class="absolute bottom-1 right-1 text-xs font-bold text-white" style="text-shadow: 1px 1px 1px #000;">${mcInstance.level}</span>
                                    <!-- [NEW] XP BAR -->
                                    <div class="disciple-xp-bar-container" style="position: absolute; bottom: 2px; left: 2px; right: 2px; height: 0.5rem; background-color: #111827;">
                                        <div class="disciple-xp-bar-fill bg-yellow-500" style="width: ${mcInstance.level >= MAX_MENH_CACH_LEVEL ? 100 : (mcInstance.xp / mcInstance.xpToNext) * 100}%;"></div>
                                        <div class="disciple-xp-bar-text" style="font-size: 0.5rem; top: 45%;">${mcInstance.level >= MAX_MENH_CACH_LEVEL ? 'MAX' : `${mcInstance.xp}/${mcInstance.xpToNext}`}</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Lỗi: instanceId tồn tại nhưng không tìm thấy Mệnh Cách (dữ liệu hỏng)
                            gameData.equippedMenhCachSlots[i] = null; // Tự sửa lỗi
                            slotHtml += `<div class="menh-cach-slot border-dashed border-gray-600" onclick="showToast('Ô trống, hãy trang bị từ kho.', true)"><i class="fa-solid fa-plus text-gray-600"></i></div>`;
                        }
                    } else {
                        // Ô trống
                        slotHtml += `<div class="menh-cach-slot border-dashed border-gray-600" onclick="showToast('Ô trống, hãy trang bị từ kho.', true)"><i class="fa-solid fa-plus text-gray-600"></i></div>`;
                    }
                } else {
                    // Ô bị khóa
                    slotHtml += `<div class="menh-cach-slot"><i class="fa-solid fa-lock text-gray-600"></i></div>`;
                }
            }
            slotContainer.innerHTML = slotHtml;

            // 2. Render Inventory List
            const equippedInstanceIds = new Set(equippedSlots.filter(id => id));
            // [FIX] Lọc cả Hung Mệnh ra khỏi kho (vì chúng đã bị bán tự động)
            const inventoryItems = gameData.menhCachInventory.filter(
                mcInstance => {
                    const mcDB = MENH_CACH_DB[mcInstance.id];
                    return mcDB.type === 'cat' && !equippedInstanceIds.has(mcInstance.instanceId);
                }
            );
            
            // Sắp xếp: Phẩm chất (cao -> thấp), Cấp (cao -> thấp)
            inventoryItems.sort((a, b) => {
                const qualityA = Object.keys(QUALITY_DB).indexOf(MENH_CACH_DB[a.id].quality);
                const qualityB = Object.keys(QUALITY_DB).indexOf(MENH_CACH_DB[b.id].quality);
                if (qualityB !== qualityA) return qualityB - qualityA;
                return b.level - a.level;
            });

            if (inventoryItems.length === 0) {
                inventoryContainer.innerHTML = `<p class="text-gray-500 text-center col-span-full">Kho Mệnh Cách trống.</p>`;
            } else {
                inventoryContainer.innerHTML = inventoryItems.map(mcInstance => {
                    const mcDB = MENH_CACH_DB[mcInstance.id];
                    const quality = QUALITY_DB[mcDB.quality];
                    const sellPrice = mcDB.sellPrice || 50; // Giá bán mặc định
                    const xpPercent = mcInstance.level >= MAX_MENH_CACH_LEVEL ? 100 : (mcInstance.xp / mcInstance.xpToNext) * 100;

                    return `
                    <div class="bg-gray-800 p-3 rounded-lg text-center flex flex-col justify-between">
                        <div onmouseover="showTooltip(event, 'menh_cach', '${mcInstance.instanceId}')" onmouseout="hideTooltip()">
                            <i class="${mcDB.icon} text-4xl ${quality.className} mb-1"></i>
                            <p class="font-bold text-sm ${quality.className} truncate">${mcDB.name}</p>
                            <p class="text-xs text-gray-300">Cấp ${mcInstance.level}</p>
                        </div>
                        
                        <!-- [MODIFIED] XP BAR - Taller with bigger text -->
                        <div class="disciple-xp-bar-container" style="height: 1rem; margin-top: 6px; margin-bottom: 6px; background-color: #111827;">
                            <div class="disciple-xp-bar-fill bg-yellow-500" style="width: ${xpPercent}%;"></div>
                            <div class="disciple-xp-bar-text" style="font-size: 0.7rem; top: 50%;">${mcInstance.level >= MAX_MENH_CACH_LEVEL ? 'MAX' : `${mcInstance.xp}/${mcInstance.xpToNext}`}</div>
                        </div>
                        
                        <!-- [MODIFIED] Button Group -->
                        <div class="mt-2 flex flex-col gap-1.5">
                            <button onclick="equipMenhCach('${mcInstance.instanceId}')" class="w-full text-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-2 rounded">
                                Trang Bị
                            </button>
                            <div class="flex gap-1.5 w-full">
                                <button onclick="upgradeMenhCach('${mcInstance.instanceId}', 1)" class="flex-1 text-xs bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-2 rounded" title="Nâng cấp 1 lần (100 LHT)">
                                    +1
                                </button>
                                <button onclick="upgradeMenhCach('${mcInstance.instanceId}', 10)" class="flex-1 text-xs bg-green-700 hover:bg-green-800 text-white font-bold py-1.5 px-2 rounded" title="Nâng cấp 10 lần (950 LHT)">
                                    +10
                                </button>
                                <button onclick="sellMenhCach('${mcInstance.instanceId}')" class="text-xs bg-red-700 hover:bg-red-800 text-white font-bold py-1.5 px-2 rounded" title="Bán (${sellPrice} LHT)">
                                    <i class="fa-solid fa-dollar-sign"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }
        }

        /**
         * [NEW] Trang bị Mệnh Cách
         */
        function equipMenhCach(instanceId) {
            // 1. Tìm ô trống
            const unlockedSlots = gameData.menhCachUnlockedSlots || 1;
            let freeSlotIndex = -1;
            for (let i = 0; i < unlockedSlots; i++) {
                if (gameData.equippedMenhCachSlots[i] === null) {
                    freeSlotIndex = i;
                    break;
                }
            }

            if (freeSlotIndex === -1) {
                showToast("Không còn ô Mệnh Bàn trống!", false);
                return;
            }

            // 2. Trang bị
            gameData.equippedMenhCachSlots[freeSlotIndex] = instanceId;

            // 3. Cập nhật UI
            renderMenhBanPanel();
            // [MODIFIED] Kích hoạt cập nhật chỉ số
            updateUI(); // Gọi updateUI để tính toán lại chỉ số
            showToast("Trang bị Mệnh Cách thành công!", true);
        }

        /**
         * [NEW] Gỡ Mệnh Cách
         */
        function unequipMenhCach(slotIndex) {
            const instanceId = gameData.equippedMenhCachSlots[slotIndex];
            if (!instanceId) return; // Ô trống

            // 1. Gỡ
            gameData.equippedMenhCachSlots[slotIndex] = null;
            
            // 2. Cập nhật UI
            renderMenhBanPanel();
            // [MODIFIED] Kích hoạt cập nhật chỉ số
            updateUI(); // Gọi updateUI để tính toán lại chỉ số
            showToast("Gỡ Mệnh Cách thành công!", true);
        }

        /**
         * [NEW] Nâng cấp Mệnh Cách (Cường Hóa)
         */
        function upgradeMenhCach(instanceId, amountStr) {
            const mcInstance = gameData.menhCachInventory.find(inv => inv.instanceId === instanceId);
            if (!mcInstance) {
                showToast("Lỗi: Không tìm thấy Mệnh Cách!", false);
                return;
            }

            const mcDB = MENH_CACH_DB[mcInstance.id];
            if (mcInstance.level >= MAX_MENH_CACH_LEVEL) {
                showToast(`[${mcDB.name}] đã đạt cấp tối đa!`, false);
                return;
            }

            const amount = parseInt(amountStr, 10) || 1;
            // const XP_PER_LHT = 10; // [REMOVED] Tỉ lệ đã thay đổi
            
            let totalLhtCost = 0;
            let totalXpGain = 0;

            if (amount === 10) {
                totalLhtCost = 950;
                totalXpGain = 950; // [MODIFIED] 950 LHT = 950 XP
            } else {
                // Mặc định là 1 lần
                totalLhtCost = 100;
                totalXpGain = 100; // [MODIFIED] 100 LHT = 100 XP
            }

            if (gameData.linhHonThach < totalLhtCost) {
                showToast(`Không đủ ${totalLhtCost} Linh Hồn Thạch!`, false);
                return;
            }

            // Trừ LHT và thêm XP
            gameData.linhHonThach -= totalLhtCost;
            mcInstance.xp += totalXpGain;
            
            let levelUps = 0;

            // Xử lý lên cấp
            while (mcInstance.xp >= mcInstance.xpToNext) {
                if (mcInstance.level >= MAX_MENH_CACH_LEVEL) {
                    mcInstance.level = MAX_MENH_CACH_LEVEL;
                    mcInstance.xp = 0;
                    mcInstance.xpToNext = Infinity;
                    break; 
                }
                
                levelUps++;
                mcInstance.level++;
                mcInstance.xp -= mcInstance.xpToNext;
                mcInstance.xpToNext = getMenhCachXpToNext(mcInstance.level);
                
                if (mcInstance.level >= MAX_MENH_CACH_LEVEL) {
                    mcInstance.level = MAX_MENH_CACH_LEVEL;
                    mcInstance.xp = 0;
                    mcInstance.xpToNext = Infinity;
                    break;
                }
            }
            
            // Thông báo
            let msg = `Đã dùng ${totalLhtCost} LHT, [${mcDB.name}] nhận ${totalXpGain} XP.`;
            if (levelUps > 0) {
                msg += ` Thăng lên Cấp ${mcInstance.level}!`;
                showToast(msg, true); // Chỉ toast khi thăng cấp
                updateUI(); // Cập nhật chỉ số tổng nếu thăng cấp
            }
            
            // Cập nhật UI (luôn luôn)
            renderMenhBanPanel();
            renderChieuMenhPanel(); // Cập nhật LHT
            document.getElementById('linhhonthach-display').textContent = gameData.linhHonThach; // Cập nhật LHT ở main UI
        }

        /**
         * [NEW] Bán (Phân giải) Cát Mệnh từ kho
         */
        function sellMenhCach(instanceId) {
            const index = gameData.menhCachInventory.findIndex(inv => inv.instanceId === instanceId);
            if (index === -1) {
                showToast("Lỗi: Không tìm thấy Mệnh Cách!", false);
                return;
            }
            
            const mcInstance = gameData.menhCachInventory[index];
            const mcDB = MENH_CACH_DB[mcInstance.id];
            
            // Tính LHT nhận lại (Giá gốc + 10% giá trị XP đã đầu tư - ví dụ)
            const baseSellPrice = mcDB.sellPrice || 50;
            const xpValue = Math.floor((mcInstance.xp || 0) * 0.1); // Giả sử 1 XP = 0.1 LHT
            const lhtGained = baseSellPrice + xpValue;

            // 1. Xóa khỏi kho
            gameData.menhCachInventory.splice(index, 1);
            
            // 2. Thêm LHT
            gameData.linhHonThach += lhtGained;

            showToast(`Đã bán [${mcDB.name}] nhận ${lhtGained} LHT!`, true);

            // 3. Cập nhật UI
            renderMenhBanPanel();
            renderChieuMenhPanel();
            updateUI();
        }

        // [END NEW] --- Menh Cach (Destiny) Functions ---

        // [NEW] --- Blacksmith Functions (Thợ Rèn) ---
        
        // --- Tab Switching ---
        function switchThoRenTab(tabId) {
            const modal = document.getElementById('tho-ren-modal');
            if (!modal) return;
            
            modal.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                // Reset all buttons
                if (btn.id === 'tab-hoang-kim') {
                     btn.classList.remove('text-yellow-500', 'border-yellow-500');
                     btn.classList.add('text-yellow-700'); // Dimmed yellow
                     btn.style.textShadow = 'none';
                } else {
                    btn.classList.remove('tab-active', 'text-yellow-400');
                    btn.classList.add('text-gray-400');
                }
            });
            
            const panel = document.getElementById(`panel-${tabId}`);
            const tab = document.getElementById(`tab-${tabId}`);
            
            if (panel) panel.classList.remove('hidden');
            if (tab) {
                if (tabId === 'hoang-kim') {
                    tab.classList.remove('text-yellow-700');
                    tab.classList.add('text-yellow-500', 'border-b-2', 'border-yellow-500');
                    tab.style.textShadow = '0 0 10px rgba(234, 179, 8, 0.8)';
                } else {
                    tab.classList.add('tab-active', 'text-yellow-400');
                    tab.classList.remove('text-gray-400');
                }
            }
            
            // Reset selection when switching tabs
            if (tabId === 'cuong-hoa') {
                renderUpgradePanel(); // Re-render to clear selection
            } else if (tabId === 'che-tao') {
                renderCraftingList();
            } else if (tabId === 'tinh-phach') { // [NEW] Thêm logic cho tab Tinh Phách
                renderTinhPhachPanel();
            } else if (tabId === 'phu-phep') { // [NEW] Logic cho tab Phù Phép (Placeholder)
                renderPhuPhepPanel();
            } else if (tabId === 'hoang-kim') { // [NEW] Logic cho tab Hoàng Kim
                renderHoangKimPanel();
            }
        }

        // [NEW] Render function for Phù Phép
        function renderPhuPhepPanel() {
            const panel = document.getElementById('panel-phu-phep');
            if (!panel) return;

            // Layout 3 cột: Chọn Trang Bị - Khu Vực Ép - Chọn Cuộn
            panel.innerHTML = `
                <h4 class="text-lg font-bold text-cyan-400 mb-2 text-center">Phù Phép Trang Bị</h4>
                <p class="text-center text-gray-400 mb-4 text-sm">Thêm dòng thuộc tính đặc biệt cho trang bị. Mỗi trang bị chỉ có thể có 1 dòng Phù Phép (sẽ ghi đè dòng cũ).</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full" style="height: 60vh;">
                    <!-- Cột 1: Chọn Trang Bị -->
                    <div class="bg-black/20 backdrop-blur-sm border border-gray-700 p-3 rounded-lg flex flex-col overflow-hidden">
                        <h5 class="font-bold text-cyan-400 text-center mb-2 border-b border-gray-700 pb-2 flex-shrink-0">1. Chọn Trang Bị</h5>
                        <div id="enchant-equip-list" class="space-y-2 flex-grow overflow-y-auto scrollbar-thin"></div>
                    </div>

                    <!-- Cột 2: Center Action -->
                    <div class="flex flex-col items-center justify-center space-y-4 py-4 bg-black/10 rounded-lg border border-gray-800">
                         <!-- Slot Trang Bị -->
                         <div id="enchant-slot-equip" class="w-24 h-24 bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center relative transition">
                            <i class="fa-solid fa-shirt text-3xl text-gray-600"></i>
                            <span class="text-xs text-gray-500 mt-1">Trang Bị</span>
                         </div>
                         
                         <i class="fa-solid fa-plus text-xl text-gray-500"></i>
                         
                         <!-- Slot Cuộn -->
                         <div id="enchant-slot-scroll" class="w-24 h-24 bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center relative transition">
                            <i class="fa-solid fa-scroll text-3xl text-gray-600"></i>
                             <span class="text-xs text-gray-500 mt-1">Cuộn Giấy</span>
                         </div>
                         
                         <div id="enchant-preview" class="text-center h-8 text-sm font-bold text-green-400"></div>

                         <button id="btn-perform-enchant" onclick="performEnchant()" class="w-3/4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg opacity-50 cursor-not-allowed transition transform hover:scale-105" disabled>
                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Phù Phép
                         </button>
                         <p class="text-xs text-gray-400">Phí: 10,000 Ngân Lượng</p>
                    </div>

                    <!-- Cột 3: Chọn Cuộn -->
                    <div class="bg-black/20 backdrop-blur-sm border border-gray-700 p-3 rounded-lg flex flex-col overflow-hidden">
                        <h5 class="font-bold text-yellow-300 text-center mb-2 border-b border-gray-700 pb-2 flex-shrink-0">2. Chọn Cuộn Phù Phép</h5>
                        <div id="enchant-scroll-list" class="space-y-2 flex-grow overflow-y-auto scrollbar-thin"></div>
                    </div>
                </div>
            `;
            
            renderEnchantLists();
            updateEnchantCenterUI();
        }

        function renderEnchantLists() {
            const equipContainer = document.getElementById('enchant-equip-list');
            const scrollContainer = document.getElementById('enchant-scroll-list');
            
            if (!equipContainer || !scrollContainer) return;

            // 1. Render Equip List (Filter out equipped items for safety/simplicity, or allow all)
            // Cho phép phù phép cả đồ đang mặc
            const allGear = gameData.gearInventory;
            
            if (allGear.length === 0) {
                equipContainer.innerHTML = `<p class="text-center text-gray-500 text-xs mt-4">Hành trang trống.</p>`;
            } else {
                // Sort: Equipped -> Quality -> Level
                const sortedGear = [...allGear].sort((a, b) => {
                    const isEquippedA = Object.values(gameData.equippedSlots).includes(a.uniqueId);
                    const isEquippedB = Object.values(gameData.equippedSlots).includes(b.uniqueId);
                    if (isEquippedA !== isEquippedB) return isEquippedB - isEquippedA;
                    return 0;
                });

                equipContainer.innerHTML = sortedGear.map(item => {
                    const quality = QUALITY_DB[item.quality];
                    const isSelected = item.uniqueId === selectedEnchantEquipId;
                    const isEquipped = Object.values(gameData.equippedSlots).includes(item.uniqueId);
                    const upgradeText = item.upgradeLevel > 0 ? ` [+${item.upgradeLevel}]` : '';
                    
                    // Check if item has enchantment
                    const hasEnchant = item.affixes.some(a => a.isEnchant);
                    
                    return `
                    <div onclick="selectEnchantEquip('${item.uniqueId}')" class="bg-gray-700 rounded p-2 mb-2 cursor-pointer hover:bg-gray-600 flex justify-between items-center ${isSelected ? 'border-2 border-cyan-400' : ''}">
                        <div>
                            <p class="font-bold text-xs ${quality.className}">${item.name}${upgradeText} ${isEquipped ? '<span class="text-green-400">(Đang mặc)</span>' : ''}</p>
                            <p class="text-[10px]" style="color: ${quality.color};">[Cấp ${item.level}] ${hasEnchant ? '<span class="text-green-300">Đã Phù Phép</span>' : ''}</p>
                        </div>
                        ${isSelected ? '<i class="fa-solid fa-check text-cyan-400"></i>' : ''}
                    </div>
                    `;
                }).join('');
            }

            // 2. Render Scroll List
            const ownedScrolls = Object.keys(gameData.items).filter(id => 
                gameData.items[id] > 0 && 
                STATIC_ITEM_DB[id] && 
                STATIC_ITEM_DB[id].type === 'enchant_scroll'
            );

            if (ownedScrolls.length === 0) {
                scrollContainer.innerHTML = `<p class="text-center text-gray-500 text-xs mt-4">Không có cuộn phù phép.</p>`;
            } else {
                scrollContainer.innerHTML = ownedScrolls.map(id => {
                    const item = STATIC_ITEM_DB[id];
                    const count = gameData.items[id];
                    const isSelected = id === selectedEnchantScrollId;
                    const rarityClass = getRarityClass(item.rarity);
                    
                    return `
                    <div onclick="selectEnchantScroll('${id}')" class="bg-gray-700 rounded p-2 mb-2 cursor-pointer hover:bg-gray-600 flex justify-between items-center ${isSelected ? 'border-2 border-purple-400' : ''}">
                        <div>
                            <p class="font-bold text-xs ${rarityClass}">${item.name}</p>
                            <p class="text-[10px] text-gray-400">Số lượng: ${count}</p>
                        </div>
                        ${isSelected ? '<i class="fa-solid fa-check text-purple-400"></i>' : ''}
                    </div>
                    `;
                }).join('');
            }
        }

        function selectEnchantEquip(id) {
            selectedEnchantEquipId = (selectedEnchantEquipId === id) ? null : id;
            renderEnchantLists();
            updateEnchantCenterUI();
        }

        function selectEnchantScroll(id) {
            selectedEnchantScrollId = (selectedEnchantScrollId === id) ? null : id;
            renderEnchantLists();
            updateEnchantCenterUI();
        }

        function updateEnchantCenterUI() {
            const equipSlot = document.getElementById('enchant-slot-equip');
            const scrollSlot = document.getElementById('enchant-slot-scroll');
            const previewEl = document.getElementById('enchant-preview');
            const btn = document.getElementById('btn-perform-enchant');
            
            let item = null;
            let scroll = null;

            // Update Equip Slot
            if (selectedEnchantEquipId) {
                item = gameData.gearInventory.find(i => i.uniqueId === selectedEnchantEquipId);
                if (item) {
                    const quality = QUALITY_DB[item.quality];
                    equipSlot.innerHTML = `
                        <div class="text-center">
                            <i class="fa-solid fa-shirt text-3xl ${quality.className}"></i>
                            <p class="text-[10px] mt-1 ${quality.className} truncate w-20">${item.name}</p>
                        </div>
                    `;
                    equipSlot.className = "w-24 h-24 bg-gray-800 border-2 border-cyan-400 rounded-lg flex flex-col items-center justify-center relative transition";
                }
            } else {
                equipSlot.innerHTML = `<i class="fa-solid fa-shirt text-3xl text-gray-600"></i><span class="text-xs text-gray-500 mt-1">Trang Bị</span>`;
                equipSlot.className = "w-24 h-24 bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center relative transition";
            }

            // Update Scroll Slot
            if (selectedEnchantScrollId) {
                scroll = STATIC_ITEM_DB[selectedEnchantScrollId];
                if (scroll) {
                     const rarityClass = getRarityClass(scroll.rarity);
                     scrollSlot.innerHTML = `
                        <div class="text-center">
                            <i class="fa-solid fa-scroll text-3xl ${rarityClass}"></i>
                            <p class="text-[10px] mt-1 ${rarityClass} truncate w-20">${scroll.name}</p>
                        </div>
                    `;
                    scrollSlot.className = "w-24 h-24 bg-gray-800 border-2 border-purple-400 rounded-lg flex flex-col items-center justify-center relative transition";
                }
            } else {
                scrollSlot.innerHTML = `<i class="fa-solid fa-scroll text-3xl text-gray-600"></i><span class="text-xs text-gray-500 mt-1">Cuộn Giấy</span>`;
                scrollSlot.className = "w-24 h-24 bg-gray-800 border-2 border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center relative transition";
            }

            // Update Button & Preview
            if (item && scroll) {
                // [FIXED] Handle both single stat and multiple stats
                let previewText = "Sẽ thêm: ";
                
                if (scroll.stats && Array.isArray(scroll.stats)) {
                    // Multi-stat scroll
                    const parts = scroll.stats.map(s => {
                        const val = s.isPercent ? `+${s.value}%` : `+${s.value}`;
                        return `${s.name} ${val}`;
                    });
                    previewText += parts.join(', ');
                } else if (scroll.stat) {
                    // Single stat
                    const stat = scroll.stat;
                    const displayVal = stat.isPercent ? `+${stat.value}%` : `+${stat.value}`;
                    previewText += `${stat.name} ${displayVal}`;
                }
                
                // [MODIFIED] Cho phép text dài xuống dòng
                previewEl.innerHTML = `<span class="text-xs leading-tight block overflow-y-auto max-h-16">${previewText}</span>`;
                
                const cost = 10000;
                if (gameData.nganLuong >= cost) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    previewEl.innerHTML = `<span class="text-red-500">Thiếu Ngân Lượng!</span>`;
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                previewEl.innerHTML = '';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function performEnchant() {
            if (!selectedEnchantEquipId || !selectedEnchantScrollId) return;
            
            const item = gameData.gearInventory.find(i => i.uniqueId === selectedEnchantEquipId);
            const scroll = STATIC_ITEM_DB[selectedEnchantScrollId];
            const cost = 10000;

            if (gameData.nganLuong < cost) {
                showToast("Không đủ Ngân Lượng!", false); return;
            }
            if (gameData.items[selectedEnchantScrollId] <= 0) {
                 showToast("Đã hết cuộn phù phép!", false); return;
            }

            // 1. Deduct cost & item
            gameData.nganLuong -= cost;
            gameData.items[selectedEnchantScrollId]--;
            if (gameData.items[selectedEnchantScrollId] <= 0) delete gameData.items[selectedEnchantScrollId];

            // 2. Apply Enchantment
            // Xóa TOÀN BỘ dòng enchant cũ (nếu có)
            item.affixes = item.affixes.filter(affix => !affix.isEnchant);
            
            // [FIXED] Support adding multiple stats or single stat
            const statsToAdd = [];
            
            if (scroll.stats && Array.isArray(scroll.stats)) {
                // Multi-stat scroll
                scroll.stats.forEach(s => statsToAdd.push(s));
            } else if (scroll.stat) {
                // Single-stat scroll
                statsToAdd.push(scroll.stat);
            }
            
            // [NEW] Get color class based on scroll rarity
            const rarityClass = getRarityClass(scroll.rarity);

            statsToAdd.forEach(statData => {
                const displayVal = statData.isPercent ? `+${statData.value}%` : `+${statData.value}`;
                item.affixes.push({
                    id: statData.id,
                    name: statData.name,
                    value: statData.value,
                    isPercent: statData.isPercent,
                    display: `[Phù Phép] ${statData.name} ${displayVal}`, // [Phù Phép] Tiền tố
                    isEnchant: true, // Flag đánh dấu
                    rarityClass: rarityClass // [NEW] Store color
                });
            });

            showToast("Phù phép thành công!", true);
            
            // 3. Refresh
            selectedEnchantEquipId = null;
            selectedEnchantScrollId = null;
            updateUI();
            renderPhuPhepPanel();
        }

        // [NEW] Render function for Hoàng Kim (Actual Implementation)
        function renderHoangKimPanel() {
            const listContainerEquip = document.getElementById('hoang-kim-equip-list');
            const listContainerBlueprint = document.getElementById('hoang-kim-blueprint-list');
            
            if (!listContainerEquip || !listContainerBlueprint) return;
            
            // --- 1. Render Equipment List ---
            const allEquippedIds = Object.values(gameData.equippedSlots);
            // Filter: Not equipped. Include ALL qualities (including common/white).
            const availableGear = gameData.gearInventory.filter(i => !allEquippedIds.includes(i.uniqueId));
            
            // Sort by quality then level
            availableGear.sort((a, b) => {
                 const qualityA = Object.keys(QUALITY_DB).indexOf(a.quality);
                 const qualityB = Object.keys(QUALITY_DB).indexOf(b.quality);
                 if (qualityA !== qualityB) return qualityA - qualityB;
                 return b.level - a.level;
            });

            if (availableGear.length === 0) {
                listContainerEquip.innerHTML = `<p class="text-center text-gray-500 text-xs mt-4">Không có trang bị nào trong hành trang.</p>`;
            } else {
                listContainerEquip.innerHTML = availableGear.map(item => {
                    const quality = QUALITY_DB[item.quality];
                    const isSelected = item.uniqueId === selectedHoangKimEquipId;
                    const upgradeText = item.upgradeLevel > 0 ? ` [+${item.upgradeLevel}]` : '';
                    
                    return `
                    <div onclick="selectHoangKimEquip('${item.uniqueId}')" class="bg-gray-700 rounded p-2 mb-2 cursor-pointer hover:bg-gray-600 flex justify-between items-center ${isSelected ? 'border-2 border-yellow-400' : ''}">
                        <div>
                            <p class="font-bold text-xs ${quality.className}">${item.name}${upgradeText}</p>
                            <p class="text-[10px]" style="color: ${quality.color};">[Cấp ${item.level}]</p>
                        </div>
                        ${isSelected ? '<i class="fa-solid fa-check text-green-400"></i>' : ''}
                    </div>
                    `;
                }).join('');
            }

            // --- 2. Render Blueprint List ---
            const ownedBlueprints = Object.keys(gameData.items).filter(id => 
                gameData.items[id] > 0 && 
                STATIC_ITEM_DB[id] && 
                STATIC_ITEM_DB[id].type === 'blueprint'
            );

            if (ownedBlueprints.length === 0) {
                listContainerBlueprint.innerHTML = `<p class="text-center text-gray-500 text-xs mt-4">Chưa sở hữu Đồ Phổ.</p>`;
            } else {
                listContainerBlueprint.innerHTML = ownedBlueprints.map(id => {
                    const item = STATIC_ITEM_DB[id];
                    const count = gameData.items[id];
                    const isSelected = id === selectedHoangKimBlueprintId;
                    const rarityClass = getRarityClass(item.rarity);
                    
                    return `
                    <div onclick="selectHoangKimBlueprint('${id}')" class="bg-gray-700 rounded p-2 mb-2 cursor-pointer hover:bg-gray-600 flex justify-between items-center ${isSelected ? 'border-2 border-yellow-400' : ''}">
                        <div>
                            <p class="font-bold text-xs ${rarityClass}">${item.name}</p>
                            <p class="text-[10px] text-gray-400">Số lượng: ${count}</p>
                        </div>
                        ${isSelected ? '<i class="fa-solid fa-check text-green-400"></i>' : ''}
                    </div>
                    `;
                }).join('');
            }
            
            updateHoangKimCenterUI();
        }

        function selectHoangKimEquip(id) {
            selectedHoangKimEquipId = (selectedHoangKimEquipId === id) ? null : id;
            renderHoangKimPanel();
        }

        function selectHoangKimBlueprint(id) {
            selectedHoangKimBlueprintId = (selectedHoangKimBlueprintId === id) ? null : id;
            renderHoangKimPanel();
        }

        // [NEW] Helper xác định Tier hiện tại của trang bị dựa vào tên
        function getItemHoangKimTier(item) {
            if (!item) return 0;
            
            // [MODIFIED] Kiểm tra tiền tố tên TRƯỚC (để xác định đúng cấp độ sau khi nâng cấp)
            // Kiểm tra từ cao xuống thấp hoặc thấp lên cao đều được vì tiền tố khác nhau

            // [NEW] Các cấp độ Siêu Thoát (Tier 16-20)
            if (item.name.startsWith("Chúa Tể")) return 20;
            if (item.name.startsWith("Thiên Đạo")) return 19;
            if (item.name.startsWith("Vĩnh Hằng")) return 18;
            if (item.name.startsWith("Hư Vô")) return 17;
            if (item.name.startsWith("Sáng Thế")) return 16;
            
            // [NEW] Các cấp độ Cao Cấp (Tier 10-15)
            if (item.name.startsWith("Hồng Mông")) return 15;
            if (item.name.startsWith("Hỗn Độn")) return 14;
            if (item.name.startsWith("Thái Cổ")) return 13;
            if (item.name.startsWith("Hư Không")) return 12;
            if (item.name.startsWith("Càn Khôn")) return 11;
            if (item.name.startsWith("Nhật Nguyệt")) return 10;
            
            // Các cấp độ cũ (Tier 1-9)
            if (item.name.startsWith("Tinh Sương")) return 9;
            if (item.name.startsWith("Đằng Long")) return 8;
            if (item.name.startsWith("Bạch Hổ")) return 7;
            if (item.name.startsWith("Kim Ô")) return 6;
            if (item.name.startsWith("Tử Mãng")) return 5;
            if (item.name.startsWith("Huyền Viên")) return 4;
            if (item.name.startsWith("Thương Lang")) return 3;
            if (item.name.startsWith("Vân Lộc")) return 2;
            if (item.name.startsWith("Thanh Câu")) return 1;
            
            // Nếu không có tiền tố Hoàng Kim, kiểm tra xem có phải là Phôi không
            if (item.baseId === 'crafting_blank_white') return 0;

            return 0; // Trang bị thường cũng coi là Tier 0 (có thể ép lên Thanh Câu)
        }

        function updateHoangKimCenterUI() {
            const equipSlot = document.getElementById('hk-slot-equip');
            const bpSlot = document.getElementById('hk-slot-blueprint');
            const resultNameEl = document.getElementById('hk-result-name');
            const costEl = document.getElementById('hk-cost-display');
            const btn = document.getElementById('btn-upgrade-hoang-kim');
            
            let item = null;
            let blueprint = null;
            let craftingCost = 0; 

            // Update Equip Slot
            if (selectedHoangKimEquipId) {
                item = gameData.gearInventory.find(i => i.uniqueId === selectedHoangKimEquipId);
                if (item) {
                    const quality = QUALITY_DB[item.quality];
                    equipSlot.innerHTML = `
                        <div class="text-center">
                            <i class="fa-solid fa-shirt text-3xl ${quality.className}"></i>
                            <p class="text-[10px] mt-1 ${quality.className} truncate w-16">${item.name}</p>
                        </div>
                    `;
                    equipSlot.classList.add('border-cyan-400');
                    equipSlot.classList.remove('border-gray-600');
                }
            } else {
                equipSlot.innerHTML = `<i class="fa-solid fa-shirt text-3xl text-gray-600"></i><span class="absolute -bottom-6 text-xs text-gray-400 whitespace-nowrap">Trang Bị</span>`;
                equipSlot.classList.remove('border-cyan-400');
                equipSlot.classList.add('border-gray-600');
            }

            // Update Blueprint Slot
            if (selectedHoangKimBlueprintId) {
                blueprint = STATIC_ITEM_DB[selectedHoangKimBlueprintId];
                if (blueprint) {
                     const rarityClass = getRarityClass(blueprint.rarity);
                     craftingCost = blueprint.craftCostKNB || 50000; 
                     
                     bpSlot.innerHTML = `
                        <div class="text-center">
                            <i class="fa-solid fa-scroll text-3xl ${rarityClass}"></i>
                            <p class="text-[10px] mt-1 ${rarityClass} truncate w-16">${blueprint.name}</p>
                        </div>
                    `;
                    bpSlot.classList.add('border-yellow-400');
                    bpSlot.classList.remove('border-gray-600');
                }
            } else {
                bpSlot.innerHTML = `<i class="fa-solid fa-scroll text-3xl text-gray-600"></i><span class="absolute -bottom-6 text-xs text-gray-400 whitespace-nowrap">Đồ Phổ</span>`;
                bpSlot.classList.remove('border-yellow-400');
                bpSlot.classList.add('border-gray-600');
            }

            // Update Result & Button
            if (item && blueprint) {
                // [MODIFIED] Kiểm tra Tier progression
                const itemTier = getItemHoangKimTier(item);
                const blueprintTier = blueprint.tier || 1;
                
                // Điều kiện: Phải là trang bị cấp trước đó mới lên được cấp tiếp theo
                // Ví dụ: Muốn lên Tier 2 (Vân Lộc), trang bị phải là Tier 1 (Thanh Câu)
                if (blueprintTier !== itemTier + 1) {
                    resultNameEl.innerHTML = `<span class="text-red-500 text-xs">Cần trang bị cấp ${blueprintTier - 1}!</span>`;
                    costEl.textContent = "--";
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    return; // Dừng xử lý
                }

                // Logic đặt tên
                const prefix = blueprint.name.replace("Đồ Phổ ", "").trim();
                let baseName = item.name;
                if (item.baseId === 'crafting_blank_white') {
                    baseName = "Vạn Dụng Thông Linh Bảo";
                } else if (baseName.includes(" - ")) {
                    const parts = baseName.split(" - ");
                    if (parts.length > 1) {
                        baseName = parts[parts.length - 1].trim();
                    }
                }
                const newName = `${prefix} - ${baseName}`;
                
                // Hiển thị thông tin buff dự kiến
                const multiplier = blueprint.statMultiplier || 1.5;
                const pBonus = blueprint.percentBonus || 0;

                resultNameEl.innerHTML = `
                    <span class="quality-supergodly text-xs block">${newName}</span>
                    <span class="text-[10px] text-green-400 block mt-1">Chỉ số x${multiplier}, +${pBonus}%</span>
                `;
                
                costEl.innerHTML = `${craftingCost.toLocaleString()} KNB`;
                costEl.className = (gameData.kimNguyenBao >= craftingCost) ? "text-left font-bold text-yellow-300" : "text-left font-bold text-red-500";
                
                const canAfford = gameData.kimNguyenBao >= craftingCost;
                
                btn.disabled = !canAfford;
                if (canAfford) {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    // Truyền craftingCost vào hàm xử lý
                    btn.onclick = function() { performHoangKimUpgrade(craftingCost, newName); };
                } else {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                resultNameEl.textContent = "???";
                costEl.textContent = "-- KNB";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function performHoangKimUpgrade(cost, newName) {
             if (gameData.kimNguyenBao < cost) return;
             
             const itemIndex = gameData.gearInventory.findIndex(i => i.uniqueId === selectedHoangKimEquipId);
             if (itemIndex === -1) return;
             const item = gameData.gearInventory[itemIndex];
             
             // [NEW] Lấy thông tin đồ phổ để áp dụng chỉ số
             const blueprint = STATIC_ITEM_DB[selectedHoangKimBlueprintId];
             const multiplier = blueprint.statMultiplier || 1.5;
             const percentAdd = blueprint.percentBonus || 0;

             // Deduct Cost
             gameData.kimNguyenBao -= cost;
             gameData.items[selectedHoangKimBlueprintId]--;
             if (gameData.items[selectedHoangKimBlueprintId] <= 0) delete gameData.items[selectedHoangKimBlueprintId];
             
             // Apply Upgrade
             item.name = newName;
             item.quality = 'supergodly'; 
             
             // [UPDATED] Apply Stats Logic (Phân loại rõ ràng)
             item.affixes.forEach(affix => {
                 if (!affix.isPercent) {
                     // Các chỉ số phẳng (HP, ATK, DEF...): Nhân theo multiplier của Đồ Phổ
                     // Logic: Giá trị mới = Giá trị hiện tại * Multiplier
                     affix.value = Math.floor(affix.value * multiplier);
                     // Cập nhật hiển thị
                     affix.display = `${affix.name} +${affix.value.toLocaleString()}`;
                 } else {
                     // Các chỉ số phần trăm (Crit, Speed%,...): Cộng thêm (Additive)
                     // Tránh việc nhân % gây ra con số vô lý (vd: 10% crit * 100 = 1000% crit)
                     
                     // Cap một số chỉ số đặc biệt để không phá game
                     if (affix.id === 'critChance' || affix.id === 'dodgeChance') {
                         // Crit/Dodge tăng ít hơn
                         const bonus = Math.floor(percentAdd / 2); 
                         affix.value += bonus;
                     } else {
                         affix.value += percentAdd;
                     }
                     
                     // Làm tròn số lẻ
                     affix.value = Math.round(affix.value * 10) / 10;
                     affix.display = `${affix.name} +${affix.value}%`;
                 }
             });
             
             showToast(`Chế tác thành công! ${newName} với sức mạnh kinh hoàng!`, true);
             addSectLog(`Chế tác thành công trang bị Hoàng Kim: ${newName} (x${multiplier} chỉ số)`, 'reward');
             
             // Reset
             selectedHoangKimEquipId = null;
             selectedHoangKimBlueprintId = null;
             
             updateUI();
             renderHoangKimPanel();
        }

        // --- Cường Hóa (Upgrade) Functions ---
        
        // Renders the list of items to upgrade AND the owned materials panel
        function renderUpgradePanel() {
            const listContainer = document.getElementById('upgrade-item-list');
            const materialsContainer = document.getElementById('upgrade-owned-materials');
            if (!listContainer || !materialsContainer) return;

            // 1. Render Item List (Equipped and Inventory)
            const allItems = [
                ...Object.values(gameData.equippedSlots)
                    .filter(id => id)
                    .map(id => gameData.gearInventory.find(i => i.uniqueId === id)),
                ...gameData.gearInventory.filter(item => !Object.values(gameData.equippedSlots).includes(item.uniqueId))
            ];
            
            // Filter out any undefined (e.g., broken links)
            const validItems = allItems.filter(item => item);
            
            // Sort: Equipped first, then quality, then level
            validItems.sort((a, b) => {
                const equippedA = Object.values(gameData.equippedSlots).includes(a.uniqueId) ? -1 : 0;
                const equippedB = Object.values(gameData.equippedSlots).includes(b.uniqueId) ? -1 : 0;
                if (equippedA !== equippedB) return equippedA - equippedB;
                
                const qualityA = Object.keys(QUALITY_DB).indexOf(a.quality);
                const qualityB = Object.keys(QUALITY_DB).indexOf(b.quality);
                if (qualityB !== qualityA) return qualityB - qualityA;
                
                return (b.level || 0) - (a.level || 0);
            });

            listContainer.innerHTML = validItems.map(item => {
                const quality = QUALITY_DB[item.quality];
                const upgradeText = item.upgradeLevel > 0 ? ` <span class="text-yellow-300">[+${item.upgradeLevel}]</span>` : '';
                const isEquipped = Object.values(gameData.equippedSlots).includes(item.uniqueId);
                
                return `
                <div onclick="selectItemForUpgrade('${item.uniqueId}')" class="bg-gray-700 rounded p-2 flex justify-between items-center cursor-pointer hover:bg-gray-600 ${selectedUpgradeItemId === item.uniqueId ? 'border-2 border-yellow-400' : ''}">
                    <div>
                        <p class="font-bold text-xs ${quality.className}">${item.name}${upgradeText}</p>
                        <p class="text-xs" style="color: ${quality.color};">[Cấp ${item.level}] ${isEquipped ? '(Đang mặc)' : ''}</p>
                    </div>
                    <i class="fa-solid fa-arrow-right text-gray-400"></i>
                </div>
                `;
            }).join('');
            if (validItems.length === 0) {
                 listContainer.innerHTML = `<p class="text-xs text-gray-500 text-center">Không có trang bị.</p>`;
            }

            // 2. Render Owned Materials
            const stones = ['upgrade_stone_low', 'upgrade_stone_medium', 'upgrade_stone_high'];
            materialsContainer.innerHTML = stones.map(id => {
                const itemDB = MATERIALS_DB[id];
                const owned = gameData.materials[id] || 0;
                return `
                <div class="bg-gray-700 rounded p-3">
                    <p class="font-bold text-sm ${getRarityClass(itemDB.rarity)}">${itemDB.name}</p>
                    <p class="text-xs text-gray-300">Đang sở hữu: <span class="font-bold">${owned}</span></p>
                </div>
                `;
            }).join('');
            
            // 3. Clear the main slot
            clearUpgradeSlot();
        }

        // Clears the upgrade slot UI
        function clearUpgradeSlot() {
            const slot = document.getElementById('upgrade-slot');
            const materialsInfo = document.getElementById('upgrade-materials');
            const chanceInfo = document.getElementById('upgrade-chance');
            const costInfo = document.getElementById('upgrade-cost');
            const upgradeBtn = document.getElementById('perform-upgrade-btn');

            selectedUpgradeItemId = null;
            
            slot.innerHTML = `<span class="text-gray-500">Chọn vật phẩm...</span>`;
            materialsInfo.innerHTML = '';
            chanceInfo.textContent = '--%';
            costInfo.textContent = '--';
            upgradeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            upgradeBtn.disabled = true;
            
            // Re-render item list to remove border
            const listContainer = document.getElementById('upgrade-item-list');
            if (listContainer) {
                listContainer.querySelectorAll('div[onclick]').forEach(el => el.classList.remove('border-2', 'border-yellow-400'));
            }
        }

        // Called when clicking an item in the list
        function selectItemForUpgrade(uniqueId) {
            // Clear previous border
            const listContainer = document.getElementById('upgrade-item-list');
            if (listContainer) {
                listContainer.querySelectorAll('div[onclick]').forEach(el => el.classList.remove('border-2', 'border-yellow-400'));
            }
            
            const item = gameData.gearInventory.find(i => i.uniqueId === uniqueId);
            if (!item) {
                console.error("Không tìm thấy vật phẩm để nâng cấp:", uniqueId); 
                clearUpgradeSlot();
                return;
            }
            
            selectedUpgradeItemId = uniqueId;
            
            // Highlight in list
            const itemEl = Array.from(listContainer.querySelectorAll('div[onclick]')).find(el => el.onclick.toString().includes(uniqueId));
            if (itemEl) itemEl.classList.add('border-2', 'border-yellow-400');

            // 1. Render item in slot
            const slot = document.getElementById('upgrade-slot');
            const quality = QUALITY_DB[item.quality];
            const upgradeText = item.upgradeLevel > 0 ? ` <span class="text-yellow-300">[+${item.upgradeLevel}]</span>` : '';
            const upgradeBonusPercent = getUpgradeBonusPercent(item.upgradeLevel || 0);
            const upgradeMultiplier = 1 + (upgradeBonusPercent / 100);
            
            slot.innerHTML = `
                <div class="text-center w-full">
                    <p class="font-bold text-base ${quality.className}">${item.name}${upgradeText}</p>
                    <p class="text-xs mb-2" style="color: ${quality.color};">[${quality.name} - Cấp ${item.level}]</p>
                    <div class="text-xs text-left space-y-0.5">
                    <!-- [MODIFIED] Apply color only if enchanted -->
                    ${item.affixes.map(affix => {
                        let colorClass = 'text-gray-300';
                        if (affix.isEnchant) colorClass = affix.rarityClass || 'text-green-400';
                        
                        if (affix.isPercent) return `<div class="${colorClass}">${affix.display}</div>`;
                        const upgradedValue = Math.floor(affix.value * upgradeMultiplier);
                        if (upgradedValue > affix.value) {
                             return `<div class="${colorClass}">${affix.name} +${upgradedValue} (<span class="text-gray-400">${affix.value}</span> + <span class="text-yellow-300">${upgradedValue - affix.value}</span>)</div>`;
                        }
                        return `<div class="${colorClass}">${affix.display}</div>`;
                    }).join('')}
                    </div>
                </div>
            `;
            
            // 2. Get next level info
            const currentLevel = item.upgradeLevel || 0;
            const nextLevelData = UPGRADE_RATES_DB[currentLevel];
            
            const materialsInfo = document.getElementById('upgrade-materials');
            const chanceInfo = document.getElementById('upgrade-chance');
            const costInfo = document.getElementById('upgrade-cost');
            const upgradeBtn = document.getElementById('perform-upgrade-btn');
            
            if (!nextLevelData) {
                console.error("Lỗi: Không tìm thấy data cường hóa cho cấp", currentLevel); return;
            }

            if (nextLevelData.max) {
                slot.innerHTML += `<p class="font-bold text-green-400 text-center mt-4">Đã đạt cấp tối đa!</p>`;
                materialsInfo.innerHTML = '';
                chanceInfo.textContent = 'MAX';
                costInfo.textContent = '0';
                upgradeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                upgradeBtn.disabled = true;
                return;
            }
            
            // 3. Render costs
            const stoneDB = MATERIALS_DB[nextLevelData.stoneId];
            const ownedStones = gameData.materials[nextLevelData.stoneId] || 0;
            const hasStones = ownedStones >= nextLevelData.stoneAmount;
            const hasCost = gameData.nganLuong >= nextLevelData.cost;

            materialsInfo.innerHTML = `
                <p class="text-sm ${hasStones ? 'text-gray-300' : 'text-red-400'}">
                    Yêu cầu: ${nextLevelData.stoneAmount} x ${stoneDB.name} (Có: ${ownedStones})
                </p>
            `;
            chanceInfo.textContent = `${nextLevelData.success}%`;
            costInfo.textContent = `${nextLevelData.cost} NL`;
            costInfo.className = `font-bold ${hasCost ? 'text-gray-300' : 'text-red-400'}`;

            // 4. Enable/Disable button
            if (hasStones && hasCost) {
                upgradeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                upgradeBtn.disabled = false;
            } else {
                upgradeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                upgradeBtn.disabled = true;
            }
        }
        
        // Called by the "Cường Hóa" button
        function performUpgrade() {
            if (!selectedUpgradeItemId) {
                showToast("Chưa chọn vật phẩm!", false); return;
            }
            
            const item = gameData.gearInventory.find(i => i.uniqueId === selectedUpgradeItemId);
            if (!item) {
                showToast("Lỗi: Không tìm thấy vật phẩm!", false);
                clearUpgradeSlot();
                return;
            }
            
            const currentLevel = item.upgradeLevel || 0;
            const upgradeData = UPGRADE_RATES_DB[currentLevel];
            
            if (!upgradeData || upgradeData.max) {
                showToast("Vật phẩm đã đạt cấp tối đa!", false); return;
            }
            
            // 1. Check costs again
            const stoneDB = MATERIALS_DB[upgradeData.stoneId];
            const ownedStones = gameData.materials[upgradeData.stoneId] || 0;
            const hasStones = ownedStones >= upgradeData.stoneAmount;
            const hasCost = gameData.nganLuong >= upgradeData.cost;
            
            if (!hasStones || !hasCost) {
                showToast("Không đủ nguyên liệu hoặc Ngân Lượng!", false);
                return; // Should be disabled, but check anyway
            }
            
            // 2. Deduct costs
            gameData.materials[upgradeData.stoneId] -= upgradeData.stoneAmount;
            gameData.nganLuong -= upgradeData.cost;
            
            // 3. Roll for success
            const roll = Math.random() * 100;
            
            if (roll <= upgradeData.success) {
                // SUCCESS
                item.upgradeLevel = (item.upgradeLevel || 0) + 1;
                showToast(`Cường hóa thành công! ${item.name} đã lên +${item.upgradeLevel}!`, true);
            } else {
                // FAILURE
                // [POLICY] For now, failure does nothing. No item break, no level down.
                showToast(`Cường hóa thất bại! May mắn lần sau.`, false);
            }
            
            // 4. Re-render UI
            updateUI(); // Update main UI stats
            renderUpgradePanel(); // Re-render materials
            selectItemForUpgrade(selectedUpgradeItemId); // Re-select item to show new stats/costs
        }

        // --- Chế Tạo (Crafting) Functions ---
        
        // [NEW] Hàm hiển thị Tooltip cho nguyên liệu (Chi phí)
        function showCostTooltip(event, name, required, owned) {
            const tooltip = document.getElementById('item-tooltip');
            const hasEnough = owned >= required;
            const colorClass = hasEnough ? 'text-green-400' : 'text-red-400';
            
            tooltip.innerHTML = `
                <div class="text-center">
                    <p class="font-bold ${colorClass} text-sm mb-1 border-b border-gray-600 pb-1">${name}</p>
                    <div class="grid grid-cols-2 gap-x-4 text-xs text-left">
                        <span class="text-gray-400">Yêu cầu:</span>
                        <span class="font-mono text-white text-right">${required.toLocaleString()}</span>
                        <span class="text-gray-400">Đang có:</span>
                        <span class="font-mono ${hasEnough ? 'text-white' : 'text-red-400'} text-right">${owned.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            tooltip.style.display = 'block';
            
            // Định vị tooltip
            const rect = event.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let top = rect.top - tooltipRect.height - 10;
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            
            // Điều chỉnh nếu tràn màn hình
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) left = window.innerWidth - tooltipRect.width - 10;
            if (top < 10) top = rect.bottom + 10;

            tooltip.style.top = `${top + window.scrollY}px`;
            tooltip.style.left = `${left + window.scrollX}px`;
        }

        // [MODIFIED] renderCraftingList - Style Divine Altar + Grid Cost Layout
        function renderCraftingList() {
            const listContainer = document.getElementById('crafting-recipe-list');
            if (!listContainer) return;

            // 1. Định nghĩa các nhóm
            const categories = {
                'upgrade': { title: 'Cường Hóa & Tinh Luyện', icon: 'fa-hammer', recipes: [], color: 'text-orange-400', bg: 'from-orange-900/40 to-gray-900', border: 'border-orange-500/30' },
                'gem': { title: 'Ngọc Khảm & Tinh Thể', icon: 'fa-gem', recipes: [], color: 'text-purple-400', bg: 'from-purple-900/40 to-gray-900', border: 'border-purple-500/30' },
                'disciple': { title: 'Đan Dược Đệ Tử', icon: 'fa-users', recipes: [], color: 'text-blue-400', bg: 'from-blue-900/40 to-gray-900', border: 'border-blue-500/30' },
                'consumable': { title: 'Thực Phẩm & Tiêu Hao', icon: 'fa-flask', recipes: [], color: 'text-green-400', bg: 'from-green-900/40 to-gray-900', border: 'border-green-500/30' },
                'equipment': { title: 'Phôi Trang Bị', icon: 'fa-shield-halved', recipes: [], color: 'text-yellow-400', bg: 'from-yellow-900/40 to-gray-900', border: 'border-yellow-500/30' },
                'other': { title: 'Vật Phẩm Khác', icon: 'fa-box', recipes: [], color: 'text-gray-400', bg: 'from-gray-800 to-gray-900', border: 'border-gray-500/30' }
            };

            // 2. Phân loại
            for (const [id, recipe] of Object.entries(CRAFTING_DB)) {
                if (id.startsWith('craft_stone_')) categories['upgrade'].recipes.push(id);
                else if (id.startsWith('craft_gem_')) categories['gem'].recipes.push(id);
                else if (id.startsWith('craft_disciple_')) categories['disciple'].recipes.push(id);
                else if (id.startsWith('craft_food_') || id.startsWith('craft_chankhi_')) categories['consumable'].recipes.push(id);
                else if (id.startsWith('craft_special_') || id.startsWith('craft_blank_')) categories['equipment'].recipes.push(id);
                else categories['other'].recipes.push(id);
            }

            let html = '';
            let hasAnyRecipe = false;

            // 3. Render
            for (const [key, cat] of Object.entries(categories)) {
                if (cat.recipes.length === 0) continue;
                hasAnyRecipe = true;

                html += `
                    <div class="mb-10 animate-fade-in">
                        <div class="relative flex items-center justify-center mb-6">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-700"></div></div>
                            <div class="relative bg-gray-900 px-4 flex items-center gap-2 border border-gray-700 rounded-full py-1">
                                <i class="fa-solid ${cat.icon} ${cat.color}"></i>
                                <span class="text-sm font-bold text-gray-300 tracking-wide">${cat.title}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                `;

                cat.recipes.forEach(id => {
                    const recipe = CRAFTING_DB[id];
                    
                    // --- Resolve Reward Info ---
                    let rewardName = '';
                    let rewardRarityClass = 'text-white';
                    let rewardIcon = 'fa-box';
                    let rewardAmount = recipe.reward.amount || 1;

                    if (recipe.reward.type === 'material') {
                        const mat = MATERIALS_DB[recipe.reward.id];
                        rewardName = mat.name;
                        rewardRarityClass = getRarityClass(mat.rarity);
                        rewardIcon = mat.icon;
                    } else if (recipe.reward.type === 'item') {
                        const itm = STATIC_ITEM_DB[recipe.reward.id];
                        rewardName = itm.name;
                        rewardRarityClass = getRarityClass(itm.rarity);
                        rewardIcon = itm.icon;
                    } else { 
                        rewardName = recipe.reward.item.name;
                        if (recipe.reward.item.quality && QUALITY_DB[recipe.reward.item.quality]) {
                             rewardRarityClass = QUALITY_DB[recipe.reward.item.quality].className;
                        } else {
                             rewardRarityClass = getRarityClass(11);
                        }
                        
                        if (recipe.icon) {
                            rewardIcon = recipe.icon; 
                        } else {
                            const type = recipe.reward.item.type;
                            if (type === 'weapon') rewardIcon = 'fa-khanda';
                            else if (type === 'armor') rewardIcon = 'fa-shirt';
                            else if (type === 'accessory') rewardIcon = 'fa-ring';
                            else rewardIcon = 'fa-shirt'; 
                        }
                    }

                    // --- Build Cost (Circular Icons) ---
                    let costHtml = '';
                    let canAfford = true;

                    recipe.cost.forEach(costItem => {
                        let name, owned, icon, hasEnough;
                        let ringColor = 'border-gray-600';
                        
                        if (costItem.type === 'material') {
                            const itemDB = MATERIALS_DB[costItem.id];
                            if(!itemDB) return;
                            name = itemDB.name;
                            owned = gameData.materials[costItem.id] || 0;
                            icon = itemDB.icon;
                        } else if (costItem.type === 'item') {
                            const itemDB = STATIC_ITEM_DB[costItem.id];
                            if(!itemDB) return;
                            name = itemDB.name;
                            owned = gameData.items[costItem.id] || 0;
                            icon = itemDB.icon;
                        } else {
                            if (costItem.id === 'kimNguyenBao') {
                                name = 'KNB'; owned = gameData.kimNguyenBao; icon = 'fa-gem'; ringColor = 'border-yellow-500';
                            } else {
                                name = 'NL'; owned = gameData.nganLuong; icon = 'fa-coins'; ringColor = 'border-gray-400';
                            }
                        }
                        
                        hasEnough = owned >= costItem.amount;
                        if (!hasEnough) { canAfford = false; ringColor = 'border-red-500 bg-red-900/20'; }

                        // [MODIFIED] Sử dụng showCostTooltip và bỏ tooltip HTML tĩnh
                        costHtml += `
                            <div class="relative group/cost cursor-help flex-shrink-0"
                                 onmouseover="showCostTooltip(event, '${name}', ${costItem.amount}, ${owned})"
                                 onmouseout="hideTooltip()">
                                <div class="w-8 h-8 rounded-full bg-black/50 border ${ringColor} flex items-center justify-center shadow-sm hover:scale-110 transition-transform">
                                    <i class="fa-solid ${icon} text-[10px] text-gray-300"></i>
                                </div>
                                <span class="absolute -bottom-1 -right-1 bg-gray-900 text-[8px] text-white px-1 rounded-full border border-gray-600 shadow">${formatCompactNumber(costItem.amount)}</span>
                            </div>
                        `;
                    });

                    // --- Render Altar Card ---
                    html += `
                        <div class="relative bg-gradient-to-b ${cat.bg} rounded-2xl border ${cat.border} p-1 shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 group overflow-hidden h-full flex flex-col">
                            <!-- Glow Effect Behind -->
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-24 h-24 bg-white/5 rounded-full blur-2xl group-hover:bg-white/10 transition"></div>
                            
                            <div class="bg-gray-900/90 rounded-xl flex-grow flex flex-col relative overflow-hidden">
                                <!-- Top: Item Icon (Floating) -->
                                <div class="h-24 flex items-center justify-center relative mt-4 flex-shrink-0">
                                    <div class="w-16 h-16 rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center bg-black/40 shadow-[0_0_15px_rgba(0,0,0,0.5)] group-hover:border-opacity-0 transition-all duration-500">
                                        <i class="${rewardIcon} text-4xl ${rewardRarityClass} drop-shadow-md group-hover:scale-110 transition duration-500"></i>
                                    </div>
                                    <!-- Rotating Ring on Hover -->
                                    <div class="absolute w-20 h-20 rounded-full border-t-2 border-b-2 border-transparent group-hover:border-t-cyan-400 group-hover:border-b-purple-400 opacity-0 group-hover:opacity-100 transition duration-700 animate-spin-slow pointer-events-none"></div>
                                </div>

                                <!-- Middle: Info -->
                                <div class="text-center px-3 mb-2 flex-shrink-0">
                                    <h6 class="font-bold text-sm ${rewardRarityClass} truncate">${rewardName}</h6>
                                    <p class="text-[10px] text-gray-500 tracking-wide">x${rewardAmount}</p>
                                    <p class="text-[10px] text-gray-400 mt-1 h-8 overflow-hidden line-clamp-2 leading-tight opacity-70 group-hover:opacity-100 transition">${recipe.desc}</p>
                                </div>

                                <!-- Bottom: Cost & Action -->
                                <div class="mt-auto bg-black/40 p-3 border-t border-gray-800">
                                    <!-- Cost Row - [MODIFIED] Grid 4 cột để tự động xuống dòng đẹp mắt -->
                                    <div class="grid grid-cols-4 gap-2 mb-3 justify-items-center">
                                        ${costHtml}
                                    </div>
                                    
                                    <!-- Action Row -->
                                    <div class="grid grid-cols-2 gap-2 flex-shrink-0">
                                        <button onclick="performCraft('${id}', 1)" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1.5 rounded text-xs transition ${!canAfford ? 'opacity-50 cursor-not-allowed' : 'hover:bg-cyan-600 hover:shadow-[0_0_10px_rgba(8,145,178,0.5)]'}" ${!canAfford ? 'disabled' : ''}>
                                            Chế Tạo
                                        </button>
                                        <button onclick="performCraft('${id}', 10)" class="bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold py-1.5 rounded text-[10px] border border-gray-600 transition ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                                            x10
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            if (!hasAnyRecipe) {
                listContainer.innerHTML = `<p class="text-center text-gray-400 italic py-10">Chưa có công thức chế tạo nào.</p>`;
            } else {
                listContainer.innerHTML = html;
            }
        }
        
        // [NEW] Helper to format numbers like 1.5k, 1M for compact display
        function formatCompactNumber(num) {
            return Intl.NumberFormat('en-US', {
                notation: "compact",
                maximumFractionDigits: 1
            }).format(num);
        }
        
        // [MODIFIED] performCraft to handle amount
        function performCraft(recipeId, amountStr = 1) {
            const recipe = CRAFTING_DB[recipeId];
            if (!recipe) {
                showToast("Không tìm thấy công thức!", false); return;
            }
            
            let amountToCraft = parseInt(amountStr, 10);
            if (isNaN(amountToCraft) || amountToCraft <= 0) amountToCraft = 1;

            // 1. Check max affordable amount
            let maxAffordable = Infinity;
            for (const costItem of recipe.cost) {
                let owned;
                if (costItem.type === 'material') {
                    owned = (gameData.materials[costItem.id] || 0);
                } else if (costItem.type === 'item') {
                    owned = (gameData.items[costItem.id] || 0);
                } else { // currency
                    if (costItem.id === 'kimNguyenBao') {
                        owned = gameData.kimNguyenBao;
                    } else {
                        owned = gameData.nganLuong;
                    }
                }
                maxAffordable = Math.min(maxAffordable, Math.floor(owned / costItem.amount));
            }
            
            // Adjust amountToCraft to the max possible
            if (amountToCraft > maxAffordable) {
                amountToCraft = maxAffordable;
            }

            if (amountToCraft <= 0) {
                showToast("Không đủ nguyên liệu/tiền để chế tạo dù chỉ 1 món!", false);
                return;
            }
            
            // 2. Check inventory space
            if (recipe.reward.type === 'equipment') {
                const freeSlots = MAX_INVENTORY_SLOTS - countInventorySlots();
                if (freeSlots < amountToCraft) {
                    amountToCraft = freeSlots;
                }
                if (amountToCraft <= 0) {
                    showToast("Hành trang đã đầy!", false); return;
                }
            }
            // (No check needed for stackable items, will be handled by addMaterial/addItem)

            // 3. Subtract cost
            let totalCostNL = 0;
            let totalCostKNB = 0;
            for (const costItem of recipe.cost) {
                const totalCostAmount = costItem.amount * amountToCraft;
                 if (costItem.type === 'material') {
                    gameData.materials[costItem.id] -= totalCostAmount;
                    if (gameData.materials[costItem.id] <= 0) {
                        delete gameData.materials[costItem.id];
                    }
                 } else if (costItem.type === 'item') {
                    gameData.items[costItem.id] -= totalCostAmount;
                    if (gameData.items[costItem.id] <= 0) {
                        delete gameData.items[costItem.id];
                    }
                 } else { // currency
                     if (costItem.id === 'kimNguyenBao') {
                        totalCostKNB += totalCostAmount;
                     } else {
                        totalCostNL += totalCostAmount;
                     }
                 }
            }
            gameData.nganLuong -= totalCostNL;
            gameData.kimNguyenBao -= totalCostKNB;
            
             // 4. Add reward
            let rewardName = '';
            const rewardAmount = (recipe.reward.amount || 1) * amountToCraft;

            if (recipe.reward.type === 'material') {
                const itemDB = MATERIALS_DB[recipe.reward.id];
                rewardName = itemDB.name;
                addMaterial(recipe.reward.id, rewardAmount, 'craft');
            } else if (recipe.reward.type === 'item') {
                const itemDB = STATIC_ITEM_DB[recipe.reward.id];
                rewardName = itemDB.name;
                addItem(recipe.reward.id, rewardAmount, 'craft');
            } else { // equipment
                rewardName = recipe.reward.item.name;
                for (let i = 0; i < amountToCraft; i++) {
                    const newItem = JSON.parse(JSON.stringify(recipe.reward.item)); // Deep copy
                    newItem.uniqueId = crypto.randomUUID(); // Give it a new unique ID
                    gameData.gearInventory.push(newItem);
                }
            }
            
            showToast(`Chế tạo thành công ${amountToCraft} x ${rewardName}!`, true);

            // 5. Re-render
            renderCraftingList();
            renderUpgradePanel(); // Update owned materials
            updateUI(); // Update currency
        }
        
        // --- [END] Blacksmith Functions ---

        // [NEW] --- Tinh Phách (Permanent Stat) Functions ---

        /**
         * Render panel "Tinh Phách"
         */
        function renderTinhPhachPanel() {
            const listContainer = document.getElementById('tinh-phach-list');
            const bonusContainer = document.getElementById('tinh-phach-bonus-display');
            if (!listContainer || !bonusContainer) return;

            const permStats = gameData.permanentStats;

            // 1. Render Bonus Display
            bonusContainer.innerHTML = `
                <div>
                    <p class="text-sm text-gray-400">Sinh Lực</p>
                    <p class="font-bold text-lg text-green-400">+${permStats.hp.toLocaleString()}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Phòng Thủ</p>
                    <p class="font-bold text-lg text-blue-400">+${permStats.def.toLocaleString()}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Công Kích</p>
                    <p class="font-bold text-lg text-purple-400">+${permStats.atk.toLocaleString()}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Bonus XP</p>
                    <p class="font-bold text-lg text-yellow-400">+${permStats.xp_boost.toFixed(2)}%</p>
                </div>
            `;

            // 2. Render Gem List
            const gems = Object.keys(TINH_PHACH_DB);
            listContainer.innerHTML = gems.map(gemId => {
                const gemData = TINH_PHACH_DB[gemId];
                const itemData = MATERIALS_DB[gemId];
                const owned = gameData.materials[gemId] || 0;
                
                const canAffordCost = gameData.nganLuong >= gemData.cost;
                const hasItem = owned > 0;
                const canUse = hasItem && canAffordCost;

                return `
                <!-- [MODIFIED] Added glass effect -->
                <div class="bg-black/20 backdrop-blur-sm border border-gray-700 p-3 rounded-lg flex flex-col sm:flex-row justify-between sm:items-center">
                    <div>
                        <p class="font-bold ${getRarityClass(itemData.rarity)}">${itemData.name}</p>
                        <p class="text-sm text-yellow-300">${gemData.desc}</p>
                        <p class="text-xs ${canAffordCost ? 'text-gray-400' : 'text-red-400'}">Chi phí: ${gemData.cost.toLocaleString()} NL</p>
                    </div>
                    <div class="flex-shrink-0 mt-2 sm:mt-0">
                        <p class="text-xs text-center text-gray-400 mb-1">Đang có: ${owned.toLocaleString()}</p>
                        <div class="flex gap-1">
                            <button onclick="performTinhPhachUse('${gemId}', 1)" class="text-xs w-1/3 sm:w-auto flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded ${!canUse ? 'opacity-50 cursor-not-allowed' : ''}" ${!canUse ? 'disabled' : ''}>
                                Hấp Thụ 1
                            </button>
                            <button onclick="performTinhPhachUse('${gemId}', 10)" class="text-xs w-1/3 sm:w-auto flex-grow bg-blue-700 hover:bg-blue-800 text-white font-bold py-1 px-2 rounded ${!canUse ? 'opacity-50 cursor-not-allowed' : ''}" ${!canUse ? 'disabled' : ''}>
                                Hấp Thụ 10
                            </button>
                            <button onclick="performTinhPhachUse('${gemId}', 'all')" class="text-xs w-1/3 sm:w-auto flex-grow bg-blue-800 hover:bg-blue-900 text-white font-bold py-1 px-2 rounded ${!canUse ? 'opacity-50 cursor-not-allowed' : ''}" ${!canUse ? 'disabled' : ''}>
                                Hấp Thụ Hết
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        /**
         * Thực hiện hấp thụ Tinh Phách
         */
        function performTinhPhachUse(gemId, amountStr) {
            const gemData = TINH_PHACH_DB[gemId];
            if (!gemData) {
                showToast("Lỗi: Không tìm thấy Tinh Phách!", false);
                return;
            }

            const owned = gameData.materials[gemId] || 0;
            const costPer = gemData.cost;
            let amountToUse = 0;

            if (owned === 0) {
                showToast("Không có Tinh Phách để hấp thụ!", false);
                return;
            }
            
            if (amountStr === 'all') {
                // Tính toán tối đa có thể dùng dựa trên Ngân Lượng và số lượng có
                const maxByItem = owned;
                const maxByCost = Math.floor(gameData.nganLuong / costPer);
                amountToUse = Math.min(maxByItem, maxByCost);
            } else {
                amountToUse = parseInt(amountStr, 10);
            }

            if (amountToUse <= 0) {
                 showToast("Không đủ điều kiện hấp thụ!", false);
                 return;
            }
            
            // Kiểm tra lại lần nữa
            if (owned < amountToUse) {
                amountToUse = owned; // Chỉ dùng số lượng đang có
            }
            const totalCost = costPer * amountToUse;
            if (gameData.nganLuong < totalCost) {
                amountToUse = Math.floor(gameData.nganLuong / costPer); // Dùng tối đa có thể
            }
            
            // Tính lại chi phí
            const finalCost = costPer * amountToUse;
            
            if (amountToUse <= 0) {
                 showToast("Không đủ Ngân Lượng để hấp thụ dù chỉ 1 viên!", false);
                 return;
            }
            
            // 1. Trừ chi phí
            gameData.materials[gemId] -= amountToUse;
            gameData.nganLuong -= finalCost;

            // 2. Cộng chỉ số
            const stat = gemData.stat;
            const valueGained = gemData.value * amountToUse;
            gameData.permanentStats[stat] += valueGained;

            // 3. Thông báo
            let statName = stat.toUpperCase();
            if (stat === 'xp_boost') statName = "% XP";
            
            showToast(`Hấp thụ x${amountToUse} ${MATERIALS_DB[gemId].name}! ${statName} vĩnh viễn +${valueGained.toLocaleString()}`, true);
            
            // 4. Cập nhật UI
            renderTinhPhachPanel(); // Render lại tab
            getTotalStats(); // Tính toán lại chỉ số
            updateUI(); // Cập nhật hiển thị chỉ số và Ngân Lượng
        }

        // --- [END NEW] Tinh Phách Functions ---

        // --- [NEW] Tong Mon Functions (Đã di chuyển vào đây) ---

        // [NEW] Function to add XP to a specific disciple and handle level up
    function addDiscipleXp(discipleId, xpAmount) {
        const disciple = gameData.disciples.find(d => d.id === discipleId);
        if (!disciple) return;

        // [NEW] If max level, don't add XP
        if (disciple.level >= 200) {
            if (disciple.xp !== 0) disciple.xp = 0; // Ensure XP stays at 0
            return false; // Return false (no level up)
        }

        // [MODIFIED] Tính toán Bonus XP dựa trên Phẩm Chất
        const potential = disciple.potential || 'Yếu Kém';
        const bonusPercent = POTENTIAL_XP_BONUS[potential] || 0;
        const bonusMultiplier = 1 + (bonusPercent / 100);
        
        // XP thực nhận = XP gốc * Multiplier
        const finalXp = Math.floor(xpAmount * bonusMultiplier);

        disciple.xp = (disciple.xp || 0) + finalXp; 

            let levelledUp = false;
            while (disciple.xp >= disciple.xpToNext) {
                // [NEW] Add max level cap check
                if (disciple.level >= 200) {
                    disciple.xp = 0; // Set XP to 0
                    addSectLog(`${disciple.name} đã đạt cấp tối đa (200)!`, 'reward');
                    break; // Exit loop
                }
                
                levelledUp = true;
                disciple.level++;
                disciple.xp -= disciple.xpToNext;
                disciple.xpToNext = getDiscipleXpToNext(disciple.level);

                // Simple stat increase on level up (example: +HP, +ATK)
                disciple.stats.hp += 5 + Math.floor(Math.random() * 5); // Increase base HP
                disciple.stats.atk += 1 + Math.floor(Math.random() * 2); // Increase base ATK
                disciple.stats.def = (disciple.stats.def || 0) + 1 + Math.floor(Math.random() * 2); // [NEW] Increase base DEF
                disciple.stats.spd = (disciple.stats.spd || 0) + 1 + Math.floor(Math.random() * 2); // [NEW] Increase base SPD

                addSectLog(`${disciple.name} đã thăng lên cấp ${disciple.level}!`, 'reward');
            }

            // Update the UI immediately only if the modal is open
            if (!document.getElementById('tong-mon-modal').classList.contains('hidden')) {
                renderDiscipleList();
            }
            return levelledUp; // Return if a level up occurred
        }

        // [NEW] Hàm tạo tên ngẫu nhiên (Mở rộng data V2)
        function generateDiscipleName() {
            // Danh sách Họ (Surnames) - Bao gồm cả họ đơn và họ kép kiếm hiệp
            const hoList = [
                "Nguyễn", "Trần", "Lê", "Phạm", "Hoàng", "Huỳnh", "Phan", "Vũ", "Võ", "Đặng", "Bùi", "Đỗ", "Hồ", "Ngô", "Dương", "Lý",
                "Vương", "Trương", "Triệu", "Lâm", "Mã", "Đinh", "Trịnh", "Đoàn", "La", "Quách", "Lục", "Lương", "Chu", "Từ",
                "Âu Dương", "Mộ Dung", "Lệnh Hồ", "Gia Cát", "Tư Mã", "Đông Phương", "Độc Cô", "Nam Cung", "Tây Môn", "Thượng Quan", "Hiên Viên", "Hoàng Phủ", "Công Tôn",
                "Tiêu", "Hàn", "Sở", "Vệ", "Tần", "Khương", "Bạch", "Liễu", "Diệp", "Mạc", "Ninh", "Thẩm", "Tô", "Lạc", "Giang", "Thủy", "Kim", "Phó", "Doãn", "Chung",
                "Nạp Lan", "Hoàn Nhan", "Gia Luật", "Khúc", "Nhậm", "Hướng", "Tả", "Nhạc", "Bàng", "Thích", "Viên", "Tào", "Lưu", "Quan"
            ];
            
            // Danh sách Đệm (Middle Names)
            const demList = [
                "Văn", "Thị", "Đức", "Thanh", "Quang", "Minh", "Ngọc", "Hữu", "Mạnh", "Tuấn", "Hoàng", "Gia", "Bảo", "Thiên", "Huyền",
                "Vô", "Lãnh", "Huyết", "Bá", "Tử", "Kinh", "Sở", "Diệp", "Tiêu", "Hàn", "Lạc", "Mạc", "Vân", "Phong", "Sương",
                "Ngạo", "Cuồng", "Đại", "Tiểu", "A", "Lão", "Thiếu", "Chân", "Nguyên", "Thánh", "Thần", "Ma", "Quỷ", "Yêu", "Tiên",
                "Nhất", "Nhị", "Tam", "Tứ", "Ngũ", "Lục", "Thất", "Bát", "Cửu", "Thập", "Bách", "Vạn", "Thiên", "Địa",
                "Như", "Ý", "Cát", "Tường", "Phúc", "Lộc", "Thọ", "Khang", "Ninh", "An", "Kỳ", "Mỹ", "Lệ", "Anh", "Hùng",
                "Bất", "Phi", "Dạ", "Nguyệt", "Tinh", "Thần", "Hạo", "Kiền", "Khôn", "Thái", "Thượng", "Hạ", "Trung", "Chính"
            ];
            
            // Danh sách Tên (Given Names)
            const tenList = [
                "Phong", "Vân", "Lôi", "Điện", "Vũ", "Bão", "Tuyết", "Sương", "Lửa", "Băng",
                "Long", "Lân", "Quy", "Phụng", "Hổ", "Báo", "Sói", "Cáo", "Hạc", "Ưng",
                "Kiếm", "Đao", "Thương", "Kích", "Cung", "Nỏ", "Ám", "Ảnh", "Quyền", "Chưởng",
                "Sơn", "Hà", "Hải", "Dương", "Thiên", "Địa", "Nhật", "Nguyệt", "Tinh", "Tú",
                "Anh", "Hùng", "Kiệt", "Hào", "Dũng", "Mãnh", "Trí", "Tuệ", "Nhân", "Nghĩa",
                "Thành", "Công", "Danh", "Toại", "Phú", "Quý", "Vinh", "Hoa", "Lộc", "Thọ",
                "An", "Bình", "Khang", "Kiện", "Tường", "Thụy", "Cát", "Lợi", "Hưng", "Thịnh",
                "Tâm", "Can", "Tỳ", "Phế", "Thận", "Hồn", "Phách", "Ý", "Chí", "Thần",
                "Huyền", "Hoàng", "Vũ", "Trụ", "Hồng", "Hoang", "Càn", "Khôn", "Thái", "Cực",
                "Nhi", "Nữ", "Cơ", "Muội", "Tỷ", "Cô", "Lang", "Ca", "Đệ", "Tử",
                "Phàm", "Trần", "Tục", "Thế", "Gian", "Hồng", "Trần", "Khổ", "Hải", "Biên",
                "Thư", "Kỳ", "Họa", "Cầm", "Thi", "Tửu", "Trà", "Đạo", "Phật", "Nho",
                "Uyên", "Bác", "Nhã", "Trúc", "Lan", "Mai", "Cúc", "Liên", "Sen", "Đào",
                "Viễn", "Chí", "Tín", "Trung", "Hiếu", "Lễ", "Nghĩa", "Liêm", "Sỉ", "Khiêm",
                "Khuyết", "Dật", "Phi", "Phàm", "Trần", "Ai", "Lạc", "Hỉ", "Nộ", "Bi", "Hoan"
            ];

            const roll = Math.random();
            const ho = hoList[Math.floor(Math.random() * hoList.length)];
            const ten = tenList[Math.floor(Math.random() * tenList.length)];

            // 10% tên 2 chữ (Họ + Tên)
            // 70% tên 3 chữ (Họ + Đệm + Tên)
            // 20% tên 4 chữ (Họ + Đệm 1 + Đệm 2 + Tên)
            if (roll < 0.1) {
                return `${ho} ${ten}`;
            } else if (roll < 0.8) {
                const dem = demList[Math.floor(Math.random() * demList.length)];
                return `${ho} ${dem} ${ten}`;
            } else {
                const dem1 = demList[Math.floor(Math.random() * demList.length)];
                let dem2 = demList[Math.floor(Math.random() * demList.length)];
                // Tránh đệm trùng nhau
                while (dem1 === dem2) {
                    dem2 = demList[Math.floor(Math.random() * demList.length)];
                }
                return `${ho} ${dem1} ${dem2} ${ten}`;
            }
        }
        
        // [NEW] Hàm tạo 5 đệ tử ban đầu
        function createStartingDisciples() {
            let startingDisciples = [];
            const potentialLevels = ['Yếu Kém', 'Bình Thường', 'Khá', 'Tốt', 'Thiên Tài'];
            
            // [NEW] Tính toán tư chất tối thiểu dựa trên nâng cấp
            const minPotentialBonus = getSectUpgradeBonus('minPotential'); 
            const minPotentialIndex = Math.floor(minPotentialBonus);
            const potentialSlice = potentialLevels.slice(minPotentialIndex);
            
            // [MODIFIED] Chỉ tạo 1 đệ tử ban đầu (Thay vì 5)
            for (let i = 0; i < 1; i++) { 
                 // [MODIFIED] Lấy ngẫu nhiên từ mốc tối thiểu
                 const randomPotential = potentialSlice[Math.floor(Math.random() * potentialSlice.length)];
                 const level = 1; // [NEW]
                 startingDisciples.push({
                    id: `disciple_${crypto.randomUUID()}`,
                    name: generateDiscipleName(),
                    level: level, // [MODIFIED]
                    xp: 0, // [NEW]
                    xpToNext: getDiscipleXpToNext(level), // [NEW]
                    potential: randomPotential,
                    status: 'Nhàn Rỗi',
                    assignedMission: null,
                    isLocked: false, // [NEW] Add lock property
                    // [MODIFIED] Add base DEF and SPD
                    stats: { 
                        hp: 50 + Math.floor(Math.random()*20), 
                        atk: 5 + Math.floor(Math.random()*3),
                        def: 1 + Math.floor(Math.random()*2),
                        spd: 1 + Math.floor(Math.random()*2),
                        mana: 20 + Math.floor(Math.random()*10),
                        honLuc: 20 + Math.floor(Math.random()*10), 
                        crit: Math.floor(Math.random()*3),
                        dodge: Math.floor(Math.random()*3),
                        critDamage: Math.floor(Math.random()*10),
                        accuracy: Math.floor(Math.random()*3),
                        lifesteal: Math.floor(Math.random()*2), 
                        manasteal: Math.floor(Math.random()*2),
                        si_khi: Math.floor(Math.random()*5) // [NEW] Random Sĩ Khí 0-4
                    },
                    lastTuLuyen: 0 // [NEW] Add cooldown field
                });
            }
            return startingDisciples;
        }

        function switchTongMonTab(tabId) {
            const modal = document.getElementById('tong-mon-modal');
            if (!modal) return;

            modal.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            modal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'text-yellow-400');
                btn.classList.add('text-gray-400');
                // [NEW] Reset style riêng của nút Chinh Phạt
                if (btn.id === 'tab-chinh-phat') {
                    btn.classList.remove('text-red-500', 'border-red-500', 'bg-red-900/20');
                    btn.classList.add('text-red-400');
                }
            });

            const panel = document.getElementById(`panel-${tabId}`);
            const tab = document.getElementById(`tab-${tabId}`);

            if (panel) panel.classList.remove('hidden');
            if (tab) {
                tab.classList.add('tab-active'); // Base active class
                tab.classList.remove('text-gray-400');
                
                // [NEW] Style riêng cho Chinh Phạt
                if (tabId === 'chinh-phat') {
                    tab.classList.add('text-red-500', 'border-b-2', 'border-red-500', 'bg-red-900/20');
                    tab.classList.remove('tab-active', 'text-yellow-400'); // Override default yellow
                } else {
                    tab.classList.add('text-yellow-400');
                }
            }

            // Render specific content when switching
            // [MODIFIED] Render based on new tabs
            if (tabId === 'chieu-mo') {
                renderRecruitPanel(); // Update member count and log
            } else if (tabId === 'boi-duong') {
            } else if (tabId === 'nhiem-vu') {
                renderSectMissionPanel(); // [NEW]
            } else if (tabId === 'quan-ly') {
                renderManagementPanel(); // [NEW]
            } else if (tabId === 'thuong-kho') {
                renderSectWarehouse(); // [NEW] Call render function
            } else if (tabId === 'cua-hang-tm') { // [NEW]
                renderSectShop(); // [NEW] Call render function
            } else if (tabId === 'thi-luyen-tm') { // [NEW]
                renderSectTrialPanel(); // [NEW] Call render function
            } else if (tabId === 'chinh-phat') { // [NEW] GOM NHÓM
                // Mặc định mở sub-tab Khiêu Chiến
                switchChinhPhatSubTab('khieu-chien-tm');
            } else if (tabId === 'do-thien-kiep') { // [NEW]
                renderDoThienKiepPanel(); // [NEW] Call render function
            } else if (tabId === 'tu-tien') { // [NEW]
                renderTuTienPanel(); // [NEW] Call render function
            } else if (tabId === 'be-quan') { // [NEW]
                renderBeQuanPanel(); // [MODIFIED] Call render function
            } else if (tabId === 'phi-thang') { // [NEW]
                renderPhiThangPanel(); // [NEW] Call render function
            } else if (tabId === 'truyen-cong') { // [NEW]
                renderTruyenCongPanel(); // [NEW] Call render function
            } else if (tabId === 'hon-phoi') { // [NEW]
                renderHonPhoiPanel(); // [NEW] Call render function
            } 
            else if (tabId === 'dong-phu') { // [NEW]
                renderDongPhuPanel(); // [NEW] Call render function
            } else if (tabId === 'linh-tri') { // [NEW]
                renderLinhTriPanel(); // [NEW] Call render function
            } else if (tabId === 'lanh-dia') { // [NEW]
                renderLanhDiaPanel(); // [NEW] Call render function
            } else if (tabId === 'loi-dai') { // [NEW]
                renderLoiDaiPanel(); // [NEW] Call render function
            } else if (tabId === 'dai-tran') { // [RESTORED]
                renderDaiTranPanel(); // [RESTORED] Call render function
            } else if (tabId === 'kinh-mach') { // [NEW]
                renderKinhMachPanel(); // [NEW] Call render function
            }
        }
        
        // [NEW] Hàm xử lý chuyển đổi tab con trong "Chinh Phạt"
        function switchChinhPhatSubTab(subTabId) {
            const parentPanel = document.getElementById('panel-chinh-phat');
            if (!parentPanel) return;
            
            // 1. Ẩn tất cả nội dung con
            parentPanel.querySelectorAll('.subtab-content').forEach(content => content.classList.add('hidden'));
            
            // 2. Reset style các nút con
            parentPanel.querySelectorAll('.subtab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('bg-red-700', 'text-white', 'border-red-400');
                btn.classList.add('bg-gray-700', 'text-gray-400');
            });
            
            // 3. Hiện nội dung được chọn
            const targetContent = document.getElementById(`panel-${subTabId}`);
            if (targetContent) targetContent.classList.remove('hidden');
            
            // 4. Active nút được chọn
            const targetBtn = document.getElementById(`subtab-${subTabId}`);
            if (targetBtn) {
                targetBtn.classList.add('active', 'bg-red-700', 'text-white', 'border-red-400');
                targetBtn.classList.remove('bg-gray-700', 'text-gray-400');
            }
            
            // 5. Render nội dung tương ứng
            if (subTabId === 'khieu-chien-tm') {
                renderSectChallengePanel();
            } else if (subTabId === 'pho-ban') {
                renderPhoBanPanel();
            } else if (subTabId === 'chien-truong') {
                renderChienTruongPanel();
            } else if (subTabId === 'vo-dai-than-ma') { 
                renderVoDaiThanMaPanel();
            } else if (subTabId === 'am-anh-kiem-anh') {
                renderAmAnhKiemAnhPanel();
            } else if (subTabId === 'bach-thang') { // [NEW] Handle Bach Thang
                renderBachThangPanel();
            }
        }

        /**
         * [NEW] Hiển thị tab Võ Đài Thần Ma (Hoàn Thiện)
         */
        function renderVoDaiThanMaPanel() {
            const panel = document.getElementById('panel-vo-dai-than-ma');
            if (!panel) return;

            // Init data nếu chưa có
            if (!gameData.arena) {
                gameData.arena = { rank: 1, points: 0, wins: 0, losses: 0, lastSalaryClaim: null, opponents: [], lastRefresh: 0, battleLog: [] };
            }
            // [FIX] Init log array nếu save cũ chưa có
            if (!gameData.arena.battleLog) gameData.arena.battleLog = [];

            // Kiểm tra và cập nhật Rank dựa trên điểm số
            let currentRankData = ARENA_RANKS_DB[1];
            let nextRankData = null;
            
            // [MODIFIED] Tìm rank hiện tại dựa trên điểm (Loop từ 20 xuống 1)
            for (let i = 20; i >= 1; i--) {
                if (gameData.arena.points >= ARENA_RANKS_DB[i].minPoints) {
                    gameData.arena.rank = i;
                    currentRankData = ARENA_RANKS_DB[i];
                    // Check if next rank exists
                    if (ARENA_RANKS_DB[i+1]) {
                        nextRankData = ARENA_RANKS_DB[i+1];
                    }
                    break;
                }
            }

            // Tạo đối thủ nếu chưa có hoặc đã quá thời gian làm mới (ví dụ 10 phút)
            // Hoặc nếu danh sách rỗng
            if (!gameData.arena.opponents || gameData.arena.opponents.length === 0) {
                generateArenaOpponents();
            }

            // Tính toán tiến độ lên hạng
            let progressPercent = 100;
            let progressText = "Vô Địch Thiên Hạ";
            if (nextRankData) {
                const range = nextRankData.minPoints - currentRankData.minPoints;
                const current = gameData.arena.points - currentRankData.minPoints;
                progressPercent = Math.min(100, Math.max(0, (current / range) * 100));
                progressText = `${gameData.arena.points} / ${nextRankData.minPoints}`;
            } else {
                progressText = `${gameData.arena.points} Điểm`;
            }

            // Kiểm tra nhận lương
            const today = new Date().toISOString().slice(0, 10);
            const now = Date.now();
            const creationTime = gameData.createdAt || 0; // Thời gian tạo nhân vật
            
            // [NEW] Logic kiểm tra 24h
            const MS_IN_24H = 24 * 60 * 60 * 1000;
            const timeSinceCreation = now - creationTime;
            const isRestricted = timeSinceCreation < MS_IN_24H;
            
            const canClaimSalary = gameData.arena.lastSalaryClaim !== today && !isRestricted;

            // Xử lý hiển thị nút
            let btnText = "Nhận Lương";
            let btnClass = "bg-green-600 hover:bg-green-500 text-white animate-bounce";
            let btnDisabled = false;

            if (gameData.arena.lastSalaryClaim === today) {
                btnText = "Đã Nhận";
                btnClass = "bg-gray-700 text-gray-500 cursor-not-allowed";
                btnDisabled = true;
            } else if (isRestricted) {
                // Chưa đủ 24h
                const remainingMs = MS_IN_24H - timeSinceCreation;
                const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                btnText = `Mở sau ${hours}h ${minutes}p`;
                btnClass = "bg-gray-700 text-gray-400 cursor-not-allowed border border-yellow-600/30";
                btnDisabled = true;
            }

            let html = `
                <div class="text-center mb-6 relative">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-red-900/20 blur-3xl rounded-full -z-10"></div>
                    <i class="fa-solid fa-skull text-6xl text-red-500 mb-2 animate-pulse filter drop-shadow-[0_0_15px_rgba(239,68,68,0.6)]"></i>
                    <h4 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-400 via-orange-400 to-red-400 mb-1 uppercase tracking-widest">Võ Đài Thần Ma</h4>
                    <p class="text-xs text-gray-400">"Chiến đấu để chứng minh thực lực, leo lên đỉnh cao danh vọng."</p>
                </div>

                <!-- Rank Info Card -->
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-600 p-4 rounded-xl mb-6 shadow-lg flex flex-col md:flex-row items-center gap-6">
                    <div class="flex-shrink-0 text-center md:text-left">
                        <!-- [MODIFIED] Dynamic Border Color based on rank style -->
                        <div class="w-20 h-20 rounded-full bg-black/40 border-2 border-gray-500 flex items-center justify-center text-4xl shadow-[0_0_20px_currentColor] ${currentRankData.color} mx-auto md:mx-0">
                            <i class="${currentRankData.icon}"></i>
                        </div>
                    </div>
                    <div class="flex-grow w-full text-center md:text-left">
                        <h5 class="text-xl font-bold ${currentRankData.color} mb-1">${currentRankData.name}</h5>
                        <div class="w-full bg-gray-700 h-3 rounded-full overflow-hidden border border-gray-600 relative">
                            <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>Điểm: ${progressText}</span>
                            <span>Thắng/Thua: <span class="text-green-400">${gameData.arena.wins}</span> / <span class="text-red-400">${gameData.arena.losses}</span></span>
                        </div>
                    </div>
                    <div class="flex-shrink-0 text-center">
                        <p class="text-[10px] text-gray-500 uppercase mb-1">Lương Hàng Ngày</p>
                        <div class="text-xs font-bold mb-2 space-y-1">
                            <div><span class="text-yellow-300">${currentRankData.salary.knb.toLocaleString()} KNB</span></div>
                            <div><span class="text-teal-300">${currentRankData.salary.danhVong.toLocaleString()} DV</span></div>
                            <!-- [NEW] Hiển thị Vinh Dự -->
                            <div><span class="text-orange-400">${(currentRankData.salary.diemVinhDuLienDau || 0).toLocaleString()} Vinh Dự</span></div>
                        </div>
                        <button onclick="claimArenaSalary()" class="w-full px-4 py-2 rounded font-bold text-xs transition transform active:scale-95 shadow-md ${btnClass}" ${btnDisabled ? 'disabled' : ''}>
                            ${btnText}
                        </button>
                        ${isRestricted ? '<p class="text-[9px] text-red-400 mt-1 italic">*Cần đợi 24h sau khi tạo nhân vật</p>' : ''}
                    </div>
                </div>

                <!-- Opponents List -->
                <div class="flex justify-between items-end mb-3 border-l-4 border-red-500 pl-3">
                    <h5 class="text-lg font-bold text-gray-200">Đối Thủ Xứng Tầm</h5>
                    <button onclick="generateArenaOpponents()" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded border border-gray-500">
                        <i class="fa-solid fa-rotate mr-1"></i> Làm Mới
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            `;

            gameData.arena.opponents.forEach((opp, index) => {
                // Tính độ khó dựa trên lực chiến (So với người chơi, để hiển thị màu sắc cảnh báo)
                const myPower = calculateTotalSectAndPlayerPower();
                const powerRatio = opp.power / Math.max(1, myPower);
                let difficulty = 'Bình Thường';
                let diffColor = 'text-yellow-300';
                
                if (powerRatio < 0.8) { difficulty = 'Dễ'; diffColor = 'text-green-400'; }
                else if (powerRatio > 1.2) { difficulty = 'Khó'; diffColor = 'text-red-500'; }
                else if (powerRatio > 1.5) { difficulty = 'Tử Chiến'; diffColor = 'text-purple-500 font-black'; }

                // [NEW] Hiển thị thêm thông tin về "Chuẩn Rank"
                const diffLabel = opp.diffLabel || "Vừa";

                html += `
                <div class="bg-black/30 backdrop-blur-sm border border-gray-600 rounded-lg p-4 relative group hover:border-red-500/50 transition duration-300 flex flex-col items-center">
                    <div class="absolute top-2 right-2 text-[10px] px-2 py-0.5 rounded bg-gray-800 border border-gray-600 ${diffColor}">
                        ${diffLabel}
                    </div>
                    <div class="w-16 h-16 rounded-full bg-gray-800 border border-gray-500 mb-3 overflow-hidden">
                        <i class="${opp.avatar || 'fa-solid fa-user'} text-4xl text-gray-400 w-full h-full flex items-center justify-center bg-gray-900"></i>
                    </div>
                    <h6 class="font-bold text-white text-center truncate w-full">${opp.name}</h6>
                    <p class="text-xs text-gray-400 mb-1">Hạng: ${opp.rankName}</p>
                    <p class="text-xs font-mono mb-3 text-orange-300">LC: ${opp.power.toLocaleString()}</p>
                    
                    <div class="mt-auto w-full">
                        <div class="flex justify-between text-[10px] text-gray-500 mb-2 px-2">
                            <span>Đánh giá: <span class="${diffColor}">${difficulty}</span></span>
                            <span>Thưởng: +${opp.rewardPoints} Điểm</span>
                        </div>
                        <button onclick="startArenaBattle(${index})" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 rounded text-sm shadow-md transition transform group-hover:scale-105 border border-red-500/30">
                            Khiêu Chiến
                        </button>
                    </div>
                </div>
                `;
            });

            html += `</div>`;
            
            // [NEW] Render Battle Log Section (Nhật Ký Chiến Đấu Võ Đài)
            html += `
                <div class="mt-8 border-t border-gray-700 pt-4">
                    <h5 class="text-lg font-bold text-gray-300 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-scroll text-yellow-500"></i> Lịch Sử Đấu Trường
                    </h5>
                    <div class="bg-black/40 backdrop-blur-md border border-gray-600 rounded-lg p-3 h-48 overflow-y-auto scrollbar-thin text-xs font-mono space-y-1 shadow-inner">
            `;
            
            const logs = gameData.arena.battleLog || [];
            if (logs.length === 0) {
                html += `<p class="text-gray-500 text-center italic py-4">Chưa có lịch sử chiến đấu.</p>`;
            } else {
                logs.forEach(log => {
                    const timeColor = 'text-gray-500';
                    const winColor = 'text-green-400';
                    const loseColor = 'text-red-400';
                    const isWin = log.type === 'win';
                    
                    html += `
                    <div class="flex justify-between items-start border-b border-gray-700/50 pb-1 last:border-0 hover:bg-white/5 px-1 rounded transition">
                        <div class="flex-grow">
                            <span class="font-bold ${isWin ? winColor : loseColor} mr-2">[${isWin ? 'THẮNG' : 'THUA'}]</span>
                            <span class="text-gray-300">${log.msg}</span>
                        </div>
                        <span class="${timeColor} text-[10px] flex-shrink-0 ml-2 mt-0.5">${log.time}</span>
                    </div>`;
                });
            }
            html += `</div></div>`;

            panel.innerHTML = html;
        }

        /**
         * [MODIFIED] Tạo danh sách đối thủ ngẫu nhiên cho Võ Đài (Fixed Power per Rank - An Toàn)
         */
        function generateArenaOpponents() {
            // [NEW] Lấy Rank hiện tại của người chơi
            const currentRank = gameData.arena.rank || 1;
            const rankData = ARENA_RANKS_DB[currentRank];
            
            // [NEW] Lấy Lực Chiến Chuẩn từ Database (Không phụ thuộc vào người chơi)
            const basePower = rankData.standardPower || 1000; 
            
            const opponents = [];
            
            // Danh sách tên NPC ngẫu nhiên
            const npcNames = [
                "Độc Cô Cầu Bại", "Lệnh Hồ Xung", "Dương Quá", "Quách Tĩnh", "Tiêu Phong", 
                "Hư Trúc", "Đoàn Dự", "Trương Vô Kỵ", "Phong Thanh Dương", "Vương Trùng Dương",
                "Hồng Thất Công", "Hoàng Dược Sư", "Âu Dương Phong", "Nhậm Ngã Hành", "Đông Phương Bất Bại",
                "Lý Tầm Hoan", "Sở Lưu Hương", "Lục Tiểu Phụng", "Diệp Cô Thành", "Tây Môn Xuy Tuyết"
            ];

            // [MODIFIED] Cấu hình 3 mức độ khó dựa trên Chuẩn Rank (80% - 100% - 120%)
            const difficulties = [
                { multiplier: 0.8, label: 'Dễ (80%)', color: 'text-green-400' },        // 80% Chuẩn Rank
                { multiplier: 1.0, label: 'Vừa (100%)', color: 'text-yellow-300' },    // 100% Chuẩn Rank
                { multiplier: 1.2, label: 'Khó (120%)', color: 'text-red-500' }        // 120% Chuẩn Rank
            ];

            for (let i = 0; i < 3; i++) {
                const diff = difficulties[i];
                // Biến thiên ngẫu nhiên +/- 5% để đỡ nhàm chán
                const variance = 0.95 + Math.random() * 0.1;
                
                // Target Power của NPC = Base Rank Power * Difficulty * Variance
                const targetPower = Math.floor(basePower * diff.multiplier * variance);
                
                const name = npcNames[Math.floor(Math.random() * npcNames.length)];
                const rankName = rankData.name; 
                
                // Tính điểm thưởng (Cố định theo vị trí ô để tránh farm điểm)
                let rewardPoints = 10;
                if (i === 0) rewardPoints = 15; // Dễ
                if (i === 1) rewardPoints = 25; // Vừa
                if (i === 2) rewardPoints = 40; // Khó

                // Bonus Rank (Rank càng cao thưởng càng nhiều)
                rewardPoints += Math.floor(currentRank * 2); 

                // Phân bổ chỉ số (Ngân sách lực chiến)
                // Công thức Game đang dùng: (HP/5) + (ATK*5) + (DEF*3) + (SPD*3)
                // Ta sẽ chia "Ngân sách Lực Chiến" (targetPower) vào 4 chỉ số này
                
                const hpBudget = targetPower * 0.45;  // 45% vào Máu
                const atkBudget = targetPower * 0.35; // 35% vào Công
                const defBudget = targetPower * 0.15; // 15% vào Thủ
                const spdBudget = targetPower * 0.05; // 5% vào Tốc

                // Đảo ngược công thức Game để ra chỉ số thực
                const hp = Math.floor(hpBudget * 5);       // budget = hp / 5 -> hp = budget * 5
                const atk = Math.floor(atkBudget / 5);     // budget = atk * 5 -> atk = budget / 5
                const def = Math.floor(defBudget / 3);     // budget = def * 3 -> def = budget / 3
                const spd = Math.floor(spdBudget / 3);     // budget = spd * 3 -> spd = budget / 3
                
                const finalStats = {
                    hp: Math.max(100, hp),
                    atk: Math.max(10, atk),
                    def: Math.max(5, def),
                    spd: Math.max(5, spd),
                    lck: 10 // May mắn mặc định
                };

                opponents.push({
                    name: `[NPC] ${name}`,
                    power: targetPower,
                    rankName: rankName,
                    rewardPoints: rewardPoints,
                    stats: finalStats,
                    diffLabel: diff.label // Lưu label để hiển thị
                });
            }

            gameData.arena.opponents = opponents;
            gameData.arena.lastRefresh = Date.now();
            
            renderVoDaiThanMaPanel();
            showToast("Đã tìm thấy các đối thủ mới!", true);
        }

        /**
         * [NEW] Nhận lương Võ Đài hàng ngày
         */
        function claimArenaSalary() {
            const today = new Date().toISOString().slice(0, 10);
            const now = Date.now();
            const creationTime = gameData.createdAt || 0;
            const MS_IN_24H = 24 * 60 * 60 * 1000;

            // [NEW] Kiểm tra điều kiện 24h
            if (now - creationTime < MS_IN_24H) {
                showToast("Bạn cần đợi đủ 24 giờ sau khi tạo nhân vật để nhận lương lần đầu!", false);
                return;
            }
            
            if (gameData.arena.lastSalaryClaim === today) {
                showToast("Hôm nay bạn đã nhận lương rồi!", false);
                return;
            }

            const rank = gameData.arena.rank;
            const salary = ARENA_RANKS_DB[rank].salary;

            // [MODIFIED] Cộng thêm điểm Vinh Dự và XP
            gameData.kimNguyenBao += salary.knb;
            gameData.danhVong += salary.danhVong;
            gameData.diemVinhDuLienDau = (gameData.diemVinhDuLienDau || 0) + (salary.diemVinhDuLienDau || 0);
            
            // [NEW] Cộng EXP
            if (salary.xp) {
                addPlayerXp(salary.xp, 'salary');
            }
            
            gameData.arena.lastSalaryClaim = today;

            // [MODIFIED] Thông báo đầy đủ
            showToast(`Đã nhận lương ${ARENA_RANKS_DB[rank].name}: ${salary.knb.toLocaleString()} KNB, ${salary.danhVong.toLocaleString()} DV, ${salary.diemVinhDuLienDau.toLocaleString()} Vinh Dự, ${salary.xp ? salary.xp.toLocaleString() + ' XP' : ''}!`, true);
            addSectLog(`Nhận lương Võ Đài ngày: +${salary.knb.toLocaleString()} KNB, +${salary.danhVong.toLocaleString()} DV, +${salary.diemVinhDuLienDau.toLocaleString()} Vinh Dự, +${salary.xp ? salary.xp.toLocaleString() + ' XP' : ''}.`, 'reward');

            updateUI();
            renderVoDaiThanMaPanel();
        }

        /**
         * [NEW] Bắt đầu trận đấu Võ Đài
         */
        function startArenaBattle(opponentIndex) {
            const opponent = gameData.arena.opponents[opponentIndex];
            if (!opponent) return;

            // Chuẩn bị dữ liệu combat turn-based (tái sử dụng modal turn-based)
            
            // Tạo enemy object
            const arenaEnemy = {
                dbId: 'arena_npc', // ID giả
                name: opponent.name,
                level: gameData.player.level, // NPC level = player level (giả lập)
                icon: 'fa-solid fa-user-ninja',
                stats: opponent.stats,
                currentHp: opponent.stats.hp,
                maxHp: opponent.stats.hp
            };

            // Chuẩn bị đồng hành (như hàm startTurnBasedCombat cũ)
            let companions = [];
            const equippedPetId = gameData.equippedSungVat;
            const championDiscipleId = gameData.sect.combatChampionId;

            if (equippedPetId) {
                const petInstance = gameData.sungVat.find(p => p.id === equippedPetId);
                const petDB = SUNG_VAT_DB[equippedPetId];
                if (petInstance && petDB) {
                    const petStats = getPetStats(petInstance);
                    companions.push({ type: 'pet', id: petInstance.id, name: petDB.name, level: petInstance.level, stats: petStats, currentHp: petStats.hp, maxHp: petStats.hp });
                }
            }
            if (championDiscipleId) {
                const champ = gameData.disciples.find(d => d.id === championDiscipleId);
                if (champ && champ.status === 'Nhàn Rỗi') {
                    companions.push({ type: 'disciple', id: champ.id, name: champ.name, level: champ.level, stats: JSON.parse(JSON.stringify(champ.stats)), currentHp: champ.stats.hp, maxHp: champ.stats.hp });
                }
            }

            // Set combat state
            gameData.turnBasedCombat = {
                active: true,
                mapId: 'map_vo_dai', // ID đặc biệt cho Võ Đài
                enemy: arenaEnemy,
                companions: companions,
                log: [],
                playerTurn: true,
                arenaRewardPoints: opponent.rewardPoints // Lưu điểm thưởng tiềm năng
            };

            // UI transition
            hideModal('tong-mon-modal'); // Đóng tab tông môn nếu đang mở
            // Chinh Phạt là tab con của Tông Môn, nên đóng Tông Môn là đủ.
            
            showModal('turn-based-combat-modal');
            addTurnBasedCombatLog(`Bước lên Võ Đài! Đối thủ: <span class="text-red-400">${opponent.name}</span>`, 'system');
            renderTurnBasedCombatUI();
        }

        /**
         * [NEW] Hiển thị tab Ám Ảnh Kiếm Ảnh (Khôi phục)
         */
        function renderAmAnhKiemAnhPanel() {
            // ... existing code for Am Anh Kiem Anh ...
            const panel = document.getElementById('panel-am-anh-kiem-anh');
            if (!panel) return;

            // Lấy chỉ số hiện tại của người chơi
            const playerStats = getTotalStats();
            
            // Tâm Ma có chỉ số y hệt người chơi (HP gấp 5 lần để làm Boss)
            const shadowStats = { ...playerStats };
            shadowStats.hp = Math.floor(playerStats.hp * 5.0);

            // Logic giới hạn lượt
            if (!gameData.sect.amAnhKiemAnh) {
                gameData.sect.amAnhKiemAnh = { attempts: 0, lastDate: new Date().toISOString().slice(0, 10) };
            }
            const today = new Date().toISOString().slice(0, 10);
            if (gameData.sect.amAnhKiemAnh.lastDate !== today) {
                gameData.sect.amAnhKiemAnh.attempts = 0;
                gameData.sect.amAnhKiemAnh.lastDate = today;
            }
            const maxAttempts = 2;
            const remaining = Math.max(0, maxAttempts - gameData.sect.amAnhKiemAnh.attempts);
            const canChallenge = remaining > 0;

            let html = `
                <div class="text-center mb-6">
                    <h4 class="text-2xl font-bold text-gray-200 uppercase tracking-widest" style="text-shadow: 0 0 10px rgba(255,255,255,0.2);">Ám Ảnh Kiếm Ảnh</h4>
                    <p class="text-sm text-gray-400 mt-2 italic">"Kẻ thù lớn nhất của đời người là chính mình."</p>
                    <p class="text-xs text-gray-500">Chiến thắng bản ngã để khai mở tiềm năng vô hạn.</p>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-12 mb-8">
                    <!-- Player Card (Bản Thể) -->
                    <div class="bg-gray-800/80 p-5 rounded-xl border border-blue-500/30 shadow-[0_0_15px_rgba(59,130,246,0.1)] w-full md:w-72 relative overflow-hidden group transition hover:border-blue-400">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-transparent z-0"></div>
                        <div class="relative z-10">
                            <div class="w-20 h-20 mx-auto bg-gray-900 rounded-full flex items-center justify-center border-2 border-blue-400 mb-3 shadow-inner overflow-hidden">
                                ${PLAYER_DATA.avatar ? `<img src="${PLAYER_DATA.avatar}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-user-ninja text-4xl text-blue-300"></i>`}
                            </div>
                            <h5 class="font-bold text-lg text-blue-300 text-center mb-1">${PLAYER_DATA.name}</h5>
                            <p class="text-xs text-gray-400 text-center mb-4 bg-black/20 rounded-full px-2 py-0.5 w-fit mx-auto">Bản Thể</p>
                            
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between border-b border-gray-700/50 pb-1"><span class="text-gray-400"><i class="fa-solid fa-heart text-red-500 w-4"></i>Sinh Lực</span> <span class="text-red-400 font-mono font-bold">${playerStats.hp.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-700/50 pb-1"><span class="text-gray-400"><i class="fa-solid fa-khanda text-orange-500 w-4"></i>Công Kích</span> <span class="text-orange-400 font-mono font-bold">${playerStats.atk.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-700/50 pb-1"><span class="text-gray-400"><i class="fa-solid fa-shield-halved text-blue-500 w-4"></i>Phòng Thủ</span> <span class="text-blue-400 font-mono font-bold">${playerStats.def.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- VS Icon -->
                    <div class="text-5xl font-black text-red-600 animate-pulse flex flex-col items-center">
                        <span>VS</span>
                        <span class="text-xs font-normal text-gray-500 mt-1 opacity-50">Tử Chiến</span>
                    </div>

                    <!-- Shadow Card (Tâm Ma) -->
                    <div class="bg-gray-900 p-5 rounded-xl border border-red-900/50 shadow-[0_0_20px_rgba(220,38,38,0.1)] w-full md:w-72 relative overflow-hidden group transition hover:border-red-700">
                        <!-- Hiệu ứng nhiễu/tối cho Tâm Ma -->
                        <div class="absolute inset-0 bg-black/60 z-0"></div>
                        
                        <div class="relative z-10">
                            <div class="w-20 h-20 mx-auto bg-black rounded-full flex items-center justify-center border-2 border-red-800 mb-3 grayscale opacity-80">
                                <i class="fa-solid fa-user-ninja text-4xl text-gray-400"></i>
                            </div>
                            <h5 class="font-bold text-lg text-gray-400 text-center mb-1">Tâm Ma</h5>
                            <p class="text-xs text-red-500 text-center mb-4 bg-red-900/20 rounded-full px-2 py-0.5 w-fit mx-auto border border-red-900/30">Bản Ngã Hắc Ám</p>
                            
                            <div class="space-y-2 text-sm opacity-70">
                                <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-500">Sinh Lực</span> <span class="text-gray-300 font-mono font-bold text-red-400">${shadowStats.hp.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-500">Công Kích</span> <span class="text-gray-300 font-mono font-bold">${shadowStats.atk.toLocaleString()}</span></div>
                                <div class="flex justify-between border-b border-gray-800 pb-1"><span class="text-gray-500">Phòng Thủ</span> <span class="text-gray-300 font-mono font-bold">${shadowStats.def.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <p class="text-sm ${canChallenge ? 'text-green-400' : 'text-red-500'} mb-2 font-bold bg-black/40 inline-block px-3 py-1 rounded border border-gray-700">
                        Số lượt khiêu chiến còn lại hôm nay: <span class="text-white">${remaining}</span> / ${maxAttempts}
                    </p>
                    <br>
                    <button class="px-8 py-3 bg-gradient-to-r from-gray-800 to-black hover:from-red-900 hover:to-black text-gray-300 hover:text-white font-bold rounded-lg shadow-lg border border-gray-600 hover:border-red-500 transition-all transform hover:scale-105 group ${!canChallenge ? 'opacity-50 cursor-not-allowed grayscale' : ''}" 
                        onclick="${canChallenge ? 'startShadowBattle()' : ''}" 
                        ${!canChallenge ? 'disabled' : ''}>
                        <i class="fa-solid fa-khanda mr-2 group-hover:rotate-45 transition duration-300"></i> 
                        ${canChallenge ? 'Khiêu Chiến Tâm Ma' : 'Đã Hết Lượt Hôm Nay'}
                    </button>
                    <div class="mt-4 grid grid-cols-3 gap-2 max-w-md mx-auto text-xs">
                        <div class="bg-black/30 p-2 rounded border border-gray-700"><i class="fa-solid fa-gem text-yellow-400 mr-1"></i> 200 KNB</div>
                        <div class="bg-black/30 p-2 rounded border border-gray-700"><i class="fa-solid fa-ghost text-cyan-400 mr-1"></i> 500 LHT</div>
                        <div class="bg-black/30 p-2 rounded border border-gray-700"><i class="fa-solid fa-medal text-orange-400 mr-1"></i> 100 Vinh Dự</div>
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
        }

        /**
         * [NEW] Hiển thị tab Bách Thắng Danh Tướng (UI Upgrade)
         */
        function renderBachThangPanel() {
            const panel = document.getElementById('panel-bach-thang');
            if (!panel) return;

            // 1. Init Data
            if (!gameData.sect.bachThang) {
                gameData.sect.bachThang = {
                    currentLayer: 1, 
                    maxLayer: 1000000,
                    highestLayer: 0  
                };
            }
            if (gameData.sect.bachThang.maxLayer < 1000000) gameData.sect.bachThang.maxLayer = 1000000;
            
            const currentLayer = gameData.sect.bachThang.currentLayer;
            const highestLayer = gameData.sect.bachThang.highestLayer || (currentLayer - 1);
            
            // 2. Tính toán sức mạnh đối thủ
            const basePower = 50000; 
            let enemyPower = 0;

            if (currentLayer <= 1000) {
                enemyPower = basePower * Math.pow(1.12, currentLayer - 1);
            } else if (currentLayer <= 10000) {
                const powerAt1000 = basePower * Math.pow(1.12, 999);
                enemyPower = powerAt1000 * Math.pow(1.02, currentLayer - 1000);
            } else {
                const powerAt10k = 4.4e29; 
                enemyPower = powerAt10k * Math.pow(1.0005, currentLayer - 10000); 
            }
            
            if (!isFinite(enemyPower) || enemyPower > Number.MAX_SAFE_INTEGER) {
                 enemyPower = 9999999999999999; 
            } else {
                enemyPower = Math.floor(enemyPower);
            }
            
            // 3. Tên Tướng & Theme
            let generalName = "";
            let themeClass = "from-gray-900 to-gray-800"; // Default
            let iconClass = "fa-user-injured";
            let iconColor = "text-red-500";

            // Logic tên tướng
            if (currentLayer <= 200) {
                const GENERAL_NAMES = ["Tiên Phong", "Bách Phu Trưởng", "Thiên Phu Trưởng", "Đô Úy", "Hiệu Úy", "Phó Tướng", "Đại Tướng Quân", "Nguyên Soái", "Thần Tướng", "Chiến Thần", "Võ Thánh", "Thiên Vương", "Tu La", "Vô Song Tướng", "Hủy Diệt Giả", "Sát Thần", "Bá Vương", "Chí Tôn", "Thiên Đế", "Chúa Tể"];
                const nameIndex = Math.min(Math.floor((currentLayer - 1) / 10), GENERAL_NAMES.length - 1);
                generalName = `${GENERAL_NAMES[nameIndex]} - Tầng ${currentLayer}`;
                themeClass = "from-gray-900 via-red-900/20 to-gray-900";
            } else if (currentLayer <= 1000) {
                const prefix = ["Thượng Cổ", "Thái Cổ", "Viễn Cổ", "Hồng Hoang", "Hỗn Độn", "Hư Vô", "Vĩnh Hằng", "Bất Diệt"];
                const pIndex = Math.floor((currentLayer - 201) / 100) % prefix.length;
                generalName = `${prefix[pIndex]} Chiến Tướng - Tầng ${currentLayer}`;
                themeClass = "from-indigo-900/40 via-purple-900/20 to-black";
                iconClass = "fa-dragon";
                iconColor = "text-purple-400";
            } else if (currentLayer <= 10000) {
                 generalName = `Ma Tôn Hóa Thân - Tầng ${currentLayer}`;
                 themeClass = "from-gray-900 via-red-900/40 to-black";
                 iconClass = "fa-skull";
                 iconColor = "text-red-600";
            } else {
                generalName = `Chúa Tể Khởi Nguyên - Tầng ${currentLayer}`;
                themeClass = "from-yellow-900/30 via-orange-900/20 to-black";
                iconClass = "fa-crown";
                iconColor = "text-yellow-400";
            }

            // Phần thưởng
            const rewardNL = Math.floor(100000 * Math.pow(1.01, Math.min(5000, currentLayer))); 
            const rewardXP = Math.floor(500000 * Math.pow(1.01, Math.min(5000, currentLayer)));
            
            // --- UI HTML Construction ---
            
            // Header
            let html = `
                <div class="text-center mb-6 relative">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-red-600/10 blur-[100px] rounded-full -z-10"></div>
                    <h4 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-b from-red-400 via-orange-500 to-red-600 mb-2 uppercase tracking-[0.2em] filter drop-shadow-[0_0_15px_rgba(220,38,38,0.5)]">
                        Bách Thắng Danh Tướng
                    </h4>
                    <p class="text-sm text-gray-400 font-serif italic">
                        <span class="text-yellow-500">"</span>
                        Đường lên đỉnh vinh quang nhuộm máu kẻ thù. Mỗi 10 tầng chiến thắng, sức mạnh tăng tiến một phần.
                        <span class="text-yellow-500">"</span>
                    </p>
                </div>
            `;

            html += `<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full min-h-[550px]">`;

            // --- LEFT COLUMN: Current Floor & Enemy (Span 7) ---
            html += `
                <div class="lg:col-span-7 bg-gradient-to-br ${themeClass} border border-gray-700 p-1 rounded-2xl shadow-2xl relative overflow-hidden group">
                    <!-- Decorative Borders -->
                    <div class="absolute top-0 left-0 w-20 h-20 border-t-2 border-l-2 border-red-500/50 rounded-tl-xl pointer-events-none"></div>
                    <div class="absolute bottom-0 right-0 w-20 h-20 border-b-2 border-r-2 border-red-500/50 rounded-br-xl pointer-events-none"></div>
                    
                    <div class="bg-black/40 backdrop-blur-sm rounded-xl h-full p-6 flex flex-col items-center justify-center relative z-10">
                        
                        <!-- Floor Indicator -->
                        <div class="absolute top-4 left-4 flex items-center gap-2">
                            <span class="text-5xl font-black text-white/10 select-none">#${currentLayer}</span>
                        </div>
                        
                        <!-- Enemy Avatar with Pulse Effect -->
                        <div class="relative mb-6">
                            <div class="absolute inset-0 bg-red-500 blur-2xl opacity-20 animate-pulse rounded-full"></div>
                            <div class="w-40 h-40 rounded-full bg-gradient-to-b from-gray-800 to-black border-4 border-red-900/80 flex items-center justify-center relative z-10 shadow-[0_0_30px_rgba(220,38,38,0.3)]">
                                <i class="fa-solid ${iconClass} text-7xl ${iconColor} filter drop-shadow-lg"></i>
                            </div>
                            <!-- Level Badge -->
                            <div class="absolute -bottom-2 -right-2 bg-red-700 text-white text-xs font-bold px-3 py-1 rounded-full border-2 border-gray-900 shadow-lg">
                                BOSS
                            </div>
                        </div>

                        <!-- Enemy Info -->
                        <h2 class="text-2xl font-bold text-gray-100 mb-1 text-center text-shadow-md">${generalName}</h2>
                        <div class="flex items-center gap-2 mb-6 bg-black/40 px-4 py-1.5 rounded-full border border-gray-700">
                            <span class="text-xs text-gray-500 uppercase tracking-wide">Lực Chiến</span>
                            <span class="text-orange-400 font-mono font-bold text-lg">${enemyPower > Number.MAX_SAFE_INTEGER ? 'Vô Cực' : enemyPower.toLocaleString()}</span>
                        </div>

                        <!-- Rewards Preview -->
                        <div class="w-full bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 mb-6">
                            <p class="text-[10px] text-gray-400 uppercase text-center mb-3 tracking-widest">Phần Thưởng Vượt Ải</p>
                            <div class="flex justify-around items-center">
                                <div class="text-center group/reward">
                                    <div class="w-10 h-10 rounded bg-gray-700 flex items-center justify-center mb-1 mx-auto border border-gray-600 group-hover/reward:border-yellow-400 transition">
                                        <i class="fa-solid fa-coins text-yellow-400"></i>
                                    </div>
                                    <span class="text-xs font-bold text-gray-300 block">${rewardNL.toLocaleString()}</span>
                                    <span class="text-[9px] text-gray-500">Ngân Lượng</span>
                                </div>
                                <div class="text-center group/reward">
                                    <div class="w-10 h-10 rounded bg-gray-700 flex items-center justify-center mb-1 mx-auto border border-gray-600 group-hover/reward:border-green-400 transition">
                                        <i class="fa-solid fa-book-open text-green-400"></i>
                                    </div>
                                    <span class="text-xs font-bold text-gray-300 block">${rewardXP.toLocaleString()}</span>
                                    <span class="text-[9px] text-gray-500">Kinh Nghiệm</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        ${currentLayer <= 1000000 ? `
                            <button onclick="startBachThangBattle(${currentLayer}, ${enemyPower > Number.MAX_SAFE_INTEGER ? Number.MAX_SAFE_INTEGER : enemyPower})" 
                                class="relative w-full max-w-sm py-4 bg-gradient-to-r from-red-700 via-red-600 to-red-800 hover:from-red-600 hover:via-red-500 hover:to-red-700 text-white font-black text-lg rounded-xl shadow-lg border-t border-red-400 transition-all transform hover:scale-[1.02] active:scale-95 group overflow-hidden">
                                
                                <!-- Shine Effect -->
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out"></div>
                                
                                <span class="relative z-10 flex items-center justify-center gap-3">
                                    <i class="fa-solid fa-khanda group-hover:rotate-45 transition-transform duration-300"></i> 
                                    KHIÊU CHIẾN
                                </span>
                            </button>
                        ` : `
                            <div class="w-full py-4 bg-green-900/80 text-green-100 font-bold rounded-xl text-center shadow-lg border border-green-500 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-trophy text-yellow-400 text-xl"></i> 
                                ĐÃ PHÁ ĐẢO (1 TRIỆU TẦNG)
                            </div>
                        `}
                    </div>
                </div>
            `;

            // --- RIGHT COLUMN: Milestones & Stats (Span 5) ---
            
            // 1. Buff định kỳ
            const currentPeriodicBonus = Math.floor(highestLayer / 10);
            
            // 2. Mốc cố định
            const fixedMilestones = [
                { floor: 10, desc: "Công Kích +5%", icon: "fa-khanda", color: "text-orange-400" },
                { floor: 50, desc: "Bạo Kích +5%", icon: "fa-bolt", color: "text-yellow-300" },
                { floor: 100, desc: "Danh Hiệu: Bách Thắng", icon: "fa-medal", color: "text-purple-400" },
                { floor: 200, desc: "Danh Hiệu: Vô Song", icon: "fa-crown", color: "text-red-400" },
                { floor: 300, desc: "Toàn Diện +10%", icon: "fa-star", color: "text-rainbow-animation" },
                { floor: 500, desc: "Danh Hiệu: Độc Cô", icon: "fa-user-ninja", color: "text-gray-200" },
                { floor: 800, desc: "Hút Máu +10%", icon: "fa-droplet", color: "text-rose-500" },
                { floor: 1000, desc: "Danh Hiệu: Vạn Cổ", icon: "fa-scroll", color: "text-yellow-500" },
                { floor: 2000, desc: "Phòng Thủ +50%", icon: "fa-shield", color: "text-blue-400" },
                { floor: 3000, desc: "Công Kích +50%", icon: "fa-khanda", color: "text-orange-500" },
                { floor: 5000, desc: "Danh Hiệu: Chí Tôn", icon: "fa-crown", color: "text-fuchsia-400" },
                { floor: 10000, desc: "Toàn Diện +50%", icon: "fa-star", color: "text-rainbow-animation" }
            ];
            
            // Lọc mốc gần nhất chưa đạt để hiển thị mục tiêu
            const nextMilestone = fixedMilestones.find(m => m.floor > highestLayer) || { floor: 'MAX', desc: 'Đỉnh Cao Võ Học' };
            const prevMilestoneFloor = (fixedMilestones.find(m => m.floor < nextMilestone.floor)?.floor || 0);
            const progressToNext = nextMilestone.floor !== 'MAX' 
                ? Math.min(100, ((highestLayer - prevMilestoneFloor) / (nextMilestone.floor - prevMilestoneFloor)) * 100)
                : 100;

            html += `
                <div class="lg:col-span-5 flex flex-col h-full gap-4">
                    
                    <!-- Summary Stats Card -->
                    <div class="bg-gray-800/80 backdrop-blur-md border border-gray-600 p-4 rounded-xl shadow-lg">
                        <h5 class="text-sm font-bold text-gray-300 mb-3 flex items-center gap-2 border-b border-gray-700 pb-2">
                            <i class="fa-solid fa-chart-line text-green-400"></i> Tổng Hợp Sức Mạnh
                        </h5>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div class="bg-black/30 p-2 rounded flex justify-between items-center">
                                <span class="text-gray-400">Tầng cao nhất</span>
                                <span class="text-white font-bold">${highestLayer.toLocaleString()}</span>
                            </div>
                            <div class="bg-black/30 p-2 rounded flex justify-between items-center">
                                <span class="text-gray-400">Bonus Toàn Diện</span>
                                <span class="text-green-400 font-bold">+${currentPeriodicBonus}%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Next Goal Card -->
                    <div class="bg-gradient-to-r from-indigo-900/60 to-purple-900/60 border border-indigo-500/30 p-4 rounded-xl shadow-lg relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-3 opacity-10"><i class="fa-solid fa-flag-checkered text-6xl text-white"></i></div>
                        <h5 class="text-xs font-bold text-indigo-300 uppercase mb-1">Mục Tiêu Tiếp Theo</h5>
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-white font-bold text-lg">${nextMilestone.desc}</span>
                            <span class="text-xs text-indigo-200">Tầng ${nextMilestone.floor.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-900 h-2 rounded-full overflow-hidden">
                            <div class="bg-indigo-500 h-full transition-all duration-1000" style="width: ${progressToNext}%"></div>
                        </div>
                    </div>

                    <!-- Milestones Scroll List -->
                    <div class="bg-gray-800/60 backdrop-blur-md border border-gray-600 p-4 rounded-xl shadow-lg flex-grow flex flex-col min-h-[250px] overflow-hidden">
                        <h5 class="text-sm font-bold text-yellow-400 mb-3 flex items-center gap-2 flex-shrink-0">
                            <i class="fa-solid fa-list-check"></i> Các Mốc Đã Đạt
                        </h5>
                        <div class="overflow-y-auto scrollbar-thin flex-grow pr-2 space-y-2">
            `;

            // Render Milestone Items
            fixedMilestones.forEach(m => {
                const isUnlocked = highestLayer >= m.floor;
                if (!isUnlocked && m.floor > nextMilestone.floor) return; // Chỉ hiện mốc đã đạt và mốc kế tiếp

                const opacity = isUnlocked ? 'opacity-100' : 'opacity-50 grayscale';
                const bg = isUnlocked ? 'bg-gray-700' : 'bg-gray-800/50 border-dashed';
                const iconColor = m.color || 'text-white';
                
                html += `
                    <div class="${bg} p-3 rounded-lg border border-gray-600 flex items-center gap-3 transition hover:bg-gray-600 ${opacity}">
                        <div class="w-8 h-8 rounded-full bg-gray-900 flex items-center justify-center border border-gray-500 flex-shrink-0">
                            <i class="fa-solid ${m.icon || 'fa-star'} ${iconColor} text-xs"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="text-xs font-bold text-gray-200">${m.desc}</p>
                            <p class="text-[10px] text-gray-500">Mốc tầng: ${m.floor.toLocaleString()}</p>
                        </div>
                        ${isUnlocked ? '<i class="fa-solid fa-check text-green-500 text-sm"></i>' : '<i class="fa-solid fa-lock text-gray-600 text-sm"></i>'}
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            </div>`; // End Grid

            panel.innerHTML = html;
        }

        /**
         * [NEW] Bắt đầu chiến đấu Bách Thắng
         */
        function startBachThangBattle(layer, power) {
            // Kiểm tra Lực Chiến
            const myPower = calculateTotalSectAndPlayerPower();
            
            // [MODIFIED] Logic tên kẻ địch mở rộng cho > 100 tầng
            let enemyName = `Danh Tướng Tầng ${layer}`;
            if (layer > 5000) enemyName = `Hỗn Độn Ma Thần Tầng ${layer}`;
            else if (layer > 2000) enemyName = `Thượng Cổ Thần Tướng Tầng ${layer}`;
            else if (layer > 1000) enemyName = `Thần Tướng Tầng ${layer}`;
            else if (layer > 500) enemyName = `Võ Thánh Tầng ${layer}`;
            else if (layer > 200) enemyName = `Chiến Thần Tầng ${layer}`;
            
            // Giả lập đối thủ (Chỉ số dựa trên Power)
            // Power = (HP/5) + (ATK*5) + (DEF*3) + (SPD*3)
            // Phân bổ: 40% Power vào HP, 40% vào ATK, 15% vào DEF, 5% vào SPD
            
            const hp = Math.floor((power * 0.45) * 5);
            const atk = Math.floor((power * 0.35) / 5);
            const def = Math.floor((power * 0.15) / 3);
            const spd = Math.floor((power * 0.05) / 3);

            const arenaEnemy = {
                dbId: 'bach_thang_npc', 
                name: enemyName,
                level: Math.min(layer * 3, 20000), // Cap level visually
                icon: 'fa-solid fa-user-injured',
                stats: { hp: hp, atk: atk, def: def, spd: spd, lck: 10 },
                currentHp: hp,
                maxHp: hp
            };

            // Chuẩn bị đồng hành
            let companions = [];
            const equippedPetId = gameData.equippedSungVat;
            const championDiscipleId = gameData.sect.combatChampionId;

            if (equippedPetId) {
                const petInstance = gameData.sungVat.find(p => p.id === equippedPetId);
                const petDB = SUNG_VAT_DB[equippedPetId];
                if (petInstance && petDB) {
                    const petStats = getPetStats(petInstance);
                    companions.push({ type: 'pet', id: petInstance.id, name: petDB.name, level: petInstance.level, stats: petStats, currentHp: petStats.hp, maxHp: petStats.hp });
                }
            }
            if (championDiscipleId) {
                const champ = gameData.disciples.find(d => d.id === championDiscipleId);
                if (champ) {
                    const fullStats = calculateDiscipleStats(champ);
                    companions.push({ type: 'disciple', id: champ.id, name: champ.name, level: champ.level, stats: fullStats, currentHp: fullStats.hp, maxHp: fullStats.hp });
                }
            }
            
            // Full heal player
            const stats = getTotalStats();
            gameData.player.currentHp = stats.hp;
            gameData.player.currentMana = stats.mana;

            // Set combat state
            gameData.turnBasedCombat = {
                active: true,
                mapId: 'map_bach_thang', // ID đặc biệt
                enemy: arenaEnemy,
                companions: companions,
                log: [],
                playerTurn: true,
                // Dữ liệu phần thưởng để callback dùng (Cap reward growth)
                bachThangReward: {
                    layer: layer,
                    nl: Math.floor(100000 * Math.pow(1.02, Math.min(2000, layer))),
                    xp: Math.floor(500000 * Math.pow(1.02, Math.min(2000, layer)))
                }
            };

            hideModal('tong-mon-modal');
            showModal('turn-based-combat-modal');
            addTurnBasedCombatLog(`Khiêu chiến Bách Thắng: <span class="text-red-400">${enemyName}</span> (LC: ${power.toLocaleString()})`, 'system');
            renderTurnBasedCombatUI();
        }

        // [REMOVED] Hàm foundSect() đã bị xóa vì không cần thiết
        
        // [RESTORED] --- Tông Môn Đại Trận Functions ---
        function renderDaiTranPanel() {
            const panel = document.getElementById('panel-dai-tran');
            if (!panel) return;

            const currentLevel = gameData.sect.level || 1;
            const nextLevel = currentLevel + 1;
            const nextLevelData = SECT_LEVEL_DB[nextLevel];
            
            // Tính bonus hiện tại (Ví dụ: +1 đệ tử mỗi cấp, cấp 5 +2)
            // Logic này khớp với getMaxMembers()
            let currentBonus = (currentLevel - 1); 
            if (currentLevel >= 5) currentBonus += 1; 
            
            let html = `
                <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Tông Môn Đại Trận</h4>
                <p class="text-center text-gray-400 mb-6 text-sm">Nâng cấp Đại Trận để gia tăng khí vận và mở rộng quy mô Tông Môn.</p>
                
                <div class="bg-black/20 backdrop-blur-sm border border-gray-700 p-6 rounded-lg max-w-md mx-auto text-center">
                    <i class="fa-solid fa-gopuram text-6xl text-yellow-400 mb-4"></i>
                    <h5 class="text-2xl font-bold text-white mb-1">Tông Môn Cấp ${currentLevel}</h5>
                    <p class="text-sm text-green-400 mb-6">Hiệu quả: +${currentBonus} Giới Hạn Đệ Tử</p>
            `;

            if (nextLevelData && !nextLevelData.max) {
                const canAffordNL = gameData.nganLuong >= nextLevelData.costNL;
                const canAffordDCH = gameData.diemCongHien >= nextLevelData.costDCH;
                const canAfford = canAffordNL && canAffordDCH;

                html += `
                    <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-600 mb-4">
                        <p class="font-bold text-yellow-200 mb-2">Yêu Cầu Nâng Cấp ${nextLevel}:</p>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">Ngân Lượng:</span>
                            <span class="${canAffordNL ? 'text-green-400' : 'text-red-500'}">${nextLevelData.costNL.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">Cống Hiến:</span>
                            <span class="${canAffordDCH ? 'text-green-400' : 'text-red-500'}">${nextLevelData.costDCH.toLocaleString()}</span>
                        </div>
                        <p class="text-xs text-cyan-300 mt-2 border-t border-gray-600 pt-2">Phần thưởng: ${nextLevelData.bonusDesc}</p>
                    </div>
                    
                    <button onclick="upgradeSectLevel()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow-lg transition transform active:scale-95 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        Nâng Cấp Đại Trận
                    </button>
                `;
            } else {
                html += `
                    <div class="p-4 bg-green-900/30 border border-green-500/50 rounded-lg">
                        <p class="font-bold text-xl text-green-400">Đã Đạt Cấp Tối Đa</p>
                    </div>
                `;
            }

            html += `</div>`;
            panel.innerHTML = html;
        }

        function upgradeSectLevel() {
            const currentLevel = gameData.sect.level || 1;
            const nextLevel = currentLevel + 1;
            const nextLevelData = SECT_LEVEL_DB[nextLevel];

            if (!nextLevelData) {
                showToast("Đã đạt cấp tông môn tối đa!", false);
                return;
            }

            const canAffordNL = gameData.nganLuong >= nextLevelData.costNL;
            const canAffordDCH = gameData.diemCongHien >= nextLevelData.costDCH;

            if (!canAffordNL || !canAffordDCH) {
                showToast("Không đủ Ngân Lượng hoặc Điểm Cống Hiến!", false);
                return;
            }

            // Deduct costs
            gameData.nganLuong -= nextLevelData.costNL;
            gameData.diemCongHien -= nextLevelData.costDCH;

            // Grant level
            gameData.sect.level = nextLevel;

            const successMsg = `Tông Môn Đại Trận đã được nâng lên Cấp ${nextLevel}!`;
            addSectLog(successMsg, 'reward');
            showToast(successMsg, true);

            // Re-render
            updateUI(); // Update currencies
            renderDaiTranPanel(); // Refresh this tab
            renderRecruitPanel(); // Refresh recruit tab (for max members update)
        }
        // [END RESTORED] --- Tông Môn Đại Trận Functions ---

        function addSectLog(message, type = 'info') {
            if (!gameData.sect || !gameData.sect.log) return;
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `<p class="log-${type}">${timestamp} - ${message}</p>`;
            gameData.sect.log.unshift(logEntry);
            if (gameData.sect.log.length > MAX_LOG_LINES * 2) { // Keep more logs for sect
                gameData.sect.log.pop();
            }
            // Re-render log if recruit tab is active
            if (!document.getElementById('panel-chieu-mo').classList.contains('hidden')) {
                 renderRecruitPanel();
            }
        }

        // [MODIFIED] Renders the content of the Chiêu mộ tab
        function renderRecruitPanel() {
             if (!gameData.sect.founded) return;

             const currentMembers = gameData.disciples.length;
             const maxMembers = getMaxMembers(); // [NEW] Sử dụng hàm mới

             document.getElementById('sect-current-members-recruit').textContent = currentMembers;
             document.getElementById('sect-max-members-recruit').textContent = maxMembers;

             const recruitBtn = document.getElementById('recruit-disciple-btn');
             const limitMsg = document.getElementById('recruit-limit-msg');

             if (currentMembers >= maxMembers) {
                 recruitBtn.disabled = true;
                 recruitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                 limitMsg.classList.remove('hidden');
             } else {
                 recruitBtn.disabled = false;
                 recruitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                 limitMsg.classList.add('hidden');
             }

             // Render sect log
             const logContainer = document.getElementById('sect-log-recruit');
             if (logContainer) {
                 logContainer.innerHTML = gameData.sect.log.join('');
                 logContainer.scrollTop = 0; // Scroll to top
             }
        }


        function recruitDisciple() {
            const cost = 200000000;
             const currentMembers = gameData.disciples.length;
             const maxMembers = getMaxMembers(); 

            if (currentMembers >= maxMembers) {
                 showToast("Tông Môn đã đủ thành viên!", false);
                 const recruitBtn = document.getElementById('recruit-disciple-btn');
                 const limitMsg = document.getElementById('recruit-limit-msg');
                 recruitBtn.disabled = true;
                 recruitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                 limitMsg.classList.remove('hidden');
                 return;
            }

            if (gameData.nganLuong < cost) {
                showToast("Không đủ Ngân Lượng để chiêu mộ!", false); return;
            }

            gameData.nganLuong -= cost;

            // [MODIFIED] Hệ thống tỉ lệ (Weighted Random)
            const potentialLevels = ['Yếu Kém', 'Bình Thường', 'Khá', 'Tốt', 'Thiên Tài', 'Tuyệt Thế', 'Thiên Kiêu Chi Tử', 'Nghịch Thiên Cải Mệnh', 'Vô Cực Đạo Thể', 'Vạn Đạo Chi Tổ', 'Chân Ngã Duy Nhất', 'Nhất Niệm Vĩnh Hằng'];
            
            // Trọng số cho từng phẩm chất (Càng cao càng dễ ra)
            // Tổng trọng số cơ bản ~ 10,000
            const baseWeights = [
                4000, // Yếu Kém (~40%)
                3000, // Bình Thường (~30%)
                1500, // Khá (~15%)
                1000, // Tốt (~10%)
                350,  // Thiên Tài (~3.5%)
                100,  // Tuyệt Thế (~1%)
                30,   // Thiên Kiêu Chi Tử (~0.3%)
                10,   // Nghịch Thiên Cải Mệnh (~0.1%)
                5,    // Vô Cực Đạo Thể (~0.05%)
                3,    // Vạn Đạo Chi Tổ (~0.03%)
                1.5,  // Chân Ngã Duy Nhất (~0.015%)
                0.5   // Nhất Niệm Vĩnh Hằng (~0.005% - 1/20.000)
            ];

            // [NEW] Tính toán tư chất tối thiểu dựa trên nâng cấp Tụ Linh Trận
            const minPotentialBonus = getSectUpgradeBonus('minPotential'); 
            const minPotentialIndex = Math.floor(minPotentialBonus); // 0, 1, 2, hoặc 3 (Tốt)
            
            // Điều chỉnh trọng số: Gán 0 cho các phẩm chất thấp hơn mức tối thiểu
            let currentWeights = [...baseWeights];
            for(let i = 0; i < minPotentialIndex; i++) {
                currentWeights[i] = 0; 
            }
            
            // Tính tổng trọng số mới
            let totalWeight = currentWeights.reduce((a, b) => a + b, 0);
            
            // Quay random dựa trên trọng số
            let randomValue = Math.random() * totalWeight;
            let selectedIndex = 0;
            
            for(let i = 0; i < currentWeights.length; i++) {
                randomValue -= currentWeights[i];
                if (randomValue <= 0) {
                    selectedIndex = i;
                    break;
                }
            }
            
            // Fallback an toàn
            if (selectedIndex >= potentialLevels.length) selectedIndex = potentialLevels.length - 1;
            
            let randomPotential = potentialLevels[selectedIndex];
            // [END MODIFIED]
            
            const level = 1;

            // [NEW] Tính toán chỉ số cơ bản
            let baseHp = 50 + Math.floor(Math.random()*20);
            let baseAtk = 5 + Math.floor(Math.random()*3);
            let baseDef = 1 + Math.floor(Math.random()*2);
            let baseSpd = 1 + Math.floor(Math.random()*2);
            let baseMana = 20 + Math.floor(Math.random()*10); 
            let baseHonLuc = 20 + Math.floor(Math.random()*10); 
            let baseCrit = Math.floor(Math.random()*3); 
            let baseDodge = Math.floor(Math.random()*3); 
            let baseCritDamage = Math.floor(Math.random()*10); 
            let baseAccuracy = Math.floor(Math.random()*3); 
            let baseLifesteal = Math.floor(Math.random()*2); 
            let baseManasteal = Math.floor(Math.random()*2); 
            let baseSiKhi = Math.floor(Math.random()*5); // [NEW]

            // [MODIFIED] Logic nhân chỉ số theo phẩm chất (Multiplier)
            let multiplier = 1;
            if (randomPotential === 'Khá') multiplier = 1.2;
            // [MODIFIED] Random Khí Vận (Destiny) - Cập nhật tỷ lệ cho 18 loại
            const destinyRoll = Math.random();
            let destinyKey = "PHAM_NHAN";
            
            // Tỷ lệ tích lũy (Cumulative Probability)
            if (destinyRoll < 0.01) destinyKey = "THIEN_TIEN";      // 1% (Cực phẩm)
            else if (destinyRoll < 0.02) destinyKey = "KIEM_THAN";  // 1% [NEW]
            else if (destinyRoll < 0.03) destinyKey = "MA_THAN";    // 1%
            else if (destinyRoll < 0.04) destinyKey = "THANH_NHAN"; // 1%
            
            else if (destinyRoll < 0.055) destinyKey = "THIEN_MENH"; // 1.5% [NEW]
            else if (destinyRoll < 0.07) destinyKey = "NGU_HANH";   // 1.5% [NEW]
            
            else if (destinyRoll < 0.09) destinyKey = "HUYET_SAT";  // 2%
            else if (destinyRoll < 0.11) destinyKey = "BAT_DIET";   // 2%
            else if (destinyRoll < 0.13) destinyKey = "HU_KHONG";   // 2% [NEW]
            else if (destinyRoll < 0.15) destinyKey = "DUOC_LINH";  // 2% [NEW]
            
            else if (destinyRoll < 0.18) destinyKey = "NGHICH_THIEN"; // 3%
            else if (destinyRoll < 0.21) destinyKey = "TRONG_DONG";   // 3%
            else if (destinyRoll < 0.25) destinyKey = "CUU_DUONG";    // 4%
            else if (destinyRoll < 0.29) destinyKey = "THAI_AM";      // 4%
            
            else if (destinyRoll < 0.36) destinyKey = "TIEN_THIEN";   // 7%
            else if (destinyRoll < 0.45) destinyKey = "LINH_DIEU";    // 9%
            else if (destinyRoll < 0.65) destinyKey = "HOANG_GIA";    // 20%
            // Còn lại 35% Phàm Nhân

            const newDisciple = {
                id: `disciple_${crypto.randomUUID()}`,
                name: generateDiscipleName(),
                level: level,
                xp: 0,
                xpToNext: getDiscipleXpToNext(level),
                potential: randomPotential,
                destiny: destinyKey, // [NEW] Lưu khí vận
                status: 'Nhàn Rỗi', 
                assignedMission: null,
                isLocked: false,
                stats: { 
                    hp: baseHp, 
                    atk: baseAtk,
                    def: baseDef,
                    spd: baseSpd,
                    mana: baseMana,
                    honLuc: baseHonLuc, 
                    crit: baseCrit,
                    dodge: baseDodge,
                    critDamage: baseCritDamage,
                    accuracy: baseAccuracy,
                    lifesteal: baseLifesteal, 
                    manasteal: baseManasteal,
                    si_khi: baseSiKhi // [NEW]
                }, 
                lastTuLuyen: 0 
            };
            gameData.disciples.push(newDisciple);

            // [MODIFIED] Log đặc biệt cho các tư chất cao
            if (newDisciple.potential === 'Nhất Niệm Vĩnh Hằng') {
                addSectLog(`<span class="text-cyan-300 font-black text-4xl" style="text-shadow: 0 0 30px #fff;">VƯỢT QUA LUÂN HỒI!</span> Đã xuất hiện Tồn Tại <span class="name-potential-eternal">Nhất Niệm Vĩnh Hằng</span>: ${newDisciple.name}!`, 'reward');
                showToast(`Đã chiêu mộ Nhất Niệm Vĩnh Hằng: ${newDisciple.name}!`, true);
            } else if (newDisciple.potential === 'Chân Ngã Duy Nhất') {
                addSectLog(`<span class="text-white font-black text-3xl" style="text-shadow: 0 0 25px #fff;">DUY NGÃ ĐỘC TÔN!</span> Đã xuất hiện Chúa Tể <span class="name-potential-trueself">Chân Ngã Duy Nhất</span>: ${newDisciple.name}!`, 'reward');
                showToast(`Đã chiêu mộ Chân Ngã Duy Nhất: ${newDisciple.name}!`, true);
            } else if (newDisciple.potential === 'Vạn Đạo Chi Tổ') {
                addSectLog(`<span class="text-fuchsia-400 font-black text-2xl" style="text-shadow: 0 0 20px #fff;">VẠN ĐẠO QUY TÔNG!</span> Đã xuất hiện Tổ Sư <span class="name-potential-ancestor">Vạn Đạo Chi Tổ</span>: ${newDisciple.name}!`, 'reward');
                showToast(`Đã chiêu mộ Vạn Đạo Chi Tổ: ${newDisciple.name}!`, true);
            } else if (newDisciple.potential === 'Vô Cực Đạo Thể') {
                addSectLog(`<span class="text-cyan-400 font-black text-xl" style="text-shadow: 0 0 15px #fff;">THIÊN ĐẠO CHÚC PHÚC!</span> Đã chiêu mộ được <span class="name-potential-dao">Vô Cực Đạo Thể</span>: ${newDisciple.name}!`, 'reward');
                showToast(`Đã chiêu mộ Vô Cực Đạo Thể: ${newDisciple.name}!`, true);
            } else if (newDisciple.potential === 'Nghịch Thiên Cải Mệnh') {
                addSectLog(`<span class="text-white font-black text-lg" style="text-shadow: 0 0 10px #f00;">CHẤN ĐỘNG TAM GIỚI!</span> Đã xuất hiện kẻ <span class="name-potential-defying">Nghịch Thiên Cải Mệnh</span>: ${newDisciple.name}!`, 'reward');
                showToast(`Đã chiêu mộ Nghịch Thiên Cải Mệnh: ${newDisciple.name}!`, true);
            } else if (newDisciple.potential === 'Thiên Kiêu Chi Tử') {
                addSectLog(`<span class="text-yellow-300 font-black text-lg">THẦN TÍCH!</span> Đã chiêu mộ được <span class="name-potential-heavenly">Thiên Kiêu Chi Tử</span>: ${newDisciple.name}!`, 'reward');
                showToast(`Đã chiêu mộ Thiên Kiêu Chi Tử: ${newDisciple.name}!`, true);
            } else if (newDisciple.potential === 'Tuyệt Thế') {
                addSectLog(`<span class="text-red-500 font-bold">CHÚC MỪNG!</span> Đã chiêu mộ được đệ tử <span class="name-potential-peerless">Tuyệt Thế</span>: ${newDisciple.name}!`, 'reward');
                showToast(`Đã chiêu mộ đệ tử Tuyệt Thế: ${newDisciple.name}!`, true);
            } else {
                addSectLog(`Đã chiêu mộ ${newDisciple.name} (Tư chất: ${newDisciple.potential}).`, 'reward');
                showToast(`Đã chiêu mộ ${newDisciple.name}!`, true);
            }

            updateUI(); // Update NL
            renderRecruitPanel(); // Update member count display
            // Also re-render disciple list if that tab is somehow active
            if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                 renderDiscipleList();
            }
        }

        // [NEW] Simple name generator
        function generateDiscipleName() {
            const prefixes = ["Tiểu", "A", "Vô", "Lãnh", "Thiết", "Huyền", "Linh"];
            const midNames = ["Long", "Phong", "Vân", "Nguyệt", "Hàn", "Minh", "Tuyết", "Kiếm", "Ảnh"];
            const suffixes = ["Nhi", "Nữ", "Ca", "Sư", "Đệ", "Tử", "Giả"];
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const midName = midNames[Math.floor(Math.random() * midNames.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            // Sometimes just use two parts
            if (Math.random() < 0.3) {
                 return `${prefix} ${midName}`;
            } else if (Math.random() < 0.6) {
                 return `${midName} ${suffix}`;
            }
            return `${prefix} ${midName} ${suffix}`;
        }

        // [NEW] Helper để lấy style màu sắc dựa trên Tư Chất
        function getPotentialStyle(potential) {
            switch(potential) {
                case 'Nhất Niệm Vĩnh Hằng': return { border: 'border-cyan-300', text: 'text-cyan-300', bg: 'bg-gradient-to-br from-cyan-900/50 to-black/80', shadow: 'shadow-[0_0_15px_rgba(34,211,238,0.4)]', ring: 'ring-1 ring-cyan-400/50' };
                case 'Chân Ngã Duy Nhất': return { border: 'border-white', text: 'text-white', bg: 'bg-gradient-to-br from-gray-700/50 to-black/80', shadow: 'shadow-[0_0_15px_rgba(255,255,255,0.4)]', ring: 'ring-1 ring-white/50' };
                case 'Vạn Đạo Chi Tổ': return { border: 'border-fuchsia-400', text: 'text-fuchsia-400', bg: 'bg-gradient-to-br from-fuchsia-900/50 to-black/80', shadow: 'shadow-[0_0_12px_rgba(232,121,249,0.4)]', ring: 'ring-1 ring-fuchsia-400/50' };
                case 'Vô Cực Đạo Thể': return { border: 'border-teal-400', text: 'text-teal-300', bg: 'bg-gradient-to-br from-teal-900/50 to-black/80', shadow: 'shadow-[0_0_12px_rgba(45,212,191,0.4)]', ring: 'ring-1 ring-teal-400/50' };
                case 'Nghịch Thiên Cải Mệnh': return { border: 'border-rose-600', text: 'text-rose-400', bg: 'bg-gradient-to-br from-rose-900/50 to-black/80', shadow: 'shadow-[0_0_12px_rgba(225,29,72,0.4)]', ring: 'ring-1 ring-rose-500/50' };
                case 'Thiên Kiêu Chi Tử': return { border: 'border-orange-400', text: 'text-orange-300', bg: 'bg-gradient-to-br from-orange-900/50 to-black/80', shadow: 'shadow-[0_0_12px_rgba(251,146,60,0.4)]', ring: 'ring-1 ring-orange-400/50' };
                case 'Tuyệt Thế': return { border: 'border-red-500', text: 'text-red-400', bg: 'bg-gradient-to-br from-red-900/50 to-black/80', shadow: 'shadow-[0_0_10px_rgba(239,68,68,0.3)]', ring: 'ring-1 ring-red-500/30' };
                case 'Thiên Tài': return { border: 'border-yellow-500', text: 'text-yellow-300', bg: 'bg-gradient-to-br from-yellow-900/50 to-black/80', shadow: 'shadow-[0_0_10px_rgba(234,179,8,0.3)]', ring: 'ring-1 ring-yellow-500/30' };
                case 'Tốt': return { border: 'border-purple-500', text: 'text-purple-400', bg: 'bg-gray-800', shadow: '', ring: 'ring-1 ring-purple-500/30' };
                case 'Khá': return { border: 'border-blue-500', text: 'text-blue-400', bg: 'bg-gray-800', shadow: '', ring: 'ring-1 ring-blue-500/30' };
                case 'Bình Thường': return { border: 'border-gray-600', text: 'text-gray-300', bg: 'bg-gray-800', shadow: '', ring: '' };
                default: return { border: 'border-gray-700', text: 'text-gray-500', bg: 'bg-gray-800', shadow: '', ring: '' };
            }
        }

        // [MODIFIED] Cập nhật giao diện Render Disciple List
        function renderDiscipleList() {
            const listContainer = document.getElementById('disciple-list');
            if (!listContainer) return;

            if (gameData.disciples.length === 0) {
                 listContainer.innerHTML = `<p class="text-gray-400 md:col-span-2 lg:col-span-3 text-center py-8 bg-black/20 rounded-lg border border-dashed border-gray-700">Chưa có đệ tử nào. Hãy đến Chiêu Mộ Các!</p>`;
                 return;
            }

            // Sort disciples by level (descending)
            gameData.disciples.sort((a, b) => b.level - a.level);

            listContainer.innerHTML = gameData.disciples.map(d => {
                // ... (Code lấy style, stats, avatar giữ nguyên) ...
                const disciplePotential = d.potential || 'Yếu Kém';
                const style = getPotentialStyle(disciplePotential);
                const finalStats = calculateDiscipleStats(d);
                const imageUrl = DISCIPLE_POTENTIAL_IMAGES[disciplePotential];
                
                // [NEW] Lấy thông tin Khí Vận
                const destinyKey = d.destiny || 'PHAM_NHAN';
                const destinyInfo = DESTINY_DB[destinyKey] || DESTINY_DB['PHAM_NHAN'];
                
                let avatarHtml = '';
                
                if (imageUrl && imageUrl.trim() !== '') {
                    avatarHtml = `<img src="${imageUrl}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" alt="${disciplePotential}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                  <i class="fa-solid fa-user-ninja text-3xl ${style.text} relative z-0 group-hover:scale-110 transition hidden"></i>`;
                } else {
                    avatarHtml = `<i class="fa-solid fa-user-ninja text-3xl ${style.text} relative z-0 group-hover:scale-110 transition"></i>`;
                }
                
                let nameEffectClass = 'text-gray-300';
                switch(disciplePotential) {
                    // ... (Code switch case giữ nguyên) ...
                    case 'Yếu Kém': nameEffectClass = 'name-potential-weak'; break;
                    case 'Bình Thường': nameEffectClass = 'name-potential-normal'; break;
                    case 'Khá': nameEffectClass = 'name-potential-good'; break;
                    case 'Tốt': nameEffectClass = 'name-potential-excellent'; break;
                    case 'Thiên Tài': nameEffectClass = 'name-potential-genius'; break;
                    case 'Tuyệt Thế': nameEffectClass = 'name-potential-peerless'; break;
                    case 'Thiên Kiêu Chi Tử': nameEffectClass = 'name-potential-heavenly'; break;
                    case 'Nghịch Thiên Cải Mệnh': nameEffectClass = 'name-potential-defying'; break;
                    case 'Vô Cực Đạo Thể': nameEffectClass = 'name-potential-dao'; break;
                    case 'Vạn Đạo Chi Tổ': nameEffectClass = 'name-potential-ancestor'; break;
                    case 'Chân Ngã Duy Nhất': nameEffectClass = 'name-potential-trueself'; break;
                    case 'Nhất Niệm Vĩnh Hằng': nameEffectClass = 'name-potential-eternal'; break;
                    default: nameEffectClass = 'text-gray-300';
                }
                
                // Lấy rank info (Nội môn, Ngoại môn...)
                const rankInfo = getDiscipleRank(d.level);

                // ... (Code xử lý nút bấm giữ nguyên) ...
                const COOLDOWN_MS = 2 * 60 * 1000; 
                const now = Date.now();
                const lastTuLuyenTime = d.lastTuLuyen || 0;
                const timePassed = now - lastTuLuyenTime;
                let tuLuyenButtonHtml = '';

                if (timePassed < COOLDOWN_MS) {
                    const remainingSeconds = Math.ceil((COOLDOWN_MS - timePassed) / 1000);
                    tuLuyenButtonHtml = `<button class="flex-1 text-xs bg-gray-700 text-gray-500 font-bold py-1.5 px-2 rounded border border-gray-600 cursor-not-allowed">Hồi (${remainingSeconds}s)</button>`;
                } else {
                    tuLuyenButtonHtml = `<button onclick="startTuLuyen('${d.id}')" class="flex-1 text-xs bg-blue-600 hover:bg-blue-500 text-white font-bold py-1.5 px-2 rounded border border-blue-500 transition">Tu Luyện</button>`;
                }

                let xuatSuButtonHtml = '';
                if (d.level >= 80) {
                    xuatSuButtonHtml = `<button onclick="confirmXuatSu('${d.id}')" class="flex-1 text-xs bg-orange-600 hover:bg-orange-500 text-white font-bold py-1.5 px-2 rounded border border-orange-500 transition">Xuất Sư</button>`;
                }

                let xuatChienButtonHtml = '';
                const isChampion = gameData.sect.combatChampionId === d.id;
                if (isChampion) {
                    xuatChienButtonHtml = `<button onclick="selectCombatChampion('${d.id}')" class="w-full text-xs bg-green-600/20 text-green-400 border border-green-500/50 font-bold py-1 px-2 rounded mb-2"><i class="fa-solid fa-check mr-1"></i>Đang Xuất Chiến</button>`;
                } else if (d.status !== 'Nhàn Rỗi') {
                    // Button disabled but visible handled elsewhere or simple disabled logic here if needed
                } else {
                    xuatChienButtonHtml = `<button onclick="selectCombatChampion('${d.id}')" class="w-full text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 border border-gray-500 font-bold py-1 px-2 rounded mb-2 transition">Chọn Xuất Chiến</button>`;
                }

                let lockIconHtml = '';
                if (d.isLocked) {
                    lockIconHtml = `<i onclick="toggleDiscipleLock('${d.id}')" class="fa-solid fa-lock text-yellow-500 cursor-pointer hover:text-yellow-400 text-sm absolute top-3 right-3 z-20" title="Đã Khóa (An toàn)"></i>`;
                } else {
                    lockIconHtml = `<i onclick="toggleDiscipleLock('${d.id}')" class="fa-solid fa-lock-open text-gray-600 cursor-pointer hover:text-gray-400 text-sm absolute top-3 right-3 z-20" title="Mở Khóa"></i>`;
                }

                const talents = getDiscipleTalents(d.id, disciplePotential);
                let talentsHtml = `<div class="flex flex-wrap gap-1.5 mt-2 mb-3 justify-center">`;
                talents.forEach(t => {
                    const colorClass = getTalentColorClass(t.quality);
                    // [MODIFIED] Sử dụng showTooltip thay vì title mặc định
                    const safeName = t.name.replace(/'/g, "\\'"); // Escape tên
                    talentsHtml += `<span class="${colorClass} border px-2 py-1 rounded text-[10px] font-bold shadow-sm whitespace-nowrap select-none cursor-help hover:scale-105 transition-transform" 
                                          onmouseover="showTooltip(event, 'talent', '${safeName}')" 
                                          onmouseout="hideTooltip()">
                                    ${t.name}
                                    </span>`;
                });
                talentsHtml += `</div>`;
                
                const xpPercent = ((d.xp || 0) / (d.xpToNext || 1)) * 100;

                return `
                <div class="relative rounded-xl p-4 border ${style.border} ${style.bg} ${style.shadow} ${style.ring} transition-all duration-300 hover:-translate-y-1 pt-8"> <!-- [MODIFIED] Thêm pt-8 để tránh đè -->
                    ${lockIconHtml}
                    
                    <!-- [MODIFIED] Rank Badge Moved to Top Left -->
                    <span class="absolute top-2 left-2 z-20 text-[9px] font-bold px-2 py-0.5 rounded-full bg-gray-900/90 border border-gray-700 ${rankInfo.class} cursor-help shadow-md" 
                          onmouseover="showTooltip(event, 'rank_bonus', '${rankInfo.name}')" 
                          onmouseout="hideTooltip()">
                        ${rankInfo.name}
                    </span>
                    
                    <!-- Header: Avatar & Name -->
                    <div class="flex flex-col items-center text-center mb-1 relative z-10">
                        <div class="w-14 h-14 rounded-full bg-gray-900 border-2 ${style.border} flex items-center justify-center mb-2 shadow-inner overflow-hidden relative group">
                             <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent z-10 pointer-events-none"></div>
                             ${avatarHtml}
                             <div class="absolute bottom-0 w-full text-[8px] font-bold bg-black/70 text-white z-20 py-0.5">Lv.${d.level}</div>
                        </div>
                        
                        <h5 class="font-bold text-base ${nameEffectClass} truncate w-full px-2 tracking-wide">${d.name}</h5>
                        
                        <!-- [MODIFIED] Badge hiển thị Phẩm chất & Khí Vận (Đã tách Rank ra) -->
                        <div class="flex flex-wrap justify-center gap-1 mt-1">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-gray-900 border border-gray-700 ${style.text} cursor-help"
                                  onmouseover="showTooltip(event, 'potential_bonus', '${disciplePotential}')" 
                                  onmouseout="hideTooltip()">
                                ${disciplePotential}
                            </span>
                            <!-- [NEW] Badge Khí Vận -->
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-gray-900 border ${destinyInfo.border} ${destinyInfo.color} cursor-help flex items-center gap-1"
                                  onmouseover="showTooltip(event, 'destiny_bonus', '${destinyKey}')" 
                                  onmouseout="hideTooltip()">
                                <i class="${destinyInfo.icon} text-[9px]"></i> ${destinyInfo.shortName}
                            </span>
                        </div>
                    </div>

                    ${talentsHtml}

                    <!-- ... (Phần còn lại giữ nguyên) ... -->
                    <!-- Status -->
                    <div class="flex justify-between items-center text-xs mb-2 bg-black/20 px-2 py-1 rounded">
                        <span class="text-gray-400">Trạng thái:</span>
                        <span class="font-bold ${d.status !== 'Nhàn Rỗi' ? 'text-yellow-300 animate-pulse' : 'text-green-400'}">${d.status}</span>
                    </div>

                    <!-- Stats Grid (Compact) -->
                    <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-[10px] mb-3 bg-gray-900/50 p-2 rounded border border-gray-700/50">
                        <div class="flex justify-between"><span class="text-gray-500">HP</span> <span class="text-red-300 font-mono">${finalStats.hp.toLocaleString()}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Nội Lực</span> <span class="text-blue-300 font-mono">${(finalStats.mana || 0).toLocaleString()}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Công</span> <span class="text-orange-300 font-mono">${finalStats.atk.toLocaleString()}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Thủ</span> <span class="text-blue-300 font-mono">${(finalStats.def || 0).toLocaleString()}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Bạo Kích</span> <span class="text-yellow-300 font-mono">${(finalStats.crit || 0).toFixed(1)}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Né Tránh</span> <span class="text-green-300 font-mono">${(finalStats.dodge || 0).toFixed(1)}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">ST Bạo</span> <span class="text-red-400 font-mono font-bold">${finalStats.critDamage}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Hồn Lực</span> <span class="text-purple-300 font-mono">${(finalStats.honLuc || 0).toLocaleString()}</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Chính Xác</span> <span class="text-cyan-300 font-mono">${(finalStats.accuracy || 0).toFixed(1)}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Hút HP</span> <span class="text-pink-400 font-mono">${(finalStats.lifesteal || 0).toFixed(1)}%</span></div>
                        <!-- [NEW] Si Khi & Manasteal -->
                        <div class="flex justify-between"><span class="text-gray-500">Hút MP</span> <span class="text-indigo-400 font-mono">${(finalStats.manasteal || 0).toFixed(1)}%</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Sĩ Khí</span> <span class="text-yellow-200 font-mono font-bold">${(finalStats.si_khi || 0).toLocaleString()}</span></div> <!-- [NEW] -->
                        
                        <div class="flex justify-between col-span-2 text-center border-t border-gray-700/30 pt-1 mt-0.5">
                             <span class="text-gray-500 mr-2">Thân Pháp</span> <span class="text-green-300 font-mono">${(finalStats.spd || 0).toLocaleString()}</span>
                        </div>
                    </div>

                    <!-- XP Bar -->
                    <div class="w-full bg-gray-900 h-1.5 rounded-full mb-3 overflow-hidden border border-gray-700 relative">
                        <div class="bg-gradient-to-r from-green-600 to-emerald-400 h-full transition-all duration-500" style="width: ${xpPercent}%;"></div>
                    </div>

                    <!-- Actions -->
                    ${xuatChienButtonHtml}
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                         <button onclick="boostDisciple('${d.id}')" class="text-xs bg-yellow-700/80 hover:bg-yellow-600 text-yellow-100 font-bold py-1.5 px-2 rounded border border-yellow-600/50 transition">Bồi Dưỡng</button>
                         <button onclick="manageDiscipleSkills('${d.id}')" class="text-xs bg-indigo-700/80 hover:bg-indigo-600 text-indigo-100 font-bold py-1.5 px-2 rounded border border-indigo-600/50 transition">Võ Học</button>
                    </div>
                    
                    <!-- [MODIFIED] Thêm nút Tẩy Tủy vào hàng nút hành động -->
                    <div class="grid grid-cols-3 gap-1 mb-2">
                         ${tuLuyenButtonHtml}
                         <!-- Nút Tẩy Tủy Mới -->
                         <button onclick="confirmTayTuy('${d.id}')" class="text-xs bg-teal-700/80 hover:bg-teal-600 text-teal-100 font-bold py-1.5 px-1 rounded border border-teal-600/50 transition" title="Đổi Tư Chất & Khí Vận">Tẩy Tủy</button>
                         ${xuatSuButtonHtml ? xuatSuButtonHtml : `<button onclick="expelDisciple('${d.id}')" class="text-xs bg-red-900/80 hover:bg-red-700 text-red-200 font-bold py-1.5 px-1 rounded border border-red-800/50 transition">Trục Xuất</button>`}
                    </div>
                </div>
                `;
            }).join('');
        }

        // [NEW] Xác nhận Tẩy Tủy
        function confirmTayTuy(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) return;

            if (disciple.isLocked) {
                showToast(`BẢO VỆ: Đệ tử đang bị Khóa! Hãy mở khóa trước.`, false);
                return;
            }

            const cost = 1000; // 1000 KNB
            const canAfford = gameData.kimNguyenBao >= cost;

            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Tẩy Tủy Phạt Mao'; // Thay đổi căn cơ
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto bg-gray-900 rounded-full border-2 border-teal-500 flex items-center justify-center mb-3 shadow-[0_0_15px_#2dd4bf]">
                            <i class="fa-solid fa-dna text-3xl text-teal-300 animate-spin-slow"></i>
                        </div>
                        <p class="text-lg text-gray-200 font-bold mb-2">Tái tạo căn cơ cho <span class="text-yellow-300">${disciple.name}</span>?</p>
                        <div class="bg-gray-800 p-3 rounded border border-gray-600 text-sm space-y-2 mb-4 text-left">
                            <div class="flex justify-between border-b border-gray-700 pb-1">
                                <span class="text-gray-400">Tư chất hiện tại:</span>
                                <span class="text-white font-bold">${disciple.potential}</span>
                            </div>
                            <div class="flex justify-between border-b border-gray-700 pb-1">
                                <span class="text-gray-400">Khí vận hiện tại:</span>
                                <span class="text-white font-bold">${DESTINY_DB[disciple.destiny || 'PHAM_NHAN'].shortName}</span>
                            </div>
                            <p class="text-xs text-red-400 italic mt-2 text-center">
                                <i class="fa-solid fa-triangle-exclamation"></i> Lưu ý: Tư chất, Khí vận và Chỉ số cơ bản sẽ được tạo lại ngẫu nhiên. Cấp độ và Kỹ năng được giữ nguyên.
                            </p>
                        </div>
                        <p class="text-sm">Chi phí: <span class="${canAfford ? 'text-yellow-300' : 'text-red-500'} font-bold">${cost.toLocaleString()} KNB</span></p>
                    </div>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button onclick="performTayTuy('${discipleId}', ${cost})" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded shadow-lg transition transform hover:scale-105 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        Bắt Đầu
                    </button>
                `;
            }
            
            showModal('dungeon-confirm-modal');
        }

        // [NEW] Thực hiện Tẩy Tủy
        function performTayTuy(discipleId, cost) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) return;

            if (gameData.kimNguyenBao < cost) {
                showToast("Không đủ Kim Nguyên Bảo!", false);
                return;
            }

            // 1. Trừ tiền
            gameData.kimNguyenBao -= cost;

            // 2. Random lại Tư Chất (Dùng lại logic từ recruitDisciple)
            const potentialLevels = ['Yếu Kém', 'Bình Thường', 'Khá', 'Tốt', 'Thiên Tài', 'Tuyệt Thế', 'Thiên Kiêu Chi Tử', 'Nghịch Thiên Cải Mệnh', 'Vô Cực Đạo Thể', 'Vạn Đạo Chi Tổ', 'Chân Ngã Duy Nhất', 'Nhất Niệm Vĩnh Hằng'];
            
            // Trọng số (Giống chiêu mộ)
            const baseWeights = [4000, 3000, 1500, 1000, 350, 100, 30, 10, 5, 3, 1.5, 0.5];
            
            // Áp dụng bonus từ Tụ Linh Trận (Nếu có nâng cấp)
            const minPotentialBonus = getSectUpgradeBonus('minPotential'); 
            const minPotentialIndex = Math.floor(minPotentialBonus);
            
            let currentWeights = [...baseWeights];
            for(let i = 0; i < minPotentialIndex; i++) currentWeights[i] = 0; 
            
            let totalWeight = currentWeights.reduce((a, b) => a + b, 0);
            let randomValue = Math.random() * totalWeight;
            let selectedIndex = 0;
            
            for(let i = 0; i < currentWeights.length; i++) {
                randomValue -= currentWeights[i];
                if (randomValue <= 0) { selectedIndex = i; break; }
            }
            if (selectedIndex >= potentialLevels.length) selectedIndex = potentialLevels.length - 1;
            
            const newPotential = potentialLevels[selectedIndex];

            // 3. Random lại Khí Vận
            const destinyRoll = Math.random();
            let newDestiny = "PHAM_NHAN";
            
            if (destinyRoll < 0.01) newDestiny = "THIEN_TIEN";
            else if (destinyRoll < 0.02) newDestiny = "KIEM_THAN";
            else if (destinyRoll < 0.03) newDestiny = "MA_THAN";
            else if (destinyRoll < 0.04) newDestiny = "THANH_NHAN";
            else if (destinyRoll < 0.055) newDestiny = "THIEN_MENH";
            else if (destinyRoll < 0.07) newDestiny = "NGU_HANH";
            else if (destinyRoll < 0.09) newDestiny = "HUYET_SAT";
            else if (destinyRoll < 0.11) newDestiny = "BAT_DIET";
            else if (destinyRoll < 0.13) newDestiny = "HU_KHONG";
            else if (destinyRoll < 0.15) newDestiny = "DUOC_LINH";
            else if (destinyRoll < 0.18) newDestiny = "NGHICH_THIEN";
            else if (destinyRoll < 0.21) newDestiny = "TRONG_DONG";
            else if (destinyRoll < 0.25) newDestiny = "CUU_DUONG";
            else if (destinyRoll < 0.29) newDestiny = "THAI_AM";
            else if (destinyRoll < 0.36) newDestiny = "TIEN_THIEN";
            else if (destinyRoll < 0.45) newDestiny = "LINH_DIEU";
            else if (destinyRoll < 0.65) newDestiny = "HOANG_GIA";

            // 4. Random lại Chỉ Số Cơ Bản (Base Stats)
            const newStats = { 
                hp: 50 + Math.floor(Math.random()*20), 
                atk: 5 + Math.floor(Math.random()*3),
                def: 1 + Math.floor(Math.random()*2),
                spd: 1 + Math.floor(Math.random()*2),
                mana: 20 + Math.floor(Math.random()*10),
                honLuc: 20 + Math.floor(Math.random()*10), 
                crit: Math.floor(Math.random()*3),
                dodge: Math.floor(Math.random()*3),
                critDamage: Math.floor(Math.random()*10),
                accuracy: Math.floor(Math.random()*3),
                lifesteal: Math.floor(Math.random()*2), 
                manasteal: Math.floor(Math.random()*2),
                si_khi: Math.floor(Math.random()*5)
            };

            // Áp dụng thay đổi
            disciple.potential = newPotential;
            disciple.destiny = newDestiny;
            disciple.stats = newStats; // Base stats reset, but level scaling applied in calculateDiscipleStats

            // 5. Thông báo & Cập nhật
            hideModal('dungeon-confirm-modal');
            
            // Tạo thông báo đẹp nếu ra đồ ngon
            if (['Thiên Tài', 'Tuyệt Thế', 'Thiên Kiêu Chi Tử', 'Nghịch Thiên Cải Mệnh', 'Vô Cực Đạo Thể', 'Vạn Đạo Chi Tổ', 'Chân Ngã Duy Nhất', 'Nhất Niệm Vĩnh Hằng'].includes(newPotential)) {
                showToast(`Tẩy Tủy Đại Thành công! ${disciple.name} lột xác thành ${newPotential}!`, true);
                addSectLog(`${disciple.name} tẩy tủy nghịch thiên, đạt được tư chất [${newPotential}]!`, 'reward');
            } else {
                showToast(`Tẩy Tủy hoàn tất for ${disciple.name}.`, true);
            }

            updateUI();
            renderDiscipleList();
        }

        // [NEW] Các hàm cho nút đệ tử
        function boostDisciple(discipleId) {
             // [MODIFIED] Logic to check for all pill types
             const pillPriority = ['disciple_xp_pill_3', 'disciple_xp_pill_2', 'disciple_xp_pill_1'];
             // [MODIFIED] This function no longer uses the pill directly.
             // It now opens the boost modal.
             const disciple = gameData.disciples.find(d => d.id === discipleId);
             if (!disciple) {
                showToast("Không tìm thấy đệ tử!", false);
                return;
             }

             // [NEW] Store the ID of the disciple being boosted
             currentBoostingDiscipleId = discipleId;
             renderBoostDiscipleModal(discipleId);
             showModal('boost-disciple-modal');
        }
        
        // [NEW] Selects a disciple for turn-based combat
        function selectCombatChampion(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) {
                showToast("Không tìm thấy đệ tử!", false);
                return;
            }
            if (disciple.status !== 'Nhàn Rỗi' && gameData.sect.combatChampionId !== discipleId) {
                showToast("Đệ tử này đang bận, không thể xuất chiến!", false);
                return;
            }
            
            // Toggle selection
            if (gameData.sect.combatChampionId === discipleId) {
                gameData.sect.combatChampionId = null;
                showToast(`Đã hủy chọn ${disciple.name} xuất chiến.`, true);
            } else {
                gameData.sect.combatChampionId = discipleId;
                // [MODIFIED] Cập nhật thông báo hiển thị bonus
                showToast(`${disciple.name} xuất chiến! Cộng 30% chỉ số cho Tông Chủ.`, true);
            }
            
            renderDiscipleList();
            updateUI(); // [NEW] Cập nhật ngay chỉ số nhân vật chính
        }

        // [NEW] Toggle disciple lock
        function toggleDiscipleLock(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) {
                showToast("Không tìm thấy đệ tử!", false);
                return;
            }
            
            disciple.isLocked = !disciple.isLocked;
            
            if (disciple.isLocked) {
                showToast(`${disciple.name} đã được khóa (an toàn).`, true);
                // If this disciple was selected as a material, remove them
                const index = selectedTruyenCongMaterials.indexOf(discipleId);
                if (index > -1) {
                    selectedTruyenCongMaterials.splice(index, 1);
                }
            } else {
                showToast(`${disciple.name} đã được mở khóa.`, true);
            }
            
            // Re-render relevant UIs
            renderDiscipleList();
            if (!document.getElementById('panel-truyen-cong').classList.contains('hidden')) {
                renderTruyenCongPanel();
            }
        }

        // [NEW] Renders the content for the new disciple boost modal
        function renderBoostDiscipleModal(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) return;

            const titleEl = document.getElementById('boost-disciple-title');
            const contentEl = document.getElementById('boost-disciple-content');
            
            titleEl.textContent = `Bồi Dưỡng: ${disciple.name} (Cấp ${disciple.level})`;

            let html = `
                <h4 class="font-bold text-lg mb-2 text-cyan-400">Chỉ Số Cơ Bản Hiện Tại</h4>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm bg-gray-700 p-3 rounded mb-4">
                    <span><strong class="text-red-400">Sinh Lực:</strong> ${disciple.stats.hp}</span>
                    <span><strong class="text-blue-300">Nội Lực:</strong> ${disciple.stats.mana || 0}</span>
                    <span><strong class="text-orange-400">Công Kích:</strong> ${disciple.stats.atk}</span>
                    <span><strong class="text-blue-400">Phòng Thủ:</strong> ${disciple.stats.def || 0}</span>
                    <span><strong class="text-yellow-300">Bạo Kích:</strong> ${(disciple.stats.crit || 0)}%</span>
                    <span><strong class="text-green-300">Né Tránh:</strong> ${(disciple.stats.dodge || 0)}%</span>
                    <span><strong class="text-red-400">ST Bạo:</strong> ${(150 + (disciple.stats.critDamage || 0))}%</span>
                    <span><strong class="text-purple-300">Hồn Lực:</strong> ${disciple.stats.honLuc || 0}</span>
                    <span><strong class="text-cyan-300">Chính Xác:</strong> ${disciple.stats.accuracy || 0}%</span>
                    <span><strong class="text-pink-400">Hút HP:</strong> ${(disciple.stats.lifesteal || 0)}%</span>
                    <span><strong class="text-indigo-400">Hút MP:</strong> ${(disciple.stats.manasteal || 0)}%</span>
                    <span><strong class="text-yellow-200">Sĩ Khí:</strong> ${(disciple.stats.si_khi || 0)}</span> <!-- [NEW] -->
                    <span class="col-span-2 text-center border-t border-gray-600 pt-1 mt-1"><strong class="text-green-400">Thân Pháp:</strong> ${disciple.stats.spd || 0}</span>
                </div>
                
                <h4 class="font-bold text-lg mb-3 text-cyan-400">Đan Dược Khả Dụng</h4>
                <div class="space-y-2">
            `;

            const pillsToCheck = [
                'disciple_xp_pill_3', 'disciple_xp_pill_2', 'disciple_xp_pill_1',
                // [MODIFIED] Add Tier 2 and Tier 3 pills
                'disciple_atk_pill_3', 'disciple_hp_pill_3', 'disciple_def_pill_3', 'disciple_spd_pill_3',
                'disciple_atk_pill_2', 'disciple_hp_pill_2', 'disciple_def_pill_2', 'disciple_spd_pill_2',
                'disciple_atk_pill_1', 'disciple_hp_pill_1', 'disciple_def_pill_1', 'disciple_spd_pill_1'
            ];

            let pillsFound = 0;

            pillsToCheck.forEach(pillId => {
                const itemDB = STATIC_ITEM_DB[pillId];
                const owned = gameData.items[pillId] || 0;

                if (owned > 0) {
                    pillsFound++;
                    let effectText = '';
                    if (itemDB.effect.target === 'disciple_xp') {
                        effectText = `+${itemDB.effect.value.toLocaleString()} XP`;
                    } else if (itemDB.effect.target === 'disciple_stat') {
                        effectText = `+${itemDB.effect.value} ${itemDB.effect.stat.toUpperCase()} cơ bản`;
                    }

                    html += `
                    <div class="bg-gray-700 rounded p-3 flex items-center justify-between">
                        <div>
                            <p class="font-bold ${getRarityClass(itemDB.rarity)}">${itemDB.name}</p>
                            <p class="text-xs text-yellow-300">${effectText}</p>
                        </div>
                        <button onclick="useDisciplePill('${discipleId}', '${pillId}')" class="text-xs bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded">
                            Dùng (Có: ${owned})
                        </button>
                    </div>
                    `;
                }
            });

            if (pillsFound === 0) {
                html += `<p class="text-center text-gray-400">Bạn không sở hữu loại đan dược bồi dưỡng nào.</p>`;
            }

            html += `</div>`;
            contentEl.innerHTML = html;
        }

        // [NEW] Handles the logic for using a pill from the modal
        function useDisciplePill(discipleId, pillId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            const itemDB = STATIC_ITEM_DB[pillId];
            
            if (!disciple || !itemDB) {
                showToast("Lỗi: Không tìm thấy đệ tử hoặc vật phẩm!", false);
                return;
            }

            if (!gameData.items[pillId] || gameData.items[pillId] <= 0) {
                showToast(`Đã hết ${itemDB.name}!`, false);
                // Re-render modal to remove the button
                renderBoostDiscipleModal(discipleId);
                return;
            }

            // 1. Consume item
            gameData.items[pillId]--;
            if (gameData.items[pillId] <= 0) {
                delete gameData.items[pillId];
            }

            // 2. Apply effect
            if (itemDB.effect.target === 'disciple_xp') {
                const xpAmount = itemDB.effect.value;
                
                // [MODIFIED] Tính toán hiển thị XP thực nhận (bao gồm bonus phẩm chất)
                const potential = disciple.potential || 'Yếu Kém';
                const bonusPercent = POTENTIAL_XP_BONUS[potential] || 0;
                const bonusMultiplier = 1 + (bonusPercent / 100);
                const finalXp = Math.floor(xpAmount * bonusMultiplier);
                
                addDiscipleXp(discipleId, xpAmount); // Hàm này vẫn xử lý logic cộng XP và thăng cấp bên trong
                
                // Hiển thị thông báo số XP thực tế
                showToast(`${disciple.name} nhận ${finalXp.toLocaleString()} XP! (Đã tính bonus ${potential})`, true);
            
            } else if (itemDB.effect.target === 'disciple_stat') {
                const stat = itemDB.effect.stat;
                const value = itemDB.effect.value;
                
                if (disciple.stats[stat] !== undefined) {
                    disciple.stats[stat] += value;
                    showToast(`${disciple.name} dùng ${itemDB.name}, ${stat.toUpperCase()} cơ bản tăng +${value}!`, true);
                } else {
                    console.error(`Lỗi: Đệ tử không có chỉ số ${stat}`);
                }
            }

            // 3. Re-render modals
            renderBoostDiscipleModal(discipleId); // Re-render this modal to update counts
            renderDiscipleList(); // Re-render main list to show new stats (if tab is active)
            
            // Re-render other modals that might show pill counts
            if (!document.getElementById('equipment-modal').classList.contains('hidden')) {
                 renderModalContent('equipment-modal');
            }
            if (!document.getElementById('tho-ren-modal').classList.contains('hidden')) {
                 renderCraftingList();
            }
        }

        // [NEW] Quản lý Võ Học Đệ Tử
        function manageDiscipleSkills(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) {
                showToast("Không tìm thấy đệ tử!", false);
                return;
            }
            
            // Đảm bảo đệ tử có mảng skills (migration cho save cũ)
            if (!disciple.skills) disciple.skills = [];
            // Đảm bảo đệ tử có object basicSkills để lưu cấp độ kỹ năng cơ bản
            if (!disciple.basicSkills) disciple.basicSkills = {};

            renderDiscipleSkillsModal(disciple);
            showModal('disciple-skills-modal');
        }

        function renderDiscipleSkillsModal(disciple) {
            const titleEl = document.getElementById('disciple-skills-title');
            const contentEl = document.getElementById('disciple-skills-content');
            const dchDisplay = document.getElementById('skill-modal-dch-display');
            
            // Cập nhật header
            titleEl.innerHTML = `<i class="fa-solid fa-book-journal-whills mr-2"></i>Võ Học: ${disciple.name}`;
            if(dchDisplay) dchDisplay.textContent = (gameData.diemCongHien || 0).toLocaleString();
            
            // Màu sắc phẩm chất
            let potentialColor = 'text-gray-400';
            let borderClass = 'border-gray-600';
            let glowClass = '';
            
            if (disciple.potential === 'Thiên Tài') { potentialColor = 'text-yellow-300'; borderClass = 'border-yellow-500'; glowClass = 'shadow-[0_0_15px_rgba(234,179,8,0.3)]'; }
            else if (disciple.potential === 'Tuyệt Thế') { potentialColor = 'text-red-400'; borderClass = 'border-red-500'; glowClass = 'shadow-[0_0_15px_rgba(239,68,68,0.4)]'; }
            else if (['Thiên Kiêu Chi Tử', 'Nghịch Thiên Cải Mệnh', 'Vô Cực Đạo Thể', 'Vạn Đạo Chi Tổ', 'Chân Ngã Duy Nhất', 'Nhất Niệm Vĩnh Hằng'].includes(disciple.potential)) { 
                potentialColor = 'text-rainbow-animation'; 
                borderClass = 'border-white';
                glowClass = 'shadow-[0_0_20px_rgba(255,255,255,0.3)]';
            }

            // Cập nhật lại thông tin đệ tử mới nhất từ gameData
            const currentDisciple = gameData.disciples.find(d => d.id === disciple.id) || disciple;

            // --- UI MỚI ---
            let html = `
                <!-- Phần 1: Thông tin Đệ Tử (Card Ngang) -->
                <div class="flex flex-col md:flex-row gap-6 mb-8">
                    <!-- Avatar & Basic Info -->
                    <div class="w-full md:w-1/3 bg-gray-800 rounded-xl p-4 border ${borderClass} ${glowClass} flex flex-col items-center text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-500 to-transparent"></div>
                        
                        <div class="w-24 h-24 rounded-full bg-gray-900 flex items-center justify-center border-4 border-indigo-500/30 mb-3 relative group">
                            <i class="fa-solid fa-user-ninja text-5xl text-indigo-300 group-hover:scale-110 transition duration-300"></i>
                            <div class="absolute bottom-0 right-0 bg-gray-900 rounded-full p-1 border border-gray-600">
                                <span class="text-xs font-bold px-1 text-white">${currentDisciple.level}</span>
                            </div>
                        </div>
                        
                        <h4 class="text-xl font-bold text-white mb-1">${currentDisciple.name}</h4>
                        <p class="text-sm text-indigo-300 mb-1">${getDiscipleRank(currentDisciple.level).name}</p>
                        <span class="px-3 py-1 rounded-full bg-gray-900 text-xs font-bold border border-gray-600 ${potentialColor}">${currentDisciple.potential}</span>
                    </div>

                    <!-- Stats Grid -->
                    <div class="w-full md:w-2/3 bg-gray-800/50 rounded-xl p-5 border border-gray-700 flex flex-col justify-center">
                        <h5 class="text-gray-400 text-sm font-bold uppercase tracking-wider mb-4 border-b border-gray-700 pb-2">Chỉ Số Chiến Đấu</h5>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div class="bg-gray-900 p-3 rounded-lg border border-red-900/50">
                                <p class="text-xs text-gray-500 mb-1"><i class="fa-solid fa-heart text-red-500 mr-1"></i>Sinh Lực</p>
                                <p class="text-lg font-bold text-red-400">${currentDisciple.stats.hp.toLocaleString()}</p>
                            </div>
                            <div class="bg-gray-900 p-3 rounded-lg border border-orange-900/50">
                                <p class="text-xs text-gray-500 mb-1"><i class="fa-solid fa-khanda text-orange-500 mr-1"></i>Công Kích</p>
                                <p class="text-lg font-bold text-orange-400">${currentDisciple.stats.atk.toLocaleString()}</p>
                            </div>
                            <div class="bg-gray-900 p-3 rounded-lg border border-blue-900/50">
                                <p class="text-xs text-gray-500 mb-1"><i class="fa-solid fa-shield-halved text-blue-500 mr-1"></i>Phòng Thủ</p>
                                <p class="text-lg font-bold text-blue-400">${(currentDisciple.stats.def || 0).toLocaleString()}</p>
                            </div>
                            <div class="bg-gray-900 p-3 rounded-lg border border-green-900/50">
                                <p class="text-xs text-gray-500 mb-1"><i class="fa-solid fa-wind text-green-500 mr-1"></i>Thân Pháp</p>
                                <p class="text-lg font-bold text-green-400">${(currentDisciple.stats.spd || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phần 2: Danh Sách Kỹ Năng (Grid Layout) -->
                <div class="flex items-center justify-between mb-4">
                    <h5 class="font-bold text-xl text-indigo-300 flex items-center">
                        <i class="fa-solid fa-book-medical mr-2"></i>Tàng Kinh Các
                    </h5>
                    <span class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded">Học bằng Điểm Cống Hiến</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            `;
            
            // Render Basic Skills List (Grid)
            // [MODIFIED] Dùng Object.keys để duyệt tuần tự
            const skillKeys = Object.keys(BASIC_DISCIPLE_SKILLS);

            for (let i = 0; i < skillKeys.length; i++) {
                const skillKey = skillKeys[i];
                const skillData = BASIC_DISCIPLE_SKILLS[skillKey];

                const currentLevel = (currentDisciple.basicSkills && currentDisciple.basicSkills[skillKey]) || 0;
                const nextCost = skillData.cost * (currentLevel + 1);
                const canAfford = (gameData.diemCongHien || 0) >= nextCost;
                const isMax = currentLevel >= skillData.maxLevel;
                
                // [NEW] Kiểm tra điều kiện khóa tuần tự
                let isLocked = false;
                if (i > 0) {
                    const prevKey = skillKeys[i - 1];
                    const prevLevel = (currentDisciple.basicSkills && currentDisciple.basicSkills[prevKey]) || 0;
                    const prevMax = BASIC_DISCIPLE_SKILLS[prevKey].maxLevel;
                    if (prevLevel < prevMax) {
                        isLocked = true;
                    }
                }
                
                // Style màu sắc tên kỹ năng
                const skillColor = skillData.color || 'text-white';
                let cardBorder = 'border-gray-700';
                let cardBg = 'bg-gray-800';
                
                // Highlight kỹ năng cao cấp
                if (skillData.cost >= 10000) { cardBorder = 'border-purple-900'; cardBg = 'bg-gray-800/80'; }
                if (skillData.cost >= 100000) { cardBorder = 'border-yellow-900'; }

                let btnHtml = '';
                if (isLocked) {
                    // [NEW] Nút khi bị khóa
                    btnHtml = `<button class="w-full bg-gray-800 text-gray-600 font-bold py-2 px-3 rounded text-xs cursor-not-allowed border border-gray-700" disabled>
                        <i class="fa-solid fa-lock mr-1"></i>Cần Max Tầng Trước
                    </button>`;
                } else if (isMax) {
                    btnHtml = `<button class="w-full bg-gray-700 text-gray-500 font-bold py-2 px-3 rounded text-xs cursor-not-allowed border border-gray-600">Đã Đạt Giới Hạn</button>`;
                } else {
                    btnHtml = `<button onclick="performLearnBasicSkill('${currentDisciple.id}', '${skillKey}', ${nextCost})" 
                                class="w-full font-bold py-2 px-3 rounded text-xs flex items-center justify-center gap-2 transition transform active:scale-95
                                ${canAfford ? 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}" 
                                ${!canAfford ? 'disabled' : ''}>
                                <span>Lĩnh Ngộ</span>
                                <span class="${canAfford ? 'text-lime-300' : 'text-gray-500'}">(${nextCost.toLocaleString()})</span>
                               </button>`;
                }

                // [NEW] Hiệu ứng mờ khi bị khóa
                const opacityClass = isLocked ? "opacity-50 grayscale" : "";

                html += `
                <div class="${cardBg} rounded-xl p-4 border ${cardBorder} hover:border-indigo-500 transition duration-200 flex flex-col justify-between group h-full relative overflow-hidden ${opacityClass}">
                    <div class="absolute top-0 right-0 bg-gray-900 px-2 py-1 rounded-bl-lg border-b border-l border-gray-700 z-10">
                        <span class="text-[10px] text-gray-400">Tầng <span class="text-yellow-400 font-bold text-sm">${currentLevel}</span>/${skillData.maxLevel}</span>
                    </div>
                    
                    <div class="flex items-start gap-3 mb-3">
                        <div class="w-12 h-12 rounded-lg bg-gray-900 flex items-center justify-center text-2xl shadow-inner flex-shrink-0">
                            <i class="${skillData.icon} ${skillColor}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-sm ${skillColor} mb-1 group-hover:text-white transition">${skillData.name}</p>
                            <p class="text-[10px] text-green-400 font-mono bg-black/30 px-1.5 py-0.5 rounded inline-block">
                                +${skillData.effect.value.toLocaleString()} ${skillData.effect.stat.toUpperCase()}/tầng
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex-grow mb-3">
                        <p class="text-xs text-gray-400 leading-relaxed h-8 overflow-hidden text-ellipsis line-clamp-2">${skillData.desc}</p>
                    </div>
                    
                    <div>
                        ${btnHtml}
                    </div>
                </div>`;
            }
            
            html += `</div>`;
            
            // Phần 3: Tuyệt Kỹ Đã Lĩnh Ngộ (Grid 3 cột)
            if (currentDisciple.skills && currentDisciple.skills.length > 0) {
                 html += `
                 <h5 class="font-bold text-xl text-orange-400 mb-4 flex items-center border-t border-gray-700 pt-4">
                    <i class="fa-solid fa-star mr-2"></i>Tuyệt Kỹ Đã Lĩnh Ngộ 
                    <span class="text-sm text-gray-500 ml-2 font-normal">(${currentDisciple.skills.length}/3)</span>
                 </h5>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">`;
                 
                 currentDisciple.skills.forEach(skill => {
                    html += `
                    <div class="bg-gray-800/80 p-3 rounded-lg border border-orange-500/30 relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 bg-orange-500/10 w-16 h-16 rounded-full blur-xl"></div>
                        <p class="font-bold text-sm text-orange-300 mb-1">${skill.name}</p>
                        <p class="text-xs text-gray-400 h-8 overflow-hidden line-clamp-2">${skill.desc}</p>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html += `
                <div class="border-t border-gray-700 pt-4">
                     <h5 class="font-bold text-xl text-gray-500 mb-2 flex items-center">
                        <i class="fa-solid fa-star mr-2"></i>Tuyệt Kỹ
                    </h5>
                    <p class="text-gray-500 text-sm italic pl-2">Đệ tử chưa học tuyệt kỹ nào từ Bí Kíp.</p>
                </div>
                `;
            }
            
            contentEl.innerHTML = html;
        }

        // [NEW] Thực hiện học kỹ năng (Trực tiếp, không qua modal xác nhận)
        function performLearnBasicSkill(discipleId, skillKey, cost) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            const skillData = BASIC_DISCIPLE_SKILLS[skillKey];
            
            if (!disciple || !skillData) return;

            // [NEW] Kiểm tra điều kiện tuần tự (Server-side validation)
            const skillKeys = Object.keys(BASIC_DISCIPLE_SKILLS);
            const index = skillKeys.indexOf(skillKey);
            if (index > 0) {
                const prevKey = skillKeys[index - 1];
                const prevLevel = (disciple.basicSkills && disciple.basicSkills[prevKey]) || 0;
                const prevMax = BASIC_DISCIPLE_SKILLS[prevKey].maxLevel;
                
                if (prevLevel < prevMax) {
                    showToast(`Cần luyện ${BASIC_DISCIPLE_SKILLS[prevKey].name} lên tầng tối đa trước!`, false);
                    return;
                }
            }
            
            if ((gameData.diemCongHien || 0) < cost) {
                showToast("Không đủ Điểm Cống Hiến!", false);
                return;
            }

            // 1. Trừ chi phí
            gameData.diemCongHien -= cost;

            // 2. Tăng chỉ số
            if (!disciple.basicSkills) disciple.basicSkills = {};
            const currentLevel = disciple.basicSkills[skillKey] || 0;
            
            disciple.basicSkills[skillKey] = currentLevel + 1;
            
            // Cộng thẳng vào stats của đệ tử
            const statType = skillData.effect.stat;
            const statValue = skillData.effect.value;
            
            // Tự động khởi tạo chỉ số nếu chưa có
            if (disciple.stats[statType] === undefined) {
                disciple.stats[statType] = 0;
            }
            
            // [MODIFIED] Xử lý đặc biệt cho các kỹ năng "ALL STATS" (Đạo Sinh Nhất & Chúa Tể Vô Cực)
            if (skillKey === 'skill_origin_all' || skillKey === 'skill_infinity_all') {
                // Cộng thêm cho các chỉ số khác ngoài ATK (statValue ở đây là ATK)
                // Tỉ lệ: HP x10, Def x0.5, Spd x0.5 so với ATK
                
                disciple.stats.atk += statValue;
                disciple.stats.hp += statValue * 10;
                
                if (disciple.stats.def === undefined) disciple.stats.def = 0;
                disciple.stats.def += Math.floor(statValue * 0.5);
                
                if (disciple.stats.spd === undefined) disciple.stats.spd = 0;
                disciple.stats.spd += Math.floor(statValue * 0.5);
                
                showToast(`${disciple.name} bước chân vào cảnh giới Vô Thượng! Toàn bộ chỉ số tăng bạo!`, true);
                // Log đặc biệt
                addSectLog(`<span class="text-rainbow-animation font-bold">CHẤN ĐỘNG!</span> ${disciple.name} lĩnh ngộ ${skillData.name} tầng ${currentLevel + 1}, uy chấn tam giới!`, 'reward');
            } else {
                // Kỹ năng thường (1 chỉ số)
                disciple.stats[statType] += statValue;
                showToast(`${disciple.name} học ${skillData.name} (+${statValue.toLocaleString()} ${statType.toUpperCase()})`, true);
            }

            // 4. Cập nhật UI
            renderDiscipleSkillsModal(disciple); // Cập nhật modal kỹ năng
            
            // Cập nhật danh sách đệ tử nếu đang mở tab Bồi Dưỡng
            if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                renderDiscipleList();
            }
            updateUI(); // Cập nhật ĐCH ở UI chính
        }

        // [MODIFIED] Bỏ qua xác nhận 'prompt' theo yêu cầu của bạn
        function expelDisciple(discipleId) {
            const index = gameData.disciples.findIndex(d => d.id === discipleId);
            if (index === -1) {
                showToast("Không tìm thấy đệ tử!", false); return;
            }
            const discipleName = gameData.disciples[index].name;
            
            // [NEW] Check if disciple is in Song Tu
            const disciple = gameData.disciples[index];
            if (disciple.status === 'Đang Song Tu') {
                // Find the pair this disciple is in
                const pairIndex = gameData.sect.songTuPairs.findIndex(p => p.d1Id === discipleId || p.d2Id === discipleId);
                if (pairIndex > -1) {
                    const pair = gameData.sect.songTuPairs[pairIndex];
                    const otherDiscipleId = (pair.d1Id === discipleId) ? pair.d2Id : pair.d1Id;
                    const otherDisciple = gameData.disciples.find(d => d.id === otherDiscipleId);
                    
                    if (otherDisciple) {
                        otherDisciple.status = 'Nhàn Rỗi'; // Free the other disciple
                        addSectLog(`${disciple.name} bị trục xuất, ${otherDisciple.name} đã dừng Song Tu.`, 'info');
                    }
                    
                    gameData.sect.songTuPairs.splice(pairIndex, 1); // Remove the pair
                }
            }
            // [END NEW]

            // Trục xuất ngay lập tức, không cần xác nhận
            gameData.disciples.splice(index, 1);
            addSectLog(`${discipleName} đã bị trục xuất khỏi Tông Môn.`, 'error');
            showToast(`${discipleName} đã bị trục xuất.`, true);
            renderDiscipleList(); // Cập nhật lại danh sách
            renderRecruitPanel(); // Cập nhật lại số lượng
        }

        // [NEW] Placeholder function for the new button
        function startTuLuyen(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            
            const result = performTuLuyen(disciple); // Call the new core function

            if (result.success) {
                // Log and toast the specific message
                addSectLog(result.msg, 'reward');
                showToast(result.msg, true);

                // Update currency if needed
                if (result.rewards.nl > 0 || result.rewards.knb > 0) {
                    updateUI();
                }
            } else {
                // Show failure toast
                showToast(result.msg, false);
            }
            
            // Re-render the list immediately to show new cooldown or error
            renderDiscipleList();
        }
        
        /**
         * [NEW] Core logic for a single disciple's Tu Luyen
         * [MODIFIED] Added safety checks and optimization
         */
        function performTuLuyen(disciple) {
            if (!disciple) {
                return { success: false, msg: "Không tìm thấy đệ tử.", rewards: { xp: 0, nl: 0, knb: 0 } };
            }

            if (disciple.status !== 'Nhàn Rỗi') {
                return { success: false, msg: `${disciple.name} đang bận!`, rewards: { xp: 0, nl: 0, knb: 0 } };
            }

            const COOLDOWN_MS = 2 * 60 * 1000; // 2 minutes
            const now = Date.now();
            const lastTuLuyenTime = disciple.lastTuLuyen || 0;
            const timePassed = now - lastTuLuyenTime;

            if (timePassed < COOLDOWN_MS) {
                const remainingSeconds = Math.ceil((COOLDOWN_MS - timePassed) / 1000);
                return { success: false, msg: `${disciple.name} đang hồi chiêu (${remainingSeconds}s).`, rewards: { xp: 0, nl: 0, knb: 0 } };
            }
            
            // Set cooldown
            disciple.lastTuLuyen = now;

            // --- Tu Luyện Logic ---
            const baseXp = 8888;
            const xpGained = baseXp + Math.floor(Math.random() * (disciple.level * 6688 + 10));
            
            // Add XP (Pass false to suppress individual render in batch mode if needed, but current addDiscipleXp renders anyway)
            // To optimize batch, we could modify addDiscipleXp, but for now it's fine.
            addDiscipleXp(disciple.id, xpGained); 

            let mainMsg = `${disciple.name} tu luyện, nhận ${xpGained} XP`;

            let nganLuongGained = 0;
            let knbGained = 0;
            
            // Reward Logic
            if (Math.random() < 0.20) {
                const bonusPercent = getSectUpgradeBonus('tuLuyenReward');
                const baseNganLuong = Math.floor(Math.random() * (disciple.level * 100)) + (disciple.level * 50);
                nganLuongGained = Math.floor(baseNganLuong * (1 + bonusPercent / 100));
                
                gameData.nganLuong += nganLuongGained;
                mainMsg += `, <span class="text-gray-300">${nganLuongGained} NL</span>`;
            }
            
            if (Math.random() < 0.01) {
                knbGained = Math.floor(Math.random() * (disciple.level / 10)) + 1;
                gameData.kimNguyenBao += knbGained;
                mainMsg += `, <span class="text-yellow-300">${knbGained} KNB</span>`;
            }

            // Return success and details
            return {
                success: true,
                msg: mainMsg,
                rewards: {
                    xp: xpGained,
                    nl: nganLuongGained,
                    knb: knbGained
                }
            };
        }

        /**
         * [NEW] Tu Luyện (Cultivate) for all eligible disciples
         * [MODIFIED] Fixed loop logic and UI update
         */
        function startTuLuyenAll() {
            if (!gameData.disciples || gameData.disciples.length === 0) {
                showToast("Chưa có đệ tử nào.", false);
                return;
            }

            const COOLDOWN_MS = 2 * 60 * 1000;
            const now = Date.now();

            // Filter eligible disciples first
            const eligibleDisciples = gameData.disciples.filter(d => {
                if (d.status !== 'Nhàn Rỗi') return false;
                const lastTuLuyenTime = d.lastTuLuyen || 0;
                const timePassed = now - lastTuLuyenTime;
                return timePassed >= COOLDOWN_MS;
            });

            if (eligibleDisciples.length === 0) {
                showToast("Không có đệ tử nào rảnh rỗi hoặc đã hồi chiêu.", false);
                return;
            }

            let disciplesTrained = 0;
            let totalXPGained = 0;
            let totalNLGained = 0;
            let totalKNBGained = 0;

            // Perform bulk update
            eligibleDisciples.forEach(disciple => {
                const result = performTuLuyen(disciple);
                if (result && result.success) {
                    disciplesTrained++;
                    totalXPGained += result.rewards.xp;
                    totalNLGained += result.rewards.nl;
                    totalKNBGained += result.rewards.knb;
                }
            });

            if (disciplesTrained > 0) {
                let summaryMsg = `Đã tu luyện ${disciplesTrained} đệ tử. Tổng: ${totalXPGained.toLocaleString()} XP`;
                if (totalNLGained > 0) summaryMsg += `, ${totalNLGained.toLocaleString()} NL`;
                if (totalKNBGained > 0) summaryMsg += `, ${totalKNBGained} KNB`;
                summaryMsg += `.`;

                addSectLog(summaryMsg, 'reward');
                showToast(summaryMsg, true);

                updateUI(); // Update main UI (currency)
                renderDiscipleList(); // Update list (cooldowns & stats)
            }
        }

        // [NEW] Xuat Su Functions
        function confirmXuatSu(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) { showToast("Không tìm thấy đệ tử!", false); return; }
            
            // [MODIFIED] 1. Kiểm tra Khóa (Điều kiện duy nhất để chặn)
            if (disciple.isLocked) {
                showToast(`BẢO VỆ: Đệ tử ${disciple.name} đang bị KHÓA!`, false);
                return;
            }

            if (disciple.level < 80) { showToast("Đệ tử chưa đủ Cấp 80!", false); return; }
            
            // Calculate reward
            const danhVongGained = (disciple.level - 79) * 5;
            
            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Xác Nhận Xuất Sư';
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2">Bạn có chắc muốn cho <strong>${disciple.name} (Cấp ${disciple.level})</strong> xuất sư?</p>
                    <p class="text-gray-300 mb-1">Đệ tử này sẽ rời khỏi tông môn vĩnh viễn.</p>
                    <p class="font-bold text-yellow-300 text-lg mt-4">Phần thưởng: <span class="text-teal-400">${danhVongGained} Danh Vọng</span>.</p>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button onclick="performXuatSu('${discipleId}')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">Xác Nhận</button>
                `;
            }
            showModal('dungeon-confirm-modal');
        }

        function performXuatSu(discipleId) {
            const index = gameData.disciples.findIndex(d => d.id === discipleId);
            if (index === -1) { 
                showToast("Không tìm thấy đệ tử!", false); 
                hideModal('dungeon-confirm-modal');
                return; 
            }
            
            const disciple = gameData.disciples[index];
            // [MODIFIED] Kiểm tra khóa lần cuối
            if (disciple.isLocked) {
                showToast(`BẢO VỆ: Đệ tử đang bị KHÓA!`, false);
                hideModal('dungeon-confirm-modal');
                return;
            }

            if (disciple.level < 80) { 
                showToast("Đệ tử chưa đủ Cấp 80!", false); 
                hideModal('dungeon-confirm-modal');
                return; 
            }
            
            // Calculate reward again
            const danhVongGained = (disciple.level - 79) * 5;
            const discipleName = disciple.name;
            const discipleLevel = disciple.level;
            
            // 1. Remove disciple
            gameData.disciples.splice(index, 1);
            
            // 2. Add reward
            gameData.danhVong += danhVongGained;
            
            // 3. Log, Toast, Update
            addSectLog(`${discipleName} (Cấp ${discipleLevel}) đã xuất sư, Tông Môn nhận được ${danhVongGained} Danh Vọng.`, 'reward');
            showToast(`${discipleName} xuất sư! Nhận ${danhVongGained} Danh Vọng.`, true);
            
            hideModal('dungeon-confirm-modal');
            updateUI(); // Update main DV display
            renderDiscipleList(); // Update disciple list
            renderRecruitPanel(); // Update member count
        }

        // [MODIFIED] Hàm Trục Xuất Đơn Giản
        function expelDisciple(discipleId) {
            const index = gameData.disciples.findIndex(d => d.id === discipleId);
            if (index === -1) {
                showToast("Không tìm thấy đệ tử!", false); return;
            }
            
            const disciple = gameData.disciples[index];
            
            // [MODIFIED] 1. Kiểm tra Khóa (Điều kiện duy nhất để chặn)
            if (disciple.isLocked) {
                showToast(`BẢO VỆ: Đệ tử ${disciple.name} đang bị KHÓA!`, false);
                return;
            }
            
            // 2. Nếu không khóa -> Trục xuất ngay lập tức
            const discipleName = disciple.name;
            
            // Check if disciple is in Song Tu
            if (disciple.status === 'Đang Song Tu') {
                const pairIndex = gameData.sect.songTuPairs.findIndex(p => p.d1Id === discipleId || p.d2Id === discipleId);
                if (pairIndex > -1) {
                    const pair = gameData.sect.songTuPairs[pairIndex];
                    const otherDiscipleId = (pair.d1Id === discipleId) ? pair.d2Id : pair.d1Id;
                    const otherDisciple = gameData.disciples.find(d => d.id === otherDiscipleId);
                    
                    if (otherDisciple) {
                        otherDisciple.status = 'Nhàn Rỗi'; 
                        addSectLog(`${disciple.name} bị trục xuất, ${otherDisciple.name} đã dừng Song Tu.`, 'info');
                    }
                    
                    gameData.sect.songTuPairs.splice(pairIndex, 1); // Remove the pair
                }
            }

            // Nếu là Hộ Chủ (đang xuất chiến) thì gỡ bỏ
            if (gameData.sect.combatChampionId === discipleId) {
                gameData.sect.combatChampionId = null;
                updateUI(); // Cập nhật lại stats người chơi
            }

            // Xóa khỏi mảng
            gameData.disciples.splice(index, 1);
            addSectLog(`${discipleName} đã bị trục xuất khỏi Tông Môn.`, 'error');
            showToast(`${discipleName} đã bị trục xuất.`, true);
            
            renderDiscipleList(); // Cập nhật lại danh sách
            renderRecruitPanel(); // Cập nhật lại số lượng
        }

        // [NEW] Toggle disciple lock
        function toggleDiscipleLock(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) {
                showToast("Không tìm thấy đệ tử!", false);
                return;
            }
            
            disciple.isLocked = !disciple.isLocked;
            
            if (disciple.isLocked) {
                showToast(`${disciple.name} đã được khóa (an toàn).`, true);
                // If this disciple was selected as a material, remove them from selection
                const index = selectedTruyenCongMaterials.indexOf(discipleId);
                if (index > -1) {
                    selectedTruyenCongMaterials.splice(index, 1);
                    showToast(`Đã bỏ chọn ${disciple.name} khỏi danh sách hi sinh.`, true);
                }
            } else {
                showToast(`${disciple.name} đã được mở khóa.`, true);
            }
            
            // Re-render relevant UIs
            renderDiscipleList();
            if (!document.getElementById('panel-truyen-cong').classList.contains('hidden')) {
                renderTruyenCongPanel();
            }
        }

        // [NEW] Xuat Su Functions
        function confirmXuatSu(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) { showToast("Không tìm thấy đệ tử!", false); return; }
            if (disciple.level < 80) { showToast("Đệ tử chưa đủ Cấp 80!", false); return; }
            
            // Calculate reward
            const danhVongGained = (disciple.level - 79) * 5; // Example: Lvl 80 = 5 DV, Lvl 100 = 105 DV
            
            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Xác Nhận Xuất Sư';
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2">Bạn có chắc muốn cho <strong>${disciple.name} (Cấp ${disciple.level})</strong> xuất sư?</p>
                    <p class="text-gray-300 mb-1">Đệ tử này sẽ rời khỏi tông môn vĩnh viễn.</p>
                    <p class="font-bold text-yellow-300 text-lg mt-4">Phần thưởng: <span class="text-teal-400">${danhVongGained} Danh Vọng</span>.</p>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button onclick="performXuatSu('${discipleId}')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">Xác Nhận</button>
                `;
            }
            showModal('dungeon-confirm-modal');
        }

        function performXuatSu(discipleId) {
            const index = gameData.disciples.findIndex(d => d.id === discipleId);
            if (index === -1) { 
                showToast("Không tìm thấy đệ tử!", false); 
                hideModal('dungeon-confirm-modal');
                return; 
            }
            
            const disciple = gameData.disciples[index];
            if (disciple.level < 80) { 
                showToast("Đệ tử chưa đủ Cấp 80!", false); 
                hideModal('dungeon-confirm-modal');
                return; 
            }
            
            // Calculate reward again
            const danhVongGained = (disciple.level - 79) * 5;
            const discipleName = disciple.name;
            const discipleLevel = disciple.level;
            
            // 1. Remove disciple
            gameData.disciples.splice(index, 1);
            
            // 2. Add reward
            gameData.danhVong += danhVongGained;
            
            // 3. Log, Toast, Update
            addSectLog(`${discipleName} (Cấp ${discipleLevel}) đã xuất sư, Tông Môn nhận được ${danhVongGained} Danh Vọng.`, 'reward');
            showToast(`${discipleName} xuất sư! Nhận ${danhVongGained} Danh Vọng.`, true);
            
            hideModal('dungeon-confirm-modal');
            updateUI(); // Update main DV display
            renderDiscipleList(); // Update disciple list
            renderRecruitPanel(); // Update member count
        }
        // [END NEW] Xuat Su Functions

        // [NEW] --- Mon Phai (Player Sect) Functions ---
        function renderMonPhaiList() {
            const listContainer = document.getElementById('mon-phai-list');
            if (!listContainer) return;

            const currentSectId = gameData.player.monPhai || 'tieu_dao';
            // [NEW] Check free change status
            const isFreeChange = gameData.player.freeSectChange;
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-2">';
            for (const sectId in MON_PHAI_SKILLS_DB) {
                const sectData = MON_PHAI_SKILLS_DB[sectId];
                const isCurrent = (sectId === currentSectId);
                
                const sectIcon = sectData.icon || 'fa-solid fa-yin-yang';
                const sectClass = sectData.className || 'text-yellow-300';

                let buttonHtml = '';
                if (isCurrent) {
                    buttonHtml = `<button class="w-full text-sm bg-gray-700 text-gray-500 font-bold py-2 px-4 rounded border border-gray-600 cursor-not-allowed shadow-inner">Đang theo học</button>`;
                } else {
                    // [MODIFIED] Display "Miễn Phí" if eligible
                    const costText = isFreeChange ? 'Miễn Phí' : '100k KNB';
                    const costClass = isFreeChange ? 'text-yellow-300 animate-pulse' : 'text-green-200';
                    
                    buttonHtml = `<button onclick="joinMonPhai('${sectId}')" class="w-full text-sm bg-gradient-to-r from-green-600 to-green-700 hover:from-green-500 hover:to-green-600 text-white font-bold py-2 px-4 rounded shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <span>Gia Nhập</span>
                        <span class="text-xs font-normal bg-black/20 px-1.5 py-0.5 rounded ${costClass}">${costText}</span>
                    </button>`;
                }

                html += `
                <div class="bg-black/20 backdrop-blur-md border ${isCurrent ? 'border-green-500 ring-1 ring-green-500/50 shadow-[0_0_20px_rgba(34,197,94,0.2)]' : 'border-gray-700 hover:border-gray-500'} rounded-xl p-5 flex flex-col items-center text-center transition duration-300 group relative overflow-hidden">
                    
                    <div class="absolute top-0 right-0 -mr-8 -mt-8 w-24 h-24 bg-gradient-to-br from-white/5 to-transparent rounded-full blur-xl pointer-events-none"></div>
                    
                    <div class="w-16 h-16 rounded-full bg-gray-900 border-2 border-gray-600 flex items-center justify-center mb-3 shadow-inner group-hover:scale-110 transition duration-300 z-10 relative">
                        <div class="absolute inset-0 rounded-full bg-gradient-to-br from-transparent to-black/50"></div>
                        <i class="${sectIcon} text-3xl ${sectClass} relative z-10"></i>
                    </div>
                    
                    <h4 class="text-lg font-bold ${sectClass} mb-2 tracking-wide">${sectData.name}</h4>
                    ${isCurrent ? '<span class="absolute top-3 right-3 text-xs font-bold text-green-400 bg-green-900/30 px-2 py-1 rounded border border-green-500/30">Đang Chọn</span>' : ''}
                    
                    <!-- [FIXED] Description: Removed fixed height and line-clamp -->
                    <p class="text-xs text-gray-400 mb-4 flex-grow px-2 leading-relaxed">
                        ${sectData.desc}
                    </p>
                    
                    <div class="w-full h-px bg-gradient-to-r from-transparent via-gray-700 to-transparent mb-4"></div>
                    
                    <div class="w-full mt-auto z-10">
                        ${buttonHtml}
                    </div>
                </div>
                `;
            }
            html += '</div>';
            listContainer.innerHTML = html;
        }

        function joinMonPhai(sectId) {
            const currentSectId = gameData.player.monPhai;
            if (currentSectId === sectId) {
                showToast("Bạn đang ở môn phái này rồi!", false);
                return;
            }

            // [MODIFIED] Kiểm tra miễn phí trước
            const isFreeChange = gameData.player.freeSectChange;
            const cost = isFreeChange ? 0 : 100000; // 0 hoặc 100,000 KNB

            if (gameData.kimNguyenBao < cost) {
                showToast(`Cần ${cost.toLocaleString()} KNB để đổi môn phái!`, false);
                return;
            }
            
            // Trừ tiền
            gameData.kimNguyenBao -= cost;
            
            // Nếu dùng miễn phí, tắt cờ
            if (isFreeChange) {
                gameData.player.freeSectChange = false;
            }

            // [FIX #2] Thêm logic thay đổi môn phái
            gameData.player.monPhai = sectId;
            
            let costMsg = isFreeChange ? "Miễn phí" : `${cost.toLocaleString()} KNB`;
            showToast(`Gia nhập ${MON_PHAI_SKILLS_DB[sectId].name} thành công! (${costMsg})`, true);

            // Re-render main UI (to update stats)
            updateUI(); // [NEW]
            
            // [FIX #2] Cập nhật lại modal môn phái và kỹ năng (nếu đang mở)
            if (!document.getElementById('mon-phai-modal').classList.contains('hidden')) {
                renderMonPhaiList();
            }
            if (!document.getElementById('skills-modal').classList.contains('hidden')) {
                renderSkillTree();
            }
        }
        // [END NEW] --- Mon Phai (Player Sect) Functions ---

        // [FIX] Bọc lại khối comment bị lỗi gây ra SyntaxError
        /**
         * [MODIFIED] Sửa logic cho 'minPotential'
         */
        function getSectUpgradeBonus(effectType) {
            if (!gameData || !gameData.sect || !gameData.sect.upgrades) return 0;
            
            let totalBonus = 0;
            
            // [FIX] For 'minPotential', we need the MAX value, not the SUM.
            if (effectType === 'minPotential') {
                let maxPotential = 0;
                gameData.sect.upgrades.forEach(upgradeId => {
                    const upgrade = SECT_UPGRADES_DB[upgradeId];
                    if (upgrade && upgrade.effect.type === effectType) {
                        if (upgrade.effect.value > maxPotential) {
                            maxPotential = upgrade.effect.value;
                        }
                    }
                });
                return maxPotential; // Trả về giá trị MAX
            }
            // [END FIX]

            // Logic cũ (SUM) cho các nâng cấp khác
            gameData.sect.upgrades.forEach(upgradeId => {
                const upgrade = SECT_UPGRADES_DB[upgradeId];
                if (upgrade && upgrade.effect.type === effectType) {
                    totalBonus += upgrade.effect.value;
                }
            });
            return totalBonus;
        }

        /**
         * Tính toán tổng số đệ tử tối đa
         */
        function getMaxMembers() {
            if (!gameData || !gameData.sect) return 10;
            let base = gameData.sect.maxMembers || 10;
            
            // [MODIFIED] Use the new helper function
            const bonusMembers = getSectUpgradeBonus('maxMembers');
            
            // [NEW] Add bonus from Sect Level
            let levelBonus = (gameData.sect.level - 1); // +1 per level starting from 2
            if (gameData.sect.level >= 5) levelBonus += 1; // +1 more at level 5 (total +2 from level)
            
            return base + bonusMembers + levelBonus;
        }

        /**
         * Hiển thị tab Quản lý Tông môn
         */
        function renderManagementPanel() {
            const panel = document.getElementById('panel-quan-ly');
            if (!panel) return;
            
            const congHien = gameData.diemCongHien || 0;
            
            let html = `<h4 class="text-lg font-bold text-cyan-400 mb-4">Quản lý Tông môn</h4>`;
            
            // --- 1. Donation Box ---
            html += `
                <div class="bg-gray-700 p-4 rounded mb-6">
                    <h5 class="font-bold text-yellow-300 mb-2 text-center">Cống Hiến Tài Sản</h5>
                    <p class="text-sm text-gray-300 mb-3 text-center">Cống hiến Ngân Lượng để nhận Điểm Cống Hiến (ĐCH).</p>
                    <p class="text-sm text-gray-300 mb-3 text-center">Tỷ giá: <span class="font-bold">1,000,000</span> NL = <span class="font-bold text-lime-400">1</span> ĐCH</p>
                    <div class="flex items-center justify-center gap-2">
                        <input type="number" id="donate-nl-amount" placeholder="Số Ngân Lượng..." class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-full max-w-xs text-center" min="1000000" step="1000000">
                        <button onclick="donateToSect()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Cống Hiến</button>
                    </div>
                </div>
            `;
            
            // --- 2. Upgrades List ---
            html += `<h5 class="font-bold text-yellow-300 mb-2 text-center">Nâng Cấp Tông Môn</h5>`;
            html += `<p class="text-sm text-gray-300 mb-3 text-center">Dùng ĐCH để mua nâng cấp vĩnh viễn. (ĐCH hiện có: <span class="font-bold text-lime-400">${congHien}</span>)</p>`;
            html += `<div class="space-y-3">`;

            const upgrades = Object.values(SECT_UPGRADES_DB);
            upgrades.sort((a,b) => a.cost - b.cost); // Sắp xếp theo giá

            upgrades.forEach(upg => {
                let buttonHtml = '';
                const hasPurchased = gameData.sect.upgrades.includes(upg.id);
                const hasRequirement = upg.requires ? gameData.sect.upgrades.includes(upg.requires) : true;
                const canAfford = congHien >= upg.cost;

                if (hasPurchased) {
                    buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-70 cursor-not-allowed">Đã Mua</button>`;
                } else if (!hasRequirement) {
                    const reqName = SECT_UPGRADES_DB[upg.requires]?.name || 'Nâng Cấp Yêu Cầu';
                    buttonHtml = `<button class="text-xs bg-gray-600 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed" title="Cần: ${reqName}">Bị Khóa</button>`;
                } else if (!canAfford) {
                    buttonHtml = `<button class="text-xs bg-red-600 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed">Không đủ ĐCH</button>`;
                } else {
                    buttonHtml = `<button onclick="buySectUpgrade('${upg.id}')" class="text-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded">Mua (${upg.cost} ĐCH)</button>`;
                }

                html += `
                <div class="bg-gray-700 p-3 rounded shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-base ${hasPurchased ? 'text-green-400' : 'text-white'}">${upg.name}</p>
                            <p class="text-sm text-gray-300">${upg.desc}</p>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
                `;
            });
            
            html += `</div>`;
            panel.innerHTML = html;
        }
        
        /**
         * Cống hiến NL lấy ĐCH
         */
        function donateToSect() {
            const inputEl = document.getElementById('donate-nl-amount');
            if (!inputEl) return;
            
            const amountToDonate = parseInt(inputEl.value, 10);
            const DONATION_RATE = 1000000; // 1M NL = 1 ĐCH

            if (isNaN(amountToDonate) || amountToDonate < DONATION_RATE) {
                showToast(`Cần cống hiến ít nhất ${DONATION_RATE.toLocaleString()} NL.`, false);
                return;
            }
            if (gameData.nganLuong < amountToDonate) {
                showToast("Không đủ Ngân Lượng!", false);
                return;
            }
            
            // Làm tròn xuống
            const actualAmount = Math.floor(amountToDonate / DONATION_RATE) * DONATION_RATE;
            const congHienGained = actualAmount / DONATION_RATE;
            
            if (congHienGained <= 0) {
                 showToast("Số tiền không hợp lệ.", false);
                 return;
            }

            // Giao dịch
            gameData.nganLuong -= actualAmount;
            gameData.diemCongHien = (gameData.diemCongHien || 0) + congHienGained;
            
            showToast(`Cống hiến ${actualAmount.toLocaleString()} NL, nhận ${congHienGained} ĐCH!`, true);
            
            inputEl.value = ''; // Xóa input
            updateUI(); // Cập nhật NL trên UI chính
            renderManagementPanel(); // Cập nhật lại tab
        }

        /**
         * Mua một nâng cấp Tông Môn
         */
        function buySectUpgrade(upgradeId) {
            const upgrade = SECT_UPGRADES_DB[upgradeId];
            if (!upgrade) {
                showToast("Lỗi: Không tìm thấy nâng cấp!", false); return;
            }
            
            // 1. Kiểm tra
            if (gameData.sect.upgrades.includes(upgradeId)) {
                showToast("Đã mua nâng cấp này rồi!", false); return;
            }
            if (upgrade.requires && !gameData.sect.upgrades.includes(upgrade.requires)) {
                showToast("Cần mua nâng cấp yêu cầu trước!", false); return;
            }
            if (gameData.diemCongHien < upgrade.cost) {
                showToast("Không đủ Điểm Cống Hiến!", false); return;
            }
            
            // 2. Giao dịch
            gameData.diemCongHien -= upgrade.cost;
            gameData.sect.upgrades.push(upgradeId);
            
            // 3. Áp dụng hiệu ứng (hiện tại chỉ xử lý logic getMaxMembers() tự động)
            // Nếu là nâng cấp 'maxMembers', hàm getMaxMembers() sẽ tự động nhận diện.
            // Nếu là các nâng cấp khác (XP, CD), logic của chúng sẽ cần kiểm tra mảng 'upgrades' sau này.
            
            addSectLog(`Tông Môn đã nghiên cứu "${upgrade.name}"!`, 'reward');
            showToast(`Đã mua nâng cấp: ${upgrade.name}!`, true);
            
            // 4. Cập nhật UI
            updateUI(); // Cập nhật ĐCH
            renderManagementPanel(); // Cập nhật tab
            renderRecruitPanel(); // Cập nhật giới hạn đệ tử nếu đang mở
        }

        // [END NEW] Sect Management Functions

        // [NEW] Sect Trial Functions (Simple Click-based)
        
        /**
         * Hiển thị danh sách Thí Luyện Tông Môn
         */
        function renderSectTrialPanel() {
            const panel = document.getElementById('panel-thi-luyen-tm');
            if (!panel) return;
            
            const now = Date.now();
            let html = '<h4 class="text-lg font-bold text-cyan-400 mb-4">Tông Môn Thí Luyện</h4>';
            
            if (!gameData.disciples || gameData.disciples.length === 0) {
                html += `<p class="text-center text-gray-400">Bạn cần chiêu mộ đệ tử trước khi có thể bắt đầu thí luyện.</p>`;
                panel.innerHTML = html;
                return;
            }

            html += '<p class="text-sm text-gray-400 mb-4">Bắt đầu thí luyện để nhận XP cho TẤT CẢ đệ tử. Hoạt động có thời gian hồi.</p>';
            html += '<div class="space-y-3">';

            const trials = Object.values(SECT_TRIALS_DB);
            trials.sort((a,b) => a.levelReq - b.levelReq); // Sort by level

            // [NEW] Get bonuses once
            const xpBonusPercent = getSectUpgradeBonus('trialXp');
            const cdReductionPercent = getSectUpgradeBonus('trialCooldown');

            trials.forEach(trial => {
                const cooldownTime = gameData.sect.trialCooldowns ? (gameData.sect.trialCooldowns[trial.id] || 0) : 0;
                const remainingMs = Math.max(0, cooldownTime - now);
                
                // [MODIFIED] Apply cooldown reduction to display
                const finalCooldown = Math.floor(trial.cooldown * (1 - cdReductionPercent / 100));
                const durationMinutes = (finalCooldown / 60000).toFixed(0);
                
                let buttonHtml = '';
                if (remainingMs > 0) {
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed">Đang hồi (${remainingSeconds}s)</button>`;
                } else if (gameData.player.level < trial.levelReq) {
                     buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed" title="Cần Cấp ${trial.levelReq}">Cần Cấp ${trial.levelReq}</button>`;
                } else {
                    buttonHtml = `<button onclick="startSectTrial('${trial.id}')" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">Bắt đầu</button>`;
                }

                // [MODIFIED] Apply XP bonus to display
                const finalXp = Math.floor(trial.rewards.xp * (1 + xpBonusPercent / 100));
                let rewardText = `Thưởng: ${finalXp.toLocaleString()} XP (mỗi đệ tử)`;
                if (xpBonusPercent > 0) {
                    rewardText += ` <span class="text-green-400">(+${xpBonusPercent}%)</span>`;
                }
                
                let cdText = `Hồi chiêu: ${durationMinutes} phút`;
                if (cdReductionPercent > 0) {
                    cdText += ` <span class="text-green-400">(-${cdReductionPercent}%)</span>`;
                }

                html += `
                <div class="bg-gray-700 p-3 rounded shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-base text-yellow-300">${trial.name} (Cần Cấp ${trial.levelReq})</p>
                            <p class="text-sm text-gray-300">${trial.desc}</p>
                            <!-- [MODIFIED] Show new reward and cd text -->
                            <p class="text-xs text-cyan-300 mt-1">${cdText} | ${rewardText}</p>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
                `;
            });

            html += '</div>';
            panel.innerHTML = html;
        }

        /**
         * Bắt đầu một hoạt động Thí Luyện
         */
        function startSectTrial(trialId) {
            const trial = SECT_TRIALS_DB[trialId];
            if (!trial) {
                showToast("Lỗi: Không tìm thấy hoạt động thí luyện!", false); return;
            }

            // 1. Check player level
            if (gameData.player.level < trial.levelReq) {
                 showToast(`Cần đạt Cấp ${trial.levelReq} để bắt đầu thí luyện này!`, false); return;
            }

            // 2. Check cooldown
            const now = Date.now();
            const cooldownTime = gameData.sect.trialCooldowns ? (gameData.sect.trialCooldowns[trial.id] || 0) : 0;
            if (now < cooldownTime) {
                showToast("Hoạt động đang trong thời gian hồi!", false); return;
            }

            // 3. Check disciples
            if (!gameData.disciples || gameData.disciples.length === 0) {
                 showToast("Bạn không có đệ tử nào để tham gia thí luyện!", false);
                 return;
            }
            
            // 4. Grant rewards
            // [MODIFIED] Use the helper function to get total bonus
            const xpBonusPercent = getSectUpgradeBonus('trialXp');
            
            const xpAmount = Math.floor(trial.rewards.xp * (1 + xpBonusPercent / 100));
            let disciplesLeveledUp = 0;
            
            gameData.disciples.forEach(disciple => {
                const leveledUp = addDiscipleXp(disciple.id, xpAmount); // Hàm này sẽ tự log nếu đệ tử thăng cấp
                if (leveledUp) disciplesLeveledUp++;
            });

            // 5. Set cooldown
            // [NEW] Apply cooldown reduction
            const cdReductionPercent = getSectUpgradeBonus('trialCooldown');
            const finalCooldown = Math.floor(trial.cooldown * (1 - cdReductionPercent / 100));

            if (!gameData.sect.trialCooldowns) gameData.sect.trialCooldowns = {};
            gameData.sect.trialCooldowns[trial.id] = now + finalCooldown; // [MODIFIED] Use finalCooldown

            // 6. Log and re-render
            let toastMsg = `Hoàn thành "${trial.name}", tất cả đệ tử nhận ${xpAmount.toLocaleString()} XP`;
            if (xpBonusPercent > 0) toastMsg += ` (+${xpBonusPercent}%)`;
            toastMsg += `.`;
            
            if (disciplesLeveledUp > 0) {
                toastMsg += ` (${disciplesLeveledUp} đệ tử đã thăng cấp!)`;
            }
            
            addSectLog(toastMsg, 'reward');
            showToast(toastMsg, true);
            renderSectTrialPanel(); // Cập nhật lại tab để hiển thị cooldown
        }
        // [END NEW] Sect Trial Functions
        
        // [NEW] --- Lãnh Địa Functions ---
        /**
         * [NEW] Tính toán tài nguyên Lãnh Địa được tạo ra (offline/afk)
         */
        function updateLanhDiaGeneration(offlineTimeMs = null) {
            if (!gameData || !gameData.sect || !gameData.sect.capturedTerritories) return;
            
            const now = Date.now();
            
            for (const territoryId in gameData.sect.capturedTerritories) {
                const territoryData = gameData.sect.capturedTerritories[territoryId];
                const territoryDB = LANH_DIA_DB[territoryId];
                
                if (territoryData && territoryDB) {
                    const lastUpdate = territoryData.lastUpdateTime || now;
                    const timePassedMs = (offlineTimeMs !== null) ? offlineTimeMs : (now - lastUpdate);
                    
                    if (timePassedMs > 0) {
                        const hoursPassed = timePassedMs / 3600000;
                        const generated = hoursPassed * territoryDB.ratePerHour;
                        const newTotal = (territoryData.current || 0) + generated;
                        territoryData.current = Math.min(territoryDB.capacity, newTotal);
                    }
                    if (offlineTimeMs === null) {
                         territoryData.lastUpdateTime = now; 
                    }
                }
            }
        }

        /**
         * [NEW] Helper: Lấy style hiển thị cho lãnh địa dựa trên Lực Chiến Yêu Cầu
         */
        function getTerritoryStyle(powerReq) {
            // [NEW] Cấp 5.000 Tỷ - Đỉnh Cao (Rainbow Ultimate)
            if (powerReq >= 5000000000000) {
                return {
                    border: 'border-yellow-200',
                    bg: 'bg-black',
                    text: 'text-rainbow-animation font-black text-3xl tracking-widest uppercase',
                    shadow: 'shadow-[0_0_80px_rgba(255,255,255,1)]',
                    // [MODIFIED] Xóa class 'animate-spin' để icon đứng yên
                    iconColor: 'text-rainbow-animation', 
                    barColor: 'bg-gradient-to-r from-yellow-300 via-white to-yellow-300',
                    tierName: 'Đa Vũ Trụ'
                };
            }
            // [NEW] Cấp 2.500 Tỷ - Hủy Diệt (Deep Red/Black)
            else if (powerReq >= 2500000000000) {
                return {
                    border: 'border-red-800',
                    bg: 'bg-gradient-to-br from-black to-red-950',
                    text: 'text-red-600 font-black text-2xl text-shadow-red animate-pulse',
                    shadow: 'shadow-[0_0_60px_rgba(153,27,27,0.8)]',
                    iconColor: 'text-red-600',
                    barColor: 'bg-gradient-to-r from-red-900 to-red-600',
                    tierName: 'Hủy Diệt'
                };
            }
            // [NEW] Cấp 1.250 Tỷ - Tinh Không (Deep Blue/Stars)
            else if (powerReq >= 1250000000000) {
                return {
                    border: 'border-blue-400',
                    bg: 'bg-gradient-to-br from-blue-950 to-black',
                    text: 'text-blue-300 font-bold text-xl text-shadow-blue',
                    shadow: 'shadow-[0_0_50px_rgba(96,165,250,0.6)]',
                    iconColor: 'text-blue-400 animate-pulse',
                    barColor: 'bg-gradient-to-r from-blue-600 to-cyan-400',
                    tierName: 'Tinh Không'
                };
            }
            // [NEW] Cấp 900 Tỷ - Chân Lý (White/Void)
            else if (powerReq >= 900000000000) {
                return {
                    border: 'border-white',
                    bg: 'bg-black',
                    text: 'text-rainbow-animation font-black tracking-widest text-shadow-white',
                    shadow: 'shadow-[0_0_30px_rgba(255,255,255,0.8)]',
                    iconColor: 'text-white animate-pulse',
                    barColor: 'bg-gradient-to-r from-white via-gray-200 to-white',
                    tierName: 'Vĩnh Hằng Chi Địa'
                };
            } 
            // [NEW] Cấp 35 Tỷ - Thần Vực (Fuchsia/Pink)
            else if (powerReq >= 35000000000) {
                return {
                    border: 'border-fuchsia-500',
                    bg: 'bg-gradient-to-br from-fuchsia-900/60 to-black/90',
                    text: 'text-fuchsia-300 font-bold text-shadow-purple',
                    shadow: 'shadow-[0_0_25px_rgba(232,121,249,0.5)]',
                    iconColor: 'text-fuchsia-400',
                    barColor: 'bg-gradient-to-r from-fuchsia-600 to-pink-500',
                    tierName: 'Thần Vực'
                };
            }
            // [NEW] Cấp 20 Tỷ - Hỗn Độn (Violet/Deep Purple)
            else if (powerReq >= 20000000000) {
                return {
                    border: 'border-violet-500',
                    bg: 'bg-gradient-to-br from-violet-900/60 to-black/90',
                    text: 'text-violet-300 font-bold',
                    shadow: 'shadow-[0_0_20px_rgba(139,92,246,0.5)]',
                    iconColor: 'text-violet-400',
                    barColor: 'bg-gradient-to-r from-violet-600 to-indigo-500',
                    tierName: 'Hỗn Độn Giới'
                };
            }
            // [NEW] Cấp 10 Tỷ - Thiên Đạo (Cyan/Ice)
            else if (powerReq >= 10000000000) {
                return {
                    border: 'border-cyan-400',
                    bg: 'bg-gradient-to-br from-cyan-900/60 to-black/90',
                    text: 'text-cyan-300 font-bold text-shadow-cyan',
                    shadow: 'shadow-[0_0_20px_rgba(34,211,238,0.5)]',
                    iconColor: 'text-cyan-400',
                    barColor: 'bg-gradient-to-r from-cyan-500 to-blue-500',
                    tierName: 'Thiên Đạo Cung'
                };
            }
            // [NEW] Cấp 3 Tỷ - Hồng Hoang (Gold/Amber)
            else if (powerReq >= 3000000000) {
                return {
                    border: 'border-amber-500',
                    bg: 'bg-gradient-to-br from-amber-900/60 to-black/90',
                    text: 'text-amber-300 font-bold text-shadow-gold',
                    shadow: 'shadow-[0_0_15px_rgba(245,158,11,0.5)]',
                    iconColor: 'text-amber-400',
                    barColor: 'bg-gradient-to-r from-amber-500 to-yellow-500',
                    tierName: 'Hồng Hoang'
                };
            }
            // Cấp 1 Tỷ - Cấm Địa (Red)
            else if (powerReq >= 1000000000) { 
                return {
                    border: 'border-red-600',
                    bg: 'bg-gradient-to-br from-red-900/60 to-black/90',
                    text: 'text-red-500 animate-pulse font-black',
                    shadow: 'shadow-[0_0_20px_rgba(220,38,38,0.5)]',
                    iconColor: 'text-red-500',
                    barColor: 'bg-gradient-to-r from-red-700 to-orange-600',
                    tierName: 'Cấm Địa'
                };
            } 
            // Cấp 100M - Truyền Thuyết (Orange)
            else if (powerReq >= 100000000) { 
                return {
                    border: 'border-orange-500',
                    bg: 'bg-gradient-to-br from-orange-900/40 to-black/80',
                    text: 'text-orange-400 font-bold',
                    shadow: 'shadow-[0_0_15px_rgba(249,115,22,0.3)]',
                    iconColor: 'text-orange-400',
                    barColor: 'bg-orange-500',
                    tierName: 'Hiểm Địa'
                };
            } 
            // Cấp 10M - Sử Thi (Purple)
            else if (powerReq >= 10000000) { 
                return {
                    border: 'border-purple-500',
                    bg: 'bg-gray-900/80',
                    text: 'text-purple-400 font-bold',
                    shadow: 'shadow-md',
                    iconColor: 'text-purple-400',
                    barColor: 'bg-purple-500',
                    tierName: 'Trọng Địa'
                };
            } 
            // Cấp 1M - Hiếm (Blue)
            else if (powerReq >= 1000000) { 
                return {
                    border: 'border-blue-500',
                    bg: 'bg-gray-800/80',
                    text: 'text-blue-400 font-bold',
                    shadow: 'shadow-sm',
                    iconColor: 'text-blue-400',
                    barColor: 'bg-blue-500',
                    tierName: 'Vùng Đất'
                };
            } 
            // Thường (Gray)
            else { 
                return {
                    border: 'border-gray-600',
                    bg: 'bg-gray-800/60',
                    text: 'text-gray-400 font-bold',
                    shadow: '',
                    iconColor: 'text-gray-400',
                    barColor: 'bg-gray-500',
                    tierName: 'Khu Vực'
                };
            }
        }

        /**
         * [MODIFIED] Hiển thị tab Lãnh Địa Tông Môn (UI Upgrade)
         */
        function renderLanhDiaPanel() {
            const panel = document.getElementById('panel-lanh-dia');
            if (!panel) return;

            updateLanhDiaGeneration();

            const now = Date.now();
            const totalPower = calculateTotalSectAndPlayerPower();
            
            // Header
            // [FIX UI] Bỏ class 'sticky', chuyển thành khối tĩnh (static block) đẹp mắt
            let html = `
                <h4 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-orange-500 mb-4 text-center uppercase tracking-widest filter drop-shadow-lg">Lãnh Địa Chiến</h4>
                
                <!-- Power Display Static (Không còn che khuất nội dung khi cuộn) -->
                <div class="bg-black/40 border border-yellow-600/30 rounded-lg py-3 px-6 mb-8 text-center max-w-md mx-auto shadow-lg relative overflow-hidden group hover:border-yellow-500/50 transition">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-yellow-500/5 to-transparent pointer-events-none"></div>
                    <p class="text-gray-400 text-xs uppercase tracking-widest mb-1">Tổng Lực Chiến Tông Môn</p>
                    <p class="text-3xl font-black text-yellow-400 text-shadow-gold group-hover:scale-110 transition duration-300">${totalPower.toLocaleString()}</p>
                </div>
            `;
            
            html += `<div class="animate-fade-in min-h-[400px] space-y-8">`;

            // 1. SECTION: MISSION IN PROGRESS (Hero Card)
            const mission = gameData.sect.territoryCaptureMission;
            if (mission) {
                const territoryDB = LANH_DIA_DB[mission.territoryId];
                const remainingMs = Math.max(0, mission.completionTime - now);
                const style = getTerritoryStyle(territoryDB.powerReq);
                
                html += `
                <div class="relative">
                    <h5 class="text-lg font-bold text-yellow-300 mb-3 flex items-center gap-2 border-l-4 border-yellow-500 pl-3">
                        <i class="fa-solid fa-flag animate-pulse"></i> Chiến Dịch Đang Tiến Hành
                    </h5>
                    
                    <div class="bg-gradient-to-r from-gray-900 to-gray-800 border-2 ${style.border} rounded-xl p-6 relative overflow-hidden shadow-2xl group">
                        <!-- Background Effect -->
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none"></div>
                        <div class="absolute -right-10 -top-10 text-9xl opacity-10 ${style.text} rotate-12 transition group-hover:scale-110 duration-700">
                            <i class="${territoryDB.icon}"></i>
                        </div>

                        <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                            <div class="flex items-center gap-4">
                                <div class="w-20 h-20 rounded-lg bg-black/50 flex items-center justify-center border ${style.border} shadow-inner">
                                    <i class="${territoryDB.icon} text-4xl ${style.iconColor} animate-bounce"></i>
                                </div>
                                <div>
                                    <h4 class="text-2xl font-bold text-white mb-1">${territoryDB.name}</h4>
                                    <p class="text-sm text-gray-400">${territoryDB.desc}</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="text-xs font-bold px-2 py-0.5 rounded bg-black/40 border border-gray-600 text-gray-300">
                                            LC Yêu Cầu: ${territoryDB.powerReq.toLocaleString()}
                                        </span>
                                        <span class="text-xs font-bold px-2 py-0.5 rounded bg-black/40 border border-gray-600 text-gray-300">
                                            ${style.tierName}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col items-center md:items-end w-full md:w-auto">
                                ${remainingMs > 0 ? `
                                    <div class="text-center md:text-right mb-2">
                                        <p class="text-xs text-gray-400 uppercase mb-1">Thời gian còn lại</p>
                                        <p class="text-3xl font-mono font-bold text-yellow-300">${formatTime(remainingMs)}</p>
                                    </div>
                                    <div class="w-full md:w-48 bg-gray-800 h-2 rounded-full overflow-hidden border border-gray-600">
                                         <div class="bg-yellow-500 h-full animate-pulse" style="width: 100%"></div>
                                    </div>
                                ` : `
                                    <p class="text-green-400 font-bold text-lg mb-2"><i class="fa-solid fa-check-circle mr-2"></i>Đã Chiếm Thành Công!</p>
                                    <button onclick="completeTerritoryCapture()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition transform hover:scale-105 animate-bounce">
                                        Hoàn Thành & Nhận Lãnh Địa
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }

            // 2. SECTION: CAPTURED TERRITORIES (Grid Layout)
            const capturedIds = Object.keys(gameData.sect.capturedTerritories);
            if (capturedIds.length > 0) {
                let totalHarvestable = 0;
                let capturedCardsHtml = '';
                
                capturedIds.forEach(id => {
                    const territoryData = gameData.sect.capturedTerritories[id];
                    const territoryDB = LANH_DIA_DB[id];
                    const style = getTerritoryStyle(territoryDB.powerReq);
                    
                    const currentAmount = Math.floor(territoryData.current);
                    totalHarvestable += currentAmount;
                    const percentFull = (territoryDB.capacity > 0) ? Math.min(100, (currentAmount / territoryDB.capacity) * 100) : 0;
                    
                    let resourceName = '';
                    let rewardIcon = '';
                    if (territoryDB.rewardType === 'material') {
                        const mat = MATERIALS_DB[territoryDB.reward];
                        resourceName = mat ? mat.name : 'Nguyên Liệu';
                        rewardIcon = mat ? `<i class="${mat.icon}"></i>` : '';
                    } else if (territoryDB.reward === 'linhKhi') { resourceName = 'Linh Khí'; rewardIcon = '<i class="fa-solid fa-wind"></i>'; }
                    else if (territoryDB.reward === 'linhThach') { resourceName = 'Linh Thạch'; rewardIcon = '<i class="fa-solid fa-cubes"></i>'; }
                    else if (territoryDB.reward === 'diemCongHien') { resourceName = 'Cống Hiến'; rewardIcon = '<i class="fa-solid fa-hand-holding-heart"></i>'; }

                    const isFull = percentFull >= 100;

                    capturedCardsHtml += `
                    <div class="bg-gray-800 border ${style.border} rounded-lg p-3 relative overflow-hidden group hover:-translate-y-1 transition duration-300 shadow-lg">
                        ${isFull ? '<div class="absolute inset-0 bg-yellow-500/10 animate-pulse pointer-events-none"></div>' : ''}
                        
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <i class="${territoryDB.icon} text-xl ${style.iconColor}"></i>
                                <div>
                                    <p class="font-bold text-sm text-gray-200 leading-tight">${territoryDB.name}</p>
                                    <p class="text-[10px] text-gray-500">${style.tierName}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-gray-400">Sản lượng</p>
                                <p class="text-xs font-bold ${style.iconColor}">${territoryDB.ratePerHour}/h</p>
                            </div>
                        </div>
                        
                        <div class="bg-black/30 rounded p-2 border border-gray-700">
                            <div class="flex justify-between text-[10px] text-gray-300 mb-1">
                                <span>${rewardIcon} ${resourceName}</span>
                                <span class="${isFull ? 'text-red-400 font-bold' : 'text-white'}">${currentAmount.toLocaleString()} / ${territoryDB.capacity.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-900 h-1.5 rounded-full overflow-hidden border border-gray-700">
                                <div class="${isFull ? 'bg-red-500' : style.barColor} h-full transition-all duration-500" style="width: ${percentFull}%;"></div>
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += `
                <div>
                    <div class="flex justify-between items-end mb-3 border-l-4 border-green-500 pl-3">
                        <h5 class="text-lg font-bold text-green-400"><i class="fa-solid fa-city mr-2"></i>Lãnh Địa Đã Chiếm</h5>
                        <button onclick="collectAllTerritories()" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-1 px-4 rounded shadow-md text-xs transition transform active:scale-95 ${totalHarvestable < 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${totalHarvestable < 1 ? 'disabled' : ''}>
                            <i class="fa-solid fa-hand-holding-dollar mr-1"></i>Thu Hoạch Tất Cả
                        </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        ${capturedCardsHtml}
                    </div>
                </div>
                `;
            } else {
                 html += `
                <div class="text-center py-8 bg-gray-800/30 rounded-xl border border-dashed border-gray-700">
                    <i class="fa-solid fa-map-location-dot text-4xl text-gray-600 mb-3"></i>
                    <p class="text-gray-500">Chưa chiếm được lãnh địa nào.</p>
                </div>
                `;
            }

            // 3. SECTION: AVAILABLE TERRITORIES (Grid Layout)
            const availableTerritories = Object.values(LANH_DIA_DB).filter(t => 
                !gameData.sect.capturedTerritories[t.id] && 
                (!mission || mission.territoryId !== t.id)
            );
            availableTerritories.sort((a,b) => a.powerReq - b.powerReq);

            if (availableTerritories.length > 0) {
                html += `
                <div>
                    <h5 class="text-lg font-bold text-gray-300 mb-3 flex items-center gap-2 border-l-4 border-gray-500 pl-3">
                        <i class="fa-solid fa-globe"></i> Bản Đồ Thế Giới
                    </h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                availableTerritories.forEach(t => {
                    const style = getTerritoryStyle(t.powerReq);
                    const hasEnoughPower = totalPower >= t.powerReq;
                    const canStartMission = !mission && hasEnoughPower;
                    
                    // Determine reward text
                    let rewardName = '';
                    if (t.rewardType === 'material') {
                         const mat = MATERIALS_DB[t.reward];
                         rewardName = mat ? mat.name : 'Nguyên Liệu';
                    } else if (t.reward === 'linhKhi') rewardName = 'Linh Khí';
                    else if (t.reward === 'linhThach') rewardName = 'Linh Thạch';
                    else if (t.reward === 'diemCongHien') rewardName = 'Cống Hiến';

                    let btnHtml = '';
                    if (mission) {
                         btnHtml = `<button class="w-full bg-gray-700 text-gray-500 py-1.5 rounded text-xs cursor-not-allowed font-bold border border-gray-600" disabled>Đang Bận</button>`;
                    } else if (!hasEnoughPower) {
                         btnHtml = `<button class="w-full bg-gray-800 text-red-400 py-1.5 rounded text-xs cursor-not-allowed font-bold border border-red-900/50" disabled><i class="fa-solid fa-lock mr-1"></i>Yêu cầu LC</button>`;
                    } else {
                         btnHtml = `<button onclick="startTerritoryCapture('${t.id}')" class="w-full bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 text-white py-1.5 rounded text-xs font-bold shadow-md transition transform active:scale-95 border border-red-500/50">
                                        <i class="fa-solid fa-crosshairs mr-1"></i>Tấn Công
                                    </button>`;
                    }

                    html += `
                    <div class="bg-black/40 backdrop-blur-sm border ${style.border} p-4 rounded-lg relative overflow-hidden group hover:bg-gray-800 transition duration-300">
                        <!-- Tier Badge -->
                        <div class="absolute top-0 right-0 bg-gray-900/90 px-2 py-0.5 rounded-bl text-[9px] text-gray-400 border-b border-l border-gray-700">
                            ${style.tierName}
                        </div>
                        
                        <div class="flex items-start gap-3 mb-3">
                            <div class="w-12 h-12 rounded bg-gray-900 flex items-center justify-center border border-gray-600 shadow-inner flex-shrink-0">
                                <i class="${t.icon} text-2xl ${style.iconColor}"></i>
                            </div>
                            <div>
                                <h5 class="font-bold text-sm ${style.text}">${t.name}</h5>
                                <p class="text-[10px] text-gray-400 h-8 overflow-hidden leading-tight mt-1">${t.desc}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mb-3 text-[10px]">
                            <div class="bg-black/30 p-1.5 rounded border border-gray-700">
                                <p class="text-gray-500">Yêu Cầu LC</p>
                                <p class="font-bold ${hasEnoughPower ? 'text-green-400' : 'text-red-500'} font-mono">${t.powerReq.toLocaleString()}</p>
                            </div>
                            <div class="bg-black/30 p-1.5 rounded border border-gray-700">
                                <p class="text-gray-500">Sản Phẩm</p>
                                <p class="font-bold text-cyan-300 truncate">${rewardName}</p>
                            </div>
                            <div class="bg-black/30 p-1.5 rounded border border-gray-700">
                                <p class="text-gray-500">Thời Gian</p>
                                <p class="font-bold text-white">${formatTime(t.captureTimeMs)}</p>
                            </div>
                             <div class="bg-black/30 p-1.5 rounded border border-gray-700">
                                <p class="text-gray-500">Sản Lượng</p>
                                <p class="font-bold text-white">${t.ratePerHour}/h</p>
                            </div>
                        </div>
                        
                        ${btnHtml}
                    </div>
                    `;
                });
                html += `</div></div>`;
            } else if (!mission && capturedIds.length > 0) {
                 html += `<div class="text-center py-8"><p class="text-yellow-400 font-bold text-xl">Tông Môn Đã Thống Nhất Giang Hồ!</p><p class="text-gray-400 text-sm">Đã chiếm hết mọi lãnh địa.</p></div>`;
            }

            html += `</div>`; // End container
            panel.innerHTML = html;
        }

        /**
         * [NEW] Bắt đầu nhiệm vụ chiếm Lãnh Địa
         */
        function startTerritoryCapture(territoryId) {
            if (gameData.sect.territoryCaptureMission) {
                showToast("Đang có một nhiệm vụ chiếm cứ khác!", false);
                return;
            }
            
            const territoryDB = LANH_DIA_DB[territoryId];
            if (!territoryDB) {
                showToast("Lỗi: Không tìm thấy lãnh địa!", false);
                return;
            }
            
            const totalPower = calculateTotalSectAndPlayerPower();
            if (totalPower < territoryDB.powerReq) {
                 showToast("Lực chiến Tông Môn không đủ!", false);
                 return;
            }
            
            // Bắt đầu nhiệm vụ
            gameData.sect.territoryCaptureMission = {
                territoryId: territoryId,
                completionTime: Date.now() + territoryDB.captureTimeMs
            };
            
            addSectLog(`Tông Môn bắt đầu chiếm cứ [${territoryDB.name}]!`, 'system');
            showToast(`Bắt đầu chiếm cứ [${territoryDB.name}]...`, true);
            
            renderLanhDiaPanel(); // Cập nhật UI
        }

        /**
         * [NEW] Hoàn thành nhiệm vụ chiếm Lãnh Địa
         */
        function completeTerritoryCapture() {
            const mission = gameData.sect.territoryCaptureMission;
            if (!mission) {
                showToast("Không có nhiệm vụ nào đang tiến hành!", false);
                return;
            }
            
            if (Date.now() < mission.completionTime) {
                showToast("Nhiệm vụ chưa hoàn thành!", false);
                return;
            }
            
            const territoryDB = LANH_DIA_DB[mission.territoryId];
            
            // 1. Ghi nhận lãnh địa
            gameData.sect.capturedTerritories[mission.territoryId] = {
                current: 0,
                lastUpdateTime: Date.now()
            };
            
            // 2. Xóa nhiệm vụ
            gameData.sect.territoryCaptureMission = null;
            
            addSectLog(`Tông Môn đã chiếm cứ thành công [${territoryDB.name}]!`, 'reward');
            showToast(`Đã chiếm cứ [${territoryDB.name}]! Bắt đầu sản sinh tài nguyên.`, true);
            
            renderLanhDiaPanel(); // Cập nhật UI
        }

        /**
         * [NEW] Thu hoạch tất cả tài nguyên từ Lãnh Địa
         */
        function collectAllTerritories() {
            updateLanhDiaGeneration(); // Cập nhật lần cuối
            
            let totalGained = { linhKhi: 0, linhThach: 0, diemCongHien: 0, materials: {} };
            let territoriesHarvested = 0;
            
            for (const territoryId in gameData.sect.capturedTerritories) {
                const territoryData = gameData.sect.capturedTerritories[territoryId];
                const territoryDB = LANH_DIA_DB[territoryId];
                const amountToCollect = Math.floor(territoryData.current);
                
                if (amountToCollect > 0) {
                    territoriesHarvested++;
                    
                    if (territoryDB.rewardType === 'material') {
                        const matId = territoryDB.reward;
                        totalGained.materials[matId] = (totalGained.materials[matId] || 0) + amountToCollect;
                        addMaterial(matId, amountToCollect, 'lanh_dia');
                    } else if (territoryDB.reward === 'linhKhi') {
                        totalGained.linhKhi += amountToCollect;
                        gameData.linhKhi += amountToCollect;
                    } else if (territoryDB.reward === 'linhThach') {
                        totalGained.linhThach += amountToCollect;
                        gameData.linhThach += amountToCollect;
                    } else if (territoryDB.reward === 'diemCongHien') {
                        totalGained.diemCongHien += amountToCollect;
                        gameData.diemCongHien += amountToCollect;
                    }
                    
                    territoryData.current = 0; // Reset
                }
            }
            
            if (territoriesHarvested === 0) {
                showToast("Chưa có tài nguyên để thu hoạch.", false);
                return;
            }

            // Tạo thông báo
            let msg = "Thu hoạch Lãnh Địa: ";
            if (totalGained.linhKhi > 0) msg += `${totalGained.linhKhi.toLocaleString()} Linh Khí, `;
            if (totalGained.linhThach > 0) msg += `${totalGained.linhThach.toLocaleString()} Linh Thạch, `;
            if (totalGained.diemCongHien > 0) msg += `${totalGained.diemCongHien.toLocaleString()} ĐCH, `;
            for(const matId in totalGained.materials) {
                msg += `${totalGained.materials[matId].toLocaleString()} x ${MATERIALS_DB[matId].name}, `;
            }
            msg = msg.slice(0, -2) + '.'; // Xóa dấu phẩy cuối
            
            showToast(msg, true);
            addSectLog(msg, 'reward');
            
            updateUI(); // Cập nhật tiền tệ
            renderLanhDiaPanel(); // Cập nhật lại panel
        }
        // [END NEW] --- Lãnh Địa Functions ---

        // [NEW] --- Sect Challenge Functions ---
        /**
         * [MODIFIED] Hiển thị tab Khiêu Chiến Tông Môn
         */
        function renderSectChallengePanel() {
            const panel = document.getElementById('panel-khieu-chien-tm');
            if (!panel) return;

            const now = Date.now();
            // [MODIFIED] Tiêu đề vẫn giữ canh giữa (text-center)
            let html = '<h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Khiêu chiến Tông môn</h4>';
            
            if (!gameData.disciples || gameData.disciples.length === 0) {
                html += `<p class="text-center text-gray-400">Bạn cần chiêu mộ đệ tử trước khi có thể khiêu chiến.</p>`;
                panel.innerHTML = html;
                return;
            }

            // Calculate Total Sect Power
            // [MODIFIED] Sử dụng hàm tính tổng lực chiến (Tông Chủ + Đệ Tử) cho đồng bộ
            const totalPower = calculateTotalSectAndPlayerPower();
            
            // [MODIFIED] Đoạn mô tả này cũng canh giữa cho đẹp
            html += `<p class="text-sm text-gray-400 mb-4 text-center">Khiêu chiến các môn phái khác để giành Danh Vọng và Cống Hiến. <br> Tổng lực chiến đội của bạn (Tông Chủ + 5 Đệ Tử): <strong class="text-yellow-300">${totalPower.toLocaleString()}</strong></p>`;
            html += '<div class="space-y-3">';

            const rivals = Object.values(RIVAL_SECTS_DB);
            rivals.sort((a,b) => a.powerLevel - b.powerLevel); // Sort by power

            rivals.forEach(rival => {
                const cooldownTime = gameData.sect.challengeCooldowns ? (gameData.sect.challengeCooldowns[rival.id] || 0) : 0;
                const remainingMs = Math.max(0, cooldownTime - now);
                
                const powerReq = Math.floor(rival.powerLevel * 0.75);
                const hasEnoughPower = totalPower >= powerReq;
                
                let buttonHtml = '';
                if (remainingMs > 0) {
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed">Đang hồi (${remainingSeconds}s)</button>`;
                } else if (!hasEnoughPower) {
                     buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed" title="Cần ${powerReq.toLocaleString()} Lực Chiến">Cần ${powerReq.toLocaleString()} LC</button>`;
                } else {
                    buttonHtml = `<button onclick="startSectChallenge('${rival.id}')" class="text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">Khiêu Chiến</button>`;
                }

                // Determine power color
                let powerColor = 'text-green-400'; // Easy
                if (totalPower < rival.powerLevel * 0.75) {
                    powerColor = 'text-red-500'; // Very Hard
                } else if (totalPower < rival.powerLevel) {
                    powerColor = 'text-orange-400'; // Hard
                } else if (totalPower < rival.powerLevel * 1.5) {
                    powerColor = 'text-yellow-300'; // Normal
                }

                html += `
                <div class="bg-gray-700 p-3 rounded shadow">
                    <div class="flex justify-between items-center">
                        <!-- [MODIFIED] Đã XÓA class 'text-center' ở div này để nội dung quay về canh trái -->
                        <div class="flex-grow text-left"> 
                            <p class="font-bold text-base ${getRarityClass(rival.rarity)}"><i class="${rival.icon}"></i> ${rival.name}</p>
                            <p class="text-sm text-gray-300">${rival.desc}</p>
                            <p class="text-xs text-gray-400 mt-1">Lực chiến địch: <span class="font-bold ${powerColor}">${rival.powerLevel.toLocaleString()}</span> (Cần: <span class="font-bold text-yellow-300">${powerReq.toLocaleString()}</span> LC)</p>
                            <p class="text-xs text-cyan-300 mt-1">Thưởng: ${rival.rewards.diemCongHien.toLocaleString()} ĐCH, ${rival.rewards.nganLuong.toLocaleString()} NL, ${rival.rewards.danhVong.toLocaleString()} Danh Vọng</p>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
                `;
            });

            html += '</div>';
            panel.innerHTML = html;
        }

        /**
         * [REMOVED] Hàm tính lực chiến cũ (chỉ đệ tử) đã bị xóa để tránh nhầm lẫn
         */
        /*
        function calculateTotalSectPower() {
            // ... old code ...
        }
        */

        /**
         * [NEW] Bắt đầu một cuộc Khiêu Chiến
         */
        function startSectChallenge(rivalSectId) {
            const rival = RIVAL_SECTS_DB[rivalSectId];
            if (!rival) {
                showToast("Lỗi: Không tìm thấy môn phái!", false); return;
            }

            // [MODIFIED] Sử dụng hàm tính tổng lực chiến mới (Tông Chủ + Đệ Tử)
            const playerPower = calculateTotalSectAndPlayerPower();
            const rivalPower = rival.powerLevel;
            const powerReq = Math.floor(rivalPower * 0.75);
            
            if (playerPower < powerReq) {
                 showToast(`Cần ${powerReq.toLocaleString()} Lực Chiến để khiêu chiến! Lực chiến của bạn là ${playerPower.toLocaleString()}.`, false); 
                 return;
            }

            // 2. Check cooldown
            const now = Date.now();
            const cooldownTime = gameData.sect.challengeCooldowns ? (gameData.sect.challengeCooldowns[rival.id] || 0) : 0;
            if (now < cooldownTime) {
                showToast("Đang trong thời gian hồi!", false); return;
            }

            // 4. Determine outcome
            // Win chance is based on power ratio, with randomness
            // (playerPower / rivalPower) * 50% = base win chance. Max 95%, Min 5%
            let winChance = Math.min(95, Math.max(5, (playerPower / rivalPower) * 50));
            const roll = Math.random() * 100;

            let logMsg = `[Khiêu chiến] ${gameData.sect.name} (Lực chiến ${playerPower.toLocaleString()}) thách đấu ${rival.name} (Lực chiến ${rivalPower.toLocaleString()})... (Tỷ lệ thắng: ${winChance.toFixed(0)}%)`;
            addSectLog(logMsg, 'info');

            // 5. Set Cooldown (regardless of win/loss)
            if (!gameData.sect.challengeCooldowns) gameData.sect.challengeCooldowns = {};
            gameData.sect.challengeCooldowns[rival.id] = now + rival.cooldown;

            // 6. Resolve
            if (roll <= winChance) {
                // VICTORY
                const rewards = rival.rewards;
                gameData.diemCongHien = (gameData.diemCongHien || 0) + rewards.diemCongHien;
                gameData.nganLuong += rewards.nganLuong;
                gameData.danhVong = (gameData.danhVong || 0) + rewards.danhVong;

                const rewardMsg = `Khiêu chiến THẮNG LỢI! Nhận ${rewards.diemCongHien.toLocaleString()} ĐCH, ${rewards.nganLuong.toLocaleString()} NL, ${rewards.danhVong.toLocaleString()} Danh Vọng.`;
                addSectLog(rewardMsg, 'reward');
                showToast(rewardMsg, true);
            } else {
                // DEFEAT
                // Penalty: Lose some Ngan Luong?
                const nlLoss = Math.floor(rival.rewards.nganLuong * 0.1); // Lose 10% of potential NL reward
                gameData.nganLuong = Math.max(0, gameData.nganLuong - nlLoss);

                const defeatMsg = `Khiêu chiến THẤT BẠI! Mất ${nlLoss.toLocaleString()} NL bồi thường.`;
                addSectLog(defeatMsg, 'error');
                showToast(defeatMsg, false);
            }
            
            // 7. Re-render
            renderSectChallengePanel(); // Cập nhật lại tab để hiển thị cooldown
            updateUI(); // Cập nhật currencies
        }
        // [END NEW] --- Sect Challenge Functions ---

        // [NEW] --- Độ Thiên Kiếp Functions ---
        /**
         * Hiển thị tab Độ Thiên Kiếp (Placeholder)
         * [MODIFIED] Hàm này giờ không còn được dùng trực tiếp do đã hợp nhất, giữ lại để tránh lỗi reference nếu có
         */
        function renderDoThienKiepPanel() {
            // Logic đã chuyển sang renderTuTienPanel
        }
        // [END NEW] --- Độ Thiên Kiếp Functions ---

        // [NEW] --- Tu Tiên Functions ---
        /**
         * [MODIFIED] Hiển thị tab Tu Tiên (Đã hợp nhất Độ Kiếp)
         */
        function renderTuTienPanel() {
            const panel = document.getElementById('panel-tu-tien');
            if (!panel) return;

            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            if (!realm) {
                console.error("Lỗi: Không tìm thấy cảnh giới:", realmId);
                panel.innerHTML = `<p class="text-red-500">Lỗi dữ liệu cảnh giới.</p>`;
                return;
            }

            const tuVi = gameData.tuVi || 0;
            const maxTuVi = realm.maxTuVi;
            const tuViPercent = Math.min(100, (tuVi / maxTuVi) * 100);
            const linhKhi = gameData.linhKhi || 0;

            // [NEW] Hiển thị Bonus hiện tại
            let currentBonusText = "";
            if (realm.bonusStats && (realm.bonusStats.hp > 0)) {
                currentBonusText = `
                    <div class="bg-black/30 p-2 rounded border border-yellow-500/30 text-xs text-gray-300 mb-3 text-center">
                        <p class="text-yellow-400 font-bold mb-1">Thưởng Cảnh Giới</p>
                        <div class="flex justify-center gap-3">
                            <span>HP: <span class="text-green-400">+${realm.bonusStats.hp.toLocaleString()}</span></span>
                            <span>ATK: <span class="text-orange-400">+${realm.bonusStats.atk.toLocaleString()}</span></span>
                            <span>DEF: <span class="text-blue-400">+${realm.bonusStats.def.toLocaleString()}</span></span>
                        </div>
                    </div>
                `;
            }

            let actionAreaHtml = '';

            if (realm.nextRealm === null) {
                // Max realm (Đại Thừa)
                actionAreaHtml = `
                    ${currentBonusText}
                    <div class="mt-auto border-t border-gray-600 pt-4 text-center">
                        <p class="text-yellow-400 font-bold text-lg mb-2">Đại Đạo Đã Thành!</p>
                        <p class="text-gray-300 mb-4 text-sm">Bạn đã đạt cảnh giới tối đa của phàm nhân.</p>
                        <button onclick="switchTongMonTab('phi-thang')" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded shadow-lg animate-pulse">
                            Đến Phi Thăng Lộ
                        </button>
                    </div>
                `;
            } else if (tuVi >= maxTuVi) {
                // --- TRẠNG THÁI ĐỘ KIẾP ---
                const nextRealm = CANH_GIOI_DB[realm.nextRealm];
                const canAfford = linhKhi >= realm.breakthroughCost;
                
                // [NEW] Hiển thị bonus cấp tiếp theo
                let nextBonusText = "";
                if (nextRealm.bonusStats) {
                     nextBonusText = `
                        <div class="text-[10px] text-gray-400 mt-2 bg-black/20 p-1 rounded">
                            <span class="text-green-400 font-bold">Sau đột phá:</span> 
                            HP +${nextRealm.bonusStats.hp.toLocaleString()} | 
                            ATK +${nextRealm.bonusStats.atk.toLocaleString()} | 
                            DEF +${nextRealm.bonusStats.def.toLocaleString()}
                        </div>
                    `;
                }

                actionAreaHtml = `
                    ${currentBonusText}
                    <div class="mt-auto border-t border-gray-600 pt-4 bg-gray-800/50 rounded p-3">
                        <p class="text-center text-green-400 font-bold text-base mb-1 animate-pulse">Tu Vi Đã Đại Viên Mãn!</p>
                        <p class="text-center text-gray-300 text-xs mb-3">Cơ hội đột phá cảnh giới đã đến.</p>
                        
                        <div class="flex justify-center items-center gap-4 mb-2">
                             <div class="text-center">
                                <p class="text-[10px] text-gray-500 uppercase">Hiện tại</p>
                                <p class="text-lg font-bold text-yellow-500">${realm.name}</p>
                             </div>
                             <i class="fa-solid fa-angles-right text-xl text-gray-500"></i>
                             <div class="text-center">
                                <p class="text-[10px] text-gray-500 uppercase">Đột phá</p>
                                <p class="text-lg font-bold text-green-400">${nextRealm.name}</p>
                             </div>
                        </div>
                        ${nextBonusText}

                        <div class="flex justify-between items-center bg-black/30 p-2 rounded mb-3 text-xs mt-3">
                            <span class="text-gray-400">Chi phí:</span>
                            <span class="${canAfford ? 'text-purple-300' : 'text-red-400'} font-bold">${realm.breakthroughCost.toLocaleString()} Linh Khí</span>
                        </div>

                        <button onclick="dotPha()" class="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 text-white font-bold py-2 px-4 rounded shadow-lg transition transform hover:scale-105 ${!canAfford ? 'opacity-50 cursor-not-allowed grayscale' : ''}" ${!canAfford ? 'disabled' : ''}>
                            <i class="fa-solid fa-bolt-lightning mr-2"></i>ĐỘ KIẾP
                        </button>
                    </div>
                `;
            } else {
                // --- TRẠNG THÁI TU LUYỆN ---
                const canTuLuyen = linhKhi > 0;
                const tuViPerLinhKhi = realm.tuViPerClick / realm.linhKhiPerClick;
                const potentialTuVi = Math.floor(linhKhi * tuViPerLinhKhi);
                
                actionAreaHtml = `
                    ${currentBonusText}
                    <div class="mt-auto">
                        <div class="flex justify-center items-center h-16 mb-2">
                             <!-- Icon thiền định để lấp khoảng trống -->
                             <i class="fa-solid fa-person-rays text-5xl text-gray-600 opacity-20"></i>
                        </div>
                        <button onclick="tuLuyen()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow-lg ${!canTuLuyen ? 'opacity-50 cursor-not-allowed' : ''}" ${!canTuLuyen ? 'disabled' : ''}>
                            Tu Luyện (Dùng Hết Linh Khí)
                        </button>
                        <p class="text-center text-[10px] text-gray-400 mt-2">
                            Tiêu hao <span class="text-purple-300">${linhKhi.toLocaleString()}</span> Linh Khí 
                            <i class="fa-solid fa-arrow-right mx-1"></i> 
                            nhận ~<span class="text-violet-300">${potentialTuVi.toLocaleString()}</span> Tu Vi.
                        </p>
                    </div>
                `;
            }

            // [MODIFIED] Cập nhật cấu trúc HTML:
            // 1. Wrapper h-full flex flex-col items-center justify-center: Để căn giữa toàn bộ thẻ vào giữa màn hình.
            // 2. Thẻ nội dung có min-h-[28rem] (khoảng 450px): Để cố định kích thước, tránh co giãn.
            panel.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center py-4">
                    <h4 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500 mb-6 text-center uppercase tracking-widest filter drop-shadow-lg">Tu Tiên Đại Đạo</h4>
                    
                    <div class="bg-gray-800/80 backdrop-blur-md p-6 rounded-xl w-full max-w-md shadow-2xl border border-gray-600 flex flex-col justify-between min-h-[28rem] relative overflow-hidden">
                        <!-- Background Decoration -->
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>
                        <i class="fa-solid fa-yin-yang absolute -bottom-10 -right-10 text-9xl text-white/5 fa-spin" style="animation-duration: 60s;"></i>

                        <!-- Header Info -->
                        <div>
                            <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-3">
                                <span class="text-sm font-semibold text-gray-400">Cảnh Giới</span>
                                <span class="text-xl font-bold text-yellow-400 text-shadow">${realm.name}</span>
                            </div>
                            <div class="flex justify-between items-center mb-6">
                                <span class="text-sm font-semibold text-gray-400">Linh Khí</span>
                                <span class="text-lg font-bold text-purple-300 font-mono">${linhKhi.toLocaleString()}</span>
                            </div>

                            <!-- Tu Vi Progress Bar -->
                            <div class="mb-1 flex justify-between text-xs text-gray-400">
                                <span>Tiến độ Tu Vi</span>
                                <span>${Math.floor(tuViPercent)}%</span>
                            </div>
                            <div class="tuvi-bar-container mb-2 h-5 bg-gray-900 border-gray-600 relative shadow-inner">
                                <div class="tuvi-bar-fill bg-gradient-to-r from-violet-600 to-fuchsia-500" style="width: ${tuViPercent}%;"></div>
                                <div class="tuvi-bar-text text-xs font-bold shadow-black drop-shadow-md" style="top: 50%;">${tuVi.toLocaleString()} / ${maxTuVi.toLocaleString()}</div>
                            </div>
                        </div>

                        <!-- Action Area (Tu Luyen or Do Kiep) -->
                        ${actionAreaHtml}
                    </div>
                </div>
            `;
        }

        /**
         * [NEW] Thực hiện Tu Luyện (click)
         */
        function tuLuyen() {
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            if (!realm || realm.nextRealm === null) return;

            const tuVi = gameData.tuVi || 0;
            const linhKhi = gameData.linhKhi || 0;
            const maxTuVi = realm.maxTuVi;

            if (tuVi >= maxTuVi) {
                showToast("Tu vi đã đầy, hãy Đột Phá!", false);
                return;
            }

            if (linhKhi <= 0) { // [MODIFIED] Check if any Linh Khi
                showToast("Không có Linh Khí để tu luyện!", false);
                return;
            }
            
            // [NEW] All-in logic
            const tuViPerLinhKhi = realm.tuViPerClick / realm.linhKhiPerClick; // Get conversion rate
            const tuViNeeded = maxTuVi - tuVi; // How much Tu Vi is needed to max out
            
            // How much Linh Khi is needed to get that Tu Vi? (Inverse of rate)
            const linhKhiNeeded = Math.ceil(tuViNeeded / tuViPerLinhKhi);
            
            // Determine how much Linh Khi to actually consume
            const linhKhiToConsume = Math.min(linhKhi, linhKhiNeeded);
            
            // Calculate Tu Vi gained from the consumed Linh Khi
            const tuViGained = Math.floor(linhKhiToConsume * tuViPerLinhKhi);

            // Safety check, in case of rounding errors, don't add more than needed
            const finalTuViGained = Math.min(tuViGained, tuViNeeded);
            
            // Handle edge case where conversion is too low and rounds to 0
            if (finalTuViGained <= 0 && linhKhiToConsume > 0) {
                 showToast(`Cần thêm Linh Khí để nhận ít nhất 1 Tu Vi.`, false);
                 return;
            }

            // Tiêu hao và nhận
            gameData.linhKhi -= linhKhiToConsume;
            addTuVi(finalTuViGained); // Use helper function

            showToast(`Đã dùng ${linhKhiToConsume.toLocaleString()} Linh Khí, nhận ${finalTuViGained.toLocaleString()} Tu Vi.`, true);

            // Cập nhật lại UI
            renderTuTienPanel();
            updateUI(); // Cập nhật Linh Khí ở panel chính
        }

        /**
         * [NEW] Helper function to add Tu Vi safely (handles capping)
         */
        function addTuVi(amount) {
            if (amount <= 0) return;
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            if (!realm) return;

            let tuViCurrent = gameData.tuVi || 0;

            // If already at max Tu Vi for this realm, and not max realm
            if (tuViCurrent >= realm.maxTuVi && realm.nextRealm !== null) {
                return; // Don't add more, user must break through
            }

            let newTuVi = tuViCurrent + amount;
            
            // Cap at max Tu Vi
            newTuVi = Math.min(realm.maxTuVi, newTuVi);
            
            gameData.tuVi = newTuVi;
        }

        /**
         * [NEW] Thực hiện Đột Phá / Độ Kiếp
         */
        function dotPha() {
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            if (!realm || realm.nextRealm === null) {
                showToast("Bạn đã ở cảnh giới tối đa!", false);
                return;
            }
            
            const tuVi = gameData.tuVi || 0;
            const linhKhi = gameData.linhKhi || 0;

            if (tuVi < realm.maxTuVi) {
                showToast("Tu vi chưa đủ để đột phá!", false);
                return;
            }
            
            if (linhKhi < realm.breakthroughCost) {
                showToast("Không đủ Linh Khí để đột phá!", false);
                return;
            }

            // Trừ chi phí
            gameData.linhKhi -= realm.breakthroughCost;
            
            // Xử lý thành công
            const nextRealmId = realm.nextRealm;
            const nextRealm = CANH_GIOI_DB[nextRealmId];
            
            gameData.canhGioi = nextRealmId;
            gameData.tuVi = 0; // Reset Tu Vi
            
            const successMsg = `ĐỘT PHÁ THÀNH CÔNG! Chúc mừng bạn đã đạt tới cảnh giới: ${nextRealm.name}!`;
            addSectLog(successMsg, 'system');
            showToast(successMsg, true);

            // Cập nhật lại UI
            updateUI(); // Cập nhật Linh Khí
            renderTuTienPanel(); // Cập nhật lại panel này (sẽ chuyển về dạng Tu Luyện cho cảnh giới mới)
            // renderDoThienKiepPanel(); // [REMOVED] Không cần nữa
        }

        // [END NEW] --- Tu Tiên Functions ---

        // [NEW] --- Bế Quan Functions ---
        /**
         * [NEW] Helper to format milliseconds into H:M:S
         */
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * [NEW] Calculate Be Quan rewards based on time and realm
         */
        function calculateBeQuanRewards(timeMs) {
            const realmId = gameData.canhGioi || 'pham_nhan';
            const rates = BE_QUAN_RATES_DB[realmId] || BE_QUAN_RATES_DB['pham_nhan'];
            
            const hours = timeMs / 3600000; // Time in hours
            
            const tuViGained = Math.floor(rates.tuViPerHour * hours);
            const linhKhiGained = Math.floor(rates.linhKhiPerHour * hours);
            
            return { tuViGained, linhKhiGained };
        }

        /**
         * [MODIFIED] Hiển thị tab Bế Quan - UI Cải tiến & Cố định khung
         */
        function renderBeQuanPanel() {
            const panel = document.getElementById('panel-be-quan');
            if (!panel) return;

            const realmId = gameData.canhGioi || 'pham_nhan';
            const rates = BE_QUAN_RATES_DB[realmId] || BE_QUAN_RATES_DB['pham_nhan'];
            const realmName = CANH_GIOI_DB[realmId] ? CANH_GIOI_DB[realmId].name : 'Phàm Nhân';

            // Wrapper để căn giữa
            let html = `<div class="h-full flex flex-col items-center justify-center py-2">`;
            
            // Title
            html += `<h4 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500 mb-4 text-center uppercase tracking-widest filter drop-shadow-lg">Bế Quan Tu Luyện</h4>`;

            // Main Fixed Container
            html += `<div class="bg-gray-800/90 backdrop-blur-md border border-gray-600 p-6 rounded-xl w-full max-w-md shadow-2xl flex flex-col justify-between relative overflow-hidden transition-all duration-300" style="height: 420px;">`;
            
            // Decorative Background
            html += `<div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50"></div>`;
            html += `<i class="fa-solid fa-person-booth absolute -bottom-8 -left-8 text-[10rem] text-white/5 pointer-events-none select-none"></i>`;

            if (gameData.isBeQuan) {
                // --- TRẠNG THÁI: ĐANG BẾ QUAN ---
                const now = Date.now();
                const startTime = gameData.lastBeQuanClaim || gameData.beQuanStartTime;
                const accumulatedTimeMs = now - startTime;
                const { tuViGained, linhKhiGained } = calculateBeQuanRewards(accumulatedTimeMs);
                
                html += `
                    <!-- Content Area -->
                    <div class="flex-grow flex flex-col justify-center items-center space-y-5 z-10">
                        <div class="text-center animate-pulse">
                            <div class="w-16 h-16 rounded-full bg-yellow-900/30 border-2 border-yellow-500/50 flex items-center justify-center mx-auto mb-2 shadow-[0_0_15px_rgba(234,179,8,0.2)]">
                                <i class="fa-solid fa-clock text-3xl text-yellow-400"></i>
                            </div>
                            <p class="text-lg text-yellow-200 font-semibold tracking-wide">Đang Nhập Định...</p>
                        </div>
                        
                        <div class="w-full bg-black/40 rounded-lg p-3 border border-gray-600 text-center">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Thời gian thiền định</p>
                            <p class="text-4xl font-mono font-bold text-white tracking-widest text-shadow-sm">${formatTime(accumulatedTimeMs)}</p>
                        </div>

                        <div class="w-full grid grid-cols-2 gap-3">
                            <div class="bg-gray-700/60 p-2 rounded border border-gray-600 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 p-1 opacity-20"><i class="fa-solid fa-fire text-violet-400"></i></div>
                                <p class="text-[10px] text-gray-400 uppercase">Tu Vi</p>
                                <p class="font-bold text-violet-300 text-lg">+${tuViGained.toLocaleString()}</p>
                                <p class="text-[9px] text-gray-500 mt-1">(${rates.tuViPerHour.toLocaleString()}/h)</p>
                            </div>
                            <div class="bg-gray-700/60 p-2 rounded border border-gray-600 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 p-1 opacity-20"><i class="fa-solid fa-wind text-purple-400"></i></div>
                                <p class="text-[10px] text-gray-400 uppercase">Linh Khí</p>
                                <p class="font-bold text-purple-300 text-lg">+${linhKhiGained.toLocaleString()}</p>
                                <p class="text-[9px] text-gray-500 mt-1">(${rates.linhKhiPerHour.toLocaleString()}/h)</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer Button -->
                    <div class="mt-4 pt-4 border-t border-gray-700/50 z-10">
                        <button onclick="endBeQuan()" class="w-full bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-500 hover:to-emerald-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 group">
                            <i class="fa-solid fa-door-open group-hover:-translate-x-1 transition"></i> 
                            <span>Xuất Quan (Nhận Thưởng)</span>
                        </button>
                    </div>
                `;
            } else {
                // --- TRẠNG THÁI: CHƯA BẾ QUAN ---
                html += `
                    <!-- Content Area -->
                    <div class="flex-grow flex flex-col justify-center items-center space-y-6 z-10">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-gray-900 rounded-full mx-auto flex items-center justify-center border-2 border-blue-500/50 shadow-[0_0_25px_rgba(59,130,246,0.2)] mb-3 group cursor-default">
                                <i class="fa-solid fa-person-rays text-4xl text-blue-300 group-hover:scale-110 transition duration-500"></i>
                            </div>
                            <h5 class="text-xl font-bold text-white">Chuẩn Bị Bế Quan</h5>
                            <p class="text-xs text-gray-400 mt-2 px-2 leading-relaxed">
                                Tự động tích lũy tài nguyên theo thời gian thực.<br>
                                Hiệu quả phụ thuộc vào cảnh giới hiện tại.
                            </p>
                        </div>

                        <div class="w-full bg-black/30 rounded-lg p-4 border border-gray-600">
                            <div class="flex justify-between items-center border-b border-gray-700/50 pb-2 mb-3">
                                <span class="text-xs text-gray-400 uppercase font-bold">Cảnh Giới</span>
                                <span class="text-sm font-bold text-yellow-400 bg-yellow-900/20 px-2 py-0.5 rounded border border-yellow-600/30">${realmName}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center divide-x divide-gray-700/50">
                                <div>
                                    <p class="text-[10px] text-gray-500 uppercase mb-1">Tốc độ Tu Vi</p>
                                    <p class="font-mono text-violet-300 font-bold text-lg">${rates.tuViPerHour.toLocaleString()}<span class="text-[10px] text-gray-500 ml-0.5">/h</span></p>
                                </div>
                                <div>
                                    <p class="text-[10px] text-gray-500 uppercase mb-1">Tốc độ Linh Khí</p>
                                    <p class="font-mono text-purple-300 font-bold text-lg">${rates.linhKhiPerHour.toLocaleString()}<span class="text-[10px] text-gray-500 ml-0.5">/h</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Button -->
                    <div class="mt-4 pt-4 border-t border-gray-700/50 z-10">
                        <button onclick="startBeQuan()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-500 hover:to-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 group">
                            <i class="fa-solid fa-lock group-hover:scale-110 transition"></i> 
                            <span>Bắt Đầu Bế Quan</span>
                        </button>
                    </div>
                `;
            }
            
            html += `</div></div>`; 
            panel.innerHTML = html;
        }

        /**
         * [NEW] Bắt đầu Bế Quan
         */
        function startBeQuan() {
            if (gameData.isBeQuan) {
                showToast("Đã đang bế quan!", false);
                return;
            }
            
            const now = Date.now();
            gameData.isBeQuan = true;
            gameData.beQuanStartTime = now;
            gameData.lastBeQuanClaim = now; // Thời điểm nhận thưởng cuối cùng là bây giờ

            addSectLog("Tông chủ bắt đầu bế quan tu luyện.", 'system');
            showToast("Bắt đầu bế quan...", true);
            
            // Cập nhật lại UI
            renderBeQuanPanel();
        }

        /**
         * [NEW] Kết thúc Bế Quan và nhận thưởng
         */
        function endBeQuan() {
            if (!gameData.isBeQuan) {
                showToast("Bạn không đang bế quan!", false);
                return;
            }

            const now = Date.now();
            const startTime = gameData.lastBeQuanClaim || gameData.beQuanStartTime;
            const accumulatedTimeMs = now - startTime;
            
            const { tuViGained, linhKhiGained } = calculateBeQuanRewards(accumulatedTimeMs);
            
            let msg = "Kết thúc bế quan.";
            if (tuViGained > 0 || linhKhiGained > 0) {
                gameData.linhKhi = (gameData.linhKhi || 0) + linhKhiGained;
                addTuVi(tuViGained); // Dùng helper function
                
                msg = `Kết thúc bế quan! Nhận ${tuViGained.toLocaleString()} Tu Vi và ${linhKhiGained.toLocaleString()} Linh Khí.`;
                addSectLog(msg, 'reward');
                showToast(msg, true);
            } else {
                showToast("Kết thúc bế quan. Chưa tích lũy được gì.", true);
            }
            
            // Reset
            gameData.isBeQuan = false;
            gameData.beQuanStartTime = null;
            gameData.lastBeQuanClaim = null;
            
            // Cập nhật UI
            renderBeQuanPanel();
            renderTuTienPanel(); // Cập nhật Tu Vi
            updateUI(); // Cập nhật Linh Khí
        }

        // [END NEW] --- Bế Quan Functions ---

        // [NEW] --- Độ Thiên Kiếp Functions ---
        /**
         * Hiển thị tab Độ Thiên Kiếp (Placeholder)
         */
        function renderDoThienKiepPanel() {
            const panel = document.getElementById('panel-do-thien-kiep');
            if (!panel) return;
            
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            const tuVi = gameData.tuVi || 0;
            const linhKhi = gameData.linhKhi || 0;
            
            let html = `<h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Độ Thiên Kiếp</h4>`;

            if (realm.nextRealm === null) {
                // Đã đạt max realm
                html += `
                <div class="bg-gray-700 p-4 rounded-lg max-w-md mx-auto text-center">
                    <p class="text-2xl font-bold text-yellow-400">${realm.name}</p>
                    <p class="text-gray-300 mt-4">Bạn đã đạt cảnh giới tối đa, không thể đột phá thêm.</p>
                    <p class="text-gray-300 mt-2">Hãy đến tab <strong class="text-cyan-300">"Phi Thăng"</strong> để bắt đầu một hành trình mới!</p>
                </div>
                `;
            } else if (tuVi < realm.maxTuVi) {
                // Chưa đủ Tu Vi
                html += `
                <div class="bg-gray-700 p-4 rounded-lg max-w-md mx-auto text-center">
                    <p class="text-lg font-semibold text-gray-300">Cảnh Giới Hiện Tại:</p>
                    <p class="text-2xl font-bold text-yellow-400 mb-4">${realm.name}</p>
                    <p class="text-gray-400">Tu vi của bạn chưa đạt đại viên mãn.</p>
                    <p class="text-gray-300 mt-2">Hãy đến tab <strong class="text-cyan-300">"Tu Tiên"</strong> hoặc <strong class="text-cyan-300">"Bế Quan"</strong> để tiếp tục tu luyện.</p>
                </div>
                `;
            } else {
                // Sẵn sàng đột phá
                const nextRealm = CANH_GIOI_DB[realm.nextRealm];
                const canAfford = linhKhi >= realm.breakthroughCost;
                html += `
                <div class="bg-gray-700 p-4 rounded-lg max-w-md mx-auto text-center">
                    <p class="text-gray-300">Chúc mừng! Tu vi của bạn đã đại viên mãn.</p>
                    <p class="text-lg font-semibold text-gray-300 mt-4">Sắp đột phá từ:</p>
                    <p class="text-2xl font-bold text-yellow-400">${realm.name}</p>
                    <i class="fa-solid fa-arrow-down text-3xl text-cyan-300 my-4"></i>
                    <p class="text-2xl font-bold text-green-400">${nextRealm.name}</p>

                    <div class="bg-gray-800 p-3 rounded mt-6">
                        <p class="text-sm text-gray-400">Chi phí đột phá:</p>
                        <p class="text-lg font-bold ${canAfford ? 'text-purple-300' : 'text-red-400'}">${realm.breakthroughCost.toLocaleString()} Linh Khí</p>
                        <p class="text-sm text-gray-400">(Đang có: ${linhKhi.toLocaleString()})</p>
                    </div>

                    <button onclick="dotPha()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded shadow-lg mt-6 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        BẮT ĐẦU ĐỘ KIẾP
                    </button>
                </div>
                `;
            }
            
            panel.innerHTML = html;
        }
        // [END NEW] --- Độ Thiên Kiếp Functions ---

        // [NEW] --- Phi Thăng Functions ---
        /**
         * Hiển thị tab Phi Thăng
         */
        function renderPhiThangPanel() {
            const panel = document.getElementById('panel-phi-thang');
            if (!panel) return;

            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            const tuVi = gameData.tuVi || 0;
            const tienLuc = gameData.tienLuc || 0;

            // [MODIFIED] Đổi điều kiện từ Đại Thừa thành Thánh Nhân
            const isMaxRealm = (realm.id === 'thanh_nhan'); 
            const isMaxTuVi = (tuVi >= realm.maxTuVi);
            const canAscend = isMaxRealm && isMaxTuVi;
            
            // Tính Tiên Lực sẽ nhận được. 
            // [MODIFIED] Thay đổi thưởng Phi thăng thành 200 điểm tiên lực cố định
            const tienLucGain = 200;
            
            // Bonus hiện tại từ Tiên Lực
            const currentBonus = (gameData.tienLuc || 0) * 1; // +1% all stats per point

            // [NEW] Khu vực đổi Linh Khí -> Tu Vi (Chỉ hiện khi ở Thánh Nhân và thiếu Tu Vi)
            let exchangeHtml = '';
            if (isMaxRealm && !isMaxTuVi) {
                exchangeHtml = `
                    <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-yellow-500/30 shadow-inner">
                        <h5 class="font-bold text-yellow-300 mb-2 text-center"><i class="fa-solid fa-bolt-lightning mr-2"></i>Bổ Sung Tu Vi (Thánh Nhân)</h5>
                        <p class="text-xs text-gray-300 mb-3 text-center">Đổi Linh Khí lấy Tu Vi để đạt điều kiện Phi Thăng.</p>
                        <p class="text-xs text-gray-400 mb-3 text-center">Tỷ lệ: <span class="text-purple-300 font-bold">200 Linh Khí</span> = <span class="text-violet-300 font-bold">1 Tu Vi</span></p>
                        
                        <div class="flex justify-center gap-3 mb-2">
                            <button onclick="exchangeLinhKhiToTuVi('all')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-xs shadow-md transition transform hover:scale-105">
                                Đổi Hết Linh Khí
                            </button>
                             <button onclick="exchangeLinhKhiToTuVi('fill')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-xs shadow-md transition transform hover:scale-105">
                                Đổi Đủ Phi Thăng
                            </button>
                        </div>
                        
                        <!-- Progress Bar for Visualization -->
                        <div class="w-full bg-gray-900 h-4 rounded-full mt-3 relative overflow-hidden border border-gray-600">
                            <div class="bg-gradient-to-r from-violet-600 to-fuchsia-500 h-full transition-all duration-500" style="width: ${(tuVi / realm.maxTuVi) * 100}%"></div>
                            <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white text-shadow">
                                ${tuVi.toLocaleString()} / ${realm.maxTuVi.toLocaleString()} Tu Vi
                            </div>
                        </div>
                    </div>
                `;
            }

            let html = `
                <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Phi Thăng Tiên Giới</h4>
                <div class="bg-gray-700 p-4 rounded-lg max-w-lg mx-auto text-center shadow-lg border border-gray-600">
                    <p class="text-gray-300 mb-4">Phi thăng sẽ đặt lại Cảnh Giới và Tu Vi của bạn về Phàm Nhân. Đổi lại, bạn sẽ nhận được <span class="font-bold text-cyan-300">Tiên Lực</span>.</p>
                    <p class="text-gray-300 mb-4">Mỗi điểm <span class="font-bold text-cyan-300">Tiên Lực</span> tăng vĩnh viễn <span class="font-bold text-yellow-300">+1%</span> tất cả các chỉ số cơ bản (HP, Mana, Công, Thủ, Thân, May).</p>
                    
                    <div class="grid grid-cols-2 gap-4 my-6">
                        <div class="bg-gray-800 p-3 rounded border border-cyan-500/30">
                            <p class="text-sm text-gray-400">Tiên Lực Hiện Tại</p>
                            <p class="text-2xl font-bold text-cyan-300">${tienLuc.toLocaleString()}</p>
                            <p class="text-sm text-gray-300">(Bonus: +${currentBonus}%)</p>
                        </div>
                        <div class="bg-gray-800 p-3 rounded border border-green-500/30">
                            <p class="text-sm text-gray-400">Tiên Lực sẽ nhận</p>
                            <p class="text-2xl font-bold text-green-400">+${tienLucGain.toLocaleString()}</p>
                            <p class="text-sm text-gray-300">(Tổng sẽ là ${tienLuc + tienLucGain})</p>
                        </div>
                    </div>

                    ${exchangeHtml}

                    <h5 class="font-bold text-yellow-300 mb-2">Yêu Cầu Phi Thăng</h5>
                    <ul class="list-disc list-inside text-left mx-auto max-w-xs mb-6 bg-gray-800/50 p-3 rounded border border-gray-600">
                        <li class="${isMaxRealm ? 'text-green-400' : 'text-red-400'}">
                            <!-- [MODIFIED] Cập nhật Text yêu cầu -->
                            Cảnh giới: Thánh Nhân (Hiện tại: ${realm.name})
                        </li>
                        <li class="${isMaxTuVi ? 'text-green-400' : 'text-red-400'}">
                            Tu Vi: ${realm.maxTuVi.toLocaleString()} (Hiện tại: ${tuVi.toLocaleString()})
                        </li>
                    </ul>

                    <button onclick="confirmPhiThang(${tienLucGain})" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded shadow-lg ${!canAscend ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAscend ? 'disabled' : ''}>
                        Bắt Đầu Phi Thăng
                    </button>
                </div>
            `;
            
            panel.innerHTML = html;
        }

        /**
         * [NEW] Đổi Linh Khí sang Tu Vi (Chỉ dành cho Thánh Nhân)
         */
        function exchangeLinhKhiToTuVi(mode) {
            const realmId = gameData.canhGioi || 'pham_nhan';
            if (realmId !== 'thanh_nhan') {
                showToast("Chức năng chỉ dành cho cảnh giới Thánh Nhân!", false);
                return;
            }
            
            const realm = CANH_GIOI_DB[realmId];
            const currentTuVi = gameData.tuVi || 0;
            const maxTuVi = realm.maxTuVi;
            const currentLinhKhi = gameData.linhKhi || 0;
            const RATE = 200; // 200 LK = 1 Tu Vi

            if (currentTuVi >= maxTuVi) {
                showToast("Tu Vi đã đầy, có thể Phi Thăng!", false); return;
            }

            const tuViNeeded = maxTuVi - currentTuVi;
            // Tính số Tu Vi tối đa có thể mua với lượng Linh Khí hiện có
            const maxTuViBuyable = Math.floor(currentLinhKhi / RATE);

            let tuViToBuy = 0;

            if (mode === 'all') {
                // Mua hết khả năng, nhưng không vượt quá số cần thiết để max
                tuViToBuy = Math.min(tuViNeeded, maxTuViBuyable);
            } else if (mode === 'fill') {
                // Cố gắng mua đủ số cần thiết
                tuViToBuy = tuViNeeded;
            }

            if (tuViToBuy <= 0) {
                 showToast("Không đủ Linh Khí để đổi dù chỉ 1 Tu Vi!", false); return;
            }
            
            const cost = tuViToBuy * RATE;

            if (currentLinhKhi < cost) {
                 showToast(`Thiếu ${(cost - currentLinhKhi).toLocaleString()} Linh Khí để đổi lượng Tu Vi này!`, false); return;
            }

            // Thực hiện giao dịch
            gameData.linhKhi -= cost;
            gameData.tuVi += tuViToBuy;
            
            showToast(`Đã đổi ${cost.toLocaleString()} Linh Khí lấy ${tuViToBuy.toLocaleString()} Tu Vi.`, true);
            
            // Cập nhật UI
            updateUI();
            renderPhiThangPanel();
        }

        /**
         * [NEW] Xác nhận Phi Thăng
         */
        function confirmPhiThang(tienLucGain) {
            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Xác Nhận Phi Thăng';
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2">Bạn có chắc muốn Phi Thăng?</p>
                    <p class="text-gray-300 mb-1"><strong class="text-red-400">Cảnh Giới</strong> và <strong class="text-red-400">Tu Vi</strong> của bạn sẽ bị <strong class="text-red-400">RESET</strong> về Phàm Nhân.</p>
                    <p class="text-gray-300 mb-1">Mọi hoạt động Bế Quan sẽ dừng lại.</p>
                    <p class="font-bold text-yellow-300 text-lg mt-4">Phần thưởng:</p>
                    <ul class="list-disc list-inside ml-4 text-gray-300">
                        <li><span class="text-cyan-400 font-semibold">${tienLucGain} Tiên Lực</span></li>
                        <li>(Tổng Tiên Lực sẽ là: <span class="text-cyan-400">${(gameData.tienLuc || 0) + tienLucGain}</span>)</li>
                    </ul>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button onclick="performPhiThang(${tienLucGain})" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Phi Thăng</button>
                `;
            }
            
            showModal('dungeon-confirm-modal');
        }

        /**
         * [NEW] Thực hiện Phi Thăng
         */
        function performPhiThang(tienLucGain) {
            const realmId = gameData.canhGioi || 'pham_nhan';
            const realm = CANH_GIOI_DB[realmId];
            const tuVi = gameData.tuVi || 0;
            const isMaxRealm = (realm.id === 'thanh_nhan');
            const isMaxTuVi = (tuVi >= realm.maxTuVi);

            if (!isMaxRealm || !isMaxTuVi) {
                showToast("Chưa đủ điều kiện Phi Thăng!", false);
                hideModal('dungeon-confirm-modal');
                return;
            }

            // 1. Dừng Bế Quan (nếu đang Bế Quan)
            if (gameData.isBeQuan) {
                endBeQuan(); // Dừng và nhận thưởng Bế Quan trước
            }

            // 2. Thêm Tiên Lực
            gameData.tienLuc = (gameData.tienLuc || 0) + tienLucGain;

            // 3. Reset Tu Vi
            gameData.canhGioi = 'pham_nhan';
            gameData.tuVi = 0;

            // 4. Thông báo và cập nhật
            addSectLog(`TÔNG CHỦ PHI THĂNG! Đạt được ${tienLucGain} Tiên Lực! Cảnh giới quay về Phàm Nhân để tu luyện lại.`, 'system');
            showToast(`Phi Thăng thành công! Nhận ${tienLucGain} Tiên Lực.`, true);

            hideModal('dungeon-confirm-modal');
            updateUI(); // Cập nhật chỉ số (quan trọng)
            renderPhiThangPanel(); // Cập nhật tab Phi Thăng
            
            // Cập nhật các tab Tu Tiên / Bế Quan nếu đang mở
            if (!document.getElementById('panel-tu-tien').classList.contains('hidden')) {
                renderTuTienPanel();
            }
            if (!document.getElementById('panel-be-quan').classList.contains('hidden')) {
                renderBeQuanPanel();
            }
        }

        // [END NEW] --- Phi Thăng Functions ---

        // [NEW] --- Truyền Công Functions ---
        /**
         * Hiển thị tab Truyền Công (Placeholder)
         */
        function renderTruyenCongPanel() {
            const panel = document.getElementById('panel-truyen-cong');
            if (!panel) return;

            const availableDisciples = gameData.disciples.filter(d => d.status === 'Nhàn Rỗi');
            
            panel.innerHTML = `
                <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Truyền Công</h4>
                <p class="text-center text-gray-400 mb-4">Chọn tối đa 20 đệ tử (Nguyên Liệu) để truyền 50% chỉ số cơ bản cho 1 đệ tử khác (Mục Tiêu).<br>Đệ tử Nguyên Liệu sẽ <strong class="text-red-400">biến mất</strong>. Cần tiêu hao Ngân Lượng.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Col 1: Nguyên Liệu (Material) List -->
                    <div>
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Chọn Nguyên Liệu (Để hy sinh)</h5>
                        <div id="truyen-cong-material-list" class="space-y-2 bg-gray-900 p-2 rounded h-80 overflow-y-auto scrollbar-thin">
                            ${generateDiscipleListHTML(availableDisciples, 'material')}
                        </div>
                    </div>
                    <!-- Col 2: Info & Button -->
                    <div class="flex flex-col">
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Mục Tiêu (Nhận)</h5>
                        <div id="truyen-cong-target-slot" class="bg-gray-700 rounded p-3 w-full mb-2 text-center h-28 flex items-center justify-center">
                            <span class="text-gray-500">Chọn mục tiêu...</span>
                        </div>
                        <i class="fa-solid fa-arrow-down text-2xl text-red-400 my-2 text-center"></i>
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Nguyên Liệu (Hy sinh)</h5>
                        <!-- [MODIFIED] This is now a scrollable list -->
                        <div id="truyen-cong-material-slot" class="bg-gray-900 rounded p-2 w-full mb-2 text-center h-40 flex-grow overflow-y-auto scrollbar-thin">
                            <span class="text-gray-500">Chọn nguyên liệu...</span>
                        </div>
                        <div id="truyen-cong-info" class="text-center mt-2"></div>
                        <button id="perform-truyen-cong-btn" onclick="confirmTruyenCong()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mt-4 opacity-50 cursor-not-allowed" disabled>
                            Truyền Công
                        </button>
                    </div>
                    <!-- Col 3: Mục Tiêu (Target) List -->
                    <div>
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Chọn Mục Tiêu (Để nhận)</h5>
                        <div id="truyen-cong-target-list" class="space-y-2 bg-gray-900 p-2 rounded h-80 overflow-y-auto scrollbar-thin">
                            ${generateDiscipleListHTML(availableDisciples, 'target')}
                        </div>
                    </div>
                </div>
            `;
            
            // Call update slots in case selections were already made
            updateTruyenCongSlots();
        }

        /**
         * [NEW] Helper for renderTruyenCongPanel to generate lists
         */
        function generateDiscipleListHTML(disciples, type) {
            if (disciples.length === 0) {
                // [MODIFIED] Thông báo cụ thể cho danh sách Mục Tiêu
                if (type === 'target') {
                    return `<p class="text-xs text-gray-500 text-center py-4">Chưa có đệ tử nào được Khóa.<br>(Hãy khóa đệ tử quan trọng để chọn làm mục tiêu)</p>`;
                }
                return `<p class="text-xs text-gray-500 text-center py-4">Không có đệ tử rảnh rỗi.</p>`;
            }

            return disciples.map(d => {
                let isDisabled = false;
                let isSelected = false;
                let reason = '';
                let overlayHtml = ''; // [NEW] Biến chứa hiệu ứng đè lên

                if (type === 'material') {
                    if (d.isLocked) { // [NEW] Check for lock
                        isDisabled = true; 
                        reason = ' (Đã khóa)';
                    } else if (d.id === selectedTruyenCongTarget) { 
                        isDisabled = true; 
                        reason = ' (Mục Tiêu)';
                    }
                    if (selectedTruyenCongMaterials.includes(d.id)) { isSelected = true; } // [MODIFIED] Check array
                } else { // type === 'target'
                    if (selectedTruyenCongMaterials.includes(d.id)) { // [MODIFIED] Check array
                        isDisabled = true; 
                        reason = ' (Nguyên Liệu)';
                    }
                    if (d.id === selectedTruyenCongTarget) { isSelected = true; }
                }
                
                const rankInfo = getDiscipleRank(d.level);
                // [NEW] Lấy thông tin phẩm chất
                const potential = d.potential || 'Yếu Kém';
                const potStyle = getPotentialStyle(potential);
                
                // [NEW] Xử lý Class CSS động cho hiệu ứng
                let cardClasses = "bg-gray-700 rounded p-2 cursor-pointer hover:bg-gray-600 transition-all duration-200 relative overflow-hidden border border-gray-600";
                
                if (isDisabled) {
                    cardClasses += " opacity-40 cursor-not-allowed";
                } else if (isSelected) {
                    if (type === 'material') {
                        // [HIỆU ỨNG HI SINH MỚI]: Viền xanh dương (Cyan), nền xanh thẫm, icon RỒNG THẦN
                        cardClasses = "bg-blue-900/40 rounded p-2 cursor-pointer border-2 border-cyan-500 shadow-[0_0_15px_rgba(34,211,238,0.6)] relative overflow-hidden";
                        overlayHtml = `
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                                <i class="fa-solid fa-dragon text-cyan-400 text-6xl opacity-30 animate-pulse"></i>
                            </div>
                            <div class="absolute top-1 right-1 pointer-events-none z-20">
                                <i class="fa-solid fa-angles-up text-cyan-300 text-sm animate-bounce"></i>
                            </div>
                        `;
                    } else {
                        // [HIỆU ỨNG MỤC TIÊU]: Viền vàng, nền sáng
                        cardClasses = "bg-yellow-900/20 rounded p-2 cursor-pointer border-2 border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.3)] relative overflow-hidden";
                        overlayHtml = `
                             <div class="absolute top-1 right-1 pointer-events-none z-20">
                                <i class="fa-solid fa-check-circle text-green-400 text-sm"></i>
                            </div>
                        `;
                    }
                }

                return `
                <div onclick="${isDisabled ? '' : `selectTruyenCongDisciple('${type}', '${d.id}')`}" class="${cardClasses}">
                    ${overlayHtml}
                    <div class="relative z-10">
                        <!-- [MODIFIED] Đổi màu chữ tên đệ tử hi sinh sang xanh nhạt cho hợp tông -->
                        <p class="font-bold text-xs ${isSelected && type === 'material' ? 'text-cyan-100' : 'text-white'} truncate">${d.name} <span class="text-[10px] font-normal text-gray-400">(Lv.${d.level})</span>${reason}</p>
                        
                        <div class="flex flex-wrap items-center gap-1 my-1">
                             <span class="text-[9px] px-1 rounded bg-black/30 ${rankInfo.class}">${rankInfo.name}</span>
                             <span class="text-[9px] px-1 rounded bg-black/30 font-bold ${potStyle.text}">${potential}</span>
                        </div>

                        <div class="grid grid-cols-2 gap-x-1 text-[10px] text-gray-400">
                            <span>HP: ${d.stats.hp.toLocaleString()}</span>
                            <span>Atk: ${d.stats.atk.toLocaleString()}</span>
                            <span>Def: ${(d.stats.def||0).toLocaleString()}</span>
                            <span>Spd: ${(d.stats.spd||0).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        /**
         * [NEW] Handle clicking on a disciple in Truyen Cong lists
         */
        function selectTruyenCongDisciple(type, discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) return;

            if (type === 'material') {
                // [NEW] Cannot select if locked
                if (disciple.isLocked) {
                    showToast("Đệ tử này đã bị khóa, không thể dùng làm nguyên liệu.", false);
                    return;
                }
                // Cannot select the target
                if (discipleId === selectedTruyenCongTarget) {
                    showToast("Không thể chọn đệ tử Mục Tiêu làm Nguyên Liệu.", false);
                    return;
                }

                const index = selectedTruyenCongMaterials.indexOf(discipleId);
                if (index > -1) {
                    // Already selected, de-select
                    selectedTruyenCongMaterials.splice(index, 1);
                } else {
                    // Not selected, add
                    selectedTruyenCongMaterials.push(discipleId);
                }
            } else { // type === 'target'
                // Cannot select if in material list
                if (selectedTruyenCongMaterials.includes(discipleId)) {
                    showToast("Không thể chọn Nguyên Liệu làm Mục Tiêu.", false);
                    return;
                }
                // Toggle target
                selectedTruyenCongTarget = (selectedTruyenCongTarget === discipleId) ? null : discipleId; // Toggle
            }
            
            // Re-render lists
            updateTruyenCongLists();
            // Re-render center panel
            updateTruyenCongSlots();
        }

        /**
         * [NEW] Re-renders only the disciple lists in Truyen Cong
         */
        function updateTruyenCongLists() {
            const availableDisciples = gameData.disciples.filter(d => d.status === 'Nhàn Rỗi');
            // [MODIFIED] Lọc danh sách mục tiêu: Chỉ lấy đệ tử đã Khóa
            const targetDisciples = availableDisciples.filter(d => d.isLocked);

            const materialList = document.getElementById('truyen-cong-material-list');
            const targetList = document.getElementById('truyen-cong-target-list');
            
            if (materialList) materialList.innerHTML = generateDiscipleListHTML(availableDisciples, 'material');
            if (targetList) targetList.innerHTML = generateDiscipleListHTML(targetDisciples, 'target');
        }

        /**
         * [NEW] Updates the center info panel in Truyen Cong
         */
        function updateTruyenCongSlots() {
            const targetSlot = document.getElementById('truyen-cong-target-slot');
            const materialSlot = document.getElementById('truyen-cong-material-slot');
            const infoEl = document.getElementById('truyen-cong-info');
            const btn = document.getElementById('perform-truyen-cong-btn');

            let target = null;
            let material = null;

            // Render Target Slot
            if (selectedTruyenCongTarget) {
                target = gameData.disciples.find(d => d.id === selectedTruyenCongTarget);
                if (target) {
                    const potStyle = getPotentialStyle(target.potential || 'Yếu Kém');
                    // [FIX] Assign to innerHTML
                    targetSlot.innerHTML = `
                        <p class="font-bold text-sm text-yellow-300">${target.name} (Cấp ${target.level})</p>
                        <p class="text-xs font-bold ${potStyle.text} mb-1">${target.potential || 'Yếu Kém'}</p>
                        <div class="grid grid-cols-2 gap-x-2 text-xs text-gray-300 text-left px-4">
                            <span>HP: ${target.stats.hp.toLocaleString()}</span>
                            <span>Công: ${target.stats.atk.toLocaleString()}</span>
                            <span>Thủ: ${(target.stats.def||0).toLocaleString()}</span>
                            <span>Thân: ${(target.stats.spd||0).toLocaleString()}</span>
                        </div>
                    `;
                } else { 
                    selectedTruyenCongTarget = null; /* Clear broken ID */ 
                    target = null; // [FIX] Ensure target is null so the next block executes
                }
            }
            if (!target) { // [FIX] Check target again
                targetSlot.innerHTML = `<span class="text-gray-500">Chọn mục tiêu...</span>`;
            }

            // [MODIFIED] Render Material Slot (as a list)
            if (selectedTruyenCongMaterials.length > 0) {
                materialSlot.innerHTML = selectedTruyenCongMaterials.map(id => {
                    const m = gameData.disciples.find(d => d.id === id);
                    if (!m) return '';
                    const potStyle = getPotentialStyle(m.potential || 'Yếu Kém');
                    return `
                    <div class="bg-gray-700 p-2 rounded mb-1 text-left text-xs flex justify-between items-center">
                        <div>
                            <p class="font-bold text-white">${m.name} <span class="font-normal text-gray-400">(Lv.${m.level})</span></p>
                            <p class="font-bold ${potStyle.text}">${m.potential || 'Yếu Kém'}</p>
                        </div>
                        <div class="text-right text-gray-400 text-[10px]">
                            <p>HP:${m.stats.hp.toLocaleString()}</p>
                            <p>XP:${m.xp.toLocaleString()}</p>
                        </div>
                    </div>
                    `;
                }).join('');
            } else {
                materialSlot.innerHTML = `<span class="text-gray-500">Chọn nguyên liệu...</span>`;
            }

            // [MODIFIED] Render Info & Button (calculating totals)
            if (target && selectedTruyenCongMaterials.length > 0) {
                let totalCost = 0;
                let totalHpGain = 0;
                let totalAtkGain = 0;
                let totalDefGain = 0;
                let totalSpdGain = 0;
                let totalXpGain = 0; // [NEW] Biến tổng XP

                selectedTruyenCongMaterials.forEach(id => {
                    const m = gameData.disciples.find(d => d.id === id);
                    if (m) {
                        totalCost += m.level * 100000;
                        totalHpGain += Math.floor(m.stats.hp * 0.5);
                        totalAtkGain += Math.floor(m.stats.atk * 0.5);
                        totalDefGain += Math.floor((m.stats.def || 0) * 0.5);
                        totalSpdGain += Math.floor((m.stats.spd || 0) * 0.5);
                        totalXpGain += Math.floor((m.xp || 0) * 0.5); // [NEW] Tính 50% XP hiện có
                    }
                });

                const hasCost = gameData.nganLuong >= totalCost;

                infoEl.innerHTML = `
                    <div class="text-xs bg-black/30 p-2 rounded mb-2">
                        <p class="text-gray-400 mb-1">Sẽ nhận được:</p>
                        <div class="grid grid-cols-2 gap-x-2 font-bold text-green-400">
                            <span>+${totalHpGain.toLocaleString()} HP</span>
                            <span>+${totalAtkGain.toLocaleString()} Công</span>
                            <span>+${totalDefGain.toLocaleString()} Thủ</span>
                            <span>+${totalSpdGain.toLocaleString()} Thân</span>
                            <span class="col-span-2 text-center text-yellow-300 border-t border-gray-600 mt-1 pt-1">+${totalXpGain.toLocaleString()} XP</span>
                        </div>
                    </div>
                    <p class="text-sm ${hasCost ? 'text-gray-300' : 'text-red-400'}">Chi phí: ${totalCost.toLocaleString()} NL</p>
                `;
                
                if (hasCost) {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.disabled = false;
                } else {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.disabled = true;
                }
            } else {
                infoEl.innerHTML = '';
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
            }
        }

        /**
         * Hiển thị tab Truyền Công (Placeholder)
         */
        function renderTruyenCongPanel() {
            const panel = document.getElementById('panel-truyen-cong');
            if (!panel) return;

            const availableDisciples = gameData.disciples.filter(d => d.status === 'Nhàn Rỗi');
            // [MODIFIED] Lọc danh sách mục tiêu: Chỉ lấy đệ tử đã Khóa
            const targetDisciples = availableDisciples.filter(d => d.isLocked);
            
            panel.innerHTML = `
                <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Truyền Công</h4>
                <p class="text-center text-gray-400 mb-4">Chọn tối đa 20 đệ tử (Nguyên Liệu) để truyền 50% chỉ số cơ bản cho 1 đệ tử khác (Mục Tiêu).<br>Đệ tử Nguyên Liệu sẽ <strong class="text-red-400">biến mất</strong>. Cần tiêu hao Ngân Lượng.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Col 1: Nguyên Liệu (Material) List -->
                    <div>
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Chọn Nguyên Liệu (Để hy sinh)</h5>
                        <div id="truyen-cong-material-list" class="space-y-2 bg-gray-900 p-2 rounded h-80 overflow-y-auto scrollbar-thin">
                            ${generateDiscipleListHTML(availableDisciples, 'material')}
                        </div>
                    </div>
                    <!-- Col 2: Info & Button -->
                    <div class="flex flex-col">
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Mục Tiêu (Nhận)</h5>
                        <div id="truyen-cong-target-slot" class="bg-gray-700 rounded p-3 w-full mb-2 text-center h-28 flex items-center justify-center">
                            <span class="text-gray-500">Chọn mục tiêu...</span>
                        </div>
                        <i class="fa-solid fa-arrow-down text-2xl text-red-400 my-2 text-center"></i>
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Nguyên Liệu (Hy sinh)</h5>
                        <!-- [MODIFIED] This is now a scrollable list -->
                        <div id="truyen-cong-material-slot" class="bg-gray-900 rounded p-2 w-full mb-2 text-center h-40 flex-grow overflow-y-auto scrollbar-thin">
                            <span class="text-gray-500">Chọn nguyên liệu...</span>
                        </div>
                        <div id="truyen-cong-info" class="text-center mt-2"></div>
                        <button id="perform-truyen-cong-btn" onclick="confirmTruyenCong()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded mt-4 opacity-50 cursor-not-allowed" disabled>
                            Truyền Công
                        </button>
                    </div>
                    <!-- Col 3: Mục Tiêu (Target) List -->
                    <div>
                        <h5 class="font-bold text-yellow-300 text-center mb-2">Chọn Mục Tiêu (Đệ tử đã Khóa)</h5>
                        <div id="truyen-cong-target-list" class="space-y-2 bg-gray-900 p-2 rounded h-80 overflow-y-auto scrollbar-thin">
                            ${generateDiscipleListHTML(targetDisciples, 'target')}
                        </div>
                    </div>
                </div>
            `;
            
            // Call update slots in case selections were already made
            updateTruyenCongSlots();
        }

        /**
         * [NEW] Helper for renderTruyenCongPanel to generate lists
         */
        function confirmTruyenCong() {
            const target = gameData.disciples.find(d => d.id === selectedTruyenCongTarget);
            
            if (!target || selectedTruyenCongMaterials.length === 0) { // [MODIFIED] Check array length
                showToast("Lỗi: Phải chọn Mục Tiêu và ít nhất 1 Nguyên Liệu!", false);
                return;
            }
            
            // [MODIFIED] Calculate totals from array
            let totalCost = 0;
            let totalHpGain = 0;
            let totalAtkGain = 0;
            let totalDefGain = 0;
            let totalSpdGain = 0;
            let totalXpGain = 0; // [NEW]
            let materialNames = [];

            selectedTruyenCongMaterials.forEach(id => {
                const m = gameData.disciples.find(d => d.id === id);
                if (m) {
                    totalCost += m.level * 100000;
                    totalHpGain += Math.floor(m.stats.hp * 0.5);
                    totalAtkGain += Math.floor(m.stats.atk * 0.5);
                    totalDefGain += Math.floor(m.stats.def * 0.5);
                    totalSpdGain += Math.floor(m.stats.spd * 0.5);
                    totalXpGain += Math.floor((m.xp || 0) * 0.5); // [NEW]
                    materialNames.push(`${m.name} (Cấp ${m.level})`);
                }
            });
            
            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Xác Nhận Truyền Công';
            if (summaryEl) {
                // [MODIFIED] Updated summary message to include XP
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2">Bạn có chắc muốn hy sinh <strong class="text-red-400">${selectedTruyenCongMaterials.length} đệ tử</strong> sau?</p>
                    <ul class="list-disc list-inside ml-4 text-red-300 text-sm max-h-24 overflow-y-auto scrollbar-thin">
                        ${materialNames.map(name => `<li>${name}</li>`).join('')}
                    </ul>
                    <p class="text-gray-300 mb-1 mt-2">Toàn bộ đệ tử này sẽ <strong class="text-red-400">BIẾN MẤT VĨNH VIỄN</strong>.</p>
                    <p class="text-gray-300 mb-1"><strong class="text-green-400">${target.name} (Cấp ${target.level})</strong> sẽ nhận được:</p>
                    <ul class="list-disc list-inside ml-4 text-green-300 text-sm">
                        <li>+${totalHpGain.toLocaleString()} HP</li>
                        <li>+${totalAtkGain.toLocaleString()} Công</li>
                        <li>+${totalDefGain.toLocaleString()} Thủ</li>
                        <li>+${totalSpdGain.toLocaleString()} Thân</li>
                        <li>+${totalXpGain.toLocaleString()} XP</li> <!-- [NEW] -->
                    </ul>
                    <p class="text-lg mt-4 ${gameData.nganLuong < totalCost ? 'text-red-400' : 'text-gray-300'}">Tổng chi phí: ${totalCost.toLocaleString()} Ngân Lượng</p>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button onclick="performTruyenCong()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Xác Nhận</button>
                `;
            }
            
            showModal('dungeon-confirm-modal');
        }

        /**
         * [NEW] Thực hiện Truyền Công
         */
        function performTruyenCong() {
            const target = gameData.disciples.find(d => d.id === selectedTruyenCongTarget);
            
            if (!target || selectedTruyenCongMaterials.length === 0) { // [MODIFIED] Check array length
                showToast("Lỗi: Không tìm thấy đệ tử!", false);
                hideModal('dungeon-confirm-modal');
                return;
            }

            // [MODIFIED] Calculate totals from array
            let totalCost = 0;
            let totalHpGain = 0;
            let totalAtkGain = 0;
            let totalDefGain = 0;
            let totalSpdGain = 0;
            let totalXpGain = 0; // [NEW]
            const materialIds = new Set(selectedTruyenCongMaterials);

            gameData.disciples.forEach(d => {
                if (materialIds.has(d.id)) {
                    totalCost += d.level * 100000;
                    totalHpGain += Math.floor(d.stats.hp * 0.5);
                    totalAtkGain += Math.floor(d.stats.atk * 0.5);
                    totalDefGain += Math.floor(d.stats.def * 0.5);
                    totalSpdGain += Math.floor(d.stats.spd * 0.5);
                    totalXpGain += Math.floor((d.xp || 0) * 0.5); // [NEW]
                }
            });
            
            if (gameData.nganLuong < totalCost) {
                showToast("Không đủ Ngân Lượng!", false);
                hideModal('dungeon-confirm-modal');
                return;
            }

            // 1. Calculate and Add Stats
            target.stats.hp += totalHpGain;
            target.stats.atk += totalAtkGain;
            target.stats.def += totalDefGain;
            target.stats.spd += totalSpdGain;

            // [NEW] Add XP (and handle level up)
            if (totalXpGain > 0) {
                addDiscipleXp(target.id, totalXpGain);
            }

            // 2. Subtract Cost
            gameData.nganLuong -= totalCost;

            // 3. Remove Material Disciples
            const materialCount = selectedTruyenCongMaterials.length; // [MODIFIED] Get count
            gameData.disciples = gameData.disciples.filter(d => !materialIds.has(d.id)); // [MODIFIED] Filter by Set
            
            // 4. Log and Toast
            const logMsg = `Hy sinh ${materialCount} đệ tử để truyền công cho ${target.name}. Nhận ${totalXpGain.toLocaleString()} XP và chỉ số!`; // [MODIFIED]
            addSectLog(logMsg, 'reward');
            showToast(logMsg, true);

            // 5. Reset UI
            hideModal('dungeon-confirm-modal');
            selectedTruyenCongTarget = null;
            selectedTruyenCongMaterials = []; // [MODIFIED] Reset array
            renderTruyenCongPanel(); // Re-render the tab
            updateUI(); // Update main UI currency
            // Re-render disciple list if open (to show updated stats for target)
            if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                renderDiscipleList();
            }
        }
        // [END NEW] --- Truyền Công Functions ---

        // [NEW] --- Hôn Phối Functions ---
        /**
         * Hiển thị tab Hôn Phối (Placeholder)
         */
        function renderHonPhoiPanel() {
            const panel = document.getElementById('panel-hon-phoi');
            if (!panel) return;
            // Hiện tại chỉ là placeholder, nội dung đã có trong HTML
        }
        // [END NEW] --- Hôn Phối Functions ---
        /**
         * Hiển thị tab Hôn Phối (Placeholder)
         */
        function renderHonPhoiPanel() {
            const panel = document.getElementById('panel-hon-phoi');
            if (!panel) return;

            // [MODIFIED] Constants moved to SONG_TU_DB
            // const SONG_TU_COST_LINH_THACH = 100;
            // const SONG_TU_REWARD_XP = 500000;
            // const SONG_TU_DURATION_MS = 1 * 60 * 60 * 1000; // 1 giờ
            const now = Date.now();

            // 1. Render Selection Area
            const idleDisciples = gameData.disciples.filter(d => d.status === 'Nhàn Rỗi');
            let optionsHtml = '<option value="">Chọn đệ tử...</option>';
            if (idleDisciples.length > 0) {
                optionsHtml += idleDisciples.map(d => `<option value="${d.id}">${d.name} (Cấp ${d.level})</option>`).join('');
            } else {
                optionsHtml = '<option value="" disabled>Không có đệ tử rảnh rỗi</option>';
            }

            let html = `
                <h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Song Tu</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Column 1: Selection -->
                    <div class="md:col-span-1 bg-gray-700 p-4 rounded-lg">
                        <h5 class="font-bold text-yellow-300 text-center mb-3">Bắt Đầu Song Tu</h5>
                        <p class="text-xs text-gray-300 mb-3 text-center">Chọn 2 đệ tử nhàn rỗi để bắt đầu song tu. Không yêu cầu giới tính.</p>
                        
                        <label for="hon-phoi-d1" class="text-sm text-gray-300 mb-1 block">Đệ tử 1:</label>
                        <select id="hon-phoi-d1" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-full mb-3">
                            ${optionsHtml}
                        </select>
                        
                        <label for="hon-phoi-d2" class="text-sm text-gray-300 mb-1 block">Đệ tử 2:</label>
                        <select id="hon-phoi-d2" class="bg-gray-800 border border-gray-600 rounded p-2 text-white w-full mb-4">
                            ${optionsHtml}
                        </select>

                        <!-- [MODIFIED] Render Tiers -->
                        <div class="space-y-3">
            `;
            
            Object.values(SONG_TU_DB).forEach(tier => {
                const canAfford = gameData.linhThach >= tier.costLinhThach;
                const canStart = idleDisciples.length >= 2 && canAfford;
                html += `
                    <div class="bg-gray-800 p-3 rounded">
                        <p class="font-bold text-yellow-300">${tier.name}</p>
                        <p class="text-xs text-gray-300">Y/c Cấp (TB): ${tier.levelReq}</p>
                        <p class="text-xs text-gray-300">Thời gian: ${formatTime(tier.durationMs)}</p>
                        <p class="text-xs text-gray-300">Thưởng: ${tier.rewardXp.toLocaleString()} XP (mỗi đệ tử)</p>
                        <p class="text-xs ${canAfford ? 'text-green-300' : 'text-red-400'}">Chi phí: ${tier.costLinhThach} Linh Thạch</p>
                        <button onclick="startSongTu('${tier.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-sm mt-2 ${!canStart ? 'opacity-50 cursor-not-allowed' : ''}" ${!canStart ? 'disabled' : ''}>
                            Bắt Đầu
                        </button>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>

                    <!-- Column 2: Active Pairs -->
                    <div class="md:col-span-2">
                        <h5 class="font-bold text-yellow-300 text-center mb-3">Các Cặp Đang Song Tu</h5>
                        <div id="song-tu-active-list" class="space-y-3" style="max-height: 60vh; overflow-y: auto;">
            `;

            // 2. Render Active Pairs List
            const activePairs = gameData.sect.songTuPairs || [];
            if (activePairs.length === 0) {
                html += `<p class="text-center text-gray-500">Chưa có cặp nào đang song tu.</p>`;
            } else {
                activePairs.forEach(pair => {
                    const d1 = gameData.disciples.find(d => d.id === pair.d1Id);
                    const d2 = gameData.disciples.find(d => d.id === pair.d2Id);
                    
                    const d1Name = d1 ? `${d1.name} (Cấp ${d1.level})` : 'Đã rời đi';
                    const d2Name = d2 ? `${d2.name} (Cấp ${d2.level})` : 'Đã rời đi';
                    
                    const remainingMs = Math.max(0, pair.completionTime - now);
                    let buttonHtml = '';
                    if (remainingMs > 0) {
                        buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed">Còn ${formatTime(remainingMs)}</button>`;
                    } else {
                        buttonHtml = `<button onclick="completeSongTu('${pair.id}')" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded">Hoàn Thành</button>`;
                    }

                    html += `
                    <div class="bg-gray-700 p-3 rounded shadow flex justify-between items-center">
                        <div>
                            <p class="font-bold text-base text-pink-300">${d1Name}</p>
                            <p class="text-center text-sm text-red-300">&</p>
                            <p class="font-bold text-base text-pink-300">${d2Name}</p>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            ${buttonHtml}
                        </div>
                    </div>
                    `;
                });
            }

            html += `
                        </div>
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
        }

        /**
         * [NEW] Bắt đầu Song Tu cho 2 đệ tử
         */
        function startSongTu(tierId) {
            const tier = SONG_TU_DB[tierId];
            if (!tier) {
                showToast("Lỗi: Cấp bậc song tu không hợp lệ!", false); return;
            }

            const d1Id = document.getElementById('hon-phoi-d1').value;
            const d2Id = document.getElementById('hon-phoi-d2').value;

            if (!d1Id || !d2Id) {
                showToast("Phải chọn 2 đệ tử!", false); return;
            }
            if (d1Id === d2Id) {
                showToast("Không thể song tu với chính mình!", false); return;
            }

            const COST = tier.costLinhThach;
            const DURATION = tier.durationMs;
            const REWARD_XP = tier.rewardXp;
            const LEVEL_REQ = tier.levelReq;

            if (gameData.linhThach < COST) {
                showToast(`Không đủ ${COST} Linh Thạch!`, false); return;
            }

            const d1 = gameData.disciples.find(d => d.id === d1Id);
            const d2 = gameData.disciples.find(d => d.id === d2Id);

            if (!d1 || !d2) {
                showToast("Lỗi: Không tìm thấy đệ tử!", false); return;
            }
            if (d1.status !== 'Nhàn Rỗi' || d2.status !== 'Nhàn Rỗi') {
                showToast("Cả hai đệ tử phải đang 'Nhàn Rỗi'!", false); return;
            }

            // [NEW] Check average level
            const avgLevel = (d1.level + d2.level) / 2;
            if (avgLevel < LEVEL_REQ) {
                showToast(`Cấp độ trung bình của 2 đệ tử phải đạt ${LEVEL_REQ} để ${tier.name}!`, false);
                return;
            }

            // 1. Trừ chi phí
            gameData.linhThach -= COST;

            // 2. Cập nhật trạng thái
            d1.status = 'Đang Song Tu';
            d2.status = 'Đang Song Tu';

            // 3. Thêm vào danh sách active
            const newPair = {
                id: crypto.randomUUID(),
                d1Id: d1Id,
                d2Id: d2Id,
                completionTime: Date.now() + DURATION,
                rewardXp: REWARD_XP // [NEW] Store the reward
            };
            gameData.sect.songTuPairs.push(newPair);

            addSectLog(`${d1.name} và ${d2.name} bắt đầu ${tier.name}.`, 'system');
            showToast(`${d1.name} và ${d2.name} bắt đầu song tu!`, true);

            // 4. Cập nhật UI
            renderHonPhoiPanel();
            updateUI(); // Cập nhật Linh Thạch
            // Cập nhật tab Bồi Dưỡng nếu đang mở
            if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                renderDiscipleList();
            }
        }

        /**
         * [NEW] Hoàn thành Song Tu
         */
        function completeSongTu(pairId) {
            const pairIndex = gameData.sect.songTuPairs.findIndex(p => p.id === pairId);
            if (pairIndex === -1) {
                showToast("Lỗi: Không tìm thấy cặp song tu!", false); return;
            }
            
            const pair = gameData.sect.songTuPairs[pairIndex];

            if (Date.now() < pair.completionTime) {
                showToast("Song tu chưa hoàn thành!", false); return;
            }

            const d1 = gameData.disciples.find(d => d.id === pair.d1Id);
            const d2 = gameData.disciples.find(d => d.id === pair.d2Id);
            const REWARD_XP = pair.rewardXp || 500000; // [MODIFIED] Read reward from pair, fallback to old value
            let d1Name = "Đệ tử 1";
            let d2Name = "Đệ tử 2";

            if (d1) {
                d1Name = d1.name;
                addDiscipleXp(d1.id, REWARD_XP);
                d1.status = 'Nhàn Rỗi';
            }
            if (d2) {
                d2Name = d2.name;
                addDiscipleXp(d2.id, REWARD_XP);
                d2.status = 'Nhàn Rỗi';
            }

            const msg = `${d1Name} và ${d2Name} đã hoàn thành song tu, cả hai nhận ${REWARD_XP.toLocaleString()} XP!`;
            addSectLog(msg, 'reward');
            showToast(msg, true);
            
            // Cập nhật UI
            renderHonPhoiPanel();
            // Cập nhật tab Bồi Dưỡng nếu đang mở
            if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                renderDiscipleList();
            }
        }
        // [END NEW] --- Hôn Phối Functions ---

        // [NEW] --- Sect Shop Functions ---
        function renderSectShop() {
            const listContainer = document.getElementById('sect-shop-list');
            const dchDisplay = document.getElementById('sect-shop-dch-display');
            if (!listContainer || !dchDisplay) return;

            const currentDCH = gameData.diemCongHien || 0;
            const currentLT = gameData.linhThach || 0;

            // [MODIFIED] Hiển thị cả ĐCH và Linh Thạch
            dchDisplay.innerHTML = `
                <span class="mr-3">ĐCH: <span class="font-bold text-lime-400">${currentDCH.toLocaleString()}</span></span>
                <span>Linh Thạch: <span class="font-bold text-green-400">${currentLT.toLocaleString()}</span></span>
            `;

            let html = '';
            const shopItems = Object.keys(SECT_SHOP_DB);

            if (shopItems.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400">Cửa hàng Tông Môn chưa có vật phẩm nào.</p>';
                return;
            }

            shopItems.forEach(buyId => {
                const shopItem = SECT_SHOP_DB[buyId];
                const itemDB = STATIC_ITEM_DB[shopItem.itemId];
                if (!itemDB) return; // Skip if item doesn't exist

                const owned = gameData.items[shopItem.itemId] || 0;
                
                // [MODIFIED] Xác định loại tiền tệ và kiểm tra số dư
                let currencyName = 'ĐCH';
                let currencyColor = 'text-lime-300';
                let playerBalance = currentDCH;
                
                if (shopItem.currency === 'linhThach') {
                    currencyName = 'Linh Thạch';
                    currencyColor = 'text-green-300';
                    playerBalance = currentLT;
                }
                
                const canAfford = playerBalance >= shopItem.cost;
                const canAfford10 = playerBalance >= (shopItem.cost * 10);

                html += `
                <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-grow">
                        <p class="font-bold text-sm ${getRarityClass(itemDB.rarity)}">${itemDB.name} (Đang có: ${owned})</p>
                        <p class="text-xs text-gray-300 mt-1">${itemDB.desc}</p>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                        <button onclick="buySectShopItem('${buyId}', 1)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-1/2 sm:w-auto ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                            Mua 1 (<span class="font-bold ${currencyColor}">${shopItem.cost} ${currencyName}</span>)
                        </button>
                        <button onclick="buySectShopItem('${buyId}', 10)" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-1/2 sm:w-auto ${!canAfford10 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford10 ? 'disabled' : ''}>
                            Mua 10 (<span class="font-bold ${currencyColor}">${shopItem.cost * 10}</span>)
                        </button>
                    </div>
                </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        function buySectShopItem(buyId, amount) {
            const shopItem = SECT_SHOP_DB[buyId];
            if (!shopItem) {
                showToast("Vật phẩm này không thể mua!", false); return;
            }

            const itemDB = STATIC_ITEM_DB[shopItem.itemId];
            if (!itemDB) {
                showToast("Lỗi: Không tìm thấy vật phẩm!", false); return;
            }

            const totalCost = shopItem.cost * amount;
            
            // [MODIFIED] Kiểm tra và trừ đúng loại tiền tệ
            let currencyName = 'ĐCH';
            if (shopItem.currency === 'linhThach') {
                if ((gameData.linhThach || 0) < totalCost) {
                    showToast("Không đủ Linh Thạch!", false); return;
                }
                gameData.linhThach -= totalCost;
                currencyName = 'Linh Thạch';
            } else {
                if ((gameData.diemCongHien || 0) < totalCost) {
                    showToast("Không đủ Điểm Cống Hiến!", false); return;
                }
                gameData.diemCongHien -= totalCost;
            }

            const currentAmount = gameData.items[shopItem.itemId] || 0;
            if (currentAmount + amount > MAX_STACK_SIZE) {
                showToast(`Không thể mua thêm, vượt quá ${MAX_STACK_SIZE} vật phẩm!`, false); return;
            }

            // Process transaction
            gameData.items[shopItem.itemId] = currentAmount + amount;

            showToast(`Đã mua ${itemDB.name} x${amount} với ${totalCost.toLocaleString()} ${currencyName}.`, true);

            // Re-render shop list
            renderSectShop();
            
            // Update main UI (update linhThach/DCH on main screen)
            updateUI();
            
            // Re-render other relevant modals
            if (!document.getElementById('equipment-modal').classList.contains('hidden')) {
                renderModalContent('equipment-modal');
            }
            // If boost modal is open, refresh it to show new pill count
            if (currentBoostingDiscipleId) {
                renderBoostDiscipleModal(currentBoostingDiscipleId);
            }
        }
        // [END NEW] --- Sect Shop Functions ---

        // [NEW] --- Sect Warehouse Functions ---

        /**
         * [NEW] Hàm helper để render danh sách vật phẩm cho kho/hành trang
         */
        function renderWarehouseList(containerId, data, type, action) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            
            // 1. Render Materials
            const materials = data.materials || {};
            const materialKeys = Object.keys(materials);
            html += `<h6 class="font-bold text-gray-300 text-sm mb-2 border-b border-gray-600 pb-1">Nguyên Liệu (${materialKeys.length})</h6>`;
            if (materialKeys.length > 0) {
                materialKeys.sort((a,b) => MATERIALS_DB[a].rarity - MATERIALS_DB[b].rarity);
                materialKeys.forEach(id => {
                    const itemDB = MATERIALS_DB[id];
                    const owned = materials[id];
                    if (owned > 0) {
                        html += `
                        <div class="bg-gray-700 p-2 rounded flex justify-between items-center text-xs">
                            <div>
                                <p class="${getRarityClass(itemDB.rarity)}">${itemDB.name}</p>
                                <p class="text-gray-300">Số lượng: ${owned.toLocaleString()}</p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="${action}('material', '${id}', 1)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-1 rounded text-xs" title="1">1</button>
                                <button onclick="${action}('material', '${id}', 100)" class="bg-blue-700 hover:bg-blue-800 text-white font-bold p-1 rounded text-xs" title="100">100</button>
                                <button onclick="${action}('material', '${id}', 'all')" class="bg-blue-800 hover:bg-blue-900 text-white font-bold p-1 rounded text-xs" title="Tất cả">All</button>
                            </div>
                        </div>`;
                    }
                });
            } else {
                html += `<p class="text-xs text-gray-500 text-center">Trống</p>`;
            }

            // 2. Render Items (Potions, etc.)
            const items = data.items || {};
            const itemKeys = Object.keys(items);
            html += `<h6 class="font-bold text-gray-300 text-sm mt-4 mb-2 border-b border-gray-600 pb-1">Tiêu Hao (${itemKeys.length})</h6>`;
            if (itemKeys.length > 0) {
                itemKeys.sort((a,b) => STATIC_ITEM_DB[a].rarity - STATIC_ITEM_DB[b].rarity);
                itemKeys.forEach(id => {
                    const itemDB = STATIC_ITEM_DB[id];
                    const owned = items[id];
                    if (owned > 0) {
                        html += `
                        <div class="bg-gray-700 p-2 rounded flex justify-between items-center text-xs">
                            <div>
                                <p class="${getRarityClass(itemDB.rarity)}">${itemDB.name}</p>
                                <p class="text-gray-300">Số lượng: ${owned.toLocaleString()}</p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="${action}('item', '${id}', 1)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-1 rounded text-xs" title="1">1</button>
                                <button onclick="${action}('item', '${id}', 10)" class="bg-blue-700 hover:bg-blue-800 text-white font-bold p-1 rounded text-xs" title="10">10</button>
                                <button onclick="${action}('item', '${id}', 'all')" class="bg-blue-800 hover:bg-blue-900 text-white font-bold p-1 rounded text-xs" title="Tất cả">All</button>
                            </div>
                        </div>`;
                    }
                });
            } else {
                html += `<p class="text-xs text-gray-500 text-center">Trống</p>`;
            }

            // 3. Render Gear
            const gear = data.gear || [];
            // Filter out equipped gear for player display
            const allEquippedIds = (action === 'depositToWarehouse') ? Object.values(gameData.equippedSlots) : [];
            const displayGear = gear.filter(item => !allEquippedIds.includes(item.uniqueId));

            html += `<h6 class="font-bold text-gray-300 text-sm mt-4 mb-2 border-b border-gray-600 pb-1">Trang Bị (${displayGear.length})</h6>`;
            if (displayGear.length > 0) {
                displayGear.sort((a,b) => (Object.keys(QUALITY_DB).indexOf(b.quality)) - (Object.keys(QUALITY_DB).indexOf(a.quality)));
                displayGear.forEach(item => {
                    const quality = QUALITY_DB[item.quality];
                    const upgradeText = item.upgradeLevel > 0 ? ` <span class="text-yellow-300">[+${item.upgradeLevel}]</span>` : '';
                    html += `
                    <div class="bg-gray-700 p-2 rounded flex justify-between items-center text-xs">
                        <div>
                            <p class="${quality.className}">${item.name}${upgradeText}</p>
                            <p class="text-xs" style="color: ${quality.color};">[Cấp ${item.level}]</p>
                        </div>
                        <button onclick="${action}('gear', '${item.uniqueId}', 1)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-1 px-2 rounded text-xs">Gửi/Rút</button>
                    </div>`;
                });
            } else {
                html += `<p class="text-xs text-gray-500 text-center">Trống</p>`;
            }

            container.innerHTML = html;
        }

        /**
         * [NEW] Hiển thị nội dung kho và hành trang
         */
        function renderSectWarehouse() {
            // Render Kho
            renderWarehouseList('sect-warehouse-display', gameData.sect.warehouse, 'warehouse', 'withdrawFromWarehouse');
            // Render Hành trang cá nhân (dùng một object tạm để khớp format)
            const playerData = {
                materials: gameData.materials,
                items: gameData.items,
                gear: gameData.gearInventory
            };
            renderWarehouseList('player-inventory-display-for-sect', playerData, 'player', 'depositToWarehouse');
        }

        /**
         * [NEW] Gửi vật phẩm vào kho
         */
        function depositToWarehouse(itemType, itemId, amount) {
            let sourceInv, destInv, itemDB, ownedAmount;

            if (itemType === 'material') {
                sourceInv = gameData.materials;
                destInv = gameData.sect.warehouse.materials;
                itemDB = MATERIALS_DB[itemId];
            } else if (itemType === 'item') {
                sourceInv = gameData.items;
                destInv = gameData.sect.warehouse.items;
                itemDB = STATIC_ITEM_DB[itemId];
            } else if (itemType === 'gear') {
                const itemIndex = gameData.gearInventory.findIndex(i => i.uniqueId === itemId);
                if (itemIndex === -1) {
                    showToast("Lỗi: Không tìm thấy trang bị!", false); return;
                }
                const item = gameData.gearInventory[itemIndex];
                gameData.sect.warehouse.gear.push(item);
                gameData.gearInventory.splice(itemIndex, 1);
                
                showToast(`Đã gửi ${item.name} vào kho.`, true);
                renderSectWarehouse();
                return;
            } else { return; }

            ownedAmount = sourceInv[itemId] || 0;
            let amountToMove = 0;
            if (amount === 'all') {
                amountToMove = ownedAmount;
            } else {
                amountToMove = parseInt(amount, 10);
                if (amountToMove > ownedAmount) amountToMove = ownedAmount;
            }

            if (amountToMove <= 0) {
                showToast(`Không có ${itemDB.name} để gửi.`, false); return;
            }

            // Move
            sourceInv[itemId] -= amountToMove;
            destInv[itemId] = (destInv[itemId] || 0) + amountToMove;
            if (sourceInv[itemId] <= 0) delete sourceInv[itemId];

            showToast(`Đã gửi ${itemDB.name} x${amountToMove.toLocaleString()} vào kho.`, true);
            renderSectWarehouse();
        }

        /**
         * [NEW] Rút vật phẩm khỏi kho
         */
        function withdrawFromWarehouse(itemType, itemId, amount) {
            let sourceInv, destInv, itemDB, ownedAmount;

            if (itemType === 'material') {
                sourceInv = gameData.sect.warehouse.materials;
                destInv = gameData.materials;
                itemDB = MATERIALS_DB[itemId];
            } else if (itemType === 'item') {
                sourceInv = gameData.sect.warehouse.items;
                destInv = gameData.items;
                itemDB = STATIC_ITEM_DB[itemId];
            } else if (itemType === 'gear') {
                if (countInventorySlots() >= MAX_INVENTORY_SLOTS) {
                    showToast("Hành trang cá nhân đã đầy!", false); return;
                }
                const itemIndex = gameData.sect.warehouse.gear.findIndex(i => i.uniqueId === itemId);
                if (itemIndex === -1) {
                    showToast("Lỗi: Không tìm thấy trang bị trong kho!", false); return;
                }
                const item = gameData.sect.warehouse.gear[itemIndex];
                gameData.gearInventory.push(item);
                gameData.sect.warehouse.gear.splice(itemIndex, 1);
                
                showToast(`Đã rút ${item.name} về hành trang.`, true);
                renderSectWarehouse();
                return;
            } else { return; }

            ownedAmount = sourceInv[itemId] || 0;
            let amountToMove = 0;
            if (amount === 'all') {
                amountToMove = ownedAmount;
            } else {
                amountToMove = parseInt(amount, 10);
                if (amountToMove > ownedAmount) amountToMove = ownedAmount;
            }

            if (amountToMove <= 0) {
                showToast(`Không có ${itemDB.name} trong kho.`, false); return;
            }

            // Check stack size for items (not materials, assume infinite)
            if (itemType === 'item') {
                const currentOwned = destInv[itemId] || 0;
                if (currentOwned + amountToMove > MAX_STACK_SIZE) {
                    showToast(`Không thể rút, vượt quá ${MAX_STACK_SIZE} vật phẩm!`, false); return;
                }
            }

            // Move
            sourceInv[itemId] -= amountToMove;
            destInv[itemId] = (destInv[itemId] || 0) + amountToMove;
            if (sourceInv[itemId] <= 0) delete sourceInv[itemId];

            showToast(`Đã rút ${itemDB.name} x${amountToMove.toLocaleString()} về hành trang.`, true);
            renderSectWarehouse();
        }

        // [END NEW] --- Sect Warehouse Functions ---

        // --- END Tong Mon Functions ---

        // [REMOVED] --- Luyện Đan Functions (Deleted) ---
        // [REMOVED] function renderLuyenDanPanel() { ... }

        // [NEW] --- Động Phủ Functions (Placeholder) ---
        /**
         * [NEW] Tính toán chỉ số của một công trình Động Phủ
         */
        function getDongPhuBuildingStats(buildingDB, level) {
            if (level === 0) {
                return { level: 0, rate: 0, capacity: 0, nextCost: buildingDB.cost };
            }
            
            const rate = Math.floor(buildingDB.baseRate * Math.pow(buildingDB.rateMultiplier, level - 1));
            const capacity = Math.floor(buildingDB.baseCapacity * Math.pow(buildingDB.capacityMultiplier, level - 1));
            
            const nextCostNL = Math.floor(buildingDB.cost.nl * Math.pow(buildingDB.costMultiplier, level));
            const nextCostDCH = Math.floor(buildingDB.cost.dch * Math.pow(buildingDB.costMultiplier, level));
            
            return {
                level: level,
                rate: rate,
                capacity: capacity,
                nextCost: { nl: nextCostNL, dch: nextCostDCH }
            };
        }
        
        /**
         * [NEW] Tính toán tài nguyên Động Phủ được tạo ra (offline/afk)
         */
        function updateDongPhuGeneration() {
            if (!gameData || !gameData.sect || !gameData.sect.dongPhu) return;

            const now = Date.now();
            
            for (const buildingId in gameData.sect.dongPhu) {
                const bData = gameData.sect.dongPhu[buildingId];
                // [FIX] Kiểm tra an toàn nếu buildingId không có trong DB (ví dụ key rác)
                const bDB = DONG_PHU_DB[buildingId];
                if (!bDB) continue; 
                
                // [MODIFIED] Thêm kiểm tra ID cho Dược Viên và Khoáng Trường
                if (bData.level > 0 && (
                    bDB.id.startsWith('linh_dien') || 
                    bDB.id.startsWith('tu_luyen_dai') || 
                    bDB.id.startsWith('luyen_dan_phong') || 
                    bDB.id.startsWith('luyen_khi_cac') ||
                    bDB.id.startsWith('duoc_vien') || // [NEW]
                    bDB.id.startsWith('khoang_truong') // [NEW]
                )) { 
                    const lastUpdate = bData.lastUpdateTime || now;
                    const timePassedMs = now - lastUpdate;
                    
                    if (timePassedMs > 0) {
                         const stats = getDongPhuBuildingStats(bDB, bData.level);
                         const { generated, isCapped } = calculateDongPhuGeneration(bData, bDB, timePassedMs);
                         
                         let currentVal = bData.current || 0;
                         if (isCapped) {
                             bData.current = stats.capacity;
                         } else {
                             bData.current = currentVal + generated; 
                         }
                    }
                }
                bData.lastUpdateTime = now; // Luôn cập nhật thời gian
            }
        }
        
        /**
         * [NEW] Helper for calculating generation
         */
        function calculateDongPhuGeneration(bData, bDB, timePassedMs) {
             const stats = getDongPhuBuildingStats(bDB, bData.level);
             const ratePerHour = stats.rate;
             const capacity = stats.capacity;
             
             const hoursPassed = timePassedMs / 3600000;
             const generated = hoursPassed * ratePerHour;
             
             const newTotal = (bData.current || 0) + generated;
             const isCapped = newTotal >= capacity;
             
             // [MODIFIED] Fix calculation for isCapped
             if (isCapped) {
                 return { generated: Math.max(0, capacity - (bData.current || 0)), isCapped: true };
             } else {
                 return { generated: generated, isCapped: false };
             }
        }

        /**
         * Hiển thị tab Động Phủ (Placeholder)
         */
        function renderDongPhuPanel() {
            const panel = document.getElementById('panel-dong-phu');
            if (!panel) return;
            
            updateDongPhuGeneration(); // Cập nhật tích lũy Động Phủ
            updateLinhTriGeneration(); // [NEW] Cập nhật tích lũy Linh Trì

            let html = `<h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Động Phủ Tông Môn</h4>`;
            html += `<p class="text-center text-gray-400 mb-4 text-sm">Xây dựng và nâng cấp các công trình để sản xuất tài nguyên.</p>`;
            
            // [MODIFIED] Hiển thị Tổng quan tài nguyên
            html += `
                <div class="flex justify-center gap-4 mb-4 text-sm font-bold">
                     <p class="text-green-300 bg-gray-800 px-3 py-1 rounded border border-green-600">Linh Thạch: ${gameData.linhThach.toLocaleString()}</p>
                     <p class="text-purple-300 bg-gray-800 px-3 py-1 rounded border border-purple-600">Linh Khí: ${gameData.linhKhi.toLocaleString()}</p>
                </div>
            `;
            
            // [NEW] Daily Tien Luc Claim
            html += `<div id="tien-luc-claim-section" class="bg-gray-900 p-4 rounded-lg mb-4 text-center max-w-md mx-auto">
                        <!-- Content will be rendered by renderTienLucClaim() -->
                     </div>`;
            
            // [NEW] Nút Thu Hoạch Nhanh
            html += `
                <div class="text-center mb-6">
                    <button onclick="collectAllDongPhuResources()" class="bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-2 px-6 rounded-full shadow-lg transition transform hover:scale-105 border border-yellow-400/50 flex items-center justify-center mx-auto gap-2">
                        <i class="fa-solid fa-hand-holding-dollar text-lg"></i>
                        <span>Thu Hoạch Nhanh Tất Cả</span>
                    </button>
                </div>
            `;

            // [MODIFIED] Grid cols 3 -> 4
            html += `<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">`; 

            // --- [NEW] RENDER LINH TRÌ (Special Building) ---
            const linhTri = gameData.sect.linhTri;
            const ltLevelData = LINH_TRI_DB[linhTri.level];
            const currentLtAmount = Math.floor(linhTri.currentLinhKhi);
            const ltCapacity = ltLevelData.capacity;
            const ltPercent = Math.min(100, (currentLtAmount / ltCapacity) * 100);
            
            let ltBtnHtml = '';
            if (ltLevelData.max) {
                ltBtnHtml = `<button class="w-full bg-gray-600 text-white font-bold py-2 px-3 rounded text-sm opacity-50 cursor-not-allowed">Max</button>`;
            } else {
                const nextLtData = LINH_TRI_DB[linhTri.level + 1]; // Data cấp tiếp theo (để tính stats nếu muốn, nhưng chi phí ở level hiện tại)
                // Lưu ý: Logic cũ dùng levelData để lấy cost
                const canAffordNL = gameData.nganLuong >= ltLevelData.costNL;
                const canAffordDCH = gameData.diemCongHien >= ltLevelData.costDCH;
                const canAfford = canAffordNL && canAffordDCH;
                
                ltBtnHtml = `
                    <div class="text-[10px] text-gray-400 mb-2 text-center">
                        <p>Phí nâng cấp:</p>
                        <p class="${canAffordNL ? 'text-gray-300' : 'text-red-400'}">${ltLevelData.costNL.toLocaleString()} NL</p>
                        <p class="${canAffordDCH ? 'text-gray-300' : 'text-red-400'}">${ltLevelData.costDCH.toLocaleString()} ĐCH</p>
                    </div>
                    <button onclick="nangCapLinhTri()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-sm ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        Nâng Cấp
                    </button>
                `;
            }

            // Thêm thẻ Linh Trì vào đầu danh sách
            html += `
            <div class="bg-gray-800 border border-purple-500/50 p-4 rounded-lg flex flex-col shadow-lg shadow-purple-500/10">
                <div class="flex-grow">
                    <p class="text-center"><i class="fa-solid fa-spa text-4xl text-purple-400 animate-pulse"></i></p>
                    <h5 class="font-bold text-xl text-purple-300 text-center mt-2">Linh Trì (Cấp ${linhTri.level})</h5>
                    <p class="text-sm text-gray-400 text-center mt-1 h-8 overflow-hidden">Tụ tập linh khí thiên địa.</p>
                    
                    <div class="mt-2">
                        <p class="text-xs text-gray-400 text-center">Sản lượng: <span class="text-white">${ltLevelData.ratePerHour.toLocaleString()} / giờ</span></p>
                        <!-- Tích lũy Progress Bar -->
                        <p class="text-xs text-purple-300 mb-1 text-center mt-2 font-bold">Linh Khí Tích Lũy</p>
                        <div class="tuvi-bar-container mb-2" style="height: 1rem;">
                            <div class="tuvi-bar-fill bg-purple-600" style="width: ${ltPercent}%;"></div>
                            <div class="tuvi-bar-text" style="font-size: 0.7rem;">${currentLtAmount.toLocaleString()} / ${ltCapacity.toLocaleString()}</div>
                        </div>
                        <button onclick="thuHoachLinhKhi()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded text-sm ${currentLtAmount < 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentLtAmount < 1 ? 'disabled' : ''}>
                            Thu Hoạch
                        </button>
                    </div>
                </div>
                <div class="mt-4 border-t border-gray-600 pt-3">
                    ${ltBtnHtml}
                </div>
            </div>
            `;
            
            // --- RENDER CÁC CÔNG TRÌNH KHÁC ---
            for (const buildingId in DONG_PHU_DB) {
                const bDB = DONG_PHU_DB[buildingId];
                // [FIX] An toàn: Nếu gameData chưa có key này thì tạo tạm để không crash, nhưng tốt nhất là loadGame đã xử lý rồi.
                let bData = gameData.sect.dongPhu[buildingId];
                if (!bData) {
                    bData = { level: 0, current: 0, lastUpdateTime: Date.now() };
                    gameData.sect.dongPhu[buildingId] = bData;
                }

                const stats = getDongPhuBuildingStats(bDB, bData.level);
                
                const currentAmount = Math.floor(bData.current);
                const capacity = stats.capacity;
                const percentFull = (capacity > 0) ? Math.min(100, (currentAmount / capacity) * 100) : 0;
                
                let actionButtonHtml = '';
                // ... (Logic render nút bấm giữ nguyên) ...
                if (bData.level === 0) {
                    const canAfford = (gameData.nganLuong >= stats.nextCost.nl) && (gameData.diemCongHien >= stats.nextCost.dch);
                    actionButtonHtml = `
                        <div class="text-[10px] text-gray-400 mb-2 text-center">
                            <p>Phí xây dựng:</p>
                            <p class="${gameData.nganLuong >= stats.nextCost.nl ? 'text-gray-300' : 'text-red-400'}">${stats.nextCost.nl.toLocaleString()} NL</p>
                            <p class="${gameData.diemCongHien >= stats.nextCost.dch ? 'text-gray-300' : 'text-red-400'}">${stats.nextCost.dch.toLocaleString()} ĐCH</p>
                        </div>
                        <button onclick="upgradeDongPhuBuilding('${bDB.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                            Xây Dựng
                        </button>
                    `;
                } else {
                     const canAfford = (gameData.nganLuong >= stats.nextCost.nl) && (gameData.diemCongHien >= stats.nextCost.dch);
                     actionButtonHtml = `
                        <div class="text-[10px] text-gray-400 mb-2 text-center">
                            <p>Phí nâng cấp:</p>
                            <p class="${gameData.nganLuong >= stats.nextCost.nl ? 'text-gray-300' : 'text-red-400'}">${stats.nextCost.nl.toLocaleString()} NL</p>
                            <p class="${gameData.diemCongHien >= stats.nextCost.dch ? 'text-gray-300' : 'text-red-400'}">${stats.nextCost.dch.toLocaleString()} ĐCH</p>
                        </div>
                        <button onclick="upgradeDongPhuBuilding('${bDB.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-sm ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                            Nâng Cấp
                        </button>
                    `;
                }
                
                // Check which resource to show
                let resourceName = "Tích Lũy";
                let resourceBarClass = "bg-gray-500";
                let iconColorClass = "text-cyan-300"; // Default color
                
                // [MODIFIED] Logic hiển thị màu sắc cho các loại Linh Điền
                if (bDB.id === 'linh_dien') {
                    resourceName = "Linh Thạch";
                    resourceBarClass = "bg-green-500";
                    iconColorClass = "text-green-300"; // Sơ cấp: Xanh lá
                } else if (bDB.id === 'linh_dien_trung_cap') { 
                     resourceName = "Linh Thạch";
                     resourceBarClass = "bg-green-500";
                     iconColorClass = "text-blue-400"; // Trung cấp: Xanh dương
                } else if (bDB.id === 'linh_dien_cao_cap') { 
                     resourceName = "Linh Thạch";
                     resourceBarClass = "bg-green-500";
                     iconColorClass = "text-purple-400"; // Cao cấp: Tím
                } else if (bDB.id === 'linh_dien_sieu_cap') { 
                     resourceName = "Linh Thạch";
                     resourceBarClass = "bg-green-500";
                     iconColorClass = "text-orange-400"; // Siêu cấp: Cam
                } else if (bDB.id === 'linh_dien_than_cap') { 
                     resourceName = "Linh Thạch";
                     resourceBarClass = "bg-green-500";
                     iconColorClass = "text-red-500 animate-pulse"; // Thần cấp: Đỏ + Nhấp nháy
                
                // [NEW] Logic hiển thị màu sắc cho Tụ Linh Đài
                } else if (bDB.id === 'tu_luyen_dai') {
                    resourceName = "Tu Vi";
                    resourceBarClass = "bg-violet-500";
                    iconColorClass = "text-violet-300"; // Sơ cấp: Tím nhạt
                } else if (bDB.id === 'tu_luyen_dai_trung_cap') {
                    resourceName = "Tu Vi";
                    resourceBarClass = "bg-violet-500";
                    iconColorClass = "text-blue-400"; // Trung cấp: Xanh dương
                } else if (bDB.id === 'tu_luyen_dai_cao_cap') {
                    resourceName = "Tu Vi";
                    resourceBarClass = "bg-violet-500";
                    iconColorClass = "text-purple-400"; // Cao cấp: Tím đậm
                } else if (bDB.id === 'tu_luyen_dai_sieu_cap') { // [NEW]
                    resourceName = "Tu Vi";
                    resourceBarClass = "bg-violet-500";
                    iconColorClass = "text-orange-400"; // Siêu cấp: Cam
                } else if (bDB.id === 'tu_luyen_dai_than_cap') { // [NEW]
                    resourceName = "Tu Vi";
                    resourceBarClass = "bg-violet-500";
                    iconColorClass = "text-red-500 animate-pulse"; // Thần cấp: Đỏ + Nhấp nháy
                
                // [NEW] Logic hiển thị màu sắc cho Luyện Đan Phòng
                } else if (bDB.id === 'luyen_dan_phong') {
                    const itemDB = STATIC_ITEM_DB[bDB.resourceId];
                    resourceName = itemDB ? itemDB.name : "Đan Dược";
                    resourceBarClass = "bg-red-600";
                    iconColorClass = "text-orange-400"; // Siêu: Cam
                } else if (bDB.id === 'luyen_dan_phong_than_cap') {
                     const itemDB = STATIC_ITEM_DB[bDB.resourceId];
                     resourceName = itemDB ? itemDB.name : "Đan Dược";
                     resourceBarClass = "bg-red-700";
                     iconColorClass = "text-red-500 animate-pulse"; // Thần: Đỏ nhấp nháy
                
            // [NEW] Logic hiển thị màu sắc cho Luyện Khí Các (Thủy Tinh)
            } else if (bDB.id.startsWith('luyen_khi_cac')) {
                const materialDB = MATERIALS_DB[bDB.resourceId];
                resourceName = materialDB ? materialDB.name : "Thủy Tinh";
                
                if (bDB.id === 'luyen_khi_cac') { // Sơ (Green - Lục)
                    resourceBarClass = "bg-green-500";
                    iconColorClass = "text-green-400";
                } else if (bDB.id === 'luyen_khi_cac_trung_cap') { // Trung (Blue - Lam)
                    resourceBarClass = "bg-blue-500";
                    iconColorClass = "text-blue-400";
                } else if (bDB.id === 'luyen_khi_cac_cao_cap') { // Cao (Purple - Tử)
                    resourceBarClass = "bg-purple-500";
                    iconColorClass = "text-purple-400";
                } else if (bDB.id === 'luyen_khi_cac_sieu_cap') { // [NEW] Siêu (Orange - Cam)
                    resourceBarClass = "bg-yellow-600";
                    iconColorClass = "text-orange-400";
                } else if (bDB.id === 'luyen_khi_cac_than_cap') { // [NEW] Thần (Red Pulse)
                    resourceBarClass = "bg-red-600";
                    iconColorClass = "text-red-500 animate-pulse";
                }
            } 
            // [NEW] Logic hiển thị màu sắc cho Dược Viên
            else if (bDB.id.startsWith('duoc_vien')) {
                const materialDB = MATERIALS_DB[bDB.resourceId];
                resourceName = materialDB ? materialDB.name : "Thảo Dược";
                resourceBarClass = "bg-emerald-500"; // Xanh ngọc lục bảo
                
                if (bDB.id === 'duoc_vien') iconColorClass = "text-emerald-300";
                else if (bDB.id === 'duoc_vien_trung_cap') iconColorClass = "text-emerald-400";
                else if (bDB.id === 'duoc_vien_cao_cap') iconColorClass = "text-emerald-500";
                else if (bDB.id === 'duoc_vien_sieu_cap') iconColorClass = "text-teal-300";
                else if (bDB.id === 'duoc_vien_than_cap') iconColorClass = "text-teal-400 animate-pulse";
            }
            // [NEW] Logic hiển thị màu sắc cho Khoáng Trường
            else if (bDB.id.startsWith('khoang_truong')) {
                const materialDB = MATERIALS_DB[bDB.resourceId];
                resourceName = materialDB ? materialDB.name : "Khoáng Thạch";
                resourceBarClass = "bg-stone-500"; // Màu đá
                
                if (bDB.id === 'khoang_truong') iconColorClass = "text-stone-400";
                else if (bDB.id === 'khoang_truong_trung_cap') iconColorClass = "text-stone-300";
                else if (bDB.id === 'khoang_truong_cao_cap') iconColorClass = "text-gray-300";
                else if (bDB.id === 'khoang_truong_sieu_cap') {
                    iconColorClass = "text-yellow-300"; 
                    resourceBarClass = "bg-yellow-600"; // Vàng cho mỏ vàng
                }
                else if (bDB.id === 'khoang_truong_than_cap') {
                    iconColorClass = "text-red-500 animate-pulse";
                    resourceBarClass = "bg-red-700"; // Đỏ cho thiên thạch
                }
            }

                html += `
                <div class="bg-gray-700 p-4 rounded-lg flex flex-col shadow-md">
                    <div class="flex-grow">
                        <p class="text-center"><i class="${bDB.icon} text-4xl ${iconColorClass}"></i></p>
                        <h5 class="font-bold text-xl text-yellow-300 text-center mt-2">${bDB.name} <span class="text-sm text-gray-400 font-normal">(Cấp ${stats.level})</span></h5>
                        <p class="text-sm text-gray-400 text-center mt-1 h-8 overflow-hidden leading-tight">${bDB.desc}</p>
                        
                        ${bData.level > 0 ? `
                        <div class="mt-2">
                            <p class="text-xs text-gray-400 text-center">Sản lượng: ${stats.rate.toLocaleString()} / giờ</p>
                            <!-- Tích lũy Progress Bar -->
                            <p class="text-xs text-gray-300 mb-1 text-center mt-2 font-bold">${resourceName}</p> 
                            <div class="tuvi-bar-container mb-2" style="height: 1rem;">
                                <div class="tuvi-bar-fill ${resourceBarClass}" style="width: ${percentFull}%;"></div> 
                                <div class="tuvi-bar-text" style="font-size: 0.7rem;">${currentAmount.toLocaleString()} / ${capacity.toLocaleString()}</div>
                            </div>
                            <button onclick="collectDongPhuResources('${bDB.id}')" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-3 rounded text-sm ${currentAmount < 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentAmount < 1 ? 'disabled' : ''}>
                                Thu Hoạch
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-4 border-t border-gray-600 pt-3">
                        ${actionButtonHtml}
                    </div>
                </div>
                `;
            }
            
            html += `</div>`;
            panel.innerHTML = html;
            
            // [NEW] Call the new render function
            renderTienLucClaim();
        }
        
        /**
         * [NEW] Hiển thị khu vực nhận Tiên Lực
         */
        function renderTienLucClaim() {
            const container = document.getElementById('tien-luc-claim-section');
            if (!container) return;
            
            const today = new Date().toISOString().slice(0, 10);
            const lastClaim = gameData.lastTienLucClaim;
            
            if (lastClaim === today) {
                // Already claimed
                container.innerHTML = `
                    <h5 class="font-bold text-lg text-cyan-300">Nhận Tiên Lực Hàng Ngày</h5>
                    <p class="text-gray-400 mt-2">Bạn đã nhận 1 Tiên Lực hôm nay. Hãy quay lại vào ngày mai!</p>
                `;
            } else {
                // Not claimed
                container.innerHTML = `
                    <h5 class="font-bold text-lg text-cyan-300">Nhận Tiên Lực Hàng Ngày</h5>
                    <p class="text-gray-300 mt-2">Đăng nhập mỗi ngày để nhận 1 Tiên Lực (dùng cho Phi Thăng).</p>
                    <button onclick="claimTienLuc()" class="w-full max-w-xs mx-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm mt-3">
                        Nhận 1 Tiên Lực
                    </button>
                `;
            }
        }

        /**
         * [NEW] Nhận Tiên Lực hàng ngày
         */
        function claimTienLuc() {
            const today = new Date().toISOString().slice(0, 10);
            if (gameData.lastTienLucClaim === today) {
                showToast("Hôm nay bạn đã nhận rồi!", false);
                return;
            }
            
            gameData.lastTienLucClaim = today;
            gameData.tienLuc = (gameData.tienLuc || 0) + 1;
            
            showToast("Nhận thành công 1 Tiên Lực!", true);
            
            addSectLog("Tông chủ đã nhận thưởng 1 Tiên Lực hàng ngày.", 'reward');
            
            renderTienLucClaim(); // Re-render the claim section
            // Re-render Phi Thang panel if it's open
            if (!document.getElementById('panel-phi-thang').classList.contains('hidden')) {
                renderPhiThangPanel();
            }
            // No need to call updateUI() as TienLuc isn't on the main screen
        }

        /**
         * [NEW] Nâng cấp hoặc xây công trình Động Phủ
         */
        function upgradeDongPhuBuilding(buildingId) {
            updateDongPhuGeneration(); // Cập nhật giá trị
            
            const bDB = DONG_PHU_DB[buildingId];
            const bData = gameData.sect.dongPhu[buildingId];
            const stats = getDongPhuBuildingStats(bDB, bData.level);
            
            const cost = stats.nextCost;
            
            if (gameData.nganLuong < cost.nl || gameData.diemCongHien < cost.dch) {
                showToast("Không đủ Ngân Lượng hoặc Điểm Cống Hiến!", false);
                return;
            }
            
            // Trừ chi phí
            gameData.nganLuong -= cost.nl;
            gameData.diemCongHien -= cost.dch;
            
            // Nâng cấp
            bData.level++;
            
            let action = (bData.level === 1) ? "Xây dựng" : "Nâng cấp";
            
            addSectLog(`${action} ${bDB.name} lên Cấp ${bData.level} thành công!`, 'reward');
            showToast(`${action} ${bDB.name} lên Cấp ${bData.level} thành công!`, true);
            
            updateUI(); // Cập nhật tiền tệ
            renderDongPhuPanel(); // Cập nhật lại panel
            renderManagementPanel(); // Cập nhật lại ĐCH ở tab Quản lý
        }
        
        /**
         * [NEW] Thu hoạch tài nguyên Động Phủ
         */
        function collectDongPhuResources(buildingId) {
            updateDongPhuGeneration(); // Cập nhật giá trị
            
            const bDB = DONG_PHU_DB[buildingId];
            const bData = gameData.sect.dongPhu[buildingId];
            
            // [FIX] Kiểm tra bData tồn tại
            if (!bData) return;

            const amountToCollect = Math.floor(bData.current);
            if (amountToCollect <= 0) {
                showToast("Chưa có tài nguyên để thu hoạch.", false);
                return;
            }
            
            // [MODIFIED] Hỗ trợ tất cả loại Linh Điền & Tụ Linh Đài
            if (bDB.id.startsWith('linh_dien')) {
                gameData.linhThach += amountToCollect;
                showToast(`Đã thu hoạch ${amountToCollect.toLocaleString()} Linh Thạch!`, true);
            } else if (bDB.id.startsWith('tu_luyen_dai')) { // [NEW] Hỗ trợ tất cả Tụ Linh Đài
                addTuVi(amountToCollect); // Dùng helper function để thêm Tu Vi
                showToast(`Đã thu hoạch ${amountToCollect.toLocaleString()} Tu Vi!`, true);
                // Cập nhật tab Tu Tiên nếu đang mở
                if (!document.getElementById('panel-tu-tien').classList.contains('hidden')) {
                    renderTuTienPanel();
                }
            } else if (bDB.id.startsWith('luyen_dan_phong')) { // [NEW] Hỗ trợ tất cả Luyện Đan Phòng
                const resourceId = bDB.resourceId;
                if (resourceId) {
                    addItem(resourceId, amountToCollect, 'dong_phu'); // Dùng hàm addItem
                    const itemDB = STATIC_ITEM_DB[resourceId];
                    showToast(`Đã thu hoạch ${amountToCollect.toLocaleString()} x ${itemDB.name}!`, true);
                }
            } else if (bDB.id.startsWith('luyen_khi_cac')) { // [MODIFIED] Hỗ trợ tất cả Luyện Khí Các
                const resourceId = bDB.resourceId;
                if (resourceId) {
                    addMaterial(resourceId, amountToCollect, 'dong_phu'); // Dùng hàm addMaterial
                    const materialDB = MATERIALS_DB[resourceId];
                    showToast(`Đã thu hoạch ${amountToCollect.toLocaleString()} x ${materialDB.name}!`, true);
                }
            } else if (bDB.id.startsWith('duoc_vien')) { // [NEW] Dược Viên
                const resourceId = bDB.resourceId;
                if (resourceId) {
                    addMaterial(resourceId, amountToCollect, 'dong_phu');
                    const materialDB = MATERIALS_DB[resourceId] || STATIC_ITEM_DB[resourceId]; // Phòng trường hợp item đặc biệt
                    showToast(`Đã thu hoạch ${amountToCollect.toLocaleString()} x ${materialDB.name}!`, true);
                }
            } else if (bDB.id.startsWith('khoang_truong')) { // [NEW] Khoáng Trường
                const resourceId = bDB.resourceId;
                if (resourceId) {
                    addMaterial(resourceId, amountToCollect, 'dong_phu');
                    const materialDB = MATERIALS_DB[resourceId] || STATIC_ITEM_DB[resourceId];
                    showToast(`Đã thu hoạch ${amountToCollect.toLocaleString()} x ${materialDB.name}!`, true);
                }
            } else {
                // Should not happen now
                showToast(`Đã thu hoạch tài nguyên từ ${bDB.name}.`, true);
            }
            
            bData.current = 0; // Đặt lại về 0
            
            updateUI(); // Cập nhật Linh Thach / Tu Vi
            renderDongPhuPanel(); // Cập nhật lại panel
        }

        /**
         * [NEW] Thu hoạch NHANH TẤT CẢ tài nguyên Động Phủ (Bao gồm Linh Trì)
         */
        function collectAllDongPhuResources() {
            updateDongPhuGeneration();
            updateLinhTriGeneration();

            let totalGained = { 
                linhThach: 0, 
                linhKhi: 0, 
                tuVi: 0, 
                items: {}, // { id: amount }
                materials: {} // { id: amount }
            };
            let harvestCount = 0;

            // 1. Thu hoạch Linh Trì
            const linhTri = gameData.sect.linhTri;
            const ltAmount = Math.floor(linhTri.currentLinhKhi);
            if (ltAmount > 0) {
                totalGained.linhKhi += ltAmount;
                gameData.linhKhi += ltAmount;
                linhTri.currentLinhKhi = 0;
                harvestCount++;
            }

            // 2. Thu hoạch các công trình Động Phủ
            for (const buildingId in gameData.sect.dongPhu) {
                const bData = gameData.sect.dongPhu[buildingId];
                const bDB = DONG_PHU_DB[buildingId];
                if (!bDB || !bData || bData.level === 0) continue;

                const amount = Math.floor(bData.current);
                if (amount > 0) {
                    harvestCount++;
                    bData.current = 0; // Reset tích lũy

                    if (bDB.id.startsWith('linh_dien')) {
                        totalGained.linhThach += amount;
                        gameData.linhThach += amount;
                    } else if (bDB.id.startsWith('tu_luyen_dai')) {
                        totalGained.tuVi += amount;
                        addTuVi(amount); // Dùng helper an toàn
                    } else if (bDB.id.startsWith('luyen_dan_phong')) {
                        if (bDB.resourceId) {
                            // Không dùng addItem để tránh spam log, cộng dồn rồi báo 1 lần
                            const currentItemAmount = gameData.items[bDB.resourceId] || 0;
                            gameData.items[bDB.resourceId] = Math.min(MAX_STACK_SIZE, currentItemAmount + amount);
                            totalGained.items[bDB.resourceId] = (totalGained.items[bDB.resourceId] || 0) + amount;
                        }
                    } else if (bDB.id.startsWith('luyen_khi_cac') || bDB.id.startsWith('duoc_vien') || bDB.id.startsWith('khoang_truong')) {
                        if (bDB.resourceId) {
                            gameData.materials[bDB.resourceId] = (gameData.materials[bDB.resourceId] || 0) + amount;
                            totalGained.materials[bDB.resourceId] = (totalGained.materials[bDB.resourceId] || 0) + amount;
                        }
                    }
                }
            }

            if (harvestCount === 0) {
                showToast("Chưa có tài nguyên nào để thu hoạch.", false);
                return;
            }

            // 3. Tổng kết và thông báo
            let msgParts = [];
            if (totalGained.linhThach > 0) msgParts.push(`${totalGained.linhThach.toLocaleString()} Linh Thạch`);
            if (totalGained.linhKhi > 0) msgParts.push(`${totalGained.linhKhi.toLocaleString()} Linh Khí`);
            if (totalGained.tuVi > 0) msgParts.push(`${totalGained.tuVi.toLocaleString()} Tu Vi`);
            
            for (const id in totalGained.items) {
                const item = STATIC_ITEM_DB[id];
                if (item) msgParts.push(`${totalGained.items[id]} x ${item.name}`);
            }
            for (const id in totalGained.materials) {
                const mat = MATERIALS_DB[id] || STATIC_ITEM_DB[id]; // Fallback nếu item nằm bên kia
                if (mat) msgParts.push(`${totalGained.materials[id]} x ${mat.name}`);
            }

            showToast(`Thu hoạch nhanh: ${msgParts.join(', ')}!`, true);
            addSectLog(`Thu hoạch nhanh Động Phủ: ${msgParts.join(', ')}.`, 'reward');
            
            // 4. Cập nhật UI
            updateUI();
            renderDongPhuPanel();
            
            // Nếu đang mở tab tu tiên, cập nhật luôn
            if (!document.getElementById('panel-tu-tien').classList.contains('hidden')) {
                renderTuTienPanel();
            }
        }

        // [END NEW] --- Động Phủ Functions ---

        // [NEW] --- Linh Trì Functions (Placeholder) ---

        /**
         * [NEW] Tính toán và cập nhật Linh Khí được tạo ra (offline/afk)
         */
        function updateLinhTriGeneration() {
            if (!gameData || !gameData.sect || !gameData.sect.linhTri) return;

            const linhTri = gameData.sect.linhTri;
            const levelData = LINH_TRI_DB[linhTri.level];
            const now = Date.now();
            
            const lastUpdate = linhTri.lastUpdateTime || now;
            const timePassedMs = now - lastUpdate;

            if (timePassedMs > 0) {
                const ratePerHour = levelData.ratePerHour;
                const capacity = levelData.capacity;
                
                const hoursPassed = timePassedMs / 3600000;
                const linhKhiGenerated = hoursPassed * ratePerHour;
                
                const newTotal = (linhTri.currentLinhKhi || 0) + linhKhiGenerated;
                
                linhTri.currentLinhKhi = Math.min(capacity, newTotal);
            }
            
            // Luôn cập nhật thời gian xem cuối cùng
            linhTri.lastUpdateTime = now;
        }

        /**
         * Hiển thị tab Linh Trì (Placeholder)
         */
        function renderLinhTriPanel() {
            const panel = document.getElementById('panel-linh-tri');
            if (!panel) return;

            updateLinhTriGeneration(); // [NEW] Cập nhật giá trị trước khi render

            const linhTri = gameData.sect.linhTri;
            const levelData = LINH_TRI_DB[linhTri.level];
            
            const currentLinhKhi = Math.floor(linhTri.currentLinhKhi);
            const capacity = levelData.capacity;
            const percentFull = Math.min(100, (currentLinhKhi / capacity) * 100);

            let upgradeButtonHtml = '';
            if (levelData.max) {
                upgradeButtonHtml = `<button class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded opacity-50 cursor-not-allowed">Đã Đạt Cấp Tối Đa</button>`;
            } else {
                const nextLevelData = LINH_TRI_DB[linhTri.level + 1];
                // [FIX] Sửa lỗi: Đọc chi phí từ 'levelData' (cấp hiện tại) thay vì 'nextLevelData'
                const canAffordNL = gameData.nganLuong >= levelData.costNL;
                const canAffordDCH = gameData.diemCongHien >= levelData.costDCH;
                const canAfford = canAffordNL && canAffordDCH;
                
                upgradeButtonHtml = `
                    <div class="text-xs text-gray-300 text-center mb-2">
                        <p>Nâng lên Cấp ${nextLevelData.level} (Sản lượng: ${nextLevelData.ratePerHour}/giờ):</p>
                        <!-- [FIX] Sửa lỗi: Đọc chi phí từ 'levelData' -->
                        <p class="${canAffordNL ? '' : 'text-red-400'}">Chi phí: ${levelData.costNL.toLocaleString()} NL</p>
                        <p class="${canAffordDCH ? '' : 'text-red-400'}">Chi phí: ${levelData.costDCH.toLocaleString()} ĐCH</p>
                    </div>
                    <button onclick="nangCapLinhTri()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        Nâng Cấp
                    </button>
                `;
            }

            panel.innerHTML = `
                <div class="bg-gray-700 p-4 rounded-lg max-w-md mx-auto text-center">
                    <i class="fa-solid fa-spa text-6xl text-cyan-300 mb-4"></i>
                    <h4 class="text-2xl font-bold text-cyan-400 mb-2">Linh Trì (Cấp ${levelData.level})</h4>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm my-4">
                        <div class="bg-gray-800 p-2 rounded">
                            <p class="text-gray-400">Sản Lượng</p>
                            <p class="font-bold text-white">${levelData.ratePerHour.toLocaleString()} / giờ</p>
                        </div>
                        <div class="bg-gray-800 p-2 rounded">
                            <p class="text-gray-400">Sức Chứa</p>
                            <p class="font-bold text-white">${levelData.capacity.toLocaleString()}</p>
                        </div>
                    </div>

                    <!-- Tích lũy Progress Bar -->
                    <p class="text-sm text-gray-300 mb-1 text-center">Đã Tích Lũy</p>
                    <div class="tuvi-bar-container mb-4">
                        <div class="tuvi-bar-fill bg-purple-500" style="width: ${percentFull}%;"></div>
                        <div class="tuvi-bar-text">${currentLinhKhi.toLocaleString()} / ${capacity.toLocaleString()}</div>
                    </div>

                    <button onclick="thuHoachLinhKhi()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow-lg ${currentLinhKhi < 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentLinhKhi < 1 ? 'disabled' : ''}>
                        Thu Hoạch (${currentLinhKhi.toLocaleString()} Linh Khí)
                    </button>

                    <div class="mt-6 border-t border-gray-600 pt-4">
                        ${upgradeButtonHtml}
                    </div>
                </div>
            `;
        }
        
        /**
         * [NEW] Thu hoạch Linh Khí từ Linh Trì
         */
        function thuHoachLinhKhi() {
            // Đảm bảo giá trị là mới nhất
            updateLinhTriGeneration();
            
            const linhTri = gameData.sect.linhTri;
            const amountToCollect = Math.floor(linhTri.currentLinhKhi);

            if (amountToCollect <= 0) {
                showToast("Linh Trì chưa tích lũy được Linh Khí.", false);
                return;
            }

            gameData.linhKhi += amountToCollect;
            linhTri.currentLinhKhi = 0; // Đặt lại về 0
            // lastUpdateTime đã được set trong updateLinhTriGeneration(), không cần set lại
            
            showToast(`Đã thu hoạch ${amountToCollect.toLocaleString()} Linh Khí!`, true);
            
            updateUI(); // Cập nhật Linh Khí ở UI chính
            // [MODIFIED] Cập nhật lại panel Động Phủ thay vì Linh Trì (vì đã gộp)
            renderDongPhuPanel(); 
        }

        /**
         * [NEW] Nâng cấp Linh Trì
         */
        function nangCapLinhTri() {
            updateLinhTriGeneration(); // [NEW] Cập nhật Linh Khí trước khi nâng cấp

            const linhTri = gameData.sect.linhTri;
            const levelData = LINH_TRI_DB[linhTri.level];

            if (levelData.max) {
                showToast("Linh Trì đã đạt cấp tối đa!", false);
                return;
            }

            // [FIX] Sửa lỗi: Đọc chi phí từ 'levelData' (cấp hiện tại)
            const canAffordNL = gameData.nganLuong >= levelData.costNL;
            const canAffordDCH = gameData.diemCongHien >= levelData.costDCH;

            if (!canAffordNL || !canAffordDCH) {
                showToast("Không đủ Ngân Lượng hoặc Điểm Cống Hiến!", false);
                return;
            }

            // Trừ chi phí
            // [FIX] Sửa lỗi: Trừ chi phí từ 'levelData'
            gameData.nganLuong -= levelData.costNL;
            gameData.diemCongHien -= levelData.costDCH;
            
            // Nâng cấp
            linhTri.level++;

            addSectLog(`Linh Trì đã được nâng cấp lên Cấp ${linhTri.level}!`, 'reward');
            showToast(`Nâng cấp Linh Trì lên Cấp ${linhTri.level} thành công!`, true);
            
            updateUI(); // Cập nhật tiền tệ
            // [MODIFIED] Cập nhật lại panel Động Phủ thay vì Linh Trì
            renderDongPhuPanel(); 
            renderManagementPanel(); // Cập nhật lại ĐCH ở tab Quản lý
        }

        // [END NEW] --- Linh Trì Functions ---

        // [NEW] --- Lôi Đài Functions (Placeholder) ---
        /**
         * [NEW] Tính toán Lực chiến của đệ tử (riêng cho Lôi Đài)
         */
        function getDisciplePower(disciple) {
            if (!disciple) return 0;
            // Đảm bảo tính toán đầy đủ chỉ số bao gồm thiên phú
            const stats = calculateDiscipleStats(disciple); 
            // Công thức LC: (HP/5) + (ATK*5) + (DEF*3) + (SPD*3) * (Level/10 + 1)
            const basePower = (stats.hp / 5) + (stats.atk * 5) + ((stats.def || 0) * 3) + ((stats.spd || 0) * 3);
            const levelMultiplier = (disciple.level / 10) + 1;
            // Bonus thêm từ Crit và Crit Damage
            const critMulti = 1 + ((stats.crit || 0) / 100) * ((stats.critDamage || 150) / 100);
            
            return Math.floor(basePower * levelMultiplier * critMulti);
        }
        
        /**
         * [NEW] Lấy thông tin Hạng Lôi Đài
         */
        function getLoiDaiTier(rank) {
            return LOI_DAI_TIERS_DB[rank] || LOI_DAI_TIERS_DB[0];
        }

        /**
         * [NEW] Cập nhật Hạng Lôi Đài cho TẤT CẢ đệ tử dựa trên điểm
         */
        function updateAllDisciplesLoiDaiRank() {
             if (!gameData.disciples) return;

             gameData.disciples.forEach(d => {
                 const points = d.loiDaiPoints || 0;
                 
                 if (points < 150) d.loiDaiRank = 1;       // Sơ Nhập Giang Hồ
                 else if (points < 250) d.loiDaiRank = 2;  // Tiểu Hữu Danh Khí
                 else if (points < 400) d.loiDaiRank = 3;  // Võ Lâm Hảo Thủ
                 else if (points < 600) d.loiDaiRank = 4;  // Nhất Phương Danh Sĩ
                 else if (points < 850) d.loiDaiRank = 5;  // Uy Trấn Giang Hồ
                 else if (points < 1200) d.loiDaiRank = 6; // Nhất Đại Tông Sư
                 else d.loiDaiRank = 7;                    // Độc Cô Cầu Bại
             });
        }

        /**
         * [NEW] Cập nhật Bảng Xếp Hạng Lôi Đài (Sorting)
         */
        function updateLoiDaiRankings() {
            updateAllDisciplesLoiDaiRank();
            
            // 1. Tạo danh sách xếp hạng
            gameData.sect.loiDaiRankings = gameData.disciples.map(d => ({
                id: d.id,
                name: d.name,
                level: d.level,
                power: getDisciplePower(d),
                rank: d.loiDaiRank || 1,
                points: d.loiDaiPoints || 0,
                potential: d.potential, // Lấy phẩm chất để hiện màu/ảnh
                avatar: DISCIPLE_POTENTIAL_IMAGES[d.potential], // Lấy ảnh avatar
                winstreak: d.winstreak || 0 // [NEW] Thêm dữ liệu chuỗi thắng
            }));
            
            // 2. Sắp xếp: Điểm (cao -> thấp), rồi Lực chiến (cao -> thấp)
            gameData.sect.loiDaiRankings.sort((a, b) => {
                if (a.points !== b.points) return b.points - a.points;
                return b.power - a.power;
            });
        }
        
        /**
         * [NEW] Hàm thêm log Lôi Đài
         */
        function addLoiDaiLog(msg, type = 'info') {
            if (!gameData.sect.loiDaiLog) gameData.sect.loiDaiLog = [];
            
            const time = new Date().toLocaleTimeString();
            let color = 'text-gray-300';
            if (type === 'win') color = 'text-green-400';
            else if (type === 'loss') color = 'text-red-400';
            else if (type === 'reward') color = 'text-yellow-300';
            else if (type === 'info') color = 'text-blue-300';
            
            const entry = `<div class="border-b border-gray-700/30 pb-1 mb-1 last:border-0 hover:bg-white/5 px-1"><span class="text-gray-500 text-[9px] mr-2">[${time}]</span><span class="${color}">${msg}</span></div>`;
            
            gameData.sect.loiDaiLog.unshift(entry);
            if (gameData.sect.loiDaiLog.length > 50) gameData.sect.loiDaiLog.pop();
            
            // Update UI if visible
            const logEl = document.getElementById('loi-dai-log-container');
            if (logEl) {
                logEl.innerHTML = gameData.sect.loiDaiLog.join('');
            }
        }

        /**
         * [NEW] Hiển thị tab Lôi Đài (Render Chính)
         */
        function renderLoiDaiPanel() {
            const panel = document.getElementById('panel-loi-dai');
            if (!panel) return;

            // Init log array nếu chưa có
            if (!gameData.sect.loiDaiLog) gameData.sect.loiDaiLog = [];
            // [NEW] Init biến theo dõi ngày nhận thưởng nếu chưa có
            if (!gameData.sect.lastLoiDaiSalaryClaim) gameData.sect.lastLoiDaiSalaryClaim = null;

            updateLoiDaiRankings(); // Cập nhật BXH
            
            const rankings = gameData.sect.loiDaiRankings;
            // Check ngày hiện tại
            const now = Date.now();
            const today = new Date().toISOString().slice(0, 10);
            const canClaim = gameData.sect.lastLoiDaiSalaryClaim !== today;
            
            let html = `
                <div class="text-center mb-6">
                    <h4 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-orange-500 mb-2 uppercase tracking-widest filter drop-shadow-lg">Lôi Đài Tông Môn</h4>
                    <p class="text-gray-400 text-xs">"Đệ tử tranh tài, kẻ mạnh lên ngôi. Rèn luyện thực chiến, nâng cao cảnh giới."</p>
                </div>
            `;
            
            html += `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">`;
            
            // Cột 1: Bảng Xếp Hạng & Phần Thưởng
            html += `
                <div class="flex flex-col gap-4 h-[500px]">
                    <!-- [MODIFIED] Phần Thưởng Top Ngày (Mở rộng Top 1-5) -->
                    <div class="bg-gray-800/90 backdrop-blur-md border border-yellow-600/30 p-3 rounded-xl shadow-lg flex flex-col items-center text-center">
                        <h5 class="font-bold text-yellow-300 text-sm uppercase tracking-wide mb-2"><i class="fa-solid fa-gift mr-1"></i>Thưởng Xếp Hạng Ngày</h5>
                        
                        <!-- Grid thưởng Top 5 -->
                        <div class="grid grid-cols-5 gap-2 text-[10px] mb-3 w-full">
                            <div class="bg-black/30 p-1 rounded border border-yellow-500/50">
                                <span class="block text-yellow-400 font-black text-xs">TOP 1</span>
                                <span class="text-gray-300">50 Tỷ</span>
                            </div>
                            <div class="bg-black/30 p-1 rounded border border-gray-400/50">
                                <span class="block text-gray-300 font-bold text-xs">TOP 2</span>
                                <span class="text-gray-400">20 Tỷ</span>
                            </div>
                            <div class="bg-black/30 p-1 rounded border border-orange-500/50">
                                <span class="block text-orange-400 font-bold text-xs">TOP 3</span>
                                <span class="text-gray-400">10 Tỷ</span>
                            </div>
                            <div class="bg-black/30 p-1 rounded border border-blue-500/50">
                                <span class="block text-blue-400 font-bold text-xs">TOP 4</span>
                                <span class="text-gray-400">5 Tỷ</span>
                            </div>
                            <div class="bg-black/30 p-1 rounded border border-green-500/50">
                                <span class="block text-green-400 font-bold text-xs">TOP 5</span>
                                <span class="text-gray-400">2 Tỷ</span>
                            </div>
                        </div>

                        <button onclick="claimLoiDaiTopRewards()" class="w-full py-2 rounded font-bold text-xs transition transform active:scale-95 shadow-md ${canClaim ? 'bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white animate-pulse' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}" ${!canClaim ? 'disabled' : ''}>
                            ${canClaim ? 'Nhận Thưởng Ngay' : 'Đã Nhận Hôm Nay'}
                        </button>
                    </div>

                    <div class="bg-gray-800/80 backdrop-blur-md rounded-xl border border-gray-600 p-4 shadow-lg flex flex-col flex-grow overflow-hidden">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                            <h5 class="font-bold text-yellow-300 flex items-center gap-2"><i class="fa-solid fa-trophy"></i> Bảng Xếp Hạng</h5>
                            <span class="text-xs text-gray-500">Tổng: ${rankings.length} đệ tử</span>
                        </div>
                        
                        <div class="flex-grow overflow-y-auto scrollbar-thin space-y-2 pr-1">
            `;
            
            if (rankings.length === 0) {
                 html += `<div class="flex flex-col items-center justify-center h-full text-gray-500 italic"><i class="fa-solid fa-user-slash text-4xl mb-2"></i>Chưa có đệ tử.</div>`;
            } else {
                rankings.forEach((d, index) => {
                    const tier = getLoiDaiTier(d.rank);
                    let rankBadge = `<span class="font-bold text-sm w-6 text-center text-gray-500">#${index + 1}</span>`;
                    let bgClass = "bg-gray-700/50";
                    let borderClass = "border-gray-700";
                    let extraStyle = ""; 
                    let visualTitle = '';
                    let avatarBorder = "border-gray-600";

                    // [MODIFIED] Fix lỗi tràn khung: Bỏ scale, dùng ring/shadow để nổi bật
                    if (index === 0) {
                        // TOP 1: Gold Theme
                        rankBadge = `<div class="w-8 h-8 flex items-center justify-center bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full shadow-[0_0_10px_#eab308] border-2 border-yellow-200 relative z-10"><i class="fa-solid fa-crown text-white text-sm animate-bounce"></i></div>`;
                        bgClass = "bg-gradient-to-r from-yellow-900/60 via-yellow-800/40 to-yellow-900/60";
                        borderClass = "border-yellow-500";
                        // [FIX] Bỏ scale-[1.02], thêm ring để làm nổi bật mà không đổi kích thước
                        extraStyle = "shadow-[0_0_20px_rgba(234,179,8,0.2)] ring-1 ring-yellow-400/50 z-10 my-1"; 
                        avatarBorder = "border-yellow-400 shadow-[0_0_10px_#facc15]";
                        
                        visualTitle = `
                            <div class="flex items-center gap-1 mt-1">
                                <i class="fa-solid fa-dragon text-yellow-500 text-[10px]"></i>
                                <span class="text-[10px] font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-white to-yellow-200 uppercase tracking-wider animate-pulse filter drop-shadow-[0_0_2px_rgba(234,179,8,0.8)]">Võ Lâm Minh Chủ</span>
                                <i class="fa-solid fa-dragon text-yellow-500 text-[10px] transform scale-x-[-1]"></i>
                            </div>`;
                    } else if (index === 1) {
                        // TOP 2: Silver Theme
                        rankBadge = `<div class="w-7 h-7 flex items-center justify-center bg-gradient-to-br from-gray-300 to-gray-500 rounded-full shadow-[0_0_8px_#9ca3af] border-2 border-gray-100 relative z-10"><i class="fa-solid fa-medal text-white text-xs"></i></div>`;
                        bgClass = "bg-gradient-to-r from-gray-800/80 via-gray-700/80 to-gray-800/80";
                        borderClass = "border-gray-400";
                        // [FIX] Bỏ scale
                        extraStyle = "shadow-[0_0_10px_rgba(156,163,175,0.2)] ring-1 ring-gray-400/30 z-0 my-0.5";
                        avatarBorder = "border-gray-300 shadow-[0_0_5px_#d1d5db]";
                        
                        visualTitle = `<span class="block text-[9px] font-bold text-gray-200 uppercase tracking-wide text-shadow-white mt-0.5"><i class="fa-solid fa-mountain mr-1 text-gray-400"></i>Thái Sơn Bắc Đẩu</span>`;
                    } else if (index === 2) {
                        // TOP 3: Bronze Theme
                        rankBadge = `<div class="w-6 h-6 flex items-center justify-center bg-gradient-to-br from-orange-500 to-amber-700 rounded-full shadow-[0_0_8px_#ea580c] border-2 border-orange-300 relative z-10"><i class="fa-solid fa-medal text-white text-[10px]"></i></div>`;
                        bgClass = "bg-gradient-to-r from-orange-900/40 via-orange-800/40 to-orange-900/40";
                        borderClass = "border-orange-500";
                        extraStyle = "shadow-[0_0_10px_rgba(249,115,22,0.2)]";
                        avatarBorder = "border-orange-400";
                        
                        visualTitle = `<span class="block text-[9px] font-bold text-orange-400 uppercase tracking-wide text-shadow-orange mt-0.5"><i class="fa-solid fa-bullhorn mr-1"></i>Danh Chấn Bát Phương</span>`;
                    } else if (index === 3) {
                         rankBadge = `<span class="font-bold text-sm w-6 text-center text-blue-400">#4</span>`;
                         borderClass = "border-blue-500/30";
                         visualTitle = `<span class="block text-[9px] font-bold text-blue-400 uppercase tracking-wide">Uy Trấn Giang Hồ</span>`;
                    } else if (index === 4) {
                         rankBadge = `<span class="font-bold text-sm w-6 text-center text-green-400">#5</span>`;
                         borderClass = "border-green-500/30";
                         visualTitle = `<span class="block text-[9px] font-bold text-green-400 uppercase tracking-wide">Nhất Phương Bá Chủ</span>`;
                    } else if (index === 5) {
                         rankBadge = `<span class="font-bold text-sm w-6 text-center text-purple-400">#6</span>`;
                         borderClass = "border-purple-500/30";
                         visualTitle = `<span class="block text-[9px] font-bold text-purple-400 uppercase tracking-wide">Võ Lâm Cao Thủ</span>`;
                    } else if (index === 6) {
                         rankBadge = `<span class="font-bold text-sm w-6 text-center text-cyan-400">#7</span>`;
                         borderClass = "border-cyan-500/30";
                         visualTitle = `<span class="block text-[9px] font-bold text-cyan-400 uppercase tracking-wide">Giang Hồ Hào Kiệt</span>`;
                    } else if (index === 7) {
                         rankBadge = `<span class="font-bold text-sm w-6 text-center text-red-300">#8</span>`;
                         borderClass = "border-red-500/30";
                         visualTitle = `<span class="block text-[9px] font-bold text-red-300 uppercase tracking-wide">Anh Hùng Thiếu Niên</span>`;
                    } else if (index === 8) {
                         rankBadge = `<span class="font-bold text-sm w-6 text-center text-indigo-400">#9</span>`;
                         borderClass = "border-indigo-500/30";
                         visualTitle = `<span class="block text-[9px] font-bold text-indigo-400 uppercase tracking-wide">Tiềm Long Tại Uyên</span>`;
                    } else if (index === 9) {
                         rankBadge = `<span class="font-bold text-sm w-6 text-center text-teal-400">#10</span>`;
                         borderClass = "border-teal-500/30";
                         visualTitle = `<span class="block text-[9px] font-bold text-teal-400 uppercase tracking-wide">Hậu Khởi Chi Tú</span>`;
                    }
                    
                    let nameColor = 'text-white';
                    if (['Thiên Tài', 'Tuyệt Thế', 'Thiên Kiêu Chi Tử', 'Nghịch Thiên Cải Mệnh', 'Vô Cực Đạo Thể', 'Vạn Đạo Chi Tổ', 'Chân Ngã Duy Nhất', 'Nhất Niệm Vĩnh Hằng'].includes(d.potential)) {
                         if (d.potential === 'Nhất Niệm Vĩnh Hằng') nameColor = 'text-rainbow-animation font-black';
                         else if (d.potential === 'Thiên Tài') nameColor = 'text-yellow-300';
                         else nameColor = 'text-cyan-300';
                    }

                    // [NEW] Hiển thị Chuỗi Thắng & Danh Hiệu Streak
                    let streakHtml = '';
                    if (d.winstreak > 0) {
                        const streakTitle = getStreakTitle(d.winstreak);
                        let titleHtml = '';
                        
                        if (streakTitle) {
                            titleHtml = `<span class="ml-1 ${streakTitle.color} text-[9px] uppercase tracking-wide border border-current px-1 rounded flex items-center gap-1">
                                <i class="fa-solid ${streakTitle.icon}"></i> ${streakTitle.name}
                            </span>`;
                        }

                        streakHtml = `
                        <div class="flex items-center gap-1 mt-0.5">
                            <span class="inline-flex items-center gap-1 bg-orange-900/40 text-orange-400 text-[9px] px-1.5 py-0.5 rounded border border-orange-500/30 font-bold" title="Chuỗi thắng liên tiếp">
                                <i class="fa-solid fa-fire animate-pulse"></i> ${d.winstreak}
                            </span>
                            ${titleHtml}
                        </div>`;
                    }

                    // [MODIFIED] HTML Structure - Đảm bảo flex-grow min-w-0 để text không tràn
                    html += `
                    <div class="${bgClass} border ${borderClass} p-2 rounded-lg flex items-center justify-between hover:bg-gray-600 transition duration-200 ${extraStyle}">
                        <div class="flex items-center gap-3 flex-grow min-w-0"> <!-- Thêm min-w-0 để text truncate hoạt động -->
                            <!-- Rank Badge -->
                            <div class="flex-shrink-0 flex justify-center w-8">
                                ${rankBadge}
                            </div>
                            
                            <!-- Avatar -->
                            <div class="w-10 h-10 rounded-full bg-gray-900 border ${avatarBorder} overflow-hidden flex-shrink-0 relative">
                                ${d.avatar ? `<img src="${d.avatar}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-user-ninja w-full h-full flex items-center justify-center text-gray-500 text-xl"></i>`}
                            </div>
                            
                            <!-- Info -->
                            <div class="min-w-0 flex-grow">
                                <div class="flex flex-wrap items-center gap-2">
                                    <p class="font-bold text-sm ${nameColor} truncate">${d.name}</p>
                                </div>
                                ${visualTitle}
                                ${streakHtml} <!-- [NEW] Thêm dòng chuỗi thắng & danh hiệu -->
                                <p class="text-[10px] ${tier.color} truncate mt-0.5">${tier.name} - ${d.points} điểm</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                             <p class="text-[10px] text-gray-400">Lực Chiến</p>
                             <p class="text-xs font-mono font-bold text-orange-300">${d.power.toLocaleString()}</p>
                        </div>
                    </div>
                    `;
                });
            }
            html += `</div></div></div>`; // End Col 1
            
            // Cột 2: Giao diện Khiêu chiến & Log (Giữ nguyên)
            const challengers = gameData.disciples.filter(d => d.status === 'Nhàn Rỗi');
            
            let challengerOptions = challengers.map(d => {
                const lastFight = d.lastLoiDaiFight || 0;
                const remainingMs = Math.max(0, (lastFight + (5 * 60 * 1000)) - now); 
                const disabled = remainingMs > 0;
                const timeStr = disabled ? ` (Hồi: ${Math.ceil(remainingMs / 1000)}s)` : '';
                return `<option value="${d.id}" ${disabled ? 'disabled' : ''}>${d.name} (Cấp ${d.level})${timeStr}</option>`;
            }).join('');
            
            if (challengers.length === 0) {
                challengerOptions = `<option value="" disabled>Không có đệ tử rảnh rỗi</option>`;
            }
            
            html += `
            <div class="flex flex-col gap-6 h-[500px]">
                <!-- Challenge Panel -->
                <div class="bg-gray-800/80 backdrop-blur-md border border-gray-600 p-5 rounded-xl shadow-lg flex-shrink-0">
                    <h5 class="font-bold text-red-400 text-center mb-4 uppercase tracking-wider flex items-center justify-center gap-2">
                        <i class="fa-solid fa-swords"></i> Sàn Đấu
                    </h5>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block uppercase font-bold">Người Khiêu Chiến</label>
                            <div class="relative">
                                <i class="fa-solid fa-user-ninja absolute top-3 left-3 text-gray-500"></i>
                                <select id="loi-dai-challenger" class="bg-black/30 border border-gray-600 rounded-lg p-2 pl-9 text-white w-full text-sm focus:border-red-500 outline-none transition">
                                    <option value="">Chọn đệ tử...</option>
                                    ${challengerOptions}
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-center -my-2 z-10 relative">
                            <div class="bg-gray-700 rounded-full p-1 border-4 border-gray-800">
                                <i class="fa-solid fa-angles-down text-gray-400"></i>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-400 mb-1 block uppercase font-bold">Đối Thủ</label>
                            <div class="relative">
                                <i class="fa-solid fa-skull absolute top-3 left-3 text-gray-500"></i>
                                <select id="loi-dai-opponent" class="bg-black/30 border border-gray-600 rounded-lg p-2 pl-9 text-white w-full text-sm focus:border-red-500 outline-none transition">
                                    <option value="">Chọn đối thủ...</option>
                                    ${rankings.map(d => `<option value="${d.id}">#${d.rank} - ${d.name} (${d.power.toLocaleString()} LC)</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 pt-2">
                            <button onclick="startLoiDaiChallenge()" class="flex-1 bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 text-white font-bold py-2.5 px-3 rounded-lg text-sm shadow-md transition transform active:scale-95 ${challengers.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${challengers.length === 0 ? 'disabled' : ''}>
                                <i class="fa-solid fa-khanda mr-1"></i> Khiêu Chiến
                            </button>
                            <button onclick="autoLoiDaiChallenge()" class="flex-1 bg-gradient-to-r from-orange-600 to-yellow-600 hover:from-orange-500 hover:to-yellow-500 text-white font-bold py-2.5 px-3 rounded-lg text-sm shadow-md transition transform active:scale-95 ${challengers.length < 2 ? 'opacity-50 cursor-not-allowed' : ''}" ${challengers.length < 2 ? 'disabled' : ''} title="Tự động ghép cặp tất cả đệ tử rảnh rỗi">
                                <i class="fa-solid fa-robot mr-1"></i> Tự Động
                            </button>
                        </div>
                        <p class="text-center text-[10px] text-gray-500 italic">Phí: 100 Linh Thạch/trận. Hồi chiêu 5 phút.</p>
                    </div>
                </div>

                <!-- Log Panel -->
                <div class="bg-black/30 border border-gray-700 rounded-xl p-3 flex flex-col flex-grow overflow-hidden relative">
                    <h5 class="font-bold text-gray-300 mb-2 flex items-center gap-2 text-xs uppercase tracking-wide border-b border-gray-700 pb-2">
                        <i class="fa-solid fa-scroll text-yellow-500"></i> Nhật Ký Diễn Võ
                    </h5>
                    <div id="loi-dai-log-container" class="overflow-y-auto scrollbar-thin text-xs font-mono space-y-1 h-full pr-1">
            `;
            
            if (gameData.sect.loiDaiLog && gameData.sect.loiDaiLog.length > 0) {
                html += gameData.sect.loiDaiLog.join('');
            } else {
                html += `<div class="h-full flex items-center justify-center text-gray-600 italic">Chưa có ghi chép nào.</div>`;
            }
            html += `</div></div></div>`; // Close Log, Col 2, Grid
            
            panel.innerHTML = html;
        }
        
        /**
         * [NEW] Nhận thưởng Top 5 Đệ Tử Lôi Đài (Hàng Ngày)
         */
        function claimLoiDaiTopRewards() {
            const today = new Date().toISOString().slice(0, 10);
            
            if (gameData.sect.lastLoiDaiSalaryClaim === today) {
                showToast("Hôm nay đã nhận thưởng rồi!", false);
                return;
            }

            // Đảm bảo BXH mới nhất
            updateLoiDaiRankings();
            const rankings = gameData.sect.loiDaiRankings;
            
            if (rankings.length === 0) {
                showToast("Chưa có đệ tử nào trong BXH!", false);
                return;
            }

            // [MODIFIED] Mức thưởng mới cho Top 1-5
            const REWARDS = [
                50000000000, // Top 1: 50 Tỷ
                20000000000, // Top 2: 20 Tỷ
                10000000000, // Top 3: 10 Tỷ
                5000000000,  // Top 4: 5 Tỷ
                2000000000   // Top 5: 2 Tỷ
            ];
            
            let msg = "Đã phát thưởng Top Lôi Đài:\n";
            let hasRewarded = false;

            // Loop phát thưởng cho 5 người đầu tiên (hoặc ít hơn nếu không đủ người)
            for (let i = 0; i < 5; i++) {
                if (rankings.length > i) {
                    const d = gameData.disciples.find(disc => disc.id === rankings[i].id);
                    if (d) {
                        addDiscipleXp(d.id, REWARDS[i]);
                        msg += `- Top ${i+1}: ${d.name} (+${(REWARDS[i]/1000000000).toFixed(0)} Tỷ XP)\n`;
                        hasRewarded = true;
                    }
                }
            }

            if (hasRewarded) {
                gameData.sect.lastLoiDaiSalaryClaim = today;
                showToast("Nhận thưởng thành công! Kiểm tra nhật ký.", true);
                addLoiDaiLog(msg.replace(/\n/g, ', '), 'reward');
                
                // Re-render
                renderLoiDaiPanel();
                // Cập nhật tab Bồi Dưỡng nếu đang mở (để thấy Level mới)
                if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                    renderDiscipleList();
                }
            } else {
                showToast("Lỗi khi phát thưởng!", false);
            }
        }

        /**
         * [NEW] Hàm xử lý logic chiến đấu lôi đài (Core Logic)
         * Dùng chung cho cả Thủ công và Auto
         */
        function processLoiDaiFight(challengerId, opponentId, isAuto = false) {
            const challenger = gameData.disciples.find(d => d.id === challengerId);
            const opponentRankInfo = gameData.sect.loiDaiRankings.find(r => r.id === opponentId);
            
            // Nếu đối thủ là đệ tử của mình, tìm object đầy đủ để lấy chỉ số mới nhất
            let opponent = gameData.disciples.find(d => d.id === opponentId);
            
            // Fallback nếu không tìm thấy trong disciples (trường hợp lỗi data), dùng data từ BXH
            if (!opponent && opponentRankInfo) {
                opponent = { ...opponentRankInfo, name: opponentRankInfo.name, power: opponentRankInfo.power };
            }

            if (!challenger || !opponent) return { success: false, msg: "Không tìm thấy dữ liệu đấu thủ." };

            // Kiểm tra Linh Thạch
            if (gameData.linhThach < 100) {
                return { success: false, msg: "Không đủ 100 Linh Thạch!" };
            }

            // Kiểm tra Hồi chiêu (Double check)
            const now = Date.now();
            const lastFight = challenger.lastLoiDaiFight || 0;
            if (now - lastFight < 5 * 60 * 1000) {
                 return { success: false, msg: `${challenger.name} đang hồi chiêu!` };
            }

            // Trừ tiền
            gameData.linhThach -= 100;

            // Set Cooldown
            challenger.lastLoiDaiFight = now;
            
            // [NEW] Grant XP Reward
            const XP_REWARD = 1000000;
            addDiscipleXp(challenger.id, XP_REWARD);

            // Tính toán kết quả
            const cPower = getDisciplePower(challenger);
            const oPower = getDisciplePower(opponent);

            // Công thức tỉ lệ thắng
            let ratio = cPower / Math.max(1, oPower);
            let winChance = 50 + (ratio - 1) * 40;
            if (ratio < 1) winChance = 50 - (1 - ratio) * 40;
            winChance = Math.min(95, Math.max(5, winChance));

            const roll = Math.random() * 100;
            let isWin = roll <= winChance;
            let logMsg = "";

            // Xử lý Rank & Điểm
            if (typeof challenger.loiDaiPoints !== 'number') challenger.loiDaiPoints = 0;
            if (typeof opponent.loiDaiPoints !== 'number') opponent.loiDaiPoints = 0;
            
            if (isWin) {
                // --- THẮNG ---
                const pointDiff = Math.max(0, (opponent.loiDaiPoints || 0) - challenger.loiDaiPoints);
                const pointsGained = 10 + Math.floor(pointDiff / 10);
                
                challenger.loiDaiPoints += pointsGained;
                // [NEW] Cập nhật Chuỗi Thắng
                challenger.winstreak = (challenger.winstreak || 0) + 1;
                
                // Nếu đối thủ là đệ tử thật (có trong list), trừ điểm và reset chuỗi
                if (gameData.disciples.find(d => d.id === opponent.id)) {
                    opponent.loiDaiPoints = Math.max(0, opponent.loiDaiPoints - 5);
                    opponent.winstreak = 0; // [NEW] Reset chuỗi của người thua
                }

                // [NEW] Phần thưởng thêm: NL, ĐCH và Item ngẫu nhiên
                const moneyReward = 50000;
                const contributionReward = 10;
                gameData.nganLuong += moneyReward;
                gameData.diemCongHien = (gameData.diemCongHien || 0) + contributionReward;

                let itemRewardMsg = '';
                if (Math.random() < 0.1) {
                    const pills = ['disciple_xp_pill_1', 'disciple_atk_pill_1', 'disciple_hp_pill_1', 'disciple_def_pill_1', 'disciple_spd_pill_1'];
                    const randomPill = pills[Math.floor(Math.random() * pills.length)];
                    addItem(randomPill, 1);
                    const pillDB = STATIC_ITEM_DB[randomPill];
                    if (pillDB) itemRewardMsg = `, nhận <span class="${getRarityClass(pillDB.rarity)}">${pillDB.name}</span>`;
                }

                logMsg = `<span class="font-bold text-white">${challenger.name}</span> đánh bại <span class="text-gray-400">${opponent.name}</span>. <span class="text-green-300">+${pointsGained} Điểm</span>, <span class="text-blue-300">+${XP_REWARD.toLocaleString()} XP</span>, <span class="text-yellow-300">+${moneyReward.toLocaleString()} NL</span>, <span class="text-lime-300">+${contributionReward} ĐCH</span>${itemRewardMsg}.`;
                
                addLoiDaiLog(logMsg, 'win');
            } else {
                // --- THUA ---
                const pointsLost = 5;
                challenger.loiDaiPoints = Math.max(0, challenger.loiDaiPoints - pointsLost);
                challenger.winstreak = 0; // [NEW] Reset chuỗi khi thua
                
                if (gameData.disciples.find(d => d.id === opponent.id)) {
                    opponent.loiDaiPoints = (opponent.loiDaiPoints || 0) + 5;
                    opponent.winstreak = (opponent.winstreak || 0) + 1; // [NEW] Đối thủ thắng khi phòng thủ thành công
                }
                
                logMsg = `<span class="font-bold text-white">${challenger.name}</span> thất bại trước <span class="text-gray-400">${opponent.name}</span>. <span class="text-red-400">-${pointsLost} Điểm</span>, <span class="text-blue-300">+${XP_REWARD.toLocaleString()} XP</span>.`;
                
                addLoiDaiLog(logMsg, 'loss');
            }
            
            return { success: true, msg: "Đấu xong", isWin: isWin };
        }

        /**
         * [NEW] Chức năng: Tự Động Khiêu Chiến (Nút Tự Động)
         */
        function autoLoiDaiChallenge() {
            const now = Date.now();
            // Lấy danh sách đệ tử rảnh và đã hồi chiêu
            const candidates = gameData.disciples.filter(d => 
                d.status === 'Nhàn Rỗi' && 
                (!d.lastLoiDaiFight || (now - d.lastLoiDaiFight >= 5 * 60 * 1000))
            );

            if (candidates.length === 0) {
                showToast("Không có đệ tử nào rảnh rỗi hoặc đã hồi chiêu!", false);
                return;
            }

            let fightCount = 0;
            const costPerFight = 100;

            // Cập nhật BXH mới nhất trước khi auto
            updateLoiDaiRankings(); 
            const rankings = gameData.sect.loiDaiRankings;

            candidates.forEach(challenger => {
                // Kiểm tra tiền
                if (gameData.linhThach < costPerFight) return;

                // Tìm vị trí hiện tại của đệ tử này trong BXH
                const myRankIdx = rankings.findIndex(r => r.id === challenger.id);

                let targetId = null;

                if (myRankIdx === -1) {
                    // Nếu chưa có hạng: Đánh thằng bét bảng
                    if (rankings.length > 0) {
                        targetId = rankings[rankings.length - 1].id;
                    } else {
                        // BXH trống trơn -> Đánh đại một thằng khác đang rảnh (nếu có) để vào BXH
                        const randomOp = candidates.find(c => c.id !== challenger.id);
                        if (randomOp) targetId = randomOp.id;
                    }
                } else if (myRankIdx === 0) {
                    // Đang Top 1: Bỏ qua (nghỉ ngơi)
                    targetId = null; 
                } else {
                    // Đã có hạng: Đánh thằng xếp ngay trên mình (index - 1) để leo rank
                    targetId = rankings[myRankIdx - 1].id;
                }

                if (targetId) {
                    const result = processLoiDaiFight(challenger.id, targetId, true);
                    if (result.success) {
                        fightCount++;
                    }
                }
            });

            if (fightCount > 0) {
                showToast(`Đã tự động thực hiện ${fightCount} trận đấu!`, true);
                updateAllDisciplesLoiDaiRank();
                updateUI();
                renderLoiDaiPanel();
            } else {
                if (gameData.linhThach < costPerFight) {
                    showToast("Không đủ Linh Thạch để auto!", false);
                } else {
                    showToast("Top 1 đang thư giãn, hoặc chưa tìm được đối thủ!", false);
                }
            }
        }

        /**
         * [NEW] Bắt đầu một trận Lôi Đài (Thủ công)
         */
        function startLoiDaiChallenge() {
            const cId = document.getElementById('loi-dai-challenger').value;
            const oId = document.getElementById('loi-dai-opponent').value;

            if (!cId || !oId) {
                showToast("Vui lòng chọn cả người khiêu chiến và đối thủ!", false); return;
            }

            if (cId === oId) {
                showToast("Không thể tự đánh chính mình!", false); return;
            }

            const result = processLoiDaiFight(cId, oId);
            
            if (!result.success) {
                showToast(result.msg, false);
            } else {
                if (result.isWin) {
                    showToast(`Chiến thắng!`, true);
                } else {
                    showToast(`Thất bại!`, false);
                }
                
                // Cập nhật Hạng
                updateAllDisciplesLoiDaiRank();
                
                // Cập nhật UI
                updateUI(); 
                renderLoiDaiPanel(); 
            }
        }
        
        /**
         * [NEW] Cập nhật Hạng Lôi Đài cho TẤT CẢ đệ tử dựa trên điểm
         * (Hàm này bị thiếu ở phiên bản trước)
         */
        function updateAllDisciplesLoiDaiRank() {
             if (!gameData.disciples) return;

             gameData.disciples.forEach(d => {
                 const points = d.loiDaiPoints || 0;
                 
                 if (points < 150) d.loiDaiRank = 1;       // Đồng Đoàn
                 else if (points < 250) d.loiDaiRank = 2;  // Bạc Đoàn
                 else if (points < 400) d.loiDaiRank = 3;  // Vàng Đoàn
                 else if (points < 600) d.loiDaiRank = 4;  // Bạch Kim
                 else if (points < 850) d.loiDaiRank = 5;  // Kim Cương
                 else if (points < 1200) d.loiDaiRank = 6; // Cao Thủ
                 else d.loiDaiRank = 7;                    // Thách Đấu
             });
        }

        // [NEW] --- Kinh Mạch Functions (UI Updated) ---
        function renderKinhMachPanel() {
            const panel = document.getElementById('panel-kinh-mach');
            if (!panel) return;

            // Đảm bảo dữ liệu tồn tại
            if (!gameData.player.kinhMach) gameData.player.kinhMach = {};

            const chanKhi = gameData.chanKhi || 0;

            let html = `<h4 class="text-lg font-bold text-cyan-400 mb-2 text-center">Kinh Mạch Đồ</h4>`;
            html += `<p class="text-center text-gray-400 mb-4 text-sm">Sử dụng <strong class="text-blue-300">Chân Khí</strong> để đả thông kinh mạch. Phải đả thông kinh mạch trước lên <strong class="text-yellow-300">Tầng 10</strong> mới mở được mạch kế tiếp.</p>`;
            
            // Hiển thị Chân Khí hiện có
            html += `
                <div class="bg-gray-800 p-2 rounded-lg mb-4 text-center max-w-xs mx-auto border border-blue-900">
                    <p class="text-sm text-gray-400">Chân Khí Hiện Có</p>
                    <!-- [MODIFIED] Thêm ID để update realtime -->
                    <p id="km-chankhi-display" class="text-2xl font-bold text-blue-300 text-shadow">${chanKhi.toLocaleString()}</p>
                </div>
            `;

            html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">`;
            
            // ... (Phần render danh sách mạch giữ nguyên) ...
            // [FIX] Bảng đối chiếu tên chỉ số đầy đủ
            const STAT_DISPLAY_NAMES = {
                'hp': 'Sinh Lực', 'atk': 'Công Kích', 'def': 'Phòng Thủ', 'spd': 'Thân Pháp', 'lck': 'May Mắn', 'mana': 'Nội Lực',
                'hp_p': 'Sinh Lực %', 'atk_p': 'Công Kích %', 'def_p': 'Phòng Thủ %', 'spd_p': 'Thân Pháp %', 'lck_p': 'May Mắn %', 'mana_p': 'Nội Lực %',
                'critChance': 'Chí Mạng %', 'critDamage': 'ST Bạo Kích %', 'dodgeChance': 'Né Tránh %', 'block_chance_p': 'Chống Đỡ %',
                'ignoreDef_p': 'Bỏ qua Thủ %', 'accuracy_p': 'Chính Xác %', 'anti_crit_p': 'Kháng Bạo %', 'anti_block_p': 'Phá Đỡ %',
                'lifesteal': 'Hút Máu %', 'manasteal': 'Hút Mana %', 'xp_boost': 'Kinh Nghiệm %'
            };

            // [MODIFIED] Lấy danh sách Key để duyệt tuần tự
            const kmKeys = Object.keys(KINH_MACH_DB);

            for (let i = 0; i < kmKeys.length; i++) {
                const kmId = kmKeys[i];
                const kmData = KINH_MACH_DB[kmId];
                const currentLevel = gameData.player.kinhMach[kmId] || 0;
                const maxLevel = 10; 
                const isMax = currentLevel >= maxLevel;

                // [NEW] Kiểm tra điều kiện mở khóa (Mạch trước đó phải Max)
                let isLocked = false;
                if (i > 0) {
                    const prevId = kmKeys[i - 1];
                    const prevLevel = gameData.player.kinhMach[prevId] || 0;
                    if (prevLevel < maxLevel) {
                        isLocked = true;
                    }
                }

                const cost = Math.floor(kmData.costBase * Math.pow(kmData.costMultiplier, currentLevel));
                const canAfford = chanKhi >= cost;

                let bonusText = "";
                let nextBonusText = "";
                
                for (const statKey in kmData.stats) {
                    let val = kmData.stats[statKey];
                    let displayKey = STAT_DISPLAY_NAMES[statKey] || statKey.toUpperCase().replace(/_/g, ' ');
                    const currentVal = val * currentLevel;
                    const nextVal = val * (currentLevel + 1);
                    const formatVal = (v) => Number.isInteger(v) ? v : v.toFixed(1);

                    bonusText += `<div class="flex justify-between"><span class="text-gray-400">${displayKey}:</span> <span class="text-green-400">+${formatVal(currentVal)}</span></div>`;
                    if (!isMax && !isLocked) {
                         nextBonusText += `<div class="flex justify-between text-xs"><span class="text-gray-500">${displayKey}:</span> <span class="text-yellow-500">+${formatVal(nextVal)}</span></div>`;
                    }
                }

                let buttonHtml = "";
                if (isLocked) {
                    // [NEW] Nút bị khóa
                    buttonHtml = `<button class="w-full bg-gray-800 text-gray-600 font-bold py-1 px-2 rounded border border-gray-700 cursor-not-allowed mt-2" disabled>
                        <i class="fa-solid fa-lock mr-1"></i>Cần Max Tầng Trước
                    </button>`;
                } else if (isMax) {
                    buttonHtml = `<button class="w-full bg-gray-600 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed mt-2">Đã Đả Thông</button>`;
                } else {
                    buttonHtml = `<button onclick="upgradeKinhMach('${kmId}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded mt-2 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        Đả Thông (${cost.toLocaleString()} CK)
                    </button>`;
                }

                const progressPercent = (currentLevel / maxLevel) * 100;
                
                // [NEW] Class mờ nếu bị khóa
                const cardOpacityClass = isLocked ? "opacity-50 grayscale" : "";

                html += `
                <div class="bg-black/20 backdrop-blur-sm border border-gray-700 p-3 rounded-lg flex flex-col justify-between hover:border-gray-500 transition duration-300 relative overflow-hidden group ${cardOpacityClass}">
                    <i class="${kmData.icon} absolute -bottom-4 -right-4 text-8xl opacity-5 ${kmData.color} group-hover:scale-110 transition-transform duration-500"></i>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <i class="${kmData.icon} text-2xl ${kmData.color}"></i>
                            <div>
                                <h5 class="font-bold text-gray-200">${kmData.name}</h5>
                                <p class="text-[10px] text-gray-400">Tầng ${currentLevel}/${maxLevel}</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-800 h-1.5 rounded-full mb-2 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full" style="width: ${progressPercent}%"></div>
                        </div>
                        <p class="text-xs text-gray-500 italic mb-2 h-8 line-clamp-2">${kmData.desc}</p>
                        <div class="bg-black/30 p-2 rounded text-xs space-y-0.5 mb-2">
                            ${currentLevel > 0 ? bonusText : '<span class="text-gray-500">Chưa kích hoạt</span>'}
                        </div>
                        ${!isMax && !isLocked ? `
                        <div class="border-t border-gray-700 pt-1 mt-1">
                             <p class="text-[10px] text-gray-400 mb-1">Hiệu quả tầng sau:</p>
                             ${nextBonusText}
                        </div>` : ''}
                    </div>
                    <div>${buttonHtml}</div>
                </div>
                `;
            }

            html += `</div>`;
            
            // [MODIFIED] Hình nhân vật ngồi thiền ở giữa - Nâng cấp thành Đan Điền Khí Hải active
            html += `
                <div class="mt-8 flex flex-col items-center justify-center group">
                    <div class="w-28 h-28 rounded-full border-4 border-blue-500/30 flex items-center justify-center bg-black/40 relative shadow-[0_0_20px_rgba(59,130,246,0.2)] overflow-hidden">
                        <!-- Hiệu ứng xoáy khí -->
                        <div class="absolute inset-0 bg-gradient-to-tr from-blue-600/20 to-transparent animate-spin-slow"></div>
                        
                        <!-- Icon người ngồi thiền -->
                        <i class="fa-solid fa-person-rays text-5xl text-blue-300 relative z-10 group-hover:scale-110 transition duration-500" style="filter: drop-shadow(0 0 10px #60a5fa);"></i>
                        
                        <!-- Hiệu ứng hạt năng lượng bay lên (Giả lập bằng chấm nhỏ) -->
                        <div class="absolute bottom-2 left-1/2 w-1 h-1 bg-blue-200 rounded-full animate-ping" style="animation-duration: 2s;"></div>
                    </div>
                    <h5 class="font-bold text-blue-300 mt-3 text-lg">Đan Điền Khí Hải</h5>
                    <div class="flex items-center gap-2 mt-1 bg-blue-900/30 px-3 py-1 rounded-full border border-blue-500/30">
                        <i class="fa-solid fa-infinity text-xs text-blue-400 animate-pulse"></i>
                        <p class="text-xs text-blue-200">Tự động tụ khí: <span class="text-white font-bold">30</span> / phút</p>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1 italic">(Hoạt động cả khi offline)</p>
                </div>
            `;

            panel.innerHTML = html;
        }

        // [NEW] Hàm xử lý nâng cấp Kinh Mạch
        function upgradeKinhMach(kmId) {
            if (!gameData.player.kinhMach) gameData.player.kinhMach = {};
            
            // [NEW] Kiểm tra điều kiện mở khóa (Mạch trước phải Max 10)
            const kmKeys = Object.keys(KINH_MACH_DB);
            const index = kmKeys.indexOf(kmId);
            if (index > 0) {
                const prevId = kmKeys[index - 1];
                const prevLevel = gameData.player.kinhMach[prevId] || 0;
                if (prevLevel < 10) {
                    showToast("Cần đả thông kinh mạch trước đó lên Đại Viên Mãn (Tầng 10)!", false);
                    return;
                }
            }
            
            const kmData = KINH_MACH_DB[kmId];
            const currentLevel = gameData.player.kinhMach[kmId] || 0;
            const maxLevel = 10;

            if (currentLevel >= maxLevel) {
                showToast("Kinh mạch này đã được đả thông hoàn toàn!", false);
                return;
            }

            const cost = Math.floor(kmData.costBase * Math.pow(kmData.costMultiplier, currentLevel));
            
            if (gameData.chanKhi < cost) {
                showToast("Không đủ Chân Khí!", false);
                return;
            }

            // Trừ chi phí
            gameData.chanKhi -= cost;
            
            // Tăng cấp
            gameData.player.kinhMach[kmId] = currentLevel + 1;

            // Hiệu ứng & Thông báo
            showToast(`Đả thông ${kmData.name} lên tầng ${currentLevel + 1} thành công!`, true);
            
            // Cập nhật UI
            renderKinhMachPanel();
            updateUI(); // Cập nhật hiển thị Chân Khí ở main screen
            
            // Lưu ý: Hàm getTotalStats cần được cập nhật ở bước sau để tính toán chỉ số từ gameData.player.kinhMach
            // Hiện tại đây chỉ là cập nhật về mặt hiển thị và dữ liệu.
        }
        // [END NEW] --- Kinh Mạch Functions ---

        // [NEW] --- Phó Bản Functions (Placeholder) ---
        /**
         * [NEW] Bắt đầu trận đấu Võ Đài
         */
        function startArenaBattle(opponentIndex) {
            const opponent = gameData.arena.opponents[opponentIndex];
            if (!opponent) return;

            // [FIX] Hồi phục 100% HP/Mana trước khi vào đấu trường để công bằng
            const stats = getTotalStats();
            gameData.player.currentHp = stats.hp;
            gameData.player.currentMana = stats.mana;

            // Chuẩn bị dữ liệu combat turn-based (tái sử dụng modal turn-based)
            
            // Tạo enemy object
            const arenaEnemy = {
                dbId: 'arena_npc', // ID này giờ đã tồn tại trong DB
                name: opponent.name,
                level: gameData.player.level, // NPC level = player level (giả lập)
                icon: 'fa-solid fa-user-ninja',
                stats: opponent.stats,
                currentHp: opponent.stats.hp,
                maxHp: opponent.stats.hp
            };

            // Chuẩn bị đồng hành (như hàm startTurnBasedCombat cũ)
            let companions = [];
            const equippedPetId = gameData.equippedSungVat;
            const championDiscipleId = gameData.sect.combatChampionId;

            if (equippedPetId) {
                const petInstance = gameData.sungVat.find(p => p.id === equippedPetId);
                const petDB = SUNG_VAT_DB[equippedPetId];
                if (petInstance && petDB) {
                    const petStats = getPetStats(petInstance);
                    companions.push({
                        type: 'pet',
                        id: petInstance.id,
                        name: petDB.name,
                        level: petInstance.level,
                        stats: petStats,
                        currentHp: petStats.hp, // [FIX] Đồng bộ HP Pet
                        maxHp: petStats.hp
                    });
                }
            }
            if (championDiscipleId) {
                const champ = gameData.disciples.find(d => d.id === championDiscipleId);
                if (champ && champ.status === 'Nhàn Rỗi') {
                    // [FIX] Sử dụng hàm calculateDiscipleStats để lấy chỉ số ĐẦY ĐỦ (bao gồm Thiên Phú)
                    const fullStats = calculateDiscipleStats(champ);

                    companions.push({
                        type: 'disciple',
                        id: champ.id,
                        name: champ.name,
                        level: champ.level,
                        stats: fullStats, // [FIX] Sử dụng fullStats thay vì champ.stats thô
                        currentHp: fullStats.hp, 
                        maxHp: fullStats.hp
                    });
                }
            }

            // Set combat state
            gameData.turnBasedCombat = {
                active: true,
                mapId: 'map_vo_dai', // ID đặc biệt cho Võ Đài
                enemy: arenaEnemy,
                companions: companions,
                log: [],
                playerTurn: true,
                arenaRewardPoints: opponent.rewardPoints // Lưu điểm thưởng tiềm năng
            };

            // UI transition
            hideModal('tong-mon-modal'); // Đóng tab tông môn nếu đang mở
            
            showModal('turn-based-combat-modal');
            addTurnBasedCombatLog(`Bước lên Võ Đài! Đối thủ: <span class="text-red-400">${opponent.name}</span>`, 'system');
            renderTurnBasedCombatUI();
        }

        /**
         * [NEW] Hiển thị tab Ám Ảnh Kiếm Ảnh (Khôi phục)
         */
        function renderPhoBanPanel() {
            const panel = document.getElementById('panel-pho-ban');
            if (!panel) return;

            const now = Date.now();
            let html = '<h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Phó Bản Tông Môn</h4>';
            
            // Tính toán tổng lực chiến
            const totalPower = calculateTotalSectAndPlayerPower();
            html += `<p class="text-sm text-gray-400 mb-4 text-center">Tập hợp Tông Chủ và 5 đệ tử mạnh nhất để khiêu chiến phó bản.<br> Tổng lực chiến đội của bạn: <strong class="text-yellow-300">${totalPower.toLocaleString()}</strong></p>`;
            html += '<div class="space-y-3">';

            const dungeons = Object.values(SECT_DUNGEON_DB);
            dungeons.sort((a,b) => a.powerReq - b.powerReq); // Sort by power

            dungeons.forEach(dungeon => {
                const cooldownTime = gameData.sect.dungeonCooldowns ? (gameData.sect.dungeonCooldowns[dungeon.id] || 0) : 0;
                const remainingMs = Math.max(0, cooldownTime - now);
                const hasEnoughPower = totalPower >= dungeon.powerReq;
                
                // [MODIFIED] Áp dụng style hiển thị tên giống Khiêu Chiến/Chiến Trường
                // Sử dụng rarity và icon mới thêm vào DB
                const rarityClass = getRarityClass(dungeon.rarity || 3); // Fallback rarity 3 (Rare - Purple)
                const iconClass = dungeon.icon || 'fa-solid fa-dungeon'; // Fallback icon

                let buttonHtml = '';
                if (remainingMs > 0) {
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    const hours = Math.floor(remainingSeconds / 3600);
                    const minutes = Math.floor((remainingSeconds % 3600) / 60);
                    const seconds = remainingSeconds % 60;
                    const remainingTimeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed">Hồi (${remainingTimeStr})</button>`;
                } else if (!hasEnoughPower) {
                     buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed" title="Cần ${dungeon.powerReq.toLocaleString()} Lực Chiến">Yêu cầu Lực Chiến</button>`;
                } else {
                    buttonHtml = `<button onclick="startSectDungeon('${dungeon.id}')" class="text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">Khiêu Chiến</button>`;
                }

                // Determine power color
                let powerColor = 'text-green-400'; // Easy
                if (totalPower < dungeon.powerReq * 0.75) {
                    powerColor = 'text-red-500'; // Very Hard
                } else if (totalPower < dungeon.powerReq) {
                    powerColor = 'text-orange-400'; // Hard
                } else if (totalPower < dungeon.powerReq * 1.5) {
                    powerColor = 'text-yellow-300'; // Normal
                }

                let rewardItemName = 'Vật phẩm hiếm';
                let rewardAmount = dungeon.rewards.materialAmount || 1;

                if (dungeon.rewards.rewardType === 'generated_equipment') {
                    const qualityName = QUALITY_DB[dungeon.rewards.quality]?.name || 'Trang bị';
                    rewardItemName = `${rewardAmount} x Trang Bị [${qualityName}] (Cấp ${dungeon.rewards.level})`;
                } else if (dungeon.rewards.material) {
                    const rewardItem = MATERIALS_DB[dungeon.rewards.material] || STATIC_ITEM_DB[dungeon.rewards.material];
                    rewardItemName = rewardItem ? `${rewardAmount} x ${rewardItem.name}` : 'Vật phẩm hiếm';
                }

                html += `
                <div class="bg-gray-700 p-3 rounded shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <!-- [MODIFIED] Hiển thị tên với icon và màu sắc theo phẩm chất -->
                            <p class="font-bold text-base ${rarityClass}"><i class="${iconClass} mr-2"></i>${dungeon.name}</p>
                            <p class="text-sm text-gray-300">${dungeon.desc}</p>
                            <p class="text-xs text-gray-400 mt-1">Yêu cầu LC: <span class="font-bold ${powerColor}">${dungeon.powerReq.toLocaleString()}</span></p>
                            <p class="text-xs text-cyan-300 mt-1">Thưởng: ${dungeon.rewards.diemCongHien} ĐCH, ${dungeon.rewards.linhKhi.toLocaleString()} Linh Khí, ${rewardItemName}</p>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
                `;
            });

            html += '</div>';
            panel.innerHTML = html;
        }

        /**
         * [NEW] Tính tổng lực chiến của Tông Chủ và 5 đệ tử mạnh nhất
         */
        function calculateTotalSectAndPlayerPower() {
            // 1. Tính lực chiến Tông Chủ
            const playerStats = getTotalStats();
            // Công thức LC Tông Chủ: (HP/10) + (ATK*5) + (DEF*3) + (SPD*3)
            let playerPower = (playerStats.hp / 5) + (playerStats.atk * 5) + (playerStats.def * 3) + (playerStats.spd * 3);
            playerPower = Math.floor(playerPower * (1 + (playerStats.critChance / 100)) * (playerStats.critDamage / 150)); // Thêm bonus chí mạng

            // 2. Lấy 5 đệ tử mạnh nhất
            const disciplesPower = gameData.disciples.map(d => {
                // [MODIFIED] Sử dụng hàm tính chỉ số đầy đủ (bao gồm Thiên Phú)
                const stats = calculateDiscipleStats(d);
                const basePower = (stats.hp / 5) + (stats.atk * 5) + ((stats.def || 0) * 3) + ((stats.spd || 0) * 3);
                const levelMultiplier = (d.level / 10) + 1;
                return Math.floor(basePower * levelMultiplier);
            });
            
            disciplesPower.sort((a, b) => b - a); // Sắp xếp giảm dần
            const top5DisciplesPower = disciplesPower.slice(0, 5).reduce((sum, power) => sum + power, 0);

            return Math.floor(playerPower + top5DisciplesPower);
        }

        /**
         * [NEW] Bắt đầu khiêu chiến Phó Bản Tông Môn
         */
        function startSectDungeon(dungeonId) {
            const dungeon = SECT_DUNGEON_DB[dungeonId];
            if (!dungeon) {
                showToast("Lỗi: Không tìm thấy phó bản!", false); return;
            }

            const totalPower = calculateTotalSectAndPlayerPower();
            
            // 1. Check requirements
            if (totalPower < dungeon.powerReq) {
                 showToast(`Cần ${dungeon.powerReq.toLocaleString()} Lực Chiến để khiêu chiến!`, false); 
                 return;
            }

            // 2. Check cooldown
            const now = Date.now();
            const cooldownTime = gameData.sect.dungeonCooldowns ? (gameData.sect.dungeonCooldowns[dungeon.id] || 0) : 0;
            if (now < cooldownTime) {
                showToast("Phó bản đang trong thời gian hồi!", false); return;
            }

            // 3. Determine outcome (Tương tự Khiêu Chiến Tông Môn)
            let winChance = Math.min(95, Math.max(5, (totalPower / dungeon.powerReq) * 50));
            const roll = Math.random() * 100;

            let logMsg = `[Phó Bản] Tổ đội (LC: ${totalPower.toLocaleString()}) khiêu chiến ${dungeon.name} (LC: ${dungeon.powerReq.toLocaleString()})... (Tỷ lệ thắng: ${winChance.toFixed(0)}%)`;
            addSectLog(logMsg, 'info');

            // 4. Set Cooldown (regardless of win/loss)
            if (!gameData.sect.dungeonCooldowns) gameData.sect.dungeonCooldowns = {};
            gameData.sect.dungeonCooldowns[dungeon.id] = now + dungeon.cooldown;

            // 5. Resolve
            if (roll <= winChance) {
                // VICTORY
                const rewards = dungeon.rewards;
                gameData.diemCongHien = (gameData.diemCongHien || 0) + rewards.diemCongHien;
                gameData.linhKhi = (gameData.linhKhi || 0) + rewards.linhKhi;
                
                // [MODIFIED] Check new reward type
                let rewardItemName = 'Vật phẩm';
                let rewardAmount = rewards.materialAmount || 1;

                if (rewards.rewardType === 'generated_equipment') {
                    // [NEW] Logic to generate equipment
                    let itemsAdded = 0;
                    for (let i = 0; i < rewardAmount; i++) {
                        if (countInventorySlots() >= MAX_INVENTORY_SLOTS) {
                            addSectLog(`Hành trang đầy, không thể nhận thêm trang bị!`, 'error');
                            break;
                        }
                        // Use generateEquipment(monsterLevel, forceQuality = null, forceType = null)
                        const newItem = generateEquipment(rewards.level, rewards.quality, null);
                        gameData.gearInventory.push(newItem);
                        itemsAdded++;
                        rewardItemName = newItem.name; // Name of the last item generated
                    }
                    if (itemsAdded > 0) {
                        rewardAmount = itemsAdded; // Update amount to reflect what was actually added
                        if (itemsAdded > 1) {
                             rewardItemName = `Trang Bị Siêu Thần`; // Generic name if multiple
                        }
                    } else {
                         rewardItemName = 'Hành Trang Đầy';
                         rewardAmount = 0;
                    }

                } else {
                    // [EXISTING] Logic for materials/static items
                    const itemDB_Material = MATERIALS_DB[rewards.material];
                    const itemDB_Static = STATIC_ITEM_DB[rewards.material];
                    
                    if (itemDB_Material) {
                        addMaterial(rewards.material, rewardAmount, 'sect_dungeon');
                        rewardItemName = itemDB_Material.name;
                    } else if (itemDB_Static) {
                        addItem(rewards.material, rewardAmount, 'sect_dungeon');
                        rewardItemName = itemDB_Static.name;
                    }
                }
                // [END MODIFIED]

                const rewardMsg = `Khiêu chiến ${dungeon.name} THẮNG LỢI! Nhận ${rewards.diemCongHien} ĐCH, ${rewards.linhKhi.toLocaleString()} Linh Khí, và ${rewardAmount > 0 ? `${rewardAmount} x ${rewardItemName}` : 'không có vật phẩm (Hành trang đầy)'}.`;
                addSectLog(rewardMsg, 'reward');
                showToast(rewardMsg, true);
            } else {
                // DEFEAT
                const defeatMsg = `Khiêu chiến ${dungeon.name} THẤT BẠI! Hãy mạnh hơn và thử lại sau.`;
                addSectLog(defeatMsg, 'error');
                showToast(defeatMsg, false);
            }
            
            // 6. Re-render
            renderPhoBanPanel(); // Cập nhật lại tab để hiển thị cooldown
            updateUI(); // Cập nhật currencies
        }
        // [END NEW] --- Phó Bản Functions ---

        // [MODIFIED] --- Chiến Trường Functions ---
        /**
         * [NEW] Hiển thị tab Chiến Trường Tông Môn
         */
        function renderChienTruongPanel() {
            const panel = document.getElementById('panel-chien-truong');
            if (!panel) return;

            const now = Date.now();
            let html = '<h4 class="text-lg font-bold text-cyan-400 mb-4 text-center">Chiến Trường Tông Môn</h4>';
            
            // Tính toán tổng lực chiến
            const totalPower = calculateTotalSectAndPlayerPower();
            html += `<p class="text-sm text-gray-400 mb-4 text-center">Tham gia chiến trường để nhận Điểm Tích Lũy Tống Kim và các phần thưởng khác.<br> Tổng lực chiến đội của bạn: <strong class="text-yellow-300">${totalPower.toLocaleString()}</strong></p>`;
            html += '<div class="space-y-3">';

            const battlefields = Object.values(CHIEN_TRUONG_DB);
            battlefields.sort((a,b) => a.powerReq - b.powerReq); // Sort by power

            battlefields.forEach(bf => {
                const cooldownTime = gameData.sect.chienTruongCooldowns ? (gameData.sect.chienTruongCooldowns[bf.id] || 0) : 0;
                const remainingMs = Math.max(0, cooldownTime - now);
                const hasEnoughPower = totalPower >= bf.powerReq;
                
                let buttonHtml = '';
                if (remainingMs > 0) {
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    // Hiển thị giờ:phút:giây
                    const hours = Math.floor(remainingSeconds / 3600);
                    const minutes = Math.floor((remainingSeconds % 3600) / 60);
                    const seconds = remainingSeconds % 60;
                    const remainingTimeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed">Hồi (${remainingTimeStr})</button>`;
                } else if (!hasEnoughPower) {
                     buttonHtml = `<button class="text-xs bg-gray-500 text-white font-bold py-1 px-2 rounded opacity-50 cursor-not-allowed" title="Cần ${bf.powerReq.toLocaleString()} Lực Chiến">Yêu cầu Lực Chiến</button>`;
                } else {
                    buttonHtml = `<button onclick="startChienTruongChallenge('${bf.id}')" class="text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">Tham Chiến</button>`;
                }

                // Determine power color
                let powerColor = 'text-green-400';
                if (totalPower < bf.powerReq * 0.75) powerColor = 'text-red-500';
                else if (totalPower < bf.powerReq) powerColor = 'text-orange-400';
                else if (totalPower < bf.powerReq * 1.5) powerColor = 'text-yellow-300';

                html += `
                <div class="bg-gray-700 p-3 rounded shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-base ${getRarityClass(bf.rarity)}"><i class="${bf.icon} mr-2"></i>${bf.name}</p>
                            <p class="text-sm text-gray-300">${bf.desc}</p>
                            <p class="text-xs text-gray-400 mt-1">Yêu cầu LC: <span class="font-bold ${powerColor}">${bf.powerReq.toLocaleString()}</span></p>
                            <p class="text-xs text-cyan-300 mt-1">Thưởng: ${bf.rewards.diemTichLuyTongKim} Điểm TK, ${bf.rewards.nganLuong.toLocaleString()} NL, ${bf.rewards.danhVong} Danh Vọng</p>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            ${buttonHtml}
                        </div>
                    </div>
                </div>
                `;
            });

            html += '</div>';
            panel.innerHTML = html;
        }

        /**
         * [NEW] Bắt đầu khiêu chiến Chiến Trường
         */
        function startChienTruongChallenge(battlefieldId) {
            const bf = CHIEN_TRUONG_DB[battlefieldId];
            if (!bf) {
                showToast("Lỗi: Không tìm thấy chiến trường!", false); return;
            }

            const totalPower = calculateTotalSectAndPlayerPower();
            
            if (totalPower < bf.powerReq) {
                 showToast(`Cần ${bf.powerReq.toLocaleString()} Lực Chiến để tham chiến!`, false); 
                 return;
            }

            const now = Date.now();
            const cooldownTime = gameData.sect.chienTruongCooldowns ? (gameData.sect.chienTruongCooldowns[bf.id] || 0) : 0;
            if (now < cooldownTime) {
                showToast("Chiến trường đang trong thời gian hồi!", false); return;
            }

            // Tính toán kết quả
            let winChance = Math.min(95, Math.max(5, (totalPower / bf.powerReq) * 50));
            const roll = Math.random() * 100;

            let logMsg = `[Chiến Trường] Tổ đội (LC: ${totalPower.toLocaleString()}) tham chiến ${bf.name} (LC: ${bf.powerReq.toLocaleString()})... (Tỷ lệ thắng: ${winChance.toFixed(0)}%)`;
            addSectLog(logMsg, 'info');

            // Đặt cooldown
            if (!gameData.sect.chienTruongCooldowns) gameData.sect.chienTruongCooldowns = {};
            gameData.sect.chienTruongCooldowns[bf.id] = now + bf.cooldown;

            if (roll <= winChance) {
                // VICTORY
                const rewards = bf.rewards;
                gameData.diemTichLuyTongKim = (gameData.diemTichLuyTongKim || 0) + rewards.diemTichLuyTongKim;
                gameData.nganLuong += rewards.nganLuong;
                gameData.danhVong = (gameData.danhVong || 0) + rewards.danhVong;

                const rewardMsg = `Chiến thắng ${bf.name}! Nhận ${rewards.diemTichLuyTongKim} Điểm TK, ${rewards.nganLuong.toLocaleString()} NL, ${rewards.danhVong} Danh Vọng.`;
                addSectLog(rewardMsg, 'reward');
                showToast(rewardMsg, true);
            } else {
                // DEFEAT
                const nlLoss = Math.floor(bf.rewards.nganLuong * 0.1); // Lose 10%
                gameData.nganLuong = Math.max(0, gameData.nganLuong - nlLoss);

                const defeatMsg = `Thất bại tại ${bf.name}! Mất ${nlLoss.toLocaleString()} NL.`;
                addSectLog(defeatMsg, 'error');
                showToast(defeatMsg, false);
            }
            
            // Re-render
            renderChienTruongPanel();
            updateUI();
        }
        // [END NEW] --- Chiến Trường Functions ---

        <!-- [NEW] --- Vong Quay (Lucky Wheel) Functions --- -->
        let isSpinning = false;
        
        // Map visual grid positions (0-8) to DB index (0-7)
        // Grid Indices:
        // 0 1 2
        // 7 C 3
        // 6 5 4
        // 'C' is center button (index 4 in a flat 9-grid, but we skip it for rewards)
        const GRID_ORDER = [0, 1, 2, 5, 8, 7, 6, 3]; // These are the DOM indices of the cells in the grid container
        
        function renderVongQuayModal() {
            const gridContainer = document.getElementById('vong-quay-grid');
            const ticketCountEl = document.getElementById('vong-quay-tickets');
            const spin10Btn = document.getElementById('vong-quay-spin-10-btn');
            const resultEl = document.getElementById('vong-quay-result');

            const tickets = gameData.materials['luot_quay_may_man'] || 0;
            ticketCountEl.textContent = tickets.toLocaleString();
            
            if (!isSpinning) {
                 if (resultEl) resultEl.innerHTML = '';
            }

            // Enable/Disable 10x button
            if (spin10Btn) {
                if (isSpinning || tickets < 10) {
                     spin10Btn.disabled = true;
                     spin10Btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                     spin10Btn.disabled = false;
                     spin10Btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // Generate 3x3 Grid
            // Positions:
            // 0: DB[0] | 1: DB[1] | 2: DB[2]
            // 3: DB[7] | 4: BUTTON | 5: DB[3]
            // 6: DB[6] | 7: DB[5] | 8: DB[4]
            
            // Mapping from DOM index (0-8) to DB index (0-7)
            // We want clockwise: 0,1,2 -> 3,4,5(bottom) -> 6,7(left)
            // Let's map DB indices to visual slots:
            // DB[0] -> Slot 0 (Top-Left)
            // DB[1] -> Slot 1 (Top-Mid)
            // DB[2] -> Slot 2 (Top-Right)
            // DB[3] -> Slot 5 (Mid-Right)
            // DB[4] -> Slot 8 (Bot-Right)
            // DB[5] -> Slot 7 (Bot-Mid)
            // DB[6] -> Slot 6 (Bot-Left)
            // DB[7] -> Slot 3 (Mid-Left)
            // Center -> Slot 4
            
            const dbMapping = {
                0: 0, 1: 1, 2: 2,
                3: 7,       5: 3,
                6: 6, 7: 5, 8: 4
            };

            let html = '';
            for (let i = 0; i < 9; i++) {
                if (i === 4) {
                    // Center Button
                    const canSpin = !isSpinning && tickets >= 1;
                    html += `
                        <div class="lucky-center-btn ${!canSpin ? 'disabled' : ''}" onclick="spinWheel(1)">
                            <span class="text-lg font-bold text-white">QUAY</span>
                            <span class="text-[10px] text-yellow-100 font-bold">-1 Vé</span>
                        </div>
                    `;
                } else {
                    const dbIndex = dbMapping[i];
                    const reward = VONG_QUAY_DB[dbIndex];
                    html += `
                        <div id="lucky-cell-${i}" class="lucky-cell">
                            <i class="fa-solid ${reward.icon} ${reward.color}"></i>
                            <span class="${reward.color} font-bold leading-tight">${reward.name}</span>
                        </div>
                    `;
                }
            }
            gridContainer.innerHTML = html;
        }

        function spinWheel(amount = 1) { 
            if (isSpinning) return;

            const tickets = gameData.materials['luot_quay_may_man'] || 0;
            if (tickets < amount) {
                showToast(`Bạn không đủ ${amount} Lượt Quay!`, false);
                return;
            }
            
            // --- 10x SPIN (Instant Results) ---
            if (amount > 1) {
                gameData.materials['luot_quay_may_man'] -= amount;
                
                let summary = {};
                let spinsGained = 0;
                let rewardsHtml = '';

                for (let i = 0; i < amount; i++) {
                    const rewardIndex = Math.floor(Math.random() * VONG_QUAY_DB.length);
                    const reward = VONG_QUAY_DB[rewardIndex];
                    const rewardResult = grantSpinReward(reward, true);

                    summary[rewardResult.name] = (summary[rewardResult.name] || 0) + 1;
                    if (rewardResult.type === 'spin_again') spinsGained++;
                }

                if (spinsGained > 0) {
                    gameData.materials['luot_quay_may_man'] = (gameData.materials['luot_quay_may_man'] || 0) + spinsGained;
                }

                rewardsHtml = 'Kết quả 10 lần:<br>';
                for (const name in summary) {
                    rewardsHtml += `- ${name}: ${summary[name]} lần<br>`;
                }
                
                document.getElementById('vong-quay-result').innerHTML = '<span class="text-green-400">Đã quay xong!</span>';
                showToast(rewardsHtml, true); // Note: HTML in toast might show as text depending on implementation, simplified here.
                addTrainingLog(rewardsHtml.replace(/<br>/g, ', '), 'reward'); // Log it

                renderVongQuayModal(); 
                updateUI(); 
                return;
            }

            // --- 1x SPIN (Animation) ---
            isSpinning = true;
            gameData.materials['luot_quay_may_man'] -= 1;
            renderVongQuayModal(); // Disable buttons

            const resultEl = document.getElementById('vong-quay-result');
            if (resultEl) resultEl.textContent = "Đang quay...";

            // Determine Reward beforehand
            const rewardIndex = Math.floor(Math.random() * VONG_QUAY_DB.length);
            const reward = VONG_QUAY_DB[rewardIndex];
            
            // Map DB index to Grid DOM ID
            // DB Mapping Reverse: 0->0, 1->1, 2->2, 3->5, 4->8, 5->7, 6->6, 7->3
            const targetGridIndex = [0, 1, 2, 5, 8, 7, 6, 3][rewardIndex];
            
            // Animation Variables
            let currentIndex = 0; // Index in GRID_ORDER array
            let speed = 100; // Initial speed (ms)
            let steps = 0;
            const minSteps = 24; // At least 3 full circles (8 * 3)
            // Add random extra steps to land on target
            // We need (steps % 8) to match the target position in GRID_ORDER
            // target pos in GRID_ORDER:
            const targetOrderIndex = GRID_ORDER.indexOf(targetGridIndex);
            const totalSteps = minSteps + targetOrderIndex + (8 * Math.floor(Math.random() * 2)); 
            
            const runAnimation = () => {
                // Clear previous active
                document.querySelectorAll('.lucky-cell').forEach(el => el.classList.remove('active'));
                
                // Highlight current
                const cellId = GRID_ORDER[currentIndex];
                const cell = document.getElementById(`lucky-cell-${cellId}`);
                if(cell) cell.classList.add('active');

                steps++;
                
                if (steps > totalSteps) {
                    // STOP
                    isSpinning = false;
                    grantSpinReward(reward);
                    renderVongQuayModal();
                } else {
                    // Continue
                    currentIndex = (currentIndex + 1) % 8;
                    
                    // Slow down logic
                    if (steps > totalSteps - 8) {
                        speed += 50; // Slow down near end
                    } else if (steps < 5) {
                         // Start slow? No, usually start fast or ramp up. Let's keep constant then slow.
                    }
                    
                    setTimeout(runAnimation, speed);
                }
            };

            runAnimation();
        }

        function grantSpinReward(reward, isBatch = false) { // [MODIFIED] Thêm 'isBatch'
            const resultEl = document.getElementById('vong-quay-result');
            let message = '';
            let showSuccessToast = true; // [NEW]
            
            switch (reward.type) {
                case 'currency':
                    gameData[reward.currency] = (gameData[reward.currency] || 0) + reward.value;
                    message = `Chúc mừng! Bạn nhận được ${reward.name}!`;
                    if (!isBatch) showToast(message, true);
                    if (!isBatch) updateUI(); // [MODIFIED] Chỉ update UI chính nếu quay 1 lần
                    break;
                case 'material':
                    addMaterial(reward.itemId, reward.value, 'vong_quay');
                    message = `Chúc mừng! Bạn nhận được ${reward.name}!`;
                    if (!isBatch) showToast(message, true);
                    break;
                case 'spin_again':
                    gameData.materials['luot_quay_may_man'] = (gameData.materials['luot_quay_may_man'] || 0) + 1;
                    message = `Bạn nhận được ${reward.name}!`;
                    if (!isBatch) showToast(message, true);
                    break;
                case 'nothing':
                    message = `Rất tiếc! Chúc bạn may mắn lần sau.`;
                    showSuccessToast = false; // [MODIFIED]
                    if (!isBatch) showToast(message, false);
                    break;
                case 'generated_equipment':
                    if (countInventorySlots() >= MAX_INVENTORY_SLOTS) {
                         message = `Bạn quay trúng Trang Bị, nhưng Hành trang đầy!`;
                         showSuccessToast = false; // [MODIFIED]
                         if (!isBatch) showToast(message, false);
                    } else {
                        const level = Math.floor(Math.random() * (reward.level[1] - reward.level[0] + 1)) + reward.level[0];
                        // (forceQuality, forceType=null)
                        const newItem = generateEquipment(level, reward.quality, null); 
                        gameData.gearInventory.push(newItem);
                        const quality = QUALITY_DB[newItem.quality];
                        message = `Chúc mừng! Nhận được <span class="${quality.className}">${newItem.name}</span>!`;
                        if (!isBatch) showToast(message, true);
                        
                        // [MODIFIED] Chỉ render hành trang nếu quay 1 lần và đang mở
                        if (!isBatch && !document.getElementById('equipment-modal').classList.contains('hidden')) {
                            renderCollectionList('equipment');
                        }
                    }
                    break;
            }
            
            // [MODIFIED] Xử lý UI dựa trên 'isBatch'
            if (!isBatch) {
                if (resultEl) resultEl.innerHTML = message;
            }
            
            return { name: reward.name, type: reward.type }; // [NEW] Trả về kết quả để xử lý batch
        }
        <!-- [END NEW] --- Vong Quay Functions --- -->

        <!-- [NEW] --- Khe Nut Thoi Khong Functions --- -->
        function renderKheNutList() {
            const listContainer = document.getElementById('khe-nut-list');
            if (!listContainer) return;

            // [MODIFIED] Render the actual map entry
            listContainer.innerHTML = `
                <div class="bg-gray-700 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-gray-600 transition duration-200">
                    <div class="flex-grow">
                        <h4 class="font-bold text-xl text-yellow-300">
                            <i class="fa-solid fa-book-open mr-2"></i>Đấu La Đại Lục
                        </h4>
                        <p class="text-sm text-gray-300 mt-1">Một thế giới nơi Võ Hồn là tất cả. (Hệ thống: Hồn Kỹ & Hồn Lực)</p>
                        <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 1+</p>
                    </div>
                    <button onclick="showModal('dauladailuc-modal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0">
                        Tiến vào
                    </button>
                </div>
                <!-- [NEW] Tu Chan Gioi Entry -->
                <div class="bg-gray-700 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-gray-600 transition duration-200 mt-4">
                    <div class="flex-grow">
                        <h4 class="font-bold text-xl text-green-300">
                            <i class="fa-solid fa-scroll mr-2"></i>Tu Chân Giới
                        </h4>
                        <p class="text-sm text-gray-300 mt-1">Một thế giới tu tiên, luyện khí, sử dụng Pháp Bảo. (Hệ thống: Pháp Bảo & Linh Khí)</p>
                        <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 3+</p>
                    </div>
                    <button onclick="showModal('tuchangioi-modal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0">
                        Tiến vào
                    </button>
                </div>
                <!-- [NEW] Kiem The Gioi (Kiem The World) Entry -->
                <div class="bg-gray-700 rounded-lg p-4 flex flex-col sm:flex-row items-center justify-between gap-3 shadow-lg hover:bg-gray-600 transition duration-200 mt-4">
                    <div class="flex-grow">
                        <h4 class="font-bold text-xl text-yellow-400">
                            <i class="fa-solid fa-swords mr-2"></i>Kiếm Thế Giới
                        </h4>
                        <p class="text-sm text-gray-300 mt-1">Thế giới của chiến trường Tống Kim và 12 Môn Phái. (Hệ thống: Võ Công & Nội Công)</p>
                        <p class="text-xs text-cyan-300 mt-1">Cấp độ đề nghị: 5+</p>
                    </div>
                    <button onclick="showModal('kiemthe-modal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full sm:w-auto flex-shrink-0">
                        Tiến vào
                    </button>
                </div>
            `;
        }
        <!-- [END NEW] --- Khe Nut Thoi Khong Functions --- -->

        <!-- [NEW] --- Dau La Dai Luc (Turn-Based) Functions --- -->

        // [MODIFIED] Renders the sub-map list for Dau La Dai Luc dynamically
        function renderDauLaDaiLucModal() {
            const listContainer = document.getElementById('dll-map-list-container'); // [MODIFIED] Target new ID
            if (!listContainer) return;

            const playerLevel = gameData.player.level;
            let html = '';

            for (const mapId in DAULADAILUC_MAPS_DB) {
                const map = DAULADAILUC_MAPS_DB[mapId];
                const isUnlocked = playerLevel >= map.levelReq;
                // [FIX] Bỏ qua TẤT CẢ các map không phải ĐLĐL
                if (map.isTuChanGioi || map.isKiemTheGioi || map.isThonPheTinhKhong) continue;

                if (isUnlocked) {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3">
                        <div>
                            <h4 class="font-bold text-lg text-yellow-300">${map.name}</h4>
                            <p class="text-xs text-gray-300">${map.desc}</p>
                        </div>
                        <button onclick="startTurnBasedCombat('${mapId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm">
                            Khiêu chiến
                        </button>
                    </div>
                    `;
                } else {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3 opacity-50">
                        <div>
                            <h4 class="font-bold text-lg text-gray-500">${map.name} (Chưa mở)</h4>
                            <p class="text-xs text-gray-400">Yêu cầu: Cấp ${map.levelReq}</p>
                        </div>
                        <button class="bg-gray-500 text-white font-bold py-2 px-3 rounded text-sm cursor-not-allowed" disabled>
                            Bị khóa
                        </button>
                    </div>
                    `;
                }
            }
            listContainer.innerHTML = html;
        }

        // [NEW] Renders the sub-map list for Tu Chan Gioi
        function renderTuChanGioiModal() {
            const listContainer = document.getElementById('tcg-map-list-container');
            if (!listContainer) return;

            const playerLevel = gameData.player.level;
            let html = '';

            for (const mapId in DAULADAILUC_MAPS_DB) {
                const map = DAULADAILUC_MAPS_DB[mapId];
                // Only show maps for Tu Chan Gioi
                if (!map.isTuChanGioi) continue;

                const isUnlocked = playerLevel >= map.levelReq;

                if (isUnlocked) {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3">
                        <div>
                            <h4 class="font-bold text-lg text-yellow-300">${map.name}</h4>
                            <p class="text-xs text-gray-300">${map.desc}</p>
                        </div>
                        <button onclick="startTurnBasedCombat('${mapId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm uppercase tracking-wide">
                            Khiêu Chiến
                        </button>
                    </div>
                    `;
                } else {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3 opacity-50">
                        <div>
                            <h4 class="font-bold text-lg text-gray-500">${map.name} (Chưa mở)</h4>
                            <p class="text-xs text-gray-400">Yêu cầu: Cấp ${map.levelReq}</p>
                        </div>
                        <button class="bg-gray-500 text-white font-bold py-2 px-3 rounded text-sm cursor-not-allowed uppercase tracking-wide" disabled>
                            Bị Khóa
                        </button>
                    </div>
                    `;
                }
            }
            listContainer.innerHTML = html;
        }
        
        // [NEW] Renders the sub-map list for Kiem The Gioi
        function renderKiemTheModal() {
            const listContainer = document.getElementById('ktg-map-list-container');
            if (!listContainer) return;

            const playerLevel = gameData.player.level;
            let html = '';

            for (const mapId in DAULADAILUC_MAPS_DB) {
                const map = DAULADAILUC_MAPS_DB[mapId];
                // Only show maps for Kiem The Gioi
                if (!map.isKiemTheGioi) continue;

                const isUnlocked = playerLevel >= map.levelReq;

                if (isUnlocked) {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3">
                        <div>
                            <h4 class="font-bold text-lg text-yellow-300">${map.name}</h4>
                            <p class="text-xs text-gray-300">${map.desc}</p>
                        </div>
                        <button onclick="startTurnBasedCombat('${mapId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm uppercase tracking-wide">
                            Khiêu Chiến
                        </button>
                    </div>
                    `;
                } else {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3 opacity-50">
                        <div>
                            <h4 class="font-bold text-lg text-gray-500">${map.name} (Chưa mở)</h4>
                            <p class="text-xs text-gray-400">Yêu cầu: Cấp ${map.levelReq}</p>
                        </div>
                        <button class="bg-gray-500 text-white font-bold py-2 px-3 rounded text-sm cursor-not-allowed uppercase tracking-wide" disabled>
                            Bị Khóa
                        </button>
                    </div>
                    `;
                }
            }
            listContainer.innerHTML = html;
        }

        // [NEW] Renders the sub-map list for Tu Chan Gioi
        function renderTuChanGioiModal() {
            const listContainer = document.getElementById('tcg-map-list-container');
            if (!listContainer) return;

            const playerLevel = gameData.player.level;
            let html = '';

            for (const mapId in DAULADAILUC_MAPS_DB) {
                const map = DAULADAILUC_MAPS_DB[mapId];
                // Only show maps for Tu Chan Gioi
                if (!map.isTuChanGioi) continue;

                const isUnlocked = playerLevel >= map.levelReq;

                if (isUnlocked) {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3">
                        <div>
                            <h4 class="font-bold text-lg text-yellow-300">${map.name}</h4>
                            <p class="text-xs text-gray-300">${map.desc}</p>
                        </div>
                        <button onclick="startTurnBasedCombat('${mapId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm">
                            Khiêu chiến
                        </button>
                    </div>
                    `;
                } else {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3 opacity-50">
                        <div>
                            <h4 class="font-bold text-lg text-gray-500">${map.name} (Chưa mở)</h4>
                            <p class="text-xs text-gray-400">Yêu cầu: Cấp ${map.levelReq}</p>
                        </div>
                        <button class="bg-gray-500 text-white font-bold py-2 px-3 rounded text-sm cursor-not-allowed" disabled>
                            Bị khóa
                        </button>
                    </div>
                    `;
                }
            }
            listContainer.innerHTML = html;
        }

        // [NEW] Starts the turn-based combat
        function startTurnBasedCombat(mapId) {
            const mapDB = DAULADAILUC_MAPS_DB[mapId];
            if (!mapDB) {
                showToast("Lỗi: Không tìm thấy bản đồ!", false);
                return;
            }

            // 1. Stop other activities
            // [REMOVED] Xóa logic dừng Luyện Công
            /*
            if (gameData.isTraining) {
                stopTraining();
                showToast("Đã dừng Luyện Công để bắt đầu chiến đấu.", "info");
            }
            */
            // [MODIFIED] User wants to allow idle actions while in turn-based combat
            /*
            if (gameData.isIdling) {
                stopIdleAction();
                showToast("Đã dừng hoạt động Idle (Câu cá/Đào khoáng) để bắt đầu chiến đấu.", "info");
            }
            */
            
            // 2. Select an enemy
            const enemyId = mapDB.enemies[Math.floor(Math.random() * mapDB.enemies.length)];
            const enemyDB = DAULADAILUC_ENEMIES_DB[enemyId];
            if (!enemyDB) {
                showToast("Lỗi: Không tìm thấy quái vật cho bản đồ này!", false);
                return;
            }

            // 3. Initialize combat state
            // [MODIFIED] Check if map is TuChanGioi to adjust UI/mechanics
            const isTuChanGioi = mapDB.isTuChanGioi || false;
            // [NEW] Check for Kiem The Gioi
            const isKiemTheGioi = mapDB.isKiemTheGioi || false;

            // [NEW] Find and prepare the companion (Pet > Disciple)
            // [MODIFIED] Logic mới: Cho phép cả Pet và Đệ tử cùng tham gia
            let companions = []; // Mảng chứa các đồng hành
            
            const equippedPetId = gameData.equippedSungVat;
            const championDiscipleId = gameData.sect.combatChampionId;

            // 1. Add Pet
            if (equippedPetId) {
                const petInstance = gameData.sungVat.find(p => p.id === equippedPetId);
                const petDB = SUNG_VAT_DB[equippedPetId];
                if (petInstance && petDB) {
                    const petStats = getPetStats(petInstance);
                    companions.push({
                        type: 'pet',
                        id: petInstance.id,
                        name: petDB.name,
                        level: petInstance.level,
                        stats: petStats,
                        currentHp: petStats.hp,
                        maxHp: petStats.hp
                    });
                }
            }
            
            // 2. Add Disciple
            if (championDiscipleId) {
                const champ = gameData.disciples.find(d => d.id === championDiscipleId);
                if (champ && champ.status === 'Nhàn Rỗi') {
                    // [MODIFIED] Tính toán lại stats đầy đủ cho đệ tử trước khi vào trận
                    const fullStats = calculateDiscipleStats(champ);
                    
                    companions.push({
                        type: 'disciple',
                        id: champ.id,
                        name: champ.name,
                        level: champ.level,
                        stats: fullStats, // [MODIFIED] Sử dụng stats đã cộng thiên phú
                        currentHp: fullStats.hp,
                        maxHp: fullStats.hp
                    });
                }
            }

            gameData.turnBasedCombat = {
                active: true,
                mapId: mapId,
                enemy: {
                    dbId: enemyId,
                    name: enemyDB.name,
                    level: enemyDB.level,
                    icon: enemyDB.icon,
                    stats: JSON.parse(JSON.stringify(enemyDB.stats)),
                    currentHp: enemyDB.stats.hp,
                    maxHp: enemyDB.stats.hp
                },
                companions: companions, // [MODIFIED] Sử dụng mảng companions thay vì object đơn lẻ
                log: [],
                playerTurn: true 
            };

            // 4. Close hub modal and show combat modal
            hideModal('dauladailuc-modal');
            hideModal('tuchangioi-modal'); // [NEW] Hide TCG modal too
            hideModal('kiemthe-modal'); // [NEW] Hide KTG modal too
            showModal('turn-based-combat-modal'); // This will call renderTurnBasedCombatUI via renderModalContent
            
            // 5. Add initial log
            addTurnBasedCombatLog(`Một <span class="text-yellow-400">${enemyDB.name}</span> (Cấp ${enemyDB.level}) xuất hiện!`, 'system');
            
            // 6. Render the UI
            renderTurnBasedCombatUI();
        }

        // [NEW] Renders the turn-based combat UI based on gameData.turnBasedCombat
        function renderTurnBasedCombatUI() {
            if (!gameData.turnBasedCombat.active) return; // Don't render if not active

            const playerStats = getTotalStats();
            const combatData = gameData.turnBasedCombat;
            const enemy = combatData.enemy;
            const isTuChanGioi = DAULADAILUC_MAPS_DB[combatData.mapId]?.isTuChanGioi || false;
            const isKiemTheGioi = DAULADAILUC_MAPS_DB[combatData.mapId]?.isKiemTheGioi || false; 
            const companions = combatData.companions || []; // [MODIFIED]

            // 1. Render Player Info
            document.getElementById('tb-player-name').textContent = PLAYER_DATA.name;

            // [FIX] Cập nhật hiển thị HP Người chơi (Đã bị thiếu ở phiên bản trước)
            const currentHp = Math.max(0, gameData.player.currentHp);
            const maxHp = playerStats.hp;
            const hpPercent = (currentHp / maxHp) * 100;
            
            document.getElementById('tb-player-hp').textContent = `${currentHp.toLocaleString()} / ${maxHp.toLocaleString()}`;
            document.getElementById('tb-player-hp-bar').style.width = `${hpPercent}%`;
                
            // [MODIFIED] Show Hon Luc (DLL) or Linh Khi (TCG)
            const honLucBar = document.getElementById('tb-player-honluc-bar').parentElement.parentElement;
            if (isTuChanGioi) {
                honLucBar.querySelector('span:first-child').textContent = 'Linh Khí (LK)';
                document.getElementById('tb-player-honluc').textContent = `${gameData.linhKhi} / --`;
                document.getElementById('tb-player-honluc-bar').style.width = `100%`; 
                document.getElementById('tb-player-honluc-bar').style.backgroundColor = '#a855f7'; 
            }
            else if (isKiemTheGioi) {
                honLucBar.querySelector('span:first-child').textContent = 'Nội Công (NC)';
                document.getElementById('tb-player-honluc').textContent = `${gameData.player.honLuc} / ${playerStats.honLuc}`; 
                document.getElementById('tb-player-honluc-bar').style.width = `${(gameData.player.honLuc / playerStats.honLuc) * 100}%`;
                document.getElementById('tb-player-honluc-bar').style.backgroundColor = '#f59e0b'; 
            }
            else {
                honLucBar.querySelector('span:first-child').textContent = 'Hồn Lực (HL)';
                document.getElementById('tb-player-honluc').textContent = `${gameData.player.honLuc} / ${playerStats.honLuc}`;
                document.getElementById('tb-player-honluc-bar').style.width = `${(gameData.player.honLuc / playerStats.honLuc) * 100}%`;
                document.getElementById('tb-player-honluc-bar').style.backgroundColor = '#9333ea'; 
            }

            // [NEW] 1b. Render Player Stats
            document.getElementById('tb-player-stats').innerHTML = `
                <span title="Công Kích"><i class="fa-solid fa-khanda text-orange-400 w-4 mr-1"></i> ${playerStats.atk.toLocaleString()}</span>
                <span title="Phòng Thủ"><i class="fa-solid fa-shield-halved text-blue-400 w-4 mr-1"></i> ${playerStats.def.toLocaleString()}</span>
                <span title="Thân Pháp"><i class="fa-solid fa-person-running text-green-400 w-4 mr-1"></i> ${playerStats.spd.toLocaleString()}</span>
                <span title="May Mắn"><i class="fa-solid fa-clover text-yellow-400 w-4 mr-1"></i> ${playerStats.lck.toLocaleString()}</span>
                <span title="Chí Mạng"><i class="fa-solid fa-bolt text-yellow-300 w-4 mr-1"></i> ${playerStats.critChance.toFixed(1)}%</span>
                <span title="ST Chí Mạng"><i class="fa-solid fa-burst text-red-400 w-4 mr-1"></i> ${playerStats.critDamage}%</span>
            `;

            // [MODIFIED] 1c. Render Companions Panel (Loop through array)
            const companionPanel = document.getElementById('tb-companion-panel'); 
            if (companions.length > 0) { 
                companionPanel.classList.remove('hidden');
                
                // Xóa nội dung cũ
                companionPanel.innerHTML = `<h4 class="text-lg font-bold text-gray-300 text-center mb-2 border-b border-gray-600 pb-1">Đội Hình Đồng Hành</h4>`;
                
                companions.forEach((comp, index) => {
                    // Xác định màu tên dựa vào loại
                    const nameColor = comp.type === 'pet' ? 'text-orange-400' : 'text-green-400'; // Pet cam, Đệ tử xanh
                    const icon = comp.type === 'pet' ? '<i class="fa-solid fa-paw mr-1"></i>' : '<i class="fa-solid fa-user mr-1"></i>';
                    const isDead = comp.currentHp <= 0;
                    
                    companionPanel.innerHTML += `
                    <div class="mb-3 bg-gray-800 p-2 rounded ${isDead ? 'opacity-50 grayscale' : ''}">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-sm font-bold ${nameColor}">${icon}${comp.name} <span class="text-xs text-gray-400">(Cấp ${comp.level})</span></h4>
                            ${isDead ? '<span class="text-red-500 text-xs font-bold">Gục ngã</span>' : ''}
                        </div>
                        
                        <!-- HP Bar -->
                        <div class="mb-1">
                            <div class="flex justify-between text-[10px] mb-0.5 text-gray-400">
                                <span>HP</span>
                                <span>${Math.max(0, comp.currentHp).toLocaleString()} / ${comp.maxHp.toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div class="bg-red-600 h-2 rounded-full transition-all duration-300" style="width: ${(Math.max(0, comp.currentHp) / comp.maxHp) * 100}%"></div>
                            </div>
                        </div>
                        <!-- Stats Mini -->
                        <div class="grid grid-cols-2 gap-x-2 text-[10px] text-gray-400">
                            <span>ATK: ${comp.stats.atk.toLocaleString()}</span>
                            <span>DEF: ${(comp.stats.def || 0).toLocaleString()}</span>
                        </div>
                    </div>
                    `;
                });

            } else {
                companionPanel.classList.add('hidden');
            }

            // 2. Render Enemy (Giữ nguyên)
            document.getElementById('tb-enemy-name').textContent = enemy.name;
            document.getElementById('tb-enemy-level').textContent = `Cấp ${enemy.level}`;
            document.getElementById('tb-enemy-icon').className = `${enemy.icon} text-6xl text-red-500 mb-4`;
            
            // [FIX] Format số liệu Enemy
            document.getElementById('tb-enemy-hp').textContent = `${enemy.currentHp.toLocaleString()} / ${enemy.maxHp.toLocaleString()}`;
            document.getElementById('tb-enemy-hp-bar').style.width = `${(enemy.currentHp / enemy.maxHp) * 100}%`;

            document.getElementById('tb-enemy-stats').innerHTML = `
                <span title="Công Kích"><i class="fa-solid fa-khanda text-orange-400 w-4 mr-1"></i> ${enemy.stats.atk.toLocaleString()}</span>
                <span title="Phòng Thủ"><i class="fa-solid fa-shield-halved text-blue-400 w-4 mr-1"></i> ${enemy.stats.def.toLocaleString()}</span>
                <span title="Thân Pháp"><i class="fa-solid fa-person-running text-green-400 w-4 mr-1"></i> ${enemy.stats.spd.toLocaleString()}</span>
                <span title="May Mắn"><i class="fa-solid fa-clover text-yellow-400 w-4 mr-1"></i> ${enemy.stats.lck.toLocaleString()}</span>
            `;

            // 3. Render Log (Giữ nguyên)
            const logContainer = document.getElementById('tb-combat-log');
            if (logContainer) {
                logContainer.innerHTML = combatData.log.map(entry => entry).join('');
                logContainer.scrollTop = logContainer.scrollHeight; 
            }

            // 4. Update Action Buttons (Giữ nguyên)
            const actionButtons = document.getElementById('tb-action-buttons');
            if (actionButtons) {
                const skillButton = actionButtons.querySelector('button[onclick*="skill"]');
                if (skillButton) {
                    if (isTuChanGioi || isKiemTheGioi) {
                        let skillName = 'Kỹ Năng';
                        if (isTuChanGioi) skillName = 'Pháp Bảo';
                        if (isKiemTheGioi) skillName = 'Võ Công';
                        skillButton.innerHTML = `<i class="fa-solid fa-scroll mr-2"></i>${skillName} (Chưa có)`;
                        skillButton.disabled = true;
                        skillButton.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        if (gameData.player.unlockedHonKy.length > 0) {
                            skillButton.innerHTML = `<i class="fa-solid fa-star mr-2"></i>Hồn Kỹ`;
                            skillButton.disabled = false;
                        } else {
                            skillButton.innerHTML = `<i class="fa-solid fa-star mr-2"></i>Chưa có Hồn Kỹ`;
                            skillButton.disabled = true;
                            skillButton.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }

                if (combatData.playerTurn) {
                    actionButtons.querySelectorAll('button').forEach(btn => {
                        if (btn.disabled === false) { 
                             btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    });
                } else {
                    actionButtons.querySelectorAll('button').forEach(btn => {
                         btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                }
            }
        }

        // [NEW] Adds a log message to the turn-based combat log
        function addTurnBasedCombatLog(message, type = 'info') {
            if (!gameData.turnBasedCombat.active) return;
            
            let colorClass = 'text-gray-300';
            if (type === 'player') colorClass = 'text-green-400';
            else if (type === 'enemy') colorClass = 'text-red-400';
            else if (type === 'system') colorClass = 'text-yellow-400';
            else if (type === 'reward') colorClass = 'text-cyan-300';

            gameData.turnBasedCombat.log.push(`<p class="${colorClass}"><i class="fa-solid fa-caret-right mr-1"></i>${message}</p>`);
            
            // Keep log tidy
            if (gameData.turnBasedCombat.log.length > 50) {
                gameData.turnBasedCombat.log.shift();
            }

            // Update log UI
            const logContainer = document.getElementById('tb-combat-log');
            if (logContainer) {
                logContainer.innerHTML = gameData.turnBasedCombat.log.map(entry => entry).join('');
                logContainer.scrollTop = logContainer.scrollHeight; // Scroll to bottom
            }
        }

        // [NEW] Player performs an action in turn-based combat
        function performPlayerAction(actionType) {
            if (!gameData.turnBasedCombat.active || !gameData.turnBasedCombat.playerTurn) {
                return; // Not player's turn or combat inactive
            }

            // Disable buttons immediately
            gameData.turnBasedCombat.playerTurn = false;
            renderTurnBasedCombatUI(); // This will disable buttons

            const playerStats = getTotalStats();
            const enemy = gameData.turnBasedCombat.enemy;
            const companion = gameData.turnBasedCombat.companion; // [MODIFIED]
            let playerDamage = 0;
            // [NEW] Check which world we are in
            const isTuChanGioi = DAULADAILUC_MAPS_DB[gameData.turnBasedCombat.mapId]?.isTuChanGioi || false;
            const isKiemTheGioi = DAULADAILUC_MAPS_DB[gameData.turnBasedCombat.mapId]?.isKiemTheGioi || false; // [NEW]

            if (actionType === 'attack') {
                // Basic attack logic
                playerDamage = Math.max(1, playerStats.atk - enemy.stats.def);
                
                // [MODIFIED] Check for crit
                if (Math.random() * 100 < playerStats.critChance) {
                    playerDamage = Math.floor(playerDamage * (playerStats.critDamage / 100));
                    addTurnBasedCombatLog(`Bạn tấn công! <span class="text-yellow-300">CHÍ MẠNG!</span> Gây ${playerDamage} sát thương.`, 'player');
                } else {
                    addTurnBasedCombatLog(`Bạn tấn công! Gây ${playerDamage} sát thương.`, 'player');
                }

                // Apply damage
                enemy.currentHp = Math.max(0, enemy.currentHp - playerDamage);
            }
            // [NEW] Add 'skill' logic
            else if (actionType === 'skill') {
                if (isTuChanGioi) {
                    // TCG: Pháp Bảo logic (chưa có)
                    addTurnBasedCombatLog('Chức năng Pháp Bảo chưa hoàn thiện!', 'system');
                    gameData.turnBasedCombat.playerTurn = true;
                    renderTurnBasedCombatUI(); // Re-enable buttons
                    return; // Exit
                }
                // [NEW] Handle Kiem The Gioi
                else if (isKiemTheGioi) {
                    // KTG: Võ Công logic (chưa có)
                    addTurnBasedCombatLog('Chức năng Võ Công chưa hoàn thiện!', 'system');
                    gameData.turnBasedCombat.playerTurn = true;
                    renderTurnBasedCombatUI(); // Re-enable buttons
                    return; // Exit
                }
                else {
                    // DLL: Hồn Kỹ logic
                    if (gameData.player.unlockedHonKy.length === 0) {
                        addTurnBasedCombatLog('Bạn chưa học được Hồn Kỹ nào!', 'system');
                        gameData.turnBasedCombat.playerTurn = true;
                        renderTurnBasedCombatUI(); // Re-enable buttons
                        return; // Exit
                    }

                    // --- SIMPLIFIED: Use the first unlocked skill ---
                    const skillId = gameData.player.unlockedHonKy[0];
                    const skillData = HON_KY_DB[skillId];

                    if (!skillData) {
                         addTurnBasedCombatLog('Lỗi: Hồn Kỹ không tồn tại!', 'system');
                         gameData.turnBasedCombat.playerTurn = true;
                         renderTurnBasedCombatUI();
                         return; // Exit
                    }
                    
                    if (gameData.player.honLuc < skillData.honLucCost) {
                        addTurnBasedCombatLog(`Không đủ Hồn Lực để dùng [${skillData.name}]! (Cần ${skillData.honLucCost})`, 'system');
                        gameData.turnBasedCombat.playerTurn = true;
                        renderTurnBasedCombatUI();
                        return; // Exit
                    }

                    // 1. Consume resource
                    gameData.player.honLuc -= skillData.honLucCost;
                    addTurnBasedCombatLog(`Bạn dùng [${skillData.name}]! (-${skillData.honLucCost} Hồn Lực)`, 'player');

                    // 2. Apply effect
                    if (skillData.type === 'attack') {
                        playerDamage = Math.max(1, (playerStats.atk * skillData.multiplier) - enemy.stats.def);
                        
                        if (Math.random() * 100 < playerStats.critChance) {
                            playerDamage = Math.floor(playerDamage * (playerStats.critDamage / 100));
                            addTurnBasedCombatLog(`... <span class="text-yellow-300">CHÍ MẠNG!</span> Gây ${playerDamage} sát thương.`, 'player');
                        } else {
                            addTurnBasedCombatLog(`... Gây ${playerDamage} sát thương.`, 'player');
                        }
                        // Apply damage
                        enemy.currentHp = Math.max(0, enemy.currentHp - playerDamage);
                    }
                    // TODO: Add buff/debuff logic here later
                }
            }
            // [NEW] Add 'item' logic
            else if (actionType === 'item') {
                const itemToUse = 'item_hp_small';
                const healPercent = 10; // From STATIC_ITEM_DB['item_hp_small']

                if ((gameData.items[itemToUse] || 0) > 0 && gameData.player.currentHp < playerStats.hp) {
                    // 1. Consume item
                    gameData.items[itemToUse]--;
                    
                    // 2. Calculate heal
                    const healAmount = Math.floor(playerStats.hp * (healPercent / 100));
                    const missingHp = playerStats.hp - gameData.player.currentHp;
                    const recovered = Math.min(missingHp, healAmount);
                    
                    // 3. Apply heal
                    gameData.player.currentHp += recovered;
                    
                    addTurnBasedCombatLog(`Bạn dùng Tiểu Hồng Dược, hồi ${recovered} HP.`, 'player');
                    
                    // 4. Update UI and end turn
                    renderTurnBasedCombatUI();
                    setTimeout(processEnemyTurn, 1500); // Enemy's turn
                    return; // Exit function
                    
                } else {
                    addTurnBasedCombatLog('Không có Tiểu Hồng Dược hoặc HP đã đầy!', 'system');
                    // Give the turn back to the player
                    gameData.turnBasedCombat.playerTurn = true;
                    renderTurnBasedCombatUI(); // Re-enable buttons
                    return; // Exit function
                }
            }
            // [END NEW]

            // Update UI after attack
            renderTurnBasedCombatUI();

            // Check for enemy defeat
            if (enemy.currentHp <= 0) {
                // Enemy defeated
                setTimeout(() => endTurnBasedCombat(true), 1000); 
            } else {
                // [MODIFIED] Lượt của các đồng hành (Chain Action)
                // Bắt đầu từ đồng hành đầu tiên (index 0)
                if (gameData.turnBasedCombat.companions && gameData.turnBasedCombat.companions.length > 0) {
                    setTimeout(() => processCompanionTurn(0), 1000); 
                } else {
                    setTimeout(processEnemyTurn, 1500); // Không có đồng hành thì đến lượt quái
                }
            }
        }

        // [MODIFIED] Xử lý lượt của đồng hành theo chuỗi (Recursive)
        function processCompanionTurn(companionIndex) { 
            if (!gameData.turnBasedCombat.active) return; 
            
            const companions = gameData.turnBasedCombat.companions || [];
            const enemy = gameData.turnBasedCombat.enemy;

            // Kiểm tra xem đã hết danh sách đồng hành chưa
            if (companionIndex >= companions.length) {
                // Hết đồng hành -> Đến lượt Quái
                setTimeout(processEnemyTurn, 500);
                return;
            }

            const companion = companions[companionIndex];

            // Nếu đồng hành đã chết, bỏ qua và đến người tiếp theo
            if (companion.currentHp <= 0) {
                processCompanionTurn(companionIndex + 1);
                return;
            }
            
            let companionDmg = 0;
            let logMsg = '';

            // Logic tấn công của đồng hành (Giữ nguyên logic cũ nhưng áp dụng cho từng loại)
            if (companion.type === 'pet') {
                const petDB = SUNG_VAT_DB[companion.id];
                const activeSkill = petDB.activeSkill;
                if (activeSkill) {
                    companionDmg = Math.max(1, Math.floor(companion.stats.atk * activeSkill.multiplier) - enemy.stats.def);
                    logMsg = `${companion.name} dùng [${activeSkill.name}]! Gây ${companionDmg} sát thương.`;
                } else {
                    companionDmg = Math.max(1, companion.stats.atk - enemy.stats.def);
                    logMsg = `${companion.name} tấn công! Gây ${companionDmg} sát thương.`;
                }
            } else { // 'disciple'
                companionDmg = Math.max(1, companion.stats.atk - enemy.stats.def);
                if (Math.random() < 0.05) {
                    const critDmg = Math.floor(companionDmg * 1.5);
                    companionDmg = critDmg;
                    logMsg = `${companion.name} tấn công! <span class="text-yellow-300">CHÍ MẠNG!</span> Gây ${critDmg} sát thương.`;
                } else {
                    logMsg = `${companion.name} tấn công! Gây ${companionDmg} sát thương.`;
                }
            }
            
            // Áp dụng sát thương
            enemy.currentHp = Math.max(0, enemy.currentHp - companionDmg);
            addTurnBasedCombatLog(logMsg, 'player'); // Log phe ta
            renderTurnBasedCombatUI(); // Cập nhật UI

            // Kiểm tra quái chết chưa
            if (enemy.currentHp <= 0) {
                setTimeout(() => endTurnBasedCombat(true), 1000);
            } else {
                // Chưa chết -> Gọi đệ quy cho đồng hành tiếp theo sau 1s
                setTimeout(() => processCompanionTurn(companionIndex + 1), 1000);
            }
        }

        // [NEW] Enemy performs its action
        function processEnemyTurn() {
            if (!gameData.turnBasedCombat.active) return; 

            const playerStats = getTotalStats();
            const enemy = gameData.turnBasedCombat.enemy;
            const enemyDB = DAULADAILUC_ENEMIES_DB[enemy.dbId];
            
            if (!enemyDB) {
                endTurnBasedCombat(false); return;
            }

            // [MODIFIED] Chọn mục tiêu ngẫu nhiên từ phe ta (Người + Đồng hành còn sống)
            let potentialTargets = [];
            
            // 1. Thêm người chơi (nếu còn sống)
            if (gameData.player.currentHp > 0) {
                potentialTargets.push({ type: 'player', name: 'Bạn', stats: playerStats });
            }
            
            // 2. Thêm đồng hành (nếu còn sống)
            const companions = gameData.turnBasedCombat.companions || [];
            companions.forEach((comp, index) => {
                if (comp.currentHp > 0) {
                    potentialTargets.push({ type: 'companion', index: index, name: comp.name, stats: comp.stats });
                }
            });

            // Nếu không còn ai sống (vô lý vì check ở endTurn), xử thua
            if (potentialTargets.length === 0) {
                setTimeout(() => endTurnBasedCombat(false), 1000);
                return;
            }

            // Chọn ngẫu nhiên
            const target = potentialTargets[Math.floor(Math.random() * potentialTargets.length)];
            
            // Tính sát thương
            const enemySkill = enemyDB.skills[0] || { multiplier: 1 };
            let damage = Math.max(1, enemy.stats.atk * (enemySkill.multiplier || 1) - target.stats.def);
            damage = Math.floor(damage);
            
            // Áp dụng sát thương
            if (target.type === 'player') {
                // Check né tránh cho người chơi
                if (Math.random() * 100 < playerStats.dodgeChance) {
                    addTurnBasedCombatLog(`${enemy.name} tấn công, nhưng bạn đã <span class="text-cyan-300">NÉ</span> được!`, 'enemy');
                } else {
                    gameData.player.currentHp = Math.max(0, gameData.player.currentHp - damage);
                    addTurnBasedCombatLog(`${enemy.name} tấn công ${target.name}! Gây ${damage} sát thương.`, 'enemy');
                }
            } else {
                // Đồng hành (chưa có chỉ số né tránh, nhận dmg thẳng)
                const comp = companions[target.index];
                comp.currentHp = Math.max(0, comp.currentHp - damage);
                addTurnBasedCombatLog(`${enemy.name} tấn công ${target.name}! Gây ${damage} sát thương.`, 'enemy');
                
                if (comp.currentHp <= 0) {
                    addTurnBasedCombatLog(`${comp.name} đã bị đánh gục!`, 'system');
                }
            }
            
            // Update UI
            renderTurnBasedCombatUI();

            // Check for TOTAL defeat (Người chơi chết là thua luôn, bất kể đệ tử)
            if (gameData.player.currentHp <= 0) {
                addTurnBasedCombatLog(`Bạn đã bị đánh bại!`, 'system');
                setTimeout(() => endTurnBasedCombat(false), 1000); 
            } else {
                // Back to player's turn
                gameData.turnBasedCombat.playerTurn = true;
                renderTurnBasedCombatUI(); 
            }
        }

        // [NEW] Ends the turn-based combat
        function endTurnBasedCombat(didWin) {
            if (!gameData.turnBasedCombat.active) return; 

            const combatMapId = gameData.turnBasedCombat.mapId; 

            // --- [FIX] XỬ LÝ RIÊNG CHO BÁCH THẮNG DANH TƯỚNG ---
            if (combatMapId === 'map_bach_thang') {
                if (didWin) {
                    const reward = gameData.turnBasedCombat.bachThangReward;
                    
                    // 1. Cộng thưởng
                    gameData.nganLuong += reward.nl;
                    addPlayerXp(reward.xp, 'turn_based');
                    
                    // 2. Cập nhật tiến độ (QUAN TRỌNG: Tăng tầng để hiện địch mới)
                    if (gameData.sect.bachThang.currentLayer === reward.layer) {
                        gameData.sect.bachThang.currentLayer++;
                        // Cập nhật tầng cao nhất nếu vượt kỷ lục
                        if (gameData.sect.bachThang.currentLayer > gameData.sect.bachThang.highestLayer) {
                             gameData.sect.bachThang.highestLayer = gameData.sect.bachThang.currentLayer - 1;
                        }
                    }

                    // 3. Thông báo chiến thắng
                    document.getElementById('tb-result-title').textContent = 'CHIẾN THẮNG';
                    document.getElementById('tb-result-title').className = 'text-3xl font-bold text-yellow-400 mb-4';
                    document.getElementById('tb-result-rewards').innerHTML = `
                        <p>Vượt ải Bách Thắng Tầng <span class="text-white font-bold">${reward.layer}</span>!</p>
                        <p class="text-green-300 mt-2">+${reward.xp.toLocaleString()} XP</p>
                        <p class="text-yellow-300">+${reward.nl.toLocaleString()} NL</p>
                        <p class="text-gray-400 text-sm mt-4">Kẻ địch tầng tiếp theo đang đợi...</p>
                    `;
                    showModal('tb-result-modal');

                    // 4. Log
                    addSectLog(`Vượt ải Bách Thắng tầng ${reward.layer}, nhận thưởng lớn!`, 'reward');

                } else {
                    // Thua
                    document.getElementById('tb-result-title').textContent = 'THẤT BẠI';
                    document.getElementById('tb-result-title').className = 'text-3xl font-bold text-red-500 mb-4';
                    const layer = gameData.turnBasedCombat.bachThangReward ? gameData.turnBasedCombat.bachThangReward.layer : '?';
                    document.getElementById('tb-result-rewards').innerHTML = `
                        <p>Bạn đã thất bại tại Tầng ${layer}.</p>
                        <p class="text-gray-400 text-sm">Hãy nâng cao lực chiến và thử lại!</p>
                    `;
                    showModal('tb-result-modal');
                }
                
                // Cleanup & Reset HP
                if (gameData.player.currentHp <= 0) gameData.player.currentHp = getTotalStats().hp;
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                
                // Đóng modal chiến đấu
                hideModal('turn-based-combat-modal');
                updateUI();
                
                // Tự động mở lại giao diện Bách Thắng (sẽ render tầng mới do currentLayer đã tăng)
                setTimeout(() => {
                    showModal('tong-mon-modal');
                    switchTongMonTab('chinh-phat');
                    switchChinhPhatSubTab('bach-thang');
                }, 300);
                
                return; // Dừng hàm tại đây
            }
            // --- [END FIX BÁCH THẮNG] ---
            
            // [MODIFIED] Special Logic for Arena Battle (Võ Đài)
            if (combatMapId === 'map_vo_dai') {
                // [NEW] Prepare log data
                if (!gameData.arena.battleLog) gameData.arena.battleLog = [];
                const enemyName = gameData.turnBasedCombat.enemy.name;
                const timeStr = new Date().toLocaleTimeString();

                if (didWin) {
                    const pointsGained = gameData.turnBasedCombat.arenaRewardPoints || 10;
                    gameData.arena.points += pointsGained;
                    gameData.arena.wins++;
                    
                    // Thưởng thêm
                    const knbReward = 10;
                    gameData.kimNguyenBao += knbReward;

                    // [NEW] Thưởng EXP sau trận đấu (Dựa trên lương rank hiện tại / 10 hoặc cố định)
                    // Lấy rank hiện tại
                    const currentRank = gameData.arena.rank || 1;
                    const salaryData = ARENA_RANKS_DB[currentRank].salary;
                    // Thưởng trận = 10% lương ngày (để khuyến khích đánh nhiều)
                    const xpReward = Math.floor((salaryData.xp || 100000) / 10);
                    
                    addPlayerXp(xpReward, 'turn_based');

                    addTurnBasedCombatLog(`CHIẾN THẮNG TRÊN VÕ ĐÀI!`, 'system');
                    addTurnBasedCombatLog(`+${pointsGained} Điểm Xếp Hạng`, 'reward');
                    addTurnBasedCombatLog(`+${knbReward} KNB`, 'reward');
                    addTurnBasedCombatLog(`+${xpReward.toLocaleString()} Kinh Nghiệm`, 'reward'); // [NEW] Log XP
                    
                    showToast(`Thắng Võ Đài! +${pointsGained} Điểm, +${xpReward.toLocaleString()} XP.`, true);
                    
                    // [MODIFIED] Add to Arena Log with XP display
                    gameData.arena.battleLog.unshift({
                        type: 'win',
                        msg: `Đánh bại <span class="text-white font-bold">${enemyName}</span>. Nhận <span class="text-yellow-300">+${pointsGained}</span> điểm, <span class="text-green-400">+${xpReward.toLocaleString()}</span> XP.`,
                        time: timeStr
                    });
                    
                    // Tạo danh sách đối thủ mới sau khi thắng để tránh farm 1 người
                    generateArenaOpponents();
                    
                } else {
                    // Thua
                    const pointsLost = 5;
                    gameData.arena.points = Math.max(0, gameData.arena.points - pointsLost);
                    gameData.arena.losses++;

                    // [NEW] Add to Arena Log
                    gameData.arena.battleLog.unshift({
                        type: 'loss',
                        msg: `Thất bại trước <span class="text-white font-bold">${enemyName}</span>. Mất <span class="text-red-400">-${pointsLost}</span> điểm.`,
                        time: timeStr
                    });

                    document.getElementById('tb-result-title').textContent = 'THẤT BẠI';
                    document.getElementById('tb-result-title').className = 'text-3xl font-bold text-red-500 mb-4';
                    document.getElementById('tb-result-rewards').innerHTML = `
                        <p>Bạn đã bị đánh bại trên võ đài.</p>
                        <p class="text-red-400">Mất ${pointsLost} điểm xếp hạng.</p>
                    `;
                    showModal('tb-result-modal');
                }
                
                // [NEW] Limit log size (Max 50 entries)
                if (gameData.arena.battleLog.length > 50) {
                    gameData.arena.battleLog.pop();
                }

                // Clean up combat state
                if (gameData.player.currentHp <= 0) gameData.player.currentHp = getTotalStats().hp;
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                
                // [MODIFIED] Đóng combat modal và mở lại Võ Đài
                hideModal('turn-based-combat-modal');
                updateUI();
                
                // Re-open Tong Mon -> Chinh Phat -> Vo Dai
                setTimeout(() => {
                    showModal('tong-mon-modal');
                    switchTongMonTab('chinh-phat');
                    switchChinhPhatSubTab('vo-dai-than-ma');
                }, 300); // Delay nhẹ để UI kịp xử lý
                
                return; // Exit function
            }

            // [MODIFIED] Special Logic for Shadow Battle (Tâm Ma) - HIỂN THỊ MODAL THẮNG
            if (combatMapId === 'map_am_anh') {
                if (didWin) {
                    // [MODIFIED] Cập nhật phần thưởng lớn hơn
                    const knbReward = 200;
                    const lhtReward = 500;
                    const vinhDuReward = 100;
                    
                    const randomStone = Math.random() < 0.5 ? 'upgrade_stone_medium' : 'upgrade_stone_high';
                    const stoneDB = MATERIALS_DB[randomStone]; // Lấy tên đá để hiển thị
                    
                    // Cộng tài nguyên
                    gameData.kimNguyenBao += knbReward;
                    gameData.linhHonThach = (gameData.linhHonThach || 0) + lhtReward;
                    gameData.diemVinhDuLienDau = (gameData.diemVinhDuLienDau || 0) + vinhDuReward;
                    
                    addMaterial(randomStone, 1, 'turn_based');
                    
                    addTurnBasedCombatLog(`CHIẾN THẮNG TÂM MA!`, 'system');
                    addTurnBasedCombatLog(`Nhận thưởng lớn: ${knbReward} KNB, ${lhtReward} LHT, ${vinhDuReward} Vinh Dự!`, 'reward');
                    
                    // [NEW] Hiển thị Modal Kết Quả thay vì chỉ Toast
                    document.getElementById('tb-result-title').textContent = 'CHIẾN THẮNG TÂM MA';
                    document.getElementById('tb-result-title').className = 'text-3xl font-bold text-yellow-400 mb-4 text-shadow-gold';
                    document.getElementById('tb-result-rewards').innerHTML = `
                        <p class="text-gray-300 mb-4">Bạn đã chiến thắng bản ngã hắc ám của chính mình!</p>
                        <div class="bg-gray-700/50 p-4 rounded-lg border border-yellow-500/30 space-y-2">
                            <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                <span class="text-gray-400">Kim Nguyên Bảo</span>
                                <span class="text-yellow-300 font-bold text-xl">+${knbReward} <i class="fa-solid fa-gem text-xs"></i></span>
                            </div>
                            <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                <span class="text-gray-400">Linh Hồn Thạch</span>
                                <span class="text-cyan-300 font-bold text-xl">+${lhtReward} <i class="fa-solid fa-ghost text-xs"></i></span>
                            </div>
                            <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                                <span class="text-gray-400">Điểm Vinh Dự</span>
                                <span class="text-orange-400 font-bold text-xl">+${vinhDuReward} <i class="fa-solid fa-medal text-xs"></i></span>
                            </div>
                            <div class="flex justify-between items-center pt-1">
                                <span class="text-gray-400">Vật phẩm</span>
                                <span class="${getRarityClass(stoneDB.rarity)} font-bold text-lg">+1 ${stoneDB.name}</span>
                            </div>
                        </div>
                    `;
                    showModal('tb-result-modal');

                } else {
                    // Thua
                    document.getElementById('tb-result-title').textContent = 'THẤT BẠI';
                    document.getElementById('tb-result-title').className = 'text-3xl font-bold text-red-500 mb-4';
                    document.getElementById('tb-result-rewards').innerHTML = `
                        <p class="text-lg text-gray-300">Tâm Ma quá mạnh!</p>
                        <p class="text-gray-400 text-sm mt-2">Hãy rèn luyện thêm và thử lại sau.</p>
                    `;
                    showModal('tb-result-modal');
                }
                
                // Clean up combat state
                if (gameData.player.currentHp <= 0) gameData.player.currentHp = getTotalStats().hp;
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                
                // [MODIFIED] Đóng combat modal và mở lại Ám Ảnh Kiếm Ảnh
                hideModal('turn-based-combat-modal');
                updateUI();
                
                // Re-open Tong Mon -> Chinh Phat -> Am Anh
                setTimeout(() => {
                    showModal('tong-mon-modal');
                    switchTongMonTab('chinh-phat');
                    switchChinhPhatSubTab('am-anh-kiem-anh');
                }, 300);
                
                return; // Exit function specifically for Shadow Battle
            }

            // --- GENERIC COMBAT LOGIC (For Maps/Dungeons) ---
            const enemyDB = DAULADAILUC_ENEMIES_DB[gameData.turnBasedCombat.enemy.dbId];
            const companions = gameData.turnBasedCombat.companions || []; 

            if (didWin) {
                // --- VICTORY ---
                const rewards = enemyDB.rewards;
                const xpGained = rewards.xp;
                const nlGained = rewards.nganLuong;
                
                // 1. Add Player Rewards
                addPlayerXp(xpGained, 'turn_based');
                gameData.nganLuong += nlGained;
                
                if (rewards.honLuc) {
                     // Logic Hồn Lực/Linh Khí tùy map đã có trong addPlayerXp/UI update, 
                     // ở đây chỉ log hoặc cộng các loại tiền tệ đặc biệt nếu cần.
                     // (Hiện tại game dùng chung Hồn Lực làm thanh năng lượng chiến đấu nên không cộng dồn)
                }
                if (rewards.linhKhi) {
                    gameData.linhKhi = (gameData.linhKhi || 0) + rewards.linhKhi;
                    addTurnBasedCombatLog(`Nhận ${rewards.linhKhi} Linh Khí.`, 'reward');
                }

                addTurnBasedCombatLog(`CHIẾN THẮNG! Nhận ${xpGained.toLocaleString()} XP và ${nlGained.toLocaleString()} NL.`, 'reward');

                // 2. Add Companion XP (50% of Player XP)
                if (companions.length > 0) {
                    const bonusXp = Math.floor(xpGained * 0.5);
                    companions.forEach(comp => {
                        // Chỉ cộng XP nếu đồng hành còn sống
                        if (comp.currentHp > 0) {
                            if (bonusXp > 0) {
                                if (comp.type === 'pet') {
                                    addEquippedPetXp(bonusXp); 
                                    addTurnBasedCombatLog(`${comp.name} nhận ${bonusXp} XP.`, 'reward');
                                } else if (comp.type === 'disciple') {
                                    addDiscipleXp(comp.id, bonusXp); 
                                    addTurnBasedCombatLog(`${comp.name} nhận ${bonusXp} XP.`, 'reward');
                                }
                            }
                        }
                    });
                }

                // 3. Drop Items
                if (rewards.loot && rewards.loot.length > 0) {
                    rewards.loot.forEach(lootItem => {
                        if (Math.random() * 100 < lootItem.chance) {
                            if (STATIC_ITEM_DB[lootItem.id]) addItem(lootItem.id, 1, 'turn_based');
                            else if (MATERIALS_DB[lootItem.id]) addMaterial(lootItem.id, 1, 'turn_based');
                        }
                    });
                }
                
                // [REMOVED] 4. Unlock Hon Ky (Soul Skills) - Đã bỏ theo yêu cầu
                /*
                if (rewards.unlockHonKy && rewards.unlockHonKyChance) {
                     if (Math.random() * 100 < rewards.unlockHonKyChance) {
                        const skillId = rewards.unlockHonKy;
                        if (!gameData.player.unlockedHonKy.includes(skillId)) {
                            gameData.player.unlockedHonKy.push(skillId);
                            const skillData = HON_KY_DB[skillId];
                            addTurnBasedCombatLog(`Hấp thụ thành công! Bạn đã học được: <span class="text-yellow-300">[${skillData.name}]</span>!`, 'reward');
                            gameData.player.unlockedHonKy.sort((a, b) => HON_KY_DB[b].levelReq - HON_KY_DB[a].levelReq);
                        }
                    }
                }
                */
                
                // 5. Drop Equipment
                const equipChance = rewards.equipChance || 0;
                if (Math.random() * 100 < equipChance) {
                    const newItem = generateEquipment(enemyDB.level || 1);
                    if (countInventorySlots() < MAX_INVENTORY_SLOTS) {
                        gameData.gearInventory.push(newItem);
                        addTurnBasedCombatLog(`Rơi ra trang bị [${newItem.name}]!`, 'reward');
                    } else {
                        addTurnBasedCombatLog(`Rơi trang bị nhưng Hành trang đầy!`, 'error');
                    }
                }

                // 6. Spawn Next Enemy
                addTurnBasedCombatLog(`Chuẩn bị... quái vật tiếp theo sắp xuất hiện!`, 'system');
                setTimeout(spawnNextTurnBasedEnemy, 2000); 

            } else {
                // --- DEFEAT / FLEE ---
                document.getElementById('tb-result-title').textContent = 'THẤT BẠI';
                document.getElementById('tb-result-title').className = 'text-3xl font-bold text-red-500 mb-4';
                document.getElementById('tb-result-rewards').innerHTML = `
                    <p>Bạn đã bị đánh bại hoặc đã bỏ chạy.</p>
                    <p>Không nhận được phần thưởng.</p>
                `;
                
                if (gameData.player.currentHp <= 0) {
                    gameData.player.currentHp = getTotalStats().hp; 
                }
                
                showModal('tb-result-modal');
                gameData.turnBasedCombat = { ...initialGameData.turnBasedCombat };
                hideModal('turn-based-combat-modal');
            }
            updateUI();
        }

        // [NEW] Spawns the next enemy in turn-based combat without closing the modal
        function spawnNextTurnBasedEnemy() {
            if (!gameData.turnBasedCombat.active || !gameData.turnBasedCombat.mapId) {
                // Failsafe, shouldn't happen
                endTurnBasedCombat(false); // Flee
                return;
            }

            const mapId = gameData.turnBasedCombat.mapId;
            const mapDB = DAULADAILUC_MAPS_DB[mapId];
            if (!mapDB) {
                showToast("Lỗi: Không tìm thấy bản đồ! Rời khỏi chiến đấu.", false);
                endTurnBasedCombat(false);
                return;
            }

            // 1. Select an enemy
            const enemyId = mapDB.enemies[Math.floor(Math.random() * mapDB.enemies.length)];
            const enemyDB = DAULADAILUC_ENEMIES_DB[enemyId];
            if (!enemyDB) {
                showToast("Lỗi: Không tìm thấy quái vật! Rời khỏi chiến đấu.", false);
                endTurnBasedCombat(false);
                return;
            }

            // 2. Reset enemy data in combat state
            gameData.turnBasedCombat.enemy = {
                dbId: enemyId,
                name: enemyDB.name,
                level: enemyDB.level,
                icon: enemyDB.icon,
                stats: JSON.parse(JSON.stringify(enemyDB.stats)), // Deep copy stats
                currentHp: enemyDB.stats.hp,
                maxHp: enemyDB.stats.hp
            };
            
            // 3. Reset turn
            gameData.turnBasedCombat.playerTurn = true;

            // 4. Add log
            addTurnBasedCombatLog(`Một <span class="text-yellow-400">${enemyDB.name}</span> (Cấp ${enemyDB.level}) mới xuất hiện!`, 'system');

            // 5. Render UI (this will re-enable buttons)
            renderTurnBasedCombatUI();
        }

        // [END NEW] --- Dau La Dai Luc (Turn-Based) Functions ---

        // [NEW] --- Kiem The Gioi (Kiem The World) Functions ---
        /**
         * [NEW] Renders the sub-map list for Kiem The Gioi
         */
        function renderKiemTheModal() {
            const listContainer = document.getElementById('ktg-map-list-container');
            if (!listContainer) return;

            const playerLevel = gameData.player.level;
            let html = '';

            for (const mapId in DAULADAILUC_MAPS_DB) {
                const map = DAULADAILUC_MAPS_DB[mapId];
                // Only show maps for Kiem The Gioi
                if (!map.isKiemTheGioi) continue;

                const isUnlocked = playerLevel >= map.levelReq;

                if (isUnlocked) {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3">
                        <div>
                            <h4 class="font-bold text-lg text-yellow-300">${map.name}</h4>
                            <p class="text-xs text-gray-300">${map.desc}</p>
                        </div>
                        <button onclick="startTurnBasedCombat('${mapId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm">
                            Khiêu chiến
                        </button>
                    </div>
                    `;
                } else {
                    html += `
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between gap-3 opacity-50">
                        <div>
                            <h4 class="font-bold text-lg text-gray-500">${map.name} (Chưa mở)</h4>
                            <p class="text-xs text-gray-400">Yêu cầu: Cấp ${map.levelReq}</p>
                        </div>
                        <button class="bg-gray-500 text-white font-bold py-2 px-3 rounded text-sm cursor-not-allowed" disabled>
                            Bị khóa
                        </button>
                    </div>
                    `;
                }
            }
            listContainer.innerHTML = html;
        }
        // [END NEW] --- Kiem The Gioi (Kiem The World) Functions ---

        // [NEW] --- Sung Vat (Pet) Functions (UI Only) ---

        /**
         * [NEW] Renders the Sung Vat (Pet) modal UI (MODIFIED)
         */
        function renderSungVatModal() {
            const equippedSlot = document.getElementById('sung-vat-equipped-slot');
            const listContainer = document.getElementById('sung-vat-list');
            if (!equippedSlot || !listContainer) return;

            // 1. Render Equipped Pet
            const equippedId = gameData.equippedSungVat;
            if (equippedId) {
                const petInstance = gameData.sungVat.find(p => p.id === equippedId);
                
                if (!petInstance) {
                    gameData.equippedSungVat = null;
                    renderSungVatModal();
                    return;
                }
                
                const petDB = SUNG_VAT_DB[petInstance.id];
                const xpPercent = (petInstance.xp / petInstance.xpToNext) * 100;
                const petStats = getPetStats(petInstance); 
                
                // [NEW] Thông tin Trùng Sinh
                const rebirthCount = petInstance.rebirthCount || 0;
                const rebirthText = rebirthCount > 0 ? `<span class="text-red-400 font-bold ml-1 text-xs border border-red-500 rounded px-1">+${rebirthCount}</span>` : '';

                // [MODIFIED] Add effect class to equipped pet
                let effectClass = '';
                if (petDB.rarity >= 10) effectClass = 'text-rainbow-animation';
                else if (petDB.rarity >= 9) effectClass = 'text-pulse-holy-glow';
                else if (petDB.rarity >= 8) effectClass = 'text-pulse-glow';
                else if (petDB.rarity >= 7) effectClass = 'text-sparkle';
                
                // [MODIFIED] Nút Trùng Sinh (Hiện khi đủ cấp 2500)
                let rebirthButton = '';
                if (petInstance.level >= 2500) {
                    // [MODIFIED] Tính chi phí cho lần tiếp theo: (Số lần + 1) * 500k KNB
                    const nextRebirth = rebirthCount + 1;
                    const cost = 500000 * nextRebirth;
                    
                    rebirthButton = `
                        <button onclick="confirmPetRebirth('${petInstance.id}')" class="text-xs bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-1 px-3 rounded mt-4 ml-2 animate-pulse shadow-lg border border-purple-400/50 flex items-center gap-1">
                            <i class="fa-solid fa-rotate"></i> Trùng Sinh (${cost.toLocaleString()} KNB)
                        </button>
                    `;
                }

                equippedSlot.innerHTML = `
                    <div class="flex flex-col items-center text-center text-white">
                        <i class="${petDB.icon} text-6xl mb-3 ${getRarityClass(petDB.rarity)} ${effectClass}"></i>
                        <p class="font-bold text-lg ${getRarityClass(petDB.rarity)} ${effectClass}">${petDB.name} ${rebirthText}</p>
                        <p class="text-sm mb-2 text-gray-300">Cấp ${petInstance.level} / 2500</p>
                        
                        <div class="disciple-xp-bar-container w-full mb-3">
                            <div class="disciple-xp-bar-fill" style="width: ${petInstance.level >= 2500 ? 100 : xpPercent}%;"></div>
                            <div class="disciple-xp-bar-text">${petInstance.level >= 2500 ? 'MAX LEVEL' : `${Math.floor(petInstance.xp).toLocaleString()} / ${petInstance.xpToNext.toLocaleString()} XP`}</div>
                        </div>

                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs mt-2 text-gray-300 w-full px-2">
                            <span class="flex justify-between"><span><i class="fa-solid fa-heart w-3 mr-1 text-red-400"></i>HP:</span> <span class="font-mono text-white">${petStats.hp.toLocaleString()}</span></span>
                            <span class="flex justify-between"><span><i class="fa-solid fa-khanda w-3 mr-1 text-orange-400"></i>Công:</span> <span class="font-mono text-white">${petStats.atk.toLocaleString()}</span></span>
                            <span class="flex justify-between"><span><i class="fa-solid fa-shield-halved w-3 mr-1 text-blue-400"></i>Thủ:</span> <span class="font-mono text-white">${petStats.def.toLocaleString()}</span></span>
                            <span class="flex justify-between"><span><i class="fa-solid fa-person-running w-3 mr-1 text-green-400"></i>Thân:</span> <span class="font-mono text-white">${petStats.spd.toLocaleString()}</span></span>
                        </div>
                        
                        <div class="bg-gray-800/50 p-2 rounded mt-3 w-full border border-gray-700">
                            <p class="text-[10px] font-bold text-yellow-300 uppercase tracking-wide mb-1">Kỹ Năng Bị Động</p>
                            <p class="text-xs text-gray-200 leading-tight">${petDB.passiveSkill ? petDB.passiveSkill.desc : 'Không có'}</p>
                        </div>
                        
                        <div class="flex flex-wrap justify-center gap-2 w-full mt-2">
                            <button onclick="equipSungVat(null)" class="text-xs bg-red-900/80 hover:bg-red-800 text-red-200 border border-red-700/50 font-bold py-1 px-3 rounded mt-4">
                                Gỡ Xuống
                            </button>
                            <button onclick="boostPet('${petInstance.id}')" class="text-xs bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded mt-4">
                                Bồi Dưỡng
                            </button>
                            ${rebirthButton}
                        </div>
                    </div>
                `;
            } else {
                 equippedSlot.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-8">
                        <i class="fa-solid fa-paw text-6xl mb-3 opacity-30"></i>
                        <p class="font-bold text-lg">Chưa xuất chiến</p>
                        <p class="text-xs mt-2">Chọn sủng vật từ danh sách bên phải để xuất chiến.</p>
                    </div>
                `;
            }
            
            // 2. Render Pet List (Giữ nguyên logic cũ)
            const allPetsInDB = Object.values(SUNG_VAT_DB);
            allPetsInDB.sort((a,b) => a.rarity - b.rarity); 
            
            listContainer.innerHTML = '';
            let petsRendered = 0;

            allPetsInDB.forEach(petDB => {
                let effectClass = '';
                if (petDB.rarity >= 10) effectClass = 'text-rainbow-animation';
                else if (petDB.rarity >= 9) effectClass = 'text-pulse-holy-glow';
                else if (petDB.rarity >= 8) effectClass = 'text-pulse-glow';
                else if (petDB.rarity >= 7) effectClass = 'text-sparkle';

                petsRendered++;
                const petInstance = gameData.sungVat.find(p => p.id === petDB.id);
                
                // [FIX] Sửa logic hiển thị điều kiện mở khóa (Rebirth Count của người chơi)
                const playerRebirth = gameData.rebirthCount || 0;
                const isUnlocked = playerRebirth >= (petDB.rebirthReq || 0);
                
                if (petInstance) {
                    // Player owns this pet
                    const xpPercent = (petInstance.xp / petInstance.xpToNext) * 100;
                    const isEquipped = (petInstance.id === gameData.equippedSungVat);
                    const rebirthCount = petInstance.rebirthCount || 0;
                    const rebirthText = rebirthCount > 0 ? `<span class="text-red-400 font-bold ml-1 text-[10px] border border-red-500/50 rounded px-1">+${rebirthCount}</span>` : '';

                    listContainer.innerHTML += `
                    <div class="bg-black/40 backdrop-blur-sm border ${isEquipped ? 'border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.3)]' : 'border-gray-600 hover:border-cyan-500'} p-3 rounded-lg flex items-center gap-4 transition duration-200">
                        <i class="${petDB.icon} text-4xl flex-shrink-0 ${getRarityClass(petDB.rarity)} ${effectClass}"></i>
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <p class="font-bold text-sm ${getRarityClass(petDB.rarity)} ${effectClass} truncate">${petDB.name} ${rebirthText} <span class="text-gray-400 text-xs font-normal">(Lv.${petInstance.level})</span></p>
                                <div class="flex gap-2 flex-shrink-0">
                                    <button onclick="boostPet('${petInstance.id}')" class="text-[10px] bg-yellow-700/80 hover:bg-yellow-600 text-yellow-100 border border-yellow-600/50 font-bold py-1 px-2 rounded">
                                        Bồi Dưỡng
                                    </button>
                                    ${isEquipped ? 
                                        `<span class="text-[10px] font-bold text-green-400 bg-green-900/30 border border-green-500/50 px-2 py-1 rounded">Đang Dùng</span>` :
                                        `<button onclick="equipSungVat('${petInstance.id}')" class="text-[10px] bg-blue-700/80 hover:bg-blue-600 text-blue-100 border border-blue-600/50 font-bold py-1 px-2 rounded">
                                            Xuất Chiến
                                        </button>`
                                    }
                                </div>
                            </div>
                            
                            <div class="disciple-xp-bar-container w-full mb-1 h-1.5">
                                <div class="disciple-xp-bar-fill" style="width: ${petInstance.level >= 2500 ? 100 : xpPercent}%;"></div>
                            </div>
                            
                            <div class="flex justify-between items-end">
                                <p class="text-[10px] text-gray-400 truncate w-3/4">${petDB.desc}</p>
                                ${petInstance.level >= 2500 ? '<span class="text-[10px] text-purple-400 animate-pulse font-bold">Đủ điều kiện TS</span>' : ''}
                            </div>
                        </div>
                    </div>
                    `;
                } else {
                     // ... (Code hiển thị pet chưa sở hữu giữ nguyên) ...
                     // Logic hiển thị giá tiền đa dạng
                    let costDisplay = '';
                    let canAfford = false;
                    
                    const costType = petDB.costType || 'knb';
                    
                    if (costType === 'mixed') {
                        const c = petDB.mixCosts;
                        const myUD = gameData.uyDanh || 0;
                        const myDV = gameData.danhVong || 0;
                        const myCH = gameData.diemCongHien || 0;
                        const myKNB = gameData.kimNguyenBao || 0;

                        canAfford = (myUD >= c.uyDanh) && (myDV >= c.danhVong) && (myCH >= c.diemCongHien) && (myKNB >= c.kimNguyenBao);

                        costDisplay = `
                            <div class="grid grid-cols-2 gap-x-2 text-[9px] w-full">
                                <span class="${myUD >= c.uyDanh ? 'text-purple-300' : 'text-red-400'}">${c.uyDanh.toLocaleString()} UD</span>
                                <span class="${myDV >= c.danhVong ? 'text-teal-300' : 'text-red-400'}">${c.danhVong.toLocaleString()} DV</span>
                                <span class="${myCH >= c.diemCongHien ? 'text-lime-300' : 'text-red-400'}">${c.diemCongHien.toLocaleString()} CH</span>
                                <span class="${myKNB >= c.kimNguyenBao ? 'text-yellow-300' : 'text-red-400'}">${c.kimNguyenBao.toLocaleString()} KNB</span>
                            </div>
                        `;
                    } else {
                        const costValue = (petDB.costValue !== undefined) ? petDB.costValue : (petDB.costKNB || 0);
                        let costTypeName = 'KNB';
                        let currentCurrency = 0;

                        if (costType === 'diemCongHien') { costTypeName = 'ĐCH'; currentCurrency = gameData.diemCongHien || 0; } 
                        else if (costType === 'uyDanh') { costTypeName = 'Uy Danh'; currentCurrency = gameData.uyDanh || 0; } 
                        else if (costType === 'danhVong') { costTypeName = 'Danh Vọng'; currentCurrency = gameData.danhVong || 0; } 
                        else if (costType === 'diemVinhDuLienDau') { costTypeName = 'Vinh Dự'; currentCurrency = gameData.diemVinhDuLienDau || 0; } 
                        else { costTypeName = 'KNB'; currentCurrency = gameData.kimNguyenBao || 0; }
                        
                        costDisplay = `<span class="${currentCurrency >= costValue ? 'text-yellow-300' : 'text-red-400'} text-xs font-bold">${costValue.toLocaleString()} ${costTypeName}</span>`;
                        canAfford = currentCurrency >= costValue;
                    }

                    let actionButton = '';
                    if (!isUnlocked) {
                        actionButton = `<button class="text-[10px] bg-gray-700 text-gray-500 font-bold py-1 px-2 rounded cursor-not-allowed border border-gray-600 w-full" disabled>
                                            Cần TS ${petDB.rebirthReq}
                                        </button>`;
                    } else {
                         actionButton = `<button onclick="acquirePet('${petDB.id}')" class="text-xs bg-green-700 hover:bg-green-600 text-white font-bold py-1 px-3 rounded shadow-md w-full border border-green-500/50 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                                            Thu Phục
                                        </button>`;
                    }

                    listContainer.innerHTML += `
                    <div class="bg-black/30 backdrop-blur-sm border ${isUnlocked ? 'border-gray-600' : 'border-red-900/50'} p-3 rounded-lg flex items-center gap-4 ${isUnlocked ? 'opacity-80' : 'opacity-40 grayscale'} transition duration-200 hover:opacity-100 hover:grayscale-0">
                        <i class="${petDB.icon} text-4xl flex-shrink-0 ${getRarityClass(petDB.rarity)} ${effectClass}"></i>
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-sm ${getRarityClass(petDB.rarity)} ${effectClass}">${petDB.name} ${!isUnlocked ? '<span class="text-red-500 text-[10px] ml-1">(Khóa)</span>' : ''}</p>
                                    <div class="text-[10px] text-gray-400 mt-1 grid grid-cols-2 gap-x-2">
                                        <span>HP:${petDB.baseStats.hp}</span> <span>ATK:${petDB.baseStats.atk}</span>
                                        <span>DEF:${petDB.baseStats.def}</span> <span>SPD:${petDB.baseStats.spd}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-1 w-28 flex-shrink-0">
                                    ${costDisplay}
                                    ${actionButton}
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }
            });

            if (petsRendered === 0) {
                 listContainer.innerHTML = `<p class="text-center text-gray-500">Chưa có dữ liệu.</p>`;
            }
        }

        // [NEW] Modal xác nhận Trùng Sinh Sủng Vật
        function confirmPetRebirth(petId) {
            const petInstance = gameData.sungVat.find(p => p.id === petId);
            if (!petInstance) return;

            const nextRebirth = (petInstance.rebirthCount || 0) + 1;
            // [MODIFIED] Cập nhật giá 500k KNB
            const cost = 500000 * nextRebirth; 
            const canAfford = gameData.kimNguyenBao >= cost;

            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Trùng Sinh Sủng Vật';
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2 text-center text-pink-300 font-bold">Xác nhận Trùng Sinh cho ${SUNG_VAT_DB[petInstance.id].name}?</p>
                    <div class="bg-gray-800 p-3 rounded border border-gray-600 text-sm space-y-2 mt-4">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Cấp độ hiện tại:</span>
                            <span class="text-white font-mono">${petInstance.level} <i class="fa-solid fa-arrow-right text-gray-500 mx-2"></i> <span class="text-red-400 font-bold">1</span></span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                            <span class="text-gray-400">Bonus Trùng Sinh:</span>
                            <span class="text-green-400 font-bold">+${(nextRebirth * 10)}% Chỉ số (Cộng dồn)</span>
                        </div>
                        <div class="flex justify-between pt-1">
                            <span class="text-gray-400">Chi phí:</span>
                            <span class="${canAfford ? 'text-yellow-300' : 'text-red-500'} font-mono font-bold">${cost.toLocaleString()} KNB</span>
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 text-center mt-3 italic">*Sủng vật sẽ quay về cấp 1, giữ nguyên Điểm Tiềm Năng.</p>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition">Hủy</button>
                    <button onclick="performPetRebirth('${petId}')" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-2 px-6 rounded shadow-lg transition transform hover:scale-105 ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                        Xác Nhận
                    </button>
                `;
            }
            
            showModal('dungeon-confirm-modal');
        }

        // [NEW] Thực hiện Trùng Sinh Sủng Vật
        function performPetRebirth(petId) {
            const petInstance = gameData.sungVat.find(p => p.id === petId);
            if (!petInstance) return;

            const nextRebirth = (petInstance.rebirthCount || 0) + 1;
            // [MODIFIED] Cập nhật giá 500k KNB
            const cost = 500000 * nextRebirth;

            if (gameData.kimNguyenBao < cost) {
                showToast("Không đủ Kim Nguyên Bảo!", false);
                return;
            }

            // 1. Trừ tiền
            gameData.kimNguyenBao -= cost;

            // 2. Reset Pet
            petInstance.level = 1;
            petInstance.xp = 0;
            petInstance.xpToNext = getPetXpToNext(1);
            petInstance.rebirthCount = nextRebirth;
            
            // 3. Thông báo
            showToast(`${SUNG_VAT_DB[petInstance.id].name} Trùng Sinh lần ${nextRebirth} thành công! Toàn bộ chỉ số +10%.`, true);
            addSectLog(`Sủng vật [${SUNG_VAT_DB[petInstance.id].name}] đã Trùng Sinh lần ${nextRebirth}.`, 'reward');
            
            // 4. Update UI
            hideModal('dungeon-confirm-modal');
            updateUI(); // Update currency and player stats (due to pet stat change)
            renderSungVatModal();
        }

        /**
         * [NEW] Mở modal bồi dưỡng sủng vật
         */
        function boostPet(petId) {
            const petInstance = gameData.sungVat.find(p => p.id === petId);
            if (!petInstance) {
                showToast("Không tìm thấy sủng vật!", false);
                return;
            }
            // Reset boosting ID to refresh properly
            currentBoostingDiscipleId = null; // Ensure not confusing with disciple logic if shared
            
            renderBoostPetModal(petId);
            showModal('boost-pet-modal');
        }

        /**
         * [NEW] Render nội dung modal bồi dưỡng sủng vật (Có nhập số điểm)
         */
        function renderBoostPetModal(petId) {
            const petInstance = gameData.sungVat.find(p => p.id === petId);
            if (!petInstance) return;

            // [NEW] Data Migration: Nếu sủng vật cũ chưa có điểm, tính bù
            if (petInstance.potentialPoints === undefined) {
                const totalPointsShouldHave = (petInstance.level - 1) * 5;
                // Trừ đi điểm đã cộng (nếu có logic cũ, ở đây coi như mới)
                let spent = 0;
                if (!petInstance.allocatedStats) {
                    petInstance.allocatedStats = { hp: 0, atk: 0, def: 0, spd: 0 };
                } else {
                    spent = (petInstance.allocatedStats.hp || 0) + (petInstance.allocatedStats.atk || 0) + 
                            (petInstance.allocatedStats.def || 0) + (petInstance.allocatedStats.spd || 0);
                }
                petInstance.potentialPoints = Math.max(0, totalPointsShouldHave - spent);
            }
            if (!petInstance.allocatedStats) petInstance.allocatedStats = { hp: 0, atk: 0, def: 0, spd: 0 };


            const petDB = SUNG_VAT_DB[petInstance.id];
            const stats = getPetStats(petInstance);
            const contentEl = document.getElementById('boost-pet-content');
            const titleEl = document.getElementById('boost-pet-title');
            
            titleEl.textContent = `Bồi Dưỡng: ${petDB.name}`;
            
            // [NEW] Phần cộng điểm tiềm năng
            const availablePoints = petInstance.potentialPoints;
            const allocated = petInstance.allocatedStats;

            // Helper tạo dòng cộng điểm (Đã thêm Input và nút MAX)
            const createStatRow = (statId, label, color, icon) => {
                const canAdd = availablePoints > 0;
                const inputId = `pet-pot-input-${petId}-${statId}`;
                
                return `
                <div class="flex justify-between items-center bg-gray-800 p-2 rounded mb-1 border border-gray-600">
                    <div class="flex items-center gap-2 w-20 sm:w-24">
                        <i class="${icon} ${color}"></i>
                        <span class="text-xs sm:text-sm text-gray-300">${label}</span>
                    </div>
                    <div class="flex items-center gap-1 sm:gap-2">
                        <span class="text-[10px] sm:text-xs text-gray-500 font-mono hidden sm:inline">Đã cộng:</span>
                        <span class="text-xs text-white font-mono min-w-[20px] text-right mr-1">${allocated[statId] || 0}</span>
                        
                        <!-- Input nhập số -->
                        <input type="number" id="${inputId}" 
                               class="w-10 sm:w-12 h-6 bg-gray-900 border border-gray-600 rounded text-center text-xs text-white focus:border-yellow-400 outline-none" 
                               value="1" min="1" max="${availablePoints > 0 ? availablePoints : 1}" 
                               onfocus="this.select()"
                               onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                        
                        <!-- Nút MAX -->
                        <button onclick="document.getElementById('${inputId}').value = ${availablePoints > 0 ? availablePoints : 1}" 
                                class="h-6 px-1 bg-gray-700 hover:bg-gray-600 text-[8px] text-yellow-300 rounded border border-gray-600 transition" 
                                title="Cộng tối đa">MAX</button>
                        
                        <!-- Nút Cộng -->
                        <button onclick="allocatePetPotential('${petId}', '${statId}')" 
                                class="w-6 h-6 sm:w-8 sm:h-6 rounded flex items-center justify-center transition ${canAdd ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-sm' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}" 
                                ${!canAdd ? 'disabled' : ''}>
                            <i class="fa-solid fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>`;
            };

            // Hiển thị chỉ số
            let html = `
                <div class="flex items-center gap-4 mb-4 bg-gray-900/50 p-3 rounded-lg">
                    <div class="w-16 h-16 flex items-center justify-center bg-black/40 rounded-full border border-gray-600">
                        <i class="${petDB.icon} text-3xl ${getRarityClass(petDB.rarity)}"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-lg text-white">Cấp ${petInstance.level}</h4>
                        <div class="text-xs text-gray-400 mt-1 grid grid-cols-2 gap-x-4">
                            <span><i class="fa-solid fa-heart text-red-400"></i> HP: ${stats.hp.toLocaleString()}</span>
                            <span><i class="fa-solid fa-khanda text-orange-400"></i> ATK: ${stats.atk.toLocaleString()}</span>
                            <span><i class="fa-solid fa-shield-halved text-blue-400"></i> DEF: ${stats.def.toLocaleString()}</span>
                            <span><i class="fa-solid fa-person-running text-green-400"></i> SPD: ${stats.spd.toLocaleString()}</span>
                        </div>
                    </div>
                </div>

                <!-- [NEW] Khu vực cộng điểm -->
                <div class="bg-black/20 p-3 rounded-lg border border-yellow-600/30 mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h5 class="font-bold text-yellow-300 text-sm uppercase">Phân Phối Tiềm Năng</h5>
                        <span class="text-xs text-gray-400">Còn lại: <span class="text-yellow-400 font-bold text-lg animate-pulse">${availablePoints}</span> điểm</span>
                    </div>
                    ${createStatRow('hp', 'Sinh Lực', 'text-red-400', 'fa-solid fa-heart')}
                    ${createStatRow('atk', 'Công Kích', 'text-orange-400', 'fa-solid fa-khanda')}
                    ${createStatRow('def', 'Phòng Thủ', 'text-blue-400', 'fa-solid fa-shield-halved')}
                    ${createStatRow('spd', 'Thân Pháp', 'text-green-400', 'fa-solid fa-wind')}
                    <p class="text-[10px] text-gray-500 mt-1 italic text-center">* 1 điểm = +20 HP hoặc +2 ATK/DEF/SPD</p>
                </div>
                
                <h4 class="font-bold text-lg mb-2 text-cyan-400">Thức Ăn Khả Dụng</h4>
                <div class="space-y-2">
            `;

            // ... (Phần render thức ăn giữ nguyên như cũ) ...
            const foodIds = ['pet_food_8', 'pet_food_7', 'pet_food_6', 'pet_food_5', 'pet_food_4', 'pet_food_3', 'pet_food_2', 'pet_food_1'];
            let hasFood = false;

            foodIds.forEach(itemId => {
                const itemDB = STATIC_ITEM_DB[itemId];
                const owned = gameData.items[itemId] || 0;
                
                if (owned > 0) {
                    hasFood = true;
                    // Format số XP lớn cho gọn
                    let xpDisplay = itemDB.effect.value.toLocaleString();
                    if (itemDB.effect.value >= 1000000000) xpDisplay = (itemDB.effect.value / 1000000000) + " Tỷ";
                    else if (itemDB.effect.value >= 1000000) xpDisplay = (itemDB.effect.value / 1000000) + " Triệu";

                    html += `
                    <div class="bg-gray-700 rounded p-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center">
                                <i class="${itemDB.icon}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm ${getRarityClass(itemDB.rarity)}">${itemDB.name}</p>
                                <p class="text-xs text-green-300">+${xpDisplay} XP</p>
                            </div>
                        </div>
                        <button onclick="usePetFood('${petId}', '${itemId}')" class="text-xs bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded">
                            Cho Ăn (Có: ${owned})
                        </button>
                    </div>
                    `;
                }
            });

            if (!hasFood) {
                html += `
                    <div class="text-center py-4 bg-gray-700/30 rounded border border-dashed border-gray-600">
                        <p class="text-gray-400 text-sm">Không có thức ăn nào.</p>
                        <button onclick="hideModal('boost-pet-modal'); showModal('tien-trang-modal'); switchTienTrangTab('buy');" class="mt-2 text-xs text-blue-400 hover:text-blue-300 underline">
                            Mua tại Tiền Trang (Tab Tiêu Hao)
                        </button>
                    </div>
                `;
            }

            html += `</div>`;
            contentEl.innerHTML = html;
        }

        /**
         * [NEW] Hàm cộng điểm tiềm năng cho Sủng Vật (Cập nhật: Nhập số lượng)
         */
        function allocatePetPotential(petId, statType) {
            const petInstance = gameData.sungVat.find(p => p.id === petId);
            if (!petInstance) return;

            // [NEW] Lấy giá trị từ input
            const inputEl = document.getElementById(`pet-pot-input-${petId}-${statType}`);
            let amount = 1;
            
            if (inputEl) {
                amount = parseInt(inputEl.value, 10);
                if (isNaN(amount) || amount <= 0) amount = 1;
            }

            if (petInstance.potentialPoints <= 0) {
                showToast("Không đủ điểm tiềm năng!", false);
                return;
            }

            // [NEW] Kiểm tra xem có đủ điểm cho số lượng muốn cộng không
            if (petInstance.potentialPoints < amount) {
                // Nếu không đủ, cộng hết số điểm còn lại
                amount = petInstance.potentialPoints;
                showToast(`Chỉ còn ${amount} điểm, đã cộng toàn bộ.`, true);
            }

            // Trừ điểm
            petInstance.potentialPoints -= amount;
            
            // Cộng stat
            if (!petInstance.allocatedStats) petInstance.allocatedStats = { hp: 0, atk: 0, def: 0, spd: 0 };
            petInstance.allocatedStats[statType] = (petInstance.allocatedStats[statType] || 0) + amount;

            // Re-render
            renderBoostPetModal(petId);
            
            // Cập nhật UI chính nếu pet đang trang bị
            if (gameData.equippedSungVat === petId) {
                updateUI();
            }
            
            // Cập nhật list nếu đang mở modal Sủng Vật
             if (!document.getElementById('sung-vat-modal').classList.contains('hidden')) {
                renderSungVatModal();
            }
        }

        /**
         * [NEW] Sử dụng thức ăn cho sủng vật
         */
        function usePetFood(petId, itemId) {
            const petInstance = gameData.sungVat.find(p => p.id === petId);
            const itemDB = STATIC_ITEM_DB[itemId];
            
            if (!petInstance || !itemDB) return;
            if (!gameData.items[itemId] || gameData.items[itemId] <= 0) {
                showToast("Đã hết thức ăn!", false);
                renderBoostPetModal(petId);
                return;
            }

            // 1. Trừ vật phẩm
            gameData.items[itemId]--;
            if (gameData.items[itemId] <= 0) delete gameData.items[itemId];

            // 2. Cộng XP
            const xpGain = itemDB.effect.value;
            petInstance.xp += xpGain;
            
            let levelUpCount = 0; // [MODIFIED] Count levels gained
            // Xử lý lên cấp
            while (petInstance.xp >= petInstance.xpToNext) {
                // [MODIFIED] Check cap 2500
                if (petInstance.level >= 2500) {
                    petInstance.level = 2500;
                    petInstance.xp = 0;
                    petInstance.xpToNext = Infinity;
                    break;
                }
                petInstance.level++;
                petInstance.xp -= petInstance.xpToNext;
                petInstance.xpToNext = getPetXpToNext(petInstance.level);
                
                // [NEW] Cộng điểm tiềm năng
                if (petInstance.potentialPoints === undefined) petInstance.potentialPoints = 0;
                petInstance.potentialPoints += 5;
                
                levelUpCount++;
            }

            // 3. Thông báo và cập nhật UI
            let msg = `${SUNG_VAT_DB[petInstance.id].name} nhận ${xpGain.toLocaleString()} XP.`;
            if (levelUpCount > 0) {
                msg += ` Thăng ${levelUpCount} cấp! (+${levelUpCount * 5} Tiềm Năng)`;
                showToast(msg, true);
                updateUI(); // Cập nhật lực chiến nhân vật
            } else {
                showToast(msg, true);
            }

            renderBoostPetModal(petId);
            // Cập nhật list bên dưới nếu đang mở
            if (!document.getElementById('sung-vat-modal').classList.contains('hidden')) {
                renderSungVatModal();
            }
        }

        /**
         * [NEW] Acquire (buy) a new pet
         */
        function acquirePet(petId) {
            const petDB = SUNG_VAT_DB[petId];
            if (!petDB) {
                showToast("Lỗi: Không tìm thấy sủng vật!", false);
                return;
            }

            // 1. Check if already owned
            if (gameData.sungVat.find(p => p.id === petId)) {
                showToast("Bạn đã sở hữu sủng vật này!", false);
                return;
            }

            // 2. Check rebirth (Vẫn giữ kiểm tra server-side để an toàn)
            if (gameData.rebirthCount < (petDB.rebirthReq || 0)) {
                showToast("Chưa đủ cấp Trùng Sinh để thu phục sủng vật này!", false);
                return;
            }

            // 3. Check cost
            const costType = petDB.costType || 'knb';
            
            if (costType === 'mixed') {
                // [NEW] Logic mua hỗn hợp
                const c = petDB.mixCosts;
                
                // Kiểm tra đủ tiền
                if ((gameData.uyDanh || 0) < c.uyDanh) { showToast(`Thiếu ${c.uyDanh - (gameData.uyDanh||0)} Uy Danh!`, false); return; }
                if ((gameData.danhVong || 0) < c.danhVong) { showToast(`Thiếu ${c.danhVong - (gameData.danhVong||0)} Danh Vọng!`, false); return; }
                if ((gameData.diemCongHien || 0) < c.diemCongHien) { showToast(`Thiếu ${c.diemCongHien - (gameData.diemCongHien||0)} Cống Hiến!`, false); return; }
                if ((gameData.kimNguyenBao || 0) < c.kimNguyenBao) { showToast(`Thiếu ${c.kimNguyenBao - (gameData.kimNguyenBao||0)} KNB!`, false); return; }

                // Trừ tiền
                gameData.uyDanh -= c.uyDanh;
                gameData.danhVong -= c.danhVong;
                gameData.diemCongHien -= c.diemCongHien;
                gameData.kimNguyenBao -= c.kimNguyenBao;

            } else {
                // Logic mua đơn giá cũ
                const costValue = (petDB.costValue !== undefined) ? petDB.costValue : (petDB.costKNB || 0);
                
                if (costType === 'diemCongHien') {
                    if ((gameData.diemCongHien || 0) < costValue) {
                        showToast(`Không đủ ${costValue.toLocaleString()} Điểm Cống Hiến!`, false);
                        return;
                    }
                    gameData.diemCongHien -= costValue;
                } else if (costType === 'uyDanh') {
                    if ((gameData.uyDanh || 0) < costValue) {
                        showToast(`Không đủ ${costValue.toLocaleString()} Uy Danh!`, false);
                        return;
                    }
                    gameData.uyDanh -= costValue;
                } else if (costType === 'danhVong') {
                    if ((gameData.danhVong || 0) < costValue) {
                        showToast(`Không đủ ${costValue.toLocaleString()} Danh Vọng!`, false);
                        return;
                    }
                    gameData.danhVong -= costValue;
                } else if (costType === 'diemVinhDuLienDau') { 
                    if ((gameData.diemVinhDuLienDau || 0) < costValue) {
                        showToast(`Không đủ ${costValue.toLocaleString()} Điểm Vinh Dự!`, false);
                        return;
                    }
                    gameData.diemVinhDuLienDau -= costValue;
                } else {
                    if (gameData.kimNguyenBao < costValue) {
                        showToast(`Không đủ ${costValue.toLocaleString()} KNB!`, false);
                        return;
                    }
                    gameData.kimNguyenBao -= costValue;
                }
            }

            // 4. Process transaction
            const newPetInstance = {
                id: petId,
                level: 1,
                xp: 0,
                xpToNext: getPetXpToNext(1),
                potentialPoints: 0, // [NEW] Init potential points
                allocatedStats: { hp: 0, atk: 0, def: 0, spd: 0 } // [NEW] Init stats
            };
            gameData.sungVat.push(newPetInstance);

            showToast(`Thu phục thành công ${petDB.name}!`, true);
            
            // 5. Update UI
            renderSungVatModal();
            updateUI(); // Update currency
        }
        
        /**
         * [NEW] Equip/Unequip a pet (MODIFIED)
         */
                        function equipSungVat(petId) {
            // petId can be null (để gỡ xuống) hoặc là một ID
            
            if (petId === null) {
                // Gỡ sủng vật
                if (gameData.equippedSungVat) {
                    gameData.equippedSungVat = null;
                    showToast("Đã gỡ sủng vật.", true);
                }
            } else {
                // Trang bị sủng vật
                const petInstance = gameData.sungVat.find(p => p.id === petId);
                if (!petInstance) {
                    showToast("Lỗi: Không tìm thấy sủng vật!", false);
                    return;
                }
                gameData.equippedSungVat = petId;
                const petDB = SUNG_VAT_DB[petInstance.id];
                showToast(`Đã xuất chiến ${petDB.name}!`, true);
            }

            // Cập nhật lại UI
            renderSungVatModal();
            // [NEW] Không gọi updateUI() hoặc getTotalStats() vì bạn yêu cầu không cộng chỉ số
            // [MODIFIED] Calling updateUI() to apply stats
            updateUI();
        }
        // [END NEW] --- Sung Vat (Pet) Functions ---

        <!-- [NEW] --- Dau La Dai Luc (Turn-Based) Functions --- -->

        // [MODIFIED] Renders the sub-map list for Dau La Dai Luc dynamically

        // [NEW] --- Sect Mission Functions ---

        /**
         * [NEW] Chỉ cập nhật danh sách nhiệm vụ đang hoạt động (để đếm ngược)
         */
        function updateActiveMissionTimers() {
            const activeList = document.getElementById('active-mission-list');
            if (!activeList) return;

            const now = Date.now();
            let activeHtml = '';

            const disciplesOnMission = gameData.disciples.filter(d => d.status === 'Nhiệm Vụ' && d.assignedMission);

            // [NEW] Cập nhật nút Nhận Thưởng Nhanh
            const completedCount = disciplesOnMission.filter(d => now >= d.assignedMission.completionTime).length;
            const claimContainer = document.getElementById('sect-mission-claim-all-container');
            
            if (claimContainer) {
                if (completedCount > 0) {
                    claimContainer.innerHTML = `
                        <button onclick="collectAllSectMissions()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-1 px-3 rounded text-sm shadow-lg animate-pulse transition transform hover:scale-105 border border-green-400 flex items-center gap-2">
                            <i class="fa-solid fa-check-double"></i> Nhận Thưởng (${completedCount})
                        </button>
                    `;
                } else {
                    claimContainer.innerHTML = '';
                }
            }

            // 1. Render Active Missions (Disciples on missions)
            disciplesOnMission.forEach(d => {
                const mission = SECT_MISSIONS_DB[d.assignedMission.missionId];
                if (!mission) return; // Bỏ qua nếu nhiệm vụ không còn tồn tại
                
                const remainingMs = Math.max(0, d.assignedMission.completionTime - now);
                
                // [NEW] Tính phí hoàn thành nhanh (50 - 500 KNB)
                const quickCost = Math.min(500, Math.max(50, mission.levelReq * 5));

                let buttonHtml = '';
                if (remainingMs > 0) {
                    const remainingSeconds = Math.ceil(remainingMs / 1000);
                    // [MODIFIED] Thêm nút Hoàn thành nhanh
                    buttonHtml = `
                        <div class="flex flex-col items-end gap-1 pointer-events-auto z-20">
                            <button onclick="confirmQuickComplete('${d.id}', ${quickCost})" class="text-[10px] bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-1 px-2 rounded border border-yellow-400/50 shadow-md flex items-center gap-1 transition transform hover:scale-105" title="Dùng KNB hoàn thành ngay">
                                <i class="fa-solid fa-bolt text-yellow-200"></i> Xong Ngay (${quickCost} KNB)
                            </button>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500 font-mono min-w-[30px] text-center bg-black/20 rounded px-1">${remainingSeconds}s</span>
                                <button onclick="cancelSectMission('${d.id}')" class="text-[10px] font-bold text-red-500 hover:text-red-400 border border-red-500/30 hover:border-red-400 px-2 py-0.5 rounded transition hover:bg-red-900/20">
                                    Hủy
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    buttonHtml = `<button onclick="completeSectMission('${d.id}')" class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded shadow-lg animate-pulse z-10 border border-green-400/50">Hoàn Thành</button>`;
                }

                activeHtml += `
                <div class="bg-gray-700 p-3 rounded shadow flex justify-between items-center relative group border border-gray-600">
                    <div>
                        <p class="font-bold text-base text-yellow-300">${d.name} <span class="text-xs text-gray-400 font-normal">(Cấp ${d.level})</span></p>
                        <p class="text-sm text-gray-300 mt-0.5">Đang làm: <span class="text-cyan-300">${mission.name}</span></p>
                    </div>
                    <div class="flex-shrink-0 ml-4">
                        ${buttonHtml}
                    </div>
                </div>
                `;
            });

            if (activeHtml === '') {
                // [MODIFIED] Thêm col-span-full để căn giữa trong grid
                activeHtml = '<p class="text-center text-gray-400 col-span-full">Không có đệ tử nào đang làm nhiệm vụ.</p>';
            }
            activeList.innerHTML = activeHtml;
        }

        /**
         * [NEW] Nhận thưởng tất cả nhiệm vụ đã hoàn thành
         */
        function collectAllSectMissions() {
            const now = Date.now();
            const completedDisciples = gameData.disciples.filter(d => 
                d.status === 'Nhiệm Vụ' && 
                d.assignedMission && 
                now >= d.assignedMission.completionTime
            );

            if (completedDisciples.length === 0) {
                showToast("Chưa có nhiệm vụ nào hoàn thành!", false);
                return;
            }

            let totalDCH = 0;
            let totalNL = 0;
            let totalXP = 0;
            let count = 0;
            
            // Áp dụng tăng thưởng từ Upgrade
            const rewardBonus = getSectUpgradeBonus('missionReward');
            const rewardMultiplier = 1 + (rewardBonus / 100);

            completedDisciples.forEach(disciple => {
                const missionId = disciple.assignedMission.missionId;
                const mission = SECT_MISSIONS_DB[missionId];
                
                // Nếu nhiệm vụ tồn tại (tránh lỗi data cũ)
                if (mission) {
                    const rewards = mission.rewards;
                    
                    const finalDCH = Math.floor(rewards.diemCongHien * rewardMultiplier);
                    const finalNL = Math.floor(rewards.nganLuong * rewardMultiplier);
                    
                    totalDCH += finalDCH;
                    totalNL += finalNL;
                    
                    if (rewards.xp && rewards.xp > 0) {
                         const xpGained = Math.floor(rewards.xp * rewardMultiplier);
                         totalXP += xpGained;
                         addDiscipleXp(disciple.id, xpGained); // Cộng XP và xử lý thăng cấp
                    }
                    
                    // Reset trạng thái đệ tử
                    disciple.status = 'Nhàn Rỗi';
                    disciple.assignedMission = null;
                    count++;
                } else {
                    // Nhiệm vụ bị lỗi, reset đệ tử để tránh kẹt
                    disciple.status = 'Nhàn Rỗi';
                    disciple.assignedMission = null;
                }
            });

            // Cộng tài nguyên tổng
            gameData.diemCongHien = (gameData.diemCongHien || 0) + totalDCH;
            gameData.nganLuong += totalNL;

            // Thông báo tổng kết
            let msg = `Đã nhận thưởng ${count} nhiệm vụ! Tổng: ${totalDCH.toLocaleString()} ĐCH, ${totalNL.toLocaleString()} NL`;
            if (totalXP > 0) msg += `, ${totalXP.toLocaleString()} XP`;
            if (rewardBonus > 0) msg += ` (Thưởng thêm ${rewardBonus}%)`;
            
            showToast(msg, true);
            addSectLog(msg, 'reward');

            // Cập nhật giao diện
            updateActiveMissionTimers();
            updateUI();
            
            // Nếu đang mở tab bồi dưỡng, render lại để cập nhật trạng thái Nhàn rỗi
            if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                renderDiscipleList();
            }
            
            // Cập nhật lại danh sách nhiệm vụ khả dụng (để giao tiếp)
            renderSectMissionPanel();
        }

        /**
         * [NEW] Xác nhận Hoàn thành nhanh nhiệm vụ bằng KNB
         */
        function confirmQuickComplete(discipleId, cost) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple || !disciple.assignedMission) {
                showToast("Lỗi: Không tìm thấy nhiệm vụ!", false); return;
            }

            if (gameData.kimNguyenBao < cost) {
                showToast(`Không đủ ${cost} KNB để hoàn thành nhanh!`, false);
                return;
            }

            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Hoàn Thành Nhanh';
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2">Dùng <strong class="text-yellow-300">${cost} KNB</strong> để hoàn thành ngay nhiệm vụ của <strong>${disciple.name}</strong>?</p>
                    <p class="text-gray-400 text-sm italic">Đệ tử sẽ hoàn thành nhiệm vụ và nhận thưởng ngay lập tức.</p>
                    <p class="text-xs text-gray-500 mt-2">KNB hiện có: ${gameData.kimNguyenBao.toLocaleString()}</p>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Hủy</button>
                    <button onclick="performQuickComplete('${discipleId}', ${cost})" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded shadow-lg border border-yellow-500/50">
                        <i class="fa-solid fa-bolt mr-1"></i> Xác Nhận
                    </button>
                `;
            }
            
            showModal('dungeon-confirm-modal');
        }

        /**
         * [NEW] Thực hiện Hoàn thành nhanh
         */
        function performQuickComplete(discipleId, cost) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple || !disciple.assignedMission) return;

            if (gameData.kimNguyenBao < cost) {
                showToast("Không đủ KNB!", false);
                hideModal('dungeon-confirm-modal');
                return;
            }

            // 1. Trừ KNB
            gameData.kimNguyenBao -= cost;

            // 2. Set thời gian hoàn thành về quá khứ để pass check của completeSectMission
            disciple.assignedMission.completionTime = Date.now() - 1000;

            // 3. Gọi hàm hoàn thành bình thường
            completeSectMission(discipleId);

            // 4. Cập nhật UI
            hideModal('dungeon-confirm-modal');
            showToast(`Đã dùng ${cost} KNB hoàn thành nhiệm vụ!`, true);
            updateUI(); // Cập nhật số KNB hiển thị
        }

        /**
         * [MODIFIED] Hủy nhiệm vụ Tông Môn (Sử dụng Modal thay vì confirm)
         */
        function cancelSectMission(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple || !disciple.assignedMission) {
                showToast("Lỗi: Không tìm thấy đệ tử hoặc nhiệm vụ!", false); return;
            }

            // [FIX] Thay thế window.confirm bằng Modal trong game để tránh bị chặn
            const titleEl = document.getElementById('dungeon-confirm-title');
            const summaryEl = document.getElementById('dungeon-confirm-summary');
            const buttonsEl = document.getElementById('dungeon-confirm-buttons');
            
            if (titleEl) titleEl.textContent = 'Xác Nhận Hủy Nhiệm Vụ';
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <p class="text-lg mb-2">Bạn có chắc muốn hủy nhiệm vụ của <strong>${disciple.name}</strong>?</p>
                    <div class="bg-red-900/20 border border-red-500/30 p-3 rounded text-sm text-red-200">
                        <p><i class="fa-solid fa-circle-exclamation mr-2"></i>Cảnh báo:</p>
                        <ul class="list-disc list-inside ml-2 mt-1">
                            <li>Tiến độ nhiệm vụ sẽ bị mất hoàn toàn.</li>
                            <li>Không nhận được phần thưởng.</li>
                            <li>Đệ tử sẽ trở về trạng thái "Nhàn Rỗi".</li>
                        </ul>
                    </div>
                `;
            }
            if (buttonsEl) {
                buttonsEl.innerHTML = `
                    <button onclick="hideModal('dungeon-confirm-modal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Đóng</button>
                    <button onclick="performCancelSectMission('${discipleId}')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded shadow-lg">Xác Nhận Hủy</button>
                `;
            }
            
            showModal('dungeon-confirm-modal');
        }

        /**
         * [NEW] Thực hiện hủy nhiệm vụ (Sau khi xác nhận qua Modal)
         */
        function performCancelSectMission(discipleId) {
             const disciple = gameData.disciples.find(d => d.id === discipleId);
             if (!disciple) return;

             const missionId = disciple.assignedMission.missionId;
             const missionName = SECT_MISSIONS_DB[missionId] ? SECT_MISSIONS_DB[missionId].name : 'Nhiệm vụ';

             // Reset trạng thái
             disciple.status = 'Nhàn Rỗi';
             disciple.assignedMission = null;
             
             // Log và thông báo
             addSectLog(`${disciple.name} đã hủy bỏ nhiệm vụ: ${missionName}.`, 'info');
             showToast(`Đã hủy nhiệm vụ của ${disciple.name}.`, true);
             
             // Đóng modal và cập nhật UI
             hideModal('dungeon-confirm-modal');
             renderSectMissionPanel();
             
             // Cập nhật danh sách đệ tử nếu đang mở tab bồi dưỡng
             if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                renderDiscipleList();
            }
        }

        /**
         * Hiển thị bảng Nhiệm Vụ Tông Môn (Render đầy đủ)
         */
        function renderSectMissionPanel() {
            const activeList = document.getElementById('active-mission-list'); // [MODIFIED]
            const availableList = document.getElementById('available-mission-list');
            if (!activeList || !availableList) return; // [MODIFIED]

            // 1. Cập nhật danh sách đang hoạt động
            updateActiveMissionTimers(); // [NEW] Gọi hàm mới

            // 2. Render Available Missions (Danh sách này chỉ render khi mở tab)
            let availableHtml = ''; // [MODIFIED]
            
            // [MODIFIED] Lấy danh sách đệ tử rảnh rỗi VÀ KHÔNG ĐANG XUẤT CHIẾN
            const championId = gameData.sect.combatChampionId;
            const availableDisciples = gameData.disciples.filter(d => d.status === 'Nhàn Rỗi' && d.id !== championId);
            
            const missionsInProgress = gameData.disciples
                .filter(d => d.status === 'Nhiệm Vụ' && d.assignedMission)
                .map(d => d.assignedMission.missionId);

            const missions = Object.values(SECT_MISSIONS_DB);
            missions.sort((a,b) => a.levelReq - b.levelReq);

            // [NEW] Lấy bonus giảm thời gian và tăng thưởng để hiển thị
            const speedBonus = getSectUpgradeBonus('missionSpeed');
            const durationMultiplier = Math.max(0.1, 1 - (speedBonus / 100));
            
            const rewardBonus = getSectUpgradeBonus('missionReward');
            const rewardMultiplier = 1 + (rewardBonus / 100);

            missions.forEach(mission => {
                // Đã có người làm nhiệm vụ này rồi (đơn giản hóa: 1 nhiệm vụ 1 người làm)
                if (missionsInProgress.includes(mission.id)) return; 

                // Lọc danh sách đệ tử rảnh rỗi VÀ đủ cấp
                const eligibleDisciples = availableDisciples.filter(d => d.level >= mission.levelReq);
                let selectHtml = `<select id="disciple-select-${mission.id}" class="bg-gray-800 border border-gray-600 rounded p-2 text-white text-sm w-full sm:w-auto">`;
                selectHtml += `<option value="">Chọn đệ tử...</option>`;
                
                if (eligibleDisciples.length > 0) {
                    eligibleDisciples.forEach(d => {
                        selectHtml += `<option value="${d.id}">${d.name} (Cấp ${d.level})</option>`;
                    });
                } else {
                    selectHtml += `<option value="" disabled>Không có đệ tử phù hợp</option>`;
                }
                selectHtml += `</select>`;

                // [MODIFIED] Tính thời gian hiển thị sau khi giảm
                const finalDuration = Math.floor(mission.duration * durationMultiplier);
                const durationMinutes = (finalDuration / 60000).toFixed(0);
                let durationText = `${durationMinutes} phút`;
                if (speedBonus > 0) {
                    durationText += ` <span class="text-green-400">(-${speedBonus}%)</span>`;
                }

                // [MODIFIED] Tính thưởng hiển thị sau khi tăng
                const displayDCH = Math.floor(mission.rewards.diemCongHien * rewardMultiplier);
                const displayNL = Math.floor(mission.rewards.nganLuong * rewardMultiplier);
                
                let xpRewardText = "";
                if (mission.rewards.xp && mission.rewards.xp > 0) {
                    const displayXP = Math.floor(mission.rewards.xp * rewardMultiplier);
                    xpRewardText = `, ${displayXP.toLocaleString()} XP`;
                }
                
                let bonusText = "";
                if (rewardBonus > 0) {
                    bonusText = ` <span class="text-green-400">(+${rewardBonus}%)</span>`;
                }

                availableHtml += `
                <div class="bg-gray-700 p-3 rounded shadow h-full flex flex-col justify-between">
                    <div>
                        <p class="font-bold text-base text-cyan-300">${mission.name} (Cần Cấp ${mission.levelReq})</p>
                        <p class="text-sm text-gray-300 mt-1">${mission.desc}</p>
                        <!-- [MODIFIED] Update reward text with bonus info -->
                        <p class="text-xs text-yellow-300 mt-1">Thưởng: ${displayDCH} ĐCH, ${displayNL.toLocaleString()} NL${xpRewardText}${bonusText}</p>
                        <p class="text-xs text-gray-400 mt-1">Thời gian: ${durationText}</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-3">
                        ${selectHtml}
                        <button onclick="startSectMission('${mission.id}')" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded flex-shrink-0 ${eligibleDisciples.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${eligibleDisciples.length === 0 ? 'disabled' : ''}>
                            Giao Phó
                        </button>
                    </div>
                </div>
                `;
            });
            if (availableHtml === '') {
                // [MODIFIED] Thêm col-span-full để căn giữa trong grid
                availableHtml = '<p class="text-center text-gray-400 col-span-full">Tất cả nhiệm vụ đã được giao.</p>';
            }
            availableList.innerHTML = availableHtml;
        }

        /**
         * Giao phó nhiệm vụ cho đệ tử
         */
        function startSectMission(missionId) {
            const mission = SECT_MISSIONS_DB[missionId];
            const selectEl = document.getElementById(`disciple-select-${missionId}`);
            if (!mission || !selectEl) {
                showToast("Lỗi: Không tìm thấy nhiệm vụ hoặc danh sách!", false); return;
            }
            
            const discipleId = selectEl.value;
            if (!discipleId) {
                showToast("Vui lòng chọn một đệ tử!", false); return;
            }

            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple) {
                showToast("Lỗi: Không tìm thấy đệ tử!", false); return;
            }

            // Validation checks
            if (disciple.status !== 'Nhàn Rỗi') {
                showToast(`${disciple.name} đang bận!`, false); return;
            }

            // [NEW] Kiểm tra nếu đang là Combat Champion (Xuất Chiến)
            if (gameData.sect.combatChampionId === disciple.id) {
                 showToast(`${disciple.name} đang Xuất Chiến hộ chủ, không thể làm nhiệm vụ!`, false); 
                 return;
            }

            if (disciple.level < mission.levelReq) {
                showToast(`${disciple.name} không đủ cấp độ!`, false); return;
            }
            
            // [NEW] Áp dụng giảm thời gian từ Upgrade
            const speedBonus = getSectUpgradeBonus('missionSpeed');
            const durationMultiplier = Math.max(0.1, 1 - (speedBonus / 100)); // Tối thiểu 10% thời gian gốc
            const finalDuration = Math.floor(mission.duration * durationMultiplier);

            // Assign mission
            disciple.status = 'Nhiệm Vụ';
            disciple.assignedMission = {
                missionId: missionId,
                completionTime: Date.now() + finalDuration // [MODIFIED] Dùng thời gian đã giảm
            };

            let logMsg = `${disciple.name} đã bắt đầu làm nhiệm vụ: ${mission.name}.`;
            if (speedBonus > 0) logMsg += ` (Giảm ${speedBonus}% thời gian)`;
            
            addSectLog(logMsg, 'info');
            showToast(`${disciple.name} đã bắt đầu nhiệm vụ!`, true);

            // Re-render
            renderSectMissionPanel();
            // Re-render disciple list if open (to update status)
            if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                renderDiscipleList();
            }
        }

        /**
         * Hoàn thành nhiệm vụ và nhận thưởng
         */
        function completeSectMission(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple || !disciple.assignedMission) {
                showToast("Lỗi: Không tìm thấy đệ tử hoặc nhiệm vụ!", false); return;
            }

            const now = Date.now();
            if (now < disciple.assignedMission.completionTime) {
                showToast("Nhiệm vụ chưa hoàn thành!", false); return;
            }

            const mission = SECT_MISSIONS_DB[disciple.assignedMission.missionId];
            if (!mission) {
                 showToast("Lỗi: Không tìm thấy dữ liệu nhiệm vụ!", false); 
                 // Reset disciple anyway
                 disciple.status = 'Nhàn Rỗi';
                 disciple.assignedMission = null;
                 renderSectMissionPanel();
                 return;
            }

            // [NEW] Áp dụng tăng thưởng từ Upgrade
            const rewardBonus = getSectUpgradeBonus('missionReward');
            const rewardMultiplier = 1 + (rewardBonus / 100);

            // 1. Add Rewards
            const rewards = mission.rewards;
            const finalDCH = Math.floor(rewards.diemCongHien * rewardMultiplier);
            const finalNL = Math.floor(rewards.nganLuong * rewardMultiplier);

            gameData.diemCongHien = (gameData.diemCongHien || 0) + finalDCH;
            gameData.nganLuong += finalNL;

            // [NEW] Add XP reward logic with Bonus
            let xpGained = 0;
            let xpMsg = "";
            if (rewards.xp && rewards.xp > 0) {
                xpGained = Math.floor(rewards.xp * rewardMultiplier);
                addDiscipleXp(disciple.id, xpGained); // Use the helper to grant XP and level up
                xpMsg = `, ${xpGained.toLocaleString()} XP`;
            }
            // [END NEW]

            // 2. Log and Toast
            // [MODIFIED] Update log message
            let rewardMsg = `${disciple.name} hoàn thành ${mission.name}! Nhận ${finalDCH} ĐCH, ${finalNL.toLocaleString()} NL${xpMsg}.`;
            if (rewardBonus > 0) rewardMsg += ` (Thưởng thêm ${rewardBonus}%)`;
            
            addSectLog(rewardMsg, 'reward');
            showToast(rewardMsg, true);

            // 3. Reset Disciple
            disciple.status = 'Nhàn Rỗi';
            disciple.assignedMission = null;

            // 4. Re-render
            renderSectMissionPanel();
            updateUI(); // Update currencies
        }

        // [NEW] --- Auto-Assign Mission Function ---

        /**
         * [NEW] Giao nhiệm vụ cho 1 đệ tử (Helper cho auto-assign)
         */
        function assignMissionToDisciple(disciple, mission) {
             if (!disciple || !mission || disciple.status !== 'Nhàn Rỗi' || disciple.level < mission.levelReq) {
                 return false;
             }

            // [NEW] Áp dụng giảm thời gian
            const speedBonus = getSectUpgradeBonus('missionSpeed');
            const durationMultiplier = Math.max(0.1, 1 - (speedBonus / 100));
            const finalDuration = Math.floor(mission.duration * durationMultiplier);

            // Assign mission
            disciple.status = 'Nhiệm Vụ';
            disciple.assignedMission = {
                missionId: mission.id,
                completionTime: Date.now() + finalDuration, // [MODIFIED] Dùng thời gian giảm
                notified: false 
            };

            addSectLog(`(Tự động) ${disciple.name} đã bắt đầu làm nhiệm vụ: ${mission.name}.`, 'info');
            return true;
        }

        // [NEW] --- Sect Shop Functions ---
        function renderSectShop() {
            const listContainer = document.getElementById('sect-shop-list');
            const dchDisplay = document.getElementById('sect-shop-dch-display');
            if (!listContainer || !dchDisplay) return;

            const currentDCH = gameData.diemCongHien || 0;
            const currentLT = gameData.linhThach || 0;

            // [NEW] Tính toán giảm giá
            const discountPercent = getSectUpgradeBonus('shopDiscount');
            const costMultiplier = Math.max(0.1, 1 - (discountPercent / 100));
            let discountMsg = '';
            if (discountPercent > 0) {
                discountMsg = `<span class="text-xs text-yellow-300 ml-2">(Giảm giá ${discountPercent}%)</span>`;
            }

            // [MODIFIED] Hiển thị cả ĐCH và Linh Thạch và Giảm giá
            dchDisplay.innerHTML = `
                <span class="mr-3">ĐCH: <span class="font-bold text-lime-400">${currentDCH.toLocaleString()}</span></span>
                <span>Linh Thạch: <span class="font-bold text-green-400">${currentLT.toLocaleString()}</span></span>
                ${discountMsg}
            `;

            let html = '';
            const shopItems = Object.keys(SECT_SHOP_DB);

            if (shopItems.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400">Cửa hàng Tông Môn chưa có vật phẩm nào.</p>';
                return;
            }

            shopItems.forEach(buyId => {
                const shopItem = SECT_SHOP_DB[buyId];
                const itemDB = STATIC_ITEM_DB[shopItem.itemId];
                if (!itemDB) return; // Skip if item doesn't exist

                const owned = gameData.items[shopItem.itemId] || 0;
                
                // [MODIFIED] Áp dụng giảm giá cho hiển thị
                const finalCost = Math.floor(shopItem.cost * costMultiplier);
                
                // [MODIFIED] Xác định loại tiền tệ và kiểm tra số dư
                let currencyName = 'ĐCH';
                let currencyColor = 'text-lime-300';
                let playerBalance = currentDCH;
                
                if (shopItem.currency === 'linhThach') {
                    currencyName = 'Linh Thạch';
                    currencyColor = 'text-green-300';
                    playerBalance = currentLT;
                }
                
                const canAfford = playerBalance >= finalCost;
                const canAfford10 = playerBalance >= (finalCost * 10);

                // [NEW] Hiển thị giá gốc nếu có giảm giá
                let priceDisplay = `<span class="font-bold ${currencyColor}">${finalCost} ${currencyName}</span>`;
                if (discountPercent > 0) {
                    priceDisplay = `<span class="line-through text-gray-500 text-xs mr-1">${shopItem.cost}</span> ${priceDisplay}`;
                }

                html += `
                <div class="bg-gray-700 rounded p-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-grow">
                        <p class="font-bold text-sm ${getRarityClass(itemDB.rarity)}">${itemDB.name} (Đang có: ${owned})</p>
                        <p class="text-xs text-gray-300 mt-1">${itemDB.desc}</p>
                    </div>
                    <div class="flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                        <button onclick="buySectShopItem('${buyId}', 1)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-1/2 sm:w-auto ${!canAfford ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford ? 'disabled' : ''}>
                            Mua 1 (${priceDisplay})
                        </button>
                        <button onclick="buySectShopItem('${buyId}', 10)" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-1 px-3 rounded text-sm flex-shrink-0 w-1/2 sm:w-auto ${!canAfford10 ? 'opacity-50 cursor-not-allowed' : ''}" ${!canAfford10 ? 'disabled' : ''}>
                            Mua 10
                        </button>
                    </div>
                </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        function buySectShopItem(buyId, amount) {
            const shopItem = SECT_SHOP_DB[buyId];
            if (!shopItem) {
                showToast("Vật phẩm này không thể mua!", false); return;
            }

            const itemDB = STATIC_ITEM_DB[shopItem.itemId];
            if (!itemDB) {
                showToast("Lỗi: Không tìm thấy vật phẩm!", false); return;
            }

            // [NEW] Áp dụng giảm giá
            const discountPercent = getSectUpgradeBonus('shopDiscount');
            const costMultiplier = Math.max(0.1, 1 - (discountPercent / 100));
            const finalSingleCost = Math.floor(shopItem.cost * costMultiplier);
            const totalCost = finalSingleCost * amount;
            
            // [MODIFIED] Kiểm tra và trừ đúng loại tiền tệ
            let currencyName = 'ĐCH';
            if (shopItem.currency === 'linhThach') {
                if ((gameData.linhThach || 0) < totalCost) {
                    showToast("Không đủ Linh Thạch!", false); return;
                }
                gameData.linhThach -= totalCost;
                currencyName = 'Linh Thạch';
            } else {
                if ((gameData.diemCongHien || 0) < totalCost) {
                    showToast("Không đủ Điểm Cống Hiến!", false); return;
                }
                gameData.diemCongHien -= totalCost;
            }

            const currentAmount = gameData.items[shopItem.itemId] || 0;
            if (currentAmount + amount > MAX_STACK_SIZE) {
                showToast(`Không thể mua thêm, vượt quá ${MAX_STACK_SIZE} vật phẩm!`, false); return;
            }

            // Process transaction
            gameData.items[shopItem.itemId] = currentAmount + amount;

            showToast(`Đã mua ${itemDB.name} x${amount} với ${totalCost.toLocaleString()} ${currencyName}.`, true);

            // Re-render shop list
            renderSectShop();
            
            // Update main UI (update linhThach/DCH on main screen)
            updateUI();
            
            // Re-render other relevant modals
            if (!document.getElementById('equipment-modal').classList.contains('hidden')) {
                renderModalContent('equipment-modal');
            }
            // If boost modal is open, refresh it to show new pill count
            if (currentBoostingDiscipleId) {
                renderBoostDiscipleModal(currentBoostingDiscipleId);
            }
        }

        /**
         * Hoàn thành nhiệm vụ và nhận thưởng
         */
        function completeSectMission(discipleId) {
            const disciple = gameData.disciples.find(d => d.id === discipleId);
            if (!disciple || !disciple.assignedMission) {
                showToast("Lỗi: Không tìm thấy đệ tử hoặc nhiệm vụ!", false); return;
            }

            const now = Date.now();
            if (now < disciple.assignedMission.completionTime) {
                showToast("Nhiệm vụ chưa hoàn thành!", false); return;
            }

            const mission = SECT_MISSIONS_DB[disciple.assignedMission.missionId];
            if (!mission) {
                 showToast("Lỗi: Không tìm thấy dữ liệu nhiệm vụ!", false); 
                 // Reset disciple anyway
                 disciple.status = 'Nhàn Rỗi';
                 disciple.assignedMission = null;
                 renderSectMissionPanel();
                 return;
            }

            // 1. Add Rewards
            const rewards = mission.rewards;
            gameData.diemCongHien = (gameData.diemCongHien || 0) + rewards.diemCongHien;
            gameData.nganLuong += rewards.nganLuong;

            // [NEW] Add XP reward logic
            let xpGained = 0;
            let xpMsg = "";
            if (rewards.xp && rewards.xp > 0) {
                xpGained = rewards.xp;
                addDiscipleXp(disciple.id, xpGained); // Use the helper to grant XP and level up
                xpMsg = `, ${xpGained.toLocaleString()} XP`;
            }
            // [END NEW]

            // 2. Log and Toast
            // [MODIFIED] Update log message
            const rewardMsg = `${disciple.name} hoàn thành ${mission.name}! Nhận ${rewards.diemCongHien} ĐCH, ${rewards.nganLuong.toLocaleString()} NL${xpMsg}.`;
            addSectLog(rewardMsg, 'reward');
            showToast(rewardMsg, true);

            // 3. Reset Disciple
            disciple.status = 'Nhàn Rỗi';
            disciple.assignedMission = null;

            // 4. Re-render
            renderSectMissionPanel();
            updateUI(); // Update currencies
        }

        // [NEW] --- Auto-Assign Mission Function ---

        /**
         * [NEW] Giao nhiệm vụ cho 1 đệ tử (Helper cho auto-assign)
         */
        function assignMissionToDisciple(disciple, mission) {
             if (!disciple || !mission || disciple.status !== 'Nhàn Rỗi' || disciple.level < mission.levelReq) {
                 return false;
             }

            // Assign mission
            disciple.status = 'Nhiệm Vụ';
            disciple.assignedMission = {
                missionId: mission.id,
                completionTime: Date.now() + mission.duration,
                notified: false // [NEW] Đánh dấu chưa thông báo
            };

            addSectLog(`(Tự động) ${disciple.name} đã bắt đầu làm nhiệm vụ: ${mission.name}.`, 'info');
            return true;
        }

        /**
         * [NEW] Tự động giao nhiệm vụ cho các đệ tử rảnh rỗi
         */
        function autoAssignMissions() {
            // 1. Get missions already in progress
            const missionsInProgress = new Set(
                gameData.disciples
                    .filter(d => d.status === 'Nhiệm Vụ' && d.assignedMission)
                    .map(d => d.assignedMission.missionId)
            );

            // 2. Get available missions (not in progress)
            const availableMissions = Object.values(SECT_MISSIONS_DB)
                .filter(m => !missionsInProgress.has(m.id));
                
            // Sort missions: highest level req first
            availableMissions.sort((a, b) => b.levelReq - a.levelReq);

            // 3. Get available disciples (idle) AND NOT DEPLOYED
            const championId = gameData.sect.combatChampionId;
            const availableDisciples = gameData.disciples
                .filter(d => d.status === 'Nhàn Rỗi' && d.id !== championId); // [MODIFIED] Lọc bỏ đệ tử xuất chiến
                
            // Sort disciples: highest level first
            availableDisciples.sort((a, b) => b.level - a.level);
            
            const assignedDiscipleIds = new Set();
            let assignmentsCount = 0;

            // 4. Loop through missions (highest level first)
            for (const mission of availableMissions) {
                // 5. Find the best available disciple for this mission
                const discipleToAssign = availableDisciples.find(
                    d => !assignedDiscipleIds.has(d.id) && d.level >= mission.levelReq
                );

                if (discipleToAssign) {
                    // 6. Assign
                    const success = assignMissionToDisciple(discipleToAssign, mission);
                    if (success) {
                        assignedDiscipleIds.add(discipleToAssign.id);
                        assignmentsCount++;
                    }
                }
            }
            
            // 7. Show summary and re-render
            if (assignmentsCount > 0) {
                showToast(`Đã tự động giao ${assignmentsCount} nhiệm vụ!`, true);
                renderSectMissionPanel(); // Update the UI
                // Re-render disciple list if open (to update status)
                if (!document.getElementById('panel-boi-duong').classList.contains('hidden')) {
                    renderDiscipleList();
                }
            } else {
                showToast("Không tìm thấy đệ tử hoặc nhiệm vụ phù hợp (Đệ tử xuất chiến sẽ không nhận nhiệm vụ).", false);
            }
        }

        // [END NEW] --- Sect Mission Functions ---

        // [NEW] --- GLOBAL NOTIFICATION SYSTEM ---
        
        let notificationInterval = null;
        let notifiedCooldowns = new Set(); // Lưu các cooldown đã thông báo để tránh spam

        function startGlobalNotificationLoop() {
            if (notificationInterval) clearInterval(notificationInterval);
            // Chạy mỗi giây để cập nhật badge và thông báo
            notificationInterval = setInterval(() => {
                checkGlobalNotifications();
                updateActivityBadges(); // [NEW] Cập nhật số lượng badge
            }, 1000);
        }
        
        // [NEW] Hàm tính toán và cập nhật Badge hiển thị số lượng
        function updateActivityBadges() {
            if (!gameData || !gameData.sect) return;
            
            const now = Date.now();
            
            // 1. Đếm Khiêu Chiến khả dụng
            let khieuChienCount = 0;
            if (gameData.sect.challengeCooldowns) {
                // Duyệt qua tất cả đối thủ trong DB
                for (const id in RIVAL_SECTS_DB) {
                    const cooldown = gameData.sect.challengeCooldowns[id] || 0;
                    if (now >= cooldown) {
                        khieuChienCount++;
                    }
                }
            } else {
                // Nếu chưa có dữ liệu cooldown, tức là tất cả đều sẵn sàng
                khieuChienCount = Object.keys(RIVAL_SECTS_DB).length;
            }
            
            // 2. Đếm Phó Bản khả dụng
            let phoBanCount = 0;
            if (gameData.sect.dungeonCooldowns) {
                for (const id in SECT_DUNGEON_DB) {
                    const cooldown = gameData.sect.dungeonCooldowns[id] || 0;
                    if (now >= cooldown) {
                        phoBanCount++;
                    }
                }
            } else {
                phoBanCount = Object.keys(SECT_DUNGEON_DB).length;
            }
            
            // 3. Đếm Chiến Trường khả dụng
            let chienTruongCount = 0;
            if (gameData.sect.chienTruongCooldowns) {
                for (const id in CHIEN_TRUONG_DB) {
                    const cooldown = gameData.sect.chienTruongCooldowns[id] || 0;
                    if (now >= cooldown) {
                        chienTruongCount++;
                    }
                }
            } else {
                chienTruongCount = Object.keys(CHIEN_TRUONG_DB).length;
            }
            
            // Helper cập nhật UI
            const setBadge = (elementId, count) => {
                const el = document.getElementById(elementId);
                if (el) {
                    if (count > 0) {
                        el.textContent = count > 99 ? '99+' : count;
                        el.classList.remove('hidden');
                        // Thêm hiệu ứng rung nếu có thông báo mới (tùy chọn)
                    } else {
                        el.classList.add('hidden');
                    }
                }
            };
            
            // Cập nhật DOM
            setBadge('badge-khieu-chien', khieuChienCount);
            setBadge('badge-pho-ban', phoBanCount);
            setBadge('badge-chien-truong', chienTruongCount);
        }

        function checkGlobalNotifications() {
            if (!gameData || !gameData.player) return;
            const now = Date.now();

            // 1. Kiểm tra Nhiệm Vụ Tông Môn
            if (gameData.disciples) {
                let missionUpdated = false;
                gameData.disciples.forEach(d => {
                    if (d.status === 'Nhiệm Vụ' && d.assignedMission) {
                        if (now >= d.assignedMission.completionTime && !d.assignedMission.notified) {
                            d.assignedMission.notified = true;
                            const missionDB = SECT_MISSIONS_DB[d.assignedMission.missionId];
                            const missionName = missionDB ? missionDB.name : 'Nhiệm vụ';
                            
                            // Hiển thị thông báo
                            showToast(`✅ ${d.name} đã hoàn thành: ${missionName}!`, true);
                            
                            // Cập nhật UI nếu đang mở tab nhiệm vụ
                            missionUpdated = true;
                        }
                    }
                });
                
                // Nếu có nhiệm vụ hoàn thành và đang mở modal nhiệm vụ, render lại để nút chuyển sang "Hoàn Thành"
                if (missionUpdated) {
                    const activeList = document.getElementById('active-mission-list');
                    if (activeList && activeList.offsetParent !== null) {
                        updateActiveMissionTimers();
                    }
                }
            }

            // Helper để kiểm tra cooldown
            const checkCooldownCategory = (cooldownMap, db, typeName) => {
                if (!cooldownMap) return;
                for (const [id, endTime] of Object.entries(cooldownMap)) {
                    if (now >= endTime) {
                        const uniqueKey = `${typeName}_${id}_${endTime}`;
                        
                        // Chỉ thông báo nếu chưa thông báo VÀ vừa mới hồi (trong vòng 5s) 
                        // để tránh spam khi load game sau thời gian dài offline
                        if (!notifiedCooldowns.has(uniqueKey)) {
                            if (now - endTime < 5000) {
                                const item = db[id];
                                if (item) {
                                    showToast(`⚔️ ${item.name} đã hồi phục!`, true);
                                }
                            }
                            notifiedCooldowns.add(uniqueKey);
                            
                            // Auto Refresh UI nếu đang mở tab tương ứng
                            if (typeName === 'challenge') {
                                const p = document.getElementById('panel-khieu-chien-tm');
                                if (p && !p.classList.contains('hidden') && p.offsetParent !== null) renderSectChallengePanel();
                            } else if (typeName === 'battlefield') {
                                const p = document.getElementById('panel-chien-truong');
                                if (p && !p.classList.contains('hidden') && p.offsetParent !== null) renderChienTruongPanel();
                            } else if (typeName === 'dungeon') {
                                const p = document.getElementById('panel-pho-ban');
                                if (p && !p.classList.contains('hidden') && p.offsetParent !== null) renderPhoBanPanel();
                            } else if (typeName === 'trial') { // [NEW] Thêm xử lý refresh cho Thí Luyện
                                const p = document.getElementById('panel-thi-luyen-tm');
                                if (p && !p.classList.contains('hidden') && p.offsetParent !== null) renderSectTrialPanel();
                            }
                        }
                    }
                }
            };

            // 2. Kiểm tra Khiêu Chiến / Chiến Trường / Phó Bản / Thí Luyện
            if (gameData.sect) {
                checkCooldownCategory(gameData.sect.challengeCooldowns, RIVAL_SECTS_DB, 'challenge');
                checkCooldownCategory(gameData.sect.chienTruongCooldowns, CHIEN_TRUONG_DB, 'battlefield');
                checkCooldownCategory(gameData.sect.dungeonCooldowns, SECT_DUNGEON_DB, 'dungeon');
                checkCooldownCategory(gameData.sect.trialCooldowns, SECT_TRIALS_DB, 'trial'); // [NEW] Thêm dòng này
            }
            
            // [NEW] 3. Tự động thu nạp Chân Khí (Đã tách khỏi UI loop để chạy ngầm ổn định hơn)
            // Nếu hàm updateChanKhiPassive chưa chạy, gọi nó ở đây
            if (typeof updateChanKhiPassive === 'function') {
                updateChanKhiPassive();
            }
        }

        // --- HỆ THỐNG KỲ NGỘ GIANG HỒ (RANDOM EVENTS) ---

        // 1. Database các sự kiện
        const RANDOM_EVENTS_DB = [
            {
                id: 'evt_beggar',
                title: 'Lão Ăn Mày Bí Ẩn',
                desc: 'Trên đường hành tẩu, bạn gặp một lão ăn mày quần áo rách rưới nhưng đôi mắt sáng như sao. Lão chìa tay xin tiền.',
                choices: [
                    {
                        text: 'Tặng 10,000 NL',
                        cost: { currency: 'nganLuong', amount: 10000 },
                        risk: 0,
                        successMsg: 'Lão ăn mày cười lớn: "Trẻ nhỏ dễ dạy!". Lão truyền cho bạn một luồng chân khí.',
                        failMsg: '',
                        rewards: { xp: 50000, danhVong: 5 }
                    },
                    {
                        text: 'Tặng 100,000 NL',
                        cost: { currency: 'nganLuong', amount: 100000 },
                        risk: 30,
                        successMsg: 'Lão ăn mày kinh ngạc, rút từ trong bọc ra một cuốn bí kíp rách nát tặng bạn.',
                        failMsg: 'Lão cầm tiền rồi chạy mất hút. Bạn bị lừa!',
                        rewards: { item: 'upgrade_stone_medium', amount: 2, uyDanh: 10 }
                    },
                    {
                        text: 'Bỏ qua',
                        action: 'close'
                    }
                ]
            },
            // ... (Giữ nguyên các sự kiện cũ từ evt_merchant đến evt_ghost_march) ...
            {
                id: 'evt_merchant',
                title: 'Thương Nhân Sa Cơ',
                desc: 'Một thương nhân bị sơn tặc cướp bóc, đang ngồi khóc bên vệ đường.',
                choices: [
                    { text: 'Giúp đỡ (Tốn 50% HP)', cost: { hpPercent: 50 }, risk: 20, successMsg: 'Bạn đánh đuổi sơn tặc. Thương nhân cảm kích tặng bạn bảo vật gia truyền.', failMsg: 'Sơn tặc quá đông, bạn bị đánh trọng thương và không cứu được ai.', rewards: { item: 'key_rare', amount: 1, diemCongHien: 50 } },
                    { text: 'Làm ngơ', action: 'close' }
                ]
            },
            {
                id: 'evt_meditation',
                title: 'Hang Động Cổ Xưa',
                desc: 'Bạn phát hiện một hang động tỏa ra linh khí nồng đậm.',
                choices: [
                    { text: 'Vào thám hiểm', risk: 40, successMsg: 'Trong động có linh tuyền! Bạn uống và cảm thấy công lực đại tăng.', failMsg: 'Trong động có bẫy rập! Bạn bị thương nặng và mất một ít Ngân Lượng.', rewards: { tuVi: 5000, linhKhi: 10000 }, penalty: { hpPercent: 80, nganLuong: 5000 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_gambler',
                title: 'Sòng Bạc Giang Hồ',
                desc: 'Một đám người đang tụ tập chơi Tài Xỉu. Bạn có muốn thử vận may?',
                choices: [
                    { text: 'Cược 50 KNB', cost: { currency: 'kimNguyenBao', amount: 50 }, risk: 50, successMsg: 'Vận may mỉm cười! Bạn thắng gấp đôi.', failMsg: 'Đen thôi đỏ quên đi. Bạn mất trắng.', rewards: { kimNguyenBao: 100 } },
                    { text: 'Cược 500 KNB', cost: { currency: 'kimNguyenBao', amount: 500 }, risk: 60, successMsg: 'Đại thắng! Cả sòng bạc nhìn bạn ngưỡng mộ.', failMsg: 'Thua sạch túi. Giang hồ hiểm ác.', rewards: { kimNguyenBao: 1200 } },
                    { text: 'Không chơi', action: 'close' }
                ]
            },
            {
                id: 'evt_chess',
                title: 'Thế Cục Cờ Tàn',
                desc: 'Hai lão giả đang đánh cờ bên suối, sát khí tỏa ra bốn phía.',
                choices: [
                    { text: 'Chỉ điểm quân Trắng (Tốn 10% HP)', cost: { hpPercent: 10 }, risk: 50, successMsg: 'Nước đi thần thánh! Quân Trắng thắng.', failMsg: 'Nước đi sai lầm. Bạn bị chưởng bay xa.', rewards: { xp: 150000, danhVong: 20 }, penalty: { hpPercent: 30 } },
                    { text: 'Chỉ điểm quân Đen (Tốn 10% HP)', cost: { hpPercent: 10 }, risk: 50, successMsg: 'Tuyệt diệu! Quân Đen thắng.', failMsg: 'Quân Đen thua. Bạn bị mắng té tát.', rewards: { item: 'upgrade_stone_high', amount: 1, uyDanh: 15 }, penalty: { hpPercent: 20 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_lost_manual',
                title: 'Bí Kíp Thất Truyền',
                desc: 'Một bộ hài cốt cầm cuốn sách ố vàng trong hang động.',
                choices: [
                    { text: 'Lấy sách xem (Rủi ro 30%)', risk: 30, successMsg: 'Nhận được tâm đắc võ học cả đời!', failMsg: 'Sách tẩm độc! Bạn bị trúng độc.', rewards: { xp: 200000, item: 'upgrade_stone_high', amount: 1 }, penalty: { hpPercent: 40 } },
                    { text: 'Chôn cất tiền bối', cost: { hpPercent: 10 }, risk: 0, successMsg: 'Vong hồn cảm tạ, chỉ điểm kho báu.', rewards: { uyDanh: 30, linhKhi: 2000, nganLuong: 100000 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_meteor',
                title: 'Thiên Ngoại Vẫn Thạch',
                desc: 'Thiên thạch rơi xuống tạo thành hố sâu nóng bỏng.',
                choices: [
                    { text: 'Đập lấy quặng (Tốn 15% HP)', cost: { hpPercent: 15 }, risk: 30, successMsg: 'Thu được tinh thể quý giá!', failMsg: 'Thiên thạch phát nổ!', rewards: { item: 'ore_epic_1', amount: 2, nganLuong: 50000 }, penalty: { hpPercent: 40 } },
                    { text: 'Hấp thụ hỏa khí (Rủi ro 50%)', risk: 50, successMsg: 'Tu vi tăng tiến vượt bậc!', failMsg: 'Hỏa khí xâm nhập tâm trí!', rewards: { xp: 500000, linhKhi: 5000 }, penalty: { hpPercent: 30 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_divine_eagle',
                title: 'Thần Điêu Xuất Hiện',
                desc: 'Thần Điêu trong truyền thuyết đang hạ cánh nghỉ chân.',
                choices: [
                    { text: 'Thách đấu (Tốn 20% HP)', cost: { hpPercent: 20 }, risk: 40, successMsg: 'Thần Điêu công nhận sức mạnh của bạn.', failMsg: 'Bạn bị vỗ bay.', rewards: { xp: 600000, item: 'upgrade_stone_high', amount: 1, uyDanh: 20 }, penalty: { hpPercent: 30 } },
                    { text: 'Dâng thức ăn (50k NL)', cost: { currency: 'nganLuong', amount: 50000 }, risk: 10, successMsg: 'Được chở đi ngắm cảnh, tâm cảnh đột phá.', failMsg: 'Thần Điêu kén ăn bỏ đi.', rewards: { tuVi: 8000, linhKhi: 5000, danhVong: 10 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_ancient_pool',
                title: 'Huyết Trì Thượng Cổ',
                desc: 'Hồ máu sôi sục tỏa ra linh khí và tà khí.',
                choices: [
                    { text: 'Ngâm mình (Tốn 30% HP)', cost: { hpPercent: 30 }, risk: 40, successMsg: 'Gân cốt được tôi luyện!', failMsg: 'Tà khí xâm nhập!', rewards: { xp: 300000, item: 'upgrade_stone_high', amount: 2 }, penalty: { hpPercent: 50 } },
                    { text: 'Uống huyết thủy (Rủi ro 60%)', risk: 60, successMsg: 'Công lực đại tăng!', failMsg: 'Trúng kịch độc!', rewards: { tuVi: 10000, linhKhi: 20000 }, penalty: { hpPercent: 40, nganLuong: 50000 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_border_merchant',
                title: 'Thương Buôn Chợ Đen',
                desc: 'Thương buôn lén lút vận chuyển hàng cấm.',
                choices: [
                    { text: 'Mua hàng nóng (500k NL)', cost: { currency: 'nganLuong', amount: 500000 }, risk: 30, successMsg: 'Mở ra Rương Thần Ma!', failMsg: 'Bị lừa mua phải đá cuội.', rewards: { item: 'box_gear_godly', amount: 1, item2: 'upgrade_stone_high', amount2: 3 } },
                    { text: 'Cướp hàng (Rủi ro 60%)', risk: 60, successMsg: 'Cướp được món hời lớn!', failMsg: 'Hắn là cao thủ ẩn danh!', rewards: { item: 'upgrade_stone_high', amount: 5, nganLuong: 1000000 }, penalty: { hpPercent: 70 } },
                    { text: 'Báo quan', risk: 0, successMsg: 'Được khen thưởng.', rewards: { danhVong: 50, uyDanh: 20 } }
                ]
            },
            {
                id: 'evt_medicine_valley',
                title: 'Dược Vương Cốc',
                desc: 'Thung lũng đầy thảo dược quý hiếm.',
                choices: [
                    { text: 'Xin thuốc (20k NL)', cost: { currency: 'nganLuong', amount: 20000 }, risk: 10, successMsg: 'Thần y tặng đan dược.', failMsg: 'Thần y không tiếp khách.', rewards: { item: 'item_hp_large', amount: 5, xp: 50000 } },
                    { text: 'Hái trộm (Rủi ro 60%)', risk: 60, successMsg: 'Hái được Nhân Sâm ngàn năm!', failMsg: 'Bị chó đuổi cắn.', rewards: { item: 'herb_epic_1', amount: 2 }, penalty: { hpPercent: 30 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_mystic_lady',
                title: 'Cửu Thiên Huyền Nữ',
                desc: 'Tiên nữ giáng trần trong mộng.',
                choices: [
                    { text: 'Thành tâm bái lạy', risk: 0, successMsg: 'Nhận được tiên khí hộ thể.', rewards: { honLuc: 50, uyDanh: 50, linhKhi: 5000 } },
                    { text: 'Xin bí kíp (Tốn 50% Mana)', cost: { manaPercent: 50 }, risk: 40, successMsg: 'Nhận được tâm pháp thất truyền!', failMsg: 'Duyên chưa tới.', rewards: { item: 'ore_mythic_1', amount: 1, xp: 500000 }, penalty: { manaPercent: 40 } },
                    { text: 'Tỉnh mộng', action: 'close' }
                ]
            },
            {
                id: 'evt_sword_tomb',
                title: 'Kiếm Mộ Hoang Tàn',
                desc: 'Bãi chiến trường cổ với hàng vạn thanh kiếm gãy.',
                choices: [
                    { text: 'Tìm Thần Binh (Rủi ro 70%)', risk: 70, successMsg: 'Tìm thấy thanh kiếm cổ tỏa sáng!', failMsg: 'Bị vạn kiếm xuyên tâm.', rewards: { item: 'box_gear_godly', amount: 1 }, penalty: { hpPercent: 80 } },
                    { text: 'Thanh tẩy oán khí', cost: { hpPercent: 20 }, risk: 0, successMsg: 'Công đức vô lượng.', rewards: { danhVong: 100, uyDanh: 30, linhKhi: 3000 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_fox_spirit_enc',
                title: 'Hồ Ly Tinh',
                desc: 'Tuyệt sắc giai nhân vẫy gọi giữa rừng khuya.',
                choices: [
                    { text: 'Đi theo nàng (Rủi ro 80%)', risk: 80, successMsg: 'Tìm thấy kho báu bí mật!', failMsg: 'Bị hút cạn sinh lực.', rewards: { kimNguyenBao: 50, item: 'upgrade_stone_high', amount: 3 }, penalty: { hpPercent: 90, manaPercent: 90 } },
                    { text: 'Tấn công', cost: { hpPercent: 10 }, risk: 30, successMsg: 'Yêu quái bỏ chạy, rơi nội đan.', failMsg: 'Bị cào trọng thương.', rewards: { item: 'gem_purple_3', amount: 1, xp: 200000 }, penalty: { hpPercent: 30 } },
                    { text: 'Bỏ đi', action: 'close' }
                ]
            },
            {
                id: 'evt_pirate_chest',
                title: 'Rương Báu Trôi Sông',
                desc: 'Một chiếc rương gỗ mục nát trôi dạt vào bờ.',
                choices: [
                    { text: 'Phá khóa (Tốn 10% HP)', cost: { hpPercent: 10 }, risk: 40, successMsg: 'Bên trong đầy châu báu!', failMsg: 'Bẫy nổ tung!', rewards: { nganLuong: 500000, item: 'upgrade_stone_medium', amount: 5 }, penalty: { hpPercent: 40 } },
                    { text: 'Đẩy ra xa', risk: 0, successMsg: 'Thủy quái trồi lên đớp lấy rương. Hú vía!', rewards: { xp: 50000, lck: 5 } },
                    { text: 'Bỏ đi', action: 'close' }
                ]
            },
            {
                id: 'evt_hero_island',
                title: 'Sứ Giả Hiệp Khách Đảo',
                desc: 'Hai sứ giả Thưởng Thiện Phạt Ác mời uống cháo Lạp Bát.',
                choices: [
                    { text: 'Uống cháo (Rủi ro 30%)', risk: 30, successMsg: 'Nội lực tăng tiến vượt bậc!', failMsg: 'Độc tính quá mạnh, thổ huyết.', rewards: { mana: 500, xp: 200000, item: 'item_mana_large', amount: 2 }, penalty: { hpPercent: 40 } },
                    { text: 'Xin Lệnh Bài', risk: 0, successMsg: 'Nhận được Huyền Thiết Lệnh.', rewards: { item: 'key_rare', amount: 1, uyDanh: 20 } },
                    { text: 'Từ chối', action: 'close' }
                ]
            },
            {
                id: 'evt_child_grandma',
                title: 'Thiên Sơn Đồng Lão',
                desc: 'Một bé gái có ánh mắt uy nghiêm đang bị vây đánh.',
                choices: [
                    { text: 'Giải vây (Tốn 20% HP)', cost: { hpPercent: 20 }, risk: 10, successMsg: 'Được truyền thụ bí kíp.', failMsg: 'Bị chê lo chuyện bao đồng.', rewards: { item: 'mt_hoa_son_2', amount: 1, danhVong: 50 }, penalty: { hpPercent: 30 } },
                    { text: 'Chế giễu (Rủi ro 90%)', risk: 90, successMsg: 'Bà ta thích tính cách của bạn, tặng quà.', failMsg: 'Trúng Sinh Tử Phù!', rewards: { item: 'gem_purple_2', amount: 2 }, penalty: { hpPercent: 80, manaPercent: 80 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_fire_turtle',
                title: 'Vạn Niên Hỏa Quy',
                desc: 'Rùa lửa khổng lồ đang ngủ trong dung nham.',
                choices: [
                    { text: 'Xin Huyết Quy (Rủi ro 60%)', risk: 60, successMsg: 'Uống huyết quy, cơ thể cường tráng!', failMsg: 'Bị rùa phun lửa.', rewards: { item: 'pill_stat_platinum_hp', amount: 1 }, penalty: { hpPercent: 50 } },
                    { text: 'Tặng Thức Ăn (50k NL)', cost: { currency: 'nganLuong', amount: 50000 }, risk: 0, successMsg: 'Rùa tặng ngọc lửa.', rewards: { item: 'gem_red_1', amount: 1, linhKhi: 3000 } }, // gem_red_1 giả định là có hoặc fallback
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_ginseng_baby',
                title: 'Oa Nhi Sâm',
                desc: 'Nhân Sâm ngàn năm thành tinh đang mắc bẫy.',
                choices: [
                    { text: 'Bắt ăn (Rủi ro 40%)', risk: 40, successMsg: 'Công lực đại tăng!', failMsg: 'Sâm tinh độn thổ mất.', rewards: { xp: 500000, tuVi: 5000 }, penalty: { danhVong: -10 } },
                    { text: 'Giải cứu', risk: 0, successMsg: 'Sâm tinh tặng rễ phụ tạ ơn.', rewards: { item: 'herb_epic_1', amount: 3, lck: 5 } },
                    { text: 'Bỏ đi', action: 'close' }
                ]
            },
            {
                id: 'evt_wine_jar',
                title: 'Nữ Nhi Hồng',
                desc: 'Đào được hũ rượu trăm năm dưới gốc đào.',
                choices: [
                    { text: 'Uống ngay', risk: 10, successMsg: 'Tinh thần sảng khoái, hồi phục hoàn toàn.', failMsg: 'Say bí tỉ bị mất tiền.', rewards: { hpPercent: 100, manaPercent: 100, si_khi: 10 }, penalty: { nganLuong: 5000 } },
                    { text: 'Mang bán', risk: 0, successMsg: 'Bán được giá cao.', rewards: { nganLuong: 300000 } },
                    { text: 'Đập vỡ', action: 'close' }
                ]
            },
            {
                id: 'evt_ten_thousand_swords',
                title: 'Vạn Kiếm Quy Tông',
                desc: 'Sơn cốc với hàng vạn thanh kiếm rỉ sét đang rung lên.',
                choices: [
                    { text: 'Ngồi thiền (Rủi ro 20%)', risk: 20, successMsg: 'Ngộ ra chân lý võ học!', failMsg: 'Bị kiếm khí làm bị thương.', rewards: { xp: 800000, linhKhi: 5000, item: 'disciple_atk_pill_1', amount: 1 }, penalty: { hpPercent: 20 } },
                    { text: 'Rút bảo kiếm (Tốn 30% HP)', cost: { hpPercent: 30 }, risk: 40, successMsg: 'Rút được thanh kiếm cổ sắc bén!', failMsg: 'Kiếm gãy nát.', rewards: { item: 'w21', quality: 'legendary', amount: 1 }, penalty: { hpPercent: 40 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_golden_pill_furnace',
                title: 'Lò Luyện Cửu Chuyển',
                desc: 'Lò luyện đan cổ xưa vẫn đang cháy lửa tam muội.',
                choices: [
                    { text: 'Mở nắp lò (Rủi ro 50%)', risk: 50, successMsg: 'Nhận được Kim Đan!', failMsg: 'Lò phát nổ!', rewards: { item: 'pill_stat_platinum_atk', amount: 1 }, penalty: { hpPercent: 60 } },
                    { text: 'Thêm củi (10k NL)', cost: { currency: 'nganLuong', amount: 10000 }, risk: 0, successMsg: 'Nhận được tro tàn dược liệu.', rewards: { item: 'herb_rare_1', amount: 5, linhKhi: 2000 } },
                    { text: 'Bỏ đi', action: 'close' }
                ]
            },
            {
                id: 'evt_beast_tribulation',
                title: 'Lôi Kiếp Trùng Sinh',
                desc: 'Một con linh thú đang độ kiếp dưới sấm sét.',
                choices: [
                    { text: 'Hộ pháp (Tốn 20% HP)', cost: { hpPercent: 20 }, risk: 10, successMsg: 'Linh thú tạ ơn, tặng nội đan.', failMsg: 'Cả hai đều bị trọng thương.', rewards: { item: 'pet_food_6', amount: 1, danhVong: 50 }, penalty: { hpPercent: 30 } },
                    { text: 'Đánh lén (Rủi ro 40%)', risk: 40, successMsg: 'Cướp được Linh Hồn Thạch!', failMsg: 'Bị linh thú phản kích.', rewards: { linhHonThach: 200, uyDanh: -20 }, penalty: { hpPercent: 50 } },
                    { text: 'Quan sát', action: 'close' }
                ]
            },
            {
                id: 'evt_penglai_mirage',
                title: 'Bồng Lai Tiên Cảnh',
                desc: 'Hòn đảo bay lơ lửng hiện ra trong sương mù.',
                choices: [
                    { text: 'Cầu duyên', risk: 0, successMsg: 'Được ban phúc khí.', rewards: { lck: 20, linhKhi: 10000 } },
                    { text: 'Hái trộm Tiên Đào (Rủi ro 60%)', risk: 60, successMsg: 'Hái được Tiên Đào ngàn năm!', failMsg: 'Bị Thiên Binh đuổi đánh.', rewards: { item: 'pill_stat_platinum_hp', amount: 1, xp: 1000000 }, penalty: { hpPercent: 70, danhVong: -30 } },
                    { text: 'Ngắm nhìn', action: 'close' }
                ]
            },
            {
                id: 'evt_ghost_march',
                title: 'Âm Binh Mượn Đường',
                desc: 'Đoàn binh lính mờ ảo đi trong đêm sương mù.',
                choices: [
                    { text: 'Tránh đường (Tốn 100 Uy Danh)', cost: { uyDanh: 100 }, risk: 0, successMsg: 'Nhặt được vũ khí rơi vãi.', rewards: { item: 'upgrade_stone_high', amount: 3, linhHonThach: 50 } },
                    { text: 'Xông vào cướp (Rủi ro 80%)', risk: 80, successMsg: 'Cướp được Quỷ Tỷ (Rương Thần Ma)!', failMsg: 'Bị âm khí xâm nhập.', rewards: { item: 'box_gear_godly', amount: 1 }, penalty: { hpPercent: 90, manaPercent: 90 } },
                    { text: 'Nín thở', action: 'close' }
                ]
            },

            // --- 10 KỲ NGỘ MỚI ---

            {
                id: 'evt_heavenly_pavilion',
                title: 'Thiên Cơ Các',
                desc: 'Một tòa lầu các bí ẩn thoắt ẩn thoắt hiện trong mây mù. Nghe đồn nơi đây buôn bán mọi bí mật trên thế gian.',
                choices: [
                    {
                        text: 'Mua tin tức (Tốn 50 KNB)',
                        cost: { currency: 'kimNguyenBao', amount: 50 },
                        risk: 20,
                        successMsg: 'Thiên Cơ Lão Nhân tiết lộ cho bạn một bí mật kinh thiên! (Nhận Uy Danh & Danh Vọng)',
                        failMsg: 'Tin tức giả! Bạn mất tiền oan.',
                        rewards: { uyDanh: 100, danhVong: 100, xp: 500000 },
                        penalty: { danhVong: -10 }
                    },
                    {
                        text: 'Xin chỉ điểm (Tốn 20% HP)',
                        cost: { hpPercent: 20 },
                        risk: 40,
                        successMsg: 'Lão nhân chỉ điểm bến mê, tâm cảnh bạn đột phá! (Tăng May Mắn)',
                        failMsg: 'Thiên cơ bất khả lộ, bạn bị thiên lôi cảnh cáo.',
                        rewards: { lck: 30, linhKhi: 5000 },
                        penalty: { hpPercent: 40 }
                    },
                    {
                        text: 'Rời đi',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_martial_contest',
                title: 'Võ Đài Tỷ Thí',
                desc: 'Một lôi đài lớn được dựng lên giữa thị trấn, tiếng hò reo vang trời. Phần thưởng cho người thắng cuộc là một thanh thần binh.',
                choices: [
                    {
                        text: 'Lên đài thách đấu (Rủi ro 50%)',
                        risk: 50,
                        successMsg: 'Bạn đánh bại đài chủ! Nhận được phần thưởng danh giá.',
                        failMsg: 'Đài chủ quá mạnh, bạn bị đánh bay khỏi sàn đấu trong sự xấu hổ.',
                        rewards: { item: 'w9', quality: 'legendary', amount: 1, uyDanh: 50 },
                        penalty: { hpPercent: 40, danhVong: -20 }
                    },
                    {
                        text: 'Đặt cược 50k NL',
                        cost: { currency: 'nganLuong', amount: 50000 },
                        risk: 40,
                        successMsg: 'Võ sĩ bạn chọn đã thắng! Bạn nhận được tiền thưởng gấp đôi.',
                        failMsg: 'Võ sĩ bạn chọn đã thua thảm hại.',
                        rewards: { nganLuong: 100000 }
                    },
                    {
                        text: 'Xem náo nhiệt',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_tomb_raider',
                title: 'Đạo Mộ Bút Ký',
                desc: 'Bạn bắt gặp hai kẻ lén lút đang đào bới trước cửa một ngôi mộ cổ. Một kẻ béo, một kẻ gầy.',
                choices: [
                    {
                        text: 'Hợp tác (Tốn 10% HP)',
                        cost: { hpPercent: 10 },
                        risk: 20,
                        successMsg: 'Ba người hợp lực mở cửa mộ. Bạn được chia một phần kho báu.',
                        failMsg: 'Bẫy trong mộ kích hoạt! Hai tên kia chạy mất, bạn bị thương.',
                        rewards: { item: 'upgrade_stone_high', amount: 3, linhThach: 100 },
                        penalty: { hpPercent: 30 }
                    },
                    {
                        text: 'Cướp của (Rủi ro 60%)',
                        risk: 60,
                        successMsg: 'Bạn đánh bại hai tên trộm mộ và chiếm đoạt toàn bộ chiến lợi phẩm.',
                        failMsg: 'Họ có súng! (Ám khí). Bạn bị bắn trọng thương.',
                        rewards: { item: 'gem_purple_2', amount: 2, nganLuong: 200000 },
                        penalty: { hpPercent: 70 }
                    },
                    {
                        text: 'Báo quan',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_blood_moon_rise',
                title: 'Huyết Nguyệt Hàng Lâm',
                desc: 'Mặt trăng bỗng chuyển sang màu đỏ như máu. Yêu thú trong vùng trở nên điên cuồng và mạnh mẽ hơn.',
                choices: [
                    {
                        text: 'Săn quái thú (Rủi ro 40%)',
                        risk: 40,
                        successMsg: 'Bạn tiêu diệt được một con Yêu Lang biến dị, thu được nội đan quý.',
                        failMsg: 'Quái thú quá đông và hung hãn, bạn phải bỏ chạy trối chết.',
                        rewards: { item: 'pet_food_4', amount: 3, xp: 500000 },
                        penalty: { hpPercent: 50 }
                    },
                    {
                        text: 'Hấp thụ Nguyệt Hoa (Tốn 30% Mana)',
                        cost: { manaPercent: 30 },
                        risk: 20,
                        successMsg: 'Dưới ánh trăng máu, Hồn Lực của bạn được tôi luyện và gia tăng.',
                        failMsg: 'Tâm trí bị ảnh hưởng bởi sát khí, tẩu hỏa nhập ma nhẹ.',
                        rewards: { honLuc: 30, linhKhi: 5000 },
                        penalty: { hpPercent: 20 }
                    },
                    {
                        text: 'Trốn vào hang',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_wandering_merchant',
                title: 'Thương Nhân Vân Du',
                desc: 'Một lão già gánh hàng rong đi qua, trong giỏ của lão dường như chứa cả thế giới.',
                choices: [
                    {
                        text: 'Mua Hộp Bí Ẩn (100k NL)',
                        cost: { currency: 'nganLuong', amount: 100000 },
                        risk: 50,
                        successMsg: 'Mở hộp ra, bên trong là một món trang bị Sử Thi!',
                        failMsg: 'Bên trong là một hòn đá cuội có vẽ mặt cười.',
                        rewards: { item: 'a9', quality: 'epic', amount: 1 }
                    },
                    {
                        text: 'Đổi Đá Cường Hóa',
                        cost: { item: 'upgrade_stone_low', amount: 5 },
                        risk: 0,
                        successMsg: 'Lão già đổi cho bạn viên đá chất lượng tốt hơn.',
                        failMsg: '',
                        rewards: { item: 'upgrade_stone_medium', amount: 1 }
                    },
                    {
                        text: 'Không mua',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_rescue_beauty',
                title: 'Cứu Mỹ Nhân',
                desc: 'Một nữ tử áo trắng đang bị đám hắc y nhân vây công. Tình thế ngàn cân treo sợi tóc.',
                choices: [
                    {
                        text: 'Ra tay tương trợ (Tốn 30% HP)',
                        cost: { hpPercent: 30 },
                        risk: 20,
                        successMsg: 'Bạn đánh đuổi bọn ác nhân. Mỹ nhân cảm kích tặng bạn ngọc bội gia truyền.',
                        failMsg: 'Địch quá đông, bạn bị đánh bầm dập, mỹ nhân bị bắt đi mất.',
                        rewards: { item: 'r7', quality: 'legendary', amount: 1, danhVong: 50 },
                        penalty: { hpPercent: 40, uyDanh: -10 }
                    },
                    {
                        text: 'Thừa nước đục thả câu (Rủi ro 50%)',
                        risk: 50,
                        successMsg: 'Bạn nhân lúc hỗn loạn cướp được túi tiền của cả hai phe.',
                        failMsg: 'Cả hai phe quay sang đánh bạn!',
                        rewards: { nganLuong: 500000 },
                        penalty: { hpPercent: 80 }
                    },
                    {
                        text: 'Làm ngơ',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_bodhi_tree',
                title: 'Ngộ Đạo Thụ',
                desc: 'Bạn tìm thấy một cây Bồ Đề ngàn năm trong rừng sâu, tỏa ra ánh sáng dịu nhẹ và tiếng tụng kinh thoang thoảng.',
                choices: [
                    {
                        text: 'Ngồi thiền (An toàn)',
                        risk: 0,
                        successMsg: 'Tâm hồn thanh tịnh, HP và Mana hồi phục hoàn toàn, nhận thêm kinh nghiệm.',
                        failMsg: '',
                        rewards: { hpPercent: 100, manaPercent: 100, xp: 200000 }
                    },
                    {
                        text: 'Hái lá thuốc (Rủi ro 30%)',
                        risk: 30,
                        successMsg: 'Bạn hái được lá Bồ Đề, là nguyên liệu chế thuốc cực phẩm.',
                        failMsg: 'Cây thần nổi giận, rễ cây quất vào người bạn.',
                        rewards: { item: 'herb_epic_1', amount: 2 },
                        penalty: { hpPercent: 30 }
                    },
                    {
                        text: 'Chặt cành làm củi',
                        risk: 100,
                        successMsg: '',
                        failMsg: 'Thiên lôi đánh xuống ngay lập tức! Bạn bị trừng phạt.',
                        rewards: {},
                        penalty: { hpPercent: 90, danhVong: -100 }
                    }
                ]
            },
            {
                id: 'evt_wanted_order',
                title: 'Truy Sát Lệnh',
                desc: 'Trên bảng cáo thị dán hình một tên ác nhân khét tiếng với mức tiền thưởng khổng lồ.',
                choices: [
                    {
                        text: 'Nhận lệnh (Rủi ro 40%)',
                        risk: 40,
                        successMsg: 'Sau một trận chiến ác liệt, bạn đã tiêu diệt được ác nhân và nhận thưởng.',
                        failMsg: 'Ác nhân quá mạnh, bạn bị trọng thương và hắn đã trốn thoát.',
                        rewards: { nganLuong: 1000000, uyDanh: 100 },
                        penalty: { hpPercent: 60 }
                    },
                    {
                        text: 'Xé bảng thị chúng (Tốn 10 Uy Danh)',
                        cost: { uyDanh: 10 },
                        risk: 0,
                        successMsg: 'Hành động ngông cuồng của bạn khiến giang hồ khiếp sợ, tăng Sĩ Khí.',
                        failMsg: '',
                        rewards: { si_khi: 20 }
                    },
                    {
                        text: 'Bỏ qua',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_abyss_fall',
                title: 'Vực Sâu Vô Tận',
                desc: 'Bạn trượt chân ngã xuống một khe nứt không thấy đáy trong lúc hái thuốc.',
                choices: [
                    {
                        text: 'Dùng khinh công (Tốn 20% Mana)',
                        cost: { manaPercent: 20 },
                        risk: 10,
                        successMsg: 'Bạn tiếp đất an toàn và phát hiện một bí kíp thất lạc dưới đáy vực.',
                        failMsg: 'Nội lực cạn kiệt giữa chừng, bạn ngã đau điếng.',
                        rewards: { item: 'mt_hoa_son_3', amount: 1, xp: 100000 },
                        penalty: { hpPercent: 30 }
                    },
                    {
                        text: 'Cầu may (Rủi ro 80%)',
                        risk: 80,
                        successMsg: 'Thần kỳ thay, bạn rơi trúng một tấm lưới cũ của thợ săn và tìm thấy rương báu.',
                        failMsg: 'Bạn rơi tự do xuống đáy vực. Gãy xương toàn thân!',
                        rewards: { item: 'box_gear_godly', amount: 1 },
                        penalty: { hpPercent: 95 }
                    }
                ]
            },
            {
                id: 'evt_immortal_guide_v2',
                title: 'Tiên Nhân Chỉ Lộ',
                desc: 'Một lão giả râu tóc bạc phơ cưỡi hạc bay qua, khí chất phi phàm như tiên nhân.',
                choices: [
                    {
                        text: 'Thành tâm cầu đạo',
                        risk: 0,
                        successMsg: 'Tiên nhân gật đầu mỉm cười, ban cho bạn một chút tiên khí. (Tăng vĩnh viễn Công Kích)',
                        failMsg: '',
                        rewards: { item: 'pill_stat_platinum_atk', amount: 1 }
                    },
                    {
                        text: 'Xin tiền',
                        risk: 0,
                        successMsg: 'Tiên nhân lắc đầu ngán ngẩm, vứt cho bạn một đồng xu nát.',
                        failMsg: '',
                        rewards: { nganLuong: 1 }
                    },
                    {
                        text: 'Bắn hạc (Rủi ro 99%)',
                        risk: 99,
                        successMsg: 'Bạn bắn trúng con hạc! Tiên nhân ngã xuống... Hóa ra là kẻ giả mạo! Bạn cướp được đồ.',
                        failMsg: 'Bạn dám mạo phạm tiên nhân? Một tia sét đánh xuống biến bạn thành than.',
                        rewards: { item: 'box_gear_godly', amount: 2 },
                        penalty: { hpPercent: 99, danhVong: -100 }
                    }
                ]
            },
            {
                id: 'evt_ghost_market',
                title: 'Quỷ Chợ',
                desc: 'Sương mù dày đặc bao phủ, một khu chợ của người âm hiện ra. Nơi đây giao dịch không dùng tiền thường.',
                choices: [
                    {
                        text: 'Mua Thọ Nguyên Đan (Tốn 50% HP)',
                        cost: { hpPercent: 50 },
                        risk: 0,
                        successMsg: 'Bạn đánh đổi sinh mệnh lấy vật phẩm tăng cường thể chất vĩnh viễn.',
                        failMsg: '',
                        rewards: { item: 'pill_stat_platinum_hp', amount: 1 }
                    },
                    {
                        text: 'Bán Linh Hồn (Tốn 20 Hồn Lực)',
                        cost: { honLuc: 20 },
                        risk: 0,
                        successMsg: 'Chủ sạp hài lòng với linh hồn của bạn, trả một lượng lớn Ngân Lượng.',
                        failMsg: '',
                        rewards: { nganLuong: 5000000 }
                    },
                    {
                        text: 'Rời đi',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_treasure_map_fragment',
                title: 'Mảnh Bản Đồ',
                desc: 'Bạn nhặt được một mảnh da dê cũ nát, dường như là một phần của bản đồ kho báu.',
                choices: [
                    {
                        text: 'Tìm kiếm xung quanh (Tốn 10% HP)',
                        cost: { hpPercent: 10 },
                        risk: 30,
                        successMsg: 'Bạn tìm thấy chiếc rương được chôn giấu theo chỉ dẫn!',
                        failMsg: 'Bạn đào trúng tổ kiến lửa. Bị cắn sưng vù.',
                        rewards: { item: 'upgrade_stone_high', amount: 2, linhThach: 50 },
                        penalty: { hpPercent: 15 }
                    },
                    {
                        text: 'Bán cho tiệm cầm đồ',
                        risk: 0,
                        successMsg: 'Chủ tiệm trả giá khá cao cho mảnh bản đồ cổ này.',
                        failMsg: '',
                        rewards: { nganLuong: 150000 }
                    }
                ]
            },
            {
                id: 'evt_mad_blacksmith',
                title: 'Luyện Khí Sư Điên',
                desc: 'Một gã thợ rèn điên khùng chặn đường, đòi cường hóa vũ khí cho bạn để chứng minh tay nghề.',
                choices: [
                    {
                        text: 'Đồng ý (Rủi ro 50%)',
                        risk: 50,
                        successMsg: 'Hắn cười man dại và đập búa. Vũ khí của bạn sáng lên! (Nhận Đá Cường Hóa)',
                        failMsg: 'Bùm! Hắn đập quá tay làm hỏng vũ khí. Bạn bị thương do vụ nổ.',
                        rewards: { item: 'upgrade_stone_high', amount: 5 },
                        penalty: { hpPercent: 30 }
                    },
                    {
                        text: 'Chế giễu',
                        risk: 80,
                        successMsg: 'Hắn tức giận ném cho bạn một cục quặng rồi bỏ đi.',
                        failMsg: 'Hắn nổi điên vác búa rượt bạn chạy tóe khói.',
                        rewards: { item: 'ore_epic_1', amount: 2 },
                        penalty: { hpPercent: 20 }
                    },
                    {
                        text: 'Từ chối',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_beast_horde',
                title: 'Thú Triều',
                desc: 'Mặt đất rung chuyển, hàng vạn con thú hoảng loạn đang chạy về phía bạn.',
                choices: [
                    {
                        text: 'Chặn đầu (Rủi ro 70%)',
                        risk: 70,
                        successMsg: 'Bạn dũng cảm chiến đấu trong dòng thú triều, thu hoạch vô số chiến lợi phẩm.',
                        failMsg: 'Bạn bị đàn thú giẫm đạp tơi tả.',
                        rewards: { item: 'pet_food_5', amount: 2, xp: 1000000 },
                        penalty: { hpPercent: 80 }
                    },
                    {
                        text: 'Chạy theo hướng thú',
                        risk: 30,
                        successMsg: 'Bạn tìm ra nguyên nhân khiến thú hoảng loạn: Một con Boss bị thương! Bạn kết liễu nó.',
                        failMsg: 'Bạn chạy không kịp và bị cuốn vào dòng thú.',
                        rewards: { item: 'box_gear_godly', amount: 1 },
                        penalty: { hpPercent: 50 }
                    },
                    {
                        text: 'Leo lên cây',
                        action: 'close'
                    }
                ]
            },
            {
                id: 'evt_mini_tribulation',
                title: 'Thiên Kiếp',
                desc: 'Mây đen tích tụ trên đầu, một tia sét bất ngờ đánh xuống!',
                choices: [
                    {
                        text: 'Dùng thân thể đỡ (Tốn 50% HP)',
                        cost: { hpPercent: 50 },
                        risk: 10,
                        successMsg: 'Sét đánh cháy đen da thịt nhưng giúp bạn tôi luyện cơ thể. (Tăng vĩnh viễn Phòng Thủ)',
                        failMsg: 'Sét đánh quá mạnh, bạn ngất xỉu tại chỗ.',
                        rewards: { item: 'disciple_def_pill_3', amount: 1 },
                        penalty: { hpPercent: 40 }
                    },
                    {
                        text: 'Dùng Tiền đỡ (Tốn 100k NL)',
                        cost: { currency: 'nganLuong', amount: 100000 },
                        risk: 0,
                        successMsg: 'Bạn ném tiền lên trời, sét đánh tan tiền và tha cho bạn. "Có tiền mua tiên cũng được".',
                        failMsg: '',
                        rewards: { lck: 5 }
                    }
                ]
            },
            {
                id: 'evt_time_traveler',
                title: 'Xuyên Không Giả',
                desc: 'Một kẻ ăn mặc kỳ quái chặn đường bạn và hỏi: "iPhone 16 ra chưa?"',
                choices: [
                    {
                        text: 'Trả lời bừa',
                        risk: 50,
                        successMsg: 'Hắn gật gù: "Hóa ra là vậy", rồi tặng bạn một vật phẩm công nghệ (Thực ra là đồ chơi).',
                        failMsg: 'Hắn tức giận: "Ngươi lừa ta!", rồi lấy súng bắn bạn.',
                        rewards: { item: 'key_rare', amount: 2 },
                        penalty: { hpPercent: 40 }
                    },
                    {
                        text: 'Bắt giữ hắn (Rủi ro 30%)',
                        risk: 30,
                        successMsg: 'Bạn khống chế được hắn và lục soát được nhiều đồ lạ.',
                        failMsg: 'Hắn ném bom khói và biến mất.',
                        rewards: { item: 'crafting_blank_white', amount: 1 },
                        penalty: { hpPercent: 10 }
                    },
                    {
                        text: 'Tưởng bị điên',
                        action: 'close'
                    }
                ]
            },
            // [NEW] 20 Kỳ Ngộ Mới
            {
                id: 'evt_ice_cave',
                title: 'Huyền Băng Động',
                desc: 'Bạn phát hiện một hang động đóng băng vĩnh cửu. Bên trong có một chiếc giường ngọc tỏa ra hàn khí.',
                choices: [
                    { text: 'Ngủ trên giường băng (Tốn 20% HP)', cost: { hpPercent: 20 }, risk: 30, successMsg: 'Hàn khí tôi luyện kinh mạch! Nội công tăng tiến vượt bậc.', failMsg: 'Hàn độc xâm nhập lục phủ ngũ tạng!', rewards: { mana: 200, xp: 300000 }, penalty: { hpPercent: 50 } },
                    { text: 'Đập giường lấy ngọc', risk: 60, successMsg: 'Bạn lấy được một mảnh Hàn Ngọc ngàn năm.', failMsg: 'Giường nổ tung, mảnh băng găm vào người.', rewards: { item: 'gem_blue_3', amount: 1 }, penalty: { hpPercent: 30 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_cliff_jump',
                title: 'Cửu Tử Nhất Sinh',
                desc: 'Bạn bị kẻ thù truy đuổi đến bước đường cùng, phía trước là vách núi dựng đứng, mây mù bao phủ.',
                choices: [
                    { text: 'Nhảy xuống (Rủi ro 90%)', risk: 90, successMsg: 'Bạn mắc vào cành cây cổ thụ và tìm thấy bí kíp võ công tuyệt thế trong hang đá!', failMsg: 'Bạn rơi xuống vực thẳm... (Mất rất nhiều máu)', rewards: { item: 'box_gear_godly', amount: 1, xp: 1000000 }, penalty: { hpPercent: 95 } },
                    { text: 'Quay lại liều mạng (Tốn 50% HP)', cost: { hpPercent: 50 }, risk: 20, successMsg: 'Bạn kích phát tiềm năng, đánh bại kẻ thù và cướp được chiến lợi phẩm.', failMsg: 'Bạn bị đánh trọng thương nhưng may mắn chạy thoát.', rewards: { nganLuong: 500000, uyDanh: 50 }, penalty: { hpPercent: 30 } },
                    { text: 'Đầu hàng (Mất mặt)', risk: 0, successMsg: 'Bạn giữ được mạng sống nhưng mất hết danh dự.', rewards: { hpPercent: 10 }, penalty: { danhVong: -50, uyDanh: -50 } }
                ]
            },
            {
                id: 'evt_misty_forest',
                title: 'Mê Hồn Trận',
                desc: 'Bạn lạc vào một rừng đào, hương hoa nồng nàn khiến đầu óc quay cuồng, phương hướng đảo lộn.',
                choices: [
                    { text: 'Vận công phá trận (Tốn 30% Mana)', cost: { manaPercent: 30 }, risk: 20, successMsg: 'Bạn phá giải ảo ảnh, tìm thấy lối ra và một hũ rượu đào tiên.', failMsg: 'Bạn bị ảo ảnh mê hoặc, đi lòng vòng đến kiệt sức.', rewards: { item: 'food_xp_4', amount: 1, xp: 150000 }, penalty: { hpPercent: 20 } },
                    { text: 'Ngồi chờ cao nhân', risk: 50, successMsg: 'Đảo chủ đi ngang qua, thấy bạn có duyên nên tặng quà rồi đưa ra ngoài.', failMsg: 'Chờ đến đói lả mà không ai tới.', rewards: { item: 'key_rare', amount: 2 }, penalty: { hpPercent: 30 } },
                    { text: 'Đi đại', action: 'close' }
                ]
            },
            {
                id: 'evt_kirin_blessing',
                title: 'Thần Thú Giáng Trần',
                desc: 'Một con Kỳ Lân rực lửa từ trên trời giáng xuống, ánh mắt hiền từ nhìn bạn.',
                choices: [
                    { text: 'Bái lạy (Thành tâm)', risk: 10, successMsg: 'Kỳ Lân gật đầu, phun ra một luồng khí tường vân bao phủ bạn. (Tăng May Mắn)', failMsg: 'Kỳ Lân không quan tâm và bay đi.', rewards: { lck: 20, linhKhi: 5000 } },
                    { text: 'Xin vảy (Rủi ro 70%)', risk: 70, successMsg: 'Kỳ Lân tặng bạn một chiếc vảy Hoàng Kim!', failMsg: 'Kỳ Lân nổi giận phun lửa!', rewards: { item: 'gem_yellow_4', amount: 1 }, penalty: { hpPercent: 60 } },
                    { text: 'Đứng nhìn', action: 'close' }
                ]
            },
            {
                id: 'evt_forget_water',
                title: 'Vong Tình Thủy',
                desc: 'Bạn tìm thấy một dòng suối kỳ lạ, nước trong vắt nhưng không có bóng cá. Bên cạnh có bia đá khắc: "Uống vào quên hết sự đời".',
                choices: [
                    { text: 'Uống thử', risk: 30, successMsg: 'Tâm hồn thanh thản, mọi tạp niệm biến mất. Nội tâm vững vàng hơn.', failMsg: 'Bạn quên mất đường về nhà... và cả võ công. (Giảm nhẹ XP)', rewards: { honLuc: 50, mana_p: 2 }, penalty: { xp: -50000 } },
                    { text: 'Lấy nước mang về', risk: 10, successMsg: 'Thu được Vong Tình Thủy, có thể dùng để chế thuốc.', failMsg: 'Nước bốc hơi ngay khi rời khỏi suối.', rewards: { item: 'item_mana_large', amount: 5 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_peach_banquet',
                title: 'Bàn Đào Hội',
                desc: 'Bạn vô tình lạc vào một bữa tiệc của các tiên nhân trong hang động.',
                choices: [
                    { text: 'Xin tham dự', risk: 40, successMsg: 'Các tiên nhân vui vẻ mời bạn uống rượu tiên và ăn bàn đào.', failMsg: 'Bạn bị đuổi ra ngoài vì là người phàm.', rewards: { hp_p: 5, atk_p: 2, xp: 500000 }, penalty: { uyDanh: -10 } },
                    { text: 'Trộm đồ ăn (Rủi ro 80%)', risk: 80, successMsg: 'Bạn trộm được Tiên Đan của Thái Thượng Lão Quân!', failMsg: 'Bị Nhị Lang Thần bắt được và đánh một trận tơi bời.', rewards: { item: 'pill_stat_platinum_atk', amount: 1 }, penalty: { hpPercent: 80 } },
                    { text: 'Lặng lẽ rút lui', action: 'close' }
                ]
            },
            {
                id: 'evt_demon_zither',
                title: 'Thiên Ma Cầm',
                desc: 'Giữa rừng trúc, một cây đàn cổ tự phát ra tiếng nhạc ma quái, khiến người nghe tâm thần bất định.',
                choices: [
                    { text: 'Dùng nội lực trấn áp (Tốn 40% Mana)', cost: { manaPercent: 40 }, risk: 20, successMsg: 'Bạn thu phục được ma tính của cây đàn. Nhận được bí kíp âm công.', failMsg: 'Tiếng đàn phản phệ, bạn bị tẩu hỏa nhập ma.', rewards: { item: 'manual_crit_1', amount: 1, honLuc: 30 }, penalty: { hpPercent: 40 } },
                    { text: 'Hòa theo điệu nhạc', risk: 50, successMsg: 'Bạn ngộ ra chân lý trong tiếng đàn. Tâm cảnh thăng hoa.', failMsg: 'Bạn bị tiếng đàn điều khiển, tự đánh bản thân.', rewards: { xp: 400000, si_khi: 10 }, penalty: { hpPercent: 30 } },
                    { text: 'Bịt tai bỏ chạy', action: 'close' }
                ]
            },
            {
                id: 'evt_blood_coral',
                title: 'Huyết Ngọc San Hô',
                desc: 'Lặn xuống hồ sâu, bạn phát hiện một rặng san hô đỏ rực như máu, tỏa ra linh khí nồng đậm.',
                choices: [
                    { text: 'Hái san hô (Tốn 20% HP)', cost: { hpPercent: 20 }, risk: 40, successMsg: 'Hái thành công Huyết San Hô quý giá.', failMsg: 'Thủy quái bảo vệ san hô tấn công!', rewards: { item: 'gem_red_1', amount: 2 }, penalty: { hpPercent: 40 } },
                    { text: 'Tu luyện tại chỗ', risk: 20, successMsg: 'Mượn linh khí của san hô để bồi bổ cơ thể.', failMsg: 'Nước quá lạnh, bị cảm lạnh.', rewards: { hp: 1000, def: 50 }, penalty: { spd: -5 } }, // Tăng vĩnh viễn HP/Def (giả lập)
                    { text: 'Bơi lên', action: 'close' }
                ]
            },
            {
                id: 'evt_sealed_tower',
                title: 'Lôi Phong Tháp',
                desc: 'Tòa tháp cổ nghiêng ngả, bên dưới được cho là trấn áp một đại yêu quái.',
                choices: [
                    { text: 'Gia cố phong ấn (Tốn 50k NL)', cost: { currency: 'nganLuong', amount: 50000 }, risk: 10, successMsg: 'Công đức vô lượng. Bạn nhận được phước lành.', failMsg: 'Phong ấn phản phệ.', rewards: { lck: 10, danhVong: 50, linhKhi: 2000 }, penalty: { hpPercent: 10 } },
                    { text: 'Phá phong ấn (Rủi ro 90%)', risk: 90, successMsg: 'Yêu quái thoát ra và tạ ơn bạn bằng một món bảo vật cái thế!', failMsg: 'Yêu quái thoát ra và... ăn thịt bạn.', rewards: { item: 'box_gear_godly', amount: 1 }, penalty: { hpPercent: 99, danhVong: -100 } },
                    { text: 'Đi vòng qua', action: 'close' }
                ]
            },
            {
                id: 'evt_sword_debate',
                title: 'Hoa Sơn Luận Kiếm',
                desc: 'Các cao thủ võ lâm đang tụ tập tại đỉnh Hoa Sơn để tranh giành danh hiệu Thiên Hạ Đệ Nhất.',
                choices: [
                    { text: 'Tham gia tỷ thí (Rủi ro 60%)', risk: 60, successMsg: 'Bạn đánh bại quần hùng, danh chấn giang hồ!', failMsg: 'Bạn bị cao thủ đánh bay khỏi võ đài.', rewards: { uyDanh: 200, danhVong: 200, kimNguyenBao: 50 }, penalty: { hpPercent: 50, uyDanh: -20 } },
                    { text: 'Ngồi xem học hỏi', risk: 0, successMsg: 'Quan sát các cao thủ giao đấu, bạn học được rất nhiều.', rewards: { xp: 300000, accuracy_p: 2 } },
                    { text: 'Bán vé xem (Kiếm tiền)', risk: 10, successMsg: 'Bạn kiếm được một khoản kha khá từ việc bán chỗ ngồi đẹp.', rewards: { nganLuong: 200000 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_fake_map',
                title: 'Tàng Bảo Đồ (Giả)',
                desc: 'Bạn mua được một tấm bản đồ kho báu từ một gã say rượu.',
                choices: [
                    { text: 'Đi theo bản đồ', risk: 70, successMsg: 'Không ngờ là thật! Bạn tìm thấy kho báu của trùm sơn tặc.', failMsg: 'Bản đồ dẫn thẳng vào ổ kiến lửa! Bị lừa rồi.', rewards: { nganLuong: 1000000, item: 'upgrade_stone_high', amount: 2 }, penalty: { hpPercent: 30 } },
                    { text: 'Bán lại cho người khác', risk: 20, successMsg: 'Bạn lừa được một tên ngốc khác mua lại với giá cao.', failMsg: 'Bị phát hiện là đồ giả, bị đánh một trận.', rewards: { nganLuong: 50000 }, penalty: { hpPercent: 10, danhVong: -10 } },
                    { text: 'Vứt đi', action: 'close' }
                ]
            },
            {
                id: 'evt_zombie_king',
                title: 'Cương Thi Chi Vương',
                desc: 'Vào đêm trăng tròn, Cương Thi Chi Vương thức tỉnh, dẫn theo đàn xác sống tàn phá.',
                choices: [
                    { text: 'Tiêu diệt (Tốn 40% HP)', cost: { hpPercent: 40 }, risk: 30, successMsg: 'Bạn chém đầu Cương Thi Vương, thu được thi đan.', failMsg: 'Cương thi quá mạnh, bạn bị cào trúng nhiễm độc thi.', rewards: { item: 'pill_stat_platinum_def', amount: 1, uyDanh: 50 }, penalty: { hpPercent: 40 } }, // Giả định item def pill
                    { text: 'Dùng bùa trấn áp (Tốn 10k NL)', cost: { currency: 'nganLuong', amount: 10000 }, risk: 10, successMsg: 'Cương thi bị phong ấn. Dân làng tạ ơn.', rewards: { danhVong: 30, linhKhi: 1000 } },
                    { text: 'Chạy thật nhanh', action: 'close' }
                ]
            },
            {
                id: 'evt_holy_fire_token',
                title: 'Thánh Hỏa Lệnh',
                desc: 'Bạn nhặt được một tấm lệnh bài kỳ lạ có khắc hình ngọn lửa, tỏa ra hơi nóng.',
                choices: [
                    { text: 'Luyện hóa lệnh bài', risk: 50, successMsg: 'Lệnh bài tan chảy vào cơ thể, bạn lĩnh ngộ võ công Minh Giáo.', failMsg: 'Lửa thiêu đốt tâm can, nội lực rối loạn.', rewards: { atk_p: 2, xp: 200000 }, penalty: { manaPercent: 50 } },
                    { text: 'Mang trả Minh Giáo', risk: 0, successMsg: 'Giáo chủ Minh Giáo cảm kích, tặng bạn hậu tạ.', rewards: { item: 'gem_red_1', amount: 2, uyDanh: 20 } },
                    { text: 'Vứt bỏ', action: 'close' }
                ]
            },
            {
                id: 'evt_ice_needle',
                title: 'Băng Phách Ngân Châm',
                desc: 'Một mũi kim bạc bay vút qua, cắm phập vào thân cây kế bên. Là ám khí của Lý Mạc Sầu!',
                choices: [
                    { text: 'Nhổ kim xem xét (Rủi ro 80%)', risk: 80, successMsg: 'Bạn cẩn thận nghiên cứu và học được cách chế tạo ám khí.', failMsg: 'Kim có kịch độc! Bạn trúng độc ngay lập tức.', rewards: { accuracy_p: 5, item: 'scroll_enchant_accuracy', amount: 1 }, penalty: { hpPercent: 60 } },
                    { text: 'Đuổi theo người ném', risk: 50, successMsg: 'Bạn đuổi kịp và đánh bại Lý Mạc Sầu (đang bị thương).', failMsg: 'Bị ả ta quay lại tung chưởng Băng Phách.', rewards: { item: 'box_gear_godly', amount: 1 }, penalty: { hpPercent: 40 } },
                    { text: 'Tránh xa', action: 'close' }
                ]
            },
            {
                id: 'evt_miracle_doctor',
                title: 'Thần Y Cứu Tử',
                desc: 'Gặp một vị thần y đang chữa bệnh cho dân nghèo miễn phí.',
                choices: [
                    { text: 'Phụ giúp (Tốn 10% Mana)', cost: { manaPercent: 10 }, risk: 0, successMsg: 'Bạn dùng nội lực hỗ trợ thần y. Ông ấy truyền cho bạn y thuật.', rewards: { hp_p: 2, lifesteal: 1, danhVong: 20 } },
                    { text: 'Xin chữa bệnh', risk: 0, successMsg: 'Thần y châm cứu, mọi vết thương lành lặn, kinh mạch thông suốt.', rewards: { hpPercent: 100, manaPercent: 100, xp: 50000 } },
                    { text: 'Quyên góp thuốc (Tốn Dược Liệu)', cost: { item: 'herb_rare_1', amount: 1 }, risk: 0, successMsg: 'Thần y cảm động, tặng bạn đan dược quý.', rewards: { item: 'item_hp_large', amount: 10 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_nine_swords',
                title: 'Độc Cô Kiếm Ý',
                desc: 'Trước vách đá trơn trượt, bạn nhìn thấy những vết kiếm chém sâu hoắm chứa đựng kiếm ý vô thượng.',
                choices: [
                    { text: 'Quan sát kiếm vết (Tốn 50% Mana)', cost: { manaPercent: 50 }, risk: 30, successMsg: 'Bạn lĩnh ngộ được một chiêu trong Độc Cô Cửu Kiếm!', failMsg: 'Kiếm ý quá mạnh làm tổn thương tâm trí.', rewards: { atk_p: 3, critChance: 2 }, penalty: { manaPercent: 40 } },
                    { text: 'Múa kiếm theo', risk: 60, successMsg: 'Bạn vô tình kích hoạt cơ quan, tìm thấy thanh kiếm gỗ của Độc Cô Cầu Bại.', failMsg: 'Bạn trượt chân ngã sấp mặt.', rewards: { item: 'w9', quality: 'legendary', amount: 1 }, penalty: { hpPercent: 10 } },
                    { text: 'Bỏ đi', action: 'close' }
                ]
            },
            {
                id: 'evt_monkey_sutra',
                title: 'Cửu Dương Chân Kinh',
                desc: 'Bạn bắt gặp một con khỉ trắng già yếu đang rên rỉ vì đau bụng.',
                choices: [
                    { text: 'Mổ bụng cứu khỉ (Rủi ro 20%)', risk: 20, successMsg: 'Bạn lấy ra được bộ Cửu Dương Chân Kinh từ bụng khỉ! Khỉ cũng sống sót.', failMsg: 'Con khỉ sợ quá chạy mất, bạn bị nó cào.', rewards: { item: 'pill_stat_platinum_atk', amount: 1, mana_p: 5 }, penalty: { hpPercent: 10 } },
                    { text: 'Cho uống thuốc', cost: { item: 'item_hp_small', amount: 1 }, risk: 0, successMsg: 'Con khỉ nôn ra một viên đá kỳ lạ để tạ ơn.', rewards: { item: 'upgrade_stone_high', amount: 1 } },
                    { text: 'Làm ngơ', action: 'close' }
                ]
            },
            {
                id: 'evt_jade_bed',
                title: 'Hàn Ngọc Giường',
                desc: 'Trong Cổ Mộ, bạn tìm thấy chiếc giường làm bằng ngọc hàn băng ngàn năm.',
                choices: [
                    { text: 'Ngủ một giấc', risk: 10, successMsg: 'Tu vi tăng nhanh gấp bội khi ngủ trên giường này.', failMsg: 'Lạnh quá không ngủ được, bị cảm.', rewards: { xp: 500000, tuVi: 2000 }, penalty: { hpPercent: 5 } },
                    { text: 'Vận công trên giường', risk: 40, successMsg: 'Hàn khí hỗ trợ đả thông kinh mạch bế tắc.', failMsg: 'Tẩu hỏa nhập ma do hàn khí xâm nhập.', rewards: { mana_p: 3, def_p: 2 }, penalty: { hpPercent: 30 } },
                    { text: 'Rời đi', action: 'close' }
                ]
            },
            {
                id: 'evt_dragon_essence',
                title: 'Long Nguyên',
                desc: 'Một con rồng già chết đi, để lại tinh hoa Long Nguyên rực sáng.',
                choices: [
                    { text: 'Nuốt Long Nguyên (Rủi ro 95%)', risk: 95, successMsg: 'Cơ thể bạn tái tạo, đạt được sức mạnh của Rồng! (Tăng mạnh mọi chỉ số)', failMsg: 'Cơ thể không chịu nổi sức mạnh, nổ tung! (Mất 99% HP)', rewards: { hp_p: 10, atk_p: 10, def_p: 10, spd_p: 10 }, penalty: { hpPercent: 99 } },
                    { text: 'Chia nhỏ Long Nguyên', risk: 30, successMsg: 'Bạn chia nhỏ sức mạnh để hấp thụ từ từ.', rewards: { xp: 1000000, hp_p: 2 }, penalty: { hpPercent: 20 } },
                    { text: 'Bỏ đi', action: 'close' }
                ]
            },
            {
                id: 'evt_modern_dream',
                title: 'Mộng Hồi Hiện Đại',
                desc: 'Bạn ngủ gục và mơ thấy mình đang lái xe Ferrari trên đường cao tốc, gió thổi vi vu.',
                choices: [
                    { text: 'Tận hưởng giấc mơ', risk: 0, successMsg: 'Tinh thần sảng khoái tột độ khi tỉnh dậy. Hồi phục hoàn toàn.', rewards: { hpPercent: 100, manaPercent: 100, si_khi: 20 } },
                    { text: 'Cố gắng ghi nhớ biển số xe', risk: 50, successMsg: 'Bạn nhớ ra một dãy số, hóa ra là mật mã kho báu!', failMsg: 'Đau đầu quá, tỉnh dậy vẫn còn choáng.', rewards: { nganLuong: 1000000, kimNguyenBao: 10 }, penalty: { manaPercent: 20 } },
                    { text: 'Tỉnh dậy ngay', action: 'close' }
                ]
            }
        ];

        // 2. Hàm kích hoạt sự kiện
        function triggerRandomEvent() {
            // Chỉ kích hoạt khi đang Luyện công hoặc Idle
            if (!gameData.isTraining && !gameData.isIdling) return;
            
            // [NEW] Nếu đã có sự kiện đang chờ thì không kích hoạt thêm
            if (gameData.pendingEvent) return;

            // Tỉ lệ xuất hiện: 2% mỗi lần check (gameLoop gọi hàm này)
            if (Math.random() > 0.02) return;

            // Kiểm tra xem có đang mở modal nào không, nếu có thì không hiện event để tránh rối
            const visibleBackdrops = Array.from(document.querySelectorAll('.modal-backdrop')).filter(el => !el.classList.contains('hidden'));
            if (visibleBackdrops.length > 0) return;

            // Chọn random sự kiện
            const eventData = RANDOM_EVENTS_DB[Math.floor(Math.random() * RANDOM_EVENTS_DB.length)];
            
            // [MODIFIED] Thay vì hiện modal ngay, lưu vào pendingEvent
            gameData.pendingEvent = eventData;
            
            // Thông báo nhỏ cho người chơi
            showToast("Có Kỳ Ngộ mới! Hãy kiểm tra thông tin nhân vật.", true);
            
            // Cập nhật UI để nút Kỳ Ngộ sáng lên
            updateUI();
        }

        // [NEW] Hàm mở Modal Kỳ Ngộ (Gắn vào nút trong panel nhân vật)
        function openKyNgoModal() {
            const modalId = 'ky-ngo-modal';
            const contentDiv = document.querySelector('#ky-ngo-modal .overflow-y-auto'); // Tìm div nội dung
            
            // Reset nội dung
            if (!contentDiv) return;
            contentDiv.innerHTML = '';

            if (gameData.pendingEvent) {
                const eventData = gameData.pendingEvent;
                
                // Render nội dung sự kiện vào panel (Tương tự renderEventModal cũ nhưng không tạo modal mới)
                let html = `
                    <div class="text-center relative z-10">
                        <h3 class="text-2xl font-black text-yellow-400 mb-2 uppercase tracking-wide drop-shadow-md animate-fade-in">${eventData.title}</h3>
                        <div class="w-16 h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent mx-auto mb-4"></div>
                        <p class="text-gray-300 mb-6 text-sm leading-relaxed italic bg-black/20 p-3 rounded border border-gray-700/50">${eventData.desc}</p>
                        
                        <div class="space-y-3">
                `;

                eventData.choices.forEach((choice, index) => {
                    let costText = '';
                    let canAfford = true;
                    if (choice.cost) {
                        if (choice.cost.hpPercent) {
                            costText = `<span class="text-red-400 text-xs ml-2">(-${choice.cost.hpPercent}% HP)</span>`;
                            if (gameData.player.currentHp < (getTotalStats().hp * (choice.cost.hpPercent/100))) canAfford = false;
                        } else if (choice.cost.currency) {
                            const curr = choice.cost.currency;
                            const amt = choice.cost.amount;
                            const currName = curr === 'nganLuong' ? 'NL' : 'KNB';
                            const currColor = curr === 'nganLuong' ? 'text-gray-300' : 'text-yellow-300';
                            costText = `<span class="${currColor} text-xs ml-2">(-${amt.toLocaleString()} ${currName})</span>`;
                            if ((gameData[curr] || 0) < amt) canAfford = false;
                        } else if (choice.cost.item) {
                             // Logic check item (nếu có trong event)
                             const itemDB = MATERIALS_DB[choice.cost.item] || STATIC_ITEM_DB[choice.cost.item];
                             const itemName = itemDB ? itemDB.name : 'Vật phẩm';
                             costText = `<span class="text-gray-400 text-xs ml-2">(-${choice.cost.amount} ${itemName})</span>`;
                             const owned = (gameData.items[choice.cost.item] || 0) + (gameData.materials[choice.cost.item] || 0);
                             if (owned < choice.cost.amount) canAfford = false;
                        }
                        // Thêm các loại cost khác nếu có
                    }

                    // Style nút
                    let btnClass = "w-full py-3 px-4 rounded-lg font-bold text-sm transition transform active:scale-95 border shadow-md flex justify-between items-center group";
                    let btnContent = `<span>${choice.text}</span> ${costText}`;
                    
                    if (choice.action === 'close') {
                        btnClass += " bg-gray-700 hover:bg-gray-600 text-gray-400 border-gray-600";
                        btnContent = `<span>${choice.text}</span> <i class="fa-solid fa-xmark"></i>`;
                    } else {
                        btnClass += " bg-gradient-to-r from-blue-900 to-slate-800 hover:from-blue-800 hover:to-slate-700 text-white border-blue-500/30";
                    }

                    if (!canAfford) {
                        html += `
                        <button class="${btnClass} opacity-50 cursor-not-allowed grayscale" disabled>
                            ${btnContent}
                        </button>`;
                    } else {
                        // Lưu index để xử lý vì không truyền object qua HTML onclick được
                        html += `
                        <button onclick="handleEventChoiceIndex(${index})" class="${btnClass}">
                            ${btnContent}
                        </button>`;
                    }
                });

                html += `</div></div>`;
                
                // Thêm nền trang trí
                html += `<div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10 pointer-events-none"></div>`;
                html += `<div class="absolute -top-10 -right-10 w-40 h-40 bg-yellow-500/10 blur-3xl rounded-full pointer-events-none"></div>`;

                contentDiv.innerHTML = html;

            } else {
                // Không có sự kiện
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <i class="fa-solid fa-wind text-6xl text-gray-600 mb-4 animate-pulse"></i>
                        <p class="text-gray-400 font-bold text-lg">Gió lặng mây trôi...</p>
                        <p class="text-gray-500 text-sm mt-2">Hiện tại chưa có kỳ ngộ nào xuất hiện.</p>
                        <p class="text-gray-600 text-xs italic mt-4">Hãy tiếp tục hành tẩu giang hồ, duyên phận sẽ tự đến.</p>
                    </div>
                `;
            }

            // Hiển thị modal
            showModal(modalId);
        }

        // [NEW] Wrapper function để xử lý lựa chọn từ index
        function handleEventChoiceIndex(index) {
            if (!gameData.pendingEvent) return;
            const choice = gameData.pendingEvent.choices[index];
            handleEventChoice(choice);
        }

        // 4. Xử lý lựa chọn (CẬP NHẬT: Hiển thị kết quả tại chỗ & Xóa Pending)
        function handleEventChoice(choice) {
            // ... (Logic trừ chi phí giữ nguyên) ...
            if (choice.cost) {
                if (choice.cost.hpPercent) {
                    const dmg = Math.floor(getTotalStats().hp * (choice.cost.hpPercent / 100));
                    gameData.player.currentHp = Math.max(1, gameData.player.currentHp - dmg);
                } else if (choice.cost.currency) {
                    gameData[choice.cost.currency] -= choice.cost.amount;
                } else if (choice.cost.item) {
                     if (STATIC_ITEM_DB[choice.cost.item]) gameData.items[choice.cost.item] -= (choice.cost.amount || 1);
                     else if (MATERIALS_DB[choice.cost.item]) gameData.materials[choice.cost.item] -= (choice.cost.amount || 1);
                }
                // updateUI(); // Sẽ update ở cuối
            }

            const roll = Math.random() * 100;
            const isSuccess = roll >= (choice.risk || 0);
            
            // [NEW] Xóa sự kiện đang chờ
            gameData.pendingEvent = null;

            // Thay đổi nội dung Modal hiện tại để hiển thị kết quả
            const contentDiv = document.querySelector('#ky-ngo-modal .overflow-y-auto');
            
            let resultTitle = "";
            let resultClass = "";
            let resultMsg = "";
            let resultDetailHtml = "";
            let logMsg = "";

            if (choice.action === 'close') {
                 // Nếu chọn bỏ qua thì đóng modal luôn hoặc báo đã bỏ qua
                 hideModal('ky-ngo-modal');
                 addTrainingLog('Bạn đã bỏ qua một kỳ ngộ.', 'info');
                 updateUI();
                 return;
            }

            if (isSuccess) {
                // THÀNH CÔNG
                resultTitle = "KỲ NGỘ THÀNH CÔNG";
                resultClass = "text-green-400";
                resultMsg = choice.successMsg;
                resultDetailHtml = formatEventResultDetail(choice.rewards, 'reward');
                
                logMsg = `[Kỳ Ngộ] ${choice.successMsg}`;
                addTrainingLog(logMsg, 'reward');

                // Trao thưởng (Logic giữ nguyên)
                if (choice.rewards) {
                    const r = choice.rewards;
                    if (r.xp) addPlayerXp(r.xp, 'event');
                    if (r.nganLuong) gameData.nganLuong += r.nganLuong;
                    if (r.kimNguyenBao) gameData.kimNguyenBao += r.kimNguyenBao;
                    if (r.danhVong) gameData.danhVong += r.danhVong;
                    if (r.uyDanh) gameData.uyDanh += r.uyDanh;
                    if (r.diemCongHien) gameData.diemCongHien += r.diemCongHien;
                    if (r.tuVi) addTuVi(r.tuVi);
                    if (r.linhKhi) gameData.linhKhi += r.linhKhi;
                    if (r.linhHonThach) gameData.linhHonThach += r.linhHonThach;
                    if (r.honLuc) gameData.player.honLuc = Math.min(getTotalStats().honLuc, gameData.player.honLuc + r.honLuc);

                    // Add items
                    const processAddItem = (id, amt) => {
                        if (MATERIALS_DB[id]) addMaterial(id, amt, 'idle');
                        else if (STATIC_ITEM_DB[id]) addItem(id, amt);
                        else if (id === 'box_gear_godly') addItem(id, amt);
                    };
                    if (r.item) processAddItem(r.item, r.amount || 1);
                    if (r.item2) processAddItem(r.item2, r.amount2 || 1);
                    
                    // Full Heal
                    if (r.hpPercent === 100) gameData.player.currentHp = getTotalStats().hp;
                    if (r.manaPercent === 100) gameData.player.currentMana = getTotalStats().mana;
                }

            } else {
                // THẤT BẠI
                resultTitle = "KỲ NGỘ THẤT BẠI";
                resultClass = "text-red-500";
                resultMsg = choice.failMsg;
                resultDetailHtml = formatEventResultDetail(choice.penalty, 'penalty');

                logMsg = `[Kỳ Ngộ] ${choice.failMsg}`;
                addTrainingLog(logMsg, 'error');

                // Áp dụng phạt (Logic giữ nguyên)
                if (choice.penalty) {
                    const p = choice.penalty;
                    if (p.hpPercent) {
                        const dmg = Math.floor(getTotalStats().hp * (p.hpPercent / 100));
                        gameData.player.currentHp = Math.max(0, gameData.player.currentHp - dmg);
                        if (gameData.player.currentHp <= 0) stopTraining(true);
                    }
                    if (p.manaPercent) {
                         const drain = Math.floor(getTotalStats().mana * (p.manaPercent / 100));
                         gameData.player.currentMana = Math.max(0, gameData.player.currentMana - drain);
                    }
                    if (p.nganLuong) gameData.nganLuong = Math.max(0, gameData.nganLuong - p.nganLuong);
                    if (p.danhVong) gameData.danhVong = Math.max(0, gameData.danhVong + p.danhVong); 
                    if (p.uyDanh) gameData.uyDanh = Math.max(0, gameData.uyDanh + p.uyDanh);
                    if (p.xp) gameData.player.xp = Math.max(0, gameData.player.xp + p.xp); 
                }
            }
            
            // Render Kết quả vào Modal
            contentDiv.innerHTML = `
                <div class="text-center relative z-10 animate-fade-in">
                    <h3 class="text-2xl font-black ${resultClass} mb-4 uppercase tracking-wide drop-shadow-md">${resultTitle}</h3>
                    <p class="text-gray-200 text-sm leading-relaxed border-l-4 ${isSuccess ? 'border-green-500' : 'border-red-500'} pl-3 italic bg-black/20 p-2 rounded">
                        "${resultMsg}"
                    </p>
                    ${resultDetailHtml}
                    
                    <button onclick="hideModal('ky-ngo-modal')" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition transform active:scale-95 border border-gray-500 mt-6">
                        Đóng
                    </button>
                </div>
            `;
            
            updateUI(); // Cập nhật nút Kỳ Ngộ (tắt nhấp nháy) và tiền tệ
        }

        // 3. Render Modal Sự Kiện
        function renderEventModal(eventData) {
            // Tạo HTML cho Modal nếu chưa có
            let eventModal = document.getElementById('random-event-modal');
            if (!eventModal) {
                const modalHtml = `
                <div id="random-event-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-[100]">
                    <div class="bg-gray-800 border-2 border-yellow-500 rounded-xl shadow-2xl w-full max-w-md transform transition-all scale-100 p-6 relative overflow-hidden">
                        <!-- Hiệu ứng nền -->
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20 pointer-events-none"></div>
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-yellow-500/20 blur-3xl rounded-full pointer-events-none"></div>

                        <div class="text-center relative z-10">
                            <h3 id="evt-title" class="text-2xl font-black text-yellow-400 mb-2 uppercase tracking-wide drop-shadow-md">Kỳ Ngộ</h3>
                            <div class="w-16 h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent mx-auto mb-4"></div>
                            <p id="evt-desc" class="text-gray-300 mb-6 text-sm leading-relaxed italic">...</p>
                            
                            <div id="evt-choices" class="space-y-3">
                                <!-- Choices injected here -->
                            </div>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                eventModal = document.getElementById('random-event-modal');
            }

            // Cập nhật nội dung
            document.getElementById('evt-title').textContent = eventData.title;
            document.getElementById('evt-desc').textContent = eventData.desc;
            
            const choicesContainer = document.getElementById('evt-choices');
            choicesContainer.innerHTML = '';

            eventData.choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.className = "w-full py-3 px-4 rounded-lg font-bold text-sm transition transform active:scale-95 border border-gray-600 shadow-md flex justify-between items-center group";
                
                if (choice.action === 'close') {
                    btn.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-gray-400');
                    btn.innerHTML = `<span>${choice.text}</span> <i class="fa-solid fa-xmark"></i>`;
                    btn.onclick = () => {
                        document.getElementById('random-event-modal').classList.add('hidden');
                        addTrainingLog('Bạn đã bỏ qua một kỳ ngộ.', 'info');
                    };
                } else {
                    // Style cho nút lựa chọn
                    btn.classList.add('bg-gradient-to-r', 'from-blue-900', 'to-slate-800', 'hover:from-blue-800', 'hover:to-slate-700', 'text-white', 'border-blue-500/30');
                    
                    // Hiển thị chi phí nếu có
                    let costText = '';
                    let canAfford = true;
                    if (choice.cost) {
                        if (choice.cost.hpPercent) {
                            costText = `<span class="text-red-400 text-xs mr-2">-${choice.cost.hpPercent}% HP</span>`;
                            if (gameData.player.currentHp < (getTotalStats().hp * (choice.cost.hpPercent/100))) canAfford = false; // Không cho chết vì event
                        } else if (choice.cost.currency) {
                            const curr = choice.cost.currency;
                            const amt = choice.cost.amount;
                            const currName = curr === 'nganLuong' ? 'NL' : 'KNB';
                            const currColor = curr === 'nganLuong' ? 'text-gray-300' : 'text-yellow-300';
                            costText = `<span class="${currColor} text-xs mr-2">-${amt.toLocaleString()} ${currName}</span>`;
                            if ((gameData[curr] || 0) < amt) canAfford = false;
                        }
                    }

                    btn.innerHTML = `<span>${choice.text}</span> ${costText}`;
                    
                    if (!canAfford) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                    } else {
                        btn.onclick = () => handleEventChoice(choice);
                    }
                }
                choicesContainer.appendChild(btn);
            });

            // Hiển thị modal
            eventModal.classList.remove('hidden');
        }

        // [NEW] Helper: Format kết quả sự kiện chi tiết
        function formatEventResultDetail(data, type) {
            if (!data) return '';
            let html = '<div class="mt-4 p-3 bg-black/40 rounded border border-gray-600 text-left text-xs space-y-1 shadow-inner">';
            const color = type === 'reward' ? 'text-green-400' : 'text-red-400';
            const prefix = type === 'reward' ? '+' : ''; // Penalty values usually passed as positive numbers to subtract
            const label = type === 'reward' ? 'Nhận được:' : 'Tổn thất:';
            
            html += `<p class="font-bold text-gray-300 border-b border-gray-600 pb-1 mb-1">${label}</p>`;

            let hasContent = false;

            // Currency & Basic Stats
            if (data.xp) { html += `<div class="${color}">${prefix}${data.xp.toLocaleString()} Kinh Nghiệm</div>`; hasContent = true; }
            if (data.nganLuong) { html += `<div class="${color}">${prefix}${data.nganLuong.toLocaleString()} Ngân Lượng</div>`; hasContent = true; }
            if (data.kimNguyenBao) { html += `<div class="${color}">${prefix}${data.kimNguyenBao.toLocaleString()} KNB</div>`; hasContent = true; }
            if (data.danhVong) { html += `<div class="${color}">${prefix}${data.danhVong.toLocaleString()} Danh Vọng</div>`; hasContent = true; }
            if (data.uyDanh) { html += `<div class="${color}">${prefix}${data.uyDanh.toLocaleString()} Uy Danh</div>`; hasContent = true; }
            if (data.diemCongHien) { html += `<div class="${color}">${prefix}${data.diemCongHien.toLocaleString()} Cống Hiến</div>`; hasContent = true; }
            if (data.tuVi) { html += `<div class="${color}">${prefix}${data.tuVi.toLocaleString()} Tu Vi</div>`; hasContent = true; }
            if (data.linhKhi) { html += `<div class="${color}">${prefix}${data.linhKhi.toLocaleString()} Linh Khí</div>`; hasContent = true; }
            if (data.linhHonThach) { html += `<div class="${color}">${prefix}${data.linhHonThach.toLocaleString()} Linh Hồn Thạch</div>`; hasContent = true; }
            if (data.honLuc) { html += `<div class="${color}">${prefix}${data.honLuc.toLocaleString()} Hồn Lực</div>`; hasContent = true; }
            
            // HP/Mana Percent (Usually penalty)
            if (data.hpPercent) { html += `<div class="${color}">-${data.hpPercent}% Sinh Lực</div>`; hasContent = true; }
            if (data.manaPercent) { html += `<div class="${color}">-${data.manaPercent}% Nội Lực</div>`; hasContent = true; }

            // Items Helper
            const appendItemHtml = (id, amt) => {
                let name = id;
                let rarityClass = 'text-gray-300';
                if (STATIC_ITEM_DB[id]) {
                    name = STATIC_ITEM_DB[id].name;
                    rarityClass = getRarityClass(STATIC_ITEM_DB[id].rarity);
                } else if (MATERIALS_DB[id]) {
                    name = MATERIALS_DB[id].name;
                    rarityClass = getRarityClass(MATERIALS_DB[id].rarity);
                } else if (id === 'box_gear_godly') {
                     name = 'Rương Thần Ma';
                     rarityClass = 'text-rainbow-animation';
                }
                html += `<div class="${rarityClass}">${prefix}${amt} x ${name}</div>`;
                hasContent = true;
            };

            if (data.item) appendItemHtml(data.item, data.amount || 1);
            if (data.item2) appendItemHtml(data.item2, data.amount2 || 1);

            // Stats Bonus (Permanent)
            const statMap = {
                'hp_p': 'Sinh Lực', 'atk_p': 'Công Kích', 'def_p': 'Phòng Thủ', 
                'spd_p': 'Thân Pháp', 'lck_p': 'May Mắn', 'critDamage': 'ST Bạo Kích',
                'lck': 'May Mắn', 'spd': 'Thân Pháp'
            };
            for (let key in statMap) {
                if (data[key]) {
                    const val = data[key];
                    const sign = val > 0 ? '+' : '';
                    html += `<div class="text-yellow-300">${sign}${val}${key.endsWith('_p') || key === 'critDamage' ? '%' : ''} ${statMap[key]}</div>`;
                    hasContent = true;
                }
            }

            html += '</div>';
            return hasContent ? html : '';
        }

        // [NEW] Init check on load
        window.onload = function() {
            checkAndShowContinueBtn();
            // Start offline chan khi check regardless of screen
            // if (!window.chanKhiInterval) window.chanKhiInterval = setInterval(updateChanKhiPassive, 1000);
            
            // [MODIFIED] Start the global notification loop
            startGlobalNotificationLoop();
        
        };
    </script>
<audio id="bgm"></audio>

<!-- BUTTONS -->
<button id="musicBtn"
  style="position:fixed;right:12px;bottom:12px;z-index:9999;padding:8px 12px;">
  🔊
</button>

<button id="nextBtn"
  style="position:fixed;right:12px;bottom:56px;z-index:9999;padding:8px 12px;">
  ⏭
</button>

<script>
  // ===== PLAYLIST =====
   const musicList = [
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music003.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music100.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/GIACMONGTHOITRAI.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music110.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/HOADIAVILAO.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music120.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/KiemHiepTinh.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music130.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/sanshengyuan.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music140.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/3sinhduyenviet.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music170.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music200.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music201.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music210.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music241.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music150.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music160.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music211.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music330.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music401.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music403.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/music404.mp3",
    "https://raw.githubusercontent.com/zpkzln1st/Nhacnenvolamluanhoi/main/GIUMAIBONGHINHEM.mp3"
  ];

  // ===== STATE =====
  let current = 0;
  let musicEnabled = true;
  let started = false;

  const bgm = document.getElementById("bgm");
  const musicBtn = document.getElementById("musicBtn");
  const nextBtn = document.getElementById("nextBtn");

  bgm.volume = 0.3;

  // ===== FUNCTIONS =====
  function playNext() {
    if (!musicEnabled) return;
    bgm.src = musicList[current];
    bgm.play().catch(() => {});
    current = (current + 1) % musicList.length;
    started = true;
  }

  // Auto next when song ends
  bgm.addEventListener("ended", playNext);

  // First click to start music (browser policy)
  document.addEventListener("click", function () {
    if (musicEnabled && !started) {
      playNext();
    }
  }, { once: true });

  // Toggle music ON / OFF
  musicBtn.addEventListener("click", function (e) {
    e.stopPropagation();
    musicEnabled = !musicEnabled;

    if (musicEnabled) {
      musicBtn.textContent = "🔊";
      if (!started) playNext();
      else bgm.play().catch(() => {});
    } else {
      musicBtn.textContent = "🔇";
      bgm.pause();
    }
  });

  // Next button
  nextBtn.addEventListener("click", function (e) {
    e.stopPropagation();
    musicEnabled = true;
    musicBtn.textContent = "🔊";
    playNext();
  });
</script>
</body>
</html>